<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../styles/scrollbar-style.html">
<link rel="import" href="../../../styles/dropdown-style.html">
<link rel="import" href="../../../styles/dialog-style.html">
<link rel="import" href="../../../styles/paper-input-style.html">
<link rel="import" href="../../../styles/dropdown-style.html">
<link rel="import" href="../../../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">

<link rel="import" href="../ht-regimen.html">
<link rel="import" href="../ht-regimen-item.html">

<dom-module id="medication-details-dialog">
    <template>
        <style include="scrollbar-style dropdown-style dialog-style vaadin-icure-theme">
            paper-dialog {
                position: absolute;
                width: 80%;
                height: 80%;
                top: 50%;
                left: 50%;
                transform: translate(-50%,-50%);
                max-height: 780px !important;
                max-width: 1280px !important;
                display: flex;
                flex-direction: column;
            }

            .content{
                flex-grow: 1
            }

            #medication-detail .save-line {
                height: 20px;
            }

            .modal-title{
                justify-content: flex-start;
            }

            .modal-title iron-icon {
                margin-right: 8px;
            }

            .medication-line > span {
                padding: 0 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 90%;
                white-space: nowrap;
            }

            .regimen-line {
                display: flex;
                flex-flow: row nowrap;
                align-items: center;
            }

            .regimen-line.block{
                justify-content: flex-start;
                align-items: flex-end;
                height: 46px;
                padding: 0 0 16px 0;
            }

            .regimen-line paper-icon-button {
                margin: 12px;
                height: 24px;
                width: 24px;
                padding: 2px;
            }
            .regimen-line vaadin-checkbox {
                align-self: flex-end;
                margin: 0 8px 8px;
            }
            .regimen-line div {
                align-self: flex-end;
                margin-bottom: 8px;
                width: auto;
            }
            .regimen-line paper-input[type=number] {
                margin: 0 8px 0;
                width: 48px;
            }
            .regimen-line.block .renewal-input{
                max-height: 42px;
                min-height: 0;
                max-width: 50px;
                text-align: center;
                --paper-input-container: {
                    padding: 0;
                }
            }
            .regimen-line.block paper-dropdown-menu {
                margin-right: 8px;
                --paper-dropdown-menu-input: {
                    height: 42px;
                    padding: 0;
                }
                --paper-input-container: {
                    padding: 0;
                };
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            .regimen-line.block span{
                margin-right: 4px;
            }

            .regimen-line.block paper-checkbox{
                margin-right: 8px;
                --paper-checkbox-checked-color: var(--app-secondary-color);
            }

            .regimen--frequency {
                margin: auto;
            }

            .regimen--tod {
                margin: auto;
                margin: 0 4px;
                flex-grow: 1;
            }

            .regimen--quantity {
                margin-right: 4px;
                width: 80px;
                text-align: right;
            }

            .regimen-grid-quantity {
                margin-left: auto;
                margin-right: auto;
                width: 48px;
                text-align: center;
                position: relative;
                --paper-input-container-underline: {
                    border-color: transparent;
                };
                --paper-input-container-input: {
                   transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
                };
            }

            .regimen-grid-quantity:hover{
                --paper-input-container-input: {
                    background: var(--app-background-color-darker);
                }
            }

            .regimen--units {
                margin: auto;
                width: 168px;
            }

            .regimen--datepicker {
                max-width: 152px;
                cursor: pointer;
                flex: 1;
            }

            .regimen-extra {
                display: flex;
                flex-direction: row;
            }

            paper-input {
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            paper-input.center {
                text-align: center;
            }

            #filter {
                width: 50%;
            }

            .dropdown-priority {
                cursor: pointer;
            }

            .regimen-lines {
                border-top: 1px solid var(--app-background-color-dark);
                margin-bottom: auto;
                padding: 0 12px;
            }
            .force-left {
                left: 12px;
            }
            .force-right {
                right: 12px;
            }

            .posology-btn {
                left: 100%;
                transform: translateX(-100%);
                padding-right: 3px;
            }

            .marginRight10 {
                margin-right: 10px;
            }

            iron-input#medicNameInput {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            .regimen-details {
                border: 1px solid var(--app-background-color-dark);
                border-radius: 4px;
                padding: 4px;
                margin-bottom: 4px;
            }

            span.regimen-txt {
                height: 36px;
            }

            .regimen-add {
                justify-content: flex-end;
                margin: 8px 0;
                position: absolute;
                right: 24px;
                z-index: 10;
            }

            .display-type-regimen {
                margin: 0 12px;
                flex-shrink: 0;
            }
            .display-type-regimen .regimen-txt {flex:1;text-align: right;}
            #medication-name {
                flex: 4;
                padding-top: 1px;
            }

            #numberByFrequency {
                text-align: right;
                padding-right: 4px;
            }

            paper-input-container {
                --paper-input-container-focus-color: var(--app-primary-color);
                --paper-input-container-label: {
                    color: var(--app-text-color);
                    opacity: 1;
                };
                --paper-input-container-underline-disabled: {
                    border-bottom: 1px solid var(--app-text-color);

                };
                --paper-input-container-color: var(--app-text-color);
            }


            .comment {
                width: 100%;
            }

            .custom-time {
                width: 100%;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }

            .custom-time > div {
                display: flex;
            }

            .custom-time-add {
                height: 20px;
                width: 20px;
                background: var(--app-secondary-color);
                border-radius: 50%;
                padding: 1px;
                margin-right: 4px;
            }

            .add-box {
                position: absolute;
                display: flex;
                flex-direction: column;
                padding: 8px;
                background: white; /*var(--app-background-color-dark);*/
                border-radius: 4px;
                box-shadow: var(--app-shadow-elevation-1);
                transform: translateY(8px);
                z-index: 1;
            }
            .add-box h2 {
                text-align: center;
            }
            .add-box .one-line {
                display: flex;
                flex-direction: row;
                width: 100%;
            }
            .add-box .one-line > * {
                flex: 1;
            }

            .regimen-add .one-line {
                display: flex;
            }
            .regimen-add .one-line.fields { flex:1; }

            .add-first-regimen {
                width: 216px;
                margin: 0 auto;
                cursor: pointer;
            }

            .regimen-line .add-first-regimen {
                margin: initial;
            }

            * .btn-dropdown-container {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                position: absolute;
                background: white;
                z-index: 10;
                width: 216px;
            }

            .add-first-regimen .btn-dropdown-container paper-item {
                text-transform: capitalize;
                height: 28px;
                padding: 0 8px;
            }

            .add-first-regimen .btn-dropdown-container paper-item:hover {
                background: var(--app-background-color-dark);
            }

            #selectedMedicationTable {
                border: none;
                height: 200px;
            }

            *.capitalize {
                text-transform: capitalize;
            }

            paper-tabs {
                /* background: var(--app-secondary-color);
                --paper-tabs-selection-bar-color: var(--app-text-color-disabled); */
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                --paper-tabs_-_color: var(--app-text-color);
                margin-top: 0;
                flex-shrink: 0;
                padding: 0;
            }

            paper-tab{
                --paper-tab-ink: var(--app-secondary-color);
            }

            #main-table {
                position: relative;
            }

            paper-tab span{
                text-overflow: ellipsis;
                overflow: hidden;
                padding-right: 12px;
                display: block;
                max-width: calc(100% - 34px);
            }

            .dosage_table {
            }

            .dosage_row {
                align-items: center;
                width: 90px;
            }

            .dosage_th {
                width: 90px;
                text-align: center;
            }

            .dosage_td_empty {
                width: 90px;
            }

            .dosage_td {
                width: 90px;
                margin-left: auto;
                margin-right: auto;
            }

            .dosage_td_nbr {
                width: 86px;
                margin-left: auto;
                margin-right: auto;
            }

            .dosage_sd {
                width: 30px;
            }

            .dosage_sd_nbr {
                width: 26px;
            }

            #custom paper-input-container{
                padding: 0;
                margin: 0 8px;
                --paper-input-container-input: {
                    border: none;
                    outline: 0;
                };
                max-width: 64px;
            }

            .rotate-icon {
                transform: rotate(-225deg);
            }

            .timeOfDay:hover {
                cursor: pointer;
                background: var(--app-background-color-dark);
            }

            #custom paper-input-container input{
                border: none;
                font-size: 1em;
                max-width: 48px;
            }

            #custom paper-input-container input:focus{
                outline: 0;
            }

            @media screen and (max-width: 936px) {
                paper-dialog#medication-detail {
                    position: fixed;
                    max-width: none !important;
                    max-height: none !important;
                    top: 64px;
                    left: 0;
                    height: calc(100vh - 84px) !important;
                    width: 100vw !important;
                    margin: 0;
                    transform: none;
                }
            }

            @media screen and (max-width: 768px) {
                .display-type-regimen {
                    flex-direction: column;
                }
                .display-type-regimen > * {
                    width: 100%;
                    box-sizing: border-box;
                }
                .display-type-regimen .one-line {
                    display: flex;
                    flex-direction: row;
                    width: 100%;
                }
                .display-type-regimen .one-line > * {
                    flex: 1;
                }

                .regimen-add {
                    flex-direction: column;
                    height: auto;
                }
                .regimen-add > * {
                    width: 100%;
                }prescriptionDialog
                .regimen-add .add-first-regimen .btn-dropdown-container {
                    width: 100%;
                }

                .regimen-add .one-line {
                    display: flex;
                    flex-direction: row;
                    width: 100%;
                }
                .regimen-add .one-line > * {
                    flex: 1;
                }
            }

        </style>

        <paper-dialog id="medication-detail" always-on-top="true" no-cancel-on-outside-click="true">

            <h2 class="modal-title"><iron-icon icon="vaadin:pill"></iron-icon> [[_any(selectedMedicationContentWithId.medicationValue.medicinalProduct.intendedname, selectedMedicationContentWithId.medicationValue.substanceProduct.intendedname,selectedMedicationContentWithId.medicationValue.compoundPrescription)]]</h2>

            <div class="content">

                <div class="regimen-line display-type-regimen">
                    <vaadin-checkbox checked="[[selectedMedicationContentWithId.medicationValue.substitutionAllowed]]" id="substitutionAllowed" on-checked-changed="_substitutionAllowedChanged">[[localize('', 'Chronique', language)]]</vaadin-checkbox>
                    <paper-input type="number" min="0" label="[[localize('', 'Quantité prescrite', language)]]" value=""></paper-input>
                </div>
                <div class="regimen-line display-type-regimen">
                    <paper-dropdown-menu id="medicReimbursement" label="[[localize('presc_reimb', 'Reimbursement', language)]]" class="regimen--reimbursement">
                        <paper-listbox slot="dropdown-content" class="dropdown-reimbursement" selected={{selectedMedicationContentWithId.medicationValue.reimbursementItemIdx}} selected-item="{{reimbursementItem}}">
                            <template is="dom-repeat" items="[[reimbursementCodeRecipe]]" as="code">
                                <paper-item id="[[code.id]]">[[_getCodeLabel(code.label)]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>

                <div class="regimen-line display-type-regimen">
                    <paper-input-container always-float-label="true" class="comment">
                        <label slot="label" class="color-status">[[localize('','Posologie CBIP',language)]]</label>
                        <iron-autogrow-textarea class="paper-input-input" slot="input" value="{{selectedMedicationContentWithId.medicationValue.commentForDelivery}}"></iron-autogrow-textarea>
                    </paper-input-container>
                </div>
                <div id="main-table" class="regimen-lines">

                    <h4>[[localize('pos','Posology',language)]]</h4>

                    <div class="regimen-line display-type-regimen">
                        <paper-input type="number" min="0" label="[[localize('', 'Quantité', language)]]" value="{{selectedMedicationContentWithId.medicationValue.renewalDecimalValue}}"></paper-input>
                        <paper-dropdown-menu id="medicRenewalTimeUnit" label="[[localize('','Nature',language)]]" class="regimen--renewalTimeUnit">
                            <paper-listbox slot="dropdown-content" class="dropdown-renewalTimeUnit" selected={{selectedMedicationContentWithId.medicationValue.renewalTimeUnitIdx}} selected-item="{{selectedMedicationContentWithId.medicationValue.renewalDurationUnitItem}}">
                                <template is="dom-repeat" items="[[timeUnit]]" as="tu">
                                    <paper-item id="[[tu.id]]">[[_getCodeLabel(tu.label)]]</paper-item>
                                </template>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <paper-input type="number" min="0" label="[[localize('', 'Nb de fois', language)]]" value="{{selectedMedicationContentWithId.medicationValue.renewalDurationValue}}"></paper-input>
                        <div>&nbsp;x&nbsp;</div>
                        <paper-dropdown-menu id="medicReimbursement" label="[[localize('', 'par', language)]]" class="regimen--reimbursement">
                            <paper-listbox slot="dropdown-content" class="dropdown-reimbursement" selected={{selectedMedicationContentWithId.medicationValue.reimbursementItemIdx}} selected-item="{{selectedMedicationContentWithId.medicationValue.reimbursementItem}}">
                                <paper-item id="daily">[[localize('','Jour',language)]]</paper-item>
                                <paper-item id="weekly" data-item="weekly">[[localize('','Semaine',language)]]</paper-item>
                                <paper-item id="monthly" data-item="monthly">[[localize('','Mois',language)]]</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                    </div>

                    <table class="dosage_table">
                        <tr class="dosage_row">
                            <td colspan="3" class="dosage_th">[[localize('','A jeun',language)]]</td>
                            <td colspan="3" class="dosage_th">[[localize('mom_morning','Matin',language)]]</td>
                            <td colspan="3" class="dosage_th">[[localize('','10h',language)]]</td>
                            <td colspan="3" class="dosage_th">[[localize('mom_midday','Midi',language)]]</td>
                            <td colspan="3" class="dosage_th">[[localize('','16h',language)]]</td>
                            <td colspan="3" class="dosage_th">[[localize('mom_evening','Soir',language)]]</td>
                            <td colspan="3" class="dosage_th">[[localize('','Couché',language)]]</td>
                        </tr>
                        <tr class="dosage_row">
                            <td class="dosage_td" colspan="3">
                                <ht-regimen-item id="regimenFasted" quantity="{{regimenFasted}}" custom="normal" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td" colspan="3">
                                <ht-regimen-item id="regimenBreakfast" quantity="{{regimenBreakfast}}" custom="normal" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td" colspan="3">
                                <ht-regimen-item id="regimenBetweenBreakfastAndLunch" quantity="{{regimenBetweenBreakfastAndLunch}}" custom="normal" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td" colspan="3">
                                <ht-regimen-item id="regimenLunch" quantity="{{regimenLunch}}" custom="normal" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td" colspan="3">
                                <ht-regimen-item id="regimenBetweenLunchAndDinner" quantity="{{regimenBetweenLunchAndDinner}}" custom="normal" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td" colspan="3">
                                <ht-regimen-item id="regimenDinner" quantity="{{regimenDinner}}" custom="normal" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td" colspan="3">
                                <ht-regimen-item id="regimenSleep" quantity="{{regimenSleep}}" custom="normal" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td>
                                <vaadin-checkbox checked="[[]]" id="ifNeeded" on-checked-changed="_ifNeededChanged">[[localize('', 'Si nécessaire', language)]]</vaadin-checkbox>
                            </td>
                        </tr>
                        <tr class="dosage_row">
                            <td class="dosage_td_empty" colspan="3"></td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenBeforeBreakfast" quantity="{{regimenBeforeBreakfast}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenDuringBreakfast" quantity="{{regimenDuringBreakfast}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenAfterBreakfast" quantity="{{regimenAfterBreakfast}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td_empty" colspan="3"></td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenBeforeLunch" quantity="{{regimenBeforeLunch}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenDuringLunch" quantity="{{regimenDuringLunch}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenAfterLunch" quantity="{{regimenAfterLunch}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td_empty" colspan="3"></td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenBeforeDinner" quantity="{{regimenBeforeDinner}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenDuringDinner" quantity="{{regimenDuringDinner}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_sd">
                                <ht-regimen-item id="regimenAfterDinner" quantity="{{regimenAfterDinner}}" custom="small" on-quantity-changed="_quantityChanged"></ht-regimen-item>
                            </td>
                            <td class="dosage_td_empty"></td>
                            <td>&nbsp;</td>
                        </tr>
                    </table>

                    <div class="regimen-line display-type-regimen">
                        <div class="regimen-extra">
                            <paper-input id="input" no-label-float value="{{quantity}}" type="number" min="0"></paper-input>
                            <span>prise(s) à</span>
                            <paper-input id="input" no-label-float value="{{time}}" style="width:40px"></paper-input>
                            <paper-icon-button icon="icons:add" on-tap="_addExtra">
                            </paper-icon-button>
                        </div>
                        <template is="dom-repeat" items="[[extras]]" as="extra">
                            <ht-regimen id="extra[[extra.code]]" extra="[[extra]]" on-delete-extra="_deleteExtra"></ht-regimen>
                        </template>
                    </div>

                    <div class="regimen-line display-type-regimen">
                        <paper-input-container always-float-label="true" class="comment">
                            <label slot="label" class="color-status">[[localize('pos','Posology',language)]]</label>
                            <iron-autogrow-textarea class="paper-input-input" slot="input" value="{{posologyString}}"></iron-autogrow-textarea>
                        </paper-input-container>
                    </div>

                    <div class="regimen-line display-type-regimen">
                        <paper-input-container always-float-label="true" class="comment">
                            <label slot="label" class="color-status">[[localize('','Commentaires pour le patient',language)]]</label>
                            <iron-autogrow-textarea class="paper-input-input" slot="input" value="{{selectedMedicationContentWithId.medicationValue.commentForDelivery}}"></iron-autogrow-textarea>
                        </paper-input-container>
                    </div>

                    <div class="regimen-line display-type-regimen">
                        <vaadin-date-picker id="beginMoment" label="[[localize('start-date', 'Start date', language)]]" value="{{selectedMedicationContentWithId.beginMomentAsString}}"
                                            class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                        <vaadin-date-picker id="endMoment" label="[[localize('end-date', 'End date', language)]]" value="{{selectedMedicationContentWithId.endMomentAsString}}"
                                            class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                        <div>ou</div>
                        <paper-input type="number" min="0" label="[[localize('','Nombre de jours',language)]]" value="{{duration}}" on-change="_changeDuration"></paper-input>
                        <vaadin-date-picker id="endMoment" label="[[localize('', 'Fin boîte', language)]]" value="{{selectedMedicationContentWithId.endMomentAsString}}"
                                            class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                    </div>

                    <div class="regimen-line display-type-regimen">
                        <paper-dropdown-menu id="medicSubstitution" label="[[localize('', 'Substitution', language)]]">
                            <paper-listbox slot="dropdown-content" selected="{{substitution}}" on-selected-changed="_substitutionChanged">
                                <paper-item id="0">[[localize('','Autorisée',language)]]</paper-item>
                                <paper-item id="1">[[localize('','Non autorisée',language)]]</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>

                        <paper-dropdown-menu id="medicReimbursement" label="[[localize('presc_reimb', 'Reimbursement', language)]]" class="regimen--reimbursement">
                            <paper-listbox slot="dropdown-content" class="dropdown-reimbursement" selected={{selectedMedicationContentWithId.medicationValue.reimbursementItemIdx}} selected-item="{{selectedMedicationContentWithId.medicationValue.reimbursementItem}}">
                                <template is="dom-repeat" items="[[reimbursementCodeRecipe]]" as="code">
                                    <paper-item id="[[code.id]]">[[_getCodeLabel(code.label)]]</paper-item>
                                </template>
                            </paper-listbox>
                        </paper-dropdown-menu>

                        <vaadin-date-picker id="endMoment" label="[[localize('', 'Déliverance', language)]]" value="{{selectedMedicationContentWithId.endMomentAsString}}"
                                            class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                    </div>

                    <div class="regimen-line display-type-regimen">
                        <!--
                        <vaadin-checkbox checked="[[selectedMedicationContentWithId.medicationValue.substitutionAllowed]]" id="substitutionAllowed" on-checked-changed="_substitutionAllowedChanged">[[localize('substitution', 'Substitution', language)]]</vaadin-checkbox>
                        <vaadin-checkbox id="renewal" checked=[[selectedMedicationContentWithId.medicationValue.isRenewal]] on-checked-changed="_renewalValueChanged">[[localize('renewal', 'Renewal', language)]]</vaadin-checkbox>
                        -->
                        <paper-dropdown-menu id="medicRenewal" label="[[localize('', 'Renouvellement', language)]]">
                            <paper-listbox slot="dropdown-content" selected="{{renewal}}" on-selected-changed="_renewalChanged">
                                <paper-item id="0">[[localize('','Autorisé',language)]]</paper-item>
                                <paper-item id="1">[[localize('','Non autorisé',language)]]</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <template is="dom-if" if="[[selectedMedicationContentWithId.medicationValue.isRenewal]]">
                            <paper-input type="number" min="0" label="[[localize('', 'Nombre de fois', language)]]" value="{{selectedMedicationContentWithId.medicationValue.renewalDecimalValue}}"></paper-input>
                            <paper-input type="number" min="0" label="[[localize('', 'tous le', language)]]" value="{{selectedMedicationContentWithId.medicationValue.renewalDurationValue}}"></paper-input>
                            <paper-dropdown-menu id="medicRenewalTimeUnit" label="[[localize('time_unit','Time unit',language)]]" class="regimen--renewalTimeUnit">
                                <paper-listbox slot="dropdown-content" class="dropdown-renewalTimeUnit" selected={{selectedMedicationContentWithId.medicationValue.renewalTimeUnitIdx}} selected-item="{{selectedMedicationContentWithId.medicationValue.renewalDurationUnitItem}}">
                                    <template is="dom-repeat" items="[[timeUnit]]" as="tu">
                                        <paper-item id="[[tu.id]]">[[_getCodeLabel(tu.label)]]</paper-item>
                                    </template>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </template>
                    </div>

                    <div class="regimen-line display-type-regimen">
                        <paper-input-container always-float-label="true" class="comment">
                            <label slot="label" class="color-status">[[localize('','Commentaires pour le pharmacien',language)]]</label>
                            <iron-autogrow-textarea class="paper-input-input" slot="input" value="{{selectedMedicationContentWithId.medicationValue.commentForDelivery}}"></iron-autogrow-textarea>
                        </paper-input-container>
                    </div>
                </div>
            </div>

            <div class="buttons">
                <template is="dom-if" if="[[_all(selectedMedicationContentWithId ,selectedMedicationContentWithId.isPrescription)]]">
                    <paper-checkbox id="createMedication" on-checked-changed="_createMedication" checked="{{selectedMedicationContentWithId.medicationValue.createMedication}}"> [[localize('create_med','Create medication',language)]]</paper-checkbox>
                    <!-- Create medication <vaadin-checkbox id="createMedication" on-checked-changed="_createMedication"></vaadin-checkbox> -->
                </template>
                <paper-button on-tap="test" class="button">Test</paper-button>
                <paper-button dialog-confirm autofocus on-tap="cancel" class="button">[[localize('can','Cancel',language)]]</paper-button>
                <template is="dom-if" if="[[!_all(selectedMedicationContentWithId ,selectedMedicationContentWithId.isPrescription)]]">
                    <paper-button dialog-confirm autofocus on-tap="endAndClose" class="button button--other">[[localize('clo2','End',language)]]</paper-button>
                    <paper-button dialog-confirm autofocus on-tap="EOLAndClose" class="button button--other">[[localize('del','Delete',language)]]</paper-button>
                </template>
                <paper-button dialog-confirm autofocus on-tap="saveAndClose" class="button button--save">[[localize('save','Save',language)]]</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>

        import _ from 'lodash/lodash'
        import moment from 'moment/src/moment'

        class MedicationDetailsDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'medication-details-dialog'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    selectedMedicationContentWithId: {
                        type: Object,
                        value: null,
                        notify: true
                    },
                    medications: {
                        type: Array,
                        value: []
                    },
                    bufferUnit: {
                        type: String
                    },
                    bufferQuantity: {
                        type: Number,
                        value: 1
                    },
                    bufferNumberByFrequency: {
                        type: Number,
                        value: 1
                    },
                    bufferFrequency: {
                        type: String,
                        value: "daily"
                    },
                    bufferGeneralFrequency: {
                        type: Number,
                        value: 0
                    },
                    // beginMoment: {
                    //     type: Number,
                    //     value: 0,
                    // },
                    // endMoment: {
                    //     type: Number,
                    //     value: 0,
                    // },
                    medicPriority: {
                        type: Number,
                        value: 0,
                        observer: "_changeMedicPriority"
                    },
                    selectedTab: {
                        type: Number,
                        value: 0
                    },
                    openAddDropDown: {
                        type: Boolean,
                        value: false
                    },
                    openAddColDropDown: {
                        type: Boolean,
                        value: false
                    },
                    reimbursementCodeRecipe: {
                        type: Array,
                        value: () => []
                    },
                    reimbursementItem:{
                        type: Object,
                        value: () => {}
                    },
                    reimbursementItemIdx:{
                        type: Number,
                        value: 0
                    },
                    timeUnit:{
                        type: Array,
                        value: () => []
                    },
                    renewalDurationUnitItem: {
                        type: Object,
                        value: () => {}
                    },
                    renewalTimeUnitIdx:{
                        type: Number,
                        value: 0
                    },
                    renewalDurationValue: {
                        type: Number,
                        value: 0
                    },
                    isRenewal:{
                        type: Boolean,
                        value: false
                    },
                    renewalDecimalValue:{
                        type: Number,
                        value: 0
                    },
                    medicationMustBeCreated:{
                        type: Boolean,
                        value: false
                    },
                    posologyString: {
                        type: String,
                        value: '',
                        observer: '_posologyChanged'
                    },
                    medicationDetail: {
                        type: Object,
                        value: () => {}
                    },
                    substitution: {
                        type: Number,
                        value: 0
                    },
                    duration: {
                        type: Number,
                        value: 0
                    },
                    regimenFasted: {
                        type: Number,
                        value: 0
                    },
                    regimenBeforeBreakfast: {
                        type: Number,
                        value: 0
                    },
                    regimenBreakfast: {
                        type: Number,
                        value: 0
                    },
                    regimenDuringBreakfast: {
                        type: Number,
                        value: 0
                    },
                    regimenAfterBreakfast: {
                        type: Number,
                        value: 0
                    },
                    regimenBetweenBreakfastAndLunch: {
                        type: Number,
                        value: 0
                    },
                    regimenBeforeLunch: {
                        type: Number,
                        value: 0
                    },
                    regimenLunch: {
                        type: Number,
                        value: 0
                    },
                    regimenDuringLunch: {
                        type: Number,
                        value: 0
                    },
                    regimenAfterLunch: {
                        type: Number,
                        value: 0
                    },
                    regimenBetweenLunchAndDinner: {
                        type: Number,
                        value: 0
                    },
                    regimenBeforeDinner: {
                        type: Number,
                        value: 0
                    },
                    regimenDinner: {
                        type: Number,
                        value: 0
                    },
                    regimenDuringDinner: {
                        type: Number,
                        value: 0
                    },
                    regimenAfterDinner: {
                        type: Number,
                        value: 0
                    },
                    regimenNight: {
                        type: Number,
                        value: 0
                    },
                    quantity: {
                        type: Number,
                        value: 1
                    },
                    time: {
                        type: String,
                        value: "10:00"
                    },
                    extras:{
                        type: Array,
                        value: () => [
                            { time: "11:00", quantity: 1 }
                        ]
                    },
                    renewal: {
                        type: Number,
                        value: 0
                    },
                }
            }

            static get observers() {
                return [
                    '_changeBeginMoment(selectedMedicationContentWithId.beginMomentAsString)',
                    '_changeEndMoment(selectedMedicationContentWithId.endMomentAsString)',
                    '_regimenChanged(selectedMedicationContentWithId.medicationValue.regimen.*)',
                    '_changeReimbursementItem(reimbursementItem)',
                    '_changeRenewalTimeUnitItem(renewalDurationUnitItem, renewalDurationValue, renewalDecimalValue)',
                    '_selectedMedicationChanged(selectedMedication)'];
            }

            constructor() {
                super()
                this._regimens = [
                    { id: "regimenFasted", code: "unknown" },
                    { id: "regimenBeforeBreakfast", code: "beforebreakfast", parent: "regimenBreakfast" },
                    { id: "regimenBreakfast", code: "morning" }, // not sure
                    { id: "regimenDuringBreakfast", code: "duringbreakfast", parent: "regimenBreakfast" },
                    { id: "regimenAfterBreakfast", code: "afterbreakfast", parent: "regimenBreakfast" },
                    { id: "regimenBetweenBreakfastAndLunch", code: "betweenbreakfastandlunch" },
                    { id: "regimenBeforeLunch", code: "beforelunch", parent: "regimenLunch" },
                    { id: "regimenLunch", code: "unknown" },
                    { id: "regimenDuringLunch", code: "duringlunch", parent: "regimenLunch" },
                    { id: "regimenAfterLunch", code: "afterlunch", parent: "regimenLunch" },
                    { id: "regimenBetweenLunchAndDinner", code: "betweenlunchanddinner" },
                    { id: "regimenBeforeDinner", code: "beforedinner", parent: "regimenDinner" },
                    { id: "regimenDinner", code: "evening" }, // not sure
                    { id: "regimenDuringDinner", code: "duringdinner", parent: "regimenDinner" },
                    { id: "regimenAfterDinner", code: "afterdinner", parent: "regimenDinner" },
                    { id: "regimenSleep", code: "night" },
                ];
            }

            ready() {
                super.ready();
            }

            _any(a,b,c,d,e) {
                return a||b||c||d||e
            }

            _regimenChanged() {
                this.set('posologyString',this.api.contact().medication().posologyToString(this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.medicationValue || {}, this.language))
            }

            _selectedMedicationChanged(idx) {
                const medicationDetail = this.medications[idx]
                const medcontent =  this.extractContentWithIdFromMedicationService(this.medications[idx].newMedication, true, this.medications[idx].options.isPrescription)
                this.set('selectedMedicationContentWithId', Object.assign(medcontent, {
                    beginMomentAsString : this.api.moment((medcontent && medcontent.medicationValue && medcontent.medicationValue.beginMoment) || (medicationDetail.newMedication && medicationDetail.newMedication.valueDate) || (medicationDetail.newMedication && medicationDetail.newMedication.openingDate) || Date.now()).format('YYYY-MM-DD') || null,
                    endMomentAsString: this.api.moment((medcontent && medcontent.medicationValue && medcontent.medicationValue.endMoment) || (medicationDetail.newMedication && medicationDetail.newMedication.closingDate)) ? this.api.moment(medcontent.medicationValue.endMoment || (medicationDetail.newMedication && medicationDetail.newMedication.closingDate)).format("YYYY-MM-DD") : null
                }))
                this._initSelectedMedicationContentWithId()
                this.set('medicationDetail', Object.assign(
                    medicationDetail,
                    {
                        bufferUnit: this.selectedMedicationContentWithId.medicationUnit || this.localize('generic_unit', 'unit', this.language),
                        medicPriority : this.selectedMedicationContentWithId.medicationValue.priority === "high" ? 2 : this.selectedMedicationContentWithId.medicationValue.priority === "middle" ? 1 : 0,
                        reimbursementItemIdx: this.selectedMedicationContentWithId.medicationValue.reimbursementReason ? this.reimbursementCodeRecipe.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.reimbursementReason.code) : this.reimbursementCodeRecipe.findIndex(idx => idx.code === "notreimbursable"),
                        isRenewal : !!this.selectedMedicationContentWithId.medicationValue.renewal,
                        renewalDecimalValue : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.decimal ? this.selectedMedicationContentWithId.medicationValue.renewal.decimal : 1 : null,
                        renewalDurationValue : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.duration.value ? this.selectedMedicationContentWithId.medicationValue.renewal.duration.value : 1 : null,
                        renewalTimeUnitIdx : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal ? this.timeUnit.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.renewal.duration.unit.code) : this.timeUnit.findIndex(idx => idx.code === "mo") : null
                    }
                ))
            }

            _posologyChanged(newValue, oldValue) {
                if(!this.selectedMedicationContentWithId || !this.selectedMedicationContentWithId.medicationValue) {
                    return;
                }
                const fetchedValue = this.api.contact().medication().posologyToString(this.selectedMedicationContentWithId.medicationValue, this.language)
                if(newValue !== fetchedValue) {
                    this.set('selectedMedicationContentWithId.medicationValue.instructionForPatient', newValue)
                }
            }

            _all(a,b) { return a && b }

            _regimenLines() {
                return this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.medicationValue && this.selectedMedicationContentWithId.medicationValue.regimen || []
            }

            extractContentWithIdFromMedicationService(m, isNew, isPres) {
                return {
                    id: m.id,
                    codes: m.codes,
                    medicationValue:
                    (
                        this.api.contact().preferredContent(m, this.language)  ||
                        ( m.content[this.language] =
                                {
                                    medicationValue: { regimen: [] }
                                }
                        )
                    ).medicationValue,
                    isNew: isNew || false,
                    isPrescription: m.isPrescription || isPres || false,
                    createMedication: m.options && m.options.createMedication || false
                };
            }

            open(medicationDetail, selectedMedicationContentWithId, boxes) {
                //console.log("open medication-details:", medicationDetail, selectedMedicationContentWithId, boxes)
                ;(!this.reimbursementCodeRecipe || this.reimbursementCodeRecipe.length === 0 || !this.timeUnit || this.timeUnit.length === 0 ? this.api.code().findPaginatedCodes('be', 'CD-REIMBURSEMENT-RECIPE', '')
                    .then(reimb => this.set("reimbursementCodeRecipe", _.orderBy(reimb.rows, ['label.fr'], ['asc'])))
                    .then(() => this.api.code().findPaginatedCodes('be', 'CD-TIMEUNIT', ''))
                    .then(timeunit => this.set("timeUnit", _.orderBy(_.filter(_.get(timeunit, "rows", []), i => ["ns", "us", "ms", "s", "min"].indexOf(_.trim(_.get(i, "code"))) == -1), ['label.fr'], 'asc'))) : Promise.resolve())
                    .finally(() => {
                        if (medicationDetail) {
                            let idx = this.medications.indexOf(medicationDetail);
                            if (idx > -1) {
                                this._selectedMedicationChanged(idx)
                            } else {
                                const preferredContent = this.api.contact().preferredContent(medicationDetail, this.language)

                                if (!selectedMedicationContentWithId || !selectedMedicationContentWithId.isNew) { // selectedMedicationContentWithId.isNew==false when opening an existing medication
                                    // do not set a default date if not defined, for the user to see when a medication has no date
                                    const start = (preferredContent && preferredContent.medicationValue && preferredContent.medicationValue.beginMoment)
                                        || (medicationDetail.valueDate)
                                        || (medicationDetail.openingDate)
                                    const end = (preferredContent && preferredContent.medicationValue && preferredContent.medicationValue.endMoment)
                                        || (medicationDetail.closingDate)
                                    selectedMedicationContentWithId = this.extractContentWithIdFromMedicationService(medicationDetail, false, selectedMedicationContentWithId.isPrescription)
                                    selectedMedicationContentWithId.beginMomentAsString = start && this.api.moment(start).format('YYYY-MM-DD') || null
                                    selectedMedicationContentWithId.endMomentAsString = end && this.api.moment(end).format('YYYY-MM-DD') || null
                                } else { // new medication, should set a default start date
                                    selectedMedicationContentWithId.beginMomentAsString = this.api.moment(Date.now()).format("YYYY-MM-DD")
                                }

                                this.set('selectedMedicationContentWithId', selectedMedicationContentWithId)
                                this._initSelectedMedicationContentWithId()
                                this.set('previousMedication', this.selectedMedicationContentWithId)
                                this.set('medicationDetail', {
                                    boxes: boxes || 1,
                                    bufferUnit: this.selectedMedicationContentWithId.medicationUnit || this.localize('generic_unit', 'unit', this.language),
                                    medicPriority: this.selectedMedicationContentWithId.medicationValue.priority === "high" ? 2 : this.selectedMedicationContentWithId.medicationValue.priority === "middle" ? 1 : 0,
                                    reimbursementItemIdx: this.selectedMedicationContentWithId.medicationValue.reimbursementReason ? this.reimbursementCodeRecipe.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.reimbursementReason.code) : this.reimbursementCodeRecipe.findIndex(idx => idx.code === "notreimbursable"),
                                    isRenewal: !!this.selectedMedicationContentWithId.medicationValue.renewal,
                                    renewalDecimalValue: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.decimal ? this.selectedMedicationContentWithId.medicationValue.renewal.decimal : 1 : null,
                                    renewalDurationValue: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.duration.value ? this.selectedMedicationContentWithId.medicationValue.renewal.duration.value : 1 : null,
                                    renewalTimeUnitIdx: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal ? this.timeUnit.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.renewal.duration.unit.code) : this.timeUnit.findIndex(idx => idx.code === "mo") : null,
                                    newMedication: medicationDetail,
                                    options: {
                                        createMedication: this.selectedMedicationContentWithId.createMedication,
                                        isPrescription: this.selectedMedicationContentWithId.isPrescription
                                    }
                                })
                            }

                            this.set('medicationMustBeCreated', false)
                            this.set('openAddDropDown', false)

                            this.substitution = this.selectedMedicationContentWithId.medicationValue.substitutionAllowed ? 0 : 1;
                            this.$['medication-detail'].open()

                            this._initialize();
                        }
                    })
            }

            _initialize() {
                const getQuantity = (regs, code) => {
                    let reg = regs.find(r => r.dayPeriod && r.dayPeriod.type == 'CD-DAYPERIOD' && r.dayPeriod.code == code);
                    return reg ? reg.administratedQuantity.quantity : null;
                }
                const regs = this.selectedMedicationContentWithId.medicationValue.regimen;
                this._regimens.filter(reg => reg.code != "unknown").forEach(reg => {
                    this.set(reg.id, getQuantity(regs, reg.code));
                });
                this.extras = [];
                regs.filter(reg => !reg.dayPeriod).forEach(reg => {
                    console.log("reg:" + reg.timeOfDay);
                    this.push("extras", { code: reg.timeOfDay, quantity: parseInt(reg.administratedQuantity.quantity) });
                });
                this._updateDuration();
            }

            _beginMoment() {
                return this.api.moment(this.selectedMedicationContentWithId.medicationValue.beginMoment);
            }

            _endMoment() {
                return this.api.moment(this.selectedMedicationContentWithId.medicationValue.endMoment);
            }

            _updateDuration() {
                if (this.selectedMedicationContentWithId.medicationValue.beginMoment &&
                    this.selectedMedicationContentWithId.medicationValue.endMoment)
                    this.set("duration", this._endMoment().diff(this._beginMoment(), "days"));
            }

            _changeDuration(e) {
                const endMoment = this._beginMoment().add(parseInt(this.duration), "days");
                this.set("selectedMedicationContentWithId.medicationValue.endMoment", parseInt(endMoment.format("YYYYMMDD")));
                this.set("selectedMedicationContentWithId.endMomentAsString", endMoment.format("YYYY-MM-DD"));
            }

            _initSelectedMedicationContentWithId(){
                this.selectedMedicationContentWithId.medicationValue && !this.selectedMedicationContentWithId.medicationValue.regimen ? this.set('selectedMedicationContentWithId.medicationValue.regimen', []) : null
            }

            openList(list) {
                // ------------------if we want to create an array even when we have only one medication selected
                // list && list.length > 0 ? this.set('medications', _.clone(list)) : (list.newMedication && this.set('medications',[list])) || this.set('medications', [])
                // ----------------------------------------------------------------------------------------------
                list && list.length > 0 ? this.set('medications', _.clone(list)) : this.set('medications', [])
                if (this.medications.length) {
                    this.open(this.medications[0], this.extractContentWithIdFromMedicationService(this.medications[0].newMedication, true, this.medications[0].options.isPrescription), this.medications[0].boxes);
                    this.set('selectedMedication',0)
                }
            }

            _localize(s) {
                return this.api.contact().medication().localize(s, this.language)
            }

            _changeBeginMoment() {
                if (this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.beginMomentAsString) { // begin moment can NOT be empty
                    const beginMoment = parseInt(this.selectedMedicationContentWithId.beginMomentAsString.replace(/(....)-(..)-(..)/, '$1$2$3'))
                    this.set("selectedMedicationContentWithId.medicationValue.beginMoment", beginMoment)
                    this._updateDuration();
                }
            }

            _changeEndMoment() {
                if (this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.endMomentAsString != null) { // end moment can be empty string
                    const endMoment = parseInt(this.selectedMedicationContentWithId.endMomentAsString.replace(/(....)-(..)-(..)/, '$1$2$3'))
                    this.set("selectedMedicationContentWithId.medicationValue.endMoment", endMoment)
                    this._updateDuration();
                }
            }

            _changeMedicPriority() {
                // console.log('_changeMedicPriority')
                if (this.selectedMedicationContentWithId) {
                    const priority = this.selectedMedicationContentWithId.medicationValue.priority?
                                    this.selectedMedicationContentWithId.medicationValue.priority=== 2 ? 'high' :
                                    this.selectedMedicationContentWithId.medicationValue.priority=== 1 ? 'middle' : 'low' :
                                    'low'
                    this.set("selectedMedicationContentWithId.medicationValue.priority", priority)
                }
            }

            _setQuantity(id, quantity = null) {
                console.log("_setQuantity:" + id)
                this.set(id, quantity);
                this.shadowRoot.querySelector("#" + id).setQuantity(quantity);
            }

            _getQuantity(id) {
                console.log("_getQuantity:" + id)
                return this.shadowRoot.querySelector("#" + id).quantity;
            }

            _quantityChanged(e) {
                const id = e.currentTarget.id;
                this._regimens.filter(reg => reg.parent == id).forEach(reg => this._setQuantity(reg.id));
                const reg = this._regimens.find(reg => reg.id == id);
                if (reg && reg.parent)
                    this._setQuantity(reg.parent);
            }

            cancel() {
                this.close()
            }

            EOLAndClose(){
                const today = parseInt(moment().subtract(1, 'days').format("YYYYMMDD"))
                this.set("medicationDetail.newMedication.endOfLife", today)
                this.save()
                this.close()
            }

            endAndClose(){
                const yesterday = parseInt(moment().subtract(1, 'days').format("YYYYMMDD"))
                this.set("selectedMedicationContentWithId.medicationValue.endMoment", yesterday)
                this.save()
                this.close()
            }

            saveAndClose() {
                this.save() // instant save
                this.close()
            }

            close() {
                this.set("selectedMedicationContentWithId", null)
                this.set('medications', [])
            }

            test() {
                const regs = this._register();
                console.log(regs);
            }

            save() {
                const regs = this._register();
                this.medicationDetail.newMedication.content.fr.medicationValue.regimen = regs;
                //set("selectedMedicationContentWithId.medicationValue.regimen", regs);
                this._valueChanged()
            }

            _addExtra() {
                const time = moment(this.time,['HH:mm','HHmm']);
                const code = parseInt(time.format("HHmmss"));
                const extra = this.extras.find(e => e.code == code);
                if (extra) {
                    extra.quantity += parseInt(this.quantity);
                    this.shadowRoot.querySelector("#extra" + code).refresh();
                    return;
                }
                this.push("extras", { code: code, quantity: parseInt(this.quantity) });
                this.extras.sort((a, b) => a.code - b.code);
                this.notifyPath("extras");
            }

            _deleteExtra(e) {
                this.splice('extras', this.extras.indexOf(e.extra), 1);
            }

            _valueChanged() {
                console.log("_valueChanged()",this.medicationDetail)
                this.dispatchEvent(new CustomEvent('value-changed', {detail: {medication: this.medicationDetail, medications:this.medications}, bubbles: true, composed: true}))
            }

            _register() {
                let regs = [];
                this._regimens.filter(reg => reg.code != "unknown").forEach(reg => {
                    this._registerDayPeriod(regs, reg.id, reg.code);
                });
                this.extras.forEach(extra => this._registerExtra(regs, extra));
                return regs;
            }

            _registerDayPeriod(regs, id, code) {
                const quantity = this._getQuantity(id);
                if (quantity < 1) return;
                regs.push ({
                    administratedQuantity: {
                        quantity: quantity
                    },
                    dayPeriod: {
                        code: code,
                        type: "CD-DAYPERIOD"
                    },
                    frequency: "daily"
                });
            }

            _registerExtra(regs, extra) {
                regs.push ({
                    administratedQuantity: {
                        quantity: extra.quantity.toString(),
                        time: null,
                        unit: "unit"
                    },
                    frequency: "daily",
                    timeOfDay: extra.code
                });
            }

            selectRegimen(scores, rg, start, end) {
                const s = rg.timeOfDay || rg.dayPeriod && rg.dayPeriod.code && scores[rg.dayPeriod.code] ||  0
                return s >= start && s <= end
            }

            _changeReimbursementItem(item) {
                if(item && item.id){
                    const reimbursementItem = this.reimbursementCodeRecipe.find(r => r.id === item.id)
                    this.set("selectedMedicationContentWithId.medicationValue.reimbursementReason", reimbursementItem)
                }
            }

            _substitutionChanged(e) {
                this.set('selectedMedicationContentWithId.medicationValue.substitutionAllowed', e.detail.value == 0);
            }

            _substitutionAllowedChanged(e) {
                this.set('selectedMedicationContentWithId.medicationValue.substitutionAllowed', e.target.checked);
            }

            _renewalChanged(e) {
                this._setRenewal(e.detail.value == 0);
            }

            _renewalValueChanged(e){
                this._setRenewal(e.target.checked);
            }

            _setRenewal(isRenewal){
                this.set('selectedMedicationContentWithId.medicationValue.isRenewal', isRenewal);
                if(!isRenewal){
                    this.set("selectedMedicationContentWithId.medicationValue.renewal", null);
                }
            }

            _changeRenewalTimeUnitItem(item, unitValue, decimalValue){
                if(item && item.id){
                    const timeUnitItem = this.timeUnit.find(r => r.id === item.id)
                    this.set("selectedMedicationContentWithId.medicationValue.renewal", {
                        decimal: decimalValue,
                        duration: {
                            value: unitValue,
                            unit: timeUnitItem
                        }
                    })
                }
            }

            _createMedication(e){
                this.set('medicationDetail.options.createMedication', e.target.checked)
                this.set('selectedMedicationContentWithId.medicationValue.createMedication', e.target.checked)
            }

            _medicationName(svc) {
                return this.api.contact().medication().medicationNameToString(this.api.contact().preferredContent(svc, this.language).medicationValue) || ''
            }
        }

        customElements.define(MedicationDetailsDialog.is, MedicationDetailsDialog)
    </script>
</dom-module>
