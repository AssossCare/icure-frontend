<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../styles/scrollbar-style.html">
<link rel="import" href="../../../styles/dropdown-style.html">
<link rel="import" href="../../../styles/dialog-style.html">
<link rel="import" href="../../../styles/paper-input-style.html">
<link rel="import" href="../../../styles/dropdown-style.html">
<link rel="import" href="../../../styles/atc-styles.html">
<link rel="import" href="../../../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../ht-regimen-day.html">

<dom-module id="medication-details">
    <template>
        <style include="scrollbar-style dropdown-style dialog-style atc-styles vaadin-icure-theme">
            .container {
                box-sizing: content-box;
                max-height: unset;
                height: 100%;
                overflow-y: scroll;
                padding: 24px 12px;
            }

            #medication-detail .save-line {
                height: 20px;
            }

            .modal-title{
                justify-content: flex-start;
            }

            .modal-title iron-icon {
                margin-right: 8px;
            }

            .medication-line > span {
                padding: 0 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 90%;
                white-space: nowrap;
            }

            .regimen-line {
                display: flex;
                flex-flow: row nowrap;
                align-items: center;
                justify-content: flex-start;
            }

            .regimen-line.block{
                justify-content: flex-start;
                align-items: flex-end;
                height: 46px;
                padding: 0 0 16px 0;
            }

            .regimen-line paper-icon-button {
                height: 16px;
                width: 16px;
                padding: 0px;
                margin-right: 8px;
            }
            .regimen-line vaadin-checkbox {
                margin-right: 8px;
            }
            .regimen-line div {
                /*align-self: flex-end;*/
                /*margin-bottom: 8px;*/
                /*width: auto;*/
            }
            .regimen-line paper-input[type=number] {
                margin-right: 8px;
                width: 128px;
            }
            .regimen-line paper-input[type=text] {
                margin-right: 8px;
            }

            .regimen-line paper-dropdown-menu {
                margin-right: 8px;
            }

            .regimen-line.block .renewal-input{
                max-height: 42px;
                min-height: 0;
                max-width: 50px;
                text-align: center;
                --paper-input-container: {
                    padding: 0;
                }
            }
            .regimen-line.block paper-dropdown-menu {
                margin-right: 8px;
                --paper-dropdown-menu-input: {
                    height: 42px;
                    padding: 0;
                };
                --paper-input-container: {
                    padding: 0;
                };
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            .regimen-line.block span{
                margin-right: 4px;
            }

            .regimen-line.block paper-checkbox{
                margin-right: 8px;
                --paper-checkbox-checked-color: var(--app-secondary-color);
            }

            .regimen-line vaadin-date-picker {
                margin-right: 8px;
                margin-top: 18px;
                cursor: pointer;
            }

            .regimen--frequency {
                margin: auto;
            }

            .regimen--tod {
                margin: auto;
                margin: 0 4px;
                flex-grow: 1;
            }

            .regimen--quantity {
                margin-right: 4px;
                width: 80px;
                text-align: right;
            }

            .regimen-grid-quantity {
                margin-left: auto;
                margin-right: auto;
                width: 48px;
                text-align: center;
                position: relative;
                --paper-input-container-underline: {
                    border-color: transparent;
                };
                --paper-input-container-input: {
                    transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
                };
            }

            .regimen-grid-quantity:hover{
                --paper-input-container-input: {
                    background: var(--app-background-color-darker);
                }
            }

            .regimen--units {
                margin: auto;
                width: 168px;
            }

            .regimen--datepicker {
                max-width: 152px;
                cursor: pointer;
                flex: 1;
            }

            .regimen-extra {
                display: flex;
                flex-direction: row;
            }

            paper-input {
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            paper-input.center {
                text-align: center;
            }

            #filter {
                width: 50%;
            }

            .dropdown-priority {
                cursor: pointer;
            }

            .regimen-lines {
                border-top: 1px solid var(--app-background-color-dark);
                margin-bottom: auto;
                padding: 0 12px;
            }
            .force-left {
                left: 12px;
            }
            .force-right {
                right: 12px;
            }

            .posology-btn {
                left: 100%;
                transform: translateX(-100%);
                padding-right: 3px;
            }

            .marginRight10 {
                margin-right: 10px;
            }

            iron-input#medicNameInput {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            .regimen-details {
                border: 1px solid var(--app-background-color-dark);
                border-radius: 4px;
                padding: 4px;
                margin-bottom: 4px;
            }

            span.regimen-txt {
                height: 36px;
            }

            .regimen-add {
                justify-content: flex-end;
                margin: 8px 0;
                position: absolute;
                right: 24px;
                z-index: 10;
            }

            .display-type-regimen {
                flex-shrink: 0;
                height: 46px;
            }
            .display-type-regimen .regimen-txt {flex:1;text-align: right;}
            #medication-name {
                flex: 4;
                padding-top: 1px;
            }

            .display-type-regimen vaadin-checkbox {
                margin: 24px 8px 4px 0px;
            }

            .display-type-regimen {
                flex-shrink: 0;
                height: 46px;
            }

            #numberByFrequency {
                text-align: right;
                padding-right: 4px;
            }

            /*paper-input-container {*/
            /*    --paper-input-container-focus-color: var(--app-primary-color);*/
            /*    --paper-input-container-label: {*/
            /*        color: var(--app-text-color);*/
            /*        opacity: 1;*/
            /*    };*/
            /*    --paper-input-container-underline-disabled: {*/
            /*        border-bottom: 1px solid var(--app-text-color);*/

            /*    };*/
            /*    --paper-input-container-color: var(--app-text-color);*/
            /*}*/

            /*paper-dropdown-menu-light {*/
            /*    width: 140px;*/
            /*    height: 22px;*/
            /*}*/

            .comment {
                width: 100%;
                margin-right: 8px;
            }

            .custom-time {
                width: 100%;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }

            .custom-time > div {
                display: flex;
            }

            .custom-time-add {
                height: 20px;
                width: 20px;
                background: var(--app-secondary-color);
                border-radius: 50%;
                padding: 1px;
                margin-right: 4px;
            }

            .add-box {
                position: absolute;
                display: flex;
                flex-direction: column;
                padding: 8px;
                background: white; /*var(--app-background-color-dark);*/
                border-radius: 4px;
                box-shadow: var(--app-shadow-elevation-1);
                transform: translateY(8px);
                z-index: 1;
            }
            .add-box h2 {
                text-align: center;
            }
            .add-box .one-line {
                display: flex;
                flex-direction: row;
                width: 100%;
            }
            .add-box .one-line > * {
                flex: 1;
            }

            .regimen-add .one-line {
                display: flex;
            }
            .regimen-add .one-line.fields { flex:1; }

            .add-first-regimen {
                width: 216px;
                margin: 0 auto;
                cursor: pointer;
            }

            .regimen-line .add-first-regimen {
                margin: initial;
            }

            * .btn-dropdown-container {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                position: absolute;
                background: white;
                z-index: 10;
                width: 216px;
            }

            .add-first-regimen .btn-dropdown-container paper-item {
                text-transform: capitalize;
                height: 28px;
                padding: 0 8px;
            }

            .add-first-regimen .btn-dropdown-container paper-item:hover {
                background: var(--app-background-color-dark);
            }

            .extra-regimen {
                align-items: flex-start;
            }

            .extra-line {
                flex-grow: 1;
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
            }
            .extra-control {
                flex-grow: 0;
                flex-shrink: 0;
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                align-items: center;
            }

            #selectedMedicationTable {
                border: none;
                height: 200px;
            }

            *.capitalize {
                text-transform: capitalize;
            }

            paper-tabs {
                /* background: var(--app-secondary-color);
                --paper-tabs-selection-bar-color: var(--app-text-color-disabled); */
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                --paper-tabs_-_color: var(--app-text-color);
                margin-top: 0;
                flex-shrink: 0;
                padding: 0;
            }

            paper-tab{
                --paper-tab-ink: var(--app-secondary-color);
            }

            #main-table {
                position: relative;
            }

            paper-tab span{
                text-overflow: ellipsis;
                overflow: hidden;
                padding-right: 12px;
                display: block;
                max-width: calc(100% - 34px);
            }

            #custom paper-input-container{
                padding: 0;
                margin: 0 8px;
                --paper-input-container-input: {
                    border: none;
                    outline: 0;
                };
                max-width: 64px;
            }

            .rotate-icon {
                transform: rotate(-225deg);
            }

            .timeOfDay:hover {
                cursor: pointer;
                background: var(--app-background-color-dark);
            }

            #custom paper-input-container input{
                border: none;
                font-size: 1em;
                max-width: 48px;
            }

            #custom paper-input-container input:focus{
                outline: 0;
            }


            @media screen and (max-width: 936px) {
                paper-dialog#medication-detail {
                    position: fixed;
                    max-width: none !important;
                    max-height: none !important;
                    top: 64px;
                    left: 0;
                    height: calc(100vh - 84px) !important;
                    width: 100vw !important;
                    margin: 0;
                    transform: none;
                }
            }

            @media screen and (max-width: 768px) {
                .display-type-regimen {
                    flex-direction: column;
                }
                .display-type-regimen > * {
                    width: 100%;
                    box-sizing: border-box;
                }
                .display-type-regimen .one-line {
                    display: flex;
                    flex-direction: row;
                    width: 100%;
                }
                .display-type-regimen .one-line > * {
                    flex: 1;
                }

                .regimen-add {
                    flex-direction: column;
                    height: auto;
                }
                .regimen-add > * {
                    width: 100%;
                }
                .regimen-add .add-first-regimen .btn-dropdown-container {
                    width: 100%;
                }

                .regimen-add .one-line {
                    display: flex;
                    flex-direction: row;
                    width: 100%;
                }
                .regimen-add .one-line > * {
                    flex: 1;
                }
            }

            .reset-all {
                height: 22px;
                width: 22px;
                margin: 0 4px 0 8px;
                padding: 2px;
            }

            .colour-code span{
                content: '';
                display: inline-block;
                height: 24px;
                width: 24px;
                border-radius: 50%;
                vertical-align: middle;
                background-color: transparent;
                margin-right: 12px;
            }
            .code-icon {
                width: 16px;
                height: 16px;
                margin-right: 4px;
            }

            .alert-icon {
                width: 16px;
                height: 16px;
                color: var(--app-secondary-color-dark);
                margin-right: 4px;
            }

            .date-alert {
                text-align: center;
                margin: 0 8px;
            }

            .allergy-alert {
                padding: 12px 0;
            }
            .allergy-title {
                display: flex;
                align-items: center;
                flex-direction: row;
                color: var(--app-secondary-color-dark);
                font-size: var(--font-size-large);
                font-weight: 700;
            }

            .title {
                position: relative;
                display: inline-block;
            }
            .title h5 {
                margin: 0;
                position: absolute;
                bottom: -4px;
            }

            .text-area {
                width: 100%;
            }
        </style>
        <div class="content container">
            <div class="title">
                <h2>[[medicationDetail.intendedName]]</h2>
                <template is="dom-if" if="[[medicationDetail.samCode]]">
                    <h5>[[medicationDetail.samCode]]</h5>
                </template>
            </div>
            <template is="dom-if" if="[[_hasAllergies(medicationDetail)]]">
                <div class="allergy-alert">
                    <div class="allergy-title">
                        <iron-icon class="alert-icon" icon="icons:warning"></iron-icon>
                        [[localize('aller_int','Allergies et intolérances',language)]]
                    </div>
                    <div class="list">
                        <template is="dom-repeat" items="[[medicationDetail.allergies]]" as="allergy">
                            <div><iron-icon class$="code-icon [[_getAtcStyle(allergy)]]" icon="[[_getAllergyIcon(allergy)]]"></iron-icon>[[_getIcpcLabel(allergy)]]<i>[[_shortDateFormat(allergy.openingDate, allergy.valueDate)]]</i>[[allergy.descr]]</div>
                        </template>
                    </div>
                </div>
            </template>
            <div class="regimen-line display-type-regimen">
                <vaadin-checkbox checked="{{medicationDetail.options.createMedication}}" id="isNew">
                    <template is="dom-if" if="[[!selectedMedicationContentWithId.isMedication]]">
                        [[localize('create_med', 'Créer une médication chronique', language)]]
                    </template>
                    <template is="dom-if" if="[[selectedMedicationContentWithId.isMedication]]">
                        [[localize('update_med', 'Mettre à jour la médication chronique', language)]]
                    </template>
                </vaadin-checkbox>
            </div>
            <template is="dom-if" if="[[medicationDetail.posologyNote]]">
                <div class="regimen-line display-type-regimen">
                    <paper-input-container always-float-label="true" class="comment">
                        <label slot="label" class="color-status">[[localize('proposed_posology','Posologie proposée',language)]]</label>
                        <iron-autogrow-textarea class="paper-input-input" slot="input" disabled value="[[medicationDetail.posologyNote]]"></iron-autogrow-textarea>
                    </paper-input-container>
                    <paper-icon-button class="button--icon-btn" icon="content-copy" role="button" on-tap="_copyPosologyNote"></paper-icon-button>
                </div>
            </template>
            <div class="regimen-line display-type-regimen">
                <paper-dropdown-menu always-float-label id="unit" label="[[localize('qua', 'Quantité', language)]]" disabled="[[!medicationDetail.dividable]]">
                    <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{quantityFactor}}">
                        <template is="dom-repeat" items="[[quantityFactors]]">
                            <paper-item id="[[item.id]]" value="[[item]]">[[localize(item.label, item.numLabel, language)]]</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
                <paper-input always-float-label type="text" readonly label="[[localize('uni','Unité', language)]]" value="{{selectedMedicationContentWithId.medicationUnit}}"></paper-input>
                <paper-input always-float-label type="number" readonly label="[[localize('number', 'Nombre', language)]]" value="{{totalTakes}}" min="0"></paper-input>
            </div>
            <template is="dom-repeat" items="[[regimenKeys]]">
                <ht-regimen-day
                        api="[[api]]" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]"
                        period-config="[[periodConfig]]" regimen-config="[[regimenConfig]]" regimen="{{selectedMedicationContentWithId.medicationValue.regimen}}" key="[[item]]"
                        medication-unit="[[selectedMedicationContentWithId.medicationUnit]]" weekday-codes="[[weekdayCodes]]" occurrences="[[regimenKeys.length]]"
                        quantity-factor=[[quantityFactorValue]] on-regimen-changed="_regimenChanged" on-regimen-delete="_removeRegimen">
                </ht-regimen-day>
            </template>
            <div class="regimen-line display-type-regimen">
                <paper-dropdown-menu always-float-label id="peri" label="[[localize('peri', 'Période', language)]]">
                    <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{periodConfig}}">
                        <template is="dom-repeat" items="[[periodConfigs]]">
                            <paper-item value="[[item]]">[[localize(item.id, item.id, language)]]</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
                <template is="dom-if" if="[[_canAddRegimen(periodConfig)]]">
                    <paper-icon-button class="button--icon-btn" icon="icons:add" on-tap="_addRegimen"></paper-icon-button>
                    <paper-dropdown-menu always-float-label id="periodConfigDropDown" label="[[localize(periodConfig.label, periodConfig.label, language)]]" disabled=[[periodConfig.disabled]]>
                        <paper-listbox id="periodConfig" slot="dropdown-content" attr-for-selected="value" selected="{{regimenKey}}">
                            <template is="dom-repeat" items="[[availableRegimenKeys]]">
                                <paper-item value="[[item]]">[[localize(item, item, language)]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </template>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-input-container always-float-label="true" class="comment">
                    <label slot="label" class="color-status">[[localize('pos','Posology',language)]]</label>
                    <iron-autogrow-textarea class="paper-input-input" slot="input" on-keydown="_instructionOverride" value="{{selectedMedicationContentWithId.medicationValue.instructionForPatient}}"></iron-autogrow-textarea>
                </paper-input-container>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-input-container always-float-label="true" class="comment">
                    <label slot="label" class="color-status">[[localize('','Commentaires pour le patient',language)]]</label>
                    <iron-autogrow-textarea class="paper-input-input" slot="input" value="{{selectedMedicationContentWithId.medicationValue.commentForDelivery}}"></iron-autogrow-textarea>
                </paper-input-container>
            </div>
            <div class="regimen-line display-type-regimen">
                <vaadin-date-picker id="beginMoment" label="[[localize('start-date', 'Start date', language)]]" value="{{medicationDetail.beginMomentAsString}}"
                                    class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                <vaadin-date-picker id="endMoment" label="[[localize('end-date', 'End date', language)]]" value="{{medicationDetail.endMomentAsString}}"
                                    class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                <paper-input always-float-label type="number" min="0" label="[[localize('','Nombre de jours',language)]]" value="{{duration}}"></paper-input>
                <vaadin-date-picker id="endProvisionMoment" label="[[localize('', 'Fin boîte', language)]]" readonly value="[[endProvisionMomentAsString]]"
                                    class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                <paper-input always-float-label type="number" min="0" readonly label="[[localize('','Durée de la provision',language)]]" value="[[provisionDays]]"></paper-input>
                <template is="dom-if" if="[[insufficientProvision]]">
                    <div class="date-alert">
                        <iron-icon class="alert-icon" icon="icons:warning"></iron-icon>
                    </div>
                </template>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-dropdown-menu always-float-label id="medicSubstitution" label="[[localize('', 'Substitution', language)]]">
                    <paper-listbox slot="dropdown-content" selected="{{substitution}}" on-selected-changed="_substitutionChanged">
                        <paper-item id="0">[[localize('','Autorisée',language)]]</paper-item>
                        <paper-item id="1">[[localize('','Non autorisée',language)]]</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>

                <paper-dropdown-menu always-float-label id="medicReimbursement" label="[[localize('presc_reimb', 'Reimbursement', language)]]" class="regimen--reimbursement">
                    <paper-listbox id="reimbursementReason" slot="dropdown-content" class="dropdown-reimbursement" attr-for-selected="value" selected="{{selectedMedicationContentWithId.medicationValue.reimbursementReason}}">
                        <template is="dom-repeat" items="[[reimbursementCodeRecipe]]">
                            <paper-item value="[[item]]">[[_getCodeLabel(item.label)]]</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>

                <vaadin-date-picker id="endMoment" label="[[localize('', 'Déliverance', language)]]" value="{{selectedMedicationContentWithId.endMomentAsString}}"
                                    class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
            </div>
            <div class="regimen-line display-type-regimen">
                <!--
                <vaadin-checkbox checked="[[selectedMedicationContentWithId.medicationValue.substitutionAllowed]]" id="substitutionAllowed" on-checked-changed="_substitutionAllowedChanged">[[localize('substitution', 'Substitution', language)]]</vaadin-checkbox>
                <vaadin-checkbox id="renewal" checked=[[selectedMedicationContentWithId.medicationValue.isRenewal]] on-checked-changed="_renewalValueChanged">[[localize('renewal', 'Renewal', language)]]</vaadin-checkbox>
                -->
                <paper-dropdown-menu always-float-label id="medicRenewal" label="[[localize('', 'Renouvellement', language)]]">
                    <paper-listbox slot="dropdown-content" selected="{{renewal}}" on-selected-changed="_renewalChanged">
                        <paper-item id="0">[[localize('','Autorisé',language)]]</paper-item>
                        <paper-item id="1">[[localize('','Non autorisé',language)]]</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <template is="dom-if" if="[[selectedMedicationContentWithId.medicationValue.isRenewal]]">
                    <paper-input always-float-label type="number" min="0" label="[[localize('', 'Nombre de fois', language)]]" value="{{selectedMedicationContentWithId.medicationValue.renewalDecimalValue}}"></paper-input>
                    <paper-input always-float-label type="number" min="0" label="[[localize('', 'tous le', language)]]" value="{{selectedMedicationContentWithId.medicationValue.renewalDurationValue}}"></paper-input>
                    <paper-dropdown-menu always-float-label id="medicRenewalTimeUnit" label="[[localize('time_unit','Time unit',language)]]" class="regimen--renewalTimeUnit">
                        <paper-listbox slot="dropdown-content" class="dropdown-renewalTimeUnit" selected={{selectedMedicationContentWithId.medicationValue.renewalTimeUnitIdx}} selected-item="{{selectedMedicationContentWithId.medicationValue.renewalDurationUnitItem}}">
                            <template is="dom-repeat" items="[[timeUnit]]" as="tu">
                                <paper-item id="[[tu.id]]">[[_getCodeLabel(tu.label)]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </template>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-input-container always-float-label="true" class="comment">
                    <label slot="label" class="color-status">[[localize('','Commentaires pour le pharmacien',language)]]</label>
                    <iron-autogrow-textarea class="paper-input-input" slot="input" value="{{selectedMedicationContentWithId.medicationValue.commentForDelivery}}"></iron-autogrow-textarea>
                </paper-input-container>
            </div>
        </div>
    </template>
    <script>

        import _ from 'lodash/lodash'
        import moment from 'moment/src/moment'
        import {parse} from "../../../../bower_components/shadycss/src/css-parse";

        class MedicationDetails extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'medication-details'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    selectedMedicationContentWithId: {
                        type: Object,
                        value: null,
                        notify: true
                    },
                    medications: {
                        type: Array,
                        value: []
                    },
                    bufferUnit: {
                        type: String
                    },
                    bufferQuantity: {
                        type: Number,
                        value: 1
                    },
                    bufferNumberByFrequency: {
                        type: Number,
                        value: 1
                    },
                    bufferFrequency: {
                        type: String,
                        value: "daily"
                    },
                    bufferGeneralFrequency: {
                        type: Number,
                        value: 0
                    },
                    medicPriority: {
                        type: Number,
                        value: 0,
                        observer: "_changeMedicPriority"
                    },
                    selectedTab: {
                        type: Number,
                        value: 0
                    },
                    openAddDropDown: {
                        type: Boolean,
                        value: false
                    },
                    openAddColDropDown: {
                        type: Boolean,
                        value: false
                    },
                    reimbursementCodeRecipe: {
                        type: Array,
                        value: () => []
                    },
                    reimbursementItem:{
                        type: Object,
                        value: () => {}
                    },
                    reimbursementItemIdx:{
                        type: Number,
                        value: 0
                    },
                    timeUnit:{
                        type: Array,
                        value: () => []
                    },
                    renewalDurationUnitItem: {
                        type: Object,
                        value: () => {}
                    },
                    renewalTimeUnitIdx:{
                        type: Number,
                        value: 0
                    },
                    renewalDurationValue: {
                        type: Number,
                        value: 0
                    },
                    isRenewal:{
                        type: Boolean,
                        value: false
                    },
                    renewalDecimalValue:{
                        type: Number,
                        value: 0
                    },
                    medicationMustBeCreated:{
                        type: Boolean,
                        value: false
                    },
                    medicationDetail: {
                        type: Object,
                        value: () => {}
                    },
                    substitution: {
                        type: Number,
                        value: 0
                    },
                    duration: {
                        type: Number,
                        value: 0
                    },
                    time: {
                        type: String,
                        value: "10:00"
                    },
                    renewal: {
                        type: Number,
                        value: 0
                    },
                    medication: {
                        type: Object,
                        value: null
                    },
                    quantityFactor: {
                        type: Object,
                        value: null
                    },
                    totalQuantity: {
                        type: Number,
                        value: 0
                    },
                    totalTakes: {
                        type: Number,
                        value: 0
                    },
                    regimenKeys: {
                        type: Array,
                        value: () => [],
                        notify: true
                    },
                    regimenKey: {
                        type: String,
                        value: ""
                    },
                    medicationId: {
                        type: String,
                        value: ""
                    },

                    quantityFactors: {
                        type: Array,
                        value: () => [
                            {id: "one", label: "quantity_factor_one", numLabel: "1", denominator: 1},
                            {id: "half", label: "quantity_factor_half", numLabel: "1/2", denominator: 2},
                            {id: "third", label: "quantity_factor_third", numLabel: "1/3", denominator: 3},
                            {id: "quarter", label: "quantity_factor_quarter", numLabel: "1/4", denominator: 4}
                        ]
                    },

                    weekdayKeys: {
                        type: Array,
                        value: () => ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"]
                    },

                    periodConfigs: {
                        type: Array,
                        value: () => [
                            {id: "dailyPosology", title: "dai", keys: [], label: "", disabled: true, keyId: ""},
                            {id: "weeklyPosology", title: "wee", keys: ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"], label: "dayOfWeek", disabled: false, keyId: "weekday"}
                            // @ todo: dayNumber not supported in posologyString
                            // {id: "monthly", keys: _.range(1, 32), label: "dayOfMonth", disabled: false, keyId: "dayNumber"}
                        ]
                    },

                    periodConfig: {
                        type: Object,
                        value: {id: ""}
                    },

                    availableRegimenKeys: {
                        type: Array,
                        value: () => [""]
                    },

                    regimenConfig: {
                        type: Array,
                        value: () => [
                            {id: "afterwakingup"},
                            {id: "beforebreakfast", parentId: "morning"},
                            {id: "morning"},
                            {id: "duringbreakfast", parentId: "morning"},
                            {id: "afterbreakfast", parentId: "morning"},
                            {id: "betweenbreakfastandlunch"},
                            {id: "beforelunch", parentId: "midday"},
                            {id: "midday"},
                            {id: "duringlunch", parentId: "midday"},
                            {id: "afterlunch", parentId: "midday"},
                            {id: "betweenlunchanddinner"},
                            {id: "beforedinner", parentId: "evening"},
                            {id: "evening"},
                            {id: "duringdinner", parentId: "evening"},
                            {id: "afterdinner", parentId: "evening"},
                            {id: "thehourofsleep"}
                        ]
                    },

                    weekdayCodes: {
                        type: Array,
                        value: () => []
                    },

                    reimbursementReason: {
                        type: Object,
                        value: () => {}
                    },

                    insufficientProvision: {
                        type: Boolean,
                        value: false
                    }
                }
            }

            static get observers() {
                return [
                    '_changeBeginMoment(medicationDetail.beginMomentAsString)',
                    '_changeEndMoment(medicationDetail.endMomentAsString)',
                    '_changeDuration(duration)',
                    '_regimenChanged(selectedMedicationContentWithId.medicationValue, selectedMedicationContentWithId.medicationValue.regimen.*)',
                    '_changeReimbursementItem(reimbursementItem)',
                    '_changeRenewalTimeUnitItem(renewalDurationUnitItem, renewalDurationValue, renewalDecimalValue)',
                    '_medicationChanged(medication, medication.*)',
                    // '_medicationDetailChanged(medicationDetail.*)',
                    '_quantityFactorChanged(quantityFactor)',
                    '_periodChanged(periodConfig)',
                    '_reimbursementReasonChanged(reimbursementReason)'
                ];
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            _reimbursementReasonChanged() {
                this.set("selectedMedicationContentWithId.medicationValue.reimbursementReason", this.reimbursementReason);
            }

            _quantityFactorChanged() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                regimen.filter(reg => reg.administratedQuantity && reg.administratedQuantity.quantity || "")
                    .forEach(reg => {
                        const quantity = reg.administratedQuantity.quantity;
                        reg.administratedQuantity.unit = this.selectedMedicationContentWithId.medicationUnit;
                        reg.administratedQuantity.quantity = this.quantityFactor.denominator > 1 && this.quantityFactor.numLabel || parseInt(quantity) || "";
                    });
                this.set("quantityFactorValue", this.quantityFactor);
                this.notifyPath("selectedMedicationContentWithId.medicationValue", "changed");
            }

            // _medicationDetailChanged(e) {
            //     console.log("__medicationDetailChanged()", this.medicationDetail)
            //     this.dispatchEvent(new CustomEvent('value-changed', {detail: {id: this.medicationDetail.id}, bubbles: true, composed: true}))
            // }

            _hasAllergies(item) {
                return item && item.allergies && item.allergies.length;
            }

            _getAllergyIcon(item) {
                return item.type === "allergy" ? "image:filter-vintage" : (item.type === "adr" ? "vaadin:pill" : "");
            }

            _getAtcStyle(item) {
                if (!item || !item.atcCode) return '';
                return 'ATC--' + item.atcCode[0].toUpperCase();
            }

            _getIcpcLabel(item) {
                const icpc = item.codes && item.codes.find(code => code.type==='ICPC' || code.type==='ICPC2');
                return icpc && (icpc.code || icpc.id.split("|")[1]) || "";
            }

            _shortDateFormat(date, altDate) {
                return (date || altDate) && this.api.moment((date || altDate)).format("YY") || "";
            }

            _any(a,b,c,d,e) {
                return a||b||c||d||e
            }

            _getCodeLabel(code){
                return code && code[this.language]
            }

            _instructionOverride() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (regimen && regimen.length) {
                    this._resetAll()
                }
            }

            _regimenChanged() {
                this._updateStats();
                this.set("selectedMedicationContentWithId.medicationValue.instructionForPatient", "");
                // exp
                if (this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.medicationValue && this.selectedMedicationContentWithId.medicationValue.regimen) {
                    this.selectedMedicationContentWithId.medicationValue.regimen.forEach(reg => {
                        reg.frequency = "weekly";
                    });
                }

                this.set("selectedMedicationContentWithId.medicationValue.instructionForPatient",this.api.contact().medication().posologyToString(this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.medicationValue || {}, this.language))
            }

            _updateStats() {
                if (!this.quantityFactor) return;
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                let totalDoses = parseInt(_.get(this.medicationDetail, "packDisplayValue", 0), 10) * parseInt(_.get(this.medicationDetail, "boxes", 0), 10) * this.quantityFactor.denominator;
                const keys= this.periodConfig.id === "weeklyPosology" ? this.weekdayKeys : [""];
                let tomorrowDayNumber = this.periodConfig.id === "weeklyPosology" ? moment().weekday() : 0;

                let takes = keys.map(key => regimen.reduce((total, period) => {
                        if (!key || _.get(period, "weekday.code", 0) === key) {
                            total += (this.quantityFactor.denominator > 1) && 1 || parseInt(period.administratedQuantity.quantity, 10) || 0;
                        }
                        return total;
                    }, 0)
                );

                const totalTakes = takes.reduce((total, quantity) => {
                    total += quantity;
                    return total;
                }, 0);
                const totalQuantity = Math.round(totalTakes / this.quantityFactor.denominator);

                let duration = 0;
                if (totalTakes > 0) {
                    while (totalDoses > 0) {
                        totalDoses -= (takes[(++tomorrowDayNumber) % takes.length] || 0);
                        duration += (totalDoses >= 0 && 1 || 0);
                    }
                }

                const endProvisionMoment = this._beginMoment().add(duration, "days");

                this.set("totalQuantity", totalQuantity);
                this.set("totalTakes", totalTakes);
                this.set("provisionDays", duration);
                this.set("endProvisionMomentAsString", endProvisionMoment.format("YYYY-MM-DD"));
                this.set("insufficientProvision", (endProvisionMoment.isBefore(this._endMoment())));
            }

            _beginMoment() {
                return this.api.moment(this.medicationDetail.beginMomentAsString, "YYYY-MM-DD");
            }

            _endMoment() {
                return this.api.moment(this.medicationDetail.endMomentAsString, "YYYY-MM-DD");
            }

            _changeBeginMoment() {
                if (this.medicationDetail &&
                    this.medicationDetail.beginMomentAsString) { // begin moment can NOT be empty
                    const endMoment = this._beginMoment().add(this.duration, "days");
                    this.set("medicationDetail.endMomentAsString", endMoment.format("YYYY-MM-DD"));
                    this.set("selectedMedicationContentWithId.medicationValue.beginMoment", this._beginMoment());
                    this.set("selectedMedicationContentWithId.medicationValue.endMoment", endMoment);
                    this._updateStats();
                }
            }

            _changeEndMoment() {
                if (this.medicationDetail &&
                    this.medicationDetail.beginMomentAsString &&
                    (this.medicationDetail.endMomentAsString != null)) {
                    this.set("duration", this._endMoment().diff(this._beginMoment(), "days"));
                    this.set("selectedMedicationContentWithId.medicationValue.endMoment", this._endMoment());
                    this._updateStats();
                }
            }

            _changeDuration() {
                if (this.medicationDetail &&
                    this.medicationDetail.beginMomentAsString) {
                    const endMoment = this._beginMoment().add(this.duration, "days");
                    this.set("medicationDetail.endMomentAsString", endMoment.format("YYYY-MM-DD"));
                    this.set("selectedMedicationContentWithId.medicationValue.endMoment", endMoment);
                    this._updateStats();
                }
            }

            _medicationChanged(medication) {
                if (!medication) return;

                if (this.medicationId === medication.id) {
                    this._updateStats();
                    return;
                }
                this.medicationId = medication.id;

                const content =  this.extractContentWithIdFromMedicationService(medication.newMedication, medication.options.isNew, medication.options.isPrescription);
                this.set("selectedMedicationContentWithId", content);
                this._initSelectedMedicationContentWithId();
                this.set("medicationDetail", Object.assign(
                    medication,
                    {
                        beginMomentAsString : this.api.moment((content && content.medicationValue && content.medicationValue.beginMoment) || (medication.newMedication && medication.newMedication.valueDate) || (medication.newMedication && medication.newMedication.openingDate) || Date.now()).format('YYYY-MM-DD') || null,
                        endMomentAsString: this.api.moment((content && content.medicationValue && content.medicationValue.endMoment) || (medication.newMedication && medication.newMedication.closingDate)) ? this.api.moment(content.medicationValue.endMoment || (medication.newMedication && medication.newMedication.closingDate)).format("YYYY-MM-DD") : null,
                        dividable: medication.dividable === undefined ? true : medication.dividable,
                        packDisplayValue: medication.packDisplayValue || 0,
                        bufferUnit: this.selectedMedicationContentWithId.medicationUnit || this.localize('generic_unit', 'unit', this.language),
                        medicPriority : this.selectedMedicationContentWithId.medicationValue.priority === "high" ? 2 : this.selectedMedicationContentWithId.medicationValue.priority === "middle" ? 1 : 0,
                        isRenewal : !!this.selectedMedicationContentWithId.medicationValue.renewal,
                        renewalDecimalValue : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.decimal ? this.selectedMedicationContentWithId.medicationValue.renewal.decimal : 1 : null,
                        renewalDurationValue : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.duration.value ? this.selectedMedicationContentWithId.medicationValue.renewal.duration.value : 1 : null,
                        renewalTimeUnitIdx : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal ? this.timeUnit.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.renewal.duration.unit.code) : this.timeUnit.findIndex(idx => idx.code === "mo") : null
                    }
                ));

                this.set("reimbursementReason", this.selectedMedicationContentWithId.medicationValue.reimbursementReason ? this.reimbursementCodeRecipe.find(item => item.code === this.selectedMedicationContentWithId.medicationValue.reimbursementReason.code) : this.reimbursementCodeRecipe.find(item => item.code === "notreimbursable"));

                // this.notifyPath("medicationDetail.boxes", "changed");
                const quantitySample = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen[0].administratedQuantity.quantity", "");
                this.set("quantityFactor", quantitySample && !parseInt(quantitySample, 10) && this.quantityFactors.find(q => q.numLabel === quantitySample) || this.quantityFactors[0]);

                // @todo: month (dayNumber) and date
                const period = _.has(this.selectedMedicationContentWithId, "medicationValue.regimen[0].weekday") ? "weeklyPosology" : "dailyPosology" ;
                if (this.periodConfig.id !== period) {
                    this.set("periodConfig", this.periodConfigs.find(config => config.id === period));
                } else {
                    this._periodChanged();
                }
            }


            _periodChanged() {
                if (!this.periodConfig.id) return;
                let regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                this.set("selectedMedicationContentWithId.medicationValue.regimen", regimen.filter(reg => this.periodConfig.id === "weeklyPosology" ? reg.weekday : !reg.weekday));
                this._initRegimenKeys();
            }

            _initRegimenKeys() {
                this.splice("regimenKeys", 0, this.regimenKeys.length);
                let regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (this.periodConfig.id === "weeklyPosology") {
                    if (!regimen.length) {
                        this.push("regimenKeys", this.periodConfig.keys[0]);
                    } else {
                        const keyId = this.periodConfig.keyId;
                        if (keyId === "weekday") {
                            const regimenKeys = regimen.filter((e, i, a) => a.findIndex(x => x[keyId].code === e[keyId].code) === i)
                                .map(reg => reg[keyId].code)
                                .filter(code => this.weekdayCodes.some(weekdayCode => weekdayCode.code === code));
                            this.push("regimenKeys", ...regimenKeys)
                        } else {
                            // @todo: dayNumber and date cases
                        }
                    }
                } else {
                    this.push("regimenKeys", "none");
                }
                this._updatePeriodConfigs();
            }

            _updatePeriodConfigs() {
                if (!this.periodConfig) return;
                if (this.periodConfig.id !== "dailyPosology") {
                    this.splice("availableRegimenKeys", 0, this.availableRegimenKeys.length);
                    const availableRegimenKeys = this.periodConfig.keys.filter(key => !this.regimenKeys.some(regKey => regKey === key));
                    if (availableRegimenKeys.length) {
                        this.push("availableRegimenKeys", ...availableRegimenKeys);
                        this.set("regimenKey", availableRegimenKeys[0]);
                    }
                }
            }
            _canAddRegimen() {
                // @ todo
                // return (this.periodConfig.id === "weeklyPosology") || (this.periodConfig.id === "monthlyPosology");
                return (this.periodConfig.id === "weeklyPosology" && this.availableRegimenKeys.length);
            }

            _canDeleteRegimen() {
                return (this.regimenKeys.length > 1);
            }

            _addRegimen() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                if (!this.regimenKey) return;
                if (this.regimenKeys.includes(this.regimenKey))
                    return;
                this.push("regimenKeys", this.regimenKey);
                this._updatePeriodConfigs();
            }

            _removeRegimen(e) {
                const key = _.get(e, "detail.key", "")
                if (!key) return;
                if (this.periodConfig.id === "dailyPosology") return;
                if (this.regimenKeys.length < 2) return;
                const keyId = this.periodConfig.keyId;
                let regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (keyId === "weekday") {
                    regimen = regimen.filter(reg => reg.weekday && reg.weekday.code != key)
                } else {
                    // @ todo dayNumber and date
                }
                this.set("selectedMedicationContentWithId.medicationValue.regimen", regimen);
                this.splice("regimenKeys", this.regimenKeys.indexOf(key), 1);
                this._updatePeriodConfigs();
            }


            _all(a,b) { return a && b }

            _regimenLines() {
                return this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.medicationValue && this.selectedMedicationContentWithId.medicationValue.regimen || []
            }

            extractContentWithIdFromMedicationService(m, isNew, isPres) {
                const content = this.api.contact().preferredContent(m, this.language)  || (m.content[this.language] = {
                    medicationValue: {regimen: []},
                    medicationUnit: this.localize("generic_unit", "unit")
                });
                return {
                    id: m.id,
                    codes: m.codes,
                    medicationValue: content.medicationValue,
                    medicationUnit: content.medicationUnit,
                    isNew: isNew || false,
                    isPrescription: m.isPrescription || isPres || false,
                    isMedication: m.tags && m.tags.length && m.tags.some(tag => tag.type === "CD-ITEM" && tag.code === "medication") || false
                };
            }

            open(medicationDetail, selectedMedicationContentWithId, boxes) {
                //console.log("open medication-details:", medicationDetail, selectedMedicationContentWithId, boxes)
                ;(!this.reimbursementCodeRecipe || this.reimbursementCodeRecipe.length === 0 || !this.timeUnit || this.timeUnit.length === 0 ? this.api.code().findPaginatedCodes('be', 'CD-REIMBURSEMENT-RECIPE', '')
                    .then(reimb => this.set("reimbursementCodeRecipe", _.orderBy(reimb.rows, ['label.fr'], ['asc'])))
                    .then(() => this.api.code().findPaginatedCodes('be', 'CD-TIMEUNIT', ''))
                    .then(timeunit => this.set("timeUnit", _.orderBy(_.filter(_.get(timeunit, "rows", []), i => ["ns", "us", "ms", "s", "min"].indexOf(_.trim(_.get(i, "code"))) == -1), ['label.fr'], 'asc'))) : Promise.resolve())
                    .finally(() => {
                        if (medicationDetail) {
                            let idx = this.medications.indexOf(medicationDetail);
                            if (idx > -1) {
                                this._selectedMedicationChanged(idx)
                            } else {
                                const preferredContent = this.api.contact().preferredContent(medicationDetail, this.language)

                                if (!selectedMedicationContentWithId || !selectedMedicationContentWithId.isNew) { // selectedMedicationContentWithId.isNew==false when opening an existing medication
                                    // do not set a default date if not defined, for the user to see when a medication has no date
                                    const start = (preferredContent && preferredContent.medicationValue && preferredContent.medicationValue.beginMoment)
                                        || (medicationDetail.valueDate)
                                        || (medicationDetail.openingDate)
                                    const end = (preferredContent && preferredContent.medicationValue && preferredContent.medicationValue.endMoment)
                                        || (medicationDetail.closingDate)
                                    selectedMedicationContentWithId = this.extractContentWithIdFromMedicationService(medicationDetail, false, selectedMedicationContentWithId.isPrescription)
                                    selectedMedicationContentWithId.beginMomentAsString = start && this.api.moment(start).format('YYYY-MM-DD') || null
                                    selectedMedicationContentWithId.endMomentAsString = end && this.api.moment(end).format('YYYY-MM-DD') || null
                                } else { // new medication, should set a default start date
                                    selectedMedicationContentWithId.beginMomentAsString = this.api.moment(Date.now()).format("YYYY-MM-DD")
                                }

                                this.set('selectedMedicationContentWithId', selectedMedicationContentWithId)
                                this._initSelectedMedicationContentWithId()
                                this.set('previousMedication', this.selectedMedicationContentWithId)
                                this.set('medicationDetail', {
                                    boxes: boxes || 1,
                                    bufferUnit: this.selectedMedicationContentWithId.medicationUnit || this.localize('generic_unit', 'unit', this.language),
                                    medicPriority: this.selectedMedicationContentWithId.medicationValue.priority === "high" ? 2 : this.selectedMedicationContentWithId.medicationValue.priority === "middle" ? 1 : 0,
                                    reimbursementItemIdx: this.selectedMedicationContentWithId.medicationValue.reimbursementReason ? this.reimbursementCodeRecipe.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.reimbursementReason.code) : this.reimbursementCodeRecipe.findIndex(idx => idx.code === "notreimbursable"),
                                    isRenewal: !!this.selectedMedicationContentWithId.medicationValue.renewal,
                                    renewalDecimalValue: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.decimal ? this.selectedMedicationContentWithId.medicationValue.renewal.decimal : 1 : null,
                                    renewalDurationValue: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.duration.value ? this.selectedMedicationContentWithId.medicationValue.renewal.duration.value : 1 : null,
                                    renewalTimeUnitIdx: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal ? this.timeUnit.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.renewal.duration.unit.code) : this.timeUnit.findIndex(idx => idx.code === "mo") : null,
                                    newMedication: medicationDetail,
                                    options: {
                                        createMedication: this.selectedMedicationContentWithId.createMedication,
                                        isPrescription: this.selectedMedicationContentWithId.isPrescription
                                    }
                                })
                            }

                            this.set('medicationMustBeCreated', false)
                            this.set('openAddDropDown', false)

                            this.substitution = this.selectedMedicationContentWithId.medicationValue.substitutionAllowed ? 0 : 1;
                            this.$['medication-detail'].open()

                            // this._updateView();
                        }
                    })
            }

            init() {
                return this.api.code().findCodes("be", "CD-DAYPERIOD")
                    .then(dayPeriods => this.api.code().findCodes("be", "care.topaz.customDayPeriod")
                        .then(customDayPeriods => dayPeriods.concat(customDayPeriods)))
                    .then(dayPeriods => {
                        return Promise.all(this.regimenConfig.map(reg => {
                            let dayPeriod = dayPeriods.find(dayPeriod => dayPeriod.code === reg.id);
                            if (!dayPeriod) {
                                dayPeriod = {code: reg.id, type: "CD-DAYPERIOD"};
                            }
                            Object.assign(reg, {dayPeriod: dayPeriod});
                            if (!dayPeriod.label || !dayPeriod.label[this.language]) {
                                dayPeriod.label = _.fromPairs([[this.language, _.lowerCase(_.trim(this.localize(`ms_${reg.id}`, reg.id)))]]);
                            }
                        }))
                    })
                    .then(() => this.api.code().findCodes("be", "CD-WEEKDAY"))
                    .then((weekdayCodes) => this.set("weekdayCodes", weekdayCodes
                        .map(weekdayCode => {
                            const day = weekdayCode.label[this.language] || "";
                            const number = this.weekdayKeys.indexOf(weekdayCode.code) || -1;
                            return Object.assign(
                                weekdayCode,
                                {
                                    "weekday": day,
                                    "weekNumber": (number > -1) && number || 0
                                });
                        })
                    ))
                    .then (() => {
                        if (this.reimbursementCodeRecipe && this.reimbursementCodeRecipe.length) return Promise.resolve();
                        return this.api.code().findPaginatedCodes('be', 'CD-REIMBURSEMENT-RECIPE', '')
                            .then(reimb => this.push("reimbursementCodeRecipe", ..._.orderBy(reimb.rows, ['label.fr'], ['asc'])))
                    })
                    .then(() => {
                        if (this.timeUnit && this.timeUnit.length) return Promise.resolve();
                        return this.api.code().findPaginatedCodes('be', 'CD-TIMEUNIT', '')
                            .then(timeUnit => this.push("timeUnit", ..._.orderBy(_.filter(_.get(timeUnit, "rows", []), i => ["ns", "us", "ms", "s", "min"].indexOf(_.trim(_.get(i, "code"))) === -1), ['label.fr'], 'asc')))
                    });
            }

            _resetAll() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                this.splice("selectedMedicationContentWithId.medicationValue.regimen", 0, regimen.length);
            }

            _copyPosologyNote() {
                this._resetAll();
                this.set("selectedMedicationContentWithId.medicationValue.instructionForPatient", this.medicationDetail.posologyNote);
            }

            _initSelectedMedicationContentWithId(){
                this.selectedMedicationContentWithId.medicationValue && !this.selectedMedicationContentWithId.medicationValue.regimen ? this.set('selectedMedicationContentWithId.medicationValue.regimen', []) : null
            }

            openList(list) {
                // ------------------if we want to create an array even when we have only one medication selected
                // list && list.length > 0 ? this.set('medications', _.clone(list)) : (list.newMedication && this.set('medications',[list])) || this.set('medications', [])
                // ----------------------------------------------------------------------------------------------
                list && list.length > 0 ? this.set('medications', _.clone(list)) : this.set('medications', [])
                if (this.medications.length) {
                    this.open(this.medications[0], this.extractContentWithIdFromMedicationService(this.medications[0].newMedication, true, this.medications[0].options.isPrescription), this.medications[0].boxes);
                    this.set('selectedMedication',0);
                }
            }

            _localize(s) {
                return this.api.contact().medication().localize(s, this.language);
            }

            _changeMedicPriority() {
                // console.log('_changeMedicPriority')
                if (this.selectedMedicationContentWithId) {
                    const priority = this.selectedMedicationContentWithId.medicationValue.priority?
                        this.selectedMedicationContentWithId.medicationValue.priority=== 2 ? 'high' :
                            this.selectedMedicationContentWithId.medicationValue.priority=== 1 ? 'middle' : 'low' :
                        'low';
                    this.set("selectedMedicationContentWithId.medicationValue.priority", priority);
                }
            }

            cancel() {
                this.close()
            }

            EOLAndClose(){
                const today = parseInt(moment().subtract(1, 'days').format("YYYYMMDD"), 10)
                this.set("medicationDetail.newMedication.endOfLife", today)
                this.save()
                this.close()
            }

            endAndClose(){
                const yesterday = parseInt(moment().subtract(1, 'days').format("YYYYMMDD"), 10)
                this.set("selectedMedicationContentWithId.medicationValue.endMoment", yesterday)
                this.save()
                this.close()
            }

            saveAndClose() {
                this.save() // instant save
                this.close()
            }

            close() {
                this.set("selectedMedicationContentWithId", null)
                this.set('medications', [])
            }

            test() {
                const regs = this._register();
                console.log(regs);
            }

            _changeReimbursementItem(item) {
                if(item && item.id){
                    const reimbursementItem = this.reimbursementCodeRecipe.find(r => r.id === item.id)
                    this.set("selectedMedicationContentWithId.medicationValue.reimbursementReason", reimbursementItem)
                }
            }

            _substitutionChanged(e) {
                this.set('selectedMedicationContentWithId.medicationValue.substitutionAllowed', e.detail.value === 0);
            }

            _substitutionAllowedChanged(e) {
                this.set('selectedMedicationContentWithId.medicationValue.substitutionAllowed', e.target.checked);
            }

            _renewalChanged(e) {
                this._setRenewal(e.detail.value === 0);
            }

            _renewalValueChanged(e){
                this._setRenewal(e.target.checked);
            }

            _setRenewal(isRenewal){
                this.set('selectedMedicationContentWithId.medicationValue.isRenewal', isRenewal);
                if(!isRenewal){
                    this.set("selectedMedicationContentWithId.medicationValue.renewal", null);
                }
            }

            _changeRenewalTimeUnitItem(item, unitValue, decimalValue){
                if(item && item.id){
                    const timeUnitItem = this.timeUnit.find(r => r.id === item.id)
                    this.set("selectedMedicationContentWithId.medicationValue.renewal", {
                        decimal: decimalValue,
                        duration: {
                            value: unitValue,
                            unit: timeUnitItem
                        }
                    })
                }
            }

            _createMedication(e){
                this.set('medicationDetail.options.createMedication', e.target.checked)
                this.set('selectedMedicationContentWithId.createMedication', e.target.checked)
            }

            _medicationName(svc) {
                return this.api.contact().medication().medicationNameToString(this.api.contact().preferredContent(svc, this.language).medicationValue) || ''
            }
        }

        customElements.define(MedicationDetails.is, MedicationDetails)
    </script>
</dom-module>
