<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../styles/scrollbar-style.html">
<link rel="import" href="../../../styles/dropdown-style.html">
<link rel="import" href="../../../styles/dialog-style.html">
<link rel="import" href="../../../styles/paper-input-style.html">
<link rel="import" href="../../../styles/dropdown-style.html">
<link rel="import" href="../../../styles/atc-styles.html">
<link rel="import" href="../../../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../ht-regimen-day.html">

<dom-module id="medication-details">
    <template>
        <style include="scrollbar-style dropdown-style dialog-style atc-styles vaadin-icure-theme">
            .container {
                box-sizing: content-box;
                max-height: unset;
                height: 100%;
                overflow-y: scroll;
                padding: 24px 12px;
            }

            #medication-detail .save-line {
                height: 20px;
            }

            .modal-title{
                justify-content: flex-start;
            }

            .modal-title iron-icon {
                margin-right: 8px;
            }

            .medication-line > span {
                padding: 0 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 90%;
                white-space: nowrap;
            }

            .regimen-line {
                display: flex;
                flex-flow: row nowrap;
                align-items: center;
            }

            .regimen-line.block{
                justify-content: flex-start;
                align-items: flex-end;
                height: 46px;
                padding: 0 0 16px 0;
            }

            .regimen-line paper-icon-button {
                height: 28px;
                width: 28px;
                padding: 2px;
            }
            .regimen-line vaadin-checkbox {
                margin-right: 8px;
            }
            .regimen-line div {
                /*align-self: flex-end;*/
                /*margin-bottom: 8px;*/
                /*width: auto;*/
            }
            .regimen-line paper-input[type=number] {
                margin: 0 8px;
                width: 128px;
            }
            .regimen-line paper-input[type=text] {
                margin: 0 8px;
            }

            .regimen-line paper-dropdown-menu {
                margin: 0 8px;
            }

            .regimen-line.block .renewal-input{
                max-height: 42px;
                min-height: 0;
                max-width: 50px;
                text-align: center;
                --paper-input-container: {
                    padding: 0;
                }
            }
            .regimen-line.block paper-dropdown-menu {
                margin-right: 8px;
                --paper-dropdown-menu-input: {
                    height: 42px;
                    padding: 0;
                };
                --paper-input-container: {
                    padding: 0;
                };
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            .regimen-line.block span{
                margin-right: 4px;
            }

            .regimen-line.block paper-checkbox{
                margin-right: 8px;
                --paper-checkbox-checked-color: var(--app-secondary-color);
            }

            .regimen--frequency {
                margin: auto;
            }

            .regimen--tod {
                margin: auto;
                margin: 0 4px;
                flex-grow: 1;
            }

            .regimen--quantity {
                margin-right: 4px;
                width: 80px;
                text-align: right;
            }

            .regimen-grid-quantity {
                margin-left: auto;
                margin-right: auto;
                width: 48px;
                text-align: center;
                position: relative;
                --paper-input-container-underline: {
                    border-color: transparent;
                };
                --paper-input-container-input: {
                    transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
                };
            }

            .regimen-grid-quantity:hover{
                --paper-input-container-input: {
                    background: var(--app-background-color-darker);
                }
            }

            .regimen--units {
                margin: auto;
                width: 168px;
            }

            .regimen--datepicker {
                max-width: 152px;
                cursor: pointer;
                flex: 1;
            }

            .regimen-extra {
                display: flex;
                flex-direction: row;
            }

            paper-input {
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            paper-input.center {
                text-align: center;
            }

            #filter {
                width: 50%;
            }

            .dropdown-priority {
                cursor: pointer;
            }

            .regimen-lines {
                border-top: 1px solid var(--app-background-color-dark);
                margin-bottom: auto;
                padding: 0 12px;
            }
            .force-left {
                left: 12px;
            }
            .force-right {
                right: 12px;
            }

            .posology-btn {
                left: 100%;
                transform: translateX(-100%);
                padding-right: 3px;
            }

            .marginRight10 {
                margin-right: 10px;
            }

            iron-input#medicNameInput {
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
            }

            .regimen-details {
                border: 1px solid var(--app-background-color-dark);
                border-radius: 4px;
                padding: 4px;
                margin-bottom: 4px;
            }

            span.regimen-txt {
                height: 36px;
            }

            .regimen-add {
                justify-content: flex-end;
                margin: 8px 0;
                position: absolute;
                right: 24px;
                z-index: 10;
            }

            .display-type-regimen {
                flex-shrink: 0;
            }
            .display-type-regimen .regimen-txt {flex:1;text-align: right;}
            #medication-name {
                flex: 4;
                padding-top: 1px;
            }

            #numberByFrequency {
                text-align: right;
                padding-right: 4px;
            }

            paper-input-container {
                --paper-input-container-focus-color: var(--app-primary-color);
                --paper-input-container-label: {
                    color: var(--app-text-color);
                    opacity: 1;
                };
                --paper-input-container-underline-disabled: {
                    border-bottom: 1px solid var(--app-text-color);

                };
                --paper-input-container-color: var(--app-text-color);
            }


            .comment {
                width: 100%;
                margin-right: 8px;
            }

            .custom-time {
                width: 100%;
                display: flex;
                flex-direction: row;
                justify-content: space-between;
            }

            .custom-time > div {
                display: flex;
            }

            .custom-time-add {
                height: 20px;
                width: 20px;
                background: var(--app-secondary-color);
                border-radius: 50%;
                padding: 1px;
                margin-right: 4px;
            }

            .add-box {
                position: absolute;
                display: flex;
                flex-direction: column;
                padding: 8px;
                background: white; /*var(--app-background-color-dark);*/
                border-radius: 4px;
                box-shadow: var(--app-shadow-elevation-1);
                transform: translateY(8px);
                z-index: 1;
            }
            .add-box h2 {
                text-align: center;
            }
            .add-box .one-line {
                display: flex;
                flex-direction: row;
                width: 100%;
            }
            .add-box .one-line > * {
                flex: 1;
            }

            .regimen-add .one-line {
                display: flex;
            }
            .regimen-add .one-line.fields { flex:1; }

            .add-first-regimen {
                width: 216px;
                margin: 0 auto;
                cursor: pointer;
            }

            .regimen-line .add-first-regimen {
                margin: initial;
            }

            * .btn-dropdown-container {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                position: absolute;
                background: white;
                z-index: 10;
                width: 216px;
            }

            .add-first-regimen .btn-dropdown-container paper-item {
                text-transform: capitalize;
                height: 28px;
                padding: 0 8px;
            }

            .add-first-regimen .btn-dropdown-container paper-item:hover {
                background: var(--app-background-color-dark);
            }

            .extra-regimen {
                align-items: flex-start;
            }

            .extra-line {
                flex-grow: 1;
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
            }
            .extra-control {
                flex-grow: 0;
                flex-shrink: 0;
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                align-items: center;
            }

            #selectedMedicationTable {
                border: none;
                height: 200px;
            }

            *.capitalize {
                text-transform: capitalize;
            }

            paper-tabs {
                /* background: var(--app-secondary-color);
                --paper-tabs-selection-bar-color: var(--app-text-color-disabled); */
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                --paper-tabs_-_color: var(--app-text-color);
                margin-top: 0;
                flex-shrink: 0;
                padding: 0;
            }

            paper-tab{
                --paper-tab-ink: var(--app-secondary-color);
            }

            #main-table {
                position: relative;
            }

            paper-tab span{
                text-overflow: ellipsis;
                overflow: hidden;
                padding-right: 12px;
                display: block;
                max-width: calc(100% - 34px);
            }

            #custom paper-input-container{
                padding: 0;
                margin: 0 8px;
                --paper-input-container-input: {
                    border: none;
                    outline: 0;
                };
                max-width: 64px;
            }

            .rotate-icon {
                transform: rotate(-225deg);
            }

            .timeOfDay:hover {
                cursor: pointer;
                background: var(--app-background-color-dark);
            }

            #custom paper-input-container input{
                border: none;
                font-size: 1em;
                max-width: 48px;
            }

            #custom paper-input-container input:focus{
                outline: 0;
            }


            @media screen and (max-width: 936px) {
                paper-dialog#medication-detail {
                    position: fixed;
                    max-width: none !important;
                    max-height: none !important;
                    top: 64px;
                    left: 0;
                    height: calc(100vh - 84px) !important;
                    width: 100vw !important;
                    margin: 0;
                    transform: none;
                }
            }

            @media screen and (max-width: 768px) {
                .display-type-regimen {
                    flex-direction: column;
                }
                .display-type-regimen > * {
                    width: 100%;
                    box-sizing: border-box;
                }
                .display-type-regimen .one-line {
                    display: flex;
                    flex-direction: row;
                    width: 100%;
                }
                .display-type-regimen .one-line > * {
                    flex: 1;
                }

                .regimen-add {
                    flex-direction: column;
                    height: auto;
                }
                .regimen-add > * {
                    width: 100%;
                }
                .regimen-add .add-first-regimen .btn-dropdown-container {
                    width: 100%;
                }

                .regimen-add .one-line {
                    display: flex;
                    flex-direction: row;
                    width: 100%;
                }
                .regimen-add .one-line > * {
                    flex: 1;
                }
            }

            ht-regimen-item {
                --counter-height: 28px;
                /*--counter-width: 48px;*/
                --counter-border-top-width: 1px;
                --counter-border-left-width: 1px;
                --counter-border-right-width: 1px;
                --counter-border-bottom-width: 1px;
                --counter-border-radius: 0 0 0 0;
            }

            ht-regimen-item.big {
                /*--counter-width: 144px;*/
            }

            ht-regimen-item.small {
                --counter-border-left-width: 0px;
                --counter-border-right-width: 0px;
            }

            ht-regimen-item.left {
                --counter-border-right-width: 0px;
                --counter-border-radius: 4px 0 0 4px;
            }

            ht-regimen-item.right {
                --counter-border-left-width: 0px;
                --counter-border-radius: 0 4px 4px 0;
            }

            ht-regimen-item.bottom-left {
                --counter-border-top-width: 0px;
                --counter-border-radius: 0 0 0 4px;
            }

            ht-regimen-item.bottom-right {
                --counter-border-top-width: 0px;
                --counter-border-radius: 0 0 4px 0;
            }

            ht-regimen-item.bottom-center {
                --counter-border-top-width: 0px;
                --counter-border-left-width: 0px;
                --counter-border-right-width: 0px;
            }

            ht-regimen {
                margin: 4px 8px;
            }

            .reset-all {
                height: 22px;
                width: 22px;
                margin: 0 4px 0 8px;
                padding: 2px;
            }

            .colour-code span{
                content: '';
                display: inline-block;
                height: 24px;
                width: 24px;
                border-radius: 50%;
                vertical-align: middle;
                background-color: transparent;
                margin-right: 12px;
            }
            .code-icon {
                width: 16px;
                height: 16px;
                margin-right: 4px;
            }

            .alert-icon {
                width: 16px;
                height: 16px;
                color: var(--app-secondary-color-dark);
                margin-right: 4px;
            }

            .allergy-alert {
                padding: 12px 0;
            }
            .allergy-title {
                display: flex;
                align-items: center;
                flex-direction: row;
                color: var(--app-secondary-color-dark);
                font-size: var(--font-size-large);
                font-weight: 700;
            }

            .title {
                position: relative;
                display: inline-block;
            }
            .title h5 {
                margin: 0;
                position: absolute;
                bottom: -4px;
            }

            .text-area {
                width: 100%;
            }

            .connector-text {
                margin: 0 8px;
            }

            .grid-container {
                font-size: var(--font-size-normal);
                border-collapse: collapse;
                border-spacing: 0;
                box-sizing: border-box;
                padding: 8px 0;
                flex-grow: 1;
                margin-right: 8px;
                /*height: 100%; */
                /*margin: 0; */
            }

            .grid-container * {
                position: relative;
                --counter-height: 28px;
                --counter-border-top-width: 1px;
                --counter-border-left-width: 1px;
                --counter-border-right-width: 1px;
                --counter-border-bottom-width: 1px;
                --counter-border-radius: 0 0 0 0;
            }

            .grid-container *:after {
                /*content:attr(class);*/
                position: absolute;
                top: 0;
                left: 0;
            }

            .grid-container {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
                grid-template-rows: auto 28px 28px;
                grid-template-areas: "a_a a_bcd a_bcd a_bcd a_e a_fgh a_fgh a_fgh a_i a_jkl a_jkl a_jkl a_m" "b_a b_bcd b_bcd b_bcd b_e b_fgh b_fgh b_fgh b_i b_jkl b_jkl b_jkl b_m" ". c_b c_c c_d . c_f c_g c_h . c_j c_k c_l .";
            }

            .gc-header {
                background: var(--app-background-color-light);
                color: var(--app-text-color-dark);
                font-weight: 500;
                text-align: center;
                font-size: var(--font-size-small);
            }

            .a_a { grid-area: a_a; }
            .a_bcd { grid-area: a_bcd; }
            .a_e { grid-area: a_e; }
            .a_fgh { grid-area: a_fgh; }
            .a_i { grid-area: a_i; }
            .a_jkl { grid-area: a_jkl; }
            .a_m { grid-area: a_m; }
            .b_a { grid-area: b_a; }
            .b_bcd { grid-area: b_bcd;}
            .b_e { grid-area: b_e; }
            .b_fgh { grid-area: b_fgh; }
            .b_i { grid-area: b_i; }
            .b_jkl { grid-area: b_jkl; }
            .b_m { grid-area: b_m; }
            .c_b { grid-area: c_b; }
            .c_c { grid-area: c_c; }
            .c_d { grid-area: c_d; }
            .c_f { grid-area: c_f; }
            .c_g { grid-area: c_g; }
            .c_h { grid-area: c_h; }
            .c_j { grid-area: c_j; }
            .c_k { grid-area: c_k; }
            .c_l { grid-area: c_l; }

        </style>
        <div class="content container">
            <div class="title">
                <h2>[[medicationDetail.intendedName]]</h2>
                <template is="dom-if" if="[[medicationDetail.samCode]]">
                    <h5>[[medicationDetail.samCode]]</h5>
                </template>
            </div>
            <template is="dom-if" if="[[_hasAllergies(medicationDetail)]]">
                <div class="allergy-alert">
                    <div class="allergy-title">
                        <iron-icon class="alert-icon" icon="icons:warning"></iron-icon>
                        [[localize('contraindications','Contre-indications',language)]]
                    </div>
                    <div class="list">
                        <template is="dom-repeat" items="[[medicationDetail.allergies]]" as="allergy">
                            <div><iron-icon class$="code-icon [[_getAtcStyle(allergy)]]" icon="[[_getAllergyIcon(allergy)]]"></iron-icon>[[_getIcpcLabel(allergy)]]<i>[[_shortDateFormat(allergy.openingDate, allergy.valueDate)]]</i>[[allergy.descr]]</div>
                        </template>
                    </div>
                </div>
            </template>
            <div class="regimen-line display-type-regimen">
                <vaadin-checkbox checked="{{medicationDetail.options.createMedication}}" id="isNew">
                    <template is="dom-if" if="[[selectedMedicationContentWithId.isNew]]">
                        [[localize('create_med', 'Créer une médication chronique', language)]]
                    </template>
                    <template is="dom-if" if="[[!selectedMedicationContentWithId.isNew]]">
                        [[localize('update_med', 'Mettre à jour la médication chronique', language)]]
                    </template>
                </vaadin-checkbox>
                <paper-input type="number" min="0" label="[[localize('', 'Quantité prescrite', language)]]" value="{{medicationDetail.boxes}}"></paper-input>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-input-container always-float-label="true" class="comment">
                    <label slot="label" class="color-status">[[localize('proposed_posology','Posologie proposée',language)]]</label>
                    <iron-autogrow-textarea class="paper-input-input" slot="input" disabled value="[[medicationDetail.posologyNote]]"></iron-autogrow-textarea>
                </paper-input-container>
                <paper-icon-button class="button--icon-btn" icon="content-copy" role="button" on-tap="_copyPosologyNote" disabled="[[!medicationDetail.posologyNote]]"></paper-icon-button>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-dropdown-menu id="unit" label="[[localize('qua', 'Quantité', language)]]" disabled="[[!medicationDetail.dividable]]">
                    <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{quantityFactor}}">
                        <template is="dom-repeat" items="[[_quantityFactors]]">
                            <paper-item id="[[item.id]]" value="[[item]]">[[localize(item.label, item.numLabel, language)]]</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>

                <paper-input type="text" readonly label="[[localize('uni','Unité', language)]]" value="{{selectedMedicationContentWithId.medicationUnit}}"></paper-input>
                <paper-input type="number" min="0" label="[[localize('number', 'Nombre', language)]]" value="{{totalTimes}}"></paper-input>
                <paper-dropdown-menu id="frequency" label="[[localize('freq', 'Fréquence', language)]]">
                    <paper-listbox slot="dropdown-content" attr-for-selected="id" selected="{{frequency}}">
                        <paper-item id="daily" data-item="daily">[[localize('perDay','par jour',language)]]</paper-item>
                        <paper-item id="weekly" data-item="weekly">[[localize('perWee','par semaine',language)]]</paper-item>
                        <paper-item id="monthly" data-item="monthly">[[localize('perMonth','par mois',language)]]</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <paper-dropdown-menu id="frequencyConfigDropDown" label="[[localize(frequencyConfig.label, frequencyConfig.label, language)]]" disabled=[[frequencyConfig.disabled]]>
                    <paper-listbox id="frequencyConfig" slot="dropdown-content" attr-for-selected="value" selected="{{regimenKey}}">
                        <template is="dom-repeat" items="[[availableRegimenKeys]]">
                            <paper-item value="[[item]]">[[localize(item, item, language)]]</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
                <paper-icon-button class="button--icon-btn" icon="icons:add" on-tap="_addRegimen"></paper-icon-button>
            </div>
            <template is="dom-repeat" items="[[regimenKeys]]">
                <ht-regimen-day
                        api="[[api]]" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]"
                        frequency="[[frequency]]" regimen-ui="[[_regimens]]" regimen="{{selectedMedicationContentWithId.medicationValue.regimen}}" key="[[item]]"
                        medication-unit="[[selectedMedicationContentWithId.medicationUnit]]"
                        quantity-factor=[[quantityFactorValue]] on-regimen-changed="_regimenChanged" on-regimen-deleted="_regimenDeleted">
                </ht-regimen-day>
            </template>
            <div class="regimen-line display-type-regimen">
                <paper-input-container always-float-label="true" class="comment">
                    <label slot="label" class="color-status">[[localize('pos','Posology',language)]]</label>
                    <iron-autogrow-textarea class="paper-input-input" slot="input" on-keydown="_instructionOverride" value="{{selectedMedicationContentWithId.medicationValue.instructionForPatient}}"></iron-autogrow-textarea>
                </paper-input-container>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-input-container always-float-label="true" class="comment">
                    <label slot="label" class="color-status">[[localize('','Commentaires pour le patient',language)]]</label>
                    <iron-autogrow-textarea class="paper-input-input" slot="input" value="{{selectedMedicationContentWithId.medicationValue.commentForDelivery}}"></iron-autogrow-textarea>
                </paper-input-container>
            </div>
            <div class="regimen-line display-type-regimen">
                <vaadin-date-picker id="beginMoment" label="[[localize('start-date', 'Start date', language)]]" value="{{selectedMedicationContentWithId.beginMomentAsString}}"
                                    class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                <vaadin-date-picker id="endMoment" label="[[localize('end-date', 'End date', language)]]" value="{{selectedMedicationContentWithId.endMomentAsString}}"
                                    class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
                <div>ou</div>
                <paper-input type="number" min="0" label="[[localize('','Nombre de jours',language)]]" value="{{duration}}" on-change="_changeDuration"></paper-input>
                <vaadin-date-picker id="endMoment" label="[[localize('', 'Fin boîte', language)]]" value="{{selectedMedicationContentWithId.endMomentAsString}}"
                                    class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-dropdown-menu id="medicSubstitution" label="[[localize('', 'Substitution', language)]]">
                    <paper-listbox slot="dropdown-content" selected="{{substitution}}" on-selected-changed="_substitutionChanged">
                        <paper-item id="0">[[localize('','Autorisée',language)]]</paper-item>
                        <paper-item id="1">[[localize('','Non autorisée',language)]]</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>

                <paper-dropdown-menu id="medicReimbursement" label="[[localize('presc_reimb', 'Reimbursement', language)]]" class="regimen--reimbursement">
                    <paper-listbox slot="dropdown-content" class="dropdown-reimbursement" selected={{selectedMedicationContentWithId.medicationValue.reimbursementItemIdx}} selected-item="{{selectedMedicationContentWithId.medicationValue.reimbursementItem}}">
                        <template is="dom-repeat" items="[[reimbursementCodeRecipe]]" as="code">
                            <paper-item id="[[code.id]]">[[_getCodeLabel(code.label)]]</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>

                <vaadin-date-picker id="endMoment" label="[[localize('', 'Déliverance', language)]]" value="{{selectedMedicationContentWithId.endMomentAsString}}"
                                    class="regimen--datepicker" i18n="[[i18n]]"></vaadin-date-picker>
            </div>
            <div class="regimen-line display-type-regimen">
                <!--
                <vaadin-checkbox checked="[[selectedMedicationContentWithId.medicationValue.substitutionAllowed]]" id="substitutionAllowed" on-checked-changed="_substitutionAllowedChanged">[[localize('substitution', 'Substitution', language)]]</vaadin-checkbox>
                <vaadin-checkbox id="renewal" checked=[[selectedMedicationContentWithId.medicationValue.isRenewal]] on-checked-changed="_renewalValueChanged">[[localize('renewal', 'Renewal', language)]]</vaadin-checkbox>
                -->
                <paper-dropdown-menu id="medicRenewal" label="[[localize('', 'Renouvellement', language)]]">
                    <paper-listbox slot="dropdown-content" selected="{{renewal}}" on-selected-changed="_renewalChanged">
                        <paper-item id="0">[[localize('','Autorisé',language)]]</paper-item>
                        <paper-item id="1">[[localize('','Non autorisé',language)]]</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <template is="dom-if" if="[[selectedMedicationContentWithId.medicationValue.isRenewal]]">
                    <paper-input type="number" min="0" label="[[localize('', 'Nombre de fois', language)]]" value="{{selectedMedicationContentWithId.medicationValue.renewalDecimalValue}}"></paper-input>
                    <paper-input type="number" min="0" label="[[localize('', 'tous le', language)]]" value="{{selectedMedicationContentWithId.medicationValue.renewalDurationValue}}"></paper-input>
                    <paper-dropdown-menu id="medicRenewalTimeUnit" label="[[localize('time_unit','Time unit',language)]]" class="regimen--renewalTimeUnit">
                        <paper-listbox slot="dropdown-content" class="dropdown-renewalTimeUnit" selected={{selectedMedicationContentWithId.medicationValue.renewalTimeUnitIdx}} selected-item="{{selectedMedicationContentWithId.medicationValue.renewalDurationUnitItem}}">
                            <template is="dom-repeat" items="[[timeUnit]]" as="tu">
                                <paper-item id="[[tu.id]]">[[_getCodeLabel(tu.label)]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </template>
            </div>
            <div class="regimen-line display-type-regimen">
                <paper-input-container always-float-label="true" class="comment">
                    <label slot="label" class="color-status">[[localize('','Commentaires pour le pharmacien',language)]]</label>
                    <iron-autogrow-textarea class="paper-input-input" slot="input" value="{{selectedMedicationContentWithId.medicationValue.commentForDelivery}}"></iron-autogrow-textarea>
                </paper-input-container>
            </div>
        </div>
    </template>
    <script>

        import _ from 'lodash/lodash'
        import moment from 'moment/src/moment'
        import {parse} from "../../../../bower_components/shadycss/src/css-parse";

        class MedicationDetails extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'medication-details'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    selectedMedicationContentWithId: {
                        type: Object,
                        value: null,
                        notify: true
                    },
                    medications: {
                        type: Array,
                        value: []
                    },
                    bufferUnit: {
                        type: String
                    },
                    bufferQuantity: {
                        type: Number,
                        value: 1
                    },
                    bufferNumberByFrequency: {
                        type: Number,
                        value: 1
                    },
                    bufferFrequency: {
                        type: String,
                        value: "daily"
                    },
                    bufferGeneralFrequency: {
                        type: Number,
                        value: 0
                    },
                    // beginMoment: {
                    //     type: Number,
                    //     value: 0,
                    // },
                    // endMoment: {
                    //     type: Number,
                    //     value: 0,
                    // },
                    medicPriority: {
                        type: Number,
                        value: 0,
                        observer: "_changeMedicPriority"
                    },
                    selectedTab: {
                        type: Number,
                        value: 0
                    },
                    openAddDropDown: {
                        type: Boolean,
                        value: false
                    },
                    openAddColDropDown: {
                        type: Boolean,
                        value: false
                    },
                    reimbursementCodeRecipe: {
                        type: Array,
                        value: () => []
                    },
                    reimbursementItem:{
                        type: Object,
                        value: () => {}
                    },
                    reimbursementItemIdx:{
                        type: Number,
                        value: 0
                    },
                    timeUnit:{
                        type: Array,
                        value: () => []
                    },
                    renewalDurationUnitItem: {
                        type: Object,
                        value: () => {}
                    },
                    renewalTimeUnitIdx:{
                        type: Number,
                        value: 0
                    },
                    renewalDurationValue: {
                        type: Number,
                        value: 0
                    },
                    isRenewal:{
                        type: Boolean,
                        value: false
                    },
                    renewalDecimalValue:{
                        type: Number,
                        value: 0
                    },
                    medicationMustBeCreated:{
                        type: Boolean,
                        value: false
                    },
                    // posologyString: {
                    //     type: String,
                    //     value: '',
                    //     observer: '_posologyChanged'
                    // },
                    medicationDetail: {
                        type: Object,
                        value: () => {}
                    },
                    substitution: {
                        type: Number,
                        value: 0
                    },
                    duration: {
                        type: Number,
                        value: 0
                    },
                    time: {
                        type: String,
                        value: "10:00"
                    },
                    renewal: {
                        type: Number,
                        value: 0
                    },
                    medication: {
                        type: Object,
                        value: null
                    },
                    quantityFactor: {
                        type: Object,
                        value: null
                    },
                    totalQuantity: {
                        type: Number,
                        value: 0
                    },
                    totalTimes: {
                        type: Number,
                        value: 0
                    },
                    frequency: {
                        type: String,
                        value: ""
                    },
                    regimenKeys: {
                        type: Array,
                        value: () => [],
                        notify: true
                    },
                    regimenKey: {
                        type: String,
                        value: ""
                    },
                    medicationId: {
                        type: String,
                        value: ""
                    },
                    frequencyConfigs: {
                        type: Object,
                        value: {}
                    },
                    frequencyConfig: {
                        type: Object,
                        value: {}
                    },
                    availableRegimenKeys: {
                        type: Array,
                        value: () => []
                    }
                }
            }

            static get observers() {
                return [
                    '_changeBeginMoment(selectedMedicationContentWithId.beginMomentAsString)',
                    '_changeEndMoment(selectedMedicationContentWithId.endMomentAsString)',
                    '_regimenChanged(selectedMedicationContentWithId.medicationValue, selectedMedicationContentWithId.medicationValue.regimen.*)',
                    '_changeReimbursementItem(reimbursementItem)',
                    '_changeRenewalTimeUnitItem(renewalDurationUnitItem, renewalDurationValue, renewalDecimalValue)',
                    '_selectedMedicationChanged(selectedMedication)',
                    '_medicationChanged(medication, medication.*)',
                    '_medicationDetailChanged(medicationDetail.*)',
                    '_quantityFactorChanged(quantityFactor)',
                    '_frequencyChanged(frequency)'
                ];
            }

            constructor() {
                super();
                this._regimens = [
                    {id: "regimenAfterWakingUp", dayPeriod: {code: "afterwakingup", type: "care.topaz.customDayPeriod"}},
                    {id: "regimenBeforeBreakfast", parentId: "regimenBreakfast", dayPeriod: {code: "beforebreakfast", type: "CD-DAYPERIOD"}},
                    {id: "regimenBreakfast", dayPeriod: {code: "morning", type: "CD-DAYPERIOD"}},
                    {id: "regimenDuringBreakfast", parentId: "regimenBreakfast", dayPeriod: {code: "duringbreakfast", type: "CD-DAYPERIOD"}},
                    {id: "regimenAfterBreakfast", parentId: "regimenBreakfast", dayPeriod: {code: "afterbreakfast", type: "CD-DAYPERIOD"}},
                    {id: "regimenBetweenBreakfastAndLunch", dayPeriod: {code: "betweenbreakfastandlunch", type: "CD-DAYPERIOD"}},
                    {id: "regimenBeforeLunch", parentId: "regimenLunch", dayPeriod: {code: "beforelunch", type: "CD-DAYPERIOD"}},
                    {id: "regimenLunch", dayPeriod: {code: "midday", type: "care.topaz.customDayPeriod"}},
                    {id: "regimenDuringLunch", parentId: "regimenLunch", dayPeriod: {code: "duringlunch", type: "CD-DAYPERIOD"}},
                    {id: "regimenAfterLunch", parentId: "regimenLunch", dayPeriod: {code: "afterlunch", type: "CD-DAYPERIOD"}},
                    {id: "regimenBetweenLunchAndDinner", dayPeriod: {code: "betweenlunchanddinner", type: "CD-DAYPERIOD"}},
                    {id: "regimenBeforeDinner", parentId: "regimenDinner", dayPeriod: {code: "beforedinner", type: "CD-DAYPERIOD"}},
                    {id: "regimenDinner", dayPeriod: {code: "evening", type: "CD-DAYPERIOD"}},
                    {id: "regimenDuringDinner", parentId: "regimenDinner", dayPeriod: {code: "duringdinner", type: "CD-DAYPERIOD"}},
                    {id: "regimenAfterDinner", parentId: "regimenDinner", dayPeriod: {code: "afterdinner", type: "CD-DAYPERIOD"}},
                    {id: "regimenSleep", dayPeriod: {code: "thehourofsleep", type: "CD-DAYPERIOD"}}
                ];

                this._quantityFactors = [
                    {id: "one", label: "quantity_factor_one", numLabel: "1", denominator: 1},
                    {id: "half", label: "quantity_factor_half", numLabel: "1/2", denominator: 2},
                    {id: "third", label: "quantity_factor_third", numLabel: "1/3", denominator: 3},
                    {id: "quarter", label: "quantity_factor_quarter", numLabel: "1/4", denominator: 4}
                ];

                this.frequencyConfigs = {
                    daily: {keys: [], label: "", disabled: true},
                    weekly: {keys: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"], label: "dayOfWeek", disabled: false                    },
                    monthly: {keys: _.range(1, 32), label: "dayOfMonth", disabled: false}
                };

            }

            ready() {
                super.ready();
            }

            _quantityFactorChanged() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                regimen.filter(reg => reg.administratedQuantity && reg.administratedQuantity.quantity || "")
                    .forEach(reg => {
                        const quantity = reg.administratedQuantity.quantity;
                        reg.administratedQuantity.unit = this.selectedMedicationContentWithId.medicationUnit;
                        reg.administratedQuantity.quantity = this.quantityFactor.denominator > 1 && this.quantityFactor.numLabel || parseInt(quantity) || "";
                    });
                this.set("quantityFactorValue", this.quantityFactor);
                this.notifyPath("selectedMedicationContentWithId.medicationValue", "changed");
            }

            _medicationDetailChanged(e) {
                console.log("__medicationDetailChanged()", this.medicationDetail)
                this.dispatchEvent(new CustomEvent('value-changed', {detail: {id: this.medicationDetail.id}, bubbles: true, composed: true}))
            }

            _hasAllergies(item) {
                return item && item.allergies && item.allergies.length;
            }

            _getAllergyIcon(item) {
                return item.type === "allergy" ? "image:filter-vintage" : (item.type === "adr" ? "vaadin:pill" : "");
            }

            _getAtcStyle(item) {
                if (!item || !item.atcCode) return '';
                return 'ATC--' + item.atcCode[0].toUpperCase();
            }

            _getIcpcLabel(item) {
                const icpc = item.codes && item.codes.find(code => code.type==='ICPC' || code.type==='ICPC2');
                return icpc && (icpc.code || icpc.id.split("|")[1]) || "";
            }

            _shortDateFormat(date, altDate) {
                return (date || altDate) && this.api.moment((date || altDate)).format("YY") || "";
            }

            _any(a,b,c,d,e) {
                return a||b||c||d||e
            }

            _getCodeLabel(code){
                return code && code[this.language]
            }

            _instructionOverride() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (regimen && regimen.length) {
                    this._resetAll()
                }
            }

            _regimenChanged() {
                this._updateStats();
                this.set("selectedMedicationContentWithId.medicationValue.instructionForPatient", "");
                this.set("selectedMedicationContentWithId.medicationValue.instructionForPatient",this.api.contact().medication().posologyToString(this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.medicationValue || {}, this.language))
            }

            _medicationChanged(medication) {
                if (!medication) return;

                if (this.medicationId === medication.id) {
                    this.notifyPath("medicationDetail.boxes", "changed");
                    return;
                }
                this.medicationId = medication.id;

                const content =  this.extractContentWithIdFromMedicationService(medication.newMedication, medication.options.isNew, medication.options.isPrescription);
                this.set("selectedMedicationContentWithId", Object.assign(
                    content,
                    {
                        beginMomentAsString : this.api.moment((content && content.medicationValue && content.medicationValue.beginMoment) || (medication.newMedication && medication.newMedication.valueDate) || (medication.newMedication && medication.newMedication.openingDate) || Date.now()).format('YYYY-MM-DD') || null,
                        endMomentAsString: this.api.moment((content && content.medicationValue && content.medicationValue.endMoment) || (medication.newMedication && medication.newMedication.closingDate)) ? this.api.moment(content.medicationValue.endMoment || (medication.newMedication && medication.newMedication.closingDate)).format("YYYY-MM-DD") : null
                    }
                ));
                this._initSelectedMedicationContentWithId();
                this.set("medicationDetail", Object.assign(
                    medication,
                    {
                        dividable: medication.dividable === undefined ? true : medication.dividable,
                        bufferUnit: this.selectedMedicationContentWithId.medicationUnit || this.localize('generic_unit', 'unit', this.language),
                        medicPriority : this.selectedMedicationContentWithId.medicationValue.priority === "high" ? 2 : this.selectedMedicationContentWithId.medicationValue.priority === "middle" ? 1 : 0,
                        reimbursementItemIdx: this.selectedMedicationContentWithId.medicationValue.reimbursementReason ? this.reimbursementCodeRecipe.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.reimbursementReason.code) : this.reimbursementCodeRecipe.findIndex(idx => idx.code === "notreimbursable"),
                        isRenewal : !!this.selectedMedicationContentWithId.medicationValue.renewal,
                        renewalDecimalValue : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.decimal ? this.selectedMedicationContentWithId.medicationValue.renewal.decimal : 1 : null,
                        renewalDurationValue : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.duration.value ? this.selectedMedicationContentWithId.medicationValue.renewal.duration.value : 1 : null,
                        renewalTimeUnitIdx : this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal ? this.timeUnit.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.renewal.duration.unit.code) : this.timeUnit.findIndex(idx => idx.code === "mo") : null
                    }
                ));

                this.notifyPath("medicationDetail.boxes", "changed");
                const quantitySample = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen[0].administratedQuantity.quantity", "");
                this.set("quantityFactor", quantitySample && !parseInt(quantitySample, 10) && this._quantityFactors.find(q => q.numLabel === quantitySample) || this._quantityFactors[0]);
                this.set("frequency" , "");
                this.set("frequency", _.get(this.selectedMedicationContentWithId, "medicationValue.regimen[0].frequency", "daily"));
            }


            _frequencyChanged() {
                if (this.frequency === "") return;
                let regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                regimen = regimen.filter(reg => reg.frequency === this.frequency);
                this._initRegimenKeys();
                this.set("frequencyConfig", this.frequencyConfigs[this.frequency]);
                this.set("selectedMedicationContentWithId.medicationValue.regimen", regimen);
            }

            _initRegimenKeys() {
                const keyId = this.frequency === "weekly" ? "day" : this.frequency === "monthly" ? "time" : "";
                this.splice("regimenKeys", 0, this.regimenKeys.length);
                let regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (keyId) {
                    if (!regimen.length) {
                        this.push("regimenKeys", this.frequencyConfigs[this.frequency].keys[0]);
                    } else {
                        const regimenKeys = regimen.filter((e, i, a) => a.findIndex(x => x[keyId] === e[keyId]) === i).map(reg => reg[keyId]);
                        this.push("regimenKeys", ...regimenKeys)
                    }
                } else {
                    this.push("regimenKeys", "none");
                }
                this._updateFrequencyConfigs();
            }

            _updateFrequencyConfigs() {
                if (!this.frequency) return;
                const configs = this.frequencyConfigs;
                if (this.frequency !== "daily") {
                    this.splice("availableRegimenKeys", 0, this.availableRegimenKeys.length);
                    const availableRegimenKeys = configs[this.frequency].keys.filter(key => !this.regimenKeys.some(regKey => regKey === key));
                    if (availableRegimenKeys.length) {
                        this.push("availableRegimenKeys", ...availableRegimenKeys);
                        this.set("regimenKey", availableRegimenKeys[0]);
                    }
                }
            }

            _regimenDeleted() {

                this._updateFrequencyConfigs();
            }

            _addRegimen() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                if (!this.regimenKey) return;
                if (this.regimenKeys.includes(this.regimenKey))
                    return;
                this.push("regimenKeys", this.regimenKey);
                this._updateFrequencyConfigs();
            }


            _all(a,b) { return a && b }

            _regimenLines() {
                return this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.medicationValue && this.selectedMedicationContentWithId.medicationValue.regimen || []
            }

            extractContentWithIdFromMedicationService(m, isNew, isPres) {
                const content = this.api.contact().preferredContent(m, this.language)  || (m.content[this.language] = {
                    medicationValue: {regimen: []},
                    medicationUnit: this.localize("generic_unit", "unit")
                });
                return {
                    id: m.id,
                    codes: m.codes,
                    medicationValue: content.medicationValue,
                    medicationUnit: content.medicationUnit,
                    isNew: isNew || false,
                    isPrescription: m.isPrescription || isPres || false,
                };
            }

            open(medicationDetail, selectedMedicationContentWithId, boxes) {
                //console.log("open medication-details:", medicationDetail, selectedMedicationContentWithId, boxes)
                ;(!this.reimbursementCodeRecipe || this.reimbursementCodeRecipe.length === 0 || !this.timeUnit || this.timeUnit.length === 0 ? this.api.code().findPaginatedCodes('be', 'CD-REIMBURSEMENT-RECIPE', '')
                    .then(reimb => this.set("reimbursementCodeRecipe", _.orderBy(reimb.rows, ['label.fr'], ['asc'])))
                    .then(() => this.api.code().findPaginatedCodes('be', 'CD-TIMEUNIT', ''))
                    .then(timeunit => this.set("timeUnit", _.orderBy(_.filter(_.get(timeunit, "rows", []), i => ["ns", "us", "ms", "s", "min"].indexOf(_.trim(_.get(i, "code"))) == -1), ['label.fr'], 'asc'))) : Promise.resolve())
                    .finally(() => {
                        if (medicationDetail) {
                            let idx = this.medications.indexOf(medicationDetail);
                            if (idx > -1) {
                                this._selectedMedicationChanged(idx)
                            } else {
                                const preferredContent = this.api.contact().preferredContent(medicationDetail, this.language)

                                if (!selectedMedicationContentWithId || !selectedMedicationContentWithId.isNew) { // selectedMedicationContentWithId.isNew==false when opening an existing medication
                                    // do not set a default date if not defined, for the user to see when a medication has no date
                                    const start = (preferredContent && preferredContent.medicationValue && preferredContent.medicationValue.beginMoment)
                                        || (medicationDetail.valueDate)
                                        || (medicationDetail.openingDate)
                                    const end = (preferredContent && preferredContent.medicationValue && preferredContent.medicationValue.endMoment)
                                        || (medicationDetail.closingDate)
                                    selectedMedicationContentWithId = this.extractContentWithIdFromMedicationService(medicationDetail, false, selectedMedicationContentWithId.isPrescription)
                                    selectedMedicationContentWithId.beginMomentAsString = start && this.api.moment(start).format('YYYY-MM-DD') || null
                                    selectedMedicationContentWithId.endMomentAsString = end && this.api.moment(end).format('YYYY-MM-DD') || null
                                } else { // new medication, should set a default start date
                                    selectedMedicationContentWithId.beginMomentAsString = this.api.moment(Date.now()).format("YYYY-MM-DD")
                                }

                                this.set('selectedMedicationContentWithId', selectedMedicationContentWithId)
                                this._initSelectedMedicationContentWithId()
                                this.set('previousMedication', this.selectedMedicationContentWithId)
                                this.set('medicationDetail', {
                                    boxes: boxes || 1,
                                    bufferUnit: this.selectedMedicationContentWithId.medicationUnit || this.localize('generic_unit', 'unit', this.language),
                                    medicPriority: this.selectedMedicationContentWithId.medicationValue.priority === "high" ? 2 : this.selectedMedicationContentWithId.medicationValue.priority === "middle" ? 1 : 0,
                                    reimbursementItemIdx: this.selectedMedicationContentWithId.medicationValue.reimbursementReason ? this.reimbursementCodeRecipe.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.reimbursementReason.code) : this.reimbursementCodeRecipe.findIndex(idx => idx.code === "notreimbursable"),
                                    isRenewal: !!this.selectedMedicationContentWithId.medicationValue.renewal,
                                    renewalDecimalValue: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.decimal ? this.selectedMedicationContentWithId.medicationValue.renewal.decimal : 1 : null,
                                    renewalDurationValue: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal && this.selectedMedicationContentWithId.medicationValue.renewal.duration.value ? this.selectedMedicationContentWithId.medicationValue.renewal.duration.value : 1 : null,
                                    renewalTimeUnitIdx: this.isRenewal ? this.selectedMedicationContentWithId.medicationValue.renewal ? this.timeUnit.findIndex(idx => idx.code === this.selectedMedicationContentWithId.medicationValue.renewal.duration.unit.code) : this.timeUnit.findIndex(idx => idx.code === "mo") : null,
                                    newMedication: medicationDetail,
                                    options: {
                                        createMedication: this.selectedMedicationContentWithId.createMedication,
                                        isPrescription: this.selectedMedicationContentWithId.isPrescription
                                    }
                                })
                            }

                            this.set('medicationMustBeCreated', false)
                            this.set('openAddDropDown', false)

                            this.substitution = this.selectedMedicationContentWithId.medicationValue.substitutionAllowed ? 0 : 1;
                            this.$['medication-detail'].open()

                            this._updateView();
                        }
                    })
            }

            init() {
                this.frequency = this.localize("perDay", "par jour");
                return Promise.all(this._regimens.map(reg => {
                    const dayPeriod = reg.dayPeriod;
                    return this.api.code().findCodes("be", dayPeriod.type, dayPeriod.code)
                        .then(results => {
                            if (results && results.length) {
                                const localizedLabel = _.get(results, `0.label.${this.language}`, "") || this.localize(`ms_${dayPeriod.code}`, dayPeriod.code);
                                Object.assign(dayPeriod, {
                                    label: _.fromPairs([[this.language, localizedLabel]])
                                });
                            }
                        })
                    })
                )
            }

            _updateStats() {
                if (!this.quantityFactor) return;
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                let totalQuantity = 0;
                let totalTimes = 0;
                if (regimen) {
                    totalTimes = regimen.reduce((total, reg) => {
                        total += (this.quantityFactor.denominator > 1) && 1 || parseInt(reg.administratedQuantity.quantity, 10) || 0;
                        return total;
                    }, 0);
                    totalQuantity = Math.round(totalTimes / this.quantityFactor.denominator);
                }
                this.set("totalQuantity", totalQuantity);
                this.set("totalTimes", totalTimes);
            }


            _updateView() {
                return;
                const getQuantity = (regimen, dayPeriod) => {
                    let reg = regimen.find(r => r.dayPeriod && r.dayPeriod.type === dayPeriod.type && r.dayPeriod.code === dayPeriod.code);
                    return reg ? reg.administratedQuantity.quantity : 0;
                };

                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                this._regimens.forEach(base => {
                    this.set(base.id, getQuantity(regimen, base.dayPeriod));
                });

                if (this.extras && this.extras.length) {
                    this.splice("extras", 0, this.extras.length);
                }
                regimen.filter(reg => !reg.dayPeriod).forEach(reg => {
                    this.push("extras", {
                        code: reg.timeOfDay,
                        quantity: reg.administratedQuantity.quantity
                    });
                    this.extras.sort((a, b) => a.code - b.code);
                });
                this._updateDuration();

                this.notifyPath("selectedMedicationContentWithId.medicationValue", "changed");
            }

            _setQuantity(id, quantity = 0) {
                console.log("_setQuantity:" + id);
                this.set(id, quantity);
            }

            _getQuantity(id) {
                console.log("_getQuantity:" + id);
                return this.get(id);
            }

            _updateDayPeriodRegimen(id, quantity = "") {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                const dayPeriod = (this._regimens.find(reg => reg.id === id) || {dayPeriod: ""}).dayPeriod;
                if (!dayPeriod) return;
                const index = regimen.findIndex(reg => reg.dayPeriod && reg.dayPeriod.code === dayPeriod.code);
                if (quantity) {
                    const updated = {
                        administratedQuantity: {
                            quantity: this.quantityFactor.denominator > 1 && this.quantityFactor.numLabel || parseInt(quantity, 10) || "",
                            unit: this.selectedMedicationContentWithId.medicationUnit
                        },
                        dayPeriod : dayPeriod,
                        frequency: "daily"
                    };
                    if (index > -1) {
                        this.splice("selectedMedicationContentWithId.medicationValue.regimen", index, 1, updated);
                    } else {
                        this.push("selectedMedicationContentWithId.medicationValue.regimen", updated);
                    }
                } else {
                    if (index > -1) {
                        this.splice("selectedMedicationContentWithId.medicationValue.regimen", index, 1);
                    }
                }
            }

            _quantityChanged(e) {
                const id = e.currentTarget.id;
                let quantity = e.currentTarget.quantity;
                this._updateDayPeriodRegimen(id, quantity);

                this._regimens.filter(reg => reg.parentId === id).forEach(reg => {
                    this._setQuantity(reg.id);
                    this._updateDayPeriodRegimen(reg.id);
                });
                const reg = this._regimens.find(reg => reg.id === id);
                if (reg && reg.parentId) {
                    this._setQuantity(reg.parentId);
                    this._updateDayPeriodRegimen(reg.parentId);
                }
            }

            _resetAll() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                this.selectedMedicationContentWithId.medicationValue.regimen = [];
                this._updateView();
            }

            _resetDayPeriodRegimen(e) {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                this.selectedMedicationContentWithId.medicationValue.regimen = regimen.filter(reg => !this._regimens.some(base => reg.dayPeriod && reg.dayPeriod.code === base.dayPeriod.code));
                this._updateView();
            }

            _resetTimeOfDayRegimen(e) {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                this.selectedMedicationContentWithId.medicationValue.regimen = regimen.filter(reg => this._regimens.some(base => reg.dayPeriod && reg.dayPeriod.code === base.dayPeriod.code));
                this._updateView();
            }

            _copyPosologyNote() {
                this._resetAll();
                this.set("selectedMedicationContentWithId.medicationValue.instructionForPatient", this.medicationDetail.posologyNote);
            }

            _beginMoment() {
                    return this.api.moment(this.selectedMedicationContentWithId.medicationValue.beginMoment);
                }

            _endMoment() {
                return this.api.moment(this.selectedMedicationContentWithId.medicationValue.endMoment);
            }

            _updateDuration() {
                if (this.selectedMedicationContentWithId.medicationValue.beginMoment &&
                    this.selectedMedicationContentWithId.medicationValue.endMoment)
                    this.set("duration", this._endMoment().diff(this._beginMoment(), "days"));
            }

            _changeDuration(e) {
                const endMoment = this._beginMoment().add(parseInt(this.duration, 10), "days");
                this.set("selectedMedicationContentWithId.medicationValue.endMoment", parseInt(endMoment.format("YYYYMMDD"), 10));
                this.set("selectedMedicationContentWithId.endMomentAsString", endMoment.format("YYYY-MM-DD"));
            }

            _initSelectedMedicationContentWithId(){
                this.selectedMedicationContentWithId.medicationValue && !this.selectedMedicationContentWithId.medicationValue.regimen ? this.set('selectedMedicationContentWithId.medicationValue.regimen', []) : null
            }

            openList(list) {
                // ------------------if we want to create an array even when we have only one medication selected
                // list && list.length > 0 ? this.set('medications', _.clone(list)) : (list.newMedication && this.set('medications',[list])) || this.set('medications', [])
                // ----------------------------------------------------------------------------------------------
                list && list.length > 0 ? this.set('medications', _.clone(list)) : this.set('medications', [])
                if (this.medications.length) {
                    this.open(this.medications[0], this.extractContentWithIdFromMedicationService(this.medications[0].newMedication, true, this.medications[0].options.isPrescription), this.medications[0].boxes);
                    this.set('selectedMedication',0);
                }
            }

            _localize(s) {
                return this.api.contact().medication().localize(s, this.language);
            }

            _changeBeginMoment() {
                if (this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.beginMomentAsString) { // begin moment can NOT be empty
                    const beginMoment = parseInt(this.selectedMedicationContentWithId.beginMomentAsString.replace(/(....)-(..)-(..)/, '$1$2$3'), 10);
                    this.set("selectedMedicationContentWithId.medicationValue.beginMoment", beginMoment);
                    this._updateDuration();
                }
            }

            _changeEndMoment() {
                if (this.selectedMedicationContentWithId && this.selectedMedicationContentWithId.endMomentAsString != null) { // end moment can be empty string
                    const endMoment = parseInt(this.selectedMedicationContentWithId.endMomentAsString.replace(/(....)-(..)-(..)/, '$1$2$3'), 10);
                    this.set("selectedMedicationContentWithId.medicationValue.endMoment", endMoment);
                    this._updateDuration();
                }
            }

            _changeMedicPriority() {
                // console.log('_changeMedicPriority')
                if (this.selectedMedicationContentWithId) {
                    const priority = this.selectedMedicationContentWithId.medicationValue.priority?
                        this.selectedMedicationContentWithId.medicationValue.priority=== 2 ? 'high' :
                            this.selectedMedicationContentWithId.medicationValue.priority=== 1 ? 'middle' : 'low' :
                        'low';
                    this.set("selectedMedicationContentWithId.medicationValue.priority", priority);
                }
            }

            cancel() {
                this.close()
            }

            EOLAndClose(){
                const today = parseInt(moment().subtract(1, 'days').format("YYYYMMDD"), 10)
                this.set("medicationDetail.newMedication.endOfLife", today)
                this.save()
                this.close()
            }

            endAndClose(){
                const yesterday = parseInt(moment().subtract(1, 'days').format("YYYYMMDD"), 10)
                this.set("selectedMedicationContentWithId.medicationValue.endMoment", yesterday)
                this.save()
                this.close()
            }

            saveAndClose() {
                this.save() // instant save
                this.close()
            }

            close() {
                this.set("selectedMedicationContentWithId", null)
                this.set('medications', [])
            }

            test() {
                const regs = this._register();
                console.log(regs);
            }

            save() {
                const regs = this._register();
                this.medicationDetail.newMedication.content.fr.medicationValue.regimen = regs;
                //set("selectedMedicationContentWithId.medicationValue.regimen", regs);
                this._valueChanged()
            }

            _addExtra() {
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                const time = moment(this.time,['HH:mm','HHmm']);
                const timeOfDay = parseInt(time.format("HHmmss"), 10);
                const index = regimen.findIndex(reg => reg.timeOfDay && reg.timeOfDay === timeOfDay);
                let quantity = 0;
                if (this.quantityFactor.denominator > 1) {
                    if (index > -1) return;
                    quantity = this.quantityFactor.numLabel;
                } else {
                    quantity = ((index > -1) && parseInt(regimen[index].administratedQuantity.quantity, 10) || 0) + 1;
                }
                const updated = {
                    administratedQuantity: {
                        quantity: quantity,
                        unit: this.selectedMedicationContentWithId.medicationUnit
                    },
                    timeOfDay : timeOfDay,
                    frequency: "daily"
                };
                if (index > -1) {
                    this.splice("selectedMedicationContentWithId.medicationValue.regimen", index, 1, updated);
                } else {
                    this.push("selectedMedicationContentWithId.medicationValue.regimen", updated);
                }
                this._updateView();
            }

            _extraChanged(e) {
                const extra = _.get(e, "currentTarget.extra", "");
                const quantity = extra.quantity;
                if (!extra) return;
                const regimen = _.get(this.selectedMedicationContentWithId, "medicationValue.regimen", "");
                if (!regimen) return;
                const index = regimen.findIndex(reg => reg.timeOfDay && !reg.dayPeriod && reg.timeOfDay === extra.code);

                if (quantity) {
                    const updated = {
                        administratedQuantity: {
                            quantity: quantity,
                            unit: this.selectedMedicationContentWithId.medicationUnit
                        },
                        timeOfDay : extra.code,
                        frequency: "daily"
                    };
                    if (index > -1) {
                        this.splice("selectedMedicationContentWithId.medicationValue.regimen", index, 1, updated);
                    } else {
                        this.push("selectedMedicationContentWithId.medicationValue.regimen", updated);
                    }
                } else {
                    if (index > -1) {
                        this.splice("selectedMedicationContentWithId.medicationValue.regimen", index, 1);
                    }
                }
                this._updateView();
            }

            _valueChanged() {
                console.log("_valueChanged()",this.medicationDetail)
                this.dispatchEvent(new CustomEvent('value-changed', {detail: {medication: this.medicationDetail, medications:this.medications}, bubbles: true, composed: true}))
            }

            _register() {
                let regs = [];
                this._regimens.filter(reg => reg.code !== "unknown").forEach(reg => {
                    this._registerDayPeriod(regs, reg.id, reg.code);
                });
                this.extras.forEach(extra => this._registerExtra(regs, extra));
                return regs;
            }

            _registerDayPeriod(regs, id, code) {
                const quantity = this._getQuantity(id);
                if (quantity < 1) return;
                regs.push ({
                    administratedQuantity: {
                        quantity: quantity
                    },
                    dayPeriod: {
                        code: code,
                        type: "CD-DAYPERIOD"
                    },
                    frequency: "daily"
                });
            }

            _registerExtra(regs, extra) {
                regs.push ({
                    administratedQuantity: {
                        // quantity: extra.quantity.toString(),
                        quantity: extra.quantity,
                        time: null,
                        unit: "unit"
                    },
                    frequency: "daily",
                    timeOfDay: extra.code
                });
            }

            selectRegimen(scores, rg, start, end) {
                const s = rg.timeOfDay || rg.dayPeriod && rg.dayPeriod.code && scores[rg.dayPeriod.code] || 0;
                return s >= start && s <= end
            }

            _changeReimbursementItem(item) {
                if(item && item.id){
                    const reimbursementItem = this.reimbursementCodeRecipe.find(r => r.id === item.id)
                    this.set("selectedMedicationContentWithId.medicationValue.reimbursementReason", reimbursementItem)
                }
            }

            _substitutionChanged(e) {
                this.set('selectedMedicationContentWithId.medicationValue.substitutionAllowed', e.detail.value === 0);
            }

            _substitutionAllowedChanged(e) {
                this.set('selectedMedicationContentWithId.medicationValue.substitutionAllowed', e.target.checked);
            }

            _renewalChanged(e) {
                this._setRenewal(e.detail.value === 0);
            }

            _renewalValueChanged(e){
                this._setRenewal(e.target.checked);
            }

            _setRenewal(isRenewal){
                this.set('selectedMedicationContentWithId.medicationValue.isRenewal', isRenewal);
                if(!isRenewal){
                    this.set("selectedMedicationContentWithId.medicationValue.renewal", null);
                }
            }

            _changeRenewalTimeUnitItem(item, unitValue, decimalValue){
                if(item && item.id){
                    const timeUnitItem = this.timeUnit.find(r => r.id === item.id)
                    this.set("selectedMedicationContentWithId.medicationValue.renewal", {
                        decimal: decimalValue,
                        duration: {
                            value: unitValue,
                            unit: timeUnitItem
                        }
                    })
                }
            }

            _createMedication(e){
                this.set('medicationDetail.options.createMedication', e.target.checked)
                this.set('selectedMedicationContentWithId.createMedication', e.target.checked)
            }

            _medicationName(svc) {
                return this.api.contact().medication().medicationNameToString(this.api.contact().preferredContent(svc, this.language).medicationValue) || ''
            }
        }

        customElements.define(MedicationDetails.is, MedicationDetails)
    </script>
</dom-module>
