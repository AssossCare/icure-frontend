<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/toggle-icon/toggle-icon.html">


<link rel="import" href="../../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/tk-token-field/tk-token-field.html">
<link rel="import" href="../../../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">

<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">

<link rel="import" href="../../../atc-styles.html">
<link rel="import" href="../../../dialog-style.html">
<link rel="import" href="../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../icons/medication-icons.html">


<dom-module id="medication-prescription-dialog">
    <template>
        <style include="dialog-style atc-styles">
            paper-dialog {
                width: 80%;
            }

            paper-input, paper-input-container {
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            paper-input-container {
                margin-top: 24px;
                margin-left: 40px;
            }

            #entities-list, #accumulated-medications {
                margin-bottom: 55px;
            }

            .modal-button {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--cancel {
                background: transparent;
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }

            .modal-button--save {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700 !important;
            }

            .modal-button--force {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                color: var(--app-light-color) !important;
                font-weight: 700 !important;
                background: var(--app-status-color-nok);
            }

            .modal-button[disabled] {
                background-color: var(--app-secondary-color-dark);
                color: var(--app-text-color-disabled);
                box-shadow: none;
            }

            paper-input {
                --paper-input-container-focus-color: var(--app-primary-color);
                --paper-input-container-label: {
                    color: var(--app-text-color);
                    opacity: 1;
                };
            }

            paper-tabs {
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                width: 100%;
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color);
            }

            paper-tab.iron-selected {
                font-weight: bold;
            }

            paper-tab.iron-selected > iron-icon {
                color: var(--app-secondary-color);
            }

            paper-dialog {
                min-height: 480px;
                min-width: 600px;
                max-height: unset !important;
                width: 80%;
                top: 50%;
                transform: translateY(-50%);
            }

            .no-grid {
                display: none;
            }

            .no-column {
                display: none;
            }

            .column {
                margin: 2px;
            }

            div.cheap {
                color: #606060;
            }


            vaadin-combo-box {
                display: block;
                width: auto;
            }

            .buttons {
                position: absolute;
                bottom: 0;
            }

            .modal-button {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--cancel {
                background: transparent;
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }

            .modal-button--save {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;

            }

            ht-spinner {
                position: fixed;
                top: calc(50% + 62px);
                left: 25%;
                z-index: 150;
                transform: translate(-50%, -50%);
                height: 42px;
                width: 42px;
            }

            .container {
                display: flex;
                flex-flow: row wrap;
                justify-content: space-around;
                align-items: flex-start;
            }

            .left-pane {
                width: calc(67% - 12px);
                margin-right: 12px;
                flex-grow: 3;
            }

            .right-pane {
                width: calc(33% - 12px);
                margin-left: 12px;
                align-self: flex-end;
                flex-grow: 1;
            }

            .buttons {
                background: var(--app-background-color);
            }

            /*.add-btn {*/
            /*    height: 20px;*/
            /*    width: 20px;*/
            /*    background: var(--app-secondary-color);*/
            /*    border-radius: 50%;*/
            /*    padding: 2px;*/
            /*    margin-right: 4px;*/
            /*}*/

            .add-btn--compound {
                position: absolute;
                left: 0;
                margin-top: 55px;
            }

            .helper {
                display: block;
                width: 100%;
                height: 62px;
            }

            .boxes-qty {
                display: inline-block;
                width: 18px;
            }

            .names-mobile-only {
                display: none;
            }

            .names-nomobile {
                display: initial;
            }

            #checkintol {
                display: flex;
                flex-direction: column;
                min-height: 640px;
                max-height: 50vh !important;
            }

            #checkintol em {
                font-weight: bold;
            }

            #checkintol div.warn {
                color: var(--app-status-color-nok);
                font-size: 1.2em;
            }

            #checkintol div.con {
                margin: 16px 0 8px 0;
            }

            #checkintol div.list {
                flex-grow: 1;
                margin: 8px 32px;
                padding: 0;
                overflow-y: auto;
                border: 1px solid var(--app-background-color-dark);
            }

            #checkintol div.list > div {
                padding: 4px 16px;
                height: 32px;
                border-bottom: 1px solid var(--app-background-color-dark);
                box-sizing: border-box;
            }

            #checkintol div.list > div:nth-child(2n-1) {
                background-color: var(--app-background-color-dark);
            }

            #checkintol div.list > div > iron-icon {
                height: 16px;
            }

            #checkintol div.endline {
                display: flex;
                flex-direction: row;
                justify-content: flex-end;
                margin: 8px 0;
                padding: 0;
                min-height: 40px;
            }

            #checkintol div.endline span {
                line-height: 40px;
                padding: 0 24px;
            }

            @media screen and (max-width: 936px) {
                paper-dialog#medication-selection,
                #checkintol {
                    position: fixed;
                    max-width: none !important;
                    top: 64px;
                    left: 0;
                    height: calc(100vh - 84px) !important;
                    width: 100vw !important;
                    margin: 0;
                    transform: none;
                }

                #checkintol {
                    max-height: none !important;
                }
            }

            @media screen and (max-width: 800px) {
                .names-mobile-only {
                    display: initial;
                }

                .names-nomobile {
                    display: none;
                }
            }

            @media screen and (max-width: 640px) {
                div.container {
                    flex-flow: initial;
                    flex-direction: column;
                    width: 100vw;
                    box-sizing: border-box;
                    overflow-y: auto;
                    /*height: calc(100vh - 164px);*/
                    justify-content: flex-start;
                }

                .left-pane, .right-pane {
                    width: 100%;
                    height: 33vh;
                }

                #entities-list {
                    height: auto;
                    max-height: 25vh;
                    overflow-y: auto;
                }

                #accumulated-medications, #entities-list {
                    margin-bottom: 0;
                }

                .buttons {
                    position: fixed;
                    bottom: 0;
                    right: 0;
                }
            }


            .search-bar {
                display: flex;
                flex-direction: row;
                align-items: center;
                height: 40px;
                margin: 0 8px 0 8px;
            }

            #search {
                width: 100%;
            }

            .filter-icon {
                --paper-icon-button: {
                    height: 22px;
                    width: 22px;
                    padding: 2px;
                    margin: 0px;
                    border-radius: 50%;
                };

                --toggle-icon: {
                    background: var(--app-background-color);
                    color: var(--app-primary-color-dark);
                    border-radius: 50%;
                };

                --toggle-icon-checked: {
                    background: var(--app-status-color-pending);
                    color: var(--app-primary-color-dark);
                    border-radius: 50%;
                };
            }

            .filter-button {
                height: 22px;
                min-width: 24px;
                margin: 0px;
                border-radius: 10%;
                width: auto;
                padding: 2px;
                background-color: var(--app-background-color);
                color: var(--app-primary-color-dark);
            }

            .filter-button[active] {
                background-color: var(--app-status-color-pending);
                color: var(--app-primary-color-dark);
            }

            .add-button {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                --paper-icon-button_-_width: 36px;
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 400;
                font-size: 14px;
                height: 20px;
                width: 20px;
                padding: 2px;
                margin: 0px;
                border-radius: 10%;
            }

            .button-group {
                padding: 0px;
                margin-left: 12px;
                flex-grow: 0;
                height: 22px;
            }
            .search-field {
                flex-grow: 2;
            }

            /*table {*/
            /*    table-layout: fixed;*/
            /*    width: 100%;*/
            /*}*/

            .search-results {
                position: relative;
                box-sizing: border-box;
                grid-column: 2 / span 1;
                grid-row: 1 / span 1;
                background: var(--app-background-color);
                float: left;
                padding: 12px 20px;
                padding-top: 0;
                display: flex;
                flex-flow: column nowrap;
                align-items: flex-start;
                width: 100%;
            }

            vaadin-grid {
                /*height: calc(100% - 16px - 32px - 50px);*/
                width: 100%;
                box-shadow: var(--app-shadow-elevation-1);
                border: none;
                box-sizing: border-box;
            }

            /*vaadin-grid.material {*/
            /*    outline: 0 !important;*/
            /*    font-family: Roboto, sans-serif;*/
            /*    background: rgba(0, 0, 0, 0);*/
            /*    border: none;*/
            /*    --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));*/

            /*    --vaadin-grid-cell: {*/
            /*        padding: 8px;*/
            /*    };*/

                /*--vaadin-grid-header-cell: {*/
                /*    overflow: visible;*/
                /*};*/

            /*    --vaadin-grid-body-cell: {*/
            /*        height: 48px;*/
            /*        color: rgba(0, 0, 0, var(--dark-primary-opacity));*/
            /*        font-size: 13px;*/
            /*    };*/

            /*    --vaadin-grid-body-row-hover-cell: {*/
            /*        background-color: var(--paper-grey-200);*/
            /*    };*/

            /*    --vaadin-grid-body-row-selected-cell: {*/
            /*        background-color: var(--paper-grey-100);*/
            /*    };*/

            /*    --vaadin-grid-focused-cell: {*/
            /*        box-shadow: none;*/
            /*        font-weight: bold;*/
            /*    };*/

            /*}*/

            /*vaadin-grid.material .cell {*/
            /*    overflow: hidden;*/
            /*    text-overflow: ellipsis;*/
            /*    padding-right: 8px;*/
            /*}*/

            /*vaadin-grid.material .cell.last {*/
            /*    padding-right: 8px;*/
            /*}*/

            /*vaadin-grid.material .cell.numeric {*/
            /*    text-align: right;*/
            /*}*/

            /*vaadin-grid.material paper-checkbox {*/
            /*    --primary-color: var(--paper-indigo-500);*/
            /*    margin: 0 24px;*/
            /*}*/

            /*vaadin-grid.material vaadin-grid-sorter {*/
            /*    --vaadin-grid-sorter-arrow: {*/
            /*        display: none !important;*/
            /*    };*/
            /*}*/

            /*vaadin-grid.material vaadin-grid-sorter .cell {*/
            /*    flex: 1;*/
            /*    display: flex;*/
            /*    justify-content: space-between;*/
            /*    align-items: center;*/
            /*}*/

            /*vaadin-grid.material vaadin-grid-sorter iron-icon {*/
            /*    transform: scale(0.8);*/
            /*}*/

            /*vaadin-grid iron-icon {*/
            /*    width: 32px;*/
            /*}*/

            /*vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {*/
            /*    color: rgba(0, 0, 0, var(--dark-disabled-opacity));*/
            /*}*/

            /*vaadin-grid.material vaadin-grid-sorter[direction] {*/
            /*    color: rgba(0, 0, 0, var(--dark-primary-opacity));*/
            /*}*/

            /*vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {*/
            /*    transform: scale(0.8) rotate(180deg);*/
            /*}*/

            /*vaadin-grid.material::slotted(div) {*/
            /*    outline: 0 !important;*/
            /*    background: red;*/
            /*}*/

            /*#columnHeader {*/
            /*    display: flex;*/
            /*    flex-flow: row wrap;*/
            /*}*/

            .dot {
                height: 20px;
                width: 20px;
                background-color: transparent;
                border-radius: 50%;
                display: inline-block;
            }
            .table-icon {
                --iron-icon-height: 20px;
                --iron-icon-width: 20px;
                color: red;
            }

        </style>

        <paper-dialog id="medication-prescription" always-on-top="true">
            <ht-spinner class="center" active="[[isLoadingEntities]]"></ht-spinner>
            <h2 class="modal-title">[[localize('sel_med','Select medication',language)]]</h2>
            <div class="search-bar">
                <div class="search-field">
                    <paper-input id="search" label="[[localize('sch_med','Search a medicine',language)]]" autofocus
                                 value="{{filterValue}}" on-keydown="refresh"></paper-input>
                </div>
                <div class="button-group">
                    <paper-icon-button icon="vaadin:file-process" class="add-button" on-tap=""
                                       id="action-medication-scheme"></paper-icon-button>
                    <paper-icon-button icon="medication-svg-icons:add-flask" class="add-button" on-tap=""
                                       id="action-create-masterly"></paper-icon-button>
                </div>
                <div class="button-group">
                    <paper-button class="filter-button" toggles id="filter-none" on-tap="_filterNone" disabled="[[allDisabled]]">All</paper-button>
                    <toggle-icon icon="vaadin:alarm" class="filter-icon" toggles id="filter-chronics" on-tap="_toggleFilter"></toggle-icon>
                    <toggle-icon icon="vaadin:time-backward" class="filter-icon" toggles id="filter-history" on-tap="_toggleFilter"></toggle-icon>
                    <toggle-icon icon="medication-svg-icons:registered" class="filter-icon" toggles id="filter-generics" on-tap="_toggleFilter"></toggle-icon>
                    <toggle-icon icon="vaadin:pill" class="filter-icon" toggles id="filter-ingredient" on-tap="_toggleFilter"></toggle-icon>
                    <toggle-icon icon="vaadin:flask" class="filter-icon" toggles id="filter-masterly" on-tap="_toggleFilter"></toggle-icon>
                </div>
            </div>
            <div class="search-results">
<!--                <table>-->
<!--                    <colgroup id="columnHeader">-->
<!--                        <col>-->
<!--                        <col flex-grow="0 0 32px">-->
<!--                        <col flex-grow="1">-->
<!--                        <col flex-grow="0 0 32px">-->
<!--                        <col flex-grow="0 0 32px">-->
<!--                        <col flex-grow="0 0 32px">-->
<!--                        <col flex-grow="0 0 32px">-->
<!--                        <col flex-grow="0 0 32px">-->
<!--                        <col flex-grow="0">-->
<!--                        <col flew-grow="0">-->
<!--                        <col flew-grow="0">-->
<!--                        <col flex-grow="0">-->
<!--                    </colgroup>-->
<!--                    <thead>-->
<!--                    <tr>-->
<!--                        <th flex-grow="0 0 32px"/><th flex-grow="0 0 32px"/><th flex-grow="1">Nom</th><th flex-grow="0 0 32px">Classe</th><th flex-grow="0 0 32px">Type</th><th colspan="2" flex-grow="0 0 64px">Chap IV</th><th flex-grow="0 0 32px">Cat</th><th colspan="2" flex-grow="1">Prix</th><th colspan="2">Traitement</th>-->
<!--                    </tr>-->
<!--                    <tr>-->
<!--                        <th/><th/><th>Posologie</th><th>ATC</th><th/><th/><th colspan="2">Délivré</th><th>Pat.</th><th>Public</th><th>Début</th><th>Fin</th>-->
<!--                    </tr>-->
<!--                    </thead>-->
<!--                    <tfoot>-->
<!--                    <tr></tr>-->
<!--                    </tfoot>-->
<!--                </table>-->

                <vaadin-grid id="medicinalProduct-list" active-item="{{medicinalProduct}}" width="100%">

                    <!-- ADD-->

                    <vaadin-grid-column width="40px" flex-grow="0">
                        <template>
                            <paper-icon-button id="[[item.id]]" class="add-button" icon="icons:add" on-tap="_addChron"></paper-icon-button>
                        </template>
                    </vaadin-grid-column>

                    <!-- MASTERLY / TEMPLATE-->

                    <vaadin-grid-column width="40px" flex-grow="0">
                        <template>
                            <template is="dom-if" if="[[_isMasterly(item.preparation)]]">
                                <iron-icon icon="medication:masterly"></iron-icon>
                            </template>
                            <template is="dom-if" if="[[_isTemplate(item.preparation)]]">
                                <iron-icon icon="medication:template"></iron-icon>
                            </template>
                        </template>
                    </vaadin-grid-column>

                    <!-- NAME / DOSAGE-->

                    <vaadin-grid-column flex-grow="1">
                        <template class="header">Nom Posologie</template>
                        <template>
                            <div class="layeredItem">
                                <div>[[item.label]]</div>
                                <div>[[item.dosage]]</div>
                            </div>
                        </template>
                    </vaadin-grid-column>

                    <!-- ATC CLASS -->

                    <vaadin-grid-column width="40px" flex-grow="0">
                        <template class="header">ATC</template>
                        <template>
                            <span class="dot" style="background-color: [[_atcColor(item.atc)]];"></span>
                        </template>
                    </vaadin-grid-column>

                    <!-- TYPE -->

                    <vaadin-grid-column flex-grow="0">
                        <template class="header">Type</template>
                        <template>
                            <template is="dom-if" if="[[_isCompProhibitedDrug(medicationType)]]">
                                <iron-icon icon="medication-svg-icons:cat-doping-prod" class="table-icon"></iron-icon>
                            </template>
                            <template is="dom-if" if="[[_isSevereRenalInsuf(medicationType)]]">
                                <iron-icon icon="medication-svg-icons:severe-renal-insufficiency" class="table-icon"></iron-icon>
                            </template>
                            <template is="dom-if" if="[[_isModerateRenalInsuf(item.type)]]">
                                <iron-icon icon="medication-svg-icons:moderate-renal-insufficiency" class="table-icon"></iron-icon>
                            </template>
                            <template is="dom-if" if="[[_isReinfPharmacoVig(medicationType)]]">
                                <iron-icon icon="medication-svg-icons:reinf-pharma-vigi" class="table-icon"></iron-icon>
                            </template>
                            <template is="dom-if" if="[[_isNarcotic(medicationType)]]">
                                <iron-icon icon="medication-svg-icons:narcotic" class="table-icon"></iron-icon>
                            </template>
                        </template>
                    </vaadin-grid-column>

                    <!-- CHAP IV -->

                    <vaadin-grid-column width="40px" flex-grow="0">
                        <template class="header">IV</template>
                        <template>
                            <span class="dot mr-2" style="background-color: [[_chap4Color(item.chap4)]];"></span>
                        </template>
                    </vaadin-grid-column>

                    <!-- DELIVERED -->

                    <vaadin-grid-column width="40px" flex-grow="0">
                        <template class="header">Del</template>
                        <template>
                            <span class="dot mr-2" style="background-color: [[_deliveredColor(item.delivered)]];"></span>
                        </template>
                    </vaadin-grid-column>

                    <!-- CATEGORY -->

                    <vaadin-grid-column width="40px" flex-grow="0">
                        <template class="header">Cat</template>
                        <template is="dom-if" if="[[_isCat1(item.cat)]]">
                            <iron-icon icon="medication:cat-1"></iron-icon>
                        </template>
                        <template is="dom-if" if="[[_isCat2(item.cat)]]">
                            <iron-icon icon="medication:cat-2"></iron-icon>
                        </template>
                    </vaadin-grid-column>

                    <!-- PRICE -->


                    <!-- PRICE: PAT -->

                    <vaadin-grid-column flex-grow="0">
                        <template class="header">Patient</template>
                        <template>
                            <div>[[item.patientPrice]]</div>
                        </template>
                    </vaadin-grid-column>

                    <!-- PRICE: PUBLIC -->

                    <vaadin-grid-column flex-grow="0">
                        <template class="header">Public</template>
                        <template>
                            <div>[[item.publicPrice]]</div>
                        </template>
                    </vaadin-grid-column>

                    <!-- DURATION -->


                    <!-- DURATION: START -->

                    <vaadin-grid-column flex-grow="0">
                        <template class="header">Début</template>
                        <template>
                            <div>[[item.startDate]]</div>
                        </template>
                    </vaadin-grid-column>

                        <!-- DURATION: END -->

                    <vaadin-grid-column flex-grow="0">
                        <template class="header">Fin</template>
                        <template>
                            <div>[[item.endDate]]</div>
                        </template>
                    </vaadin-grid-column>

                </vaadin-grid>

            </div>
        </paper-dialog>
    </template>
    <script>
        import _ from 'lodash/lodash'
        import accounting from '../../../../scripts/accounting';

        class MedicationPrescriptionDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'medication-prescription-dialog'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    medicationType: {
                        type: String,
                        value: 'medicinalProduct'
                    },
                    compoundPrescriptionText: {
                        type: String
                    },
                    columnsDefinition: {
                        type: Object,
                        value: function () {
                            return {
                                substanceProduct: [{key: 'name', title: 'Name', size: '400px'}],
                                medicinalProduct: [{key: 'name', title: 'Name', size: '400px'}, {
                                    key: 'pricepatstd',
                                    title: 'Price pat.'
                                }, {key: 'pubprice', title: 'Price'}]
                            };
                        }
                    },
                    selectedMedicationFromList: {
                        type: Object,
                        value: null,
                        observer: "_selectedMedicationFromListChanged"
                    },
                    selectedChronicalMedicationFromList: {
                        type: Object,
                        value: null
                    },
                    newMedication: {
                        type: Object,
                        value: null
                    },
                    isLoadingEntities: {
                        type: Boolean,
                        value: false
                    },
                    medications: {
                        type: Array,
                        value: () => []
                    },
                    medicationAccumulator: {
                        type: Array,
                        value: []
                    },
                    compoundListItems: {
                        type: Array,
                        value: () => []
                    },
                    selectedCompound: {
                        type: Object,
                        value: () => ({
                            medicationValue: null
                        })
                    },
                    isPrescription: {
                        type: Boolean,
                        value: false
                    },
                    searchOnIngredients: {
                        type: Boolean,
                        value: false,
                        observer: "_searchOnIngredientsChanged"
                    },

                    ingredients: {
                        type: Array,
                        value: () => []
                    },
                    ingredient: {
                        type: Object,
                        value: null
                    },

                    medicinalProducts: {
                        type: Array,
                        value: () => []
                    },
                    medicinalProduct: {
                        type: Object,
                        value: null
                    },

                    filterValue: {
                        type: String,
                        value: ""
                    },
                    filters: {
                        type: Object,
                        value: () => ({
                            medicationValue: null
                        })
                    },
                    filterNone : {
                        type: Object,
                        value: null
                    },
                    allDisabled: {
                        type: Boolean,
                        value: true
                    }
                }
            }

            static get observers() {
                return [
                    // 'medicationTypeChanged(medicationType)',
                ];
            }

            constructor() {
                super()
            }

            _isModerateRenalInsuf(type) {
                return true;
            }

            _isSevereRenalInsuf(type) {
                return true;
            }

            _isCompProhibitedDrug(type) {
                return true;
            }

            _isReinfPharmacoVig(type) {
                return true;
            }



            _isMedicinalProduct(medicationType) {
                return !_.trim(medicationType) || _.trim(medicationType) === "medicinalProduct"
            }

            _searchOnIngredientsChanged() {
                let grid = this.$['ingredient-list'];
                // Force bypass cache, we just checked / unchecked ingredient box
                if (grid && grid.drugsCache) {
                    grid.drugsCache = null;
                    grid.drugsCacheUpperSearchIndex = 0;
                    grid.clearCache();
                }
            }

            open(medication, options = {}) {
                this.set('newMedication', medication || {content: {}});
                this.set('medicationAccumulator', []);

                this.set('isPrescription', options.isPrescription);

                this.set('compoundFilterString', '')
                this.set('compound', '')
                this.set('compoundPrescriptionText', '')

                this.$['medication-prescription'].open()

                this.medications.map(m => {
                    const letter = ((m && m.codes && m.codes.find(c => c.type === 'CD-ATC') || {code: 'V'}).code || 'V').substr(0, 1)
                    m.atcCat = letter
                })

                this.set('medications', _.orderBy(this.medications, ['atcCat'], ['asc']))
            }

            _init() {
                this.latestSearchValue = this.filterValue;
                // this._initIngredientList();
                // this._initList('medicine-list', this.api.bedrugs().getMedecinePackages, null);
                const bedrugsIcc = this.api.bedrugs();
                // this._initList('ingredient-list', bedrugsIcc.getInnClusters.bind(bedrugsIcc), this._mppAdapter.bind(this));
                this._initList('medicinalProduct-list', bedrugsIcc.getMedecinePackages.bind(bedrugsIcc), this._mppAdapter.bind(this))
                this.filterNone = this.shadowRoot.querySelector("#filter-none");
                this.filterNone.active = true;
            }

            _mppAdapter(results) {
                if (results && results.length) {
                    let data = [];
                    return Promise.all(results.map(med => this.api.bedrugs().getMppInfos(med.id.id, this.language === 'en' ? 'fr' : this.language || 'fr')
                        .then(mppInfos => {
                            med.id.id && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-DRUG-CNK') || (med.codes[med.codes.length] = {
                                type: 'CD-DRUG-CNK',
                                version: '0.0.1'
                            })).code = med.id.id)
                            mppInfos.atcCode && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-ATC') || (med.codes[med.codes.length] = {
                                type: 'CD-ATC',
                                version: '0.0.1'
                            })).code = mppInfos.atcCode)

                            let item = {
                                "label": mppInfos.name,
                                "atc": mppInfos.atcCode,
                                "publicPrice": mppInfos.pubprice,
                                "type": "test",
                            };
                            data.push(item);
                        })))
                        .then(() => data);
                    // return this.api.bedrugs().getMppInfos(med.id.id, ).then(mppInfos => {
                    //
                    //     med.id.id && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-DRUG-CNK') || (med.codes[med.codes.length] = {
                    //         type: 'CD-DRUG-CNK',
                    //         version: '0.0.1'
                    //     })).code = med.id.id)
                    //     mppInfos.atcCode && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-ATC') || (med.codes[med.codes.length] = {
                    //         type: 'CD-ATC',
                    //         version: '0.0.1'
                    //     })).code = mppInfos.atcCode)
                    //
                    // })
                }
            }

            _medProdAdapter(results) {
                if (results && results.length) {
                    let data = [];
                    return Promise.all(results.map(mppResult => this.api.bedrugs().getExtentedMpInfosWithPackage(mppResult.id.id, this.language === 'en' ? 'fr' : this.language || 'fr')
                        .then(mppInfos => {
                            let item = {
                                "label": mppInfos.name,
                                "dosage": mppInfos.pos,
                                "atc": mppInfos.atcCode,
                                "publicPrice": mppInfos.pubprice,
                            };
                            data.push(item);
                        }))).then(() => data);
                }
            }


            _initList(list, search, adapter) {
                let grid = this.$[list];
                if (!grid) return;
                grid.lastParams = null; //Used to prevent double calls
                grid.size = 0;
                grid.pageSize = 10;
                grid.drugsCache = [];
                grid.dataProvider = (params, callback) => {
                    // const sort = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].path || columns[0] && columns[0].key;
                    const sort = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].path;
                    const desc = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].direction === 'desc' || false;

                    const pageSize = params.pageSize || grid.pageSize;
                    const startIndex = (params.page || 0) * pageSize;
                    const endIndex = ((params.page || 0) + 1) * pageSize;

                    // @TODO change mech to allow parallel serach
                    let latestSearchValue = this.filterValue
                    this.latestSearchValue = latestSearchValue
                    if (!latestSearchValue || latestSearchValue.length < 2) {
                        console.log("Cancelling empty search");
                        this.setGridSize(grid, 0);
                        callback([]);
                        return
                    }

                    console.log("Starting search for " + this.filterValue + "|" + sort + "|" + search.toString() + "|" + (desc ? "<|" : ">|") + startIndex + ":" + pageSize + ":")

                    const limit = endIndex || grid.pageSize;
                    const offset = params.index;
                    search(latestSearchValue, this.language, null, 0, 20).then(packs => {
                        return {
                            totalSize: packs.length,
                            rows: (desc ? _.reverse(_.sortBy(packs, sort)) : _.sortBy(packs, sort)).slice(offset, limit)
                        }
                    }).then(function (res) {
                        if (this.filterValue !== latestSearchValue) {
                            console.log("Cancelling obsolete search");
                            return
                        }
                        if (grid.size !== res.totalSize) {
                            this.setGridSize(grid, res.totalSize);
                        }
                        // adapter(res.rows);
                        adapter(_.slice(res.rows, startIndex, endIndex)).then(results => {
                            grid.latestResults = results;
                            if (grid.latestResults.length) {
                                (grid.drugsCache || (grid.drugsCache = []))[startIndex] = null;
                                grid.drugsCache.splice(startIndex, grid.latestResults.length, ...grid.latestResults);
                            }
                            callback(grid.latestResults)
                        })
                        // grid.latestResults = _.slice(res.rows, startIndex, endIndex);
                        // if (grid.latestResults.length) {
                        //     (grid.drugsCache || (grid.drugsCache = []))[startIndex] = null;
                        //     grid.drugsCache.splice(startIndex, grid.latestResults.length, ...grid.latestResults);
                        // }
                        // callback(grid.latestResults)
                    }.bind(this));
                }
            }

            _initIngredientList() {
                let grid = this.$['ingredient-list'];
                if (!grid) return;
                grid.lastParams = null; //Used to prevent double calls
                grid.size = 0;
                grid.pageSize = 50;
                grid.drugsCache = [];
                grid.dataProvider = (params, callback) => {
                    const sort = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].path || columns[0] && columns[0].key;
                    const desc = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].direction === 'desc' || false;

                    const pageSize = params.pageSize || grid.pageSize;
                    const startIndex = (params.page || 0) * pageSize;
                    const endIndex = ((params.page || 0) + 1) * pageSize;

                    // @TODO change mech to allow parallel search
                    let latestSearchValue = this.filterValue
                    this.latestSearchValue = latestSearchValue
                    if (!latestSearchValue || latestSearchValue.length < 2) {
                        console.log("Cancelling empty search");
                        this.setGridSize(grid, 0);
                        callback([]);
                        return
                    }

                    console.log("Starting search for " + this.filterValue + "|" + sort + "|innClusters|" + (desc ? "<|" : ">|") + startIndex + ":" + pageSize + ":")

                    const limit = endIndex || grid.pageSize;
                    const offset = params.index;
                    this.api.bedrugs().getInnClusters(latestSearchValue, this.language, null, 0, 100).then(packs => {
                        return {
                            totalSize: packs.length,
                            rows: (desc ? _.reverse(_.sortBy(packs, sort)) : _.sortBy(packs, sort)).slice(offset, limit)
                        }
                    }).then(function (res) {
                        if (this.filterValue !== latestSearchValue) {
                            console.log("Cancelling obsolete search");
                            return
                        }
                        if (grid.size !== res.totalSize) {
                            this.setGridSize(grid, res.totalSize);
                        }
                        grid.latestResults = _.slice(res.rows, startIndex, endIndex);
                        if (grid.latestResults.length) {
                            // ;(grid.drugsCache || (grid.drugsCache = []))[startIndex] = null
                            grid.drugsCache.splice(startIndex, grid.latestResults.length, ...grid.latestResults)
                        }
                        callback(grid.latestResults)
                    }.bind(this));
                }
            }

            _initMedicinePackageList() {
                let grid = this.$['medecine-list'];
                if (!grid) return;
                grid.lastParams = null; //Used to prevent double calls
                grid.size = 0;
                grid.pageSize = 50;
                grid.drugsCache = [];
                grid.dataProvider = (params, callback) => {
                    const sort = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].path || columns[0] && columns[0].key;
                    const desc = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].direction === 'desc' || false;

                    const pageSize = params.pageSize || grid.pageSize;
                    const startIndex = (params.page || 0) * pageSize;
                    const endIndex = ((params.page || 0) + 1) * pageSize;

                    // @TODO change mech to allow parallel serach
                    let latestSearchValue = this.filterValue
                    this.latestSearchValue = latestSearchValue
                    if (!latestSearchValue || latestSearchValue.length < 2) {
                        console.log("Cancelling empty search");
                        this.setGridSize(grid, 0);
                        callback([]);
                        return
                    }

                    console.log("Starting search for " + this.filterValue + "|" + sort + "|medecinepackages|" + (desc ? "<|" : ">|") + startIndex + ":" + pageSize + ":")

                    const limit = endIndex || grid.pageSize;
                    const offset = params.index;

                    this.api.bedrugs().getMedecinePackages(latestSearchValue, this.language, null, 0, 100).then((packs) => {
                        return {
                            totalSize: packs.length,
                            rows: (desc ? _.reverse(_.sortBy(packs, sort)) : _.sortBy(packs, sort)).slice(offset, limit)
                        }
                    }).then(function (res) {
                        if (this.filterValue !== latestSearchValue) {
                            console.log("Cancelling obsolete search");
                            return
                        }
                        if (grid.size !== res.totalSize) {
                            this.setGridSize(grid, res.totalSize);
                        }
                        grid.latestResults = _.slice(res.rows, startIndex, endIndex);
                        if (grid.latestResults.length) {
                            // ;(grid.drugsCache || (grid.drugsCache = []))[startIndex] = null
                            grid.drugsCache.splice(startIndex, grid.latestResults.length, ...grid.latestResults)
                        }
                        callback(grid.latestResults)
                    }.bind(this));
                }
            }

            ready() {
                super.ready()
                this._init();

                // let grid = this.$['ingredient-list'];
                //
                // grid.lastParams = null; //Used to prevent double calls
                // grid.size = 0;
                // grid.pageSize = 50;
                // grid.dataProvider = (params, callback) => {
                //
                //     // const columns = this._getColumns(this.medicationType)
                //
                //     const sort = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].path || columns[0] && columns[0].key;
                //     const desc = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].direction === 'desc' || false;
                //
                //     const pageSize = params.pageSize || grid.pageSize;
                //     const startIndex = (params.page || 0) * pageSize;
                //     const endIndex = ((params.page || 0) + 1) * pageSize;
                //
                //     const thisParams = this.filterValue + "|" + sort + "|" + this.medicationType + "|" + (desc ? "<|" : ">|") + startIndex + ":" + pageSize + ":"
                //
                //     let latestSearchValue = this.filterValue
                //     this.latestSearchValue = latestSearchValue
                //     if (!latestSearchValue || latestSearchValue.length < 2) {
                //         console.log("Cancelling empty search")
                //         this.setGridSize(grid, 0)
                //         callback([])
                //         return
                //     }
                //
                //     console.log("Starting search for " + thisParams)
                //
                //     const limit = endIndex || grid.pageSize
                //     const offset = params.index
                //     if (this.medicationType === 'substanceProduct') {
                //         this.api.bedrugs().getInnClusters(this.latestSearchValue, this.language, null, 0, 100).then(packs => {
                //             return {totalSize: packs.length, rows: (desc ? _.reverse(_.sortBy(packs, sort)) : _.sortBy(packs, sort)).slice(offset, limit)}
                //         }).then(function (res) {
                //             if (this.filterValue !== latestSearchValue) {
                //                 console.log("Cancelling obsolete search")
                //                 return
                //             }
                //             if (grid.size !== res.totalSize) {
                //                 this.setGridSize(grid, res.totalSize)
                //             }
                //             grid.latestResults = _.slice(res.rows, startIndex, endIndex)
                //             if (grid.latestResults.length) {
                //                 ;(grid.drugsCache || (grid.drugsCache = []))[startIndex] = null
                //                 grid.drugsCache.splice(startIndex, grid.latestResults.length, ...grid.latestResults)
                //             }
                //             callback(grid.latestResults)
                //         }.bind(this))
                //     } else {
                //         const fillCache = (minSize) =>
                //             grid.drugsCache && grid.drugsCache.allItemsLoaded ?
                //                 Promise.resolve(grid.drugsCache) :
                //                 Promise.all([
                //                     this.api.dedup(() => this.api.bedrugs().getMedecinePackages(this.latestSearchValue, this.language, null, grid.drugsCacheUpperSearchIndex || 0, 100), 'getMedecinePackages', `${this.latestSearchValue}|${this.language}|${grid.drugsCacheUpperSearchIndex}`, 5000),
                //                     this.searchOnIngredients ? this.api.dedup(() => this.api.bedrugs().getMedecinePackagesFromIngredients(this.latestSearchValue, this.language, null, grid.drugsCacheUpperSearchIndex || 0, 100), 'getMedecinePackagesFromIngredients', `${this.latestSearchValue}|${this.language}|${grid.drugsCacheUpperSearchIndex}`, 5000) : Promise.resolve({})
                //                 ])
                //                     .then(([packs, packsIng]) => {
                //                         const allDone = (packs||[]).length < 100 && (packsIng||[]).length
                //                         const newItems = _.unionBy(packs, packsIng, 'id.id') //what to do when there are no newitems ?
                //                         if (newItems.length > 0) {
                //                             grid.drugsCacheUpperSearchIndex = (grid.drugsCacheUpperSearchIndex || 0) + 100
                //                         }
                //                         return [(grid.drugsCache = _.sortBy(_.unionBy(grid.drugsCache || [], newItems, 'id.id'), 'name')), newItems.length, allDone]
                //                     })
                //                     .then(([cache, newItemsLength, allDone]) => {
                //                         cache.allItemsLoaded = !newItemsLength || allDone
                //                         return cache.length > minSize || !newItemsLength || allDone ? Promise.resolve(cache) : fillCache(minSize)
                //                     })
                //
                //         this.loadCheapAlternativesIfNeeded(this.selectedMedicationFromList).then(alternatives => {
                //             const cheapAlternativeSearchSeedIndex = this.cheapAlternativeSearchSeed ? grid.drugsCache.findIndex(mpp => this._id(mpp) === this._id(this.cheapAlternativeSearchSeed)) : -1
                //             const cacheEndIndex = cheapAlternativeSearchSeedIndex === -1 ? endIndex :
                //                 (cheapAlternativeSearchSeedIndex < endIndex ? endIndex - alternatives.length : endIndex)
                //             ;((grid.drugsCache && grid.drugsCache.length >= cacheEndIndex) ? Promise.resolve(grid.drugsCache) : fillCache(cacheEndIndex)).then(cache => {
                //                 this.setGridSize(grid, cache.length + alternatives.length)
                //
                //                 let fullVirtualDataSet = cache.map(it => it)
                //                 if (cheapAlternativeSearchSeedIndex === -1 || endIndex <= cheapAlternativeSearchSeedIndex) {
                //                     fullVirtualDataSet = cache.slice(startIndex, endIndex)
                //                 } else if (cheapAlternativeSearchSeedIndex + alternatives.length < startIndex) {
                //                     fullVirtualDataSet = cache.slice(startIndex - alternatives.length, endIndex - alternatives.length)
                //                 } else {
                //                     fullVirtualDataSet.splice(cheapAlternativeSearchSeedIndex + 1, 0, ...alternatives)
                //                     fullVirtualDataSet = fullVirtualDataSet.slice(startIndex, endIndex)
                //                 }
                //                 grid.fullVirtualDataSet = fullVirtualDataSet
                //                 callback(grid.fullVirtualDataSet)
                //             })
                //         })
                //     }
                // };
            }

            medicationTypeChanged(name) {
                if (this.medicationType === 'substanceProduct' || this.medicationType === 'medicinalProduct') {
                    let grid = this.$['ingredient-list'];
                    grid.clearCache()
                }
            }

            setGridSize(grid, size) {
                console.log('setSize', size)
                grid.set('size', size)
                this.set('isLoadingEntities', false)
            }

            _cellContent(item, column) {
                return column.key.indexOf("price") !== -1 ? accounting.formatMoney(_.get(item, column.key) / 100, "€", 2, " ", ",") :
                    (column.key.indexOf("name") !== -1 && _.get(item, "cheap") && _.get(item, "cheap") === 'cheap' ? '\u2794 ' + _.get(item, column.key) :
                        _.get(item, column.key));
            }

            _addCnkDci(e) {
                const grid = this.$['ingredient-list'];
                let med = null
                if (this.medicationType === 'substanceProduct') {
                    med = grid.latestResults.find(d => this._id(d) === e.target.id)
                } else {
                    med = grid.fullVirtualDataSet.find(d => this._id(d) === e.target.id)
                }
                this.checkAdr(med, () => this.selectMedicationFromList(med))
            }

            _addChron(e) {
                const med = this.medications.find(d => d.id === e.target.id)
                this.checkAdr(med, () => this.selectChron(med))
            }

            _addCompound(e) {
                if (this.compoundPrescriptionText && this.compoundPrescriptionText.length) {
                    ;((this.selectedCompound || (this.selectedCompound = {})).medicationValue || (this.selectedCompound.medicationValue = {})).compoundPrescription = this.compoundPrescriptionText
                    if (!this.selectedCompound.id) {
                        this.selectedCompound.id = this.compoundPrescriptionText
                    }
                    this.selectMedicationFromList(this.selectedCompound)

                    this.set('selectedCompound', null)
                    this.set('compoundPrescriptionText', '')
                    this.set('compoundFilterString', '')
                }
            }

            _removeFromAcc(e) {
                const idx = _.findIndex(this.medicationAccumulator, d => `remove-${this._id(d)}` === e.target.id)

                if (idx >= 0) {
                    this.set(`medicationAccumulator.${idx}.boxes`, (this.medicationAccumulator[idx].boxes || 1) - 1)
                    if (!this.medicationAccumulator[idx].boxes) {
                        this.splice('medicationAccumulator', idx, 1)
                    }
                }
            }

            _id(item) {
                return item && (item.id && (item.id.id || item.id) || item.inncluster || item.name)
            }

            _columnWidth(column) {
                return column.size || "100px";
            }

            selectMedicationFromList(med) {
                console.log("selectMedicationFromList", med)

                const unit = this.localize('generic_unit', 'unit', this.language)
                const newMedicationContent = {
                    medicationValue: {},
                    medicationUnit: unit,
                    regimen: [{administratedQuantity: {time: '', quantity: 1, unit: unit}}]
                }
                this.set('newMedication.content.' + this.language, newMedicationContent)

                const options = {
                    isPrescription: this.isPrescription
                }

                const id = this._id(med)

                const currentMedIdx = _.findIndex(this.medicationAccumulator, m => this._id(m) === id)
                if (currentMedIdx >= 0) {
                    this.set(`medicationAccumulator.${currentMedIdx}.boxes`, (this.medicationAccumulator[currentMedIdx].boxes || 1) + 1)
                } else {
                    if (med.id && med.id.id) {
                        //by productName
                        this.api.bedrugs().getMppInfos(med.id.id, this.language === 'en' ? 'fr' : this.language || 'fr').then(mppInfos => {
                            newMedicationContent.medicationValue.medicinalProduct = {
                                "intendedname": med.name,
                                "intendedcds": [{type: "CD-DRUG-CNK", code: med.id.id}],
                                "priority": 'low'
                            }
                            if (mppInfos.gal && mppInfos.gal.name) {
                                newMedicationContent.medicationUnit = newMedicationContent.regimen[0].administratedQuantity.unit = mppInfos.gal.name
                            }

                            med.id.id && (((this.newMedication.codes || (this.newMedication.codes = [])).find(c => c.type === 'CD-DRUG-CNK') || (this.newMedication.codes[this.newMedication.codes.length] = {
                                type: 'CD-DRUG-CNK',
                                version: '1'
                            })).code = med.id.id)
                            mppInfos.atcCode && (((this.newMedication.codes || (this.newMedication.codes = [])).find(c => c.type === 'CD-ATC') || (this.newMedication.codes[this.newMedication.codes.length] = {
                                type: 'CD-ATC',
                                version: '1'
                            })).code = mppInfos.atcCode)

                            const desc = this._serviceDescription(_.cloneDeep(this.newMedication));
                            if (desc) {
                                this.push('medicationAccumulator', {
                                    boxes: 1,
                                    newMedication: _.cloneDeep(this.newMedication),
                                    id,
                                    options
                                })
                            }
                        })
                    } else {
                        //by molecule
                        if (med.inncluster) {
                            newMedicationContent.medicationValue.substanceProduct = {
                                "intendedname": med.name,
                                "intendedcds": [{type: "CD-INNCLUSTER", code: med.inncluster}]
                            }

                            med.inncluster && (((this.newMedication.codes || (this.newMedication.codes = [])).find(c => c.type === 'CD-INNCLUSTER') || (this.newMedication.codes[this.newMedication.codes.length] = {
                                type: 'CD-INNCLUSTER',
                                version: '1'
                            })).code = med.inncluster)
                            med.atcCode && (((this.newMedication.codes || (this.newMedication.codes = [])).find(c => c.type === 'CD-ATC') || (this.newMedication.codes[this.newMedication.codes.length] = {
                                type: 'CD-ATC',
                                version: '1'
                            })).code = med.atcCode)
                        } else {
                            //Compound prescription
                            newMedicationContent.medicationValue = med.medicationValue
                        }
                        this.push('medicationAccumulator', {
                            boxes: 1,
                            newMedication: _.cloneDeep(this.newMedication),
                            id,
                            options
                        })
                    }
                }
            }

            validateMedications() {
                this.dispatchEvent(new CustomEvent('new-medications', {
                    detail: {medications: this.medicationAccumulator},
                    bubbles: true,
                    composed: true
                }))
            }

            click(e) {
                const selected = this.selectedMedicationFromList;

                console.log('selected ', selected, ' - ', this.latestSelected);
                if (this.inDoubleClick && (this._id(this.latestSelected) === this._id(selected) || this.latestSelected && !selected || !this.latestSelected && selected)) {
                    this._addCnkDci({target: {id: this._id(this.latestSelected)}})
                } else {
                    if (selected) this.latestSelected = selected;
                    this.inDoubleClick = true;

                    //Trigger cheapAlternativeSearch
                    if (this.selectedMedicationFromList && !this.selectedMedicationFromList.cheap) {
                        const grid = this.$['ingredient-list']
                        grid.clearCache();
                    }

                    setTimeout(() => {
                        delete this.inDoubleClick;
                    }, 500);
                }
            }

            clickChron(e) {
                const selected = this.selectedChronicalMedicationFromList;

                console.log('selected ', selected, ' - ', this.latestSelected);
                if (this.inDoubleClick && (this.latestSelected === selected || this.latestSelected && !selected || !this.latestSelected && selected)) {
                    this._addChron({target: {id: this._id(this.latestSelected)}})
                } else {
                    if (selected) this.latestSelected = selected;
                    this.inDoubleClick = true;

                    setTimeout(() => {
                        delete this.inDoubleClick;
                    }, 500);
                }

            }

            loadCheapAlternativesIfNeeded(searchSeed) {
                if (searchSeed) {
                    if (searchSeed.cheap) {
                        searchSeed = this.cheapAlternativeSearchSeed
                    }
                    if (!searchSeed.id) {
                        this.cheapAlternativeSearchSeed = null
                        return Promise.resolve([])
                    }
                    this.cheapAlternativeSearchSeed = searchSeed
                    return this.api.bedrugs().getCachedCheapAlternativesBasedOnAtc(searchSeed.id.id, 'fr')
                        .then(packs => packs.filter(mpp => this._id(searchSeed) !== this._id(mpp)).sort((mpp1, mpp2) => (mpp1.index || 10000000) - (mpp2.index || 10000000)).map(mpp => _.extend(_.extend({}, mpp), {cheap: 'cheap'})))
                } else {
                    this.cheapAlternativeSearchSeed = null
                    return Promise.resolve([])
                }
            }

            refresh() {
                //Give the gui the time to update the field
                setTimeout(function () {
                    let currentValue = this.filterValue;

                    if (this.latestSearchValue === currentValue) {
                        return;
                    }
                    setTimeout(function () {
                        if (currentValue === this.filterValue) {
                            this.set('isLoadingEntities', true)
                            console.log("Triggering search for " + this.filterValue);

                            this.selectedMedicationFromList = null
                            this.cheapAlternativeSearchSeed = null

                            const grid = this.$['medicinalProduct-list']
                            grid.drugsCache = null;
                            grid.drugsCacheUpperSearchIndex = 0;
                            grid.clearCache();
                        } else {
                            console.log("Skipping search for " + this.filterValue + " != " + currentValue);
                            this.set('isLoadingEntities', false)
                        }
                    }.bind(this), 500); //Wait for the user to stop typing
                }.bind(this), 100);
            }

            skip() {
                this.set('filterValue', '')
                this.set('medicationType', 'medicinalProduct')
                this.$['ingredient-list'].clearCache();
            }

            close() {
                if (!this.customFrequencyTable) {
                    this._setFrequencyList()
                }
                this.set('filterValue', '')
                this.$['ingredient-list'].clearCache();
                this.set('customFrequencyTable', false)
                this.set('flagTableFrequency', false)
            }

            select(item) {
                if (item) {
                    this.selectMedicationFromList(item);
                    this.set('filterValue', '')
                    this.set('medicationType', 'medicinalProduct')
                    this.$['ingredient-list'].clearCache();
                }
            }

            selectChron(med) {
                if (med) {
                    const id = this._id(med)
                    const currentMedIdx = _.findIndex(this.medicationAccumulator, m => m.id === id)
                    if (currentMedIdx >= 0) {
                        this.set(`medicationAccumulator.${currentMedIdx}.boxes`, (this.medicationAccumulator[currentMedIdx].boxes || 1) + 1)
                    } else {
                        this.push('medicationAccumulator', {
                            id,
                            boxes: 1,
                            newMedication: _.cloneDeep(med),
                            options: {isPrescription: this.isPrescription}
                        })
                    }
                }
            }

            _isEqual(a, b) {
                return a === b
            }

            _selectedMedicationFromListChanged(item) {
                var grid = this.$['medicinalProduct-list'];
                grid.selectedItems = item ? [item] : [];
            }

            _indexOfDayPeriod(code) {
                return this._dayPeriods.indexOf(code)
            }

            _getColumns(medicationType) {
                return this.columnsDefinition[medicationType] || []
            }

            _isCompoundPrescription(medicationType) {
                return medicationType === 'compoundPrescription';
            }

            _isMedicinalProduct(medicationType) {
                return medicationType === 'medicinalProduct';
            }

            _noGridClass(medicationType) {
                return this._isCompoundPrescription(medicationType) || this._isChronicalView(medicationType) ? 'no-grid' : ''
            }

            _noColumnClass(medicationType) {
                return this._isMedicinalProduct(medicationType) ? 'no-column' : ''
            }

            drugPicture(med) {
                if (!med.rrsstate) {
                    return require('../../../../images/Drug.None.gif')
                }
                if (med.rrsstate === 'R') {
                    return require('../../../../images/Drug.NotReduced.gif')
                } else if (med.rrsstate === 'B') {
                    return require('../../../../images/Drug.NoAlternative.gif')
                } else if (med.rrsstate === 'G') {
                    return require('../../../../images/Drug.Cheap.gif')
                } else {
                    return require('../../../../images/Drug.None.gif')
                }

                //return pat.picture ? 'data:image/jpeg;base64,' + pat.picture : pat.gender === 'female' ? require('../../../images/Female-128.jpg') : require('../../../images/Male-128.jpg')
            }

            _indexOfDayPeriod(code) {
                return this._dayPeriods.indexOf(code)
            }

            _getColumns(medicationType) {
                return this.columnsDefinition[medicationType] || []
            }

            _isCompoundPrescription(medicationType) {
                return medicationType === 'compoundPrescription';
            }

            _isMedicinalProduct(medicationType) {
                return medicationType === 'medicinalProduct';
            }

            _isChronicalView(medicationType) {
                return medicationType === "chronical"
            }

            atcCat(l) {
                return l === 'A' ? this.localize('ali_trac_meta', 'Alimentary tract and metabolism') :
                    l === 'B' ? this.localize('blo_blo_for', 'Blood and blood forming organs') :
                        l === 'C' ? this.localize('car_sys', 'Cardiovascular system') :
                            l === 'D' ? this.localize('dermatologicals', 'Dermatologicals') :
                                l === 'G' ? this.localize('gen_uri_sys', 'Genito-urinary system and sex hormones') :
                                    l === 'H' ? this.localize('sys_hor_pre', 'Systemic hormonal preparations, excluding sex hormones and insulins') :
                                        l === 'J' ? this.localize('anti_inf_sys', 'Antiinfectives for systemic use') :
                                            l === 'L' ? this.localize('anti_neo_imm', 'Antineoplastic and immunomodulating agents') :
                                                l === 'M' ? this.localize('mus_ske_sys', 'Musculo-skeletal system') :
                                                    l === 'N' ? this.localize('ner_sys', 'Nervous system') :
                                                        l === 'P' ? this.localize('Anti_para_pro', 'Antiparasitic products, insecticides and repellents') :
                                                            l === 'R' ? this.localize('res_sys', 'Respiratory system') :
                                                                l === 'S' ? this.localize('sens_org', 'Sensory organs') :
                                                                    l === 'V' ? this.localize('various', 'Various') : this.localize('unk', 'Unknown')
            }

            _atcColor(code) {
                if (!code) return "red";
                let c = code[0];
                return c === 'A' ? "pink" :
                    c === 'B' ? "orange" :
                        c === 'C' ? "yellow" :
                            c === 'D' ? "violet" :
                                c === 'G' ? "purple" :
                                    c === 'H' ? "lime" :
                                        c === 'J' ? "green" :
                                            c === 'L' ? "teal" :
                                                c === 'M' ? "blue" :
                                                    c === 'N' ? "brown" :
                                                        c === 'P' ? "beige" :
                                                            c === 'R' ? "grey" :
                                                                c === 'S' ? "cyan" :
                                                                    c === 'V' ? "olive" : "white";
            }

            _serviceDescription(s) {
                return this.api.contact().medication().medicationNameToString((this.api.contact().preferredContent(s, this.language) || {}).medicationValue, this.language)
            }

            _servicePosology(s) {
                return this.api.contact().medication().posologyToString((this.api.contact().preferredContent(s, this.language) || {}).medicationValue, this.language)
            }

            _compoundFilterChanged(e) {
                const searchString = e.detail.value || ''

                this.compoundSearchString = searchString;
                if (!searchString || searchString.length < 2) {
                    console.log("Cancelling empty search");
                    this.set('compoundListItems', []);
                    return;
                }

                this.api.entitytemplate().findAllEntityTemplates('org.taktik.icure.entities.embed.Medication', searchString, true).then(res => {
                    if (searchString !== this.compoundSearchString) {
                        console.log("Cancelling obsolete search");
                        this.set('compoundListItems', []);
                    }
                    this.set('compoundListItems', res);
                })
            }

            _compoundChanged(e) {
                const compound = this.compoundListItems.find(c => c.id === e.detail.value)
                if (compound) {
                    const medication = compound.entity.find(e => e.compoundPrescription)
                    this.set('selectedCompound', {
                        id: e.detail.value,
                        medicationValue: medication
                    })
                    this.set('compoundPrescriptionText', medication.compoundPrescription)
                } else {
                    this.set('selectedCompound', null);
                    this.set('compoundPrescriptionText', '')
                }
            }


            checkAdr(med, thenfun) {
                // check if patient have adverse drug reaction to this drug

                if (!this.user || !this.patient) {
                    console.log("no user or patient, abort")
                    return
                }
                if (!med) {
                    return
                }
                this.set('continueAddMedication', thenfun)
                this.api.helement().findBy(this.user.healthcarePartyId, this.patient).then(hes => {
                    console.log(hes)
                    this._fillMedecineCodes(med).then(() => {

                        const intols = hes
                            .filter(he => he.tags.find(tag => tag.type == "CD-ITEM" && tag.code == "adr"))
                            .filter(he =>
                                he.codes.find(hecode =>
                                    med.codes.find(medcode => hecode.type == medcode.type && hecode.code == medcode.code)
                                )
                            )

                        if (intols.length) {
                            this.set('intolItems', intols)
                            this.set('medicationToBeAdded', med)
                            if (!med.content) {
                                this.set('medicationToBeAdded_label', med.name)
                            } else {
                                const content = med.content[this.language]
                                this.set('medicationToBeAdded_label',
                                    this._any(
                                        content.medicationValue.medicinalProduct && content.medicationValue.medicinalProduct.intendedname,
                                        content.medicationValue.substanceProduct && content.medicationValue.substanceProduct.intendedname,
                                        content.medicationValue.compoundPrescription
                                    )
                                )
                            }
                            this.$['checkintol'].open()
                        } else {
                            console.log("no intol")
                            return thenfun()
                        }
                    })
                })

            }

            getIcpcLabel(he) {
                const icpc = he.codes && he.codes.find(t => t.type === 'ICPC' || t.type === 'ICPC2')
                return icpc && ((icpc.code || icpc.id.split('|')[1]) + ' - ')
            }

            _heShortDateFormat(date, altDate) {
                return (date || altDate) && "'" + this.api.moment((date || altDate)).format('YY') || '';
            }

            _any(a, b, c, d, e) {
                return a || b || c || d || e
            }

            _fillMedecineCodes(med) {
                // add codes to med in place and return promise
                if (med.id && med.id.id) {
                    //by productName
                    return this.api.bedrugs().getMppInfos(med.id.id, this.language === 'en' ? 'fr' : this.language || 'fr').then(mppInfos => {

                        med.id.id && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-DRUG-CNK') || (med.codes[med.codes.length] = {
                            type: 'CD-DRUG-CNK',
                            version: '0.0.1'
                        })).code = med.id.id)
                        mppInfos.atcCode && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-ATC') || (med.codes[med.codes.length] = {
                            type: 'CD-ATC',
                            version: '0.0.1'
                        })).code = mppInfos.atcCode)

                    })
                } else {
                    //by molecule
                    if (med.inncluster) {

                        med.inncluster && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-INNCLUSTER') || (med.codes[med.codes.length] = {
                            type: 'CD-INNCLUSTER',
                            version: '0.0.1'
                        })).code = med.inncluster)
                        med.atcCode && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-ATC') || (med.codes[med.codes.length] = {
                            type: 'CD-ATC',
                            version: '0.0.1'
                        })).code = med.atcCode)
                    } else {
                        //Compound prescription

                    }
                }
                return Promise.resolve([])

            }

            _getIntolIcon(intol) {
                const iconsMapping = {
                    allergy: "image:filter-vintage",
                    adr: "vaadin:pill",
                    risk: "vaadin:exclamation-circle",
                    socialrisk: "vaadin:group",
                    professionalrisk: "icons:work"
                }
                return iconsMapping[(intol.tags.find(c => (c.type === 'CD-ITEM' || c.type === 'CD-ITEM-EXT-CHARACTERIZATION')) || {}).code || '']
            }

            _chronicIcon(filter) {
                return filter === "chronic" ? "vaadin:close-circle" : "vaadin:clock";
            }

            _toggleFilter(e) {
                if (!this.filters.hasOwnProperty(e.currentTarget.id)) this.filters[e.currentTarget.id] = e.currentTarget;

                if (e.currentTarget.active) {
                    this.filterNone.active = true;
                    this.filterNone.disabled = true;
                } else {
                    this.filterNone.active = false;
                    this.filterNone.disabled = false;
                    Object.keys(this.filters).filter(key => this.filters[key] && this.filters[key].active).map(key => this.filters[key].active = false);
                }
            }
            _filterNone(e) {
                Object.keys(this.filters).filter(key => this.filters[key] && this.filters[key].active).map(key => this.filters[key].active = false);
                this.filterNone.disabled = true;
            }
        }

        customElements.define(MedicationPrescriptionDialog.is, MedicationPrescriptionDialog)
    </script>
</dom-module>
