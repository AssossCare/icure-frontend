<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/toggle-icon/toggle-icon.html">


<link rel="import" href="../../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/tk-token-field/tk-token-field.html">
<link rel="import" href="../../../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">

<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">

<link rel="import" href="../../../styles/atc-styles.html">
<link rel="import" href="../../../styles/dialog-style.html">
<link rel="import" href="../../../styles/scrollbar-style.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../icons/medication-icons.html">


<dom-module id="medication-prescription-dialog">
    <template>
        <style include="shared-styles dialog-style atc-styles buttons-style vaadin-grid-scrollbar-style">
            paper-input, paper-input-container {
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            paper-input-container {
                margin-top: 24px;
                margin-left: 40px;
            }

            .modal-button {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--cancel {
                background: transparent;
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }

            .modal-button--save {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700 !important;
            }

            .modal-button--force {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                color: var(--app-light-color) !important;
                font-weight: 700 !important;
                background: var(--app-status-color-nok);
            }

            .modal-button[disabled] {
                background-color: var(--app-secondary-color-dark);
                color: var(--app-text-color-disabled);
                box-shadow: none;
            }

            paper-input {
                --paper-input-container-focus-color: var(--app-primary-color);
                --paper-input-container-label: {
                    color: var(--app-text-color);
                    opacity: 1;
                };
            }

            paper-tabs {
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                width: 100%;
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color);
            }

            paper-tab.iron-selected {
                font-weight: bold;
            }

            paper-tab.iron-selected > iron-icon {
                color: var(--app-secondary-color);
            }

            paper-dialog {
                min-height: 480px;
                min-width: 600px;
                max-height: unset !important;
                height: 80%;
                width: 80%;
                top: 50%;
                transform: translateY(-50%);
            }

            .no-grid {
                display: none;
            }

            .no-column {
                display: none;
            }

            .column {
                margin: 2px;
            }

            div.cheap {
                color: #606060;
            }


            vaadin-combo-box {
                display: block;
                width: auto;
            }

            .buttons {
                position: absolute;
                bottom: 0;
            }

            .modal-button {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--cancel {
                background: transparent;
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }

            .modal-button--save {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;

            }

            ht-spinner {
                position: fixed;
                top: calc(50% + 62px);
                left: 25%;
                z-index: 150;
                transform: translate(-50%, -50%);
                height: 42px;
                width: 42px;
            }

            .container {
                display: flex;
                flex-flow: row wrap;
                justify-content: space-around;
                align-items: flex-start;
            }

            .left-pane {
                width: calc(67% - 12px);
                margin-right: 12px;
                flex-grow: 3;
            }

            .right-pane {
                width: calc(33% - 12px);
                margin-left: 12px;
                align-self: flex-end;
                flex-grow: 1;
            }

            .buttons {
                background: var(--app-background-color);
            }

            .add-btn--compound {
                position: absolute;
                left: 0;
                margin-top: 55px;
            }

            .helper {
                display: block;
                width: 100%;
                height: 62px;
            }

            .boxes-qty {
                display: inline-block;
                width: 18px;
            }

            .names-mobile-only {
                display: none;
            }

            .names-nomobile {
                display: initial;
            }

            #checkintol {
                display: flex;
                flex-direction: column;
                min-height: 640px;
                max-height: 50vh !important;
            }

            #checkintol em {
                font-weight: bold;
            }

            #checkintol div.warn {
                color: var(--app-status-color-nok);
                font-size: 1.2em;
            }

            #checkintol div.con {
                margin: 16px 0 8px 0;
            }

            #checkintol div.list {
                flex-grow: 1;
                margin: 8px 32px;
                padding: 0;
                overflow-y: auto;
                border: 1px solid var(--app-background-color-dark);
            }

            #checkintol div.list > div {
                padding: 4px 16px;
                height: 32px;
                border-bottom: 1px solid var(--app-background-color-dark);
                box-sizing: border-box;
            }

            #checkintol div.list > div:nth-child(2n-1) {
                background-color: var(--app-background-color-dark);
            }

            #checkintol div.list > div > iron-icon {
                height: 16px;
            }

            #checkintol div.endline {
                display: flex;
                flex-direction: row;
                justify-content: flex-end;
                margin: 8px 0;
                padding: 0;
                min-height: 40px;
            }

            #checkintol div.endline span {
                line-height: 40px;
                padding: 0 24px;
            }

            @media screen and (max-width: 936px) {
                paper-dialog#medication-selection,
                #checkintol {
                    position: fixed;
                    max-width: none !important;
                    top: 64px;
                    left: 0;
                    height: calc(100vh - 84px) !important;
                    width: 100vw !important;
                    margin: 0;
                    transform: none;
                }

                #checkintol {
                    max-height: none !important;
                }
            }

            @media screen and (max-width: 800px) {
                .names-mobile-only {
                    display: initial;
                }

                .names-nomobile {
                    display: none;
                }
            }

            @media screen and (max-width: 640px) {
                div.container {
                    flex-flow: initial;
                    flex-direction: column;
                    width: 100vw;
                    box-sizing: border-box;
                    overflow-y: auto;
                    /*height: calc(100vh - 164px);*/
                    justify-content: flex-start;
                }

                .left-pane, .right-pane {
                    width: 100%;
                    height: 33vh;
                }

                #entities-list {
                    height: auto;
                    max-height: 25vh;
                    overflow-y: auto;
                }

                .buttons {
                    position: fixed;
                    bottom: 0;
                    right: 0;
                }
            }


            .filter-icon {
                --paper-icon-button: {
                    height: 22px;
                    width: 22px;
                    padding: 2px;
                    margin: 0px;
                    border-radius: 50%;
                };

                --toggle-icon: {
                    background: var(--app-background-color);
                    color: var(--app-primary-color-dark);
                    border-radius: 50%;
                };

                --toggle-icon-checked: {
                    background: var(--app-status-color-pending);
                    color: var(--app-primary-color-dark);
                    border-radius: 50%;
                };
            }

            .filter-button {
                height: 22px;
                min-width: 24px;
                border-radius: 10%;
                width: auto;
                padding: 12px 20px;
                background-color: var(--app-background-color);
                color: var(--app-primary-color-dark);
            }

            .filter-button[active] {
                background-color: var(--app-status-color-pending);
                color: var(--app-primary-color-dark);
            }

            .button-group {
                margin-left: 12px;
            }

            vaadin-grid {
                width: 100%;
                box-shadow: var(--app-shadow-elevation-1);
                border: none;
                box-sizing: border-box;
            }

            vaadin-grid.header {
                flex: 0 0 40px;
            }

            vaadin-grid.sub-list {
                flex: 1 1 auto;

                --vaadin-grid-cell: {
                    padding: 8px;
                };

                --vaadin-grid-body-cell: {
                    height: 20px;
                    max-height: 20px;
                    font-size: var(--font-size-normal);
                };
            }

            vaadin-grid.sub-list-collapse {
                visibility: collapse !important;
                flex: 0 1 0px;
            }

            vaadin-grid.material .cell {
                overflow: hidden;
                text-overflow: ellipsis;
                padding-right: 0;
            }

            .dot {
                height: 8px;
                width: 8px;
                background-color: transparent;
                border-radius: 50%;
                display: inline-block;
                vertical-align: middle;
            }

            .table-icon {
                --iron-icon-height: 18px !important;
                --iron-icon-width: 18px !important;
                padding: 0px;
            }

            .icon-type-group {
                display: flex;
            }

            .filter-bar {
            }

            .filter-selected {
                color: var(--app-secondary-color) !important;
            }

            .filters-bar--small-icon {
                height: 32px
            }

            paper-icon-button.list-item-icon--add {
                padding: 0;
                height: 16px;
                width: 16px;
                border-radius: 2px;
                background: var(--app-secondary-color);
                color: var(--app-text-color-light);
            }

            .sub-header {
                position: relative;
                background: var(--app-background-color-dark);
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                box-sizing: border-box;
                box-shadow: var(--app-shadow-elevation-1);
                flex: 0 0 auto;
            }

            .sub-header .sub-header-title {
                flex-grow: 1;
            }

            .sub-header-title {
                display: block;
                @apply --paper-font-body2;
                @apply --padding-32;
                padding: 4px 0;
            }

            .search-pane {
                width: 67%;
                display: flex;
                flex-direction: column;
            }

            .search-bar {
                display: flex;
                flex-direction: row;
                align-items: center;
                height: 40px;
                padding: 12px 20px;
            }

            .search-field {
                flex-grow: 2;
            }

            #search {
                width: 100%;
            }

            .search-results {
                position: relative;
                box-sizing: border-box;
                float: left;
                padding: 12px 20px;
                display: flex;
                flex-flow: column nowrap;
                justify-content: flex-start;
                align-items: stretch;
                width: 100%;
                height: 590px;
            }

            .prescription-pane {
                width: 33%;
                display: flex;
                flex-direction: column;
            }

            .prescription-title {
                padding: 12px 20px;
                height: 40px;
                margin: 0;
            }

            .prescription-list {
                position: relative;
                box-sizing: border-box;
                float: left;
                padding: 12px 20px;
                display: flex;
                flex-flow: column nowrap;
                justify-content: flex-start;
                align-items: stretch;
                width: 100%;
                height: 590px;
            }

            .sub-list div {
                height: 18px;
                line-height: 18px;
                font-weight:500;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .price {
                text-align: right;
            }

            .CHAP4--PENDING {
                color: var(--paper-amber-a700) !important;
            }

            .CHAP4--PENDING-back::after {
                background: var(--paper-amber-a700) !important;
            }

            .CHAP4--PENDING span {
                background: var(--paper-amber-a700) !important;
            }

            .CHAP4--NOK {
                color: var(--paper-red-a200) !important;
            }

            .CHAP4--NOK-back::after {
                background: var(--paper-red-a200) !important;
            }

            .CHAP4--NOK span {
                background: var(--paper-red-a200) !important;
            }

            .CHAP4--OK {
                color: var(--paper-green-a700) !important;
            }

            .CHAP4--OK-back::after {
                background: var(--paper-green-a700) !important;
            }

            .CHAP4--OK span {
                background: var(--paper-green-a700) !important;
            }

            .CHAP4--HIDDEN {
                color: transparent !important;
            }

            .CHAP4--HIDDEN-back::after {
                background: transparent !important;
            }

            .CHAP4--HIDDEN span {
                background: transparent !important;
            }

            .small {
                padding: 1px;
                height: 20px;
                width: 20px;
            }

        </style>

        <paper-dialog id="medication-prescription" always-on-top="true">
            <ht-spinner class="center" active="[[isLoadingEntities]]"></ht-spinner>
            <h2 class="modal-title">[[localize('sel_med','Select medication',language)]]</h2>
            <div class="content container">
                <div class="prescription-pane">
                    <h5 class="prescription-title">[[localize('selected_meds','Selected medication(s)',language)]]</h5>
                    <div class="prescription-list">
                        <vaadin-grid class="sub-list" id="accumulated-medications" items="[[medicationAccumulator]]"
                                     active-item="{{selectedMedicationFromAccumulator}}">
                            <vaadin-grid-column width="72px">
                                <template class="header">
                                    <div>Boxes</div>
                                </template>
                                <template>
                                    <span class="boxes-qty">[[item.boxes]]</span>
                                    <paper-icon-button id="remove-[[_id(item)]]" class="add-btn" icon="icons:remove"
                                                       on-tap="_removeFromAcc"></paper-icon-button>
                                </template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="calc(100% - 72px)">
                                <template class="header">
                                    <div>Description</div>
                                </template>
                                <template>
                                    <div class="cell frozen">[[_serviceDescription(item.newMedication)]]</div>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                </div>
                <div class="search-pane">
                    <div class="search-bar">
                        <div class="search-field">
                            <paper-input id="search" label="[[localize('sch_med','Search a medicine',language)]]"
                                         autofocus
                                         value="{{filterValue}}" on-keydown="refresh"></paper-input>
                        </div>
                        <div class="button-group">
                            <paper-icon-button icon="vaadin:file-process" class="button--icon-btn small" on-tap=""
                                               id="action-medication-scheme"></paper-icon-button>
                            <paper-icon-button icon="medication-svg-icons:add-flask" class="button--icon-btn small" on-tap=""
                                               id="action-create-masterly"></paper-icon-button>
                        </div>
                        <div class="filter-bar">
                            <paper-icon-button icon="vaadin:alarm"
                                               class$="filters-bar--small-icon [[_activeIconClass('chronic', trigger)]]"
                                               id="chronic" on-tap="_toggleFilter" toggles></paper-icon-button>
                            <paper-icon-button icon="vaadin:time-backward"
                                               class$="filters-bar--small-icon [[_activeIconClass('history', trigger)]]"
                                               id="history" on-tap="_toggleFilter" toggles></paper-icon-button>
                            <paper-icon-button icon="vaadin:copyright"
                                               class$="filters-bar--small-icon [[_activeIconClass('medicine-package', trigger)]]"
                                               id="medicine-package" on-tap="_toggleFilter" toggles></paper-icon-button>
                            <paper-icon-button icon="vaadin:pill"
                                               class$="filters-bar--small-icon [[_activeIconClass('ingredient', trigger)]]"
                                               id="ingredient" on-tap="_toggleFilter" toggles></paper-icon-button>
                            <paper-icon-button icon="vaadin:flask"
                                               class$="filters-bar--small-icon [[_activeIconClass('masterly', trigger)]]"
                                               id="masterly" on-tap="_toggleFilter" toggles></paper-icon-button>
                        </div>
                    </div>
                    <div class="search-results">
                        <vaadin-grid id="header" class="header">
                            <vaadin-grid-column width="40px" flex-grow="0"></vaadin-grid-column>
                            <vaadin-grid-column width="40px" flex-grow="0"></vaadin-grid-column>
                            <vaadin-grid-column flex-grow="1">
                                <template class="header">Nom Posologie</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template class="header">ATC</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="108px" flex-grow="0">
                                <template class="header">Type</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template class="header">IV</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template class="header">Del</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template class="header">Cat</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0">
                                <template class="header">Patient</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0">
                                <template class="header">Public</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0">
                                <template class="header">Début</template>
                            </vaadin-grid-column>
                            <vaadin-grid-column flex-grow="0">
                                <template class="header">Fin</template>
                            </vaadin-grid-column>
                        </vaadin-grid>

                        <div class="sub-header" id="chronic" on-tap="_toggleFilter">
                            <paper-icon-button icon="vaadin:alarm"
                                               class$="filters-bar--small-icon [[_activeIconClass('chronic', trigger)]]"></paper-icon-button>
                            <span class="sub-header-title">[[localize('chronic','Chronique',language)]]</span>
                        </div>

                        <vaadin-grid id="chronic-list" class$="sub-list [[_activeListClass('chronic', trigger)]]"
                                     active-item="{{chronic}}">

                            <!-- ADD-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <paper-icon-button id="[[item.id]]" class="list-item-icon--add" icon="icons:add"
                                                       on-tap="_addChron"></paper-icon-button>
                                </template>
                            </vaadin-grid-column>

                            <!-- MASTERLY / TEMPLATE-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <template is="dom-if" if="[[_isMasterly(item.preparation)]]">
                                        <iron-icon icon="medication:masterly"></iron-icon>
                                    </template>
                                    <template is="dom-if" if="[[_isTemplate(item.preparation)]]">
                                        <iron-icon icon="medication:template"></iron-icon>
                                    </template>
                                </template>
                            </vaadin-grid-column>

                            <!-- NAME / DOSAGE-->

                            <vaadin-grid-column flex-grow="1">
                                <template>
                                        <div>[[item.label]]</div>
                                        <div>[[item.pos]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- ATC CLASS -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('ATC', item.atcCat)]]" id="[[item.atcCat]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.atcCat]]_[[item.id]]"
                                                   for="[[item.atcCat]]_[[item.id]]">[[_atcTooltip(item.atcCat)]]
                                    </paper-tooltip>
                                </template>

                            </vaadin-grid-column>

                            <!-- TYPE -->

                            <vaadin-grid-column width="108px" flex-grow="0">
                                <template>
                                    <div class="icon-type-group">
                                        <iron-icon icon="medication-svg-icons:[[item.compProhibIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.narcoticIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.moderateRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.severeRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.rmaPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.reinfPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                    </div>
                                </template>
                            </vaadin-grid-column>

                            <!-- CHAP IV -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('CHAP4', item.chap4Status)]]"
                                         id="[[item.chap4Status]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.chap4Status]]_[[item.id]]"
                                                   for="[[item.chap4Status]]_[[item.id]]">
                                        [[_chap4Tooltip(item.chap4Status)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- DELIVERED -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('DELIVERY', item.deliveryStatus)]]"
                                         id="[[item.deliveryStatus]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.deliveryStatus]]_[[item.id]]"
                                                   for="[[item.deliveryStatus]]_[[item.id]]">
                                        [[_deliveryTooltip(item.deliveryStatus)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- CATEGORY -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <iron-icon icon="medication-svg-icons:[[item.catIcon]]"
                                               class="table-icon"></iron-icon>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE -->


                            <!-- PRICE: PAT -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.patientPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE: PUBLIC -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.publicPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION -->


                            <!-- DURATION: START -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.startDate]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION: END -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.endDate]]</div>
                                </template>
                            </vaadin-grid-column>

                        </vaadin-grid>

                        <div class="sub-header" id="history" on-tap="_toggleFilter">
                            <paper-icon-button icon="vaadin:time-backward"
                                               class$="filters-bar--small-icon [[_activeIconClass('history', trigger)]]"></paper-icon-button>
                            <span class="sub-header-title">[[localize('his','Historique',language)]]</span>
                        </div>

                        <vaadin-grid id="history-list" class$="sub-list [[_activeListClass('history', trigger)]]"
                                     active-item="{{history}}">

                            <!-- ADD-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <paper-icon-button id="[[item.id]]" class="list-item-icon--add" icon="icons:add"
                                                       on-tap="_addChron"></paper-icon-button>
                                </template>
                            </vaadin-grid-column>

                            <!-- MASTERLY / TEMPLATE-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <template is="dom-if" if="[[_isMasterly(item.preparation)]]">
                                        <iron-icon icon="medication:masterly"></iron-icon>
                                    </template>
                                    <template is="dom-if" if="[[_isTemplate(item.preparation)]]">
                                        <iron-icon icon="medication:template"></iron-icon>
                                    </template>
                                </template>
                            </vaadin-grid-column>

                            <!-- NAME / DOSAGE-->

                            <vaadin-grid-column flex-grow="1">
                                <template>
                                    <div>[[item.label]]</div>
                                    <div>[[item.pos]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- ATC CLASS -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('ATC', item.atcCat)]]" id="[[item.atcCat]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip id="tt_[[item.atcCat]]_[[item.id]]"
                                                   for="[[item.atcCat]]_[[item.id]]">[[_atcTooltip(item.atcCat)]]
                                    </paper-tooltip>
                                </template>

                            </vaadin-grid-column>

                            <!-- TYPE -->

                            <vaadin-grid-column width="108px" flex-grow="0">
                                <template>
                                    <div class="icon-type-group">
                                        <iron-icon icon="medication-svg-icons:[[item.compProhibIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.narcoticIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.moderateRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.severeRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.rmaPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.reinfPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                    </div>
                                </template>
                            </vaadin-grid-column>

                            <!-- CHAP IV -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('CHAP4', item.chap4Status)]]"
                                         id="[[item.chap4Status]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.chap4Status]]_[[item.id]]"
                                                   for="[[item.chap4Status]]_[[item.id]]">
                                        [[_chap4Tooltip(item.chap4Status)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- DELIVERED -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('DELIVERY', item.deliveryStatus)]]"
                                         id="[[item.deliveryStatus]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.deliveryStatus]]_[[item.id]]"
                                                   for="[[item.deliveryStatus]]_[[item.id]]">
                                        [[_deliveryTooltip(item.deliveryStatus)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- CATEGORY -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <iron-icon icon="medication-svg-icons:[[item.catIcon]]"
                                               class="table-icon"></iron-icon>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE -->


                            <!-- PRICE: PAT -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.patientPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE: PUBLIC -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.publicPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION -->


                            <!-- DURATION: START -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.startDate]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION: END -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.endDate]]</div>
                                </template>
                            </vaadin-grid-column>

                        </vaadin-grid>

                        <div class="sub-header" id="medicine-package" on-tap="_toggleFilter">
                            <paper-icon-button icon="vaadin:copyright"
                                               class$="filters-bar--small-icon [[_activeIconClass('medicine-package', trigger)]]"></paper-icon-button>
                            <span class="sub-header-title">[[localize('commercial_name','Nom commercial',language)]]</span>
                        </div>

                        <vaadin-grid id="medicine-package-list"
                                     class$="sub-list [[_activeListClass('medicine-package', trigger)]]"
                                     active-item="{{medicinalProduct}}">

                            <!-- ADD-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <paper-icon-button id="[[item.id]]" class="list-item-icon--add" icon="icons:add"
                                                       on-tap="_addChron"></paper-icon-button>
                                </template>
                            </vaadin-grid-column>

                            <!-- MASTERLY / TEMPLATE-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <template is="dom-if" if="[[_isMasterly(item.preparation)]]">
                                        <iron-icon icon="medication:masterly"></iron-icon>
                                    </template>
                                    <template is="dom-if" if="[[_isTemplate(item.preparation)]]">
                                        <iron-icon icon="medication:template"></iron-icon>
                                    </template>
                                </template>
                            </vaadin-grid-column>

                            <!-- NAME / DOSAGE-->

                            <vaadin-grid-column flex-grow="1">
                                <template>
                                    <vaadin-grid-tree-toggle leaf="[[!item.hasChildren]]" expanded="{{expanded}}" level="[[level]]">
                                        <div>[[item.label]]</div>
                                    </vaadin-grid-tree-toggle>
                                </template>
                            </vaadin-grid-column>

                            <!-- ATC CLASS -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('ATC', item.atcCat)]]" id="[[item.atcCat]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.atcCat]]_[[item.id]]"
                                                   for="[[item.atcCat]]_[[item.id]]">[[_atcTooltip(item.atcCat)]]
                                    </paper-tooltip>
                                </template>

                            </vaadin-grid-column>

                            <!-- TYPE -->

                            <vaadin-grid-column width="108px" flex-grow="0">
                                <template>
                                    <div class="icon-type-group">
                                        <iron-icon icon="medication-svg-icons:[[item.compProhibIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.narcoticIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.moderateRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.severeRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.rmaPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.reinfPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                    </div>
                                </template>
                            </vaadin-grid-column>

                            <!-- CHAP IV -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('CHAP4', item.chap4Status)]]"
                                         id="[[item.chap4Status]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.chap4Status]]_[[item.id]]"
                                                   for="[[item.chap4Status]]_[[item.id]]">
                                        [[_chap4Tooltip(item.chap4Status)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- DELIVERED -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('DELIVERY', item.deliveryStatus)]]"
                                         id="[[item.deliveryStatus]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.deliveryStatus]]_[[item.id]]"
                                                   for="[[item.deliveryStatus]]_[[item.id]]">
                                        [[_deliveryTooltip(item.deliveryStatus)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- CATEGORY -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <iron-icon icon="medication-svg-icons:[[item.catIcon]]"
                                               class="table-icon"></iron-icon>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE -->


                            <!-- PRICE: PAT -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.patientPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE: PUBLIC -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.publicPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION -->


                            <!-- DURATION: START -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.startDate]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION: END -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.endDate]]</div>
                                </template>
                            </vaadin-grid-column>

                        </vaadin-grid>

                        <div class="sub-header" id="ingredient" on-tap="_toggleFilter" toggles>
                            <paper-icon-button icon="vaadin:pill"
                                               class$="filters-bar--small-icon [[_activeIconClass('ingredient', trigger)]]"></paper-icon-button>
                            <span class="sub-header-title">[[localize('mol','Molécule',language)]]</span>
                        </div>

                        <vaadin-grid id="ingredient-list" class$="sub-list [[_activeListClass('ingredient', trigger)]]"
                                     active-item="{{ingredient}}">

                            <!-- ADD-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <paper-icon-button id="[[item.id]]" class="list-item-icon--add" icon="icons:add"
                                                       on-tap="_addChron"></paper-icon-button>
                                </template>
                            </vaadin-grid-column>

                            <!-- MASTERLY / TEMPLATE-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <template is="dom-if" if="[[_isMasterly(item.preparation)]]">
                                        <iron-icon icon="medication:masterly"></iron-icon>
                                    </template>
                                    <template is="dom-if" if="[[_isTemplate(item.preparation)]]">
                                        <iron-icon icon="medication:template"></iron-icon>
                                    </template>
                                </template>
                            </vaadin-grid-column>

                            <!-- NAME / DOSAGE-->

                            <vaadin-grid-column flex-grow="1">
                                <template>
                                    <div>[[item.label]]</div>
                                    <div>[[item.pos]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- ATC CLASS -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('ATC', item.atcCat)]]" id="[[item.atcCat]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.atcCat]]_[[item.id]]"
                                                   for="[[item.atcCat]]_[[item.id]]">[[_atcTooltip(item.atcCat)]]
                                    </paper-tooltip>
                                </template>

                            </vaadin-grid-column>

                            <!-- TYPE -->

                            <vaadin-grid-column width="108px" flex-grow="0">
                                <template>
                                    <div class="icon-type-group">
                                        <iron-icon icon="medication-svg-icons:[[item.compProhibIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.narcoticIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.moderateRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.severeRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.rmaPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.reinfPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                    </div>
                                </template>
                            </vaadin-grid-column>

                            <!-- CHAP IV -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('CHAP4', item.chap4Status)]]"
                                         id="[[item.chap4Status]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.chap4Status]]_[[item.id]]"
                                                   for="[[item.chap4Status]]_[[item.id]]">
                                        [[_chap4Tooltip(item.chap4Status)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- DELIVERED -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('DELIVERY', item.deliveryStatus)]]"
                                         id="[[item.deliveryStatus]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.deliveryStatus]]_[[item.id]]"
                                                   for="[[item.deliveryStatus]]_[[item.id]]">
                                        [[_deliveryTooltip(item.deliveryStatus)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- CATEGORY -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <iron-icon icon="medication-svg-icons:[[item.catIcon]]"
                                               class="table-icon"></iron-icon>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE -->


                            <!-- PRICE: PAT -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.patientPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE: PUBLIC -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.publicPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION -->


                            <!-- DURATION: START -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.startDate]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION: END -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.endDate]]</div>
                                </template>
                            </vaadin-grid-column>

                        </vaadin-grid>

                        <div class="sub-header" id="masterly" on-tap="_toggleFilter" toggles>
                            <paper-icon-button icon="vaadin:flask"
                                               class$="filters-bar--small-icon [[_activeIconClass('masterly', trigger)]]"></paper-icon-button>
                            <span class="sub-header-title">[[localize('compound','Magistrale',language)]] / [[localize('template','Modèle',language)]]</span>
                        </div>

                        <vaadin-grid id="masterly-list" class$="sub-list [[_activeListClass('masterly', trigger)]]"
                                     active-item="{{masterly}}">

                            <!-- ADD-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <paper-icon-button id="[[item.id]]" class="list-item-icon--add" icon="icons:add"
                                                       on-tap="_addChron"></paper-icon-button>
                                </template>
                            </vaadin-grid-column>

                            <!-- MASTERLY / TEMPLATE-->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <template is="dom-if" if="[[_isMasterly(item.preparation)]]">
                                        <iron-icon icon="medication:masterly"></iron-icon>
                                    </template>
                                    <template is="dom-if" if="[[_isTemplate(item.preparation)]]">
                                        <iron-icon icon="medication:template"></iron-icon>
                                    </template>
                                </template>
                            </vaadin-grid-column>

                            <!-- NAME / DOSAGE-->

                            <vaadin-grid-column flex-grow="1">
                                <template>
                                    <div>[[item.label]]</div>
                                    <div>[[item.pos]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- ATC CLASS -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('ATC', item.atcCat)]]" id="[[item.atcCat]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.atcCat]]_[[item.id]]"
                                                   for="[[item.atcCat]]_[[item.id]]">[[_atcTooltip(item.atcCat)]]
                                    </paper-tooltip>
                                </template>

                            </vaadin-grid-column>

                            <!-- TYPE -->

                            <vaadin-grid-column width="108px" flex-grow="0">
                                <template>
                                    <div class="icon-type-group">
                                        <iron-icon icon="medication-svg-icons:[[item.compProhibIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.narcoticIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.moderateRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.severeRenalInsufIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.rmaPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                        <iron-icon icon="medication-svg-icons:[[item.reinfPharmaVigiIcon]]"
                                                   class="table-icon"></iron-icon>
                                    </div>
                                </template>
                            </vaadin-grid-column>

                            <!-- CHAP IV -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('CHAP4', item.chap4Status)]]"
                                         id="[[item.chap4Status]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.chap4Status]]_[[item.id]]"
                                                   for="[[item.chap4Status]]_[[item.id]]">
                                        [[_chap4Tooltip(item.chap4Status)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- DELIVERED -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <div class$="[[_getStyle('DELIVERY', item.deliveryStatus)]]"
                                         id="[[item.deliveryStatus]]_[[item.id]]">
                                        <span class="dot"></span>
                                    </div>
                                    <paper-tooltip z-index="1000" id="tt_[[item.deliveryStatus]]_[[item.id]]"
                                                   for="[[item.deliveryStatus]]_[[item.id]]">
                                        [[_deliveryTooltip(item.deliveryStatus)]]
                                    </paper-tooltip>
                                </template>
                            </vaadin-grid-column>

                            <!-- CATEGORY -->

                            <vaadin-grid-column width="40px" flex-grow="0">
                                <template>
                                    <iron-icon icon="medication-svg-icons:[[item.catIcon]]"
                                               class="table-icon"></iron-icon>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE -->


                            <!-- PRICE: PAT -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.patientPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- PRICE: PUBLIC -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div class="price">[[item.publicPrice]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION -->


                            <!-- DURATION: START -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.startDate]]</div>
                                </template>
                            </vaadin-grid-column>

                            <!-- DURATION: END -->

                            <vaadin-grid-column flex-grow="0">
                                <template>
                                    <div>[[item.endDate]]</div>
                                </template>
                            </vaadin-grid-column>

                        </vaadin-grid>
                    </div>
                </div>
            </div>
            <div class="buttons">
                <paper-button class="button" dialog-dismiss on-tap="skip">[[localize('can','Cancel',language)]]
                </paper-button>
                <paper-button class="button button--save" dialog-confirm autofocus on-tap="validateMedications"
                              disabled="[[!medicationAccumulator.length]]">[[localize('valid','Validate',language)]]
                </paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        import _ from 'lodash/lodash'
        import accounting from '../../../../scripts/accounting';
        import moment from 'moment/src/moment';

        class MedicationPrescriptionDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'medication-prescription-dialog'
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    medicationType: {
                        type: String,
                        value: 'medicinalProduct'
                    },
                    compoundPrescriptionText: {
                        type: String
                    },
                    columnsDefinition: {
                        type: Object,
                        value: function () {
                            return {
                                substanceProduct: [{key: 'name', title: 'Name', size: '400px'}],
                                medicinalProduct: [{key: 'name', title: 'Name', size: '400px'}, {
                                    key: 'pricepatstd',
                                    title: 'Price pat.'
                                }, {key: 'pubprice', title: 'Price'}]
                            };
                        }
                    },
                    selectedMedicationFromList: {
                        type: Object,
                        value: null,
                        observer: "_selectedMedicationFromListChanged"
                    },
                    selectedChronicalMedicationFromList: {
                        type: Object,
                        value: null
                    },
                    newMedication: {
                        type: Object,
                        value: null
                    },
                    isLoadingEntities: {
                        type: Boolean,
                        value: false
                    },
                    medications: {
                        type: Array,
                        value: () => []
                    },
                    prescriptions: {
                        type: Array,
                        value: () => []
                    },
                    medicationAccumulator: {
                        type: Array,
                        value: []
                    },
                    compoundListItems: {
                        type: Array,
                        value: () => []
                    },
                    selectedCompound: {
                        type: Object,
                        value: () => ({
                            medicationValue: null
                        })
                    },
                    isPrescription: {
                        type: Boolean,
                        value: false
                    },
                    searchOnIngredients: {
                        type: Boolean,
                        value: false,
                        observer: "_searchOnIngredientsChanged"
                    },

                    ingredients: {
                        type: Array,
                        value: () => []
                    },
                    medicinalProducts: {
                        type: Array,
                        value: () => []
                    },

                    medicinalProduct: {
                        type: Object,
                        value: null
                    },

                    ingredient: {
                        type: Object,
                        value: null
                    },

                    chronic: {
                        type: Object,
                        value: null
                    },

                    history: {
                        type: Object,
                        value: null
                    },

                    masterly: {
                        type: Object,
                        value: null
                    },

                    filterValue: {
                        type: String,
                        value: ""
                    },
                    filters: {
                        type: Object,
                        // notify: true,
                        value: []
                    },
                    filterNone: {
                        type: Object,
                        notify: true,
                        value: null
                    },
                    allDisabled: {
                        type: Boolean,
                        value: true
                    },

                    trigger: {
                        type: String,
                        notify: true,
                        value: ''
                    }
                }
            }

            static get observers() {
                return [
                    // 'medicationTypeChanged(medicationType)',
                ];
            }

            constructor() {
                super()
            }

            _isMedicinalProduct(medicationType) {
                return !_.trim(medicationType) || _.trim(medicationType) === "medicinalProduct"
            }

            _searchOnIngredientsChanged() {
                let grid = this.$['ingredient-list'];
                // Force bypass cache, we just checked / unchecked ingredient box
                if (grid && grid.drugsCache) {
                    grid.drugsCache = null;
                    grid.drugsCacheUpperSearchIndex = 0;
                    grid.clearCache();
                }
            }

            open(medication, options = {}) {
                this.set('newMedication', medication || {content: {}});
                this.set('medicationAccumulator', []);

                this.set('isPrescription', options.isPrescription);

                this.set('compoundFilterString', '')
                this.set('compound', '')
                this.set('compoundPrescriptionText', '')

                this.$['medication-prescription'].open()

                // this.medications.map(m => {
                //     const letter = ((m && m.codes && m.codes.find(c => c.type === 'CD-ATC') || {code: 'V'}).code || 'V').substr(0, 1)
                //     m.atcCat = letter
                // })

                this.set('medications', _.orderBy(this.medications, ['atcCat'], ['asc']))

                this._initList('chronic-list', this._servicesSearch.bind(this, this.medications), '_servicesSearch_medications', this._serviceAdapter.bind(this));
                this._initList('history-list', this._servicesSearch.bind(this, this.prescriptions), '_servicesSearch_prescriptions', this._serviceAdapter.bind(this));
                // this._initList('medicine-package-list', this._medecinePackagesSearch.bind(this), this._medicinePackageAdapter.bind(this));
                this._initList('medicine-package-list', this._medicinePackageSearchSamV2.bind(this), '_medicinePackageSearchSamV2', this._medicinePackageAdapterSamV2.bind(this));
                this._initList('ingredient-list', this._ingredientSearchSamV2.bind(this), '_ingredientSearchSamV2', this._ingredientAdapterSamV2.bind(this));
                this._initList('masterly-list', this._compoundPrescriptionsSearch.bind(this), '_compoundPrescriptionsSearch', this._serviceAdapter.bind(this));
            }

            _init() {
                // this.latestSearchValue = this.filterValue;
                // const bedrugsIcc = this.api.bedrugs();

                // OK
                // this._initList('ingredient-list', bedrugsIcc.getInnClusters.bind(bedrugsIcc), this._ingredientAdapter.bind(this));
                // this._initList('ingredient-list', this._ingredientSearch.bind(this), this._ingredientAdapter.bind(this));

                // OK
                //this._initList('medicine-package-list', bedrugsIcc.getMedecinePackages.bind(bedrugsIcc), this._medicinePackageAdapter.bind(this));

                // OK
                // this._initList('medicine-package-list', bedrugsIcc.getMedecinePackagesFromIngredients.bind(bedrugsIcc), this._medicinePackageAdapter.bind(this));

                // OK
                // this._initList('medicine-package-list', this._medecinePackagesSearch.bind(this), this._medicinePackageAdapter.bind(this));

                // OK
                // this._initList('chronic-list', this._chronicsSearch.bind(this), this._chronicAdapter.bind(this));

                // this.filterNone = this.shadowRoot.querySelector("#filter-none");
                // this.filterNone.active = true;
            }

            _compProhibIcon(info) {
                // return info.mp && info.mp.dopingcode && info.mp.dopingcode === "N" ? 'cat-doping-prod' : 'void';
                return info.mp && info.mp.dopingcode ? 'cat-doping-prod' : 'void';
            }

            _compProhibIconSamV2(vmpGroup) {
                return vmpGroup && vmpGroup.noGenericPrescriptionReason && vmpGroup.noGenericPrescriptionReason.code === "5" ? 'cat-doping-prod' : 'void';
            }

            _servereRenalInsufIcon(info) {
                return true ? 'severe-renal-insufficiency' : 'void';
            }

            _moderateRenalInsufIcon(info) {
                return true ? 'moderate-renal-insufficiency' : 'void';
            }

            _reinfPharmaVigiIcon(info) {
                return true ? 'reinf-pharma-vigi' : 'void';
            }

            _reinfPharmaVigiIconSamV2(info) {
                return info.blackTriangle ? 'reinf-pharma-vigi' : 'void';
            }

            _rmaPharmaVigiIcon(info) {
                return false ? 'rma-pharma-vigi' : 'void';
            }

            _catIcon(info) {
                switch (info.rrsstate) {
                    case 'B':
                        return 'cat-notcheap-noacm';
                    case 'G':
                        return 'cat-cheap-noacm';
                    case 'R':
                        return 'cat-notcheap-acm';
                    default :
                        return 'void';
                }
            }

            _catIconSamV2(ampp) {
                if (!ampp.publicDmpp || !ampp.currentReimbursement) return "";
                if (ampp.publicDmpp.cheap) {
                    if (ampp.currentReimbursement.copaymentSupplement) return 'void';
                    else return 'cat-cheap-noacm';
                } else {
                    if (ampp.currentReimbursement.copaymentSupplement) return 'cat-notcheap-acm';
                    else return 'cat-notcheap-noacm';
                }
            }

            _narcoticIcon(info) {
                return info.note === 'stupéfiant' ? 'stup' : 'void';
            }

            _hasValidChap4(s) {
                return (((this.api.contact().preferredContent(s, this.language) || {}).medicationValue || {}).agreements || []).some(z => z.accepted && (!!z.end || this.api.moment(z.end).isAfter(moment())));
            }

            _hasPendingChap4(s) {
                return (((this.api.contact().preferredContent(s, this.language) || {}).medicationValue || {}).agreements || []).some(z => z.inTreatment);
            }

            _hasChap4(s) {
                return !!(((this.api.contact().preferredContent(s, this.language) || {}).medicationValue || {}).agreements || []).length;
            }

            _hasValidChap4Class(s) {
                return this._hasValidChap4(s) ? 'ok' : this._hasPendingChap4(s) ? 'pending' : this._hasChap4(s) ? 'nok' : 'hidden';
            }

            _chap4Status(info) {
                const med = this.medications.find(m => (m.codes.find(c => c.type === 'CD-DRUG-CNK') || {}).code === info.id);
                if (med)
                    return this._hasValidChap4Class(med);
                else
                    return 'hidden';
            }

            _deliveryStatus(info) {

            }

            _isDrugAlreadyDelivered(s) {
                return s && s.tags && s.tags.find(t => (t.type === 'CD-ITEM' && t.code === 'treatment') || (t.type === 'ICURE' && t.code === 'PRESC')) && !s.endOfLife && s.tags.find(t => t.type === 'CD-LIFECYCLE' && t.code === 'delivered') && this.api.contact().medicationValue(s, this.language);
            }

            _getStyle(prefix, cat) {
                if (!cat) return '';
                return prefix + '--' + cat.toUpperCase() + ' span';
            }

            _buildListItem(mppInfos, prescInfos) {
                const medicationValue = prescInfos && prescInfos.content.fr.medicationValue;
                return {
                    "id": mppInfos.id.id,
                    "label": mppInfos.name,
                    "atc": mppInfos.atcCode,
                    "atcCat": mppInfos.atcCode && mppInfos.atcCode[0] || "",
                    "publicPrice": accounting.formatMoney(mppInfos.pubprice / 100, "€", 2, " ", ","),
                    "compProhibIcon": this._compProhibIcon(mppInfos),
                    "moderateRenalInsufIcon": this._moderateRenalInsufIcon(mppInfos),
                    "severeRenalInsufIcon": this._servereRenalInsufIcon(mppInfos),
                    "rmaPharmaVigiIcon": this._rmaPharmaVigiIcon(mppInfos),
                    "reinfPharmaVigiIcon": this._reinfPharmaVigiIcon(mppInfos),
                    "narcoticIcon": this._narcoticIcon(mppInfos),
                    "catIcon": this._catIcon(mppInfos),
                    "chap4Status": this._chap4Status(mppInfos),
                    "deliveryStatus": this._deliveryStatus(mppInfos),
                    "startDate": medicationValue && medicationValue.beginMoment && this.api.moment(medicationValue.beginMoment).format('DD/MM/YYYY') || '',
                    "endDate": medicationValue && medicationValue.endMoment && this.api.moment(medicationValue.endMoment).format('DD/MM/YYYY') || ''
                };
            }

            _medicinePackageAdapter(results) {
                if (results && results.length) {
                    return Promise.all(results.map(med => this.api.bedrugs().getMppInfos(med.id.id, this.language === 'en' ? 'fr' : this.language || 'fr')
                        .then(mppInfos => {
                            mppInfos.id.id && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-DRUG-CNK') || (med.codes[med.codes.length] = {
                                type: 'CD-DRUG-CNK',
                                version: '0.0.1'
                            })).code = med.id.id)
                            mppInfos.atcCode && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-ATC') || (med.codes[med.codes.length] = {
                                type: 'CD-ATC',
                                version: '0.0.1'
                            })).code = mppInfos.atcCode)

                            return this._buildListItem(mppInfos);
                        })))
                        .catch(err => {
                            console.log("error:", err);
                            return [];
                        });
                } else {
                    return Promise.resolve([]);
                }
            }

            _ingredientAdapter(results) {
                return Promise.resolve(results.map(result => {
                    return {
                        "id": result.inncluster,
                        "label": result.name
                    };
                }));
            }

            _ingredientAdapterSamV2(results) {
                if (results && results.length) {
                    return Promise.all(results.map(result => {
                        return {
                            "id": result.id,
                            "label": result.name[this.language]
                        };
                    }));
                } else {
                    return Promise.resolve([]);
                }
            }

            _serviceAdapter(results) {
                let data = [];
                if (results && results.length) {
                    let data = [];
                    return Promise.all(results.map(result => {
                        let id = ((result.codes || (result.codes = [])).find(c => c.type === 'CD-DRUG-CNK') || {code: ''}).code;
                        if (id && !id.includes(':')) {
                            return this.api.bedrugs().getMppInfos(id, this.language === 'en' ? 'fr' : this.language || 'fr')
                                .then(mppInfos => this._buildListItem(mppInfos, result));
                        } else {
                            return {
                                "id": result.id,
                                "label": result.label,
                                "pos": this.api.contact().medication().frequencyToString((this.api.contact().preferredContent(result, this.language) || {}).medicationValue, this.language)
                            };
                        }}))
                        .catch(err => {
                            console.log("error:", err);
                            return [];
                        });
                } else {
                    return Promise.resolve([]);
                }
            }

            _ingredientSearch(searchValue, language, type, first, count) {
                if (!searchValue || searchValue.length < 2) return Promise.resolve([]);
                return this.api.bedrugs().getInnClusters(searchValue, language, type, first, count);
            }

            _ingredientSearchSamV2(searchValue, language, type, first, count) {
                if (!searchValue || searchValue.length < 2) return Promise.resolve([]);
                return this.api.besamv2().findPaginatedVmpsByLabel(language, searchValue, null, null, count)
                    .then(results => (results && results.rows || []));
            }

            _medecinePackagesSearch(searchValue, language, type, first, count) {
                if (!searchValue || searchValue.length < 2) return Promise.resolve([]);
                return Promise.all([
                    this.api.bedrugs().getMedecinePackages(searchValue, language, type, first, count),
                    this.api.bedrugs().getMedecinePackagesFromIngredients(searchValue, language, type, first, count)
                ])
                    .then(([packs, packsIng]) => _.unionBy(packs, packsIng, 'id.id'));
            }

            _medicinePackageSearchSamV2(searchValue, language, type, first, count) {
                if (!searchValue || searchValue.length < 2) return Promise.resolve([]);
                return this.api.besamv2().findPaginatedAmpsByLabel(language, searchValue, null, null, count)
                    .then(results => (results && results.rows || []))
                    .then(rows => rows
                        .reduce((ampps, row) => {
                            if (row.ampps && row.ampps.length) {
                                return ampps.concat(row.ampps.map(ampp => {
                                    const now = moment().valueOf();
                                    const publicDmpp = ampp.dmpps.find(dmpp => dmpp.deliveryEnvironment === "P");
                                    const currentReimbursement = publicDmpp && publicDmpp.reimbursements && publicDmpp.reimbursements.length && publicDmpp.reimbursements.find(reimbursement => reimbursement.from < now && (!reimbursement.to || reimbursement.to > now ));
                                    return Object.assign(ampp, {
                                        publicDmpp: publicDmpp,
                                        currentReimbursement: currentReimbursement,
                                        cnk: publicDmpp && publicDmpp.codeType === 'CNK' && publicDmpp.code,
                                        prescriptionName: (ampp.prescriptionName && ampp.prescriptionName[this.language]) || (publicDmpp && publicDmpp.prescriptionName && publicDmpp.prescriptionName[this.language]) || (ampp.abbreviatedName && ampp.abbreviatedName[this.language]) || '',
                                        amp: row
                                    })
                                }));
                            }
                            return ampps;
                        }, [])
                        .filter((e, i, a) => e.publicDmpp && e.cnk && e.prescriptionName && a.findIndex(x => x.cnk === e.cnk) === i)
                    );
            }

            _medicinePackageAdapterSamV2(results) {
                return Promise.resolve(results
                    .map(ampp => {
                        const basePrice = ampp.currentReimbursement && ((ampp.currentReimbursement.referenceBasePrice && parseFloat(ampp.currentReimbursement.referenceBasePrice)) ||
                            ampp.currentReimbursement.reimbursementBasePrice && parseFloat(ampp.currentReimbursement.reimbursementBasePrice)) || 0;
                        const vmpGroup = ampp.vmp && ampp.vmp.vmpGroup;
                        return {
                            "id": ampp.ctiExtended,
                            "label": ampp.prescriptionName,
                            "atc": ampp.atcs[0].code,
                            "atcCat": ampp.atcs[0].code && ampp.atcs[0].code[0] || "",
                            "patientPrice": ampp.currentReimbursement && ampp.currentReimbursement.referenceBasePrice + "€",
                            "publicPrice": ampp.currentReimbursement && ampp.currentReimbursement.referenceBasePrice && ampp.currentReimbursement.copaymentSupplement && ((parseFloat(ampp.currentReimbursement.referenceBasePrice) + parseFloat(ampp.currentReimbursement.copaymentSupplement)).toFixed(2) + "€") || "",
                            "compProhibIcon": this._compProhibIconSamV2(vmpGroup),
                            "moderateRenalInsufIcon": this._moderateRenalInsufIcon(ampp),
                            "severeRenalInsufIcon": this._servereRenalInsufIcon(ampp),
                            "rmaPharmaVigiIcon": this._rmaPharmaVigiIcon(ampp),
                            "reinfPharmaVigiIcon": this._reinfPharmaVigiIconSamV2(ampp.amp),
                            "narcoticIcon": this._narcoticIcon(ampp),
                            "catIcon": this._catIconSamV2(ampp),
                            "chap4Status": this._chap4Status(ampp),
                            "deliveryStatus": this._deliveryStatus(ampp),
                            "startDate": '',
                            "endDate": ''
                        };
                    }));
            }


            _servicesSearch(source, searchValue, language, type, first, count) {
                // todo: this must be done only once per search!
                const normSearchValue = searchValue.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                return new Promise(resolve => {
                    // let results = [];
                    resolve(source.reduce((results, m) => {
                        const contentValue = m.content.fr.medicationValue || '';
                        const intendedName = contentValue.medicinalProduct ? contentValue.medicinalProduct.intendedname :
                            contentValue.substanceProduct ? contentValue.substanceProduct.intendedname : '';
                        if (!intendedName) return results;
                        const normIntendedName = intendedName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                        if (!searchValue || searchValue.length < 2 || normIntendedName.includes(normSearchValue)) {
                            m.label = intendedName;
                            results.push(m);
                        }
                        return results;
                    }, []));
                });
            }

            _compoundPrescriptionsSearch(searchValue, language, type, first, count) {
                const normSearchValue = searchValue.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                return new Promise(resolve => {
                    // let results = [];
                    resolve(this.prescriptions.reduce((results, m) => {
                        const contentValue = m.content.fr.medicationValue || '';
                        const intendedName = contentValue.compoundPrescription || '';
                        if (!intendedName) return results;
                        const normIntendedName = intendedName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                        if (!searchValue || searchValue.length < 2 || normIntendedName.includes(normSearchValue)) {
                            m.label = intendedName;
                            results.push(m);
                        }
                        return results;
                    }, []));
                });
            }

            _initList(list, search, domain, adapter) {
                this._list = list;
                let grid = this.$[list];
                if (!grid) return;
                grid.lastParams = null; //Used to prevent double calls
                grid.size = 0;
                grid.pageSize = 100;
                grid.drugsCache = [];
                grid.dataProvider = (params, callback) => {
                    // const sort = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].path || columns[0] && columns[0].key;
                    const sort = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].path;
                    const desc = params.sortOrders && params.sortOrders[0] && params.sortOrders[0].direction === 'desc' || false;

                    const pageSize = params.pageSize || grid.pageSize;
                    const startIndex = (params.page || 0) * pageSize;
                    const endIndex = ((params.page || 0) + 1) * pageSize;

                    const parentUuid = params.parentItem ? params.parentItem.uuid : null;


                    let latestSearchValue = this.filterValue && this.filterValue.trim();
                    this.latestSearchValue = latestSearchValue;

                    console.log("Starting search for " + this.filterValue + "|" + sort + "|" + search.toString() + "|" + (desc ? "<|" : ">|") + startIndex + ":" + pageSize + ":")

                    const limit = endIndex || grid.pageSize;
                    const offset = params.index;
                    this.api.dedup(() => search(latestSearchValue, this.language, null, 0, grid.pageSize), domain, `${this.latestSearchValue}|${this.language}|${grid.drugsCacheUpperSearchIndex}`, 5000)
                        .then(packs => {
                            return {
                                totalSize: packs.length,
                                rows: (desc ? _.reverse(_.sortBy(packs, sort)) : _.sortBy(packs, sort)).slice(offset, limit)
                            }
                        })
                        .then(function (res) {
                            if (this.filterValue !== latestSearchValue) {
                                console.log("Cancelling obsolete search");
                                return;
                            }
                            if (res.totalSize == 0) {
                                console.log("Empty search");
                                this.setGridSize(grid, 0);
                                callback([]);
                                return;
                            }

                            // if (grid.size !== res.totalSize) {
                            //     this.setGridSize(grid, res.totalSize);
                            // }
                            // adapter(res.rows);
                            adapter(_.slice(res.rows, startIndex, endIndex)).then(results => {
                                if (grid.size !== results.length) {
                                    this.setGridSize(grid, results.length);
                                }
                                grid.latestResults = results;
                                if (grid.latestResults.length) {
                                    (grid.drugsCache || (grid.drugsCache = []))[startIndex] = null;
                                    grid.drugsCache.splice(startIndex, grid.latestResults.length, ...grid.latestResults);
                                }
                                callback(grid.latestResults)
                            })
                        }.bind(this));
                };
            }

            ready() {
                super.ready();

                this.filters = {
                    'chronic': false,
                    'history': false,
                    'medicine-package': false,
                    'ingredient': false,
                    'masterly': false
                };

                this._init();
            }

            medicationTypeChanged(name) {
                if (this.medicationType === 'substanceProduct' || this.medicationType === 'medicinalProduct') {
                    let grid = this.$['ingredient-list'];
                    grid.clearCache()
                }
            }

            setGridSize(grid, size) {
                console.log('setSize', size)
                grid.set('size', size)
                this.set('isLoadingEntities', false)
            }

            _cellContent(item, column) {
                return column.key.indexOf("price") !== -1 ? accounting.formatMoney(_.get(item, column.key) / 100, "€", 2, " ", ",") :
                    (column.key.indexOf("name") !== -1 && _.get(item, "cheap") && _.get(item, "cheap") === 'cheap' ? '\u2794 ' + _.get(item, column.key) :
                        _.get(item, column.key));
            }

            _addCnkDci(e) {
                const grid = this.$['ingredient-list'];
                let med = null
                if (this.medicationType === 'substanceProduct') {
                    med = grid.latestResults.find(d => this._id(d) === e.target.id)
                } else {
                    med = grid.fullVirtualDataSet.find(d => this._id(d) === e.target.id)
                }
                this.checkAdr(med, () => this.selectMedicationFromList(med))
            }

            _addChron(e) {
                const med = this.medications.find(d => d.id === e.target.id)
                this.checkAdr(med, () => this.selectChron(med))
            }

            _addCompound(e) {
                if (this.compoundPrescriptionText && this.compoundPrescriptionText.length) {
                    ;((this.selectedCompound || (this.selectedCompound = {})).medicationValue || (this.selectedCompound.medicationValue = {})).compoundPrescription = this.compoundPrescriptionText
                    if (!this.selectedCompound.id) {
                        this.selectedCompound.id = this.compoundPrescriptionText
                    }
                    this.selectMedicationFromList(this.selectedCompound)

                    this.set('selectedCompound', null)
                    this.set('compoundPrescriptionText', '')
                    this.set('compoundFilterString', '')
                }
            }

            _removeFromAcc(e) {
                const idx = _.findIndex(this.medicationAccumulator, d => `remove-${this._id(d)}` === e.target.id)

                if (idx >= 0) {
                    this.set(`medicationAccumulator.${idx}.boxes`, (this.medicationAccumulator[idx].boxes || 1) - 1)
                    if (!this.medicationAccumulator[idx].boxes) {
                        this.splice('medicationAccumulator', idx, 1)
                    }
                }
            }

            _id(item) {
                return item && (item.id && (item.id.id || item.id) || item.inncluster || item.name)
            }

            _columnWidth(column) {
                return column.size || "100px";
            }

            selectMedicationFromList(med) {
                console.log("selectMedicationFromList", med)

                const unit = this.localize('generic_unit', 'unit', this.language)
                const newMedicationContent = {
                    medicationValue: {},
                    medicationUnit: unit,
                    regimen: [{administratedQuantity: {time: '', quantity: 1, unit: unit}}]
                }
                this.set('newMedication.content.' + this.language, newMedicationContent)

                const options = {
                    isPrescription: this.isPrescription
                }

                const id = this._id(med)

                const currentMedIdx = _.findIndex(this.medicationAccumulator, m => this._id(m) === id)
                if (currentMedIdx >= 0) {
                    this.set(`medicationAccumulator.${currentMedIdx}.boxes`, (this.medicationAccumulator[currentMedIdx].boxes || 1) + 1)
                } else {
                    if (med.id && med.id.id) {
                        //by productName
                        this.api.bedrugs().getMppInfos(med.id.id, this.language === 'en' ? 'fr' : this.language || 'fr').then(mppInfos => {
                            newMedicationContent.medicationValue.medicinalProduct = {
                                "intendedname": med.name,
                                "intendedcds": [{type: "CD-DRUG-CNK", code: med.id.id}],
                                "priority": 'low'
                            }
                            if (mppInfos.gal && mppInfos.gal.name) {
                                newMedicationContent.medicationUnit = newMedicationContent.regimen[0].administratedQuantity.unit = mppInfos.gal.name
                            }

                            med.id.id && (((this.newMedication.codes || (this.newMedication.codes = [])).find(c => c.type === 'CD-DRUG-CNK') || (this.newMedication.codes[this.newMedication.codes.length] = {
                                type: 'CD-DRUG-CNK',
                                version: '1'
                            })).code = med.id.id)
                            mppInfos.atcCode && (((this.newMedication.codes || (this.newMedication.codes = [])).find(c => c.type === 'CD-ATC') || (this.newMedication.codes[this.newMedication.codes.length] = {
                                type: 'CD-ATC',
                                version: '1'
                            })).code = mppInfos.atcCode)

                            const desc = this._serviceDescription(_.cloneDeep(this.newMedication));
                            if (desc) {
                                this.push('medicationAccumulator', {
                                    boxes: 1,
                                    newMedication: _.cloneDeep(this.newMedication),
                                    id,
                                    options
                                })
                            }
                        })
                    } else {
                        //by molecule
                        if (med.inncluster) {
                            newMedicationContent.medicationValue.substanceProduct = {
                                "intendedname": med.name,
                                "intendedcds": [{type: "CD-INNCLUSTER", code: med.inncluster}]
                            }

                            med.inncluster && (((this.newMedication.codes || (this.newMedication.codes = [])).find(c => c.type === 'CD-INNCLUSTER') || (this.newMedication.codes[this.newMedication.codes.length] = {
                                type: 'CD-INNCLUSTER',
                                version: '1'
                            })).code = med.inncluster)
                            med.atcCode && (((this.newMedication.codes || (this.newMedication.codes = [])).find(c => c.type === 'CD-ATC') || (this.newMedication.codes[this.newMedication.codes.length] = {
                                type: 'CD-ATC',
                                version: '1'
                            })).code = med.atcCode)
                        } else {
                            //Compound prescription
                            newMedicationContent.medicationValue = med.medicationValue
                        }
                        this.push('medicationAccumulator', {
                            boxes: 1,
                            newMedication: _.cloneDeep(this.newMedication),
                            id,
                            options
                        })
                    }
                }
            }

            validateMedications() {
                this.dispatchEvent(new CustomEvent('new-medications', {
                    detail: {medications: this.medicationAccumulator},
                    bubbles: true,
                    composed: true
                }))
            }

            click(e) {
                const selected = this.selectedMedicationFromList;

                console.log('selected ', selected, ' - ', this.latestSelected);
                if (this.inDoubleClick && (this._id(this.latestSelected) === this._id(selected) || this.latestSelected && !selected || !this.latestSelected && selected)) {
                    this._addCnkDci({target: {id: this._id(this.latestSelected)}})
                } else {
                    if (selected) this.latestSelected = selected;
                    this.inDoubleClick = true;

                    //Trigger cheapAlternativeSearch
                    if (this.selectedMedicationFromList && !this.selectedMedicationFromList.cheap) {
                        const grid = this.$['ingredient-list']
                        grid.clearCache();
                    }

                    setTimeout(() => {
                        delete this.inDoubleClick;
                    }, 500);
                }
            }

            clickChron(e) {
                const selected = this.selectedChronicalMedicationFromList;

                console.log('selected ', selected, ' - ', this.latestSelected);
                if (this.inDoubleClick && (this.latestSelected === selected || this.latestSelected && !selected || !this.latestSelected && selected)) {
                    this._addChron({target: {id: this._id(this.latestSelected)}})
                } else {
                    if (selected) this.latestSelected = selected;
                    this.inDoubleClick = true;

                    setTimeout(() => {
                        delete this.inDoubleClick;
                    }, 500);
                }

            }

            loadCheapAlternativesIfNeeded(searchSeed) {
                if (searchSeed) {
                    if (searchSeed.cheap) {
                        searchSeed = this.cheapAlternativeSearchSeed
                    }
                    if (!searchSeed.id) {
                        this.cheapAlternativeSearchSeed = null
                        return Promise.resolve([])
                    }
                    this.cheapAlternativeSearchSeed = searchSeed
                    return this.api.bedrugs().getCachedCheapAlternativesBasedOnAtc(searchSeed.id.id, 'fr')
                        .then(packs => packs.filter(mpp => this._id(searchSeed) !== this._id(mpp)).sort((mpp1, mpp2) => (mpp1.index || 10000000) - (mpp2.index || 10000000)).map(mpp => _.extend(_.extend({}, mpp), {cheap: 'cheap'})))
                } else {
                    this.cheapAlternativeSearchSeed = null
                    return Promise.resolve([])
                }
            }

            _clear(list) {
                const grid = this.$[list]
                if (!grid) return;
                grid.drugsCache = null;
                grid.drugsCacheUpperSearchIndex = 0;
                grid.clearCache();
            }

            _clearAll() {
                this._clear('chronic-list');
                this._clear('history-list');
                this._clear('medicine-package-list');
                this._clear('ingredient-list');
                this._clear('masterly-list');
            }

            refresh() {
                //Give the gui the time to update the field
                setTimeout(function () {
                    let currentValue = this.filterValue && this.filterValue.trim();

                    if (this.latestSearchValue === currentValue) {
                        return;
                    }
                    setTimeout(function () {
                        if (currentValue === this.filterValue) {
                            this.set('isLoadingEntities', true)
                            console.log("Triggering search for " + this.filterValue);

                            this.selectedMedicationFromList = null
                            this.cheapAlternativeSearchSeed = null
                            this._clearAll();
                        } else {
                            console.log("Skipping search for " + this.filterValue + " != " + currentValue);
                            this.set('isLoadingEntities', false)
                        }
                    }.bind(this), 500); //Wait for the user to stop typing
                }.bind(this), 100);
            }

            skip() {
                this.set('filterValue', '')
                this.set('medicationType', 'medicinalProduct')
                // this.$['ingredient-list'].clearCache();
                this._clearAll();
            }

            close() {
                if (!this.customFrequencyTable) {
                    this._setFrequencyList()
                }
                this.set('filterValue', '')
                // this.$['ingredient-list'].clearCache();
                this._clearAll();
                this.set('customFrequencyTable', false)
                this.set('flagTableFrequency', false)
            }

            select(item) {
                if (item) {
                    this.selectMedicationFromList(item);
                    this.set('filterValue', '')
                    this.set('medicationType', 'medicinalProduct')
                    this.$['ingredient-list'].clearCache();
                }
            }

            selectChron(med) {
                if (med) {
                    const id = this._id(med)
                    const currentMedIdx = _.findIndex(this.medicationAccumulator, m => m.id === id)
                    if (currentMedIdx >= 0) {
                        this.set(`medicationAccumulator.${currentMedIdx}.boxes`, (this.medicationAccumulator[currentMedIdx].boxes || 1) + 1)
                    } else {
                        this.push('medicationAccumulator', {
                            id,
                            boxes: 1,
                            newMedication: _.cloneDeep(med),
                            options: {isPrescription: this.isPrescription}
                        })
                    }
                }
            }

            _isEqual(a, b) {
                return a === b
            }

            _selectedMedicationFromListChanged(item) {
                var grid = this.$['medicine-package-list'];
                grid.selectedItems = item ? [item] : [];
            }

            _indexOfDayPeriod(code) {
                return this._dayPeriods.indexOf(code)
            }

            _getColumns(medicationType) {
                return this.columnsDefinition[medicationType] || []
            }

            _isCompoundPrescription(medicationType) {
                return medicationType === 'compoundPrescription';
            }

            _isMedicinalProduct(medicationType) {
                return medicationType === 'medicinalProduct';
            }

            _noGridClass(medicationType) {
                return this._isCompoundPrescription(medicationType) || this._isChronicalView(medicationType) ? 'no-grid' : ''
            }

            _noColumnClass(medicationType) {
                return this._isMedicinalProduct(medicationType) ? 'no-column' : ''
            }

            _indexOfDayPeriod(code) {
                return this._dayPeriods.indexOf(code)
            }

            _getColumns(medicationType) {
                return this.columnsDefinition[medicationType] || []
            }

            _isCompoundPrescription(medicationType) {
                return medicationType === 'compoundPrescription';
            }

            _isMedicinalProduct(medicationType) {
                return medicationType === 'medicinalProduct';
            }

            _isChronicalView(medicationType) {
                return medicationType === "chronical"
            }

            _atcTooltip(cat) {
                if (!cat) return "";
                return this.localize('atc-' + cat, '');
                // return cat === 'A' ? this.localize('ali_trac_meta', 'Alimentary tract and metabolism') :
                //     cat === 'B' ? this.localize('blo_blo_for', 'Blood and blood forming organs') :
                //         cat === 'C' ? this.localize('car_sys', 'Cardiovascular system') :
                //             cat === 'D' ? this.localize('dermatologicals', 'Dermatologicals') :
                //                 cat === 'G' ? this.localize('gen_uri_sys', 'Genito-urinary system and sex hormones') :
                //                     cat === 'H' ? this.localize('sys_hor_pre', 'Systemic hormonal preparations, excluding sex hormones and insulins') :
                //                         cat === 'J' ? this.localize('anti_inf_sys', 'Antiinfectives for systemic use') :
                //                             cat === 'L' ? this.localize('anti_neo_imm', 'Antineoplastic and immunomodulating agents') :
                //                                 cat === 'M' ? this.localize('mus_ske_sys', 'Musculo-skeletal system') :
                //                                     cat === 'N' ? this.localize('ner_sys', 'Nervous system') :
                //                                         cat === 'P' ? this.localize('Anti_para_pro', 'Antiparasitic products, insecticides and repellents') :
                //                                             cat === 'R' ? this.localize('res_sys', 'Respiratory system') :
                //                                                 cat === 'S' ? this.localize('sens_org', 'Sensory organs') :
                //                                                     cat === 'V' ? this.localize('various', 'Various') : this.localize('unk', 'Unknown')
            }

            _serviceDescription(s) {
                return this.api.contact().medication().medicationNameToString((this.api.contact().preferredContent(s, this.language) || {}).medicationValue, this.language)
            }

            _servicePosology(s) {
                return this.api.contact().medication().posologyToString((this.api.contact().preferredContent(s, this.language) || {}).medicationValue, this.language)
            }

            _compoundFilterChanged(e) {
                const searchString = e.detail.value || ''

                this.compoundSearchString = searchString;
                if (!searchString || searchString.length < 2) {
                    console.log("Cancelling empty search");
                    this.set('compoundListItems', []);
                    return;
                }

                this.api.entitytemplate().findAllEntityTemplates('org.taktik.icure.entities.embed.Medication', searchString, true).then(res => {
                    if (searchString !== this.compoundSearchString) {
                        console.log("Cancelling obsolete search");
                        this.set('compoundListItems', []);
                    }
                    this.set('compoundListItems', res);
                })
            }

            _compoundChanged(e) {
                const compound = this.compoundListItems.find(c => c.id === e.detail.value)
                if (compound) {
                    const medication = compound.entity.find(e => e.compoundPrescription)
                    this.set('selectedCompound', {
                        id: e.detail.value,
                        medicationValue: medication
                    })
                    this.set('compoundPrescriptionText', medication.compoundPrescription)
                } else {
                    this.set('selectedCompound', null);
                    this.set('compoundPrescriptionText', '')
                }
            }


            checkAdr(med, thenfun) {
                // check if patient have adverse drug reaction to this drug

                if (!this.user || !this.patient) {
                    console.log("no user or patient, abort")
                    return
                }
                if (!med) {
                    return
                }
                this.set('continueAddMedication', thenfun)
                this.api.helement().findBy(this.user.healthcarePartyId, this.patient).then(hes => {
                    console.log(hes)
                    this._fillMedecineCodes(med).then(() => {

                        const intols = hes
                            .filter(he => he.tags.find(tag => tag.type == "CD-ITEM" && tag.code == "adr"))
                            .filter(he =>
                                he.codes.find(hecode =>
                                    med.codes.find(medcode => hecode.type == medcode.type && hecode.code == medcode.code)
                                )
                            )

                        if (intols.length) {
                            this.set('intolItems', intols)
                            this.set('medicationToBeAdded', med)
                            if (!med.content) {
                                this.set('medicationToBeAdded_label', med.name)
                            } else {
                                const content = med.content[this.language]
                                this.set('medicationToBeAdded_label',
                                    this._any(
                                        content.medicationValue.medicinalProduct && content.medicationValue.medicinalProduct.intendedname,
                                        content.medicationValue.substanceProduct && content.medicationValue.substanceProduct.intendedname,
                                        content.medicationValue.compoundPrescription
                                    )
                                )
                            }
                            this.$['checkintol'].open()
                        } else {
                            console.log("no intol")
                            return thenfun()
                        }
                    })
                })

            }

            getIcpcLabel(he) {
                const icpc = he.codes && he.codes.find(t => t.type === 'ICPC' || t.type === 'ICPC2')
                return icpc && ((icpc.code || icpc.id.split('|')[1]) + ' - ')
            }

            _heShortDateFormat(date, altDate) {
                return (date || altDate) && "'" + this.api.moment((date || altDate)).format('YY') || '';
            }

            _any(a, b, c, d, e) {
                return a || b || c || d || e
            }

            _fillMedecineCodes(med) {
                // add codes to med in place and return promise
                if (med.id && med.id.id) {
                    //by productName
                    return this.api.bedrugs().getMppInfos(med.id.id, this.language === 'en' ? 'fr' : this.language || 'fr').then(mppInfos => {

                        med.id.id && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-DRUG-CNK') || (med.codes[med.codes.length] = {
                            type: 'CD-DRUG-CNK',
                            version: '0.0.1'
                        })).code = med.id.id)
                        mppInfos.atcCode && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-ATC') || (med.codes[med.codes.length] = {
                            type: 'CD-ATC',
                            version: '0.0.1'
                        })).code = mppInfos.atcCode)

                    })
                } else {
                    //by molecule
                    if (med.inncluster) {

                        med.inncluster && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-INNCLUSTER') || (med.codes[med.codes.length] = {
                            type: 'CD-INNCLUSTER',
                            version: '0.0.1'
                        })).code = med.inncluster)
                        med.atcCode && (((med.codes || (med.codes = [])).find(c => c.type === 'CD-ATC') || (med.codes[med.codes.length] = {
                            type: 'CD-ATC',
                            version: '0.0.1'
                        })).code = med.atcCode)
                    } else {
                        //Compound prescription

                    }
                }
                return Promise.resolve([])

            }

            _getIntolIcon(intol) {
                const iconsMapping = {
                    allergy: "image:filter-vintage",
                    adr: "vaadin:pill",
                    risk: "vaadin:exclamation-circle",
                    socialrisk: "vaadin:group",
                    professionalrisk: "icons:work"
                }
                return iconsMapping[(intol.tags.find(c => (c.type === 'CD-ITEM' || c.type === 'CD-ITEM-EXT-CHARACTERIZATION')) || {}).code || '']
            }

            _chronicIcon(filter) {
                return filter === "chronic" ? "vaadin:close-circle" : "vaadin:clock";
            }

            _activeIconClass(key, trigger) {
                return this.filters[key] ? 'filter-selected' : ''
            }

            _activeListClass(key, trigger) {
                if (Object.values(this.filters).every(f => !f)) return '';
                return this.filters[key] ? '' : 'sub-list-collapse';
            }

            _toggleFilter(e) {
                const key = e.currentTarget.id;
                this.filters[key] = !this.filters[key];
                Object.keys(this.filters).filter(k => k !== key && this.filters[k]).map(k => this.filters[k] = false);
                this.set('trigger', key + '_' + this.filters[key]);
            }
        }

        customElements.define(MedicationPrescriptionDialog.is, MedicationPrescriptionDialog)
    </script>
</dom-module>
