<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../styles/dialog-style.html">
<link rel="import" href="../../../styles/atc-styles.html">
<link rel="import" href="../../../styles/scrollbar-style.html">
<link rel="import" href="../../icons/medication-icons.html">

<dom-module id="prescription-history">
    <template>
        <style include="dialog-style atc-styles scrollbar-style">

            .table-container {
                margin-bottom: 24px;
            }

            .table-header {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--app-background-color-dark);
                font-size: 11px;
                color: var(--app-text-color-disabled);
                height: 28px;
            }

            .col {
                height: 100%;
                padding: 0 4px;
                box-sizing: border-box;
                display: flex;
                flex-flow: row wrap;
                justify-content: center;
                align-items: center;
            }

            .table-row {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                font-size: 12px;
                color: var(--app-text-color);
                height: 40px;
            }

            .table-row:nth-child(even) {
                background: var(--app-background-color-light);
            }

            .table-row .col:not(:last-child) {
                border-right: 1px solid var(--app-background-color-dark);
            }

            .table {
                display: flex;
                flex-flow: column nowrap;
                font-size: .8rem;
                margin: 0.5rem;
                line-height: 1.5;
                flex: 1 1 auto;
            }

            .table div{
                box-sizing: border-box;
            }

            .th {
                display: none;
                font-weight: 700;
                text-align: left;
            }

            .th:first-child {
                border-top: 1px solid var(--app-background-color-dark);
            }

            .th > .td {
                white-space: nowrap;
                text-overflow: ellipsis;
                justify-content: center;
            }

            .th .td {
                color: var(--app-text-color);
            }

            .th .td:first-child {
                box-sizing: border-box;
            }

            .tr {
                position: relative;
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                color: var(--app-text-color);
                z-index: 1;
                height: 32px;
            }

            .td {
                position: relative;
                display: flex;
                flex-flow: row nowrap;
                align-items: center;
                flex-basis: 0;
                padding: 0.5em;
                overflow: hidden;
                min-width: 0px;
                z-index: 2;
                word-break: break-word;
                white-space: nowrap;
                border-right: 1px solid var(--app-background-color-dark);
                font-size: 13px;
                text-align: left;
            }

            .fg0 {
                flex-grow: 0;
            }

            .fg1 {
                flex-grow: 1;
            }

            .fg2 {
                flex-grow: 2;
            }

            .td span{
                text-overflow: ellipsis;
                width: 100%;
                overflow: hidden;
                text-align: center;
            }

            .td:first-child {
                border-left: 1px solid var(--app-background-color-dark);
            }

            .th .td {
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .content{
                padding: 0;
            }

        </style>
        <div class="content">
            <div class="table">
                <div class="tr th">
                    <div class="td fg0" style="min-width: 100px">Date</div>
                    <div class="td fg0" style="min-width: 140px">Code</div>
                    <div class="td fg2" style="min-width: 300px">Name</div>
                    <div class="td fg1" style="min-width: 200px">Drugs</div>
                    <div class="td fg0" style="min-width: 140px">Status</div>
                    <div class="td fg0" style="min-width: 100px">Actions</div>
                </div>
                <template is="dom-repeat" items="[[prescriptions]]" as="item">
                    <div class="tr">
                        <div class="td fg0" style="min-width: 100px">[[item.date]]</div>
                        <div class="td fg0" style="min-width: 140px">[[item.rid]]</div>
                        <div class="td fg2" style="min-width: 300px">[[item.name]]</div>
                        <div class="td fg1" style="min-width: 200px">
                            <div class="table">
                                <template is="dom-repeat" items="[[item.cds]]" as="cd">
                                <div class="tr">
                                    <div class="td fg1" style="min-width: 200px">[[cd]]</div>
                                </div>
                                </template>
                            </div>
                        </div>
                        <div class="td fg0" style="min-width: 140px">[[_getValue(item.status, refresher)]]</div>
                        <div class="td fg0" style="min-width: 100px">
                            <template is="dom-if" if="[[item.rid]]">
                                <paper-icon-button data-rid="[[item.rid]]" class="form-title-bar-btn" icon="social:notifications" on-tap="_notify"></paper-icon-button>
                                <paper-icon-button data-rid="[[item.rid]]" class="form-title-bar-btn" icon="icons:delete" on-tap="_revoke"></paper-icon-button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <script>

        import _ from 'lodash/lodash'

        class PrescriptionHistory extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'prescription-history'
            }

            static get properties() {
                return {
                    hcp: {
                        type: Object,
                        value: null
                    },
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    patient : {
                        type : Object,
                        value : {}
                    },
                    refresher: {
                        type: Number,
                        value: 0
                    },
                    prescriptions: {
                        type: Array,
                        value: () => []
                    },
                }
            }

            static get observers() {
                return []
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
            }

            attached() {
                super.attached();
                this.async(this.notifyResize, 1);
            }

            setPrescriptions(prescriptions) {
                this.set("prescriptions", prescriptions);
                this.set("refresher", this.refresher + 1)
            }

            _getValue(value) {
                return value;
            }

            _updateFeedback(e) {
                const rid = e.currentTarget.dataRid;
                console.log("_update " + rid);
                if (!this.hcp) return;
                this.api.fhc().Recipecontroller().updateFeedbackFlagUsingPUT(this.api.keystoreId, this.api.tokenId, "persphysician", this.hcp.nihii, this.hcp.ssin, this.hcp.lastName, this.api.credentials.ehpassword, rid)
                .then(result => {
                    console.log("updated: ", result)
                })
                .catch(error => {
                    console.log("error:", error)
                })
            }

            _notify(e) {
                const rid = e.currentTarget.dataRid;
                console.log("_notify " + rid);
                if (!this.hcp) return;
                this.api.fhc().Recipecontroller().sendNotificationUsingPOST(this.api.keystoreId, this.api.tokenId, "persphysician", this.hcp.nihii, this.hcp.ssin, this.hcp.lastName, this.api.credentials.ehpassword, rid)
                .then(result => {
                    console.log("notified: ", result)
                })
                .catch(error => {
                    console.log("error:", error)
                })
            }

            _revoke(e) {
                const rid = e.currentTarget.dataRid;
                console.log("_revoke " + rid);
                if (!this.hcp) return;
                this.api.fhc().Recipecontroller().revokePrescriptionUsingDELETE(this.api.keystoreId, this.api.tokenId, "persphysician", this.hcp.nihii, this.hcp.ssin, this.hcp.lastName, this.api.credentials.ehpassword, rid, "no reason specified")
                .then(isDeleted => {
                    console.log("delete rid: ", isDeleted)
                })
                .catch(error => {
                    console.log("error:", error)
                })
            }
        }

        customElements.define(PrescriptionHistory.is, PrescriptionHistory)
    </script>
</dom-module>
