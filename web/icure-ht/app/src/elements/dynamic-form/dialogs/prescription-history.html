<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column-group.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../styles/dialog-style.html">
<link rel="import" href="../../../styles/atc-styles.html">
<link rel="import" href="../../../styles/scrollbar-style.html">
<link rel="import" href="../../icons/medication-icons.html">

<dom-module id="prescription-history">
    <template>
        <style include="dialog-style atc-styles scrollbar-style">

            .table-container {
                margin-bottom: 24px;
            }

            .table-header {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--app-background-color-dark);
                font-size: 11px;
                color: var(--app-text-color-disabled);
                height: 28px;
            }

            .col {
                height: 100%;
                padding: 0 4px;
                box-sizing: border-box;
                display: flex;
                flex-flow: row wrap;
                justify-content: center;
                align-items: center;
            }

            .table-row {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                font-size: 12px;
                color: var(--app-text-color);
                height: 40px;
            }

            .table-row:nth-child(even) {
                background: var(--app-background-color-light);
            }

            .table-row .col:not(:last-child) {
                border-right: 1px solid var(--app-background-color-dark);
            }

            .table {
                display: flex;
                flex-flow: column nowrap;
                font-size: .8rem;
                margin: 0.5rem;
                line-height: 1.5;
                flex: 1 1 auto;
            }

            .table div{
                box-sizing: border-box;
            }

            .th {
                display: none;
                font-weight: 700;
                text-align: left;
            }

            .th:first-child {
                border-top: 1px solid var(--app-background-color-dark);
            }

            .th > .td {
                white-space: nowrap;
                text-overflow: ellipsis;
                justify-content: center;
            }

            .th .td {
                color: var(--app-text-color);
            }

            .th .td:first-child {
                box-sizing: border-box;
            }

            .tr {
                position: relative;
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                color: var(--app-text-color);
                z-index: 1;
                height: 32px;
            }

            .td {
                position: relative;
                display: flex;
                flex-flow: row nowrap;
                align-items: center;
                flex-basis: 0;
                padding: 0.5em;
                overflow: hidden;
                min-width: 0px;
                z-index: 2;
                word-break: break-word;
                white-space: nowrap;
                border-right: 1px solid var(--app-background-color-dark);
                font-size: 13px;
                text-align: left;
            }

            .fg0 {
                flex-grow: 0;
            }

            .fg1 {
                flex-grow: 1;
            }

            .fg2 {
                flex-grow: 2;
            }

            .td span{
                text-overflow: ellipsis;
                width: 100%;
                overflow: hidden;
                text-align: center;
            }

            .td:first-child {
                border-left: 1px solid var(--app-background-color-dark);
            }

            .th .td {
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .status {
                border-radius: 20px;
                padding: 1px 12px 1px 8px;
                font-size: 14px;
                display: block;
                width: auto;
                max-width: fit-content;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
            }

            .statusOrange{
                background: #fcdf354d;
            }
            .statusGreen{
                background: #07f8804d;
            }
            .statusRed{
                background: #ff4d4d4d;
            }

            .statusIcon {
                height: 8px;
                width: 8px;
            }

            .statusIconOrange {
                color: var(--app-status-color-pending);
            }
            .statusIconGreen {
                color: var(--app-status-color-ok);
            }
            .statusIconRed {
                color: var(--app-status-color-nok);
            }

            paper-icon-button > iron-icon {
                height: 16px;
                width: 16px;
            }

            .filter {
                display: flex;
                flex-flow: row nowrap;
            }

            .dateFilter {
                mergin-left: 5px;
            }

            .content{
                padding: 0;
            }

        </style>
        <div class="content">

            <div class="filter">
                <vaadin-date-picker class="dateFilter" id="dateMin" on-value-changed="_onValueChanged" label="De"
                    value="{{dateMin}}" i18n="[[i18n]]"></vaadin-date-picker>
                <vaadin-date-picker class="dateFilter" id="dateMax" on-value-changed="_onValueChanged" label="Ã "
                    value="{{dateMax}}" i18n="[[i18n]]"></vaadin-date-picker>
            </div>

            <div class="table">
                <div class="tr th">
                    <div class="td fg0" style="min-width: 100px">Date</div>
                    <div class="td fg0" style="min-width: 140px">Code</div>
                    <div class="td fg2" style="min-width: 300px">Name</div>
                    <div class="td fg1" style="min-width: 200px">Drugs</div>
                    <div class="td fg0" style="min-width: 140px">Status</div>
                    <div class="td fg0" style="min-width: 100px">Actions</div>
                </div>
                <template is="dom-repeat" items="[[prescriptions]]" as="item">
                    <div class="tr">
                        <div class="td fg0" style="min-width: 100px">[[item.date]]</div>
                        <div class="td fg0" style="min-width: 140px">[[item.rid]]</div>
                        <div class="td fg2" style="min-width: 300px">[[item.name]]</div>
                        <div class="td fg1" style="min-width: 200px">
                            <div class="table">
                                <template is="dom-repeat" items="[[item.cds]]" as="cd">
                                <div class="tr">
                                    <div class="td fg1" style="min-width: 200px">[[cd]]</div>
                                </div>
                                </template>
                            </div>
                        </div>
                        <div class="td fg0" style="min-width: 140px">
                            <span class$="status status[[_getStatusClass(item, refresher)]]"><iron-icon icon="vaadin:circle" class$="statusIcon statusIcon[[_getStatusClass(item, refresher)]]"></iron-icon>&nbsp;[[_getStatus(item, refresher)]]</span>
                        </div>
                        <div class="td fg0" style="min-width: 100px">
                            <paper-icon-button data-rid$="[[item.rid]]" icon="print" on-tap="_print"></paper-icon-button>
                            <template is="dom-if" if="[[item.rid]]">
                                <paper-icon-button data-rid$="[[item.rid]]" icon="social:notifications" on-tap="_notify"></paper-icon-button>
                                <paper-icon-button data-rid$="[[item.rid]]" icon="icons:block" on-tap="_revoke"></paper-icon-button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <script>

        import _ from 'lodash/lodash'

        const STATUS_NOT_SENT = 1;
        const STATUS_SENT = 2;
        const STATUS_PENDING = 4;
        const STATUS_DELIVERED = 8;
        const STATUS_REVOKED = 16;

        class PrescriptionHistory extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'prescription-history'
            }

            static get properties() {
                return {
                    hcp: {
                        type: Object,
                        value: null
                    },
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    dateMin: {
                        type: Object,
                        value: null
                    },
                    dateMax: {
                        type: Object,
                        value: null
                    },
                    patient : {
                        type : Object,
                        value : {}
                    },
                    refresher: {
                        type: Number,
                        value: 0
                    },
                    prescriptions: {
                        type: Array,
                        value: () => []
                    },
                }
            }

            static get observers() {
                return []
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
            }

            attached() {
                super.attached();
                this.async(this.notifyResize, 1);
            }

            setPrescriptions(prescriptions) {
                this._prescriptions = prescriptions;
                this.set("prescriptions", prescriptions);
                this.set("refresher", this.refresher + 1)
                const min = this.api.moment(Date.now()).subtract(1, 'Y');
                const max = this._tomorrow();
                this.set("dateMin", min.format("YYYY-MM-DD"));
                this.set("dateMax", max.format("YYYY-MM-DD"));
                this._filter();
            }

            _tomorrow() {
                return this.api.moment(Date.now()).add(1, 'd');
            }

            _between(date, min, max) {
                if (min && max) return date >=min && date <= max;
                if (min) return date >= min;
                if (max) return date <= max;
                return true;
            }

            _filter() {
                if (!this._prescriptions) return;
                this.$["dateMin"].max = this.$["dateMax"].value;
                this.$["dateMax"].min = this.$["dateMin"].value;
                this.$["dateMax"].max = this._tomorrow().format("YYYY-MM-DD");
                const min = this.dateMin ? parseInt(this.api.moment(this.dateMin).format('YYYYMMDDHHmmss')) : null;
                const max = this.dateMax ? parseInt(this.api.moment(this.dateMax).format('YYYYMMDDHHmmss')) : null;
                const prescriptions = this._prescriptions.filter(p => this._between(p.service.valueDate, min, max));
                this.set("prescriptions", prescriptions);
            }

            _onValueChanged(e) {
                console.log("change");
                this.dateMin = this.$["dateMin"].value;
                this.dateMax = this.$["dateMax"].value;
                this._filter();
            }

            _getStatus(item) {
                return item.status;
            }

            _getStatusClass(item) {
                if (item.service.status & STATUS_DELIVERED )
                    return "Green";
                if (item.service.status & STATUS_REVOKED )
                    return "Red";
                return "Orange";
            }

            _updateFeedback(e) {
                const rid = e.currentTarget.dataset.rid;
                console.log("_update " + rid);
                if (!this.hcp) return;
                this.api.fhc().Recipecontroller().updateFeedbackFlagUsingPUT(this.api.keystoreId, this.api.tokenId, "persphysician", this.hcp.nihii, this.hcp.ssin, this.hcp.lastName, this.api.credentials.ehpassword, rid)
                .then(result => {
                    console.log("updated: ", result)
                })
                .catch(error => {
                    console.log("error:", error)
                })
            }

            _notify(e) {
                const rid = e.currentTarget.dataset.rid;
                console.log("_notify " + rid);
                if (!this.hcp) return;
                this.api.fhc().Recipecontroller().sendNotificationUsingPOST(this.api.keystoreId, this.api.tokenId, "persphysician", this.hcp.nihii, this.hcp.ssin, this.hcp.lastName, this.api.credentials.ehpassword, rid)
                .then(result => {
                    console.log("notified: ", result)
                })
                .catch(error => {
                    console.log("error:", error)
                })
            }

            _revoke(e) {
                const rid = e.currentTarget.dataset.rid;
                console.log("_revoke " + rid);
                if (!this.hcp) return;
                const prescription = this.prescriptions.find(p => p.rid === rid);
                prescription.service.content.fr.medicationValue.status = STATUS_SENT | STATUS_REVOKED;
                this.api.fhc().Recipecontroller().revokePrescriptionUsingDELETE(this.api.keystoreId, this.api.tokenId, "persphysician", this.hcp.nihii, this.hcp.ssin, this.hcp.lastName, this.api.credentials.ehpassword, rid, "no reason specified")
                .then(isDeleted => {
                    console.log("revoke1", isDeleted)
                    return isDeleted ? this.api.contact().modifyContactWithUser(this.user, prescription.contact)
                        .then(() => {
                            console.log("revoke2")
                        }) : Promise.resolve();
                })
                .catch(error => {
                    console.log("error:", error)
                })
            }

            _print(e) {
                const rid = e.currentTarget.dataset.rid;
                console.log("_print " + rid);
                if (!this.hcp) return;
                const prescription = this.prescriptions.find(p => p.rid === rid);
                this.dispatchEvent(new CustomEvent('print-prescription', {
                    detail: {
                        service: prescription.service
                    },
                    bubbles:true,
                    composed:true
                }))
            }
        }

        customElements.define(PrescriptionHistory.is, PrescriptionHistory)
    </script>
</dom-module>
