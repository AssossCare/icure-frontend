<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">



<dom-module id="dynamic-info">
    <template>
        <style include="shared-styles">
            paper-menu-button {
                padding: 0;
                color: grey
            }

            paper-icon-button {
                padding: 0 4px 8px 4px;
                width: 20px;
                height: 20px;
            }

            .link .colour-code span {
                content: '';
                display: inline-block;
                height: 6px;
                width: 6px;
                border-radius: 3px;
                margin-right: 3px;
                margin-bottom: 1px;
            }

            paper-item {
                font-size: 14px;
                min-height: 30px;
            }

            .dropdown_icon{
                height: 12px;
            }

            .status_icon{
                height: 8px;
            }

            .stat_act{
                color: var( --paper-green-400);
            }

            .stat_pass_rev{
                color: var(--paper-orange-400);
            }

            .stat_pass_n_rev{
                color: var( --paper-red-400);
            }

            .stat_not_pres{
                color: var(--paper-grey-400);
            }



            .buttons {
                position: initial;
                display: flex;
                background: var(--app-background-color);
                z-index: 10;
                bottom: 0;
                right: 0;
                box-sizing: border-box;
            }


        </style>

        <template is="dom-if" if="[[_display(linkedInfo)]]">
            <paper-menu-button id="menu-info" horizontal-align="left" dynamic-align="true" opened="{{opened}}" allow-outside-scroll>
                <paper-icon-button id="info_menu" class="form-title-bar-btn" icon="vaadin:info-circle" slot="dropdown-trigger" alt="menu" on-tap="_show"></paper-icon-button>
                <paper-tooltip for="subctc-type">[[localize('info','Information',language)]]</paper-tooltip>
                <paper-listbox slot="dropdown-content">
                    <template is="dom-if" if="[[_isDescription(linkedInfo, linkedInfo.*)]]">
                        <paper-item id="" class="link" on-tap="_showDescription">
                            <iron-icon icon="vaadin:info-circle-o" class="dropdown_icon"></iron-icon>
                            [[localize('info_descr', 'Description', language)]]
                        </paper-item>
                    </template>
                    <template is="dom-if" if="[[_isExternalLink(linkedInfo, linkedInfo.*)]]">
                        <paper-item id="" class="link" on-tap="_redirectToLink">
                            <iron-icon icon="vaadin:external-link" class="dropdown_icon"></iron-icon>
                            [[localize('info_ext-lnk', 'External link', language)]]
                        </paper-item>
                    </template>
                    <template is="dom-if" if="[[_isVideo(linkedInfo, linkedInfo.*)]]">
                        <paper-item id="" class="link" on-tap="_redirectToVideo">
                            <iron-icon icon="vaadin:presentation" class="dropdown_icon"></iron-icon>
                            [[localize('info_vid-lnk', 'Video', language)]]
                        </paper-item>
                    </template>
                </paper-listbox>
            </paper-menu-button>
        </template>

    </template>
    <script>

        class DynamicInfo extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'dynamic-info';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    linkables: {
                        type: Array
                    },
                    representedObject: {
                        type: Object
                    },
                    noStatus: {
                        type: Boolean,
                        value: false
                    },
                    opened: {
                        type: Boolean,
                        value: false,
                        observer: '_opened'
                    },
                    openedOnce: {
                        type: Boolean,
                        value: false
                    }
                };
            }

            static get observers() {
                return ['_initialize(dataInfo)'];
            }

            ready() {
                super.ready();
            }

            _initialize(){
                this.dataInfo.then(code => {
                    code && code.length > 0 ? this.set('linkedInfo', code) : null
                })
            }

            _opened(b) {
                this.set('openedOnce', b || this.openedOnce)
            }

            _linkables(links,b) {
                return b ? links: []
            }

            _show(e) {
                e.preventDefault();
                e.stopPropagation();

                if(e.target.id === "info_menu"){
                    this.root.querySelector('#menu-info').open();
                }

            }

            _display(linkedInfo) {
                return linkedInfo.length > 0
            }

            _showDescription(e){
                e.stopPropagation()
                _.get(this, 'linkedInfo.0.appendices.description', null)  !== null ?  this.dispatchEvent(new CustomEvent('open-dynamic-description-dialog', {detail: {desc: _.get(this, 'linkedInfo.0.appendices.description', null)}, bubbles: true, composed: true})) : null
            }

            _redirectToLink(e){
                e.stopPropagation()
                _.get(this, 'linkedInfo.0.appendices.externalLink', null) !== null ? window.open(_.get(this, 'linkedInfo.0.appendices.externalLink', null),'_blank') : null

            }

            _redirectToVideo(e){
                e.stopPropagation()
                _.get(this, 'linkedInfo.0.appendices.video', null) !== null ? window.open(_.get(this, 'linkedInfo.0.appendices.video', null),'_blank') : null
            }

            _isDescription(info){
                return _.get(info[0], 'appendices.description', null) !== null && _.get(info[0], 'appendices.description', null) !== ""
            }

            _isExternalLink(info){
               return _.get(info[0], 'appendices.externalLink', null) !== null && _.get(info[0], 'appendices.externalLink', null) !== ""
            }

            _isVideo(info){
               return _.get(info[0], 'appendices.video', null) !== null && _.get(info[0], 'appendices.video', null) !== ""
            }

        }
        customElements.define(DynamicInfo.is, DynamicInfo);
    </script>
</dom-module>
