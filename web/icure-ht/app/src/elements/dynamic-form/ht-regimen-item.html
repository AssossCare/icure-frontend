<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-style.html">

<dom-module id="ht-regimen-item">
    <template>

        <style include="buttons-style">
            .base {
                box-sizing: border-box;
                width: 100%;
                height: var(--counter-height);
                color: transparent;
                background: var(--app-background-color-dark);
                padding: 0;
                margin: 0;
                border-radius: var(--counter-border-radius);
                -webkit-user-select: none;

                display: flex;
            }
            .base:hover {
                background: rgba(255, 80, 0, .2);
            }
            .base:focus {
                background: rgba(221, 52, 21, .2);
            }

            .positive {
                background: var(--app-secondary-color);
                color: var(--app-text-color-light);
            }
            .positive:hover {
                background: var(--app-secondary-color-dark);
            }
            .positive:focus {
                background: var(--app-secondary-color-dark);
                color: #fafafa;
            }

            .control-button {
                --control-button-positive: {
                    height: var(--counter-height);
                    width: calc(var(--counter-height) - 4px);
                    background: var(--app-secondary-color);
                    color: var(--app-text-color-light);
                    padding: 2px;
                };

                --paper-icon-button: {
                    height: 0;
                    width: 0;
                    padding: 0;
                    margin: 0;
                };
            }
            .control-button.positive {
                --paper-icon-button: {
                    @apply --control-button-positive;
                };
            }
            .control-button.left {
                border-radius: var(--counter-border-radius);
                border-top-right-radius: 0;
                border-bottom-right-radius: 0;
            }
            .control-button.right {
                border-radius: var(--counter-border-radius);
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
            }

            .quantity-label {
                width: 100%;
                line-height: var(--counter-height);
                font-weight: 500;
                font-size: var(--font-size-normal);
                padding: 0;
                margin: 0;
                text-align: center;
                display: block;
                border-width: 0;
            }
            .quantity-label.positive {
                width: calc(100% - var(--counter-height));
            }

        </style>
        <div id="counter" class$="base [[custom]]">
            <div>
                <paper-icon-button class$="control-button right [[custom]]" icon="icons:remove" on-tap="decrease"></paper-icon-button>
            </div>
            <div id="counter-label" class$="quantity-label [[custom]]">[[_format(quantity, unit)]]</div>
            <div>
                <paper-icon-button class$="control-button left [[custom]]" icon="icons:add" on-tap="increase"></paper-icon-button>
            </div>
            <div>
                <paper-icon-button class$="control-button left [[custom]]" icon="icons:more-vert" on-tap="_divide"></paper-icon-button>
            </div>
        </div>
    </template>
    <script>

        class HtRegimenItem extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-regimen-item';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    unit: {
                        type: Number,
                        value: 0
                    },
                    custom: {
                        type: String,
                        value: 'normal'
                    },
                    quantity: {
                        type: String,
                        value: "",
                        notify: true
                    },
                    mouseIsDown: {
                        type: Boolean,
                        value: false
                    },
                    resetTimer: {
                        type: Object,
                        value: null
                    }
                };
            }

            static get observers() {
                return [
                    "_quantityChanged(quantity)"
                ];
            }

            static get units() {
                return [ 1.00, 0.50, 0.33, 0.25 ];
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
                const counter = this.$['counter-label'];
                if (!counter) return;
                counter.addEventListener('mousedown', this.mouseDown.bind(this), false);
                counter.addEventListener('mouseup', this.mouseUp.bind(this), false);
            }

            reset() {
                if (!this.mouseIsDown) return;
                this.set("quantity", 0);
                this.mouseIsDown = false;
            }

            _getUnit() {
                return HtRegimenItem.units[this.unit];
            }

            _getValue() {
                return Math.floor((parseFloat(this.quantity) || 0) / this._getUnit());
            }

            _setValue(value) {
                this.innerCall = true;
                this.set("quantity", this.unit != 2 ?
                    value * this._getUnit() :
                    Math.round((Math.floor(value / 3) + ((value % 3) * 0.33)) * 100) / 100);
            }

            _format() {
                const unit = this.unit + 1;
                const value = this._getValue().toString();
                return unit > 1 ? value + "/" + unit.toString() : value;
            }

            _divide() {
                const value = this._getValue();
                this.set("unit", (this.unit + 1) % 4);
                this._setValue(value);
            }

            decrease() {
                this._setValue(this._getValue() - 1);
            }

            increase() {
                this._setValue(this._getValue() + 1);
            }

            mouseDown(e) {
                console.log("mouseDown");
                if (this.resetTimer) {
                    clearTimeout(this.resetTimer);
                    this.resetTimer = null;
                }
                if (!this.mouseIsDown) {
                    this.mouseIsDown = true;
                    this.resetTimer = setTimeout(this.reset.bind(this), 500);
                }
            }

            mouseUp(e) {
                console.log("mouseUp");
                if (this.mouseIsDown) {
                    this.increase();
                    this.mouseIsDown = false;
                }
            }

            _quantityChanged() {
                console.log("_quantityChanged: " + this.quantity);
                this.set("custom", this.quantity && "positive" || "");
                if (!this.innerCall) {
                    const decimals = (this.quantity * 100) % 100;
                    if (decimals == 50) this.unit = 1;
                    else if (decimals == 33 || decimals == 66) this.unit = 2;
                    else if (decimals == 25 || decimals == 75) this.unit = 3;
                    else this.unit = 0;
                }
                this.innerCall = false;
            }
        }

        customElements.define(HtRegimenItem.is, HtRegimenItem);
    </script>
</dom-module>
