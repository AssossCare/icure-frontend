<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-style.html">

<dom-module id="ht-regimen-item">
    <template>

        <style include="buttons-style">
            .base {
                box-sizing: border-box;
                /*width: var(--counter-width);*/
                width: 100%;
                height: var(--counter-height);
                /*line-height: var(--counter-height);*/
                color: transparent;
                /*background: var(--app-background-color);*/
                background: var(--app-input-background-color);
                /*font-weight: 500;*/
                /*font-size: var(--font-size-normal);*/
                padding: 0;
                margin: 0;
                /*text-align: center;*/
                border-style: solid;
                /*border-color: var(--app-secondary-color-dark);*/
                border-color: var(--app-background-color-light);
                border-top-width: var(--counter-border-top-width);
                border-left-width: var(--counter-border-left-width);
                border-right-width: var(--counter-border-right-width);
                border-bottom-width: var(--counter-border-bottom-width);
                border-radius: var(--counter-border-radius);
                -webkit-user-select: none;

                display: flex;
            }

            .base:hover {
                background: rgba(255, 80, 0, .2);
            }

            .base:focus {
                background: rgba(221, 52, 21, .2);
            }


            .positive {
                background: var(--app-secondary-color);
                color: var(--app-text-color-light);
            }

            .positive:hover {
                background: var(--app-secondary-color-dark);
            }

            .positive:focus {
                background: var(--app-secondary-color-dark);
                color: #fafafa;
            }

            .decrease-button {
                --decrease-button-positive: {
                    height: calc(var(--counter-height) - 2px);
                    width: calc(var(--counter-height) - 2px);
                    background: var(--app-secondary-color);
                    color: var(--app-text-color-light);
                    padding: 4px;
                };

                --paper-icon-button: {
                    height: 0;
                    width: 0;
                    padding: 0;
                    margin: 0;
                };
            }
            .decrease-button.positive {
                --paper-icon-button: {
                    @apply --decrease-button-positive;
                };
            }
            .quantity-label {
                width: 100%;
                line-height: var(--counter-height);
                font-weight: 500;
                font-size: var(--font-size-normal);
                padding: 0;
                margin: 0;
                text-align: center;
                display: block;
                border-right-width: 0;
                border-right-style: solid;
                border-right-color: var(--app-secondary-color-dark);
            }
            .quantity-label.positive {
                width: calc(100% - var(--counter-height));
                border-right-width: 1px;
                border-radius: var(--counter-border-radius);
                border-bottom-right-radius: 0;
                border-top-right-radius: 0;
            }

        </style>
        <div id="counter" class$="base [[custom]]">
            <div id="counter-label" class$="quantity-label [[custom]]">[[quantity]]</div>
            <paper-icon-button class$="decrease-button [[custom]]" icon="icons:remove" on-tap="decrease"></paper-icon-button>
        </div>
    </template>
    <script>

        class HtRegimenItem extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-regimen-item';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    custom: {
                        type: String,
                        value: 'normal'
                    },
                    quantity: {
                        type: String,
                        value: "",
                        notify: true
                    },
                    mouseIsDown: {
                        type: Boolean,
                        value: false
                    },
                    resetTimer: {
                        type: Object,
                        value: null
                    },
                    quantityFactor: {
                        type: Object,
                        notify: true,
                        value: null
                    }
                };
            }

            static get observers() {
                return [
                    "_quantityChanged(quantity)"
                    // "_quantityFactorChanged(quantityFactor)"
                ];
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
                const counter = this.$['counter-label'];
                if (!counter) return;
                counter.addEventListener('mousedown', this.mouseDown.bind(this), false);
                counter.addEventListener('mouseup', this.mouseUp.bind(this), false);
            }

            reset() {
                if (this.mouseIsDown) {
                    this.set("quantity", 0);
                    this.mouseIsDown = false;
                }
            }

            decrease() {
                if (this.quantityFactor && this.quantityFactor.denominator > 1) {
                    this.set("quantity", 0);
                } else {
                    const quantityValue = parseInt(this.quantity) || 0;
                    if (quantityValue > 0) {
                        this.set("quantity", quantityValue - 1);
                    }
                }
            }

            mouseDown(e) {
                console.log("mouseDown");
                if (this.resetTimer) {
                    clearTimeout(this.resetTimer);
                    this.resetTimer = null;
                }
                if (!this.mouseIsDown) {
                    this.mouseIsDown = true;
                    this.resetTimer = setTimeout(this.reset.bind(this), 500);
                }
            }

            mouseUp(e) {
                console.log("mouseUp");
                if (this.mouseIsDown) {
                    if (this.quantityFactor && this.quantityFactor.denominator > 1) {
                        this.set("quantity", this.quantityFactor.numLabel);
                    } else {
                        const quantityValue = parseInt(this.quantity) || 0;
                        this.set("quantity", quantityValue + 1);
                    }
                    this.mouseIsDown = false;
                }
            }

            _quantityChanged() {
                console.log("_quantityChanged: " + this.quantity);
                this.set("custom", this.quantity && "positive" || "");
            }

            // _quantityFactorChanged() {
            //     if (this.quantity) {
            //         if (this.quantityFactor && this.quantityFactor.denominator > 1) {
            //             this.set("quantity", this.quantityFactor.numLabel);
            //         } else {
            //             this.set("quantity", parseInt(this.quantity) || 0);
            //         }
            //         this.dispatchEvent(new CustomEvent("quantity-changed", {detail: {}, bubbles: true, composed: true}))
            //     }
            // }
        }

        customElements.define(HtRegimenItem.is, HtRegimenItem);
    </script>
</dom-module>
