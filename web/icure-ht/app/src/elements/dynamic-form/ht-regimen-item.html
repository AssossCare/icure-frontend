<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-style.html">

<dom-module id="ht-regimen-item">
    <template>

        <style include="buttons-style">
            .base {
                box-sizing: border-box;
                width: 100%;
                height: var(--counter-height);
                color: transparent;
                /*background: var(--app-input-background-color);*/
                background: var(--app-background-color-dark);
                padding: 0;
                margin: 0;
                /*border-style: solid;*/
                /*border-color: var(--app-background-color-light);*/
                /*border-top-width: var(--counter-border-top-width);*/
                /*border-left-width: var(--counter-border-left-width);*/
                /*border-right-width: var(--counter-border-right-width);*/
                /*border-bottom-width: var(--counter-border-bottom-width);*/
                border-radius: var(--counter-border-radius);
                -webkit-user-select: none;

                display: flex;
            }

            .base:hover {
                background: rgba(255, 80, 0, .2);
            }

            .base:focus {
                background: rgba(221, 52, 21, .2);
            }

            .positive {
                background: var(--app-secondary-color);
                color: var(--app-text-color-light);
            }

            .positive:hover {
                background: var(--app-secondary-color-dark);
            }

            .positive:focus {
                background: var(--app-secondary-color-dark);
                color: #fafafa;
            }

            .control-button {
                --control-button-positive: {
                    height: var(--counter-height);
                    width: calc(var(--counter-height) - 4px);
                    background: var(--app-secondary-color);
                    color: var(--app-text-color-light);
                    padding: 2px;
                };

                --paper-icon-button: {
                    height: 0;
                    width: 0;
                    padding: 0;
                    margin: 0;
                };
            }
            .control-button.positive {
                --paper-icon-button: {
                    @apply --control-button-positive;
                };
            }
            .control-button.left {
                border-radius: var(--counter-border-radius);
                border-top-right-radius: 0;
                border-bottom-right-radius: 0;
            }
            .control-button.right {
                border-radius: var(--counter-border-radius);
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
            }

            .quantity-label {
                width: 100%;
                line-height: var(--counter-height);
                font-weight: 500;
                font-size: var(--font-size-normal);
                padding: 0;
                margin: 0;
                text-align: center;
                display: block;
                border-width: 0;
                /*border-right-width: 0;*/
                /*border-right-style: solid;*/
                /*border-right-color: var(--app-secondary-color-dark);*/
                /*border-left-width: 0;*/
                /*border-left-style: solid;*/
                /*border-left-color: var(--app-secondary-color-dark);*/
            }
            .quantity-label.positive {
                width: calc(100% - var(--counter-height));
                /*border-right-width: 1px;*/
                /*border-left-width: 1px;*/
            }

        </style>
        <div id="counter" class$="base [[custom]]">
            <div>
                <paper-icon-button class$="control-button right [[custom]]" icon="icons:remove" on-tap="decrease"></paper-icon-button>
            </div>
            <div id="counter-label" class$="quantity-label [[custom]]">[[_format(quantity)]]</div>
            <div>
                <paper-icon-button class$="control-button left [[custom]]" icon="icons:add" on-tap="increase"></paper-icon-button>
            </div>
            <div>
                <paper-icon-button class$="control-button left [[custom]]" icon="icons:more-vert" on-tap="_divide"></paper-icon-button>
            </div>
        </div>
    </template>
    <script>

        class HtRegimenItem extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-regimen-item';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    custom: {
                        type: String,
                        value: 'normal'
                    },
                    quantity: {
                        type: String,
                        value: "",
                        notify: true
                    },
                    mouseIsDown: {
                        type: Boolean,
                        value: false
                    },
                    resetTimer: {
                        type: Object,
                        value: null
                    },
                    quantityFactor: {
                        type: Object,
                        notify: true,
                        value: null
                    }
                };
            }

            static get observers() {
                return [
                    "_quantityChanged(quantity)"
                ];
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
                const counter = this.$['counter-label'];
                if (!counter) return;
                counter.addEventListener('mousedown', this.mouseDown.bind(this), false);
                counter.addEventListener('mouseup', this.mouseUp.bind(this), false);
            }

            reset() {
                if (this.mouseIsDown) {
                    this.set("quantity", 0);
                    this.mouseIsDown = false;
                }
            }

            _quantity() {
                return parseInt(this.quantity) || 0;
            }

            _quantityValue() {
                return this._quantity() % 1000;
            }

            _quantityUnit() {
                return Math.floor(this._quantity() / 1000);
            }

            _divide() {
                const value = this._quantityValue();
                const unit = this._quantityUnit() + 1;
                this.set("quantity", unit < 4 ? (unit * 1000) + value : value);
            }

            _format() {
                const value = this._quantityValue().toString();
                const unit = this._quantityUnit() + 1;
                return unit > 1 ? value + "/" + unit.toString() : value;
            }

            decrease() {
                if (this.quantityFactor && this.quantityFactor.denominator > 1) {
                    this.set("quantity", 0);
                } else {
                    const value = this._quantity();
                    this.set("quantity", value % 1000 > 1 ? value - 1 : 0);
                }
            }

            increase() {
                if (this.quantityFactor && this.quantityFactor.denominator > 1) {
                    this.set("quantity", this.quantityFactor.numLabel);
                } else {
                    const value = this._quantity();
                    this.set("quantity", value % 1000 < 999 ? value + 1 : 0);
                }
            }

            mouseDown(e) {
                console.log("mouseDown");
                if (this.resetTimer) {
                    clearTimeout(this.resetTimer);
                    this.resetTimer = null;
                }
                if (!this.mouseIsDown) {
                    this.mouseIsDown = true;
                    this.resetTimer = setTimeout(this.reset.bind(this), 500);
                }
            }

            mouseUp(e) {
                console.log("mouseUp");
                if (this.mouseIsDown) {
                    this.increase();
                    this.mouseIsDown = false;
                }
            }

            _quantityChanged() {
                console.log("_quantityChanged: " + this.quantity);
                this.set("custom", this.quantity && "positive" || "");
            }
        }

        customElements.define(HtRegimenItem.is, HtRegimenItem);
    </script>
</dom-module>
