<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-style.html">
<link rel="import" href="../../styles/paper-input-style.html">

<dom-module id="ht-regimen">
    <template>

        <style include="dialog-style buttons-style">
            .dose-tag {
                --dose-tag-text: {
                    font-weight: 500;
                    text-align: center;
                    font-size: var(--font-size-normal);
                    line-height: 24px;
                    padding: 0;
                    margin: 0;
                    display: block;
                    border-width: 0;
                };

                box-sizing: border-box;
                background: var(--app-input-background-color);
                color: var(--app-text-color-dark);
                height: 24px;
                padding: 0;
                margin-right: 8px;
                border-radius: 4px;
                border-width: 0;
                border-style: none;
                overflow: hidden;
                float: left;
                display: flex;
            }

            .time-label {
                @apply --dose-tag-text;
                padding: 0 16px;
                margin: 0;
            }

            .quantity-label {
                @apply --dose-tag-text;
                background: var(--app-secondary-color);
                color: var(--app-text-color-light);
                padding: 0 16px;
                margin: 0;
            }
            .quantity-label:hover {
                background: var(--app-secondary-color-dark);
            }
            .quantity-label:focus {
                background: var(--app-secondary-color-dark);
                color: #fafafa;
            }
            .quantity_label { grid-area: quantity_label; }

            .control-button {
                --paper-icon-button: {
                    height: 24px;
                    width: 20px;
                    background: var(--app-secondary-color);
                    color: var(--app-text-color-light);
                    padding: 2px;
                };
            }
            .control-button:hover {
                background: var(--app-secondary-color-dark);

            }
            .control-button:focus {
                background: var(--app-secondary-color-dark);
                color: #fafafa;
            }

            .grid-container {
                display: grid;
                grid-template-columns: auto auto auto auto auto;
                grid-template-rows: 24px;
                grid-template-areas: "time_tag button_decrease quantity_label button_increase button_divide";
            }

            .time_tag { grid-area: time_tag; }
            .button_decrease { grid-area: button_decrease; }
            .button_increase { grid-area: button_increase; }
            .button_divide { grid-area: button_divide; }

        </style>

        <div class="grid-container dose-tag">
            <div class="time_tag time-label">[[time]]</div>
            <div class="button_decrease">
                <paper-icon-button class="control-button" icon="icons:remove" on-tap="decrease"></paper-icon-button>
            </div>
            <div class="quantity_label quantity-label" on-tap="increase">[[_format(extra.*, unit)]]</div>
            <div class="button_increase">
                <paper-icon-button class="control-button" icon="icons:add" on-tap="increase"></paper-icon-button>
            </div>
            <div class="button_divide">
                <paper-icon-button class="control-button" icon="medication-svg-icons:[[getIcon(unit)]]" on-tap="_divide"></paper-icon-button>
            </div>
        </div>

    </template>
    <script>

        class HtRegimen extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-regimen';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    time: {
                        type: String
                    },
                    unit: {
                        type: Number,
                        value: 0
                    },
                    extra: {
                        type: Object,
                        value: () => {}
                    },
                    parts: {
                        type: Number,
                        value: 1
                    },
                    availableUnits: {
                        type: Array,
                        value: () => HtRegimen.units
                    }
                };
            }

            static get observers() {
                return [
                    "_extraChanged(extra)",
                    "_partsChanged(parts)"
                ];
            }

            static get units() {
                return [
                    {
                        size: 1.00,
                        icon: "one-full",
                        denominator: "1"
                    },
                    {
                        size: 0.50,
                        icon: "one-half",
                        denominator: "2"
                    },
                    {
                        size: 0.33,
                        icon: "one-third",
                        denominator: "3"
                    },
                    {
                        size: 0.25,
                        icon: "one-quarter",
                        denominator: "4"
                    }
                ]
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            _getUnit() {
                return this.availableUnits[this.unit].size;
            }

            _getDenominator() {
                return this.availableUnits[this.unit].denominator;
            }

            getIcon() {
                return this.availableUnits[this.unit].icon;
            }

            _getValue() {
                return Math.floor((parseFloat(this.extra.quantity) || 0) / this._getUnit());
            }

            _setValue(value) {
                this.innerCall = true;
                this.set("extra.quantity", this._getDenominator() === "3" ?
                    Math.round((Math.floor(value / 3) + ((value % 3) * 0.33)) * 100) / 100 :
                    value * this._getUnit());
            }

            _format() {
                const value = this._getValue().toString();
                return this.unit > 0 ? value + "/" + this._getDenominator() : value;
            }

            _divide() {
                const value = this._getValue();
                this.set("unit", (this.unit + 1) % this.availableUnits.length);
                this._setValue(value);
            }

            decrease() {
                this._setValue(this._getValue() - 1);
            }

            increase() {
                this._setValue(this._getValue() + 1);
            }

            _setUnitIndex(decimals) {
                let denominator;
                if (decimals == 50) denominator = "2";
                else if (decimals == 33 || decimals == 66) denominator = "3";
                else if (decimals == 25 || decimals == 75) denominator = "4";
                else denominator = "1";

                const unit = this.availableUnits.findIndex(availableUnit => availableUnit.denominator === denominator);
                this.unit = unit > -1 ? unit : 0;
            }

            _extraChanged() {
                console.log("extraChanged");
                this.set("time",
                    (Math.floor(this.extra.code / 10000) % 100).toString().padStart(2, '0') + ":" +
                    (Math.floor(this.extra.code / 100) % 100).toString().padStart(2, '0'));
                if (!this.innerCall) {
                    const decimals = (this.extra.quantity * 100) % 100;
                    this._setUnitIndex(decimals);
                }
                this.innerCall = false;
            }

            _partsChanged() {
                const availableUnitsCount = this.availableUnits.length;
                if (this.parts === 4) {
                    this.splice("availableUnits", 0, availableUnitsCount, HtRegimen.units[0], HtRegimen.units[1], HtRegimen.units[3]);
                }
                else if (this.parts > 1) {
                    this.splice("availableUnits", 0, availableUnitsCount, HtRegimen.units[0], HtRegimen.units[this.parts - 1]);
                } else if (availableUnitsCount !== HtRegimen.units.length) {
                    this.splice("availableUnits", 0, availableUnitsCount, ...HtRegimen.units);
                }
            }
        }

        customElements.define(HtRegimen.is, HtRegimen);
    </script>
</dom-module>
