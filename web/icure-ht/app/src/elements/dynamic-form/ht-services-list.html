
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">

<link rel="import" href="../dynamic-form/dynamic-form.html">

<dom-module id="ht-services-list">



    <template>



        <style>
            .form-title-bar-btn {
                height: 20px;
                width: 20px;
                padding: 2px;
            }
            .horizontal vaadin-date-picker {
                height: 90px;
                padding-bottom: 0px;
                @apply --padding-right-left-16
            }


            .link .ICD-10 span {
                content: '';
                display: inline-block;
                height: 6px;
                width: 6px;
                border-radius: 3px;
                margin-right: 3px;
                margin-bottom: 1px;
            }

            paper-listbox {
                min-width: 200px;
            }

            paper-menu-button {
                padding: 0;
            }

            vaadin-grid {
                /*height: unset;*/
				max-height:calc(100% - 104px);
                margin: 8px 0;
				box-shadow: var(--app-shadow-elevation-1);
				border: none;
                border-radius: 3px;
                overflow-y: auto;
                flex-grow: 1;
                margin-bottom: 46px;
			}

            span.outofrange-true {
                color: var(--app-status-color-nok);
            }

            .textContainer {
                margin:0 32px;
                box-shadow: var(--app-shadow-elevation-1);
            }

            .textContainer.fullWidth {
                margin:8px 0 0 0;
            }

            .margin032 {
                margin:0 32px!important;
            }

            .margin032.fullWidth {
                margin:8px 0 0 0!important;
            }

            .textContainer pre {
                font-family: var(--paper-font-common-base_-_font-family);
                -webkit-font-smoothing: var(--paper-font-common-base_-_-webkit-font-smoothing);
                font-size: 13px;
                line-height: 1.6em;
                max-height: none;
                overflow-x: hidden;
                overflow-y: hidden;
                word-break:normal;
                white-space: pre-wrap;
                white-space: -moz-pre-wrap;
                white-space: -pre-wrap;
                white-space: -o-pre-wrap;
                word-wrap: break-word;
                padding:10px;
                margin:0;
                background: #fff;
            }

            .actionIcons {
                min-width: 1px;
            }

            .documentHeader {
                color: var(--app-primary-color);
                background: var(--app-background-color-dark);
                font-size: 12px;
                margin: 0;
                padding: 0 10px;
                display: flex;
                flex-flow: row nowrap;
                text-align: left;
                justify-content: space-between;
                align-items: center;
            }

            .documentHeader >div {
                flex-grow: 0;
                min-width: 20px;
            }

        </style>



        <template is="dom-if" if="[[!_moreThan1Service(contacts,contacts.*)]]">

            <div class$="textContainer [[additionalCssClasses]]">
                <template is="dom-repeat" items="[[_services(contacts,contacts.*)]]" as="item">

                    <template is="dom-if" if="[[_any(printable,forwardable)]]">
                        <div class="documentHeader">
                            <span></span>
                            <div>
                                <template is="dom-if" if="[[_isContactLabResultOrProtocol(contacts)]]">
                                    <template is="dom-if" if="[[_documentId(contacts)]]">
                                        <paper-button on-tap="_triggerDownload" data-document-id$="[[_documentId(contacts)]]" class="actionIcons" id="downloadFile"><iron-icon icon="file-download"></iron-icon></paper-button>
                                        <paper-tooltip for="downloadFile" position="left">[[localize('dl','Download',language)]]</paper-tooltip>
                                    </template>
                                    <template is="dom-if" if="[[printable]]">
                                        <paper-button on-tap="_printDocument" data-contact-id$="[[_contactId(contacts)]]" class="actionIcons" id="printDocument"><iron-icon icon="print"></iron-icon></paper-button>
                                        <paper-tooltip for="printDocument" position="left">[[localize('pri','Print',language)]]</paper-tooltip>
                                    </template>
                                </template>
                                <template is="dom-if" if="[[forwardable]]">
                                    <template is="dom-if" if="[[_documentId(contacts)]]">
                                        <paper-button on-tap="_forwardDocument" data-document-id$="[[_documentId(contacts)]]" class="actionIcons" id="forwardDocument"><iron-icon icon="arrow-forward"></iron-icon><iron-icon icon="mail"></iron-icon></paper-button>
                                        <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                                    </template>
                                </template>
                            </div>
                        </div>
                    </template>

                    <pre>[[_prettifyText(item)]]</pre>

                </template>
            </div>

        </template>



        <template is="dom-if" if="[[_moreThan1Service(contacts,contacts.*)]]">

            <template is="dom-if" if="[[!_moreThan1Contact(contacts,contacts.*)]]">
                <template is="dom-if" if="[[_any(printable,forwardable)]]">
                    <div class$="documentHeader margin032 [[additionalCssClasses]]">
                        <span></span>
                        <div>
                            <template is="dom-if" if="[[_isContactLabResultOrProtocol(contacts)]]">
                                <template is="dom-if" if="[[_documentId(contacts)]]">
                                    <paper-button on-tap="_triggerDownload" data-document-id$="[[_documentId(contacts)]]" class="actionIcons" id="downloadFile"><iron-icon icon="file-download"></iron-icon></paper-button>
                                    <paper-tooltip for="downloadFile" position="left">[[localize('dl','Download',language)]]</paper-tooltip>
                                </template>
                                <template is="dom-if" if="[[printable]]">
                                    <paper-button on-tap="_printDocument" data-contact-id$="[[_contactId(contacts)]]" class="actionIcons" id="printDocument"><iron-icon icon="print"></iron-icon></paper-button>
                                    <paper-tooltip for="printDocument" position="left">[[localize('pri','Print',language)]]</paper-tooltip>
                                </template>
                            </template>
                            <template is="dom-if" if="[[forwardable]]">
                                <template is="dom-if" if="[[_documentId(contacts)]]">
                                    <paper-button on-tap="_forwardDocument" data-document-id$="[[_documentId(contacts)]]" class="actionIcons" id="forwardDocument"><iron-icon icon="arrow-forward"></iron-icon><iron-icon icon="mail"></iron-icon></paper-button>
                                    <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                                </template>
                            </template>
                        </div>
                    </div>
                </template>
            </template>

            <vaadin-grid id="dynamic-list" size="10" multi-sort="[[multiSort]]" active-item="{{activeItem}}" items="[[_services(contacts,contacts.*)]]" on-tap="click" class$="margin032 [[additionalCssClasses]]">
                    <vaadin-grid-column flex-grow="2" width="80px">
                        <template class="header">
                            <vaadin-grid-sorter path="label">[[localize('lab','Label',language)]]</vaadin-grid-sorter>
                        </template>
                        <template><span class$="outofrange-[[_isOutOfRange(item)]]">[[item.label]]</span></template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="1">
                        <template class="header">
                            <vaadin-grid-sorter path="modified">[[localize('dat','Date',language)]]</vaadin-grid-sorter>
                        </template>
                        <template>[[_date(item)]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="4">
                        <template class="header">
                            Value
                        </template>
                        <template><span class$="outofrange-[[_isOutOfRange(item)]]">[[_shortDescription(item)]]</span></template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="4">
                        <template class="header">
                            [[localize('nor_val','Normal values',language)]]
                        </template>
                        <template>[[_normalValues(item)]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column  flex-grow="2" width="80px">
                        <template class="header">
                            <vaadin-grid-sorter path="function{[[_author(item)]]}">[[localize('aut','Author',language)]]</vaadin-grid-sorter>
                        </template>
                        <template>[[_author(item)]]</template>
                    </vaadin-grid-column>
                </vaadin-grid>

        </template>



    </template>



    <script>



        class HtServicesList extends Polymer.TkLocalizerMixin(Polymer.Element) {

            static get is() {
                return 'ht-services-list';
            }

            static get properties() {
                return {
                    api: {
                        type: Object
                    },
                    user: {
                        type: Object
                    },
                    contact: {
                        type: Object,
                        value: null
                    },
                    contacts: {
                        type: Array,
                        value: []
                    },
                    activeItem: {
                        type: Object
                    },
                    currentContact: {
                        type: Object,
                        value: null
                    },
                    lastColumnSort: {
                        type: String,
                        value: null
                    },
                    forwardable: {
                        type: Boolean,
                        value: false
                    },
                    printable: {
                        type: Boolean,
                        value: false
                    },
                    additionalCssClasses: {
                        type: String,
                        value: ""
                    },
                    _downloadUrl: {
                        type: String,
                        value: ""
                    }
                };
            }

            constructor() {
                super();
            }

            ready() {
                super.ready()

                this._notifyResize()
            }

            _date(item) {
                return (item && item.modified) ? this.api.moment(item.modified).format(item.modified > 99991231 ? 'DD/MM/YYYY HH:mm' : 'DD/MM/YYYY') : '';
            }

            _author(item) {
                return this.api.getAuthor(item.author);
            }

            _isOutOfRange(svc) {
                const c = this.api.contact().preferredContent(svc, this.language)
                return (c && c.measureValue && (c.measureValue.value < c.measureValue.min || c.measureValue.value > c.measureValue.max ))
            }

            _normalValues(svc) {
                const c = this.api.contact().preferredContent(svc, this.language)
                return c && c.measureValue && `${c.measureValue.ref ? c.measureValue.ref.toFixed(2) : ''} ${c.measureValue.min || c.measureValue.max ? `${c.measureValue.min ? c.measureValue.min.toFixed(1) : '*'} - ${c.measureValue.max ? c.measureValue.max.toFixed(1) : '*'}` : ''}` || '';
            }

            _shortDescription(svc) {
                return this.api.contact().shortServiceDescription(svc, this.language);
            }

            _notifyResize() {
                const grid = this.$['dynamic-list']
                if (grid) {
                    grid.notifyResize()
                }
            }

            _moreThan1Contact(contacts) {
                return _.size(contacts) > 1
            }

            _prettifyText(input) {
                return _.trim(this._shortDescription(input)).replace(/\r\n|\n|\r/gm, "\n")
            }

            _contactId(input) {
                return _
                    .chain(input)
                    .filter(ctc => !!_.size(_.get(ctc,"services",[])))
                    .orderBy(["modified"],["asc"])
                    .head()
                    .get("id","")
                    .value()
            }

            _documentId(input) {
                return _
                    .chain(input)
                    .filter(ctc => !!_.size(_.get(ctc,"services",[])))
                    .orderBy(["modified"],["asc"])
                    .head()
                    .get("tags",[])
                    .find({type:"originalEhBoxDocumentId"})
                    .get("id","")
                    .trim()
                    .value()

                // _.trim(_.get(_.find(_.get(input,"[0].tags",[]), {type:"originalEhBoxDocumentId"}), "id",""))

            }

            _ehBoxMessageId(input) {
                return _
                    .chain(input)
                    .filter(ctc => !!_.size(_.get(ctc,"services",[])))
                    .orderBy(["modified"],["asc"])
                    .head()
                    .get("tags",[])
                    .find({type:"originalEhBoxMessageId"})
                    .get("id","")
                    .trim()
                    .value()
            }

            _forwardDocument(e) {
                const targetButton = _.find(_.get(e,"path",[]), nodePath=> _.trim(_.get(nodePath,"nodeName","")).toUpperCase() === "PAPER-BUTTON" )
                return !!targetButton ? this.dispatchEvent(new CustomEvent('forward-document', { composed: true, bubbles: true, detail: _.merge({source:_.trim(_.get(this,"nodeName","")).toLowerCase()},_.get(targetButton,"dataset",{})) })) : false;
            }

            _printDocument(e) {
                const targetButton = _.find(_.get(e,"path",[]), nodePath=> _.trim(_.get(nodePath,"nodeName","")).toUpperCase() === "PAPER-BUTTON" )
                return !!targetButton ? this.dispatchEvent(new CustomEvent('print-document', { composed: true, bubbles: true, detail: _.get(targetButton,"dataset",{}) })) : false;
            }

            _any(a,b,c,d,e) {
                return !!a||!!b||!!c||!!d||!!e
            }

            _triggerDownload(e) {

                const targetButton = _.find(_.get(e,"path",[]), nodePath=> _.trim(_.get(nodePath,"nodeName","")).toUpperCase() === "PAPER-BUTTON" )
                const documentId = _.trim(_.get(targetButton,"dataset.documentId",""))

                return !targetButton || !documentId ? false : this.api.document().getDocument(documentId)
                    .then(document => !_.size(_.get(document,"encryptionKeys",[])) && !_.size(_.get(document,"delegations",[])) ?
                        Promise.resolve([document,null]) :
                        this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(_.trim(_.get(this,"user.healthcarePartyId","")), _.trim(_.get(document,"id","")), _.size(_.get(document,"encryptionKeys",[])) ? _.get(document,"encryptionKeys",[]) : _.get(document,"delegations",[]))
                            .then(({extractedKeys: enckeys}) => ([document,enckeys]))
                            .catch(()=>Promise.resolve([document,null]))
                    )
                    .then(([document,enckeys]) => !_.size(document) ? false : this.api.triggerUrlDownload(this.api.document().getAttachmentUrl(_.trim(_.get(document,"id","")), _.trim(_.get(document,"attachmentId","")), enckeys, _.get(this,"api.sessionId"))))
                    .catch(()=>false)

            }

            _isSubContactLabResultOrProtocol(sctc) {

                // 1<<0 = Lab Result ; 1<<5 = Protocol
                return !!((parseInt(_.get(sctc, "status", 0)) & (1 << 0)) || (parseInt(_.get(sctc, "status", 0)) & (1 << 5)))

            }

            _isContactLabResultOrProtocol(contacts) {

                // 1<<0 = Lab Result ; 1<<5 = Protocol
                return !!_.some(contacts, ctc => !!_.some(_.get(ctc,"subContacts",[]), sctc => this._isSubContactLabResultOrProtocol(sctc)))

            }

            _getServicesOutOfContact(ctc) {

                const isLabResultOrProtocol = !!_.some(_.get(ctc,"subContacts",[]), sctc => this._isSubContactLabResultOrProtocol(sctc))
                return !isLabResultOrProtocol ? ctc.services : _.size(ctc.services) !== 2 ? ctc.services : _.filter(ctc.services, svc => _.trim(_.get(svc, "label","")).toLowerCase() !== "labresult" && _.trim(_.get(svc, "label","")).toLowerCase() !== "report" )

            }

            _moreThan1Service(contacts) {

                // return _.size(_.flatMap(contacts, c => c.services)) > 1
                return _.size(_.flatMap(contacts, ctc => this._getServicesOutOfContact(ctc))) > 1

            }

            _services(contacts) {

                // return _.sortBy(_.flatMap(contacts, c => c.services), ['modified']);
                return _.sortBy(_.flatMap(contacts, ctc => this._getServicesOutOfContact(ctc)),['modified'])

            }


        }



        customElements.define(HtServicesList.is, HtServicesList);



    </script>



</dom-module>
