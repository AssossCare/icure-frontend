
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">

<link rel="import" href="../dynamic-form/dynamic-form.html">

<dom-module id="ht-services-list">
    <template>



        <style>
            .form-title-bar-btn {
                height: 20px;
                width: 20px;
                padding: 2px;
            }
            .horizontal vaadin-date-picker {
                height: 90px;
                padding-bottom: 0px;
                @apply --padding-right-left-16
            }


            .link .ICD-10 span {
                content: '';
                display: inline-block;
                height: 6px;
                width: 6px;
                border-radius: 3px;
                margin-right: 3px;
                margin-bottom: 1px;
            }

            paper-listbox {
                min-width: 200px;
            }

            paper-menu-button {
                padding: 0;
            }

            vaadin-grid {
                /*height: unset;*/
				max-height:calc(100% - 104px);
                margin: 8px 0;
				box-shadow: var(--app-shadow-elevation-1);
				border: none;
                border-radius: 3px;
                overflow-y: auto;
                flex-grow: 1;
                margin-bottom: 46px;
			}

            span.outofrange-true {
                color: var(--app-status-color-nok);
            }

            .textContainer {
                margin:0 32px;
                box-shadow: var(--app-shadow-elevation-1);
            }

            .textContainer pre {
                font-family: var(--paper-font-common-base_-_font-family);
                -webkit-font-smoothing: var(--paper-font-common-base_-_-webkit-font-smoothing);
                font-size: 13px;
                line-height: 1.6em;
                max-height: none;
                overflow-x: hidden;
                overflow-y: hidden;
                word-break:normal;
                white-space: pre-wrap;
                white-space: -moz-pre-wrap;
                white-space: -pre-wrap;
                white-space: -o-pre-wrap;
                word-wrap: break-word;
                padding:10px;
                margin:0;
                background: #fff;
            }

            .actionIcons {
                min-width: 1px;
            }

            .documentHeader {
                color: var(--app-primary-color);
                background: var(--app-background-color-dark);
                font-size: 12px;
                margin: 0;
                padding: 0 10px;
                display: flex;
                flex-flow: row nowrap;
                text-align: left;
                justify-content: space-between;
                align-items: center;
            }

            .documentHeader >div {
                flex-grow: 0;
                min-width: 20px;
            }

        </style>



        <template is="dom-if" if="[[!_moreThan1(contacts,contacts.*)]]">

            <div class="textContainer">
                <template is="dom-repeat" items="[[_services(contacts,contacts.*)]]" as="item">

                    <div class="documentHeader">
                        <span></span>
                        <div>
                            <paper-button on-tap="_printDocument" data-contact-id$="[[_contactId(contacts)]]" data-document-id$="[[_documentId(contacts)]]" data-ehbox-message-id$="[[_ehBoxMessageId(contacts)]]" class="actionIcons" id="printDocument"><iron-icon icon="print"></iron-icon></paper-button>
                            <paper-tooltip for="printDocument" position="left">[[localize('pri','Print',language)]]</paper-tooltip>
                            <template is="dom-if" if="[[forwardable]]">
                                <paper-button on-tap="_forwardDocument" data-contact-id$="[[_contactId(contacts)]]" data-document-id$="[[_documentId(contacts)]]" data-ehbox-message-id$="[[_ehBoxMessageId(contacts)]]" class="actionIcons" id="forwardDocument"><iron-icon icon="arrow-forward"></iron-icon><iron-icon icon="mail"></iron-icon></paper-button>
                                <paper-tooltip for="forwardDocument" position="left">[[localize('forwardDocumentToColleague','Forward document to a colleague',language)]]</paper-tooltip>
                            </template>
                        </div>
                    </div>

                    <pre>[[_prettifyText(item)]]</pre>
                </template>
            </div>

        </template>



        <template is="dom-if" if="[[_moreThan1(contacts,contacts.*)]]">
            <vaadin-grid id="dynamic-list" size="10" multi-sort="[[multiSort]]" active-item="{{activeItem}}" items="[[_services(contacts,contacts.*)]]" on-tap="click">
                <vaadin-grid-column flex-grow="2" width="80px">
                    <template class="header">
                        <vaadin-grid-sorter path="label">[[localize('lab','Label',language)]]</vaadin-grid-sorter>
                    </template>
                    <template><span class$="outofrange-[[_isOutOfRange(item)]]">[[item.label]]</span></template>
                </vaadin-grid-column>
                <vaadin-grid-column flex-grow="1">
                    <template class="header">
                        <vaadin-grid-sorter path="modified">[[localize('dat','Date',language)]]</vaadin-grid-sorter>
                    </template>
                    <template>[[_date(item)]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column flex-grow="4">
                    <template class="header">
                        Value
                    </template>
                    <template><span class$="outofrange-[[_isOutOfRange(item)]]">[[_shortDescription(item)]]</span></template>
                </vaadin-grid-column>
                <vaadin-grid-column flex-grow="4">
                    <template class="header">
                        [[localize('nor_val','Normal values',language)]]
                    </template>
                    <template>[[_normalValues(item)]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column  flex-grow="2" width="80px">
                    <template class="header">
                        <vaadin-grid-sorter path="function{[[_author(item)]]}">[[localize('aut','Author',language)]]</vaadin-grid-sorter>
                    </template>
                    <template>[[_author(item)]]</template>
                </vaadin-grid-column>
            </vaadin-grid>
        </template>

    </template>



    <script>

class HtServicesList extends Polymer.TkLocalizerMixin(Polymer.Element) {
    static get is() {
        return 'ht-services-list';
    }

    static get properties() {
        return {
            api: {
                type: Object
            },
            user: {
                type: Object
            },
            contact: {
                type: Object,
                value: null
            },
            contacts: {
                type: Array,
                value: []
            },
            activeItem: {
                type: Object
            },
            currentContact: {
                type: Object,
                value: null
            },
            lastColumnSort: {
                type: String,
                value: null
            },
            forwardable: {
                type: Boolean,
                value: false
            }
        };
    }

    constructor() {
        super();
    }

    ready() {
        super.ready()

        this._notifyResize()
    }

    _services(contacts) {
        return _.sortBy(_.flatMap(contacts, c => c.services), ['modified']);
    }

    _date(item) {
        return (item && item.modified) ? this.api.moment(item.modified).format(item.modified > 99991231 ? 'DD/MM/YYYY HH:mm' : 'DD/MM/YYYY') : '';
    }

    _author(item) {
        return this.api.getAuthor(item.author);
    }

    _isOutOfRange(svc) {
        const c = this.api.contact().preferredContent(svc, this.language)
        return (c && c.measureValue && (c.measureValue.value < c.measureValue.min || c.measureValue.value > c.measureValue.max ))
    }

    _normalValues(svc) {
        const c = this.api.contact().preferredContent(svc, this.language)
        return c && c.measureValue && `${c.measureValue.ref ? c.measureValue.ref.toFixed(2) : ''} ${c.measureValue.min || c.measureValue.max ? `${c.measureValue.min ? c.measureValue.min.toFixed(1) : '*'} - ${c.measureValue.max ? c.measureValue.max.toFixed(1) : '*'}` : ''}` || '';
    }

    _shortDescription(svc) {
        return this.api.contact().shortServiceDescription(svc, this.language);
    }

    _notifyResize() {
        const grid = this.$['dynamic-list']
        if (grid) {
            grid.notifyResize()
        }
    }

    _moreThan1(contacts) {
        return _.size(_.flatMap(contacts, c => c.services)) > 1
    }

    _prettifyText(input) {
        return _.trim(this._shortDescription(input))
            .replace(/\r\n|\n|\r/gm, "\n")
    }

    _contactId(input) {
        return _.get(input,"[0].id","")
    }

    _documentId(input) {
        return _.trim(_.get(_.find(_.get(input,"[0].tags",[]), {type:"originalEhBoxDocumentId"}), "id",""))
    }

    _ehBoxMessageId(input) {
        return _.trim(_.get(_.find(_.get(input,"[0].tags",[]), {type:"originalEhBoxMessageId"}), "id",""))
    }

    _forwardDocument(e) {
        const targetButton = _.find(_.get(e,"path",[]), nodePath=> _.trim(_.get(nodePath,"nodeName","")).toUpperCase() === "PAPER-BUTTON" )
        return !!targetButton ? this.dispatchEvent(new CustomEvent('forward-document', { composed: true, bubbles: true, detail: _.merge({source:_.trim(_.get(this,"nodeName","")).toLowerCase()},_.get(targetButton,"dataset",{})) })) : false;
    }

    _printDocument(e) {
        const targetButton = _.find(_.get(e,"path",[]), nodePath=> _.trim(_.get(nodePath,"nodeName","")).toUpperCase() === "PAPER-BUTTON" )
        return !!targetButton ? this.dispatchEvent(new CustomEvent('print-document', { composed: true, bubbles: true, detail: _.merge({source:_.trim(_.get(this,"nodeName","")).toLowerCase()},_.get(targetButton,"dataset",{})) })) : false;
    }

}

customElements.define(HtServicesList.is, HtServicesList);
</script>
</dom-module>
