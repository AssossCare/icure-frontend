<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../../bower_components/paper-toggle-button/paper-toggle-button.html">


<dom-module id="ht-admin-account-procedures">

    <template>

        <style include="shared-styles">

            .procedures-panel{
                width: 100%;
                height: 100%;
                padding: 0 24px;
                box-sizing: border-box;
            }

            #packageDialog{
                height: calc(98% - 12vh);
                width: 98%;
                max-height: calc(100% - 64px - 48px - 20px); /* 100% - header - margin - footer*/
                min-height: 400px;
                min-width: 800px;
                top: 64px;
            }

            .package-container{
                display: flex;
                height: calc(100% - 45px);
                width: auto;
                margin: 0;
                padding: 0;
            }

            .package-list-container{
                height: 100%;
                width: 30%;
                background-color: var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
                overflow: auto;
                position: relative;
            }

            .package-search-container{
                height: 100%;
                width: 70%;
                border-bottom: 1px solid var(--app-background-color-darker);
            }

            .package-list-title{
                height: 48px;
                width: 100%;
                border-bottom: 1px solid var(--app-background-color-darker);
                background-color: var(--app-background-color-dark);
                padding: 0 12px;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                box-sizing: border-box;
            }

            .package-search-title{
                height: 46px;
                width: 100%;
                background-color: var(--app-secondary-color);
                border-bottom: 2px solid black;
            }

            .package-search-title-content{
                padding: 12px;
                text-align: center;
                width: auto;
                font-weight: bold;
            }

            .buttons{
                position: absolute;
                right: 0;
                bottom: 0;
                margin: 0;
            }

            .title-icon{
                height: 16px;
                width: 16px;
            }

            .package-search-block{
                height: calc(100% - 48px);
                width: 100%;
            }

            .package-search{
                height: 60px;
                width: 100%;
                display: flex;
            }

            .package-search-result{
                height: calc(100% - 60px);
                width: 100%;
            }

            .pad-6{
                padding: 6px;
            }

            .mar-10{
                margin: 10px;
            }

            .addIcon{
                height: 14px;
                width: 14px;
                background-color: var(--app-secondary-color);
                border-radius: 50%;
                padding: 2px;
            }

            .package-list-of-procedure{
                height: calc(100% - 60px);
                width: 100%;
            }

            .procedure-container{
                border: 1px solid var(--app-background-color-darker);
                margin: 8px;
                height: 60px;
                width: auto;
                box-shadow: var(--app-shadow-elevation-1);
            }

            .procedure-title{
                height: 20px;
                width: auto;
                padding: 4px;
                background-color: var(--app-background-color-darker);
            }

            .procedure-description{
                height: 24px;
                padding: 4px;
                width: auto;
                background-color: var(--app-background-color-light);
            }

            .trashIcon{
                height: 14px;
                width: 14px;
                float: right;
            }

            #procedureList{
                height: calc(100% - 60px);
                width: auto;
            }

            .w-70{
                width: 80%;
            }

            .w-30{
                width: 20%;
            }

            .p-30{
                padding: 30px;
            }

            .packageTitle{
                width: 100%;
                margin-top: -9px;
            }

            paper-toggle-button.status{
                --paper-toggle-button-checked-bar-color:  var(--paper-green-500);
                --paper-toggle-button-checked-button-color:  var(--paper-green-500);
                --paper-toggle-button-checked-ink-color: var(--paper-green-500);
                --paper-toggle-button-unchecked-bar-color:  var(--paper-red-900);
                --paper-toggle-button-unchecked-button-color:  var(--paper-red-900);
                --paper-toggle-button-unchecked-ink-color: var(--paper-red-900);
            }

        </style>


        <div class="procedures-panel">
            <h4 class="section-title">[[localize('my_pro', 'My profil', language)]] - [[localize('my-proc', 'My procedures', language)]]</h4>
            <div class="">
                <h4>[[localize('adm-pack-avai', 'Available package', language)]] <paper-icon-button class="add-btn" icon="icons:add-circle" on-tap="_openPackageDialog"></paper-icon-button></h4>

                <vaadin-grid id="packageList" class="material pad-6 mar-10" items="[[listOfPackage]]" active-item="{{selectedPackage}}">
                    <vaadin-grid-column>
                        <template class="header">
                            [[localize('adm-pack-name','Package name',language)]]
                        </template>
                        <template>
                            [[_localizeLabel(item.label)]]
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">
                            [[localize('adm-pack-nb-proc','Number of procedure',language)]]
                        </template>
                        <template>
                            [[_getNumberOfProcedure(item.links)]]
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">
                            [[localize('adm-pack-dept','Type',language)]]
                        </template>
                        <template>
                            <template is="dom-repeat" items="[[item.flags]]" as="flag">
                                <div>[[_localizeType(flag)]]</div>
                            </template>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">
                            [[localize('status','Status',language)]]
                        </template>
                        <template>
                            <paper-toggle-button class="status" id="[[item.id]]" on-change="_toggleStatusChanged"></paper-toggle-button>
                        </template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </div>
        </div>

        <paper-dialog id="packageDialog">
            <div class="package-container">
                <div class="package-list-container">
                    <div class="package-list-title">
                        <paper-input class="packageTitle" value="{{selectedPackageInfo.packageName}}" label="[[localize('adm-pack-name', 'Package name', language)]]"></paper-input>
                    </div>
                    <div class="package-list-of-procedure">
                        <template is="dom-repeat" items="[[selectedPackageInfo.listOfProcedures]]">
                            <div class="procedure-container">
                                <div class="procedure-title">
                                    [[_localizeLabel(item.label)]]
                                    <iron-icon icon="vaadin:trash" class="trashIcon" on-tap="_deleteProcedureFromPackage" data-item-procedure$="[[item]]"></iron-icon>
                                </div>
                                <div class="procedure-description">

                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                <div class="package-search-container">
                    <div class="package-search-title">
                        <div class="package-search-title-content">
                            <iron-icon icon="vaadin:search" class="title-icon"></iron-icon> [[localize('adm-pack-proc-search', 'Search procedure', language)]]
                        </div>
                    </div>
                    <div class="package-search-block">
                        <div class="package-search">
                            <paper-input label="[[localize('adm-pack-search', 'Search', language)]]" value="{{procedureFilter}}" class="pad-6 w-70"></paper-input> <paper-checkbox class="w-30 p-30" on-change="_allDepartementCheckChanged" value="{{allDepartmentChecked}}">[[localize('adm-pack-all-dept', 'All departments', language)]]</paper-checkbox>
                        </div>
                        <div class="package-search-result">
                            <vaadin-grid id="procedureList" class="material pad-6 mar-10" items="[[displayedResultOfSearch]]">
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('adm-pack-code','Code',language)]]
                                    </template>
                                    <template>
                                        <iron-icon icon="vaadin:plus" class="addIcon" on-tap="_addProcedureToPackage" data-item-procedure$="[[item]]"></iron-icon>
                                        [[item.code]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('adm-pack-proc','Procedure',language)]]
                                    </template>
                                    <template>
                                        [[_localizeLabel(item.label)]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('adm-pack-dept','Departement',language)]]
                                    </template>
                                    <template>
                                        <template is="dom-repeat" items="[[item.flags]]" as="flag">
                                            <div>[[_localizeType(flag)]]</div>
                                        </template>
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid>
                        </div>
                    </div>
                </div>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" on-tap="_closePackageDialog"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                <paper-button class="modal-button" on-tap="_savePackage"><iron-icon icon="icons:save" class="mr5 smallIcon" ></iron-icon> [[localize('save','Save',language)]]</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models';

        class HtAdminAccountProcedures extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-admin-account-procedures'
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        noReset: true
                    },
                    hcp:{
                        type: Object,
                        value: () => {}
                    },
                    listOfPackage: {
                        type: Object,
                        value: () => []
                    },
                    selectedPackage:{
                        type: Object,
                        value: () => {}
                    },
                    selectedPackageInfo:{
                        type: Object,
                        value: () => ({
                            packageName: null,
                            listOfProcedures: []
                        })
                    },
                    procedureFilter:{
                        type: String,
                        value: null
                    },
                    searchResult:{
                        type: Array,
                        value: () => []
                    },
                    allDepartmentChecked:{
                        type: Boolean,
                        value: false
                    },
                    displayedResultOfSearch:{
                        type: Array,
                        value: () => []
                    }
                }
            }

            static get observers() {
                return ['_initialize(api, user)', '_selectedPackageChanged(selectedPackage)', '_procedureFilterChanged(procedureFilter)'];
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
            }

            _initialize(){
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId)
                    .then(hcp => this.set('hcp', hcp))
                    .then(() => this.api.code().findPaginatedCodes('be', 'care.topaz.procedurepackage', '', null, null, 100))
                    .then(listOfPackage => {
                        this.set('listOfPackage', listOfPackage.rows)
                    })
            }

            _localizeLabel(label){
                return label[this.language] || null
            }

            _selectedPackageChanged(){
                if(this.selectedPackage){
                    (_.get(this.selectedPackage, 'links', null) ? this.api.code().getCodes(this.selectedPackage.links.join(",")) : Promise.resolve([]))
                        .then(listOfProcedures => {
                            this.set('selectedPackageInfo', {
                                packageName: _.get(this.selectedPackage, 'label['+this.language+']', null),
                                listOfProcedures: listOfProcedures
                            })
                        }).finally(() => {
                            this._openPackageDialog()
                        })
                }
            }

            _addProcedureToPackage(e){
                if(_.get(e, 'target.dataset.itemProcedure', null)){
                    const data = JSON.parse(_.get(e, 'target.dataset.itemProcedure', ''))
                    !this.selectedPackageInfo.listOfProcedures.find(proc => proc.id === data.id) ? this.push('selectedPackageInfo.listOfProcedures', data) : null
                }
            }

            _deleteProcedureFromPackage(e){
                if(_.get(e, 'target.dataset.itemProcedure', null)){
                    const data = JSON.parse(_.get(e, 'target.dataset.itemProcedure', ''))
                    this.splice('selectedPackageInfo.listOfProcedures', _.indexOf(this.selectedPackageInfo.listOfProcedures, this.selectedPackageInfo.listOfProcedures.find(proc => proc.id === data.id)), 1)
                }
            }

            _openPackageDialog(){
                this.$['packageDialog'].open()
            }

            _closePackageDialog(){
                this.set('procedureFilter', null)
                this.set('displayedResultOfSearch', [])
                this.set('searchResult', [])
                this.set('selectedPackageInfo', { packageName: null, listOfProcedures: []})
                this.$['packageDialog'].close()
            }

            _procedureFilterChanged(){
                if(this.procedureFilter && _.trim(this.procedureFilter).length > 2){
                    this.set('displayedResultOfSearch', [])
                    setTimeout(() => {
                        this.api.code().findPaginatedCodesByLabel('be', 'BE-THESAURUS-PROCEDURES', 'fr', this.procedureFilter, null, null, 1000)
                            .then(listOfProc => {
                                this.set('searchResult', listOfProc.rows)
                            })
                            .finally(() => {
                                this.set('displayedResultOfSearch', [])
                                if(this.allDepartmentChecked === true){
                                    this.set('displayedResultOfSearch', this.searchResult)
                                }else{
                                    this.searchResult.map(proc => {
                                        _.get(proc,'flags', []).find(flag => flag === _.get(this.hcp, 'specialityCodes[0].code', 'deptgeneralpractice')) ? this.displayedResultOfSearch.push(proc) : null
                                    })
                                }
                                this.set('displayedResultOfSearch', _.orderBy(this.displayedResultOfSearch, '[label['+this.language+']]', '[asc]'))
                                this.$['procedureList'].clearCache()
                            })
                    }, 300)
                }
            }

            _allDepartementCheckChanged(e){
                this.set('displayedResultOfSearch', [])
                if(e.target.checked){
                    this.set('allDepartmentChecked', true)
                    this.set('displayedResultOfSearch', this.searchResult)
                }else{
                    this.set('allDepartmentChecked', false)
                    this.searchResult.map(proc => {
                        _.get(proc,'flags', []).find(flag => flag === _.get(this.hcp, 'specialityCodes[0].code', 'deptgeneralpractice')) ? this.displayedResultOfSearch.push(proc) : null
                    })
                }
                this.set('displayedResultOfSearch', _.orderBy(this.displayedResultOfSearch, '[label['+this.language+']]', '[asc]'))
                this.$['procedureList'].clearCache()
            }

            _savePackage(){
                if(this.selectedPackage && this.selectedPackage.id){
                    const newPackage = _.cloneDeep(this.selectedPackage)
                    newPackage.links = this.selectedPackageInfo.listOfProcedures.map(proc => proc.id)
                    newPackage.label =  {[this.language]: this.selectedPackageInfo.packageName}
                    this.api.code().modifyCode(newPackage)
                        .then(pack => this.api.register(pack, 'selectedPackage'))
                        .then(pack => {
                            this.splice('listOfPackage', _.indexOf(this.listOfPackage.find(p => p.id === pack.id)), 1)
                            this.push('listOfPackage', pack)
                        })
                        .finally(() => {
                            this.$['procedureList'].clearCache()
                            this._closePackageDialog()
                        })
                }else{
                    const uuid = this.api.crypto().randomUuid()
                    this.api.code().createCode({
                        id: 'care.topaz.procedurepackage|'+uuid+'|1',
                        code: uuid,
                        type: 'care.topaz.procedurepackage',
                        version: 1,
                        level: 1,
                        links: this.selectedPackageInfo.listOfProcedures.map(proc => proc.id),
                        flags: this.hcp.specialityCodes.map(spec => spec.code),
                        regions: ["be", "fr"],
                        label: {[this.language]: this.selectedPackageInfo.packageName},
                        author: this.user.id
                    })
                    .then(pack => this.api.register(pack, 'selectedPackage'))
                    .then(pack => {
                        this.push('listOfPackage', pack)
                    })
                    .finally(() => {
                        this.$['procedureList'].clearCache()
                        this._closePackageDialog()
                    })
                }
            }

            _getNumberOfProcedure(links){
                return links && links.length || null
            }

            _localizeType(flag){
                if(this.allDepartmentChecked === true){
                    return this.localize('cd-hcp-'+flag, flag, this.language)
                }else{
                    return flag && flag === _.get(this.hcp, 'specialityCodes[0].code', 'deptgeneralpractice') ? this.localize('cd-hcp-'+flag, flag, this.language) : null
                }
            }

            _toggleStatusChanged(e){
                e.stopPropagation()
                if(e.target.id && e.target.checked){
                    console.log(e.target.id)
                    //todo see if code can be disabled
                }
            }

        }

        customElements.define(HtAdminAccountProcedures.is, HtAdminAccountProcedures)
    </script>
</dom-module>
