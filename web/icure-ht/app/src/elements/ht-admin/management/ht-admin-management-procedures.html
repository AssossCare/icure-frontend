<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../styles/paper-input-style.html">
<link rel="import" href="./dialogs/ht-admin-management-procedures-dialog.html">

<dom-module id="ht-admin-management-procedures">

    <template>

        <style include="shared-styles">
            :host {
                display: block;
                height: 100%;
            }

            :host *:focus{
                outline:0!important;
            }

            .panel-title {
                margin-bottom: 0;
            }

            .procedures-panel {
                height: 100%;
                width: 100%;
                padding: 0 20px;
                box-sizing: border-box;
                position:relative;

                display: flex;
                flex-direction: column;
            }

            .procedures-panel .panel-content {
                padding: 0 12px;
                overflow: hidden;
                border-bottom: 1px solid var(--app-background-color-dark);
                box-sizing: border-box;
                overflow-y: auto;
            }

            .grid {
                min-height: 0;
            }

            .grids-section {
                display: flex;
                flex-direction: column;
                flex: 1;
            }

            .line {
                display: flex;
            }

            paper-toggle-button.status{
                --paper-toggle-button-checked-bar-color:  var(--paper-green-500);
                --paper-toggle-button-checked-button-color:  var(--paper-green-500);
                --paper-toggle-button-checked-ink-color: var(--paper-green-500);
                --paper-toggle-button-unchecked-bar-color:  var(--paper-red-900);
                --paper-toggle-button-unchecked-button-color:  var(--paper-red-900);
                --paper-toggle-button-unchecked-ink-color: var(--paper-red-900);
            }

            .procedures-list{
                height: calc(100% - 50px);
                width: 100%;
            }

            div.bottom-commands {
                display: flex;
                width: 100%;
                justify-content: flex-end;
                align-items: center;
            }

            div.bottom-commands > div.grid-size-indicator {
                max-width: 208px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
                color: var(--app-text-color);
                font-size: 13px;
                font-weight: 400;
                letter-spacing: 0.3px;
            }

            paper-icon-button.change-page {
                cursor: pointer;
                width: 24px;
                height: 24px;
                min-width: 0;
                padding: 2px;
                color: var(--app-text-color);
                margin:0 4px;
            }

            .scroll-top {
                background: var(--app-secondary-color);
                padding: 0 4px;
                height: 24px;
                width: 24px;
                box-sizing: border-box;
                border-radius: 50%;
            }

            #vaadinProceduresGrid{
                height: calc(100% - 130px);
                width: 100%;
            }

        </style>

        <div class="procedures-panel">
            <h4 class="panel-title">[[localize('man_procs', 'Management - Procedures', language)]]</h4>
            <div class="procedures-list">
                <div>
                    <paper-input class="m0 mr10" value="{{procedureFilter}}" label="[[localize('search','Search',language)]]:"></paper-input>
                </div>
                <vaadin-grid id="vaadinProceduresGrid" class="material" width="100%" items="[[vaadinGridDataToShow]]" active-item="{{selectedProcedure}}" pageSize="[[_vaadinGridMaxItemsPerPage]]" on-selected-items-changed="_gridSelectedItemsChanged">
                    <vaadin-grid-column>
                        <template class="header"><vaadin-grid-sorter path="code">[[localize('code','Code',language)]]</vaadin-grid-sorter></template>
                        <template><div>[[item.code]]</div></template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="2">
                        <template class="header"><vaadin-grid-sorter path="proc">[[localize('proc','Procedures',language)]]</vaadin-grid-sorter></template>
                        <template><div>[[_getLabel(item.label)]]</div></template>
                    </vaadin-grid-column>
                    <vaadin-grid-column flex-grow="1">
                        <template class="header">[[localize('adm-pack-dept','Departement',language)]]</template>
                            <template>
                                <template is="dom-repeat" items="[[item.flags]]" as="flag">
                                    <div>[[_localizeType(flag)]]</div>
                                </template>
                        </template>
                    </vaadin-grid-column>
                </vaadin-grid>

                <div class="bottom-commands">
                    <div class="grid-size-indicator hideOnMobile"> [[pageStart]] â€“ [[pageEnd]] [[localize('sur','sur',language)]] [[totalProceduresForCurrentFolderAndCurrentFilter]]</div>
                    <paper-icon-button id="previous-page-change" icon="chevron-left"class="change-page" on-tap="_gotoPreviousGridPage"></paper-icon-button>
                    <paper-icon-button id="next-page-change" icon="chevron-right" class="change-page" on-tap="_gotoNextGridPage"></paper-icon-button>
                    <div class="hideOnMobile"><paper-icon-button id="scrolltop" class="scroll-top" icon="arrow-upward" on-tap="_scrollToTop"></paper-icon-button></div>
                </div>
            </div>
        </div>

        <ht-admin-management-procedures-dialog id="htAdminManagementProceduresDialog" selected-procedure="[[selectedProcedure]]" user="[[user]]" api="[[api]]" i18n="[[i18n]]" language="[[language]]" resources="[[resources]]" on-refresh-proc-list="_refreshProcList"></ht-admin-management-procedures-dialog>
    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';

        class HtAdminManagementProcedures extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-admin-management-procedures'
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        noReset: true
                    },
                    currentPageNumber: {
                        type: Number,
                        value: 1
                    },
                    vaadinGridDataToShow:{
                        type: Array,
                        value: () => []
                    },
                    selectedProcedure: {
                        type: Object,
                        value: null
                    },
                    pageStart: {
                        type: Number,
                        value: 0
                    },
                    pageEnd: {
                        type: Number,
                        value: 250
                    },
                    vaadinGridMaxItemsPerPage: {
                        type: Number,
                        value: 250
                    },
                    allProcedures:{
                        type: Array,
                        value: () => []
                    },
                    totalPagesForCurrentFolderAndCurrentFilter:{
                        type: Number,
                        value: 0
                    },
                    totalProceduresForCurrentFolderAndCurrentFilter:{
                        type: Number,
                        value: 0
                    },
                    procedureFilter:{
                        type: String,
                        value: null
                    }

                }
            }

            static get observers() {
                return ['_proceduresDataProvider(user, api)', '_currentPageChanged(currentPageNumber)', '_selectedProcedureChanged(selectedProcedure)', '_procedureFilterChanged(procedureFilter)'];
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
            }

            _proceduresDataProvider(){

                this.api.code().findPaginatedCodes('be', 'BE-THESAURUS-PROCEDURES', '', '', '', 3000)
                    .then(proc =>  Promise.all([proc, this.api.code().findPaginatedCodesByLabel('be', 'CD-HCPARTY', this.language, 'dept', null, null, 200)]))
                    .then(([proc, listOfCdHcParty]) => {
                        this.set('allProcedures', proc.rows.map(proc =>
                            _.assign(proc, {
                                normalizedSearchTerms: _.map(_.uniq(_.compact(_.flatten(_.concat([_.get(proc, _.trim('label.'+this.language), ""), _.get(proc, 'code', ""), _.get(proc, 'searchTerms.'+this.language, ""), _.compact(_.get(proc, 'flags', []).map(flag => _.get(listOfCdHcParty.rows.find(hcp => hcp.code === flag), 'label.'+this.language, "")))])))), i =>  _.trim(i).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "")).join(" ")
                            })
                        ))
                        this.set('totalPagesForCurrentFolderAndCurrentFilter', parseInt(proc.rows.length / this.vaadinGridMaxItemsPerPage))
                        this.set('vaadinGridDataToShow', _.sortBy(_.get(_.chunk(proc.rows, this.vaadinGridMaxItemsPerPage), 0), ['code', 'label.'+this.language, 'id'], ['asc', 'asc', 'asc']))
                        this.set('totalProceduresForCurrentFolderAndCurrentFilter', _.size(proc.rows))
                    })
            }

            _currentPageChanged(){
                this.set('vaadinGridDataToShow', _.sortBy(_.get(_.chunk(this.allProcedures, this.vaadinGridMaxItemsPerPage), parseInt(this.currentPageNumber - 1)), ['code', 'label.'+this.language], ['asc', 'asc']))
                this.set('pageStart', parseInt((this.currentPageNumber - 1) * this.vaadinGridMaxItemsPerPage))
                this.set('pageEnd', parseInt(this.currentPageNumber * this.vaadinGridMaxItemsPerPage))

            }

            _gotoPreviousGridPage() {
               parseInt(_.get(this,"currentPageNumber",1)) > 1  ? this.set( 'currentPageNumber',( parseInt(_.get(this,"currentPageNumber",2)) - 1 )) : null
            }

            _gotoNextGridPage() {
               parseInt(_.get(this,"currentPageNumber",1)) <= parseInt(_.get(this,"totalPagesForCurrentFolderAndCurrentFilter",1))  ?  this.set('currentPageNumber', ( parseInt(_.get(this,"currentPageNumber",1)) + 1 )) : null
            }

            _getLabel(label){
                return label[this.language]
            }

            _localizeType(flag){
                return this.localize('cd-hcp-'+flag, flag, this.language)
            }

            _selectedProcedureChanged(){
                if(this.selectedProcedure){
                    console.log(this.selectedProcedure)
                    this.$['htAdminManagementProceduresDialog']._openProcedureDialog()
                }
            }

            _refreshProcList(e){
                console.log(e)
                this.splice('allProcedures', _.indexOf(this.allProcedures, this.allProcedures.find(f => f.id === e.detail.procedure.id)), 1)
                this.push('allProcedures', e.detail.procedure)
                if(this.vaadinGridDataToShow.find(f => f.id === e.detail.procedure.id)){
                    this.splice('vaadinGridDataToShow', _.indexOf(this.vaadinGridDataToShow, this.vaadinGridDataToShow.find(f => f.id === e.detail.procedure.id)), 1)
                    this.push('vaadinGridDataToShow', e.detail.procedure)
                    this.set('vaadinGridDataToShow', _.sortBy(this.allProcedures, ['code', 'label.'+this.language, 'id'], ['asc', 'asc', 'asc']))
                }
                this.$['vaadinProceduresGrid'].clearCache()
                this.$['htAdminManagementProceduresDialog']._closeFormDialog()
            }

            _procedureFilterChanged(){
                if(this.procedureFilter){
                    const keywordsString = _.trim(_.get(this,"procedureFilter","")).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "")
                    const keywordsArray = _.compact(_.uniq(_.map(keywordsString.split(" "), i=>_.trim(i))))

                    setTimeout(() => {
                        if(parseInt(_.get(keywordsString,"length",0)) > 2) {
                            const proceduresSearchResults =  _.chain(_.get(this, "allProcedures", []))
                                .chain(_.get(this, "procedureFilter", []))
                                .filter(i => _.size(keywordsArray) === _.size(_.compact(_.map(keywordsArray, keyword => _.trim(_.get(i, "normalizedSearchTerms", "")).indexOf(keyword) > -1))))
                                .compact()
                                .uniq()
                                .orderBy(['code', 'label.' + this.language, 'id'], ['asc', 'asc', 'asc'])
                                .value()

                            this.set('currentPageNumber', 1)
                            this.set('pageStart', 0)
                            this.set('pageEnd', _.size(proceduresSearchResults) <= this.vaadinGridMaxItemsPerPage ? _.size(proceduresSearchResults) : this.vaadinGridMaxItemsPerPage)
                            this.set('totalPagesForCurrentFolderAndCurrentFilter', parseInt(_.size(proceduresSearchResults) / this.vaadinGridMaxItemsPerPage))
                            this.set('totalProceduresForCurrentFolderAndCurrentFilter', _.size(proceduresSearchResults))
                            this.set('vaadinGridDataToShow', _.sortBy(_.get(_.chunk(proceduresSearchResults, this.vaadinGridMaxItemsPerPage), 0), ['code', 'label.' + this.language, 'id'], ['asc', 'asc', 'asc']))
                        }else{
                            this.set('currentPageNumber', 1)
                            this.set('pageStart', 0)
                            this.set('pageEnd', _.size(this.allProcedures) <= this.vaadinGridMaxItemsPerPage ? _.size(this.allProcedures) : this.vaadinGridMaxItemsPerPage)
                            this.set('totalPagesForCurrentFolderAndCurrentFilter', parseInt(_.size(this.allProcedures) / this.vaadinGridMaxItemsPerPage))
                            this.set('vaadinGridDataToShow', _.sortBy(_.get(_.chunk(this.allProcedures, this.vaadinGridMaxItemsPerPage), 0), ['code', 'label.'+this.language, 'id'], ['asc', 'asc', 'asc']))
                            this.set('totalProceduresForCurrentFolderAndCurrentFilter', _.size(this.allProcedures))
                        }
                    }, 100)
                }
            }


        }

        customElements.define(HtAdminManagementProcedures.is, HtAdminManagementProcedures)
    </script>
</dom-module>
