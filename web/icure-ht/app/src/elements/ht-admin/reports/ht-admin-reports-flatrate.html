<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../../bower_components/iron-iconset/iron-iconset.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../../../styles/dialog-style.html">
<link rel="import" href="../../../styles/scrollbar-style.html">
<link rel="import" href="../../../styles/buttons-style.html">
<link rel="import" href="../../../styles/paper-tabs-style.html">

<link rel="import" href="../../ht-spinner/ht-spinner.html">


<dom-module id="ht-admin-reports-flatrate">

    <template>

        <style include="shared-styles dialog-style buttons-style paper-tabs-style">
            .panel{
                margin: 5px;
                height: calc(100% - 20px);
                width: auto;
            }

            .panel-title{
                height: 40px;
                width: auto;
            }

            .panel-search{
                height: 45px;
                width: auto;
                display: flex;
            }

            .panel-content{
                height: calc(100% - 125px);
                width: auto;
            }

            .panel-button{
                height: 32px;
                width: auto;
                padding: 4px;
                display: flex;
                justify-content: flex-end!important;
            }

            .panel-content-block{
                height: 50px;
                width: auto;
                margin: 5px;
                padding: 5px;
                display: flex;
            }

            .btn-container{
                width: 100px;
            }

            .button{
                display: inline-flex!important;
                align-items: center!important;
            }

            #processDialog{
                height: 300px;
                width: 600px
            }

            #requestInfoDialog{
                height: 400px;
                width: 700px;
            }

            ht-spinner {
                height: 42px;
                width: 42px;
                display: block;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%,-50%);
            }

            .processDialogContent{
                padding: 5px;
                text-align: center;
            }

            .process-icon{
                height: 14px;
                width: 14px;
                padding: 0px;
                color: var(--app-status-color-ok);
            }

            .table{
                height: auto;
                width: 98%;
                padding: 1%;
            }

            .tr{
                height: auto;
                width: 100%;
                display: flex;
            }

            .td .info{
                width: 5%;
            }

            .td .title{
                width: 65%;
            }

            .td .result{
                width: 28%;
            }

            .w5{
                width: 5%;
            }

            .w65{
                width: 65%;
            }

            .w30{
                width: 28%;
                text-align: right;
            }

            .w90{
                width: 90%;
            }


        </style>

        <div class="panel">
            <div class="panel-title">
                <div class="title">
                    [[localize('rash-report', 'Report', language)]] - [[localize('rep-flatrate-title', 'Report about flatrate', language)]]
                </div>
            </div>
            <div class="panel-content">
                <div class="panel-content-block">
                    <div>
                        [[localize('rep-flatrate-pat-with', 'List of patient with flatrate', language)]]
                    </div>
                    <div class="btn-container">
                        <paper-button on-tap="_generateListWithContract"  class="button button--save">[[localize('rep-gen','Generate',language)]]</paper-button>
                    </div>
                </div>
                <div class="panel-content-block">
                    <div>
                        [[localize('rep-flatrate-pat-without', 'List of patient without flarate', language)]]
                    </div>
                    <div class="btn-container">
                        <paper-button on-tap="_generateListWithoutContract" class="button button--save">[[localize('rep-gen','Generate',language)]]</paper-button>
                    </div>
                </div>
                <div class="panel-content-block">
                    <div>
                        [[localize('rep-flatrate-invoice', 'List of invoices', language)]]
                    </div>
                    <div class="btn-container">
                        <paper-button on-tap="_generateInvoiceReport" class="button button--save">[[localize('rep-gen','Generate',language)]]</paper-button>
                    </div>
                </div>
                <div class="panel-content-block">
                    <div>
                        [[localize('rep-flatrate-infos-patient', 'List of infos patient : contracts and insurabilities', language)]]
                    </div>
                    <div class="btn-container">
                        <paper-button on-tap="_generateInfosReport" class="button button--save">[[localize('rep-gen','Generate',language)]]</paper-button>
                    </div>
                </div>
            </div>
        </div>

        <paper-dialog id="processDialog">
            <h2 class="modal-title">[[localize('rash-proc', 'Process request', language)]]</h2>
            <div class="content">
                <div class="processDialogContent">
                    [[localize('rash-proc-mess', 'This process can take a few minutes, please wait a moment', language)]]
                    <div class="table">
                        <template is="dom-repeat" items="[[processStep]]">
                            <div class="tr">
                                <div class="td w90 left">
                                    [[item]]
                                </div>
                                <div class="td w5 center">
                                    <iron-icon icon="vaadin:check-circle" class="process-icon"></iron-icon>
                                </div>
                            </div>
                        </template>
                    </div>
                    <ht-spinner active="[[isLoading]]"></ht-spinner>
                </div>
            </div>
            <div class="buttons">
                <div>&nbsp;</div>
            </div>
        </paper-dialog>

    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import { parse } from '../../../../scripts/icure-reporting'
        import { filter as icrFilter } from '../../../../scripts/filters'
        import '../../../../bower_components/js-xlsx/shim.js'
        import * as models from '@taktik/icc-api-legacy/dist/icc-api/model/models'
        import * as retry from "@taktik/icc-api-legacy/dist/icc-x-api/utils/net-utils"
        const XLSX = require('../../../../bower_components/js-xlsx/dist/xlsx.full.min.js')

        class HtAdminReportsFlatrate extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-admin-reports-flatrate'
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: () => {}
                    },
                    user: {
                        type: Object,
                        value: () => {}
                    },
                    hcp:{
                      type: Object,
                      value: () => {}
                    },
                    isLoading:{
                        type: Boolean,
                        value: false
                    },
                    patientList:{
                        type: Array,
                        value: () => []
                    },
                    selectedYear:{
                        type: Object,
                        value: () => {}
                    },
                    availableYearForReport:{
                        type: Array,
                        value: () => []
                    },
                    displayedYear: {
                        type: Number,
                        value: () => Number(moment().format('YYYY'))
                    },
                    processStep:{
                        type: Array,
                        value: () => []
                    }
                }
            }

            static get observers() {
                return ['_initializeDataProvider(api, user)'];
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
            }

            _initializeDataProvider(){
                if(this.api && this.user){
                    this.api.hcparty().getHealthcareParty(_.get(this.user, 'healthcarePartyId', null))
                        .then(hcp => this.set('hcp', hcp))
                }
            }

            _reset(){
                const currentYear = this.api.moment(new Date).format("YYYY")

                this.set('availableYearForReport', [
                    {label: currentYear, id: currentYear}
                ])
                this.set('selectedYear', _.get(this, 'availableYearForReport', []).find(ay => _.get(ay, 'id', null) === parseInt(this.api.moment(new Date()).format('YYYY')) -1))
                this.set('hcp', {})
                this.set('patientList', [])
                this.set('processStep', [])
            }

            _generateListWithContract(){
                this._reset()
                this.$['processDialog'].open()
                this.set("isLoading", true)
                this.push('processStep',  this.localize('mh_eInvoicing.mda.step_2', 'Collecting patient', this.language))
                this._initializeDataForListOfContract().then(patients => {
                   this.push('processStep',  this.localize('', 'Vérification des contracts', this.language))
                   this.set('patientList', patients.rows)
                    // they have a lot of patient inactive and they don't want to check every patient
                   //const listOfActivePatient = _.get(this, 'patientList', []).filter(pat => _.get(pat, 'active', false) === true)
                   const listOfPatientWithFlatRateContract = this._getPatientWithFlatrateContract( _.get(this, 'patientList', []))
                   this._generatePatientContractStatusReport(listOfPatientWithFlatRateContract, "withContract")
                })
            }

            _generateListWithoutContract(){
                this._reset()
                this.set("isLoading", true)
                this.push('processStep',  this.localize('mh_eInvoicing.mda.step_2', 'Collecting patient', this.language))
                this._initializeDataForListOfContract().then(patients => {
                    this.push('processStep',  this.localize('', 'Vérification des contracts', this.language))
                    this.set('patientList', patients.rows)
                    // they have a lot of patient inactive and they don't want to check every patient
                    //const listOfActivePatient = _.get(this, 'patientList', []).filter(pat => _.get(pat, 'active', false) === true)
                    const listOfPAtientWithoutFlatRateContract = this._getPatientWithoutFlatrateContract(_.get(this, 'patientList', []))
                    this._generatePatientContractStatusReport(listOfPAtientWithoutFlatRateContract, "withoutContract")
                })
            }

            _getPatientWithFlatrateContract(listOfActivePatient){
                const startOfYear = parseInt(_.get(this, 'selectedYear.id', null)+"0101")
                return listOfActivePatient.filter(pat => (_.get(pat, 'active', false) === true) &&  _.size(_.get(pat, "medicalHouseContracts", [])) &&
                    _.some(_.get(pat, "medicalHouseContracts", []), mhc => mhc &&
                        (mhc.kine || mhc.gp || mhc.nurse) &&
                        _.trim(_.get(mhc,"startOfContract") &&
                            _.get(mhc,"startOfContract") < (startOfYear+(1e4)) &&
                            (!_.get(mhc,"startOfCoverage") || (_.get(mhc,"startOfCoverage") && _.get(mhc,"startOfCoverage") < (startOfYear+(1e4))) ) &&
                            (!_.get(mhc,"endOfContract") || _.get(mhc,"endOfContract") > (startOfYear + 1130)) &&
                            (!_.get(mhc,"endOfCoverage") || _.get(mhc,"endOfCoverage") > (startOfYear + 1130)))))

            }

            _getPatientWithoutFlatrateContract(listOfActivePatient){
                const startOfYear = parseInt(_.get(this, 'selectedYear.id', null)+"0101")
                return listOfActivePatient.filter(pat => (_.get(pat, 'active', false) === true) &&  !_.size(_.get(pat, "medicalHouseContracts", [])) ||
                    !_.some(_.get(pat, "medicalHouseContracts", []), mhc => mhc &&
                        (mhc.kine || mhc.gp || mhc.nurse) &&
                        _.trim(_.get(mhc,"startOfContract") &&
                            _.get(mhc,"startOfContract") < (startOfYear+(1e4)) &&
                            (!_.get(mhc,"startOfCoverage") || (_.get(mhc,"startOfCoverage") && _.get(mhc,"startOfCoverage") < (startOfYear+(1e4))) ) &&
                            (!_.get(mhc,"endOfContract") || _.get(mhc,"endOfContract") > (startOfYear + 1130)) &&
                            (!_.get(mhc,"endOfCoverage") || _.get(mhc,"endOfCoverage") > (startOfYear + 1130)))))
            }


            _initializeDataForListOfContract() {
                return this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp => {
                    this.set('hcp', hcp)
                    const filter = {
                        $type: "PatientByHcPartyNameContainsFuzzyFilter",
                        healthcarePartyId: _.get(hcp, 'parentId', null) ? _.get(hcp, 'parentId', null) : _.get(hcp, 'id', null),
                        searchString: ""
                    };

                    return this.api.patient().filterByWithUser(this.user, null, null, 30000, 0, null, true, {filter: filter})

                })
            }

            _generatePatientContractStatusReport(listOfPatient, type){
                this.push('processStep',  this.localize('', 'Génération du rapport', this.language))
                let data = [
                    [
                        this.localize('inv_mut','Mutual',this.language),
                        this.localize('inv_pat','Patient',this.language),
                        this.localize('inv_niss','Inss',this.language),
                        this.localize('gender','Gender',this.language)
                    ]
                ]

                listOfPatient.map(pat => {
                    data.push([
                        _.get(pat, 'insuranceCode', ''),
                        _.get(pat, 'lastName', '')+' '+_.get(pat, 'firstName', ''),
                        _.get(pat, 'ssin', ''),
                        this.localize(_.get(pat, 'gender', ''), _.get(pat, 'gender', ''), this.language)
                    ])
                })

                this.set("isLoading", false)
                this.$['processDialog'].close()

                this.generateXlsFile(
                    data,
                    type === "withContract" ? "patientWithCtc"+moment().format("YYYYMMDD-HHmmss")+ ".xls" : "patientWithoutCtc"+moment().format("YYYYMMDD-HHmmss")+ ".xls",
                    type === "withContract" ? "Patient with contract" : "Patient without contract",
                    "Topaz"
                )

            }

            generateXlsFile(data, filename, title, author){

                // Create xls work book and assign properties
                const xlsWorkBook = {SheetNames: [], Sheets: {}}
                xlsWorkBook.Props = {Title: title, Author: author}

                // Create sheet based on json data collection
                var xlsWorkSheet = XLSX.utils.json_to_sheet(data)

                // Link sheet to workbook
                XLSX.utils.book_append_sheet(xlsWorkBook, xlsWorkSheet, title)

                // Virtual data output
                var xlsWorkBookOutput = new Buffer(XLSX.write(xlsWorkBook, {bookType: 'xls', type: 'buffer'}))

                // Put output to virtual "file"
                var fileBlob = new Blob([xlsWorkBookOutput], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})

                // Create download link and append to page's body
                var downloadLink = document.createElement("a")
                document.body.appendChild(downloadLink)
                downloadLink.style = "display: none"

                // Create url
                var urlObject = window.URL.createObjectURL(fileBlob)

                // Link to url
                downloadLink.href = urlObject
                downloadLink.download = filename

                // Trigger download and drop object
                downloadLink.click()
                window.URL.revokeObjectURL(urlObject)

                // Free mem
                fileBlob = false
                xlsWorkBookOutput = false
            }

            _generateInfosReport(){
                this._reset()
                this.$['processDialog'].open()
                this.set("isLoading", true)

                this.push('processStep',  this.localize('', 'listing des patients', this.language))

                this.api.getRowsUsingPagination(
                    (key,docId) => this.api.patient().listPatientsByHcPartyWithUser(this.user, _.trim(_.get(this,"user.healthcarePartyId","")), null, key && JSON.stringify(key), docId, 1000)
                            .then(pl => {
                                return {
                                    rows:pl.rows,
                                    nextKey: pl.nextKeyPair && pl.nextKeyPair.startKey,
                                    nextDocId: pl.nextKeyPair && pl.nextKeyPair.startKeyDocId,
                                    done: !pl.nextKeyPair
                                }
                            })
                            .catch(()=>{ return Promise.resolve(); })
                ).then(patients => {
                    this.push('processStep',  this.localize('', 'listing des assurances', this.language))
                    const insuranceIds = _.compact(_.uniq(patients.map(pat => _.get(_.get(pat,"insurabilities",[]).find(ins => _.get(ins,"startDate",false) && this.api.moment(_.get(ins,"startDate","")).isSameOrBefore(moment(),"day") && (!ins.endDate || this.api.moment(ins.endDate).isSameOrAfter(moment(),"day"))),"insuranceId",""))))
                    return Promise.all([Promise.resolve(patients), this.api.insurance().getInsurances(new models.ListOfIdsDto({ids:insuranceIds}))])
                }).then(([patients,insurances]) => {
                    this.push('processStep',  this.localize('', 'formatage des données', this.language))
                    return this.generateXlsFile(
                        patients.map(pat => {
                            const insurance = _.get(pat,"insurabilities",[]).find(ins => _.get(ins,"startDate",false) && this.api.moment(_.get(ins,"startDate","")).isSameOrBefore(moment(),"day") && (!_.get(ins,"endDate",false) || this.api.moment(ins.endDate).isSameOrAfter(moment(),"day")))
                            const contract = _.get(pat,"medicalHouseContracts",[]).find(mhc => _.get(mhc, 'startOfCoverage', "") && this.api.moment(_.get(mhc, 'startOfCoverage', "")).isSameOrBefore(moment(),"day") && (!_.get(mhc,"endOfCoverage",false) || this.api.moment(mhc,"endOfCoverage","").isSameOrAfter(moment(),"day")))
                            return {
                                "externalId" : _.get(pat,"externalId",""),
                                "firstName" : _.get(pat,"firstName",""),
                                "lastName" : _.get(pat,"lastName", ""),
                                "ssin" : _.get(pat,"ssin",""),
                                "actif" : _.get(pat,"active",false) ? "Actif" : "Inactif",
                                "OA" : _.get(insurances.find(ins => ins.id === _.get(insurance,"insuranceId","")),"code",""),
                                "startDate": _.get(insurance,"startDate",false) ? this.api.formatedMoment(_.get(insurance,"startDate","")) : "NDA",
                                "endDate": _.get(insurance,"endDate",false) ? this.api.formatedMoment(_.get(insurance,"endDate","")) : "NDA",
                                "identificationNumber" : _.get(insurance,"identificationNumber","NDA"),
                                "TC1-TC2" : _.get(insurance,"parameters.tc1","")+"-"+_.get(insurance,"parameters.tc2",""),
                                "contractId" : _.get(contract,"contractId"),
                                "startOfCoverage" : _.get(contract,"startOfCoverage",false) ? this.api.formatedMoment( _.get(contract,"startOfCoverage","")) : "NDA",
                                "endOfCoverage" : _.get(contract,"endOfCoverage",false) ? this.api.formatedMoment( _.get(contract,"endOfCoverage","")) : "NDA",
                                "startOfContract" : _.get(contract,"startOfContract",false) ? this.api.formatedMoment( _.get(contract,"startOfContract","")) : "NDA",
                                "enOfContract" : _.get(contract,"enOfContract",false) ? this.api.formatedMoment( _.get(contract,"enOfContract","")) : "NDA",
                                "contractStatus" : this._getSubscriptionStatus(contract) || ""
                            }
                        }),
                         "infosPatients"+moment().format("YYYYMMDD-HHmmss")+ ".xls" ,
                        "infosPatients",
                        "Topaz"
                    )
                }).finally(()=>{
                    this.set("isLoading",false)
                    this.$['processDialog'].close()
                })
            }

            _getSubscriptionStatus(mhc) {
                return !!(_.get(mhc, 'status', null) & (1 << 3)) ? this.localize('mhm_stat_closed', 'Closed', this.language) + ' le ' + this.api.formatedMoment(_.get(mhc, 'endOfCoverage', null)) :
                    !!(_.get(mhc, 'status', null) & (1 << 2)) ? this.localize('mhm_stat_cancelled', 'Cancelled', this.language) :
                        !!(_.get(mhc, 'status', null) & (1 << 1)) ? this.localize('mhm_stat_ongoing', 'On going', this.language) :
                            this.localize('mhm_stat_other', 'Manual encoding', this.language)
            }


            _generateInvoiceReport(){
                this._reset()
                this.$['processDialog'].open()
                this.set("isLoading", true)

                this.api.message().findMessagesByTransportGuid("EFACT:BATCH:*").then(messages => {
                    const filteredMessages =  messages.rows.filter(msg => msg.transportGuid && msg.responsible === this.hcp.id && this.api.moment(new Date).isBefore(this.displayedYear+'0301') ? (msg.transportGuid.startsWith("EFACT:BATCH:" + this.displayedYear) || msg.transportGuid.startsWith("EFACT:BATCH:" + (this.displayedYear-1))) : (msg.transportGuid.startsWith("EFACT:BATCH:" + this.displayedYear)))
                    const promCarrier = []
                    let prom = Promise.resolve([])
                    _.chunk(filteredMessages, 25).map(chunckMessages => {
                        prom = prom.then(msgStruct => {
                            return Promise.all(
                                chunckMessages.map(msg =>
                                    this._getInvoicesFormBatch(msg.invoiceIds.map(id => id))
                                        .then(invsFromMess => this._getInvoicesFormBatch(invsFromMess.map(inv => inv.correctiveInvoiceId)))
                                        .then(correctiveInvoices => {
                                            let allInvoicesIsCorrected = false

                                            if((msg.status & (1 << 17)) !== 0 && !(msg.status & (1 << 21))){
                                                const resentNmclStatus = _.uniq(_.flatten(correctiveInvoices && correctiveInvoices.map(inv =>inv && inv.invoicingCodes && inv.invoicingCodes.map(c => c.resent))))
                                                let allInvoicesIsCorrected = false

                                                if(resentNmclStatus.length === 1 && resentNmclStatus[0] === false){
                                                    allInvoicesIsCorrected = true
                                                }
                                            }

                                            return this.api.document().findByMessage(this.user.healthcarePartyId, msg)
                                                .then(docs => {
                                                    const jsonDoc = docs.find(d => d.mainUti === "public.json" && _.endsWith(d.name, '_records'))

                                                    return jsonDoc && jsonDoc.attachmentId ?
                                                        (_.size(jsonDoc.encryptionKeys) || _.size(jsonDoc.delegations) ?
                                                            this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(this.user.healthcarePartyId, jsonDoc.id, _.size(jsonDoc.encryptionKeys) ? jsonDoc.encryptionKeys : jsonDoc.delegations).then(({extractedKeys: enckeys}) => this.api.document().getAttachment(jsonDoc.id, jsonDoc.attachmentId, enckeys.join(','))) : this.api.document().getAttachment(jsonDoc.id, jsonDoc.attachmentId))
                                                            .then(a => {

                                                                if (typeof a === "string"){
                                                                    try { a = JSON.parse( this.cleanStringForJsonParsing(a) ) } catch (ignored) {}
                                                                } else if (typeof a === "object") {
                                                                    try { a = JSON.parse( this.cleanStringForJsonParsing(new Uint8Array(a).reduce((data, byte) => data + String.fromCharCode(byte), ''))); } catch (ignored) {}
                                                                }

                                                                const zone200 = a && a.find(enr => enr.zones.find(z => z.zone === "200"))
                                                                const zone300 = a && a.find(enr => enr.zones.find(z => z.zone === "300"))
                                                                const zone400 = a && a.find(enr => enr.zones.find(z => z.zone === "400"))
                                                                const zone500 = a && a.find(enr => enr.zones.find(z => z.zone === "500"))
                                                                const enr10 = a && a.find(enr => enr.zones.find(z => z.zone === "1" && z.value === "10"))

                                                                const st = msg.status

                                                                const invoiceStatus =
                                                                    !!(st & (1 << 21)) ? this.localize('inv_arch','Archived',this.language):
                                                                        !!(st & (1 << 17)) ? this.localize('inv_err','Error',this.language):
                                                                            !!(st & (1 << 16)) ? this.localize('inv_par_acc','Partially accepted',this.language):
                                                                                !!(st & (1 << 15)) ? this.localize('inv_full_acc','Fully accepted',this.language):
                                                                                    !!(st & (1 << 12)) ? this.localize('inv_rej','Rejected',this.language):
                                                                                        !!(st & (1 << 11)) ? this.localize('inv_tre','Treated',this.language):
                                                                                            !!(st & (1 << 10)) ? this.localize('inv_acc_tre','Accepted for treatment',this.language):
                                                                                                !!(st & (1 << 9))  ? this.localize('inv_succ_tra_oa','Successfully transmitted to OA',this.language):
                                                                                                    !!(st & (1 << 8))  ? this.localize('inv_pen','Pending',this.language):
                                                                                                        !!(st & (1 << 7))  ? this.localize('inv_pen','Pending',this.language): ""


                                                                const rejectionReason = !!(st & (1 << 17)) ? this.localize('inv_rej_5%','More than 5% error',this.language) :
                                                                    !!(st & (1 << 12)) ? this.localize('inv_rej_block','Blocking error',this.language): ""

                                                                return (zone200 && zone300) ?
                                                                    ({
                                                                        message: msg,
                                                                        messageInfo: {
                                                                            messageType:        zone200.zones && zone200.zones.find(z => z.zone === "200") ? zone200.zones.find(z => z.zone === "200").value : "",
                                                                            hcp:                this.hcp.firstName + " " + this.hcp.lastName,
                                                                            oa:                 _.get(msg, 'metas.ioFederationCode', ""),
                                                                            hcpReference:       enr10.zones && enr10.zones.find(z => z.zone === "28") ? enr10.zones.find(z => z.zone === "28").value : "",
                                                                            invoiceNumber:      zone300.zones && zone300.zones.find(z => z.zone === "301") ? zone300.zones.find(z => z.zone === "301").value : "",
                                                                            invoiceMonth:       zone300.zones &&zone300.zones.find(z => z.zone === "300") ? zone300.zones.find(z => z.zone === "300").value : "",
                                                                            invoiceDate:        zone300.zones && zone300.zones.find(z => z.zone === "302") ? zone300.zones.find(z => z.zone === "302").value : "",
                                                                            invoicedAmount:     Number(_.get(msg, 'metas.totalAmount', '0.00')),
                                                                            acceptedAmount:     Number(_.get(msg, 'metas.totalAcceptedAmount', '0.00')),
                                                                            refusedAmount:      Number(_.get(msg, 'metas.totalRejectedAmount', '0.00')),
                                                                            invoiceStatus:      invoiceStatus,
                                                                            rejectionReason:    rejectionReason,
                                                                            paymentReference:   _.get(msg, 'metas.paymentReferenceAccount1', ""),
                                                                            paymentDate:        "",
                                                                            amountPaid:         Number(_.get(msg, 'metas.totalAcceptedAmount', '0.00')).toFixed(2),
                                                                            paymentAccount:     enr10.zones && enr10.zones.find(z => z.zone === "36") ? enr10.zones.find(z => z.zone === "36").value : "",
                                                                            paid: false,
                                                                            allInvoicesIsCorrected : allInvoicesIsCorrected,
                                                                            sendError: false
                                                                        },
                                                                        normalizedSearchTerms: _.map(_.uniq(_.compact(_.flatten(_.concat([_.trim(_.get(msg, 'metas.ioFederationCode', "")), _.trim(_.get(this.hcp, 'firstName', "")), _.trim(_.get(this.hcp, 'lastName', "")), _.trim(zone300.zones && zone300.zones.find(z => z.zone === "301") ? zone300.zones.find(z => z.zone === "301").value : ""), _.trim(zone300.zones &&zone300.zones.find(z => z.zone === "300") ? zone300.zones.find(z => z.zone === "300").value : ""), _.trim(zone300.zones && zone300.zones.find(z => z.zone === "302") ? zone300.zones.find(z => z.zone === "302").value : ""), _.trim(msg.metas && msg.metas.paymentReferenceAccount1 ? msg.metas.paymentReferenceAccount1 : "")])))), i =>  _.trim(i).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "")).join(" ")
                                                                    }) : {}
                                                            }) : Promise.resolve({
                                                            message: msg,
                                                            messageInfo: {
                                                                messageType:        null,
                                                                hcp:                _.get(this.hcp, 'firstName', "") + " " + _.get(this.hcp, 'lastName', ""),
                                                                oa:                 _.get(msg, 'metas.ioFederationCode', null),
                                                                hcpReference:       _.get(msg, 'metas.errors', null),
                                                                invoiceNumber:      _.get(msg, 'externalRef', null),
                                                                invoiceMonth:       msg.metas && msg.metas.invoiceMonth && msg.metas.invoiceYear ? msg.metas.invoiceYear+''+msg.metas.invoiceMonth : null,
                                                                invoiceDate:        msg.metas && msg.metas.invoiceMonth && msg.metas.invoiceYear ? msg.metas.invoiceYear+''+msg.metas.invoiceMonth+'01' : null,
                                                                invoicedAmount:     Number(_.get(msg, 'metas.totalAmount', '0.00')),
                                                                acceptedAmount:     Number(_.get(msg, 'metas.totalAcceptedAmount', '0.00')),
                                                                refusedAmount:      Number(_.get(msg, 'metas.totalAmount', '0.00')),
                                                                invoiceStatus:      !!(msg.status & (1 << 21)) ? this.localize('inv_arch','Archived',this.language) : this.localize('inv_send_err','Send error',this.language),
                                                                rejectionReason:    _.get(msg, 'metas.errors', ""),
                                                                paymentReference:   _.get(msg, 'metas.paymentReferenceAccount1', ""),
                                                                paymentDate:        null,
                                                                amountPaid:         Number(_.get(msg, 'metas.totalAcceptedAmount', '0.00')).toFixed(2),
                                                                paymentAccount:     null,
                                                                paid:               false,
                                                                allInvoicesIsCorrected : false,
                                                                sendError:          true
                                                            },
                                                            normalizedSearchTerms: _.map(_.uniq(_.compact(_.flatten(_.concat([_.trim(_.get(msg, 'metas.ioFederationCode', "")), _.trim(_.get(this.hcp, 'firstName', "")), _.trim(_.get(this.hcp, 'lastName', "")), _.trim(_.get(msg, 'externalRef', "")), _.trim(msg.metas && msg.metas.invoiceMonth && msg.metas.invoiceYear ? msg.metas.invoiceYear+''+msg.metas.invoiceMonth : null,), _.trim(msg.metas && msg.metas.invoiceMonth && msg.metas.invoiceYear ? msg.metas.invoiceYear+''+msg.metas.invoiceMonth+'01' : null), _.trim(_.get(msg, 'metas.paymentReferenceAccount1', ""))])))), i =>  _.trim(i).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "")).join(" ")
                                                        })
                                                })


                                        })
                                )
                            ).then(messageInfo => {
                                promCarrier.push(messageInfo)
                            }).catch(e => console.log(e))
                        })
                    })

                    prom.then(() => {
                        //traitement pour le XLS
                        const data = _.compact(_.flatten(promCarrier)).map( message => {
                            let formatedData = {};
                            formatedData[this.localize("batchnr","Numéro d'envoi")] = _.get(message,"messageInfo.invoiceNumber","-")
                            formatedData[this.localize("status","statut")] = _.get(message,"messageInfo.invoiceStatus","")
                            formatedData[this.localize("inv_oa","OA")] = _.get(message,"messageInfo.oa","-")
                            formatedData[this.localize('inv_prest','Physician')] = _.get(message,"messageInfo.hcp","-")
                            formatedData[this.localize('inv_batch_amount','Amount')+ " " +this.localize('inv_batch_amount_invoiced','Invoiced')] = this._formatAmount(_.get(message,"messageInfo.invoicedAmount","-")) + " €"
                            formatedData[this.localize('inv_batch_bank_account','Bank account')] = _.get(message,"messageInfo.paymentAccount","-")
                            formatedData[this.localize('inv_batch_month','Billed month')] = this.formatDate(_.get(message,"messageInfo.invoiceMonth",""),"month")
                            formatedData[this.localize('inv_batch_amount','Amount')+ " " +this.localize('inv_batch_amount_acc','Accepted')] = this._formatAmount(_.get(message,"messageInfo.acceptedAmount","")) + " €"
                            formatedData[this.localize('inv-ref-pai','Paiement reference')] = _.get(message,"messageInfo.paymentReference","")
                            formatedData[this.localize('inv_date_fact','Invoice date')] = this.formatDate(_.get(message,"messageInfo.invoiceDate",""),'date')
                            formatedData[this.localize('inv_batch_amount','Amount')+ " "+ this.localize('inv_batch_amount_rej','Rejected')] = this._getRefusedAmount(_.get(message,"messageInfo.invoicedAmount",0), _.get(message,"messageInfo.acceptedAmount",0))+ " €"
                            formatedData[this.localize('inv_batch_amount_paid','Paid')] = this._formatAmount(_.get(message,"messageInfo.amountPaid",""))+" €"
                            formatedData[this.localize('error','error')] = _.get(message,"invoicesErrorMsg",[]).join(" ")

                            return formatedData;
                        })

                        this.generateXlsFile(data,
                            "invoices"+moment().format("YYYYMMDD-HHmmss")+ ".xls" ,
                            "invoices",
                            "Topaz"
                        )
                    }).finally(() => {
                        this.$['processDialog'].close()
                        this.set("isLoading", false)
                    })
                })

            }

            formatDate(d,f) {
                const input = d && d.toString() || _.trim(d)
                const yyyy = input.slice(0,4), mm = input.slice(4,6), dd = input.slice(6,8)
                switch(f) {
                    case 'date' :
                        return `${dd}/${mm}/${yyyy}`;
                    case 'month' :
                        const monthStr =
                            (mm.toString() === '01') ? this.localize('Jan',this.language) :
                                (mm.toString() === '02') ? this.localize('Feb',this.language) :
                                    (mm.toString() === '03') ? this.localize('Mar',this.language) :
                                        (mm.toString() === '04') ? this.localize('Apr',this.language) :
                                            (mm.toString() === '05') ? this.localize('May',this.language) :
                                                (mm.toString() === '06') ? this.localize('Jun',this.language) :
                                                    (mm.toString() === '07') ? this.localize('Jul',this.language) :
                                                        (mm.toString() === '08') ? this.localize('Aug',this.language) :
                                                            (mm.toString() === '09') ? this.localize('Sep',this.language) :
                                                                (mm.toString() === '10') ? this.localize('Oct',this.language) :
                                                                    (mm.toString() === '11') ? this.localize('Nov',this.language) :
                                                                        this.localize('Dec',this.language)
                        return `${monthStr} ${yyyy}`
                }
            }

            _formatAmount(amount){
                return this.findAndReplace(((Number(amount).toFixed(2)).toString()),'.',',')
            }

            _getRefusedAmount(totalAmount, acceptedAmount){
                return this.findAndReplace(((Number(Number(totalAmount) - Number(acceptedAmount)).toFixed(2)).toString()),'.',',')
            }

            findAndReplace(string, target, replacement) {
                for (let i = 0; i < string.length; i++) { string = string.replace(target, replacement); }
                return string;
            }


            _getInvoicesFormBatch(listOfInvoiceId){
                let prom = Promise.resolve([])
                _.chunk(listOfInvoiceId, 50).map(chunkList =>
                    prom = prom.then(listOfInvoice =>
                        retry.retry(() => (this.api.invoice().getInvoices(new models.ListOfIdsDto({ids: chunkList.map(id => id)}))), 4, 1000, 1)
                            .then(inv => _.concat(listOfInvoice, inv))
                            .catch(e => console.log(e))
                    )
                )

                return prom
            }

            cleanStringForJsonParsing(inputValue) {
                return inputValue
                    .replace(/\\n/g, "\\n")
                    .replace(/\\'/g, "\\'")
                    .replace(/\\"/g, '\\"')
                    .replace(/\\&/g, "\\&")
                    .replace(/\\r/g, "\\r")
                    .replace(/\\t/g, "\\t")
                    .replace(/\\b/g, "\\b")
                    .replace(/\\f/g, "\\f")
                    .replace(/[\u0000-\u0019]+/g,"")
            }
        }

        customElements.define(HtAdminReportsFlatrate.is, HtAdminReportsFlatrate)
    </script>
</dom-module>
