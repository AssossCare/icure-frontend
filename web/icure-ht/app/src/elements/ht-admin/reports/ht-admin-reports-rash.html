<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../../bower_components/iron-iconset/iron-iconset.html">
<link rel="import" href="../../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">


<dom-module id="ht-admin-reports-rash">

    <template>

        <style include="shared-styles">
            :host {
                display: block;
            }

            :host *:focus{
                outline:0!important;
            }

            .rash-panel{
                width: 100%;
                height: 100%;
                grid-column-gap: 24px;
                grid-row-gap: 24px;
                padding: 0 24px;
                box-sizing: border-box;
                background: white;
            }

            .rashResult{
                height: calc(100% - 50px);
                width: auto;
                margin: 1%;
                overflow: auto;
            }

            .block-title{
                height: 20px;
                width: auto;
                font-weight: bold;
            }

            .sub-block{
                padding: 8px;
            }

            .sub-block-title{

            }

            .sub-bloc-content{
                padding: 8px;
            }

        </style>

        <div class="rash-panel">
            <h4 class="section-title">[[localize('rash-report', 'Report', language)]] - [[localize('rash-rash', 'RASH', language)]]</h4>

            <div class="rashResult">
                <div class="info-block">
                    <div class="block-title">
                        [[localize('rash-jobs-done', 'Jobs done', language)]]
                    </div>

                    <div class="sub-block">
                        <div class="sub-block-title">
                             - [[localize('rash-influ', 'Influenza vaccination rate (65 years and over)', language)]]:
                        </div>
                    </div>

                     <div class="sub-block">
                         <div class="sub-block-title">
                             - [[localize('rash-dmg', 'Number of DMG (number of patients registred on 31/12/2019)', language)]]:
                         </div>
                     </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-cons-doc', 'Number of consultations / services performed by a doctor', language)]]:
                        </div>
                    </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-cons-nurse', 'Number of consultations / services provided by a nurse', language)]]:
                        </div>
                    </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-cons-phy', 'Number of consultations / services performed by a physiotherapist', language)]]:
                        </div>
                    </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-cons-ano', 'Number of consultations / services performed by another function', language)]]:
                        </div>
                    </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-non-flatrate', 'Number of active patients (if ASI fixed price)', language)]]: [[_getNumberOfPatientWithoutFlatrateContract(patientList)]]
                        </div>
                    </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-flatrate', 'Number of active patients on the INAMI package (if ASI on the package)', language)]]: [[_getNumberOfPatientWithFlatrateContract(patientList)]]
                        </div>
                    </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-colon', 'Colon cancer screening rate (50 to 75 years)', language)]]:
                        </div>
                    </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-mammograms', 'Rate of screening mammograms (women aged 50 to 69)', language)]]:
                        </div>
                    </div>
                </div>

                <div class="info-block">
                    <div class="block-title">
                        [[localize('rash-recipient', 'Recipient', language)]] ([[_getNumberOfPatient(patientList)]])
                    </div>
                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-age-distrib', 'Age distribution (age groups)', language)]]
                        </div>
                        <div class="sub-bloc-content">
                            0 - 4 [[localize('rash-years', 'years', language)]]: [[_getNumberOfPatientByRangeOfAge(0, 5, patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            5 - 14 [[localize('rash-years', 'years', language)]]: [[_getNumberOfPatientByRangeOfAge(5, 15, patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            15 - 24 [[localize('rash-years', 'years', language)]]: [[_getNumberOfPatientByRangeOfAge(15, 25, patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            25 - 44 [[localize('rash-years', 'years', language)]]: [[_getNumberOfPatientByRangeOfAge(25, 45, patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            45 - 64 [[localize('rash-years', 'years', language)]]: [[_getNumberOfPatientByRangeOfAge(45, 65, patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            65 - 74 [[localize('rash-years', 'years', language)]]: [[_getNumberOfPatientByRangeOfAge(65, 75, patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            75 - 94 [[localize('rash-years', 'years', language)]]: [[_getNumberOfPatientByRangeOfAge(75, 95, patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            [[localize('rash-95-and-more', '95 years and more', language)]]: [[_getNumberOfPatientByRangeOfAge(95, 120, patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            [[localize('rash-ageless', 'Ageless patients', language)]]: [[_getNumberOfPatientByRangeOfAge(219, 221, patientList)]]
                        </div>
                    </div>

                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-BIM', 'BIM', language)]]: [[_getNumberOfBim(patientList)]]
                        </div>
                    </div>

                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-amu', 'Emergency help (AMU)', language)]]:
                        </div>
                    </div>

                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-gender-dist', 'Gender distribution', language)]]
                        </div>
                        <div class="sub-bloc-content">
                            [[localize('rash-male', 'Male', language)]]: [[_getNumberOfPatientByGender('m', patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            [[localize('rash-female', 'Female', language)]]: [[_getNumberOfPatientByGender('f', patientList)]]
                        </div>
                        <div class="sub-bloc-content">
                            [[localize('rash-other', 'Other', language)]]: [[_getNumberOfPatientByGender('o', patientList)]]
                        </div>
                    </div>

                    <div class="sub-block">
                        <div class="sub-block-title">
                            - [[localize('rash-home-dist', 'Home distribution', language)]]
                        </div>
                        <template is="dom-repeat" items="[[homeDistribution]]">
                            <template is="dom-if" if="[[_isMoreThanOnePercent(item.rate)]]">
                                <div class="sub-bloc-content">
                                    [[item.postalCode]]: [[item.rate]]%
                                </div>
                            </template>
                        </template>
                    </div>

                </div>
            </div>
        </div>

    </template>

    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import { parse } from '../../../../scripts/icure-reporting'
        import { filter as icrFilter } from '../../../../scripts/filters'

        class HtAdminReportsRash extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-admin-reports-rash'
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        noReset: true
                    },
                    patientList:{
                        type: Array,
                        value: () => []
                    },
                    homeDistribution:{
                        type: Array,
                        value: () => []
                    },
                    hcp:{
                        type: Object,
                        value: () => {}
                    }
                }
            }

            static get observers() {
                return ['_initializeDataProvider(api, user)'];
            }

            constructor() {
                super()
            }

            ready() {
                super.ready()
            }

            _initializeDataProvider(){
                let queryList = [
                    {type: 'breastCancer', filter:'((gender == "female") & age>50y & age<69y & active == true) - SVC[ICPC == X76 - :CD-CERTAINTY == excluded] - HE[ICPC == X76 - :CD-CERTAINTY == excluded] - SVC[BE-THESAURUS-PROCEDURES == X41.004{<2y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)] - SVC[BE-THESAURUS-PROCEDURES == X41.006{<2y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)] - SVC[BE-THESAURUS-PROCEDURES == X41.007{<2y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)] - SVC[BE-THESAURUS-PROCEDURES == X41.008{<2y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)] - SVC[BE-THESAURUS-PROCEDURES == X41.009{<2y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)] - SVC[BE-THESAURUS-PROCEDURES == X41.010{<2y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)] - SVC[BE-THESAURUS-PROCEDURES == X41.011{<2y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)]'},
                    {type: 'colorectalCancer', filter: '((gender == "female" | gender == "male") & active == true & (age>50y & age<75y)) - SVC[ICPC == D75 - :CD-CERTAINTY == excluded] - HE[ICPC == D75 - :CD-CERTAINTY == excluded] - SVC[BE-THESAURUS-PROCEDURES == D40.001{<5y} & :CD-LIFECYCLE == completed] - SVC[BE-THESAURUS-PROCEDURES == D36.002{<2y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)]'},
                    {type: 'collarSmear', filter: '(gender=="female" & (age>25y & age<65y) & active == true) - SVC[ICPC == X75 - :CD-CERTAINTY == excluded] - HE[ICPC == X75 - :CD-CERTAINTY == excluded] - SVC[BE-THESAURUS-PROCEDURES == X37.003{<3y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed) | :CD-LIFECYCLE == refused] - SVC[BE-THESAURUS-PROCEDURES == X37.002{<3y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)]'},
                    {type: 'influenza', filter: '((age>65y & active == true) | SVC[ICPC == W78 - :CD-CERTAINTY == excluded] | HE[ICPC == W78 - :CD-CERTAINTY == excluded] | SVC[ICPC == W79 - :CD-CERTAINTY == excluded] | HE[ICPC == W79 - :CD-CERTAINTY == excluded] | SVC[ICPC == W29 - :CD-CERTAINTY == excluded] | HE[ICPC == W29 - :CD-CERTAINTY == excluded] | SVC[ICPC == W84 - :CD-CERTAINTY == excluded] | HE[ICPC == W84 - :CD-CERTAINTY == excluded] | SVC[ICPC == T90 - :CD-CERTAINTY == excluded] | HE[ICPC == T90 - :CD-CERTAINTY == excluded] | SVC[ICPC == T89 - :CD-CERTAINTY == excluded] | HE[ICPC == T89 - :CD-CERTAINTY == excluded]| SVC[ICPC == R95 - :CD-CERTAINTY == excluded]) | HE[ICPC == R95 - :CD-CERTAINTY == excluded] - SVC[BE-THESAURUS-PROCEDURES == R44.003{<1y} & (:CD-LIFECYCLE == completed | :CD-LIFECYCLE == aborted | :CD-LIFECYCLE == cancelled | :CD-LIFECYCLE == proposed | :CD-LIFECYCLE == refused)]'},
                    {type: 'male', filter: '(gender == "male")'},
                    {type: 'female', filter: '(gender == "female")'},
                    {type: 'other', filter: '(gender == "indeterminate") | (gender == "changed") | (gender == "changedToMale") | (gender == "changedToFemale") | (gender == "unknown")'},
                    {type: '0To4', filter: 'age>0y & age<5y'},
                    {type: '5To14', filter: 'age>5y & age<15y'},
                    {type: '15To24', filter: 'age>15y & age<25y'},
                    {type: '25To44', filter: 'age>25y & age<45y'},
                    {type: '45To64', filter: 'age>45y & age<65y'},
                    {type: '65To74', filter: 'age>65y & age<75y'},
                    {type: '75To94', filter: 'age>75y & age<95y'},
                    {type: 'moreThan95', filter: 'age>95y'}

                ]
                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp => {
                    this.set('hcp', hcp)
                    let prom = Promise.resolve([])

                    const filter = {
                        $type: "PatientByHcPartyNameContainsFuzzyFilter",
                        healthcarePartyId: _.get(hcp, 'parentId', null) ? _.get(hcp, 'parentId', null) : _.get(hcp, 'id', null),
                        searchString: ""
                    };

                    this.api.patient().filterByWithUser(this.user, null, null, 30000, 0, null, true, {filter: filter})
                        .then(patients => {
                            this.set('patientList', patients.rows)
                        }).then(() => {
                            queryList.map(query => {
                                prom = prom.then(result => this._executeQueryFilter(query.filter).then(res => _.concat(result, {
                                    result: res,
                                    numberOfPatient: _.size(res),
                                    type: _.get(query, 'type', null)
                                })))
                            })

                            prom.then(allResult => {
                                console.log(allResult)
                            })
                        })
                        .finally(() => {
                                this.set("isLoading", false);
                                this._getHomeDistribution()
                        });

                })
            }

            _executeQueryFilter(searchFilter){
                let svcFilter = null
                let lastParamsWithIdxProm = Promise.resolve()

                svcFilter = parse(`PAT[${searchFilter}]`, {hcpId: this.hcp.parentId || this.user.healthcarePartyId})

                lastParamsWithIdxProm = icrFilter(svcFilter, {
                    cryptoicc: this.api.crypto(), usericc: this.api.user(), patienticc: this.api.patient(), contacticc: this.api.contact(), helementicc: this.api.helement(), invoiceicc: this.api.invoice(), hcpartyicc: this.api.hcparty()
                }, this.hcp.parentId || this.user.healthcarePartyId, false).then(pl => pl.rows)

                return lastParamsWithIdxProm.then(res => {
                   return res
                })
            }

            _getNumberOfPatientByRangeOfAge(startAge, endAge){
                return _.size(_.get(this, 'patientList', []).filter(p => (_.get(p, 'dateOfBirth', null) ? this.api.moment(new Date()).diff(this.api.moment(_.get(p, 'dateOfBirth', null)).format('YYYY-MM-DD'), 'years', true) : 220) >= startAge && (_.get(p, 'dateOfBirth', null) ? this.api.moment(new Date()).diff(this.api.moment(_.get(p, 'dateOfBirth', null)).format('YYYY-MM-DD'), 'years', true) : 220) <= endAge))
            }

            _getNumberOfPatient(){
                return _.size(_.get(this, 'patientList', []))
            }

            _getNumberOfBim(){
                return _.size(
                    _.get(this, 'patientList', []).filter(p =>
                        _.size(_.get(p, 'insurabilities', [])) &&
                        parseInt(_.get(_.head(_.get(p, 'insurabilities', []).filter(ins =>
                            _.get(ins, 'startDate', null) && !_.get(ins, 'endDate', null) && _.trim(_.get(ins, 'parameters.tc1', null)).length === 3 && _.trim(_.get(ins, 'parameters.tc2', null)).length === 3
                        )), 'parameters.tc1', null)) % 2 !== 0
                    )
                )
            }

            _getNumberOfPatientByGender(g){
                const gender = g && g === "m" ? "male" : g && g === "f" ? "female" : "other"
                return _.size(_.get(this, 'patientList', []).filter(p => gender === "male" || gender === "female" ? _.get(p, 'gender', null) === gender : _.get(p, 'gender', null) !== "female" && _.get(p, 'gender', null) !== "male"))
            }

            _getNumberOfPatientWithFlatrateContract(){
                return _.size(
                    _.get(this, 'patientList', []).filter(p =>
                        _.size(_.get(p, 'medicalHouseContracts', [])) &&
                        (
                            _.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'startOfCoverage', null) ? this.api.moment(_.get(mhc, 'startOfCoverage', null)).isBefore('2019-12-31') : null) &&
                            (_.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'endOfCoverage', null) ? this.api.moment(_.get(mhc, 'endOfCoverage', null)).isAfter('2019-01-01') : null) ||
                            !_.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'endOfCoverage', null)))
                        )
                    )
                )
            }

            _getNumberOfPatientWithoutFlatrateContract(){
                return _.size(
                    _.get(this, 'patientList', []).filter(p =>
                        (_.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'startOfCoverage', null) ? this.api.moment(_.get(mhc, 'startOfCoverage', null)).isBefore('2019-01-01') : null) && _.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'endOfCoverage', null) ? this.api.moment(_.get(mhc, 'endOfCoverage', null)).isBefore('2019-01-01') : null)) ||
                        (_.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'startOfCoverage', null) ? this.api.moment(_.get(mhc, 'startOfCoverage', null)).isAfter('2019-12-31') : null) && _.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'endOfCoverage', null) ? this.api.moment(_.get(mhc, 'endOfCoverage', null)).isAfter('2019-12-31') : null)) ||
                        _.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'endOfCoverage', null) ? this.api.moment(_.get(mhc, 'endOfCoverage', null)).isBetween('2019-01-01', '2019-12-31') : null) ||
                        !_.size(_.get(p, 'medicalHouseContracts', [])) ||
                        (_.size(_.get(p, 'medicalHouseContracts', [])) && !_.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'startOfCoverage', null)) && !_.get(p, 'medicalHouseContracts', []).find(mhc => _.get(mhc, 'endOfCoverage', null)))
                    )
                )
            }

            _getHomeDistribution(){
                let homeDistribution = []
                const patientWithAdr = _.get(this, 'patientList', []).filter(p => _.get(p, 'addresses', []).find(adr => _.get(adr, 'addressType', null) === "home" && _.trim(_.get(adr, 'postalCode', null))  && _.trim(_.get(adr, 'postalCode', null)) !== "")) || []

                this.set("homeDistribution", _.orderBy(_.map(_.groupBy(patientWithAdr.map(pwa => _.head(_.get(pwa, 'addresses', []))), 'postalCode'), a => {
                    return {
                        postalCode: _.get(_.head(a), 'postalCode', null),
                        occurence: _.size(a),
                        rate: parseFloat(((parseInt(_.size(a)) / parseInt(_.size(_.get(this, 'patientList', [])))) * 100).toFixed(2))
                    }
                }), ['rate'], ['desc']))

                console.log(this.homeDistribution)
            }

            _isMoreThanOnePercent(rate){
                return rate && rate >= 1
            }
        }

        customElements.define(HtAdminReportsRash.is, HtAdminReportsRash)
    </script>
</dom-module>
