<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../dynamic-form/ckmeans-grouping.html">
<link rel="import" href="../ht-spinner/ht-spinner.html">

<dom-module id="ht-msg-list">



    <template>



        <custom-style>
            <style include="shared-styles">

                :host {
                    display: flex;
                    flex-direction: column;
                    z-index:0;
                }

                :host *:focus {
                    outline: 0 !important;
                }

                .new-msg-btn{
                    margin: 5px 0 0 10px;
                    box-sizing: border-box;
                    --paper-button-ink-color: var(--app-secondary-color);
                    height: 40px !important;
                    display: block;
                    text-align: center;
                    --paper-button: {
                        background: var(--app-secondary-color);
                        color: var(--app-text-color);
                        width: calc(100% - 48px);
                        margin: 0 auto;
                        font-size: 14px;
                        font-weight: bold;
                        text-transform: capitalize;
                    };
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    overflow: hidden;
                    max-width: 220px;
                    text-transform: uppercase;
                    font-weight: 700;
                }

                .new-msg-btn.disabled{
                    --paper-button: {
                        background: var(--app-background-color-darker);
                        color: var(--app-text-color);
                        width: calc(100% - 48px);
                        font-size: 14px;
                        font-weight: bold;
                    }
                }

                .boxes-list {
                    margin: 20px auto;
                    padding: 0;
                    min-width: 80%;
                }

                .col-right {
                    position: relative;
                    box-sizing: border-box;
                    grid-column: 2 / span 1;
                    grid-row: 1 / span 1;
                    /*background:var(--app-background-color);*/
                    float:left;
                    padding: 12px 20px;
                    padding-top: 0;
                    display:flex;
                    flex-flow: column nowrap;
                    align-items: flex-start;
                    height: calc(100% - 56px);
                    width: calc(100vw - 38%);
                    /*width: calc(100vw - 19%)*/
                }

                .card-title-container{
                    padding: 8px 0;
                    height: 34px;
                }

                .card-title{
                    margin: 0;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    -webkit-font-smoothing: antialiased;
                    font-family: 'Roboto',Helvetica,Arial,sans-serif;
                    font-size: 14px;
                    letter-spacing: .15px;
                    color: var(--app-text-color);
                    font-weight: 500;
                    letter-spacing: 0;
                    line-height: 16px;
                    -webkit-box-ordinal-group: 0;
                    -webkit-order: 0;
                    order: 0;
                }

                .card-title iron-icon{
                    width:16px;
                    width: 16px;
                    color: var(--app-text-color-disabled);
                }

                .has-unread {
                    font-weight: bold;
                }

                paper-item {
                    outline: 0;
                    cursor: pointer;
                    --paper-item: { margin: 0; };
                    font-size:.9em;
                    min-height:36px;
                    --paper-item-selected: { background: rgba(0, 0, 0, 0.1); color: var(--google-green-700); };
                    --paper-item-focused: { background: rgba(0, 0, 0, 0.1); color: var(--google-green-700); };
                    --paper-item-focused-before: { background: rgba(0, 0, 0, 0.1); }
                }

                paper-item:hover {
                    background: rgba(0, 0, 0, 0.1);
                    color:var(--dark-primary-color)
                }

                paper-listbox {
                    width:250px;
                }

                paper-listbox:focus {
                    outline: 0;
                }

                .sublist {
                    padding-left: 20px;
                    outline: 0;

                }

                .sublist paper-item {
                    --paper-item-min-height: 28px;
                }

                vaadin-grid {
                    height: calc(100% - 16px - 32px - 50px);
                    width: 100%;
                    box-shadow: var(--app-shadow-elevation-1);
                    border: none;
                    box-sizing: border-box;
                }

                vaadin-grid.material {
                    outline: 0 !important;
                    font-family: Roboto, sans-serif;
                    background: rgba(0, 0, 0, 0);
                    border: none;
                    --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                    --vaadin-grid-cell: {
                        padding: 8px;
                    };

                    --vaadin-grid-header-cell: {
                        height: 48px;
                        padding: 11.2px;
                        color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                        font-size: 12px;
                        background: rgba(0, 0, 0, 0);
                        border-top: 0;
                    };

                    --vaadin-grid-body-cell: {
                        height: 48px;
                        color: rgba(0, 0, 0, var(--dark-primary-opacity));
                        font-size: 13px;
                    };

                    --vaadin-grid-body-row-hover-cell: {
                        background-color: var(--paper-grey-200);
                    };

                    --vaadin-grid-body-row-selected-cell: {
                        background-color: var(--paper-grey-100);
                    };

                    --vaadin-grid-focused-cell: {
                        box-shadow: none;
                        font-weight: bold;
                    };

                }

                vaadin-grid.material .cell {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    padding-right: 8px;
                }

                vaadin-grid.material .cell.last {
                    padding-right: 8px;
                }

                vaadin-grid.material .cell.numeric {
                    text-align: right;
                }

                vaadin-grid.material paper-checkbox {
                    --primary-color: var(--paper-indigo-500);
                    margin: 0 24px;
                }

                vaadin-grid.material vaadin-grid-sorter {
                    --vaadin-grid-sorter-arrow: {
                        display: none !important;
                    };
                }

                vaadin-grid.material vaadin-grid-sorter .cell {
                    flex: 1;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                vaadin-grid.material vaadin-grid-sorter iron-icon {
                    transform: scale(0.8);
                }

                vaadin-grid.material vaadin-grid-sorter:not([direction]) iron-icon {
                    color: rgba(0, 0, 0, var(--dark-disabled-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction] {
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                }

                vaadin-grid.material vaadin-grid-sorter[direction=desc] iron-icon {
                    transform: scale(0.8) rotate(180deg);
                }

                vaadin-grid.material::slotted(div) {
                    outline: 0 !important;
                    background: red;
                }

                paper-checkbox {
                    --paper-checkbox-unchecked-color: var(--app-text-color);
                    --paper-checkbox-label-color: var(--app-text-color);
                    --paper-checkbox-checked-color: var(--app-secondary-color);
                    --paper-checkbox-checked-ink-color: var(--app-secondary-color-dark);
                }

                .buttons{
                    padding-bottom: 10px;
                }

                .modal-button--delete{
                    box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                    background: var(--app-background-color-light);
                    color: var(--app-primary-color-dark);
                    font-weight: 700;
                }

                .modal-button{
                    box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                    background: var(--app-background-color-light);
                    color: var(--app-primary-color-dark);
                    font-weight: 700;
                }

                .table-top {
                    width: calc(100vw - 38%);
                    /*width: calc(100vw - 19%);*/
                    min-height: 56px;
                    display: flex;
                    flex-direction: row;
                    justify-content: flex-end;
                    padding-top:5px;
                }
                .table-top > .checkbox {
                    width: 16px;
                    margin-left: 20px;
                    display: flex;
                    justify-content: space-around;
                    padding-left: 12px;
                    flex-direction: column;
                }
                .table-top > div {
                    display: flex;
                    flex-direction: row;
                    z-index: 1;
                }
                .table-top > div > div {
                    text-align: center;
                }
                .table-top > div.indicators {
                    justify-content: flex-end;
                    padding-right: 24px;
                }
                .table-top > div.indicators > div {
                    display: flex;
                    flex-direction: column;
                    padding: 8px;
                    justify-content: center;
                }
                .table-top > div.indicators > div > * {
                    margin: 0 auto;
                }
                .table-top > div.indicators > div#stamp-indicator.hasNew span {color: var(--app-error-color);}
                .table-top > div.indicators > div#capacity-indicator > * {
                    display: inline-block;
                }
                .table-top > div.actions {
                    flex-grow: 1;
                    margin: 0 16px;
                }
                .table-top paper-dropdown-menu#filterLabresult {
                    min-width: 256px;
                    margin-left: 22%;
                }

                .table-top > div.actions paper-icon-button {
                    margin: 8px 0;
                }

                .mb4 {
                    margin-bottom: 4px !important;
                }

                .mb4 iron-icon{
                    opacity: 0.7;
                    margin-right: 4px;
                }

                .mb4 span{
                    font-size: 12px;
                    font-weight: 400;
                }

                paper-progress {
                    --paper-progress-active-color: var(--app-secondary-color);
                }

                paper-progress.full {
                    --paper-progress-active-color: var(--app-error-color);
                }

                .errorColor {
                    color: var(--app-error-color);
                }

                .errorColorDark {
                    color: var(--app-error-color-dark);
                }

                #vaadinMessagesGrid {
                    padding-right: 0;
                    margin-right: 0;
                    flex-grow: 1;
                    margin-bottom: 16px;
                    transition: opacity .25s ease;
                }

                #vaadinMessagesGrid iron-icon{
                    color: var(--app-text-color);
                    height: 18px;
                    width: 18px;
                    padding: 0px;
                }

                .labicon {
                    content: '';
                    display: inline-block;
                    height: 8px;
                    width: 8px;
                    margin: 0 auto;
                    border-radius: 50%;
                    background: var(--app-status-color-ok);
                    margin-right:5px;
                }
                .labicon.unassigned-true {
                    background: var(--app-status-color-nok);
                }
                .actions .labicon {
                    margin: 8px;
                }

                .get-msg-btn{
                    margin-bottom: 16px;
                    --paper-button: {
                        background: var(--app-secondary-color);
                        color: var(--app-text-color);
                        width: 100%;
                        margin: 0 auto;
                        font-size: 14px;
                        font-weight: bold;
                        text-transform: capitalize;
                    };
                    --paper-button-ink-color: var(--app-secondary-color-dark);
                }

                paper-icon-button.change-page {
                    cursor: pointer;
                    width: 24px;
                    height: 24px;
                    min-width: 0;
                    padding: 2px;
                    color: var(--app-text-color);
                    margin:0 4px;
                }

                .selector {
                    overflow-x: auto;
                    overflow-y: hidden;
                    white-space: nowrap;
                    max-width: 360px;
                }

                div.bottom-commands {
                    display: flex;
                    width: 100%;
                    justify-content: flex-end;
                    align-items: center;
                }

                div.bottom-commands > div.grid-size-indicator {
                    max-width: 208px;
                    overflow: hidden;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    color: var(--app-text-color);
                    font-size: 13px;
                    font-weight: 400;
                    letter-spacing: 0.3px;
                }

                .scroll-top {
                    background: var(--app-secondary-color);
                    padding: 0 4px;
                    height: 24px;
                    width: 24px;
                    box-sizing: border-box;
                    border-radius: 50%;
                }

                .warn {
                    color: var(--app-status-color-nok);
                }

                @media screen and (max-width:1696px) {
                    .table-top paper-dropdown-menu#filterLabresult {
                        margin-left: 0;
                    }
                }

                @media screen and (max-width:1025px) {
                    .col-right {
                        width: 100vw;
                        transition: all .5s ease;
                        box-shadow: none;
                    }

                    ht-spinner.center {
                        left: 50vw;
                    }
                }

                @media screen and (max-width: 1025px) {
                    div.bottom-commands {
                        justify-content: center;
                    }
                }

                @media screen and (max-width: 800px) {
                    .table-top paper-dropdown-menu#filterLabresult {
                        min-width: 0;
                        margin-left: initial;
                    }
                    .mb4 span {
                        display: none;
                    }
                    
                    #capacity-indicator paper-progress {
                        width: 64px;
                    }

                    .table-top paper-dropdown-menu#filterLabresult {
                        min-width: 0;
                        margin-left: initial;
                    }
                }

                @media screen and (max-width: 640px) {
                    .hideOnMobile {
                        display: none;
                    }
                }

                .bold {
                    font-weight: 700;
                }

                #loadingContainer, #loadingContainerSmall {
                    position:absolute;
                    width: 100%;
                    height: 100%;
                    top: 0;left: 0;
                    background-color: rgba(0,0,0,.3);
                    z-index: 10;
                    text-align: center;
                }

                #loadingContentContainer, #loadingContentContainerSmall {
                    position:relative;
                    width: 400px;
                    min-height: 200px;
                    background-color: #ffffff;
                    padding:20px;
                    border:3px solid var(--app-secondary-color);
                    margin:40px auto 0 auto;
                    text-align: center;
                }

                .sub-container {
                    position:relative;
                }

                .loadingIcon {
                    margin-right:5px;
                }

                .loadingIcon.done {
                    color: var(--app-secondary-color);
                }

                .mr5 {margin-right:5px}
                .ml5 {margin-left:5px}

                .smallIcon { width:16px; height:16px; }

                .modalDialog {
                    height: 300px;
                    width: 600px;
                }

                .modalDialog.modalDialogLarge {
                    height: 500px;
                    width: 800px;
                }

                .modalDialogContent{
                    height: 250px;
                    width: auto;
                    margin: 10px;
                }

                .modalDialog.modalDialogLarge .modalDialogContent{
                    height: 450px;
                }

                .modalDialog.modalDialogLarge .dialogButtons{
                    bottom: 20px;
                    text-align:left;
                }

                .m-t-40 {
                    margin-top:40px;
                }

                .m-t-50 {
                    margin-top:50px!important;
                }

                .m-t-20 {
                    margin-top:20px!important;
                }

                .m-t-25 {
                    margin-top:25px!important;
                }

                .textAlignCenter {
                    text-align: center;
                }

                .dialogButtons {
                    position: absolute;
                    bottom: 40px;
                    margin: 0;
                    width:100%;
                    text-align:center;
                }

                .dialogButtons .modal-button{
                    --paper-button-ink-color: var(--app-secondary-color);
                    background-color: var(--app-secondary-color);
                    color: var(--app-text-color);
                    font-weight: 700;
                    font-size: 14px;
                    height: 40px;
                    min-width: 100px;
                    padding: 10px 1.2em;
                    text-transform: uppercase;
                }

                .dialogButtons .modal-button.grey {
                    --paper-button-ink-color: var(--app-background-color-dark);
                    background-color: var(--app-background-color-dark);
                }

                .fs12 {
                    font-size:12px;
                }

                .m-r-5 {
                    margin-right:5px;
                }

                .m-t-minus-2 {
                    margin-top:-2px;
                }

                .w-20 {
                    width:20px
                }

                .darkRed {
                    color:#a00000!important;
                }

                .modal-title {
                    background: var(--app-background-color-dark);
                    margin-top: 0;
                    padding: 16px 24px;
                }

                .eHealthBoxProcessErrorMessage {
                    border: 1px dashed #999999;
                    padding: 10px 10px 0 10px;
                    margin-top: 10px;
                    max-height: 240px;
                    overflow: auto;
                }

                .eHealthBoxProcessErrorMessage p {
                    margin:0 0 5px 0;
                    border-bottom:1px dashed #dddddd;
                    padding-bottom:5px;
                }

                .eHealthBoxProcessErrorMessage p:last-child {
                    border-bottom:0;
                }

                .italic {
                    font-style:italic;
                }

                .fs9em {
                    font-size:.9em;
                }

                .fs8em {
                    font-size:.8em;
                }

                .displayBlock {
                    display: block;
                }

                .header {
                    padding: 10px;
                    color: #ffffff;
                    text-transform: uppercase;
                    margin: 0;
                    font-weight: 700;
                    background-color: #777777;
                    cursor: pointer;
                }

                #messagesFilters {
                    margin:0 auto;
                }

                #messagesFiltersDropDown {
                    margin-top:4px;
                    width:250px;
                }

                #messagesFiltersDropDown hr {
                    margin: 5px 10px;
                    border: 0;
                    border-top: 1px dashed #aaaaaa;
                }

                .w20 {
                    width:20px;
                }

                .h20 {
                    height:20px;
                }

                .w22 {
                    width:22px;
                }

                .modal-button-right {
                    float:right;
                    margin-right:55px;
                }

                .darkBlue {
                    color:var(--dark-primary-color)!important;
                }

                .darkGreen {
                    color:#41671e!important
                }

                .visibilityHidden {
                    visibility:hidden;
                }

            </style>
        </custom-style>



        <template is="dom-if" if="[[_bodyOverlay]]">
            <div id="loadingContainer"></div>
        </template>
        <template is="dom-if" if="[[_isLoading]]">
            <div id="loadingContainer">
                <div id="loadingContentContainer">
                    <div style="max-width:100px; margin:0 auto"><ht-spinner class="spinner" alt="Loading..." active></ht-spinner></div>
                    <div id="loadingContent"></div>
                </div>
            </div>
        </template>



        <div class="table-top">

            <div class="actions">

                <template is="dom-if" if="[[_haveGridSelectedMessages]]">
                    <template is="dom-if" if="[[!_isEqual(menuSelectionObject.selection.folder,'deleted')]]"><template is="dom-if" if="[[!_isEqual(menuSelectionObject.selection.folder,'hidden')]]"><paper-icon-button id="hidebutton" icon="visibility-off" on-tap="_hideUnHideMessages"></paper-icon-button><paper-tooltip for="hidebutton" offset="0">[[localize('ehb.hideMessages','Hide messages',language)]]</paper-tooltip></template></template>
                    <template is="dom-if" if="[[_isEqual(menuSelectionObject.selection.folder,'hidden')]]"><paper-icon-button id="restoreHiddenMessagesButton" icon="undo" on-tap="_hideUnHideMessages"></paper-icon-button><paper-tooltip for="restoreHiddenMessagesButton" offset="0">[[localize('ehb.restoreHiddenMessages','Restore hidden messages',language)]]</paper-tooltip></template>
                    <template is="dom-if" if="[[!_isEqual(menuSelectionObject.selection.folder,'deleted')]]"><paper-icon-button id="del-button" icon="delete" on-tap="_deletedUndeleteMessages"></paper-icon-button></template>
                    <template is="dom-if" if="[[_isEqual(menuSelectionObject.selection.folder,'deleted')]]"><paper-icon-button id="restore-button" icon="undo" on-tap="_deletedUndeleteMessages"></paper-icon-button><paper-icon-button id="del-for-button" icon="delete-forever" on-tap="_confirmDeleteMessagesForEver"></paper-icon-button></template>
                    <paper-icon-button id="flagAsUnreadButton" icon="markunread-mailbox" on-tap="_flagAsUnred"></paper-icon-button><paper-tooltip for="flagAsUnreadButton" offset="0">[[localize('ehb.flagAsUnread','Flag as unread',language)]]</paper-tooltip>
                </template>

                <template is="dom-if" if="[[!_haveGridSelectedMessages]]"><paper-icon-button id="refresh-button" icon="icons:refresh" on-tap="_triggerGetEHealthBoxData"></paper-icon-button></template>
                <paper-button id="new-msg-btn" class$="new-msg-btn [[_disabledCssClassWhenNoeHealthSession]]" on-tap="_createNewMessage">
                    <template is="dom-if" if="[[!ehealthSession]]"><iron-icon icon="icons:block" class="m-r-5 m-t-minus-2 w-20 darkRed"></iron-icon></template>
                    <template is="dom-if" if="[[ehealthSession]]"><iron-icon icon="icons:mail" class="m-r-5 m-t-minus-2 w-20"></iron-icon></template>
                    [[localize('new_mes','New Message',language)]]
                </paper-button>


                <div id="messagesFilters">
                    <paper-dropdown-menu id="messagesFiltersDropDown" label="[[localize('filterMessages','Filter messages',language)]]" no-label-float selected-item="{{_messageFilterSelectedItem}}">
                        <paper-listbox slot="dropdown-content">
                            <paper-item data-filter="" id="allMessagesFilter"><iron-icon icon="icons:home" class="m-r-5 w22"></iron-icon>[[localize('ehb.all','All',language)]]</paper-item>
                            <hr />
                            <paper-item data-filter="read"><iron-icon icon="icons:visibility" class="m-r-5 w22"></iron-icon>[[localize('ehb.read','Read',language)]]</paper-item>
                            <paper-item data-filter="unread"><iron-icon icon="icons:visibility-off" class="m-r-5 w22"></iron-icon>[[localize('ehb.unread','Unread',language)]]</paper-item>
                            <hr />
                            <paper-item data-filter="withAttachment"><iron-icon icon="editor:attach-file" class="m-r-5 w22"></iron-icon>[[localize('ehb.withAttachments','With attachments',language)]]</paper-item>
                            <paper-item data-filter="withoutAttachment"><iron-icon icon="icons:check-box-outline-blank" class="m-r-5 w22"></iron-icon>[[localize('ehb.withoutAttachments','Without attachments',language)]]</paper-item>
                            <hr />
                            <paper-item data-filter="important"><iron-icon icon="icons:arrow-upward" class="m-r-5 w22"></iron-icon>[[localize('ehb.important','High importance',language)]]</paper-item>
                            <paper-item data-filter="notImportant"><iron-icon icon="icons:arrow-downward" class="m-r-5 w22"></iron-icon>[[localize('ehb.notImportant','Low importance',language)]]</paper-item>
                            <hr />
                            <paper-item data-filter="assignedResults"><iron-icon icon="icons:folder-shared" class="m-r-5 w22"></iron-icon>[[localize('ehb.assignedResults','Assigned results',language)]]</paper-item>
                            <paper-item data-filter="unassignedResults"><iron-icon icon="icons:folder-open" class="m-r-5 w22"></iron-icon>[[localize('ehb.unassignedResults','Unassigned results',language)]]</paper-item>
                            <paper-item data-filter="labResults"><iron-icon icon="icons:assignment" class="m-r-5 w22"></iron-icon>[[localize('ehb.labResults','Lab results',language)]]</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                </div>

            </div>

            <div class="indicators">

                <template is="dom-if" if="[[!_isEqual(nbrMessagesInStandBy,0)]]">
                    <div id="stamp-indicator" class="stamp-indicator hasNew errorColor"><iron-icon icon="warning" class="errorColor"></iron-icon><span class="label errorColor fs12">[[nbrMessagesInStandBy]] [[localize('pendingMessages','Pending messages',language)]]</span></div>
                    <paper-tooltip for="stamp-indicator" offset="0">[[localize('becauseEhBoxIsFull','Because your e-Health Box is full',language)]]</paper-tooltip>
                </template>

                <div id="capacity-indicator">
                    <div class="mb4"><iron-icon icon="cloud"></iron-icon>
                        <span>
                            <template is="dom-if" if="[[ehealthSession]]">[[localize('mail_cap','mailbox capacity',language)]] ([[currentCapacityPercentage]]%)</template>
                            <template is="dom-if" if="[[!ehealthSession]]"><span class="warn">[[localize('ehe_is_not_con','eHealth is not connected',language)]]</span></template>
                        </span>
                    </div>
                    <template is="dom-if" if="[[ehealthSession]]"><paper-progress value$="[[currentCapacityPercentage]]" min="0" max="100" class$="[[_ehBoxCurrentSizeColor]]"></paper-progress></template>
                </div>

                <template is="dom-if" if="[[ehealthSession]]">
                    <paper-tooltip for="capacity-indicator" offset="0">[[currentStorageCapacity]]%</paper-tooltip>
                </template>

            </div>

        </div>

        <div class="second-panel col-right">

            <vaadin-grid
                id="vaadinMessagesGrid"
                class="material"
                width="100%"
                items="[[_vaadinGridDataToShow]]"
                active-item="{{_vaadinGridMessagesActiveItem}}"
                pageSize="[[_vaadinGridMaxItemsPerPage]]"
                on-selected-items-changed="_gridSelectedItemsChanged"
            >

                <vaadin-grid-selection-column></vaadin-grid-selection-column>

                <!--
                <vaadin-grid-column width="80px" flex-grow="0">
                    <template class="header"></template>
                    <template>
                        <template is="dom-if" if="[[_isCrypted(item)]]"><iron-icon icon="lock" class=""></iron-icon></template>
                        <template is="dom-if" if="[[_isImportant(item)]]"><iron-icon icon="warning" class=""></iron-icon></template>
                        <template is="dom-if" if="[[_hasAnnex(item)]]"><iron-icon icon="editor:attach-file" class=""></iron-icon></template>
                    </template>
                </vaadin-grid-column>
                -->

                <vaadin-grid-column flex-grow="1">
                    <template is="dom-if" if="[[!_isEqual(menuSelectionObject.selection.folder,'sent')]]"><template class="header"><vaadin-grid-sorter path="fromAddress"><b>[[localize('sen','Sender',language)]]</b></vaadin-grid-sorter></template></template>
                    <template is="dom-if" if="[[_isEqual(menuSelectionObject.selection.folder,'sent')]]"><template class="header"><vaadin-grid-sorter path="fromAddress"><b>[[localize('rec','Recipient',language)]]</b></vaadin-grid-sorter></template></template>
                    <template>
                        <div class$="cell [[_boldIfIsUnread(item)]]">
                            <template is="dom-if" if="[[_isImportant(item)]]"><iron-icon icon="warning" class="darkRed"></iron-icon></template>
                            <template is="dom-if" if="[[!_isImportant(item)]]"><iron-icon icon="warning" class="darkGreen"></iron-icon></template>
                            <template is="dom-if" if="[[_hasAnnex(item)]]"><iron-icon icon="editor:attach-file" class="m-r-5 darkBlue"></iron-icon></template>
                            <template is="dom-if" if="[[!_hasAnnex(item)]]"><iron-icon icon="editor:attach-file" class="m-r-5 visibilityHidden"></iron-icon></template>
                            <template is="dom-if" if="[[!_isEqual(menuSelectionObject.selection.folder,'sent')]]">[[item.fromAddress]]</template>
                            <template is="dom-if" if="[[_isEqual(menuSelectionObject.selection.folder,'sent')]]">[[_formatRecipientDetailsForSentFolder(item)]]</template>
                        </div>
                    </template>
                </vaadin-grid-column>

                <vaadin-grid-column flex-grow="1">
                    <template class="header"><vaadin-grid-sorter path="subject">[[localize('sub','Subject',language)]]</vaadin-grid-sorter></template>
                    <template><div class$="cell [[_boldIfIsUnread(item)]]">[[item.subject]]</div></template>
                </vaadin-grid-column>

                <vaadin-grid-column flex-grow="1">
                    <template class="header">[[localize('pat','Patient',language)]]</template>
                    <template>
                        <template is="dom-repeat" items="[[item.patientInfosBasedOnResultInfo]]" as="patientInfos">
                            <div class$="singlePatientInfo [[_boldIfIsUnread(item)]]">
                                <template is="dom-if" if="[[patientInfos.isAssigned]]"><div id="hasLab-[[patientInfos.uniqueId]]" class="labicon"></div><paper-tooltip position="right" for="hasLab-[[patientInfos.uniqueId]]">[[localize('assigned_labresults','Assigned lab results',language)]]</paper-tooltip></template>
                                <template is="dom-if" if="[[!patientInfos.isAssigned]]"><div id="hasLab-[[patientInfos.uniqueId]]" class="labicon unassigned-true"></div><paper-tooltip position="right" for="hasLab-[[patientInfos.uniqueId]]">[[localize('unassigned_labresults','Unassigned lab results',language)]]</paper-tooltip></template>
                                [[patientInfos.lastName]]
                                [[patientInfos.firstName]]
                                [[patientInfos.dateOfBirthHr]]
                            </div>
                        </template>
                    </template>
                </vaadin-grid-column>

                <vaadin-grid-column width="100px" flex-grow="0">
                    <template class="header"><vaadin-grid-sorter path="created" direction="asc">[[localize('dat','Date',language)]]</vaadin-grid-sorter></template>
                    <template><div class$="cell [[_boldIfIsUnread(item)]]">[[_msTstampToDDMMYYYY(item.created)]]</div></template>
                </vaadin-grid-column>

            </vaadin-grid>

            <div class="bottom-commands">
                <div class="grid-size-indicator hideOnMobile"> [[pageStart]] – [[pageEnd]] [[localize('sur','sur',language)]] [[_totalMessagesForCurrentFolderAndCurrentFilter]]</div>
                <paper-icon-button id="previous-page-change" icon="chevron-left"class="change-page" on-tap="_gotoPreviousGridPage"></paper-icon-button>
                <paper-icon-button id="next-page-change" icon="chevron-right" class="change-page" on-tap="_gotoNextGridPage"></paper-icon-button>
                <div class="hideOnMobile"><paper-icon-button id="scrolltop" class="scroll-top" icon="arrow-upward" on-tap="_scrollToTop"></paper-icon-button></div>
            </div>

        </div>



        <paper-dialog class="modalDialog" id="confirmPermanentDeletionDialog" no-cancel-on-outside-click no-cancel-on-esc-key>
            <h2 class="modal-title"><iron-icon icon="icons:warning"></iron-icon> [[localize('warning','Warning',language)]]</h2>
            <div class="modalDialogContent m-t-50">
                <h3 class="textAlignCenter">[[localize('confirmDeletePermanently','Are you sure you wish to delete PERMANENTLY ?',language)]]</h3>
                <p class="textAlignCenter m-t-20">[[localize('cantBeUndone',"This can't be undone",language)]].</p>
            </div>
            <div class="dialogButtons">
                <paper-button class="modal-button grey" on-tap="_closeDialogs"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('can','Cancel',language)]]</paper-button>
                <paper-button class="modal-button" on-tap="_deleteMessagesForEver"><iron-icon icon="check-circle" class="mr5 smallIcon" ></iron-icon> [[localize('confirm','Confirm',language)]]</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog class="modalDialog" id="notConnctedToeHealthBox" no-cancel-on-outside-click no-cancel-on-esc-key>
            <h2 class="modal-title"><iron-icon icon="icons:warning"></iron-icon> [[localize('warning','Warning',language)]]</h2>
            <div class="modalDialogContent m-t-50">
                <h3 class="textAlignCenter">[[localize('notConnctedToeHealthBox','You are not connected to your eHealthBox yet',language)]]</h3>
                <p class="textAlignCenter m-t-20">[[localize('someFunctionalitiesAreDisabled','Some functionalities are disabled',language)]].</p>
            </div>
            <div class="dialogButtons">
                <paper-button class="modal-button" on-tap="_closeDialogs"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog class="modalDialog modalDialogLarge" id="errorWithEHealthBoxProcessing" no-cancel-on-outside-click no-cancel-on-esc-key>
            <h2 class="modal-title"><iron-icon icon="icons:warning"></iron-icon> [[localize('errorDealingWithYourRequest','An error occurred while processing your request',language)]]</h2>
            <div class="modalDialogContent m-t-25">
                <div class="m-t-25 bold">[[localize('followingMessagesCouldNotBeDeletedRestored','Following message(s) could not be deleted / restored',language)]]:</div>

                <div class="eHealthBoxProcessErrorMessage">
                    <template is="dom-repeat" items="[[_eHealthBoxProcessErrorMessages]]" as="singleErrorMessage" id="eHealthBoxProcessErrorMessageDomRepeat">
                        <p>
                            <span class="fs9em bold italic displayBlock "><iron-icon icon="icons:mail" class="errorColorDark"></iron-icon> [[singleErrorMessage.subject]]</span>
                            <span class="fs8em displayBlock">[[[_msTstampToDDMMYYYY(singleErrorMessage.created)]]] [[singleErrorMessage.fromAddress]]</span>
                        </p>
                    </template>
                </div>

                <p class=" m-t-25 bold">[[localize('toContactUs','To contact us',language)]]: <iron-icon icon="communication:phone" class="mr5 ml5 smallIcon colorAppSecondaryColorDark" ></iron-icon> <a href="tel:+3223192241" class="textDecorationNone">+32(0)2/319.22.41</a> - <iron-icon icon="icons:mail" class="mr5 smallIcon colorAppSecondaryColorDark" ></iron-icon> <a href="mailto:support@topaz.care" class="textDecorationNone">support@topaz.care</a>.</p>
            </div>
            <div class="dialogButtons">
                <paper-button class="modal-button" on-tap="_closeDialogs"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                <paper-button class="modal-button modal-button-right" on-tap="_moveErrorMessagesToHiddenFolder"><iron-icon icon="icons:visibility-off" class="mr5 smallIcon" ></iron-icon> [[localize('moveMessagesToHiddenFolder','Move messages to hidden box',language)]]</paper-button>
            </div>
        </paper-dialog>
        <paper-dialog class="modalDialog" id="errorGettingEHealthBoxMessages" no-cancel-on-outside-click no-cancel-on-esc-key>
            <h2 class="modal-title"><iron-icon icon="icons:warning"></iron-icon> [[localize('warning','Warning',language)]]</h2>
            <div class="modalDialogContent m-t-50">
                <h3 class="textAlignCenter">[[localize('errorGettingEHealthBoxMessages','An error occurred while getting your messages',language)]]</h3>
                <p class="textAlignCenter m-t-20">[[localize('pleaseReloadPageOrApp','Please reload the page / the application',language)]]</p>
            </div>
            <div class="dialogButtons">
                <paper-button class="modal-button" on-tap="_closeDialogs"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>



    </template>



    <script>

        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import * as models from 'icc-api/dist/icc-api/model/models'

        class HtMsgList extends Polymer.TkLocalizerMixin(Polymer.Element) {

            static get is() {
                return 'ht-msg-list';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        noReset: true
                    },
                    _vaadinGridMessagesActiveItem: {
                        type: Object,
                        value: null
                    },
                    _vaadinGridDataToShow: {
                        type: Array,
                        value: () => []
                    },
                    menuSelectionObject: {
                        type: Object
                    },
                    i18n: {
                        Type: Object,
                        value: function () {
                            moment.locale('fr');
                            const res = {
                                monthNames: moment.months(),
                                weekdays: moment.weekdays(),
                                weekdaysShort: moment.weekdaysShort(),
                                firstDayOfWeek: moment.localeData().firstDayOfWeek(),
                                week: 'Semaine',
                                calendar: 'Calendrier',
                                clear: 'Clear',
                                today: 'Aujourd\'hui',
                                cancel: 'Annuler',
                                formatDate: function (d) {
                                    //return moment(d).format(moment.localeData().longDateFormat('L'))
                                    return moment(d).format('DD/MM/YYYY');
                                },
                                parseDate: function (s) {
                                    return moment(s, 'DD/MM/YYYY').toDate();
                                },
                                formatTitle: function (monthName, fullYear) {
                                    return monthName + ' ' + fullYear;
                                }
                            };
                            return res;
                        },
                        noReset: true
                    },
                    _currentPageNumber: {
                        type: Number,
                        value: 1
                    },
                    nbrMessagesInStandBy: {
                        type: Number,
                        value: 0
                    },
                    ehBoxCurrentSize: {
                        type: Number,
                        value: 0
                    },
                    ehboxMaxStorageCapacity: {
                        type: Number,
                        value: 10485760 // 1024^2 - 10Mb
                    },
                    currentCapacityPercentage: {
                        type: Number,
                        value: 0
                    },
                    selectedLabFilter: {
                        type: Number,
                            value: 0
                    },
                    currentStorageCapacity: {
                        type: Number,
                        value: 0
                    },
                    _totalMessagesForCurrentFolderAndCurrentFilter: {
                        type: Number,
                        value: 0
                    },
                    _totalPagesForCurrentFolderAndCurrentFilter: {
                        type: Number,
                        value: 1
                    },
                    ehealthSession: {
                        type: Boolean,
                        value: false,
                        noReset: true
                    },
                    pageStart: {
                        type: Number,
                        value: 0
                    },
                    pageEnd: {
                        type: Number,
                        value: 50
                    },
                    _bodyOverlay: {
                        type: Boolean,
                        value: false
                    },
                    _loadingMessages: {
                        type: Array,
                        value: () => []
                    },
                    _isLoading: {
                        type: Boolean,
                        value: false,
                        observer: '_loadingStatusChanged'
                    },
                    _vaadinGridMaxItemsPerPage: {
                        type: Number,
                        value: 50
                    },
                    _ehBoxCurrentSizeColor: {
                        type: String,
                        value: ""
                    },
                    _disabledCssClassWhenNoeHealthSession: {
                        type: String,
                        value: ""
                    },
                    _haveGridSelectedMessages: {
                        type: Boolean,
                        value: false
                    },
                    _eHealthBoxProcessErrorMessages: {
                        type: Array,
                        value: () => []
                    },
                    _getEHealthBoxDataLastRefreshTstamp:{
                        type: Number,
                        value: 0
                    },
                    _cachedMessagesData: {
                        type: Object,
                        value: () => {
                            return {
                                "inbox": [],
                                "sent": [],
                                "hidden": [],
                                "deleted": []
                            }
                        }
                    },
                    currentHcp: {
                        type: Object,
                        value: {}
                    },
                    parentHcp: {
                        type: Object,
                        value: {}
                    },
                    isAMedicalHouse: {
                        type: Boolean,
                        value: false
                    },
                    isParentAMedicalHouse: {
                        type: Boolean,
                        value: false
                    },
                    medicalHouseBillingTypeIsFlatRate: {
                        type: Boolean,
                        value: false
                    },
                    _messageFilterSelectedItem: {
                        type: Object,
                        value: {}
                    },
                    _eHealthBoxLastFolder: {
                        type: String,
                        value: "inbox"
                    },
                    _messageFilterLastSelectedItem: {
                        type: String,
                        value: ""
                    }
                };
            }

            constructor() {
                super();
            }

            static get observers() {
                return [
                    '_setIsConnectedToEhbox(api.tokenId)',
                    '_getEHealthBoxData(menuSelectionObject,_messageFilterSelectedItem,_currentPageNumber)',
                    '_getEHealthBoxData(currentHcp)',
                    '_vaadinGridActiveItemChanged(_vaadinGridMessagesActiveItem)',
                ];
            }
            
            ready() {
                super.ready();
            }

            _loadingStatusChanged() {
                if(!this._isLoading) this._resetLoadingMessage();
            }

            _resetLoadingMessage() {
                this._loadingMessages = [];
            }

            _setLoadingMessage( messageData ) {
                setTimeout(()=> {
                    if (messageData.updateLastMessage) this._loadingMessages.pop();
                    this._loadingMessages.push(messageData);
                    let loadingContentTarget = this.shadowRoot.querySelectorAll('#loadingContent')[0];
                    if (loadingContentTarget) { loadingContentTarget.innerHTML = ''; _.each(this._loadingMessages, (v) => { loadingContentTarget.innerHTML += "<p><iron-icon icon='" + v.icon + "' class='" + (v.done ? "loadingIcon done" : "loadingIcon") + "'></iron-icon>" + v.message + "</p>"; }); }
                },100)
            }

            _setIsConnectedToEhbox() {
                this.set("ehealthSession", !!this.api.tokenId)
                this.set("_disabledCssClassWhenNoeHealthSession", !!this.api.tokenId ? "" : "disabled")
            }
            
            _isUnread(m) {
                return ((m.status & (1 << 1)) !== 0)
            }

            _boldIfIsUnread(m) {
                return this._isUnread(m) ? "bold" : "";
            }
            
            _isImportant(m) {
                return ((m.status & (1 << 2)) !== 0)
            }

            _isCrypted(m) {
                return ((m.status & (1 << 3)) !== 0)
            }

            _hasAnnex(m) {
                return ((m.status & (1 << 4)) !== 0)
            }
            
            _getGridSelectedItems() {
                return _.get(this.shadowRoot.querySelector('#vaadinMessagesGrid'), "selectedItems", []);
            }

            _resetGridSelectedItems() {
                const vaadinMessagesGrid = this.shadowRoot.querySelector('#vaadinMessagesGrid');
                vaadinMessagesGrid.selectedItems = []
                this.set('_haveGridSelectedMessages',false)
            }

            _clearGridCache() {
                const vaadinMessagesGrid = this.shadowRoot.querySelector('#vaadinMessagesGrid');
                vaadinMessagesGrid && vaadinMessagesGrid.clearCache()
            }

            _gridSelectedItemsChanged(e) {
                this.set("_haveGridSelectedMessages", !!_.size(this._getGridSelectedItems()))
            }

            _isEqual(a,b) {
                return !!(a === b)
            }

            _getBoxCapacity() {
                return !(_.get(this,"api.keystoreId",false) && _.get(this,"api.tokenId",false) && _.get(this,"api.credentials.ehpassword",false)) ?
                    Promise.resolve() :
                    this.api.fhc().Ehboxcontroller().getInfosUsingGET(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword)
                        .then(boxInfo=>{
                            this.set('nbrMessagesInStandBy',parseInt(_.get(boxInfo,"nbrMessagesInStandBy",0)))
                            this.set('ehBoxCurrentSize',parseInt(_.get(boxInfo,"currentSize",0)))
                            this.set('ehboxMaxStorageCapacity',parseInt(_.get(boxInfo,"maxSize",10485760))) // 1024^2 - 10 Mb
                            this.set('currentStorageCapacity',((this.ehBoxCurrentSize / this.ehboxMaxStorageCapacity)*100).toFixed(2))
                            if (this.currentStorageCapacity > 90) this.set('_ehBoxCurrentSizeColor','full')
                            this.set('currentCapacityPercentage', this.currentStorageCapacity <= 100 ? this.currentStorageCapacity : '100+')
                        })
                        .catch(e=>console.log("ERROR with _getBoxCapacity: ", e))
                        .finally(()=>Promise.resolve())
            }

            _scrollToTop() {
                const grid = this.shadowRoot.getElementById('vaadinMessagesGrid')
                return grid && setTimeout(()=>grid._scrollToIndex(0),250)
            }

            _triggerGridResize() {
                const vaadinMessagesGrid = this.shadowRoot.querySelector('#vaadinMessagesGrid');
                vaadinMessagesGrid && vaadinMessagesGrid.notifyResize()
            }

            _msTstampToDDMMYYYY(msTstamp) {
                return parseInt(msTstamp) ? this.api.moment(parseInt(msTstamp)).format('DD/MM/YYYY') : ""
            }

            _toggleProcessingPopup( inputMessage="" ) {
                if(!_.get(this,"_isLoading",false)) {
                    this._resetLoadingMessage();
                    this.set('_isLoading', true );
                    this._setLoadingMessage({ message: _.trim(inputMessage) ? _.trim(inputMessage) : this.localize('ongoingProcess',this.language), icon:"arrow-forward"});
                } else {
                    this.set('_isLoading', false );
                }
            }

            _confirmDeleteMessagesForEver() {

                const selectedMessages = this._getGridSelectedItems()
                if(!_.size(selectedMessages)) return

                this.set("_bodyOverlay", true);
                this.$["confirmPermanentDeletionDialog"].open()

            }
            
            _closeDialogs() {
                this.set("_bodyOverlay", false);
                _.map( this.shadowRoot.querySelectorAll('.modalDialog'), i=> i && typeof i.close === "function" && i.close() )
            }

            _menuSelectionChanged(menuSelectionObject) {
                this._resetGridSelectedItems();
            }

            _createNewMessage(){

                // No eHealthBox ?
                if (!_.get(this,"ehealthSession",false)) { this.set("_bodyOverlay", true); this.$["notConnctedToeHealthBox"].open(); return; }

                this.dispatchEvent(new CustomEvent('create-new-msg', { detail: {},params: null}));
            }

            _closeReadMessageComponent() {
                this.set("_vaadinGridMessagesActiveItem",null)
                this.dispatchEvent(new CustomEvent('selected-message-changed', { detail:{selection:{item:null}}}))
                return Promise.resolve()
            }

            assignResolvedObjects(inputObjects) {
                _.map(inputObjects, (v,k)=> this.set(k,v))
            }

            _moveErrorMessagesToHiddenFolder() {
                this._closeDialogs();
                const messagesToHide = _.cloneDeep(this._eHealthBoxProcessErrorMessages)
                this.set("_eHealthBoxProcessErrorMessages",[])
                this._hideUnHideMessages(_.compact(_.filter(messagesToHide, i=>!(_.get(i,"status",0)&(1<<14)))), {metas:{deletionFromeHealthBoxFailed:true}}); // Hide when not already
            }

            _resetMessagesFilters() {
                if(this.shadowRoot.querySelector('#allMessagesFilter') && typeof _.get(this.shadowRoot.querySelector('#allMessagesFilter'),"click",false) === "function" ) { try { this.shadowRoot.querySelector('#allMessagesFilter').click() } catch(e){} }
            }

            _updateCachedMessagesDataStructure(modifiedMessages) {

                const idsOfMessagesToRemove = _.compact(_.map(_.compact(modifiedMessages),i=>_.trim(_.get(i,"message.id",""))))
                let cachedMessagesDataCopy = _.cloneDeep(_.get(this,"_cachedMessagesData",{}))
                let newCachedMessagesData =_.fromPairs(_.map(_.keys(cachedMessagesDataCopy), i=>[i,[]]))

                // Drop from current folder
                _.map(cachedMessagesDataCopy, (messagesOfFolder,cacheFolderName)=> newCachedMessagesData[cacheFolderName] = _.compact(_.remove(messagesOfFolder, i=>idsOfMessagesToRemove.indexOf(_.trim(_.get(i,"id","")))===-1)))

                // Assign to new folder
                _.map(modifiedMessages,i=>{
                    const modifyAction = _.trim(_.get(i,"action",""))
                    const singleMessage = _.get(i,"message",{})
                    const messageBox = _.trim(_.get(_.trim(_.get(singleMessage,"transportGuid","")).split(":"),"[0]",""))
                    const isHidden = !!(_.get(singleMessage,"status",0)&(1<<14))
                    return (
                        modifyAction === "hide" ? newCachedMessagesData.hidden.push(singleMessage) :
                        modifyAction === "unhide" && messageBox === "INBOX" ? newCachedMessagesData.inbox.push(singleMessage) :
                        modifyAction === "unhide" && messageBox === "SENTBOX" ? newCachedMessagesData.sent.push(singleMessage) :
                        modifyAction === "delete" ? newCachedMessagesData.deleted.push(singleMessage) :
                        modifyAction === "undelete" && isHidden ? newCachedMessagesData.hidden.push(singleMessage) :
                        modifyAction === "undelete" && !isHidden && messageBox === "INBOX" ? newCachedMessagesData.inbox.push(singleMessage) :
                        modifyAction === "undelete" && !isHidden && messageBox === "SENTBOX" ? newCachedMessagesData.sent.push(singleMessage) :
                        modifyAction === "unread" || modifyAction === "read" ? newCachedMessagesData[_.trim(_.get(this,"menuSelectionObject.selection.folder","inbox"))].push(singleMessage) :
                        false
                    )
                })

                _.map(newCachedMessagesData, (v,k) => newCachedMessagesData[k] = _.chain(v).compact().orderBy(['created','transportGuid'],['desc','desc']).value())
                this.set("_cachedMessagesData", newCachedMessagesData)
                return Promise.resolve()

            }

            _hideUnHideMessages(givenMessages=null,additionalDataForMessagesToUpdate=null) {

                let selectedMessages = _.size(givenMessages) && !( givenMessages instanceof Event) ? givenMessages : this._getGridSelectedItems()
                selectedMessages = !_.size(additionalDataForMessagesToUpdate) || !!_.size(_.get(additionalDataForMessagesToUpdate,"sourceEvent",false)) ? selectedMessages : _.map(selectedMessages, i=>_.merge(i,additionalDataForMessagesToUpdate))
                if(!_.size(selectedMessages)) return Promise.resolve()

                this._toggleProcessingPopup();

                let prom = Promise.resolve([]);
                selectedMessages.map(singleSelectedMessage => {
                    prom = prom.then(promisesCarrier => {
                        const isAlreadyHidden = !!(_.get(singleSelectedMessage,"status",0)&(1<<14))
                        const newMessageStatus = isAlreadyHidden ? (_.get(singleSelectedMessage,"status",0)^(1<<14)) : (_.get(singleSelectedMessage,"status",0)|(1<<14))
                        return !_.trim(_.get(singleSelectedMessage,"id","")) ? Promise.resolve() : this.api.message().modifyMessage(_.merge(singleSelectedMessage, {status:newMessageStatus})).then(modifiedMessage=>_.concat(promisesCarrier, {action:isAlreadyHidden?"unhide":"hide", message:modifiedMessage})).catch(e=>{console.log("ERROR with modifyMessage: ", e); return Promise.resolve();})
                    })
                })

                return prom
                    .then(promisesCarrier=>this._updateCachedMessagesDataStructure(promisesCarrier))
                    .catch(e=>console.log("ERROR with _hideMessages: ",e))
                    .finally(()=>{
                        this._toggleProcessingPopup();
                        this._getEHealthBoxData();
                        return Promise.resolve()
                    })

            }

            _flagAsUnred() {

                const selectedMessages = _.filter(this._getGridSelectedItems(),i=>!(_.get(i,"status",0) & (1 << 1)))
                if(!_.size(selectedMessages)) return

                this._toggleProcessingPopup();

                let prom = Promise.resolve([]);
                selectedMessages.map(singleSelectedMessage => {
                    prom = prom.then(promisesCarrier => !_.trim(_.get(singleSelectedMessage,"id","")) ? Promise.resolve() : this.api.message().modifyMessage(_.merge(singleSelectedMessage, {status:(_.get(singleSelectedMessage,"status",0)|(1<<1))})).then(modifiedMessage=>_.concat(promisesCarrier, {action:"unread", message:modifiedMessage})).catch(e=>{console.log("ERROR with modifyMessage: ", e); return Promise.resolve();}))
                })

                return prom
                    .then(promisesCarrier=>this._updateCachedMessagesDataStructure(promisesCarrier))
                    .catch(e=>console.log("ERROR with _hideMessages: ",e))
                    .finally(()=>{
                        this._toggleProcessingPopup();
                        this._getEHealthBoxData();
                    })

            }

            _deletedUndeleteMessages(givenMessages=null) {

                // No eHealthBox ?
                if (!_.get(this,"ehealthSession",false)) { this.set("_bodyOverlay", true); this.$["notConnctedToeHealthBox"].open(); return Promise.resolve(); }

                let selectedMessages = _.size(givenMessages) && !( givenMessages instanceof Event) ? givenMessages : this._getGridSelectedItems()
                if(!_.size(selectedMessages)) return Promise.resolve()

                this._toggleProcessingPopup()

                let prom = Promise.resolve([]);
                selectedMessages.map(singleSelectedMessage => {
                    prom = prom.then(promisesCarrier => {
                        const sourceBox = _.trim(_.get(_.trim(_.get(singleSelectedMessage,"transportGuid","")).split(':'), "[0]", ""))
                        const destinationBox = sourceBox === "INBOX" ? "BININBOX" : sourceBox === "SENTBOX" ? "BINSENTBOX" : sourceBox === "BININBOX" ? "INBOX" : sourceBox === "BINSENTBOX" ? "SENTBOX" : false
                        const eHealthBoxMessageId = _.trim(_.get(_.trim(_.get(singleSelectedMessage,"transportGuid","")).split(':'), "[1]", ""))
                        const action = sourceBox === "INBOX" || sourceBox === "SENTBOX" ? "delete" : "undelete"
                        return !eHealthBoxMessageId || !sourceBox || !destinationBox || !_.get(this,"api.keystoreId",false) || !_.get(this,"api.tokenId",false) || !_.get(this,"api.credentials.ehpassword",false) ?
                            false :
                            this.api.fhc().Ehboxcontroller().moveMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [eHealthBoxMessageId], sourceBox, destinationBox)
                                .then(()=> this.api.message().modifyMessage(_.merge(singleSelectedMessage, {transportGuid:destinationBox+":"+eHealthBoxMessageId})).then(modifiedMessage=>_.concat(promisesCarrier, {action:action, message:modifiedMessage, success:true})).catch(e=>{console.log("ERROR with modifyMessage: ", e); return Promise.resolve();}))
                                .catch(()=>_.concat(promisesCarrier, {action:action, message:singleSelectedMessage, success:false}))
                    })
                })

                return prom
                    .then(promisesCarrier => {
                        const failedExecutions = _.map(_.compact(_.filter(promisesCarrier, i=>!_.get(i,"success",false))),i=>_.get(i,"message",{}))
                        const successfulExecutions = _.compact(_.filter(promisesCarrier, i=>!!_.get(i,"success",false)))
                        if(_.size(failedExecutions)) {
                            setTimeout(()=>{
                                this.set("_bodyOverlay", true);
                                this.$["errorWithEHealthBoxProcessing"].open();
                                this.set("_eHealthBoxProcessErrorMessages", failedExecutions);
                                this.shadowRoot.querySelector('#eHealthBoxProcessErrorMessageDomRepeat') && this.shadowRoot.querySelector('#eHealthBoxProcessErrorMessageDomRepeat').render()
                            },200)
                        }
                        return this._updateCachedMessagesDataStructure(successfulExecutions)
                    })
                    .catch(e=>console.log("ERROR with _deletedUndeleteMessages: ",e))
                    .finally(()=>{
                        this._toggleProcessingPopup();
                        this._getEHealthBoxData();
                        return Promise.resolve()
                    })

            }

            _deleteMessagesForEver(givenMessages=null) {

                // No eHealthBox ?
                if (!_.get(this,"ehealthSession",false)) { this.set("_bodyOverlay", true); this.$["notConnctedToeHealthBox"].open(); return Promise.resolve(); }

                let selectedMessages = _.size(givenMessages) && !( givenMessages instanceof Event) ? givenMessages : this._getGridSelectedItems()
                if(!_.size(selectedMessages)) return Promise.resolve()

                this._closeDialogs();
                this._toggleProcessingPopup()

                let prom = Promise.resolve([]);
                selectedMessages.map(singleSelectedMessage => {
                    prom = prom.then(promisesCarrier => {
                        const sourceBox = _.trim(_.get(_.trim(_.get(singleSelectedMessage,"transportGuid","")).split(':'), "[0]", ""))
                        const eHealthBoxMessageId = _.trim(_.get(_.trim(_.get(singleSelectedMessage,"transportGuid","")).split(':'), "[1]", ""))
                        const action = "deleteForEver"
                        return !eHealthBoxMessageId || !sourceBox || !_.get(this,"api.keystoreId",false) || !_.get(this,"api.tokenId",false) || !_.get(this,"api.credentials.ehpassword",false) ?
                            false :
                            this.api.fhc().Ehboxcontroller().deleteMessagesUsingPOST(this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword, [eHealthBoxMessageId], sourceBox)
                                .then(()=> this.api.message().deleteMessages(_.trim(_.get(singleSelectedMessage,"id",""))).then(deletetionResult=>_.concat(promisesCarrier, {action:action, message:singleSelectedMessage, success:!!deletetionResult})).catch(e=>{console.log("ERROR with deleteMessages: ", e); return Promise.resolve();}))
                                .catch(()=>_.concat(promisesCarrier, {action:action, message:singleSelectedMessage, success:false}))
                    })
                })

                return prom
                    .then(promisesCarrier => {
                        const failedExecutions = _.map(_.compact(_.filter(promisesCarrier, i=>!_.get(i,"success",false))),i=>_.get(i,"message",{}))
                        const successfulExecutions = _.compact(_.filter(promisesCarrier, i=>!!_.get(i,"success",false)))
                        if(_.size(failedExecutions)) {
                            setTimeout(()=>{
                                this.set("_bodyOverlay", true);
                                this.$["errorWithEHealthBoxProcessing"].open();
                                this.set("_eHealthBoxProcessErrorMessages", failedExecutions);
                                this.shadowRoot.querySelector('#eHealthBoxProcessErrorMessageDomRepeat') && this.shadowRoot.querySelector('#eHealthBoxProcessErrorMessageDomRepeat').render()
                            },200)
                        }
                        return this._updateCachedMessagesDataStructure(successfulExecutions).then(()=>this._getBoxCapacity())
                    })
                    .catch(e=>console.log("ERROR with _deleteMessagesForEver: ",e))
                    .finally(()=>{
                        this._toggleProcessingPopup();
                        this._getEHealthBoxData();
                        return Promise.resolve()
                    })

            }

            _triggerGetEHealthBoxData() {
                this._getEHealthBoxData(null,null,null,{forceRefresh:true})
            }

            _formatRecipientDetailsForSentFolder(inputData) {
                return !_.size(_.get(inputData,"metas",{})) ? "" : _.trim(_.compact([
                    _.trim(_.get(inputData,"metas.CM-RecipientLastName","")),
                    _.trim(_.get(inputData,"metas.CM-RecipientFirstName","")),
                    "(" + _.compact([
                        _.trim(_.get(inputData,"metas.CM-RecipientIDType","")),
                        _.trim(_.get(inputData,"metas.CM-RecipientID",""))
                    ]).join(": ") + ")"
                ]).join(" "))
            }

            _vaadinGridActiveItemChanged(activeItem) {

                const isUnread = !!(_.get(activeItem,"status",0) & (1 << 1))

                if(activeItem && isUnread) {
                    let modifiedMessageCarrier = {}
                    this.api.message().modifyMessage(_.merge(activeItem, {status:(_.get(activeItem,"status",0)^(1<<1))}))
                        .then(modifiedMessage=>{modifiedMessageCarrier = modifiedMessage; this._updateCachedMessagesDataStructure([{action:"read", message:modifiedMessage}]); })
                        .catch(e=>console.log("ERROR with flag as read: ",e))
                        .finally(()=>{ this.set("_vaadinGridMessagesActiveItem",modifiedMessageCarrier); this._getEHealthBoxData(null,null,null,{avoidClosingOpenedDocument:true,avoidScrollToTop:true}).then(()=>this.dispatchEvent(new CustomEvent('selected-message-changed', {detail:{selection:{item: modifiedMessageCarrier}}}))); })
                }

                if(!activeItem || (activeItem && !isUnread)) this.dispatchEvent(new CustomEvent('selected-message-changed', {detail:{selection:{item: activeItem}}}))

            }
            
            _gotoPreviousGridPage() {
                if ( parseInt(_.get(this,"_currentPageNumber",1)) > 1 ) this.set( '_currentPageNumber',( parseInt(_.get(this,"_currentPageNumber",2)) - 1 ) )
            }

            _gotoNextGridPage() {
                if ( parseInt(_.get(this,"_currentPageNumber",1)) < parseInt(_.get(this,"_totalPagesForCurrentFolderAndCurrentFilter",1)) ) this.set('_currentPageNumber', ( parseInt(_.get(this,"_currentPageNumber",1)) + 1 ) )
            }

            takeActionForDetailMessage(givenAction,givenMessage,additionalParameters) {

                let prom = Promise.resolve([])

                prom = this._closeReadMessageComponent()
                    .then(() => !_.trim(givenAction) || !_.trim(_.get(givenMessage,"id","")) ?
                        Promise.resolve():
                        (
                            givenAction === "hideUnhide" ? this._hideUnHideMessages([givenMessage]) :
                            givenAction === "deleteUndelete" ? this._deletedUndeleteMessages([givenMessage]) :
                            givenAction === "deleteForEver" ? this._deleteMessagesForEver([givenMessage]) :
                            (givenAction === "reply" || givenAction === "forward") ? this._replyToOrForwardMessage(givenMessage,additionalParameters,givenAction) :
                            Promise.resolve()
                        )
                    )

                return prom
                    .then(()=>{})
                    .catch((e)=>console.log("ERROR with takeActionForDetailMessage: ", e))
                    .finally(()=>prom)

            }

            _replyToOrForwardMessage(givenMessage,additionalParameters,replyOrForwardAction) {
                const prom = Promise.resolve([])
                return prom
                    .then(()=> !_.trim(_.get(givenMessage,"id","")) ? prom : {
                        subject: _.trim(_.get(givenMessage,"subject","")),
                        recipientId: _.trim(_.get(givenMessage,"fromHealthcarePartyId",_.trim(_.get(givenMessage,"metas.CM-SenderID","")))),
                        recipientType: _.trim(_.get(givenMessage,"metas.CM-SenderIDType","")),
                        patientSsin: _.trim(_.get(givenMessage,"metas.patientSsin","")),
                        body: _.trim(_.get(_.find(_.get(additionalParameters,"documentsOfMessage",[]),i=>_.trim(_.get(i,"documentLocation"))==="body"),"attachmentInfos.decryptedContent","")),
                        originalSender: _.trim(_.get(givenMessage,"fromAddress","")),
                        received: this.api.moment(_.get(givenMessage,"created",new Date().getTime())).format('DD/MM/YYYY hh:mm'),
                        replyOrForward: _.trim(replyOrForwardAction),
                        attachments: _.get(additionalParameters,"_messageAttachments",[])
                    })
                    .then(eventParameters=>this.dispatchEvent(new CustomEvent("reply-to-or-forward-message", { bubbles:true, composed:true, detail:eventParameters })))
                    .catch((e)=>console.log("ERROR with _replyToMessage: ", e))
                    .finally(()=>prom)
            }















            _enrichMessageWithPatientInfo(messages) {

                this._setLoadingMessage({ message:this.localize('ehb.gettingPatientsInfo',this.language), icon:"arrow-forward"});

                const startPostion = (parseInt(this._currentPageNumber)-1) * parseInt(this._vaadinGridMaxItemsPerPage)
                const endPosition = parseInt(this._currentPageNumber) * parseInt(this._vaadinGridMaxItemsPerPage)

                // Resolve additional pat infos, observing pagination size (slice passes along as reference)
                let messagesToResolve = messages.slice(startPostion, endPosition).filter(singleMessge=>!_.get(singleMessge,"patientInfosBasedOnResultInfo",false));

                let prom = Promise.resolve([]);
                const totalMessages = _.size(messagesToResolve)||1;
                messagesToResolve.map((singleMessage,loopIndex) => {
                    prom = prom.then(resolvedMessages => {
                        return this.api.document().findByMessage(_.get(this,"user.healthcarePartyId", null), singleMessage)
                            .then(docs => docs.filter(doc => !!_.get(doc,"id",false) && !!_.get(doc,"attachmentId",false) && !!_.get(doc,"secretForeignKeys",false) ))
                            .then(docs => Promise.all(docs.map(singleDocument => {
                                return this.api.crypto()
                                    .extractKeysFromDelegationsForHcpHierarchy(_.get(this,"user.healthcarePartyId", null), singleDocument.id, _.size(singleDocument.encryptionKeys) ? singleDocument.encryptionKeys : singleDocument.delegations)
                                    .then(({extractedKeys: enckeys}) =>
                                        this.api.beresultimport().canHandle(singleDocument.id, enckeys.join(','))
                                            .then(isResult => (isResult ? this.api.beresultimport().getInfos(singleDocument.id, true, null, enckeys.join(',')) : false))
                                            .catch(e=>{ /* console.log("Couldn't exec beresultimport().canHandle, error: ", e); console.log("singleDocument ", singleDocument); */ })
                                    )
                                    .then(resultInfos => _.compact(_.map(resultInfos, ri=> {
                                        return {
                                            lastName: _.upperFirst(_.trim(_.get(ri, "lastName", "NA")).toLowerCase()),
                                            firstName: _.upperFirst(_.trim(_.get(ri, "firstName", "NA")).toLowerCase()),
                                            dateOfBirthHr: (_.parseInt(_.get(ri, "dateOfBirth", 0)) ? "(" + moment(_.trim(_.get(ri, "dateOfBirth", ""))).format("DD/MM/YYYY") + ")" : ""),
                                            // isAssigned: !!(parseInt(singleMessage.modified)%2),
                                            isAssigned: !!_.size(_.get(singleMessage,"assignedResults",[])),
                                            uniqueId: _.uniqueId(_.trim(_.get(singleMessage, "id", _.uniqueId())))
                                        }
                                    })))
                                    .catch(e=>{})
                            })))
                            .then(resultInfos => {
                                this._setLoadingMessage({ message:this.localize('ehb.gettingPatientsInfo',this.language) + " " + (parseInt(loopIndex)+1) + "/" + totalMessages, icon:"arrow-forward", updateLastMessage: true});
                                return _.concat(resolvedMessages, [_.merge(singleMessage, {patientInfosBasedOnResultInfo: (_.compact(_.flatMap(resultInfos))||[])})])
                            })
                            .catch(e=>{})
                    })
                })
                return prom.then(()=>messages)
            }



            _getEHealthBoxData(menuSelectionObject, _messageFilterSelectedItem, _currentPageNumber, additionalSettings={}) {

                // patientInfo: [
                //     {
                //         patientId: "123",
                //         isAssigned: true,
                //         assignedProtocolIds: ["123","456","789"]
                //         assignedDocumentIds: ["123","456","789"]
                //     },
                //     {
                //         patientId: "456",
                //         isAssigned: true,
                //         assignedProtocolIds: ["123","456","789"]
                //         assignedDocumentIds: ["123","456","789"]
                //     },
                //     {
                //         patientId: "789",
                //         isAssigned: false,
                //         assignedProtocolIds: []
                //         assignedDocumentIds: []
                //     }
                // ]

                // Not ready yet, wait for assignResolvedObjects - upon filter change value is set to null before being set to something
                if(!_.size(_.get(this,"currentHcp",{})) || _.get(this,"_messageFilterSelectedItem",null) === null) return;

                const cacheTTL = (10**3)*3600 // Long TTL on purpose, ehboxWebWorker will force refresh (when new message hits inbox / sentbox)
                const eHealthBoxType = _.trim(_.get(this,"menuSelectionObject.selection.item","personalInbox"))
                const eHealthBoxCurrentFolder = _.trim(_.get(this,"menuSelectionObject.selection.folder","inbox"))
                const eHealthBoxLastFolder = _.trim(_.get(this,"_eHealthBoxLastFolder","inbox"))
                const selectedMessagesFilter = _.get(this,"_messageFilterSelectedItem.dataset.filter","")
                const messageFilterLastSelectedItem = _.trim(_.get(this,"_messageFilterLastSelectedItem",""))
                const shouldRefreshData = !!_.get(additionalSettings,"forceRefresh",false) || !!(parseInt(_.get(this,"_getEHealthBoxDataLastRefreshTstamp",0)) < (+new Date() - cacheTTL))
                const currentPageNumber = parseInt(_.get(this,"_currentPageNumber",1))
                this.set("_eHealthBoxLastFolder", eHealthBoxCurrentFolder);
                this.set("_messageFilterLastSelectedItem", selectedMessagesFilter);

                if(eHealthBoxCurrentFolder !== eHealthBoxLastFolder) {
                    if (parseInt(currentPageNumber) > 1) this.set("_currentPageNumber", 1);
                    if (_.trim(selectedMessagesFilter)) this._resetMessagesFilters();
                    if (parseInt(currentPageNumber) > 1 || _.trim(selectedMessagesFilter)) return;
                }

                if(selectedMessagesFilter !== messageFilterLastSelectedItem && parseInt(currentPageNumber) > 1 ) { this.set("_currentPageNumber", 1); return; }

                if(!_.get(additionalSettings,"avoidClosingOpenedDocument",false)) this._closeReadMessageComponent()
                this._toggleProcessingPopup(this.localize('ehb.gettingMessages',this.language));

                const promiseResolver = !shouldRefreshData ?
                    Promise.resolve() :
                    Promise.all(_.map(["INBOX:*","SENTBOX:*","BININBOX:*","BINSENTBOX:*"], singleTransportGuid => this.api.message().findMessagesByTransportGuid(_.trim(singleTransportGuid), null, null, null, 2000).then(messages=>messages.rows).catch(()=>Promise.resolve())))
                        .then(promisesResults => _
                            .chain(promisesResults)
                            .flatMap()
                            .uniqBy('id')
                            .filter(msg=>_.trim(_.get(msg,"responsible","")) === (eHealthBoxType==="personalInbox" ? _.trim(_.get(this,"user.healthcarePartyId","")) : _.trim(_.get(this,"parentHcp.id","")))) // "My messages" or the ones of my "Medical House"
                            .orderBy(['created','transportGuid'],['desc','desc'])
                            .value()
                        )
                        .then(foundMessages => {
                            this.set("_getEHealthBoxDataLastRefreshTstamp",( _.size(foundMessages) ? +new Date() : 0 ))
                            Object.keys(this._cachedMessagesData).forEach(k => this._cachedMessagesData[k] = [] )
                            return _.map(foundMessages, singleMessage => {
                                const messageBox = _.trim(_.get(_.trim(_.get(singleMessage,"transportGuid","")).split(":"),"[0]",""))
                                const isHidden = !!(_.get(singleMessage,"status",0)&(1<<14))
                                return (
                                    messageBox === "INBOX" && !isHidden ? this.push("_cachedMessagesData.inbox", singleMessage) :
                                    messageBox === "SENTBOX" && !isHidden ? this.push("_cachedMessagesData.sent", singleMessage) :
                                    messageBox === "BININBOX" && !isHidden ? this.push("_cachedMessagesData.deleted", singleMessage):
                                    messageBox === "BINSENTBOX" && !isHidden ? this.push("_cachedMessagesData.deleted", singleMessage) :
                                    this.push("_cachedMessagesData.hidden", singleMessage)
                                )
                            })

                        })
                        .then(()=>this._getBoxCapacity())

                return promiseResolver
                    .then(() => {

                        this.dispatchEvent(new CustomEvent('update-menu-folders-totals', { bubbles:true, composed:true, detail:_.fromPairs(_.map(_.get(this,"_cachedMessagesData",{}), (v,k)=>[k, _.size(v)])) }));

                        const messagesDataForCurrentFolderAndCurrentFilter = _
                            .chain(_.get(this,"_cachedMessagesData." + eHealthBoxCurrentFolder, []))
                            .uniqBy('id')
                            .filter(msg=>{
                                return !_.trim(selectedMessagesFilter) ? msg :
                                    _.trim(selectedMessagesFilter) === "read" ? !(_.get(msg,"status",0) & (1 << 1)) :
                                    _.trim(selectedMessagesFilter) === "unread" ? !!(_.get(msg,"status",0) & (1 << 1)) :
                                    _.trim(selectedMessagesFilter) === "withAttachment" ? !!(_.get(msg,"status",0) & (1 << 4)) :
                                    _.trim(selectedMessagesFilter) === "withoutAttachment" ? !(_.get(msg,"status",0) & (1 << 4)) :
                                    _.trim(selectedMessagesFilter) === "important" ? !!(_.get(msg,"status",0) & (1 << 2)) :
                                    _.trim(selectedMessagesFilter) === "notImportant" ? !(_.get(msg,"status",0) & (1 << 2)) :
                                    _.trim(selectedMessagesFilter) === "assignedResults" ? (!!(_.get(msg,"status",0) & (1 << 0)) && !!_.size(_.get(msg,"assignedResults",[]))) :
                                    _.trim(selectedMessagesFilter) === "unassignedResults" ? (!!(_.get(msg,"status",0) & (1 << 0)) && !!_.size(_.get(msg,"unassignedResults",[]))) :
                                    _.trim(selectedMessagesFilter) === "labResults" ? !!(_.get(msg,"status",0) & (1 << 0)) :
                                    false
                            })
                            .orderBy(['created','transportGuid'],['desc','desc'])
                            .value()

                        this._clearGridCache()
                        this._resetGridSelectedItems()
                        this.set('pageStart', parseInt(((currentPageNumber-1)||0) * parseInt(this._vaadinGridMaxItemsPerPage)) )
                        this.set('pageEnd', parseInt(((currentPageNumber)||1) * parseInt(this._vaadinGridMaxItemsPerPage)) )
                        this.set('_totalMessagesForCurrentFolderAndCurrentFilter', _.size(messagesDataForCurrentFolderAndCurrentFilter))
                        this.set('_totalPagesForCurrentFolderAndCurrentFilter', Math.ceil(_.get(this,"_totalMessagesForCurrentFolderAndCurrentFilter",0) / parseInt(this._vaadinGridMaxItemsPerPage)))
                        this.set("_vaadinGridDataToShow", messagesDataForCurrentFolderAndCurrentFilter.slice(parseInt(_.get(this,"pageStart",0)), parseInt(_.get(this,"pageEnd",0))))

                    })
                    .catch(e=>{ setTimeout(()=>{ console.log("ERROR with _getEHealthBoxData: ", e); this.set("_bodyOverlay", true); this.$["errorGettingEHealthBoxMessages"].open(); },200); return Promise.resolve(); })
                    .finally(()=>{
                        this._triggerGridResize()
                        if(!_.get(additionalSettings,"avoidScrollToTop",false)) this._scrollToTop()
                        this._toggleProcessingPopup()
                        return Promise.resolve()
                    })

            }



            _testCryptedMetasKey() {

                // FABIEN: double check si ma MM est capable de décrypter ce message

                const mySecretContentToBeCrypted = "This is top secret - to be encrypted"

                let prom = this.api.message().newInstance(this.user)
                    .then(newMessageInstance => this.api.message().createMessage(
                        _.merge(newMessageInstance, {
                            transportGuid: "TEST:CRYPTO:METAS",
                            recipients: [_.get(this.user, 'healthcarePartyId', "")],
                            recipientsType: "org.taktik.icure.entities.HealthcareParty",
                            metas: { nonEncryptedContent: mySecretContentToBeCrypted },
                            toAddresses: [_.get(this.user, 'email', _.get(this.user, 'healthcarePartyId', ""))],
                            subject: "TEST message with crypted meta key"
                        }))
                    )
                    .then(createdMessage => this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("encrypt", this.user, createdMessage, this.api.crypto().utils.ua2ArrayBuffer(this.api.crypto().utils.text2ua(createdMessage.metas.nonEncryptedContent))).then(encryptedContent => ({createdMessage, encryptedContent})))
                    .then(({createdMessage, encryptedContent}) => this.api.message().modifyMessage(_.merge(createdMessage, {metas:{encryptedContent:btoa(String.fromCharCode.apply(null, new Uint8Array(encryptedContent)))}})).then(modifiedMessageWithEncryptedContent=>modifiedMessageWithEncryptedContent))
                    .then(modifiedMessageWithEncryptedContent => this.api.register(modifiedMessageWithEncryptedContent,"message"))
                    .then(modifiedMessageWithEncryptedContent => this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("decrypt", this.user, modifiedMessageWithEncryptedContent, new Uint8Array(this.api.crypto().utils.base64toArrayBuffer(modifiedMessageWithEncryptedContent.metas.encryptedContent)))
                        .then(uaDecryptedContent => {
                            const decryptedContent = this.api.crypto().utils.ua2text(uaDecryptedContent);
                            return ({modifiedMessageWithEncryptedContent,decryptedContent});
                        })
                    )

                prom.then(({modifiedMessageWithEncryptedContent, decryptedContent}) => {
                    console.log("modifiedMessageWithEncryptedContent: ", modifiedMessageWithEncryptedContent);
                    console.log("decryptedContent: ", decryptedContent);
                })

            }




            
            
            







            
            
            
            
            
            
            


















		}

        customElements.define(HtMsgList.is, HtMsgList);
    </script>



</dom-module>
