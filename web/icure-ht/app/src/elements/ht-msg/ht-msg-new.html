<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial.html">
<link rel="import" href="../../../bower_components/paper-fab-speed-dial/paper-fab-speed-dial-action.html">

<link rel="import" href="../../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../../../bower_components/iron-iconset/iron-iconset.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../ht-spinner/ht-spinner.html">

<link rel="import" href="../../vaadin-icure-theme.html">

<link rel="import" href="../dynamic-form/dynamically-loaded-form.html">
<link rel="import" href="../dynamic-form/entity-selector.html">


<dom-module id="ht-msg-new">
    
    <template>
        
        <style>
            h2 {
                margin-block-start:0;
            }

            .posRel {
                position:relative
            }

            .vertical {
                display: flex;
                flex-direction: column;
                flex-grow: 1;
            }
            .horizontal {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                flex-basis: 100%;
                align-items: center;
            }
            .m-t-8 {
                margin-top: 8px;
            }
            .m-t-12 {
                margin-top: 12px;
            }
            .m-t-m-10 {
                margin-top: -10px;
            }
            .m-t-20 {
                margin-top: 20px;
            }
            .m-t-30 {
                margin-top: 30px;
            }
            .m-t-50 {
                margin-top: 50px;
            }
            .m-l-20 {
                margin-left: 20px;
            }
            .p-t-7 {
                padding-top: 7px;
            }
            .p-t-18 {
                padding-top: 18px;
            }
            .mw120 {
                min-width:120px;
            }
            .cell {
                display: flex;
                flex-grow: 1;
            }
            .cell.colspan2 {
                flex-grow: 2;
            }
            .cell.colspan3 {
                flex-grow: 3;
            }
            .cell.colspan6 {
                flex-grow: 6;
            }

            .type-to {
                width: 280px;
            }

            .recipients-list {
                overflow-x: auto;
                padding-left: 130px;
            }

            input {
                border: none;
                width: 100%;
            }

            paper-dialog {
                margin: 0;
                min-width: 30%;
                width: 80%;
                height: 80vh;
                overflow: hidden;
            }

            vaadin-upload {
                margin: 16px 0;
                min-height: 280px;
                min-height: 0;
                background: var(--app-background-color);
                --vaadin-upload-buttons-primary: {
                    padding: 16px;
                };
                --vaadin-upload-button-add: {
                    background: var(--app-secondary-color);
                    color: var(--app-text-color);
                };
                --vaadin-upload-file-progress: {
                    --paper-progress-active-color: var(--app-secondary-color);
                };
                --vaadin-upload-file-commands: {
                    color: var(--app-primary-color);
                };
                --vaadin-upload-file-meta: {
                    min-height: 36px;
                };

            }

            paper-input, paper-input-container {
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            .modal-title {
                background: var(--app-background-color-dark);
                margin-top: 0;
                padding: 16px 24px;
            }

            .modal-subtitle {
                margin: 8px 12px 8px 0;
                font-weight: bold;
            }
            .patLabel {
                padding-top: 12px;
            }

            paper-checkbox {
                margin-right: 16px;
            }

            vaadin-combo-box {
                width: 100%;
            }

            iron-autogrow-textarea {
                min-height: 80px;
                width: 100%;
                --paper-input-container-focus-color: var(--app-primary-color);
            }

            .form-disabled {
                opacity: .5;
                background: var(--app-background-color-darker);
            }

            .buttons {
                display: flex;
                flex-direction: row;
            }

            .scrollbox {
                height: calc(100% - 132px);
                overflow-y: auto;
                margin-top: 0;
                border-bottom: 1px  solid rgba(0,0,0,0.1);
            }

            .field{
                padding:12px 0;
            }

            .destination-tag {
                background: rgba(0,0,0,.1);
                color: var(--exm-token-input-badge-text-color,--text-primary-color);
                height: 24px;
                min-height: 1px;
                font-size: 12px;
                min-width: initial;
                padding: 0;
                margin: 5px 10px 0 0;
                border-radius: 5px;
                overflow: hidden;
                float:left;
            }

            .destination-type{
                background: var(--app-secondary-color);
                color: var(--app-text-color);
                display: flex;
                height: 100%;
                flex-flow: row wrap;
                padding: 0 4px;
                box-sizing: border-box;
                align-items: center;
                margin-right: 8px;
            }

            .del-destination {
                height: 22px;
                width: 22px;
                margin: 0 4px 0 8px;
                padding: 2px;
            }

            paper-checkbox {
                --paper-checkbox-unchecked-color: var(--app-text-color);
				--paper-checkbox-label-color: var(--app-text-color);
				--paper-checkbox-checked-color: var(--app-secondary-color);
				--paper-checkbox-checked-ink-color: var(--app-secondary-color-dark);
            }

            #messageBodyText {
                min-height: 200px;
            }

            #new-msg {
                display: flex;
                flex-direction: column;
                top: 70px !important;
                right: 7px !important;
                left: initial !important;
                position: fixed;
                max-width: initial !important;
                width: 83vw !important;
                max-height: initial !important;
                height: calc(100vh - 78px);
            }

            .spinner {
                display: flex;
                flex-grow: 1;
                width: 47px; /* force circle */
                transform: translateY(16px);
            }

            .sendingSpinner {
                display: block;
                float: right;
            }

            #success, #failed {
                display: flex;
                position: fixed;
                top: 50vh;
                right: 0;
                transform: translate(100vw,-50%);
                z-index: 999;
                padding: 16px;
                border-radius: 4px 0 0 4px;
                transition: 1s ease-in;
                flex-flow: row wrap;
                align-items: center;
                justify-content: flex-start;
                background: rgba(0,0 ,0,.42);
                color: var(--app-text-color-light);
                box-shadow: 0 9px 12px 1px rgba(0,0,0,.14),
                            0 3px 16px 2px rgba(0,0,0,.12),
                            0 5px 6px 0 rgba(0,0,0,.2);
            }

            #success iron-icon, #failed iron-icon{
                border-radius: 50%;
                padding: 2px;
                margin-right: 8px;
                box-sizing: border-box;
            }

            #success iron-icon{
                background: var(--app-status-color-ok);
            }

            #failed iron-icon{
                background: var(--app-status-color-nok);
            }

            .displayNotif {
                animation: displaySent 7.5s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .modal-button--cancel {
                background: transparent;
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }

            .modal-button--save {
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;
            }

            @keyframes displaySent {
                0% {transform: translate(100vw,-50%);}
                10% {transform: translate(0,-50%);}
                88% {transform: translate(0,-50%);}
                100% {transform: translate(100vw,-50%);}
            }

            @media screen and (max-width: 1030px) {
                #new-msg {
                    top: 64px !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: calc(100vh - 64px - 20px) !important;
                }
            }

            ht-spinner {
                height: 42px;
                width: 42px;
            }

            .messageSubject {
                width:100%;
            }

            .busySpinner {
                position:absolute;
                top:10px;
                display:inline-block;
                width:40px;
                height:40px;
                margin-left:20px;
            }

            .bordered {
                border: 1px solid #ddd
            }

            paper-input-container {
                padding:0 10px 10px 10px;
            }

            .fleft {
                flex-grow: 1;
            }

        </style>

        <paper-dialog id="new-msg" >
            <h2 class="modal-title posRel">[[localize('new_mes','New message',language)]] [[isForwardOrReply]] <ht-spinner class="busySpinner" active="[[busySpinner]]" hidden="[[!busySpinner]]"></ht-spinner></h2>
            <div class="scrollbox">

                <div class="horizontal m-t-20">
                    <div class="cell">
                        <div class="vertical">
                            <div class="cell">
                                <div class="horizontal">
                                    <div class="modal-subtitle p-t-7 mw120">[[localize('recipient_s','Recipient(s)',language)]]:</div>
                                    <div class="cell">
                                        <vaadin-combo-box id="newMsg-To" label="[[localize('inputYourSearchQuery','What are you looking for ?',language)]]" filter="{{recipientFilter}}" filtered-items="[[filteredRecipientsList]]" item-label-path="displayName" allow-custom-value on-change="_addRecipient"><template>[[item.displayName]]</template></vaadin-combo-box>
                                        <vaadin-combo-box class="type-to m-l-20" id="type-To" items="[[recipientTypes]]" item-label-path="label" item-value-path="id" required error-message="This field is required" label="[[localize('sch_by', 'Search by', language)]]" selected-item="{{recipientType}}"></vaadin-combo-box>
                                    </div>
                                    <div class="horizontal recipients-list">
                                        <template is="dom-if" if="[[newMessage.recipients]]">
                                                <template is="dom-repeat" items="[[newMessage.recipients]]" as="singleRecipient" id="recipientsList">
                                                    <paper-item class="destination-tag" id="[[singleRecipient.displayName]]">
                                                        <div class="destination-type">[[singleRecipient.type]]</div>
                                                        <div class="one-line-menu list-title">[[singleRecipient.displayName]]</div>
                                                        <paper-icon-button class="del-destination" icon="clear" id="[[singleRecipient.displayName]]" on-tap="_removeRecipient" data-recipient-index$='[[index]]'></paper-icon-button>
                                                    </paper-item>
                                                </template>
                                            </template>
                                    </div>
                                </div>
                            </div>
                            <div class="cell">
                                <div class="horizontal">
                                    <div class="modal-subtitle patLabel mw120">[[localize('pati','Patient',language)]]:</div>
                                    <div class="cell"><vaadin-combo-box id="linkedPatientComboxBox" label="[[localize('inputYourSearchQuery','What are you looking for ?',language)]]" filter="{{patientFilter}}" filtered-items="[[filteredPatientsList]]" item-label-path="displayName" allow-custom-value on-selected-item-changed="_setLinkedPatient"><template>[[item.displayName]]</template></vaadin-combo-box>
                                    </div>
                                </div>
                            </div>
                            <div class="cell m-t-12">
                                <div class="horizontal">
                                    <div class="modal-subtitle mw120">[[localize('options','Options',language)]]:</div>
                                    <div class="cell">
                                        <paper-checkbox checked="{{newMessage.important}}">[[localize('importantMessage','Important message',language)]]</paper-checkbox>
                                        <paper-checkbox checked="{{newMessage.useReceivedReceipt}}">[[localize('aknReception','Reception acknowledge',language)]]</paper-checkbox>
                                        <paper-checkbox checked="{{newMessage.useReadReceipt}}">[[localize('aknRead','Read acknowledge',language)]]</paper-checkbox>
                                        <paper-checkbox checked="{{newMessage.usePublicationReceipt}}">[[localize('aknPublication','Publication acknowledge',language)]]</paper-checkbox>
                                    </div>
                                </div>
                            </div>
                            <div class="cell">
                                <div class="horizontal m-t-m-10">
                                    <div class="modal-subtitle mw120 p-t-18">[[localize('sub','Subject',language)]]:</div>
                                    <div class="cell"><paper-input id="newMsg-Subject" class="messageSubject" value="{{newMessage.document.title}}" placeholder="[[localize('writeYourSubject', 'Write your subject', language)]]"></paper-input></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="messageContainer m-t-30">
                    <div class="modal-subtitle">[[localize('msg','Message',language)]]:</div>
                    <div class="bordered"><paper-input-container alway-float-label="true"><iron-autogrow-textarea slot="input" class="paper-input-input" id="messageBodyText" placeholder="[[localize('writeYourMessage', 'Write your message', language)]]" value="{{newMessage.document.textContent}}"></iron-autogrow-textarea></paper-input-container></div>
                </div>

                <div class="attachmentsContainer m-t-50">
                    <div class="modal-subtitle">[[localize('attachments','Attachments',language)]]:</div>
                    <vaadin-upload id="vaadin-upload" class="m-t-8" no-auto files="{{files}}" target$="[[api.host]]/document/{documentId}/attachment/multipart;jsessionid=[[api.sessionId]]" method="PUT" form-data-name="attachment" on-upload-success="_fileUpload" on-file-remove="_fileUploadRemove"></vaadin-upload>
                </div>

            </div>
            <div class="buttons">
                <div class="fleft">
                    <paper-button class="modal-button--cancel" on-tap="_resetComponentData">[[localize('reset','Reset',language)]]</paper-button>
                </div>
                <div class="fright">
                    <paper-button class="modal-button--cancel" on-tap="_closeComponent">[[localize('clo','Close',language)]]</paper-button>
                    <paper-button class="modal-button--save" on-tap="_sendMessage">[[localize('send','Send',language)]]</paper-button>
                    <template is="dom-if" if="[[busySendingMessage]]"><ht-spinner class="sendingSpinner" active="[[busySendingMessage]]"></ht-spinner></template>
                </div>
            </div>
        </paper-dialog>

        <div id="success"><iron-icon icon="check"></iron-icon> [[localize('sen_succ','Success',language)]]</div>
        <div id="failed"><iron-icon icon="clear"></iron-icon> [[localize('sen_error','Error',language)]]</div>

    </template>
    
    <script>

        import _ from 'lodash/lodash'
        import moment from 'moment/src/moment'

		class HtMsgNew extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-msg-new'
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true
                    },
                    user: {
                        type: Object,
                        noReset: true
                    },
                    credentials: {
                        type: Object,
                        noReset: true
                    },
					newMessage:{
						type: Object,
                        value: {
							customMetas:{},
							document:{
							    textContent: '',
                                title: '',
                                mimeType: 'text/plain',
                                filename: ''
                            },
                            important: false,
                            encrypted: true,
                            patientInss: '',
                            annex: [],
                            recipients:[],
                            useReceivedReceipt:false,
                            useReadReceipt:false,
                            usePublicationReceipt:false
						}
                    },
                    recipientTypes: {
                        type: Array,
                        value: [
                            {id: "CBE", label: "BCE"},
                            {id: "EHP", label: "EHP (eHealth Partner)"},
                            {id: "INSS", label: "INSS"},
                            {id: "NIHII", label: "NIHII"},
                            {id: "NIHII-HOSPITAL", label: "NIHII-HOSPITAL"},
                            {id: "NIHII-PHARMACY", label: "NIHII-PHARMACY"}
                        ],
                        noReset: true
                    },
                    filteredRecipientsList: {
                        type: Array,
                        value: () => []
                    },
                    filteredPatientsList: {
                        type: Array,
                        value: () => []
                    },
					customMetas:{
                    	type: Array,
                        value: () => []
                    },
                    busySpinner: {
                        type: Boolean,
                        value: false
                    },
                    currentContact: {
                        type: Object,
                        value: {
                            subContacts: [],
                            services: []
                        }
                    },
                    files: {
                        type: Array,
                        value: () => []
                    },
                    busySendingMessage:{
                        type: Boolean,
                        value: false
                    },
                    uploadedFiles: {
                        type: Array,
                        value: () => []
                    },
                    recipientReqIdx: {
                        type: Number,
                        value: 0
                    },
                    currentHcp: {
                        type: Object,
                        value: {},
                        noReset: true
                    },
                    isForwardOrReply: {
                        type: String,
                        value: ''
                    },
                    recipientFilter: {
                        type: String,
                        value: ''
                    },
                    recipientType: {
                        type: Object,
                        value: {}
                    }
                }
            }

            static get observers() {
                return [
                    '_userChanged(user)',
                    '_loadRecipientTypesTranslations(language)',
                    '_recipientsFilterChanged(recipientType, recipientFilter)',
                    '_patientFilterChanged(patientFilter)',
                    '_uploadedFilesChanged(files.*)',
                ];
            }

            constructor() {
                super()
            }

			ready() {
				super.ready()
			}

			_userChanged(changedUser) {
                if( _.trim(_.get(changedUser, "healthcarePartyId", "something")) === _.trim(_.get(this,"currentHcp.id", "else")) ) return;
                this.api.hcparty().getHealthcareParty(_.trim(_.get(changedUser, "healthcarePartyId", ""))).then(hcp => this.set("currentHcp",hcp)).catch(ignored=>{})
            }

            _loadRecipientTypesTranslations() {

                let cbe = this.recipientTypes.find(i=>i.id==="CBE")
                let ehp = this.recipientTypes.find(i=>i.id==="EHP")
                let inss = this.recipientTypes.find(i=>i.id==="INSS")
                let nihii = this.recipientTypes.find(i=>i.id==="NIHII")
                let nihiiHospital = this.recipientTypes.find(i=>i.id==="NIHII-HOSPITAL")
                let nihiiPharmacy = this.recipientTypes.find(i=>i.id==="NIHII-PHARMACY")

                cbe.label = this.localize('cbe', 'CBE', this.language) + " / " + this.localize('name', 'Name', this.language)
                ehp.label = "EHP (eHealth Partner) / " + this.localize('name', 'Name', this.language)
                inss.label = this.localize('ssin', 'Registre national', this.language) + " / " + this.localize('name', 'Name', this.language)
                nihii.label = this.localize('nihii', 'INAMI', this.language) + " / " + this.localize('name', 'Name', this.language)
                nihiiHospital.label = this.localize('nihii', 'INAMI', this.language) + " " + this.localize('hospital', 'Hospital', this.language) + " / " + this.localize('name', 'Name', this.language)
                nihiiPharmacy.label = this.localize('nihii', 'INAMI', this.language) + " " + this.localize('pharmacy', 'Pharmacy', this.language) + " / " + this.localize('name', 'Name', this.language)

                this.set("recipientType", nihii)

            }

            _recipientsFilterChanged(recipientType, recipientFilter) {
                if( _.trim(recipientFilter).length < 3 ) { this.set("filteredRecipientsList",[]); return; }
                const reqIdx = (this.recipientReqIdx = (this.recipientReqIdx || 0) + 1)
                setTimeout(() => {

                    if (reqIdx !== this.recipientReqIdx) return;
                    this.set('busySpinner', true)

                    const numericSearchQuery = _.trim(_.trim(recipientFilter).replace( /([^\d]*)/gi, '' ))
                    const patternsValidation = { 8: /^([0-9]){8}$/i, 10: /^([0-9]){10}$/i, 11: /^([0-9]){11}$/i }

                    const isValidNihii = !!patternsValidation[8].test(numericSearchQuery) || !!patternsValidation[11].test(numericSearchQuery)
                    const isValidBce = !!patternsValidation[10].test(numericSearchQuery)
                    const isValidEhp = !!patternsValidation[10].test(numericSearchQuery)
                    const isValidSsin = !!patternsValidation[11].test(numericSearchQuery)

                    let searchProm = recipientType.id === 'CBE' ?
                        Promise.all([
                            !isValidBce ? Promise.resolve([]) : this.api.fhc().Addressbookcontroller().getOrgByCbeUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, numericSearchQuery ).then(searchResults=>_.chain([searchResults]).filter(i=>!!_.get(i,'cbe',false)).value()),
                            this.api.fhc().Addressbookcontroller().searchHcpUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, _.trim(recipientFilter) + '*').then(searchResults=>_.chain(searchResults).filter(i=>!!_.get(i,'nihii',false)).uniqBy('nihii').value()),
                            this.api.fhc().Addressbookcontroller().searchOrgUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, _.trim(recipientFilter) + '*').then(searchResults=>_.chain(searchResults).filter(i=>!!_.get(i,'ehp',false)).uniqBy('ehp').value())
                        ]) :
                        recipientType.id === 'EHP' ? Promise.all([
                            !isValidEhp ? Promise.resolve([]) : this.api.fhc().Addressbookcontroller().getOrgByEhpUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, numericSearchQuery ).then(searchResults=>_.chain([searchResults]).filter(i=>!!_.get(i,'ehp',false)).value()),
                            this.api.fhc().Addressbookcontroller().searchHcpUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, _.trim(recipientFilter) + '*').then(searchResults=>_.chain(searchResults).filter(i=>!!_.get(i,'nihii',false)).uniqBy('nihii').value()),
                            this.api.fhc().Addressbookcontroller().searchOrgUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, _.trim(recipientFilter) + '*').then(searchResults=>_.chain(searchResults).filter(i=>!!_.get(i,'ehp',false)).uniqBy('ehp').value())
                        ]) :
                        recipientType.id === 'INSS' ? Promise.all([
                            !isValidSsin ? Promise.resolve([]) : this.api.fhc().Addressbookcontroller().getHcpBySsinUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, numericSearchQuery ).then(searchResults=>_.chain([searchResults]).filter(i=>!!_.get(i,'nihii',false)).value()),    // Looking for SSIN "53815994527" returns it but WITHOUT SSIN value, quite logical. Filtering on NIHII then
                            this.api.fhc().Addressbookcontroller().searchHcpUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, _.trim(recipientFilter) + '*').then(searchResults=>_.chain(searchResults).filter(i=>!!_.get(i,'nihii',false)).uniqBy('nihii').value())
                        ]) :
                        (recipientType.id === 'NIHII-HOSPITAL' || recipientType.id === 'NIHII-PHARMACY')  ? Promise.all([
                            !isValidNihii ? Promise.resolve([]) : this.api.fhc().Addressbookcontroller().getOrgByNihiiUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, numericSearchQuery ).then(searchResults=>_.chain([searchResults]).filter(i=>!!_.get(i,'nihii',false)).value()),
                            this.api.fhc().Addressbookcontroller().searchOrgUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, _.trim(recipientFilter) + '*', ( recipientType.id === 'NIHII-PHARMACY' ? "PHARMACY" : "HOSPITAL" ) ).then(searchResults=>_.chain(searchResults).filter(i=>!!_.get(i,'ehp',false)).uniqBy('ehp').value())
                        ]) :
                        // Default type = NIHII
                        Promise.all([
                            !isValidNihii ? Promise.resolve([]) : this.api.fhc().Addressbookcontroller().getHcpByNihiiUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, numericSearchQuery ).then(searchResults=>_.chain([searchResults]).filter(i=>!!_.get(i,'nihii',false)).value()),
                            this.api.fhc().Addressbookcontroller().searchHcpUsingGET(this.api.keystoreId, this.api.tokenId, this.credentials.ehpassword, _.trim(recipientFilter) + '*').then(searchResults=>_.chain(searchResults).filter(i=>!!_.get(i,'nihii',false)).uniqBy('nihii').value())
                        ])

                    searchProm
                        .then(searchResults => { if (reqIdx === this.recipientReqIdx) {
                            this.set("filteredRecipientsList", _
                                .chain(searchResults)
                                .flatMap()
                                .filter( singleSearchResult => { return (
                                    ( !!_.get(singleSearchResult, "ehp", false) && _.uniq(_.compact(_.map(_.get(this,"newMessage.recipients",[]), i=>_.trim(i.ehp)))).indexOf(_.trim(_.get(singleSearchResult, "ehp", ""))) === -1 ) ||
                                    ( !!_.get(singleSearchResult, "ssin", false) && _.uniq(_.compact(_.map(_.get(this,"newMessage.recipients",[]), i=>_.trim(i.ssin)))).indexOf(_.trim(_.get(singleSearchResult, "ssin", ""))) === -1 ) ||
                                    ( !!_.get(singleSearchResult, "cbe", false) && _.uniq(_.compact(_.map(_.get(this,"newMessage.recipients",[]), i=>_.trim(i.cbe)))).indexOf(_.trim(_.get(singleSearchResult, "cbe", ""))) === -1 ) ||
                                    ( !!_.get(singleSearchResult, "nihii", false) && _.uniq(_.compact(_.map(_.get(this,"newMessage.recipients",[]), i=>_.trim(i.nihii)))).indexOf(_.trim(_.get(singleSearchResult, "nihii", ""))) === -1 )
                                )})
                                .map(singleRecipient => _.assign({displayName : _.compact([
                                        _.map( _.trim(_.get(singleRecipient, "lastName", "")).split(" "),i=> _.capitalize(i)).join(" "),
                                        _.map( _.trim(_.get(singleRecipient, "firstName", "")).split(" "),i=> _.capitalize(i)).join(" "),
                                        ( ( !_.trim(_.get(singleRecipient, "lastName", "")) && !_.trim(_.get(singleRecipient, "firstName", "")) ) ? _.map( _.trim(_.get(singleRecipient, "name", "")).split(" "),i=> _.capitalize(i)).join(" ") : "" ),
                                        ( !! _.trim(_.get(singleRecipient, "nihii", "")) ? "(" + this.localize('nihii', 'INAMI', this.language) + ": " + this.api.formatInamiNumber(_.trim(_.get(singleRecipient, "nihii", ""))) + ")" : "" ),
                                        ( !! _.trim(_.get(singleRecipient, "ssin", "")) ? "(" + this.localize('ssin', 'Registre national', this.language) + ": " + this.api.formatSsinNumber(_.trim(_.get(singleRecipient, "ssin", ""))) + ")" : "" ),
                                        ( !! _.trim(_.get(singleRecipient, "ehp", "")) ? "(EHP: " + _.trim(_.get(singleRecipient, "ehp", "")) + ")" : "" ),
                                        ( !! _.trim(_.get(singleRecipient, "cbe", "")) ? "(BCE: " + _.trim(_.get(singleRecipient, "cbe", "")) + ")" : "" )
                                    ]).join(" ")},singleRecipient))
                                .orderBy(['displayName','nihii', 'ssin', 'ehp', 'cbe'],['asc','asc','asc','asc','asc'])
                                .value()
                            )
                        }})
                        .catch(e=>{console.log(e);})
                        .finally(() => this.set('busySpinner', false))

                }, 300)
            }

            _addRecipient(){
                const newMsgTo = this.shadowRoot.querySelector('#newMsg-To')||false;
                return (!newMsgTo || !_.get(newMsgTo,"selectedItem",false) || !_.size(newMsgTo,"selectedItem",false)) ? false : ( this.push('newMessage.recipients', _.merge(_.get(newMsgTo,"selectedItem",{}),{type:_.get(this,"recipientType.id", "NIHII")})) && newMsgTo._clear() );
            }

            _removeRecipient(e){
                return !_.size(this,"newMessage.recipients",[]) ? false : ( this.newMessage.recipients.splice(parseInt( _.get(e, "target.dataset.recipientIndex",0)), 1) && this.shadowRoot.querySelector('#recipientsList') && this.shadowRoot.querySelector('#recipientsList').render() )
            }

            _closeComponent() {
                this.$['new-msg'] && this.$['new-msg'].close()
            }

            _wrapRecipientData(recipientObject){
                return {
                    identifierType: {type: _.trim(_.get(recipientObject,"type",""))},
                    id: (
                        _.trim(_.get(recipientObject,"type","")).toLowerCase() === 'cbe' ? _.trim( _.get(recipientObject, "cbe", "")) :
                        _.trim(_.get(recipientObject,"type","")).toLowerCase() === 'ehp' ? _.trim( _.get(recipientObject, "ehp", "")) :
                        _.trim(_.get(recipientObject,"type","")).toLowerCase() === 'inss' ? _.trim( _.get(recipientObject, "ssin", "")) :
                        _.trim( _.get(recipientObject, "nihii", ""))
                    ),
                    quality: _.trim(_.get(recipientObject,"quality","DOCTOR")).toUpperCase(),
                    applicationId: _.trim(_.get(recipientObject,"applicationID","")),
                    lastName: _.trim(_.get(recipientObject,"lastName","")),
                    firstName: _.trim(_.get(recipientObject,"firstName","")),
                    organizationName: _.trim(_.get(recipientObject,"name","")),
                    personInOrganisation: ""
                }
            }

            _patientFilterChanged(patientSearchValue) {

                if( _.trim(patientSearchValue).length < 3 ) { this.set("filteredPatientsList",[]); return; }
                const reqIdx = (this.patientReqIdx = (this.patientReqIdx || 0) + 1)

                const filter = {
                    '$type': 'IntersectionFilter',
                    'healthcarePartyId': _.get(this,"currentHcp.parentId",false) || _.get(this,"user.healthcarePartyId",false),
                    'filters': _.compact(_.trim(patientSearchValue).split(/[ ,;:]+/).filter(w => w.length >= 2).map( word => /^[0-9]{11}$/.test(word) ? {
                        '$type': 'PatientByHcPartyAndSsinFilter',
                        'healthcarePartyId': _.get(this,"currentHcp.parentId",false) || _.get(this,"user.healthcarePartyId",false),
                        'ssin': word
                    } : /^[0-3]?[0-9][\/-](1[0-2]|0?[0-9])[\/-]([1-2][89012])?[0-9][0-9]$/.test(word) ? {
                        '$type': 'PatientByHcPartyDateOfBirthFilter',
                        'healthcarePartyId': _.get(this,"currentHcp.parentId",false) || _.get(this,"user.healthcarePartyId",false),
                        'dateOfBirth': word.replace(/([0-3]?[0-9])[\/-](1[0-2]|0?[0-9])[\/-]((?:[1-2][89012])?[0-9][0-9])/g, (correspondance, p1, p2, p3) => (p3.length === 4 ? p3 : (p3 > 20) ? "19" + p3 : "20" + p3) + (p2.length === 2 ? p2 : "0" + p2) + (p1.length === 2 ? p1 : "0" + p1))
                    } : /^[0-9]{3}[0-9]+$/.test(word) ? {
                        '$type': 'UnionFilter',
                        'healthcarePartyId': _.get(this,"currentHcp.parentId",false) || _.get(this,"user.healthcarePartyId",false),
                        'filters': [
                            {
                                '$type': 'PatientByHcPartyDateOfBirthBetweenFilter', 'healthcarePartyId': _.get(this,"currentHcp.parentId",false) || _.get(this,"user.healthcarePartyId",false),
                                'minDateOfBirth': word.length >= 8  ? Number(word.substr(0,8)) : word.length >= 6 ? Number(word.substr(0,6) + '00') : Number(word.substr(0,4) + '0000'),
                                'maxDateOfBirth': word.length >= 8  ? Number(word.substr(0,8)) : word.length >= 6 ? Number(word.substr(0,6) + '99') : Number(word.substr(0,4) + '9999')
                            },
                            {
                                '$type': 'PatientByHcPartyAndExternalIdFilter', 'healthcarePartyId': _.get(this,"currentHcp.parentId",false) || _.get(this,"user.healthcarePartyId",false),
                                'externalId': word
                            }
                        ]
                    } : word.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g,'').length >= 2 ? {
                        '$type': 'PatientByHcPartyNameContainsFuzzyFilter',
                        'healthcarePartyId': _.get(this,"currentHcp.parentId",false) || _.get(this,"user.healthcarePartyId",false),
                        'searchString': word
                    } : null))
                }

                const predicates = _.trim(patientSearchValue).split(/[ ,;:]+/).filter(w => w.length >= 2).map( word =>
                    /^[0-9]{11}$/.test(word) ? (() => true) :
                    /^[0-3]?[0-9][\/-](1[0-2]|0?[0-9])[\/-]([1-2][89012])?[0-9][0-9]$/.test(word) ? (() => true) :
                    /^[0-9]{3}[0-9]+$/.test(word) ? ((p) => (p.dateOfBirth && (`${p.dateOfBirth}`.includes(word))) || (p.externalId && p.externalId.includes(word))) :
                    (p => {
                        const w = word.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g,'')
                        return w.length<2 ?
                            true :
                            (p.firstName && p.firstName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g,'').includes(w)) ||
                            (p.lastName && p.lastName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g,'').includes(w))
                    })
                )

                setTimeout(() => {
                    if (reqIdx !== this.patientReqIdx) return;
                    this.set('busySpinner', true)                
                    this.api.getRowsUsingPagination((key, docId, pageSize) =>
                        this.api.patient().filterByWithUser(this.user, key, docId, pageSize || 50, 0, "lastName", false, { filter: _.assign({}, filter, {filters: filter.filters}) })
                            .then(pl => {
                                const filteredRows = pl.rows.filter(p => predicates.every(f => f(p)))
                                return {
                                    rows: filteredRows,
                                    nextKey: pl.nextKeyPair && pl.nextKeyPair.startKey,
                                    nextDocId: pl.nextKeyPair && pl.nextKeyPair.startKeyDocId,
                                    done: !pl.nextKeyPair
                                }
                            })
                            .catch(() => { return Promise.resolve() }),
                        p => ( !!_.get(p,"active",false) && ( !!_.trim(_.get(p,"dateOfBirth","")) || !!_.trim(_.get(p,"ssin","")) ) ), 0, 50, []
                    )
                    .then(searchResults => { if (reqIdx === this.patientReqIdx) {
                        this.set("filteredPatientsList", _
                            .chain(searchResults)
                            .map(singlePat => _.assign({displayName : _.compact([
                                    _.map( _.trim(_.get(singlePat, "lastName", "")).split(" "),i=> _.capitalize(i)).join(" "),
                                    _.map( _.trim(_.get(singlePat, "firstName", "")).split(" "),i=> _.capitalize(i)).join(" "),
                                    ( !! _.trim(_.get(singlePat, "ssin", "")) ? "(" + this.localize('ssin', 'Registre national', this.language) + ": " + this.api.formatSsinNumber(_.trim(_.get(singlePat, "ssin", ""))) + ")" : "" ),
                                    ( ! _.trim(_.get(singlePat, "ssin", "")) && !! _.trim(_.get(singlePat, "dateOfBirth", "")) ? "(" + this.localize('birthDate', 'Birthdate', this.language) + ": " + moment(_.trim(_.get(singlePat,"dateOfBirth",0)), "YYYYMMDD").format('DD/MM/YYYY') + ")" : "" )
                                ]).join(" ")},singlePat))
                            .orderBy(['displayName','ssin', 'dateOfBirth'],['asc','asc','asc'])
                            .uniqBy('id')
                            .value()
                        )                        
                    }})
                    .catch(e=>{console.log(e);})
                    .finally(() => this.set('busySpinner', false))
                }, 300)

            }

            _setLinkedPatient(e){

                const linkedPatientComboxBox = this.shadowRoot.querySelector("#linkedPatientComboxBox")

                setTimeout(() => {

                    // Because we allow for custom values, it could be we have no selected item but still a value being passed
                    const linkedPatientComboxBoxSelectedItem = _.get(linkedPatientComboxBox, "selectedItem", null)
                    const linkedPatientComboxBoxValue = _.get(linkedPatientComboxBox, "value", null)

                    // Valid pat, valid ssin, assign straight
                    if( _.trim(_.get(linkedPatientComboxBoxSelectedItem, "ssin", "")) ) { this.set("newMessage.patientInss", _.trim(_.get(linkedPatientComboxBoxSelectedItem, "ssin", ""))); return; }

                    // At this stage, we don't have a valid inss anymore, unset var & update subject with relevant info
                    this.set("newMessage.patientInss", null);
                    return _.trim(_.get(linkedPatientComboxBoxSelectedItem, "id", "")) ?
                        this.set("newMessage.document.title", _.compact([_.trim(_.get(this, "newMessage.document.title")),_.trim(_.get(linkedPatientComboxBoxSelectedItem, "displayName", ""))]).join(" - ")) :
                        this.set("newMessage.document.title", _.compact([_.trim(_.get(this, "newMessage.document.title")),_.trim(linkedPatientComboxBoxValue)]).join(" - "))

                }, 100)

            }

            _resetComponentData(){

                const componentProperties = HtMsgNew.properties
                Object.keys(componentProperties).forEach(k => { if (!_.get(componentProperties[k],"noReset", false)) { this.set(k, (typeof componentProperties[k].value === 'function' ? componentProperties[k].value() : (componentProperties[k].value || null))) }})

                this.set("recipientType", this.recipientTypes.find(i=>i.id==="NIHII"))
                if(this.shadowRoot.querySelector('#linkedPatientComboxBox')) this.shadowRoot.querySelector('#linkedPatientComboxBox').value = "";
                this.shadowRoot.querySelector('#recipientsList') && this.shadowRoot.querySelector('#recipientsList').render()

                this.$['success'] && this.$['success'].classList && this.$['success'].classList.remove('displayNotif')
                this.$['failed'] && this.$['failed'].classList && this.$['failed'].classList.remove('displayNotif')

            }            





















            open(componentOpenParameters) {

                this._resetComponentData();

                // Target data obtained from pat detail, if any
                const dataFromPatDetail = _.get(componentOpenParameters, "dataFromPatDetail", false );

                // Assign values
                if(_.size(dataFromPatDetail)) {

                    componentOpenParameters = null

                    if(_.trim(_.get(dataFromPatDetail,"patient.id",""))) {

                        dataFromPatDetail.patient = _.assign({displayName : _.compact([
                            _.map( _.trim(_.get(dataFromPatDetail.patient, "lastName", "")).split(" "),i=> _.capitalize(i)).join(" "),
                            _.map( _.trim(_.get(dataFromPatDetail.patient, "firstName", "")).split(" "),i=> _.capitalize(i)).join(" "),
                            ( !! _.trim(_.get(dataFromPatDetail.patient, "ssin", "")) ? "(" + this.localize('ssin', 'Registre national', this.language) + ": " + this.api.formatSsinNumber(_.trim(_.get(dataFromPatDetail.patient, "ssin", ""))) + ")" : "" ),
                            ( ! _.trim(_.get(dataFromPatDetail.patient, "ssin", "")) && !! _.trim(_.get(dataFromPatDetail.patient, "dateOfBirth", "")) ? "(" + this.localize('birthDate', 'Birthdate', this.language) + ": " + moment(_.trim(_.get(dataFromPatDetail.patient,"dateOfBirth",0)), "YYYYMMDD").format('DD/MM/YYYY') + ")" : "" )
                        ]).join(" ")},dataFromPatDetail.patient)

                        this.set("newMessage.important", true)
                        this.set("newMessage.document.title", this.localize('documentTransfer', 'Document transfer', this.language))
                        if(this.shadowRoot.querySelector('#linkedPatientComboxBox')) this.shadowRoot.querySelector('#linkedPatientComboxBox').value = _.trim(_.get(dataFromPatDetail,"patient.displayName"));
                        setTimeout(() => { if(_.trim(_.get(dataFromPatDetail.patient, "ssin", ""))) this.set("newMessage.patientInss", _.trim(_.get(dataFromPatDetail.patient, "ssin", ""))); }, 500 );

                        // FZ: continue with file attachment

                    }

                }





                console.log("dataFromPatDetail", dataFromPatDetail);

                let vaadinUpload = this.shadowRoot.querySelector('#vaadin-upload')
                vaadinUpload.set('i18n.addFiles.many', this.localize('upl_fil','Upload file',this.language))
                vaadinUpload.set('i18n.dropFiles.many', this.localize('uplabel','Drop files here...',this.language))

                if (componentOpenParameters) {
                    let msgFrom = ''
                    let msgNewTxt = ''
                    if (componentOpenParameters.destinations && componentOpenParameters.destinations.length && componentOpenParameters.received) {
                        msgFrom = `> [${componentOpenParameters.received}] ${componentOpenParameters.destinations[0].lastName} ${componentOpenParameters.destinations[0].firstName}`
                    }
                    if (componentOpenParameters.document && componentOpenParameters.document.textContent) {
                        const lines = componentOpenParameters.document.textContent.split('\n')
                        lines.forEach(l=>{
                            if (l.length) msgNewTxt += "> "+l+"\n"
                        })
                    } else {
                        msgNewTxt = this.localize('empty','Empty',this.language)
                    }
                    this.set("newMessage.annex", componentOpenParameters.annex || [])
                    this.set("newMessage.customMetas", componentOpenParameters.customMetas || {})
                    this.set('newMessage.recipients',componentOpenParameters.destinations || [])
                    this.set('newMessage.document.title', componentOpenParameters.document.title || '')
                    this.set('newMessage.document.textContent',
                        componentOpenParameters.type === 'fwd' ? `\r\n\r\n====${this.localize(componentOpenParameters.type,'',this.language)} ====\r\n${componentOpenParameters && componentOpenParameters.document && componentOpenParameters.document.textContent || this.localize('empty','Empty',this.language)}`
                        : componentOpenParameters.type === 'replyto' ? `\r\n\r\n${msgFrom} :\r\n${msgNewTxt}`
                        : ''
                    )
                    // this.set("newMessage.patientInss", componentOpenParameters.patientInss)
                    vaadinUpload.files = this.newMessage.annex
                    this.set('isForwardOrReply',
                        componentOpenParameters.type === 'fwd' ? `(${this.localize(componentOpenParameters.type,'',this.language)})`
                        : componentOpenParameters.type === 'replyto' ? `(${this.localize('answer','Answer',this.language)})`
                        : ''
                    )
                }

                this.$['new-msg'].open()

            }

            _uploadedFilesChanged() {

                const files = _.clone(this.files);
                // console.log('cloned files',files)
                const vaadinUpload = this.shadowRoot.querySelector('#vaadin-upload');

                Promise.all(files.filter(f => !f.attached).map(f => {
                    f.attached = true;
                    return this.api.document().newInstance(this.user, null, { documentType: 'result', mainUti: this.api.document().uti(f.type), name: f.name }).then(d => this.api.document().createDocument(d)).then(d => {
                        f.doc = d;
                        f.uploadTarget = (f.uploadTarget || vaadinUpload.target).replace(/\{documentId\}/, d.id);
                        return f;
                    })
                })).then(files => {
                    files.map(file=>{
                        console.log('enters in map',file)
                        const fr = new FileReader();
                        fr.onload = function (se) {
                            let fileByteArray = [];
                            new Uint8Array(se.target.result).forEach(int8 => fileByteArray.push(int8));
                            this.set('newMessage.annex',[{
                                "content": fileByteArray,
                                "filename": file.name,
                                "mimeType": file.type ? file.type : 'text/plain',
                                "title": file.name,
                                "size": file.size>1024?(file.size/1024).toFixed(2) + " ko":file.size + " o"
                            }]);
                            console.log('annexes',this.newMessage.annex)
                            this.dispatchEvent(new CustomEvent('file-received', file));
                        }.bind(this);
                        fr.readAsArrayBuffer(file);
                    })
                    files.length && vaadinUpload.uploadFiles(files);
                });
            }

            saveCurrentContact() {
                if(!this.currentContact.id ) {
                    this.currentContact.id = this.api.crypto().randomUuid()
                }
                return (this.currentContact.rev ? this.api.contact().modifyContactWithUser(this.user, this.currentContact) : this.api.contact().createContactWithUser(this.user, this.currentContact)).then(c=>this.api.register(c,'contact')).then(c => (this.currentContact.rev = c.rev) && c);
            }

			_fileUpload(e){
				e.preventDefault();

				if(e.detail && e.detail.file){

                    console.log('form',form)
                    if (!this.currentContact) {
                        console.log('no currentContact, return;')
                        this.push('currentContact.subContacts',{services: []}); // return;
                        // return;
                    }
                    const vaadinUpload = this.shadowRoot.querySelector('#vaadin-upload');
                    const f = e.detail.file;
                    const d = f.doc;

                    let sc = this.currentContact.subContacts.find(sbc => (sbc.status || 0) & 64);
                    if (!sc) {
                        sc = { status: 64, services: [] };
                        this.currentContact.subContacts.push(sc);
                    }
                    const svc = this.api.contact().service().newInstance(this.user, { content: _.fromPairs([[this.language, { documentId: d.id, stringValue: f.name }]]), label: 'document' });
                    this.currentContact.services.push(svc);
                    console.log('currentContact',this.currentContact)
                    sc.services.push({ serviceId: svc.id });
                    if (!vaadinUpload.files.find(f => !f.complete && !f.error)) {
                        this.saveCurrentContact();
                    }
                    console.log('v-up.files',vaadinUpload.files)
                    this.set('uploadedFiles',vaadinUpload.files)
				}

            }

			_fileUploadRemove(e){
				if(e.detail && e.detail.file) {
					this.newMessage.annex.splice(this.newMessage.annex.indexOf(e.detail.file), 1);
				}
            }

			_sendMessage(){

                this.set("busySendingMessage", true);
                console.log( this.newMessage );
                // return;

                this.$['success'].classList.remove('displayNotif')
                this.$['failed'].classList.remove('displayNotif')
                this.set('busySendingMessage',true)

				this.api.hcparty().getCurrentHealthcareParty().then(currentHcp =>{
				    console.log('currentHcp',currentHcp)

                    const forcedMetas = this._setMetaDatas(currentHcp,currentHcp,this._wrapRecipientData(this.newMessage.recipients[0]),this.newMessage.annex)
                    let customMetas = this.newMessage.customMetas
                    Object.keys(forcedMetas).forEach(k=>customMetas[k] = forcedMetas[k])
                    console.log('newMessage',this.newMessage)

                    let builtStatus = 0<<0 | 1<<1
                    builtStatus = this.newMessage && this.newMessage.important ? builtStatus|1<<2 : builtStatus
                    builtStatus = this.newMessage && this.newMessage.encrypted ? builtStatus|1<<3 : builtStatus
                    builtStatus = this.newMessage && this.newMessage.annex.length ? builtStatus|1<<4 : builtStatus
                    console.log('status',builtStatus)

                    let message = {
                        id : this.api.crypto().randomUuid(),
                        publicationId : (new Date).getTime(),
                        publicationDateTime : parseInt(moment().format('YYYYMMDD')),
                        expirationDateTime : parseInt(moment().add(1,"years").format('YYYYMMDD')),
                        customMetas : customMetas,
                        document : {
                            title: this.newMessage.document.title ? this.newMessage.document.title : 'No title',
                            textContent: this.newMessage.document.textContent,
                            mimeType: 'text/plain',
                            filename: this.newMessage.document.title ? this.newMessage.document.title : 'No title'
                        },
                        freeText : this.newMessage.document.textContent ? this.newMessage.document.textContent : '',
                        freeInformationTableTitle : null,
                        freeInformationTableRows : {},
                        patientInss : this.newMessage && this.newMessage.patientInss ? this.newMessage.patientInss : null,
                        annex : this.newMessage.annex,
                        copyMailTo : [],
                        documentTitle : this.newMessage.document.title ? this.newMessage.document.title : 'No title',
                        annexList : this.newMessage.annex,
                        useReceivedReceipt : this.newMessage && this.newMessage.useReceivedReceipt ? this.newMessage.useReceivedReceipt : false,
                        useReadReceipt : this.newMessage && this.newMessage.useReadReceipt ? this.newMessage.useReadReceipt : false,
                        usePublicationReceipt : this.newMessage && this.newMessage.usePublicationReceipt ? this.newMessage.usePublicationReceipt : false,
                        hasAnnex : this.newMessage.annex && this.newMessage.annex.length > 0,
                        hasFreeInformations : false,
                        important : this.newMessage && this.newMessage.important ? this.newMessage.important : false,
                        encrypted : this.newMessage && this.newMessage.encrypted ? this.newMessage.encrypted : false,
                        destinations : this.newMessage.recipients.map(recipient => this._wrapRecipientData(recipient)),
                        sender : {
                            identifierType: "NIHII",
                            id: _.trim(_.get(currentHcp, "nihii", "")),
                            quality: _.trim(_.get(currentHcp,"quality","DOCTOR")).toUpperCase(),
                            applicationId: _.trim(_.get(currentHcp,"applicationID","")),
                            lastName: _.trim(_.get(currentHcp,"lastName","")),
                            firstName: _.trim(_.get(currentHcp,"firstName","")),
                            organizationName: _.trim(_.get(currentHcp,"name","")),
                            personInOrganisation: ""
                        },
                        fromHealthcarePartyId: currentHcp.id,
                        status: builtStatus
                    };

					console.log('request',this.api.keystoreId,this.api.tokenId,this.credentials.ehpassword,message,
                        message.usePublicationReceipt,
                        message.useReceivedReceipt,
                        message.useReadReceipt)

                    this.api.fhc().Ehboxcontroller().sendMessageUsingPOST(
                        this.api.keystoreId,
                        this.api.tokenId,
                        this.credentials.ehpassword,
                        message,
						""+message.usePublicationReceipt,
                        ""+message.useReceivedReceipt,
                        ""+message.useReadReceipt)
                        .then(response => {
                        	console.log(response);
                        	if(response) {
								this._resetComponentData();
                                this.set('busySendingMessage',false)
                                this.set('newMessage.annex',[]);
                                this.set('uploadedFiles',[])
                                this.$['success'].classList.add('displayNotif')
								this.$['new-msg'].close()
							}
                        })
                        .catch(ex =>{
							console.log(ex);
                            this.$['failed'].classList.add('displayNotif')
                            this.set('busySendingMessage',false)
						})

				})
			}

			msgBodyFileInputSelected() {

                let messageBodyFile = this.shadowRoot.querySelector('#messageBodyFile');
                let messageBodyText = this.shadowRoot.querySelector('#messageBodyText');

                messageBodyText.value = undefined;
                messageBodyText.disabled = false;
                messageBodyText.classList.remove("form-disabled");

				if( messageBodyFile.inputElement && messageBodyFile.inputElement.inputElement &&
                    messageBodyFile.inputElement.inputElement.files.length > 0){
                    let file = messageBodyFile.inputElement.inputElement.files[0];

                    const fr = new FileReader();
					fr.onload = function (e) {
						// let binfile = btoa(new Uint8Array(e.target.result).reduce((data, byte) => data + String.fromCharCode(byte), ""));
                        let fileByteArray = [];
                        new Uint8Array(e.target.result).forEach(int8 => fileByteArray.push(int8));

                        this.set('newMessage.document.content', fileByteArray);
                    }.bind(this)
                    fr.readAsArrayBuffer(file)

                    this.set('newMessage.document.filename', file.name);
                    this.set('newMessage.document.mimeType', file.type);

                    messageBodyText.disabled = true;
                    messageBodyText.classList.add("form-disabled");
				}
				else{
					this.set('newMessage.document.content', null);
					this.set('newMessage.document.filename', null);
					this.set('newMessage.document.mimeType', null);
                }
			}

            _isMedical(file) {
                let fileInfos
                // this.api.beresultimport().getInfos(file.doc.id).then(res=>fileInfos = res)
                const ext = (/[^.]+$/.exec(file.filename ? file.filename : file.name)).toString().toUpperCase()
                // const content = this._readFile(file)
                return
                    ext.startsWith('DMA-') || ext.startsWith('HDM-') || ext.startsWith('ALA-') || ext.startsWith('CI-') || ext.startsWith('COG-') || ext == 'KMEHR' || ext == 'SUMEHR' ||
                    ext.includes('TEC') || ext.includes('REP') || ext.includes('REC') || ext.includes('LAB') || ext.includes('KOM') || ext.includes("IMA")
                    ? true : false
            }

            _getMedicalFormat(file) {
                const ext = (/[^.]+$/.exec(file.filename ? file.filename : file.name)).toString().toUpperCase()
                // const content = this._readFile(file)z
                return
                    ext.startsWith('DMA-') ? "Medidoc" :
                    ext.startsWith('HDM-') ? "Health One" :
                    ext.startsWith('ALA-') ? "Windoc/Medar" :
                    ext.startsWith('CI-') ? "Medibase" :
                    ext.startsWith('COG-') ? "Medigest" :
                    ext == 'KMEHR' ? ext :
                    ext == 'SUMEHR' ? ext :
                    ""
            }

            _getTransportType(file) {
                const ext = (/[^.]+$/.exec(file.filename ? file.filename : file.name)).toString().toUpperCase()
                // const content = this._readFile(file)
                const format = this._getMedicalFormat(file)
                const descr =
                    ext.includes('TEC') ? " technical report" :
                    ext.includes('REP') || ext.includes('REC') ? " medical report" :
                    ext.includes('LAB') ? " lab result" :
                    ext.includes('KOM') ? " comment file" :
                    ext.includes("IMA") ? " medical imaging" :
                    ""
                return format+descr
            }

            _setMetaDatas(author,sender,recipient,files) {
                const isPerson = (person) => {return person.lastName ? true : false},
                    isText = (file) => {return file.mimeType === 'text/plain'},
                    getMediaType = (file) => {
                        const ext = (/[^.]+$/.exec(file.filename ? file.filename : file.name)).toString().toUpperCase()
                        return 'TODO MediaType.'+ext
                    },
                    isTransaction = (isPerson(recipient) && this.uploadedFiles.length ? this._isMedical(this.uploadedFiles[0]) : false) // bool

                // initialize metas //
                let encodingMetas = {}
                if (files.length) {
                    files.forEach((f)=>{
                        if (isText(file)) {
                            const i = files.indexOf(f)
                            encodingMetas["HC-AttachmentEncodingType"+(i==0 ? '' : `-${i+1}`)] =  "UTF-8"
                        }
                    }) // foreach end
                }
                // required
                const neededMetas = {
                    // "CM-MediaType" : files.length ? getMediaType(files[0]) : '', // https://www.ehealth.fgov.be/standards/kmehr/en/tables TODO
                    "CM-AuthorID" : author.nihii ? author.nihii : author.ssin, // 12345625001
                    "CM-AuthorIDType" : author.nihii ? "NIHII" : "SSIN", // NIHII
                    "CM-AuthorType" : author.civility ? author.civility.toUpperCase() : 'NOTFOUND', // doctor
                    "CM-SenderID" : sender.nihii ? sender.nihii : sender.ssin, // 12345625001
                    "CM-SenderIDType" : sender.nihii ? "NIHII" : "SSIN", // NIHII
                    "CM-RecipientID" : recipient.id, // 12345625001
                    "CM-RecipientIDType" : recipient.identifierType.type, // NIHII
                    "CM-SendDateTime" : moment().format('YYYY-MM-DD hh:mm:ss'), // 1997-01-01 12:34:56
                    "CM-Requestnumber": parseInt(moment().format('YYMMDDhmmss')).toFixed(1), // 123456789.0
                    "CM-EhrMessageType" : isTransaction ? "Transactionnal" : "Functionnal",
                    "CM-EhrMessage" : isTransaction || false, // bool
                    "CM-EtkApplicationID": this.api.tokenId ? this.api.tokenId : '', // certificate ID
                    // "CM-AttachmentTransportType": files.length ? this._getTransportType(files[0]) : '' // main message format (first annex) TODO
                }
                // author
                , authorMetas = isPerson(author) ? {
                    "CM-AuthorLastName" : author.lastName.toUpperCase(),
                    "CM-AuthorFirstName" : author.firstName
                } : {
                    "CM-AuthorName": author.organizationName
                }
                // sender
                , senderMetas = isPerson(sender) ? {
                    "CM-SenderLastName": sender.lastName.toUpperCase(),
                    "CM-SenderFirstName": sender.firstName
                } : {
                    "CM-SenderName": sender.organizationName
                }
                // recipient
                , recipientMetas = isPerson(recipient) ? {
                    "CM-RecipientLastName" : recipient.lastName.toUpperCase(),
                    "CM-RecipientFirstName" : recipient.firstName,
                } : {
                    "CM-RecipientName" : recipient.organizationName
                }

                // join JSONs //
                let finalMetas = {}
                Object.keys(neededMetas).forEach(k=>finalMetas[k] = neededMetas[k])
                Object.keys(authorMetas).forEach(k=>finalMetas[k] = authorMetas[k])
                Object.keys(senderMetas).forEach(k=>finalMetas[k] = senderMetas[k])
                Object.keys(recipientMetas).forEach(k=>finalMetas[k] = recipientMetas[k])
                Object.keys(encodingMetas).forEach(k=>finalMetas[k] = encodingMetas[k])

                return finalMetas
            }

		}

        customElements.define(HtMsgNew.is, HtMsgNew)
    </script>
</dom-module>
