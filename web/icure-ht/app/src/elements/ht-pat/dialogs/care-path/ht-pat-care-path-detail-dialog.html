<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../../collapse-button/collapse-button.html">
<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">

<dom-module id="ht-pat-care-path-detail-dialog">
    <template>
        <style include="dialog-style scrollbar-style buttons-style">
            #care-path-detail{
                height: calc(98% - 12vh);
                width: 98%;
                max-height: calc(100% - 64px - 48px - 20px); /* 100% - header - margin - footer*/
                min-height: 400px;
                min-width: 800px;
                top: 64px;
            }

            .content{
                height: 100%;
            }

            .buttons{
                position: absolute;
                right: 0;
                bottom: 0;
                margin: 0;
            }

            #care-path-list-grid{
                margin: 1%;
                height: calc(100% - 55px);
            }

            paper-tabs {
                --paper-tabs-selection-bar-color: var(--app-text-color);
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color-dark);
                color: var(--app-text-color);
            }

            paper-tab iron-icon{
                color: var(--app-text-color-disabled);
            }

            paper-tab.iron-selected {
                font-weight: bold;
            }

            paper-tab.iron-selected > iron-icon {
                color: var(--app-text-color);
            }

            .tabIcon{
                height: 16px;
                width: 16px;
                padding: 4px;
            }

            .tab-selector {
                height: 48px;
                background: var(--app-secondary-color);
            }

            .btn-dropdown-container {
                text-align: right;
                position: absolute;
                margin-top: 8px;
                top: -40px;
                right: 4px;
                background-color: var(--app-background-color);
                opacity: 1;
                border-radius: 2px;
                z-index: 200;
                height: auto !important;
                box-shadow: var(--app-shadow-elevation-2);
                display: flex;
                flex-flow: column nowrap;
                align-items: stretch;
                border-radius: 3px;
                overflow: hidden;
                padding: 0;
                color: var(--app-text-color);
            }

            .btn-dropdown-container paper-button{
                display: flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: center;
                text-transform: capitalize;
                height: 28px;
                padding: 0 12px 0 8px;
                font-weight: 400;
                font-size: var(--font-size-normal);
                text-align: left;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                flex-grow: 1;
                border-radius: 0;
                margin: 0;
            }

            .btn-dropdown-container paper-icon-button:hover{
                background: var(--app-background-color-dark);
            }

            .btn-dropdown-container paper-button iron-icon{
                color: var(--app-secondary-color);
                height: 20px;
                width: 20px;
                margin-right: 4px;
                box-sizing: border-box;
            }

            .information-block{
                height: auto;
                width: 98%;
                border: 1px solid var(--app-background-color-dark);
                margin: 1%;
            }

            .information-block-title{
                background-color: var(--app-background-color-dark);
                height: 16px;
                font-size: var(--font-size-small);
                padding: 4px;
            }

            .information-block-content{
                height: auto;
                width: auto;
                padding: 4px;
            }

           .agreement-picker{
               min-width: 200px;
           }

            .care-path-selection{
                display: flex;
            }

            .w50{
                width: 50%;
                padding: 4px;
            }

            .not-found-mess{
                color: var(--app-status-color-nok);
                padding: 4px;
                margin-top: 18px;
            }

            .ko{
                color: var(--app-status-color-nok)
            }

            .ok{
                color: var(--app-status-color-ok)
            }

            .p4{
                padding: 4px;
            }
        </style>

        <paper-dialog id="care-path-detail">
            <h2 class="modal-title">
                [[localize('care-path', 'Care path', language)]] ([[patient.firstName]] [[patient.lastName]] - [[_formatDate(patient.dateOfBirth)]] [[_ageFormat(patient.dateOfBirth)]])
            </h2>
            <div class="content">
                <paper-tabs class="tab-selector" selected="{{tabs}}">
                    <paper-tab>
                        <iron-icon class="tabIcon" icon="vaadin:ambulance"></iron-icon>[[localize('care-path-info','Care path info',language)]]
                    </paper-tab>
                    <paper-tab>
                        <iron-icon class="tabIcon" icon="vaadin:group"></iron-icon>[[localize('care-path-team','Care team',language)]]
                    </paper-tab>
                    <paper-tab>
                        <iron-icon class="tabIcon" icon="vaadin:tools"></iron-icon>[[localize('care-path-procedure','Procedures',language)]]
                    </paper-tab>
                    <paper-tab>
                        <iron-icon class="tabIcon" icon="vaadin:newspaper"></iron-icon>[[localize('care-path-document','Documents',language)]]
                    </paper-tab>
                    <paper-tab>
                        <iron-icon class="tabIcon" icon="vaadin:newspaper"></iron-icon>[[localize('care-path-prescription','Prescription',language)]]
                    </paper-tab>
                </paper-tabs>
                <iron-pages selected="[[tabs]]">
                    <page>
                        <div class="information-block">
                            <div class="information-block-title">
                                [[localize('care-path', 'Care path', language)]]
                            </div>
                            <div class="information-block-content care-path-selection">
                                <vaadin-combo-box id="care-path-type" class="w50" label="[[localize('care-path-type','Care path type',language)]]" filter="{{carePathType}}" selected-item="{{selectedCarePathType}}"  filtered-items="[[carePathList]]" item-label-path="label.fr" >
                                    <template>[[item.label.fr]]</template>
                                </vaadin-combo-box>
                                <template is="dom-if" if="[[_isSelectableHealthElements(selectableEhealthElements)]]">
                                    <vaadin-combo-box id="linked-health-element" class="w50" label="[[localize('care-path-linked-health-element','linked health element',language)]]" filter="{{healthElement}}" selected-item="{{selectedHealthElement}}" filtered-items="[[selectableEhealthElements]]" item-label-path="descr">
                                        <template>[[_getHeDescr(item)]]</template>
                                    </vaadin-combo-box>
                                </template>
                                <template is="dom-if" if="[[!_isSelectableHealthElements(selectableEhealthElements)]]">
                                    <span class="not-found-mess">[[localize('care-path-act-he-prob-found', 'No corresponding active health problem found', language)]]</span>
                                </template>
                            </div>
                        </div>
                        <template is="dom-if" if="[[_isSelectableHealthElements(selectableEhealthElements)]]">
                            <div class="information-block">
                                <div class="information-block-title">
                                    [[localize('care-path-cond', 'Conditions', language)]]
                                </div>
                                <div>
                                    <template is="dom-if" if="[[isRenal(selectedHealthElement)]]">
                                        <div class="p4">
                                            <template is="juicy-html" html="[[localize('care-path-ren-crit-incl', 'Inclusion critera', language)]]"></template>
                                            <template is="dom-if" if="[[_checkPatientAge(patient)]]">
                                                <span class="ok">
                                                    <template is="juicy-html" html="[[localize('care-path-ren-crit-incl-age', 'Inclusion critera', language)]]"></template>
                                                </span>
                                            </template>
                                            <template is="dom-if" if="[[!_checkPatientAge(patient)]]">
                                                <span class="ko">
                                                    <template is="juicy-html" html="[[localize('care-path-ren-crit-incl-age', 'Inclusion critera', language)]]"></template>
                                                </span>
                                            </template>
                                        </div>
                                    </template>
                                    <template is="dom-if" if="[[!isRenal(selectedHealthElement)]]">
                                        <div class="p4">
                                            <template is="juicy-html" html="[[localize('care-path-dia-crit-incl', 'Inclusion critera', language)]]"></template>
                                            <template is="juicy-html" html="[[localize('care-path-dia-crit-excl', 'Exclusion critera', language)]]"></template>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div class="information-block">
                                <div class="information-block-title">
                                    [[localize('care-path-act', 'Activation', language)]]
                                </div>
                                <div class="information-block-content">
                                    <vaadin-date-picker class="agreement-picker" label="[[localize('care-path-start-date', 'Start date', language)]]" i18n="[[i18n]]" value="{{activationDateAsString.start}}"></vaadin-date-picker>
                                    <vaadin-date-picker class="agreement-picker" label="[[localize('care-path-end-date', 'End date', language)]]" i18n="[[i18n]]" value="{{activationDateAsString.end}}"></vaadin-date-picker>
                                </div>
                            </div>

                            <div class="information-block">
                                <div class="information-block-title">
                                    [[localize('care-path-supp-agr', 'Support agreements', language)]]
                                </div>
                                <div class="information-block-content">
                                    <vaadin-date-picker class="agreement-picker" label="[[localize('care-path-acc-pat', 'Patient agreement', language)]]" i18n="[[i18n]]" value="{{agreementsDateAsString.patient}}"></vaadin-date-picker>
                                    <vaadin-date-picker class="agreement-picker" label="[[localize('care-path-acc-phys', 'Physician agreement', language)]]" i18n="[[i18n]]" value="{{agreementsDateAsString.physician}}"></vaadin-date-picker>
                                    <vaadin-date-picker class="agreement-picker" label="[[localize('care-path-acc-spec', 'Specialist agreement', language)]]" i18n="[[i18n]]" value="{{agreementsDateAsString.specialist}}"></vaadin-date-picker>
                                    <vaadin-date-picker class="agreement-picker" label="[[localize('care-path-acc-mut', 'Mutuality agreement', language)]]" i18n="[[i18n]]" value="{{agreementsDateAsString.mutuality}}"></vaadin-date-picker>
                                </div>
                            </div>
                        </template>
                    </page>
                    <page>

                    </page>
                    <page>

                    </page>
                    <page>

                    </page>
                </iron-pages>
            </div>
            <div class="buttons">
                <paper-button class="button" on-tap="_closeDialogs"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                <paper-button class="button button--save" on-tap="_openCarePathDetailDialog"><iron-icon icon="save" class="mr5 smallIcon" ></iron-icon> [[localize('care-path-save','Save',language)]]</paper-button>
                <paper-icon-button class="button--icon-btn" icon="more-vert" on-tap="_toggleAddActions"></paper-icon-button>
                <template is="dom-if" if="[[showMoreOptionContainer]]">
                    <div class="btn-dropdown-container">
                        <paper-button on-tap="_createContract"><iron-icon icon="vaadin:clipboard-text"></iron-icon>[[localize('care-path-print-contract', 'Print contract', language)]]</paper-button>
                    </div>
                </template>
            </div>
        </paper-dialog>
    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';
        import juicy from 'juicy-html'
        import mustache from "mustache/mustache.js";

        class HtPatCarePathDetailDialog extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-care-path-detail-dialog';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                    tabs:{
                        type: Number,
                        value: 0
                    },
                    showMoreOptionContainer: {
                        type: Boolean,
                        value: false
                    },
                    agreementsDateAsString:{
                        type: Object,
                        value: () => ({
                            patient: null,
                            physician: null,
                            specialist: null,
                            mutuality: null
                        })
                    },
                    activationDateAsString:{
                        type: Object,
                        value: () => ({
                            start: null,
                            end: null
                        })
                    },
                    carePathList:{
                        type: Array,
                        value: () => []
                    },
                    selectedCarePathType:{
                        type: Object,
                        value: () => {}
                    },
                    activeHealthElements:{
                      type: Array,
                      value: () => []
                    },
                    selectableEhealthElements:{
                        type: Array,
                        value: () => []
                    },
                    selectedHealthElement:{
                        type: Object,
                        value: () => {}
                    },
                    selectedCarePath:{
                        type: Object,
                        value: () => {}
                    }

                };
            }

            static get observers() {
                return ['_initDataProvider(user, api)', '_selectedCarePathTypeChanged(selectedCarePathType, selectedCarePathType.*)'];
            }

            ready() {
                super.ready();
            }

            open(){
                this.$['care-path-detail'].open()
            }

            _closeDialogs(){
                this.$["care-path-detail"].close()
            }

            _initDataProvider(){
                const carePathCode = ["BE-THESAURUS|10025768|3.1.0", "BE-THESAURUS|10119104|3.1.0"]
                this.api.code().getCodes(carePathCode.join(',')).then(hes => {

                    const pathList = [{
                            label: {fr: 'Trajet de soins insuffisance rénale chronique', nl: 'Chronisch nierfalen zorgpad' , en: 'Chronic renal failure care pathway'},
                            linkedHe: hes.find(he => he.id === "BE-THESAURUS|10119104|3.1.0") || {}
                        },
                        {
                            label: {fr: 'Trajet de soins diabète type 2', nl: 'Diabetes zorgpad type 2' , en: 'Diabetes Care Path Type 2'},
                             linkedHe: hes.find(he => he.id === "BE-THESAURUS|10025768|3.1.0") || {}
                        }
                    ]

                    this.set("carePathList", pathList)
                })
            }

            _formatDate(date){
                return date ? this.api.moment(date).format('DD/MM/YYYY') : null
            }

            _ageFormat(date) {
                return date ? this.api.getCurrentAgeFromBirthDate(date,( e , s ) => this.localize(e, s, this.language)) : '';
            }

            _toggleAddActions() {
                this.showMoreOptionContainer = !this.showMoreOptionContainer;
            }

            _actionIcon(showMoreOptionContainer) {
                return showMoreOptionContainer ? 'icons:close' : 'icons:more-vert';
            }

            _createContract(){
                //this.isRenal() === true ? this._getRenalPdfContent : this._getDiabetesPdfContent
                let pdfTemplate = ""

                pdfTemplate+="<div style='margin-top:100px'></div><p class='bold fs10'>Renal</p>"

                this.api.pdfReport(mustache.render(pdfTemplate, {}))
                    .then(printedPdf => !printedPdf.printed && this.api.triggerFileDownload( printedPdf.pdf, "application/pdf", _.kebabCase(_.trim(_.get(this,"_data.content.dateYYYYMMDD",moment().format("YYYYMMDD"))) + "-" +_ .trim(_.get(this,"_data.content.title",this.api.crypto().randomUuid()))) + ".pdf" ))

            }

            _selectedCarePathTypeChanged(){
                if(this.selectedCarePathType){
                    this.set("selectableEhealthElements", this.activeHealthElements.filter(he => he.codes.find(c => c.type === "BE-THESAURUS") && he.codes.find(c => c.code === _.get(this.selectedCarePathType, 'linkedHe.code', null))))
                    this.set('selectedHealthElement', this.activeHealthElements.find(he => he.codes.find(c => c.type === "BE-THESAURUS") && he.codes.find(c => c.code === _.get(this.selectedCarePathType, 'linkedHe.code', null))))
                }
            }


            _getHeDescr(he){
                return _.get(_.get(he, 'codes', []).find(c => c.type === "ICPC"), 'code', "")+' - '+_.get(he, 'descr', "")
            }

            _isSelectableHealthElements(){
                return this.selectableEhealthElements.length > 0 ? true : false
            }

            isRenal(){
                return _.get(this.selectedHealthElement, 'codes', []).find(c => c.type === "BE-THESAURUS" && c.code === "10119104") ? true : false
            }

            _checkPatientAge(){
                return parseInt(_.trim(this._ageFormat(this.patient.dateOfBirth)).replace(/\D/g, '')) >= 18 ? true : false
            }

            _getRenalPdfContent(){

            }

            _getDiabetesPdfContent(){
                let pdfTemplate = ""

                return pdfTemplate
            }

        }
        customElements.define(HtPatCarePathDetailDialog.is, HtPatCarePathDetailDialog);
    </script>
</dom-module>
