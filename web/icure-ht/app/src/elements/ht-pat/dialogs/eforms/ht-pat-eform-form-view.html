<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../../collapse-button/collapse-button.html">

<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/paper-tabs-style.html">
<link rel="import" href="../../../../styles/notification-style.html">

<link rel="import" href="./ht-pat-eform-documents.html">



<dom-module id="ht-pat-eform-form-view">

    <template>

        <style include="dialog-style scrollbar-style buttons-style shared-style paper-tabs-style notification-style">

            .formContainer{
                height: calc(98% - 20px);
                width: 98%;
                padding: 1%;
            }

            .pageContent{
                padding: 12px;
                width: auto;
                box-sizing: border-box;
                height: 100%;
            }

            .tabIcon{
                padding-right: 10px;
            }

            iron-pages{
                height: 100%;
                height: calc(100% - 50px);
            }


        </style>

        <paper-tabs selected="{{tabs}}" >
            <paper-tab>
                <iron-icon class="tabIcon" icon="icons:assignment"></iron-icon> [[localize('eforms','E-forms',language)]]
            </paper-tab>
            <template is="dom-if" if="[[attachmentAvailable]]">
                <paper-tab class="doNotDisplay" id="tabAttachments">
                    <iron-icon class="tabIcon" icon="editor:attach-file"></iron-icon> [[_getAttachmentCount(attachmentCount)]] [[localize('attachments','Attachments',language)]]
                </paper-tab>
            </template>
        </paper-tabs>
        <iron-pages selected="[[tabs]]">
            <page>
                <div class="pageContent">
                    <ht-spinner active="[[isLoading]]"></ht-spinner>
                    <template is="dom-if" if="[[!isLoading]]" restamp="true">
                        <template is="dom-if" if="[[embededFormDomIf]]"><embed id="embededForm" src="[[selectedFormInfo.clientUrl]]" class="formContainer"/></template>
                    </template>
                </div>
            </page>
            <page>
                <div class="pageContent">
                    <ht-pat-eform-form-documents id="htPatEformFormDocuments" api="[[api]]" i18n="[[i18n]]" user="[[user]]" patient="[[patient]]" language="[[language]]" resources="[[resources]]" current-contact="[[currentContact]]" unlinked-documents="[[unlinkedDocuments]]" linked-documents="[[linkedDocuments]]"></ht-pat-eform-form-documents>
                </div>
            </page>
        </iron-pages>

    </template>

    <script>

        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';
        import xml2js from 'xml2js/lib/xml2js';

        class HtPatEformFormView extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {

            static get is() {
                return 'ht-pat-eform-form-view';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient: {
                        type: Object,
                        value: () => {
                        }
                    },
                    currentContact: {
                        type: Object,
                        value: () => {
                        }
                    },
                    isLoading: {
                        type: Boolean,
                        value: false
                    },
                    hcp: {
                        type: Object,
                        value: () => {
                        }
                    },
                    eformsHost: {
                        type: Object,
                        value: {}
                    },
                    selectedForm: {
                        type: Object,
                        value: () => {
                        }
                    },
                    oAuthToken: {
                        type: Object,
                        value: () => {
                        }
                    },
                    selectedFormInfo: {
                        type: Object,
                        value: () => {
                        }
                    },
                    patientSumehr: {
                        type: String,
                        value: null
                    },
                    dataSetId:{
                        type:String,
                        value: null
                    },
                    embededFormDomIf: {
                        type: Boolean,
                        value: false
                    },
                    tabs:{
                        type: Number,
                        value: 0
                    },
                    attachmentAvailable:{
                        type: Boolean,
                        value: false
                    },
                    availableDocumentList:{
                        type: Array,
                        value: () => []
                    },
                    selectedDocumentIdToBeImported:{
                        type: String,
                        value: null
                    },
                    unlinkedDocuments:{
                        type: Array,
                        value: () => []
                    },
                    linkedDocuments:{
                        type: Array,
                        value: () => []
                    }
                };
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
            }

            _reset() {
                this.set('selectedForm', {})
                this.set('dataSetId', null)
                this.set('selectedFormInfo', {})
                this.set('embededFormDomIf', false)
                this.set('isLoading', false)
            }

            _showForm() {

                const promResolve = Promise.resolve()

                return promResolve
                    .then(() => {
                        this.set('isLoading', true)
                        this.set('attachmentAvailable', false)
                    })
                    .then(() => this._removeForm())
                    .then(removeFormResonse => _.parseInt(_.get(removeFormResonse, 'response.status', 0)) !== 204 ? this._showErrorNotification(_.get(removeFormResonse, 'response', 0), _.get(removeFormResonse, 'content', {})) : null)
                    .then(() => this._createFormInstance())
                    .then(formInstanceResponse => _.parseInt(_.get(formInstanceResponse, 'response.status', 0)) !== 201 ? this._showErrorNotification(_.get(formInstanceResponse, 'response', 0), _.get(formInstanceResponse, 'content', {})) : promResolve
                        .then(() => this.set("embededFormDomIf", false))
                        .then(() => this.set("selectedFormInfo", _.get(formInstanceResponse, 'content', {})))
                        .then(() => this.set("embededFormDomIf", true))
                        .then(() => this._uploadDataSet())
                    )
                    .then(dataSetResponse => _.parseInt(_.get(dataSetResponse, 'response.status', 0)) !== 200 ? this._showErrorNotification(_.get(dataSetResponse, 'response', 0), _.get(dataSetResponse, 'content', {})) : promResolve
                        .then(() => this.set("dataSetId", _.get(dataSetResponse, 'content', null)))
                        .then(() => this._mergeDataSet())
                    )
                    .then(mergeDataSetResponse => _.parseInt(_.get(mergeDataSetResponse, 'response.status', 0)) === 204 ? this._unlockForm() : this._showErrorNotification(_.get(mergeDataSetResponse, 'response', 0), _.get(mergeDataSetResponse, 'content', {})))
                    .finally(() => {
                        this.set('isLoading', false)
                        this.set('attachmentAvailable', true)
                    })

            }

            _createFormInstance() {
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": this.language+"-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': "application/json;charset=UTF-8"
                    },
                    body: JSON.stringify({
                        id: _.get(this, 'selectedForm.id', {}),
                        format: _.get(this, 'selectedForm.exportConfiguration.defaultDocumentFormat', 'A4'),
                        integrator: {
                            name: 'Topaz',
                            version: '1.0'
                        },
                        headless: false,
                        formManagesAttachments: true
                    })
                })
            }

            _uploadDataSet(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/data-set", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "text/plain",
                        "Accept-Language": this.language+"-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': "application/vnd.healthconnect.eforms.kmehr.integrator.v1+xml;charset=UTF-8"
                    },
                    body: _.get(this, 'patientSumehr', null)
                })
            }

            _mergeDataSet(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/merge", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": this.language+"-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        "Content-Type": "application/json;charset=UTF-8"
                    },
                    body: JSON.stringify({
                        "dataSetId" : _.get(this, 'dataSetId', null),
                        "mergeStrategy" : "extend"
                    })
                })
            }

            _unlockForm(){
               return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/lock", {
                   method: "DELETE",
                   mode: "cors",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": this.language+"-BE",
                       Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),

                   }
               })
            }

            _removeForm(){
               return _.get(this.selectedFormInfo, 'formId', null) ? this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null), {
                   method: "DELETE",
                   mode: "cors",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": this.language+"-BE",
                       Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),

                   }
               }) : Promise.resolve({response: {status: 204}})
            }

            _getFormAdr(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/adr", {
                    method: "GET",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": this.language+"-BE",
                        Authorization: 'Bearer '+ _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': 'application/xml'
                    }
                })
            }

            _getAllAttachments(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/attachments", {
                    method: "GET",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": this.language+"-BE",
                        Authorization: 'Bearer '+ _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': 'application/xml'
                    }
                })
            }

            _getExportFormat() {
               return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/pdf", {
                   method: "GET",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": this.language+"-BE",
                       Authorization: 'Bearer '+ _.get(this, 'oAuthToken.access_token', null),
                   }
               })
            }

            _showErrorNotification(response, content) {
                this.dispatchEvent(new CustomEvent('show-error-notification', {bubbles: true, composed: true, detail: {response: response, content: content}}))
            }

            _tabChanged() {
                this.dispatchEvent(new CustomEvent('tab-changed', {bubbles: true, composed: true, detail: {tab: _.get(this, 'tabs', 0)}}))
            }

            _joinDocument() {
                if(_.get(this, 'selectedDocumentIdToBeImported', null)) {
                    const selectedDoc = _.get(this, 'availableDocumentList', []).find(doc => _.get(doc, 'id', null) === _.get(this, 'selectedDocumentIdToBeImported', ''))

                    if(_.get(selectedDoc, 'attachmentId', null)){
                        (_.size(_.get(selectedDoc, 'encryptionKeys', [])) || _.size(_.get(selectedDoc, 'delegations', [])) ?
                                this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(_.get(this.user, 'healthcarePartyId', null), _.get(selectedDoc, 'id', null), _.size(_.get(selectedDoc, 'encryptionKeys', [])) ?
                                    _.get(selectedDoc, 'encryptionKeys', []) : _.get(selectedDoc, 'delegations', []))
                                        .then(({extractedKeys: enckeys}) => this.api.document().getAttachment(_.get(selectedDoc, 'id', null), _.get(selectedDoc, 'attachmentId', null), enckeys.join(','))) :
                                this.api.document().getAttachment(_.get(selectedDoc, 'id', null), _.get(selectedDoc, 'attachmentId', null))
                        ).then(attachment => this._addAttachment(selectedDoc, attachment))
                        .then(attachmentResponse =>
                            _.parseInt(_.get(attachmentResponse, 'response.status', 0)) === 201 ? this._linkDocument(selectedDoc) : this._showErrorNotification(_.get(attachmentResponse, 'response', 0), _.get(attachmentResponse, 'content', {}))
                        ).finally(() => {

                        })
                    }

                }
            }

            _linkDocument(selectedDoc){
                const targetDocument = _.head(_.remove(this.unlinkedDocuments, {id: _.get(selectedDoc, 'id', null)}))
                this.push("linkedDocuments", targetDocument)
                this.$["htPatEformFormDocuments"]._refreshLinkedAndAvailableDocuments()
            }

            _refreshAttachement(){
                return this._getAllAttachments().then(allAttachment => {
                    this.set('unlinkedDocuments', _.get(this, 'availableDocumentList', []))
                    this.set('linkedDocuments', [])
                    if(_.parseInt(_.get(allAttachment, 'response.status', 0)) === 200){
                        _.get(allAttachment, 'content', []).map(att => {
                            const docTarget = _.head(_.remove(this.unlinkedDocuments, {id: _.get(_.get(this, 'unlinkedDocuments', []).find(doc => _.get(doc, 'name', null) === _.get(att, 'fileName', null)), 'id', null)}))
                            this.push('linkedDocuments', docTarget)
                        })
                        this.$["htPatEformFormDocuments"]._refreshLinkedAndAvailableDocuments()
                    }
                })
            }

            _addAttachment(doc, attachment) {
                const attachmentAsBlob = new Blob([new Uint8Array(attachment)], {type: 'application/pdf'})

                const formData = new FormData();
                formData.append('attachment', attachmentAsBlob, _.get(doc, 'name', null));

                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/attachments", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": this.language+"-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null)
                    },
                    body: formData
                })
            }

            _sendForm() {

                const promResolve = Promise.resolve()

                return promResolve
                    .then(() => this._getFormAdr())
                    .then(adrResponse => _.parseInt(_.get(adrResponse, 'response.status', 0)) !== 200 ? this._showErrorNotification(_.get(adrResponse, 'response', 0), _.get(adrResponse, 'content', {})) : this.xmlStringToObject(_.get(adrResponse, 'content', null))
                        .then(parsedXml => {
                            const pdf = _.get(parsedXml, 'ADR.Attachment', []).find(att => _.get(att, 'MimeType', []).find(mt => mt === "application/pdf"))
                            return this._importDocumentIntoPatient(_.head(_.get(pdf, 'Content', [])), _.head(_.get(pdf, 'Name', [])), _.head(_.get(pdf, 'MimeType', []))).then(() => parsedXml).catch(() => parsedXml)
                        })
                    )
                    .then(parsedXml => {
                        console.log("parsedXml", parsedXml)
                        const eform = _.get(parsedXml, 'ADR.Attachment', []).find(att => _.get(att, 'MimeType', []).find(mt => mt === "application/xml"))
                        const recipient = _.get(this.selectedForm, 'fixedRecipient',[])
                        return this._sendFormUsingEhBox(parsedXml)
                    })
                    .finally(() => (this._reset()||true) && this.dispatchEvent(new CustomEvent('close-dialog', {bubbles: true, composed: true, detail: {}})))

            }

            xmlStringToObject(xml){
                return new Promise((resolve, reject) => {
                    xml2js.parseString(xml, { explicitArray: true, attrkey: 'attributes', charkey: 'value' }, (err, doc) => {
                        if (err) reject(err);
                        resolve(doc);
                    });
                });
            }

            _importDocumentIntoPatient(content, docName, mimeType) {

                const promResolve = Promise.resolve()

                return this.api.message().newInstance(this.user)
                    .then(nmi => this.api.message().createMessage(_.merge(nmi, {
                        transportGuid: "EFORM:IN:IMPORTED-DOCUMENT",
                        recipients: [this.user && this.user.healthcarePartyId],
                        metas: {
                            filename: docName,
                            mediaType: mimeType
                        },
                        toAddresses: [_.get(this.user, 'email', this.user && this.user.healthcarePartyId)],
                        subject: "Import form: "+ _.get(this. selectedForm, 'label', null) || null,
                        status : 0 | 1<<25 | (this.patient.id ? 1<<26 : 0)
                    })))
                    .then(createdMessage => Promise.all([createdMessage, this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("encrypt", this.user, createdMessage, this.api.crypto().utils.ua2ArrayBuffer(this.api.crypto().utils.text2ua(JSON.stringify({patientId : _.get(this.patient, 'id', null), isAssigned: true}))))]))
                    .then(([createdMessage, cryptedMeta]) => {
                        createdMessage.metas.cryptedInfo = Base64.encode(String.fromCharCode.apply(null, new Uint8Array(cryptedMeta)))
                        return this.api.message().modifyMessage(createdMessage)
                    })
                    .then(createdMessage => this.api.document().newInstance(this.user, createdMessage, {
                        documentType: 'request',
                        mainUti: this.api.document().uti(mimeType),
                        name: docName
                    }))
                    .then(newDocInstance => this.api.document().createDocument(newDocInstance))
                    .then(createdDocument => this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject('encrypt', this.user, createdDocument, this.api.crypto().utils.base64toArrayBuffer(content)).then(encryptedFileContent => ({createdDocument, encryptedFileContent })))
                    .then(({createdDocument, encryptedFileContent}) => this.api.document().setAttachment(createdDocument.id, null, encryptedFileContent))
                    .then(resourcesObject => {
                        //Import into currentContact
                        let sc = this.currentContact.subContacts.find(sbc => (sbc.status || 0) & 64);
                        if (!sc) {
                            sc = { status: 64, services: [] };
                            this.currentContact.subContacts.push(sc);
                        }
                        const svc = this.api.contact().service().newInstance(this.user, {
                            content: _.fromPairs([[this.language, { documentId: resourcesObject.id, stringValue: resourcesObject.name }]]),
                            label: 'document',
                            tags: [
                                {type: 'CD-TRANSACTION', code: 'request'},
                                {type: 'EFORMS', code: 'download'},
                            ]
                        });
                        this.currentContact.services.push(svc);
                        sc.services.push({ serviceId: svc.id });

                        return this.saveCurrentContact().then(() => this.dispatchEvent(new CustomEvent('eforms-download', {bubbles: true, composed: true, detail: {}})))
                    })
                    .catch(e => { console.log("---error upload attachment---", e); return promResolve })

            }

            saveCurrentContact() {
                if(!this.currentContact.id ) {
                    this.currentContact.id = this.api.crypto().randomUuid()
                }
                return (this.currentContact.rev ? this.api.contact().modifyContactWithUser(this.user, this.currentContact) : this.api.contact().createContactWithUser(this.user, this.currentContact)).then(c=>this.api.register(c,'contact')).then(c => (this.currentContact.rev = c.rev) && c);
            }

            _sendFormUsingEhBox(parsedXml) {

                const promResolve = Promise.resolve()
                const patternsValidation = {
                    heightDigits: /^([0-9]){8}$/i,
                    tenDigits: /^([0-9]){10}$/i,
                    elevenDigits: /^([0-9]){11}$/i
                }
                const publicationId = +new Date
                const subject = _.trim(_.get(parsedXml, "ADR.Subject[0]", ""))
                const annexes = _.compact(_.map(_.get(parsedXml, "ADR.Attachment", []), it => {
                    const filename = _.trim(_.get(it, "Name[0]", this.api.crypto().randomUuid()))
                    const attachmentByteArray = this.api.crypto().utils.base64toByteArray(_.get(it, "Content[0]"))
                    return !_.trim(_.get(it, "Content[0]")) ? false : {
                        content: attachmentByteArray,
                        filename: filename,
                        mimeType: _.trim(_.get(it, "MimeType[0]", "text/plain")),
                        title: filename,
                        // size: _.size(attachmentByteArray)
                    }
                }))

                const isEncrypted = false
                const useReceivedReceipt = true
                const useReadReceipt = true
                const usePublicationReceipt = true

                // Unread by default, then eval important, cyrpted & has annexes statuses
                let messageStatus = 1 << 1
                messageStatus = isEncrypted ? messageStatus | 1 << 3 : messageStatus
                messageStatus = !!_.size(annexes) ? messageStatus | 1 << 4 : messageStatus

                let sendMessageResponse = false

                return !_.size(parsedXml) ? promResolve : promResolve
                    .then(() => this.set('isLoading', true))
                    .then(() => _.map(_.get(parsedXml, "ADR.Addressee", []), it => {
                        const identifierValue = _.trim(_.trim(_.get(it, "Identifier[0]", "")).replace(/[^0-9]*/g, ""))
                        const isValidCbe = !!patternsValidation.tenDigits.test(identifierValue)
                        const isValidEhp = !!patternsValidation.tenDigits.test(identifierValue)
                        const isValidSsin = !!patternsValidation.elevenDigits.test(identifierValue) && this.api.patient().isValidSsin(identifierValue)
                        const isValidNihii = !!patternsValidation.heightDigits.test(identifierValue) || !!patternsValidation.elevenDigits.test(identifierValue)
                        const recipientsName = _.trim(_.get(it, "Name[0]", "")) ? _.trim(_.get(it, "Name[0]", "")) : _.trim(_.trim(_.get(it, "FirstName[0]", "")) + " " + _.trim(_.get(it, "FirstName[0]", "")))
                        return {
                            identifierType: {type: isValidCbe ? "CBE" : isValidEhp ? "EHP" : isValidSsin ? "SSIN" : "NIHII"},
                            id: identifierValue,
                            name: _.trim(recipientsName) ? _.trim(recipientsName) : null,
                            quality: _.trim(_.get(it, "Quality[0]", "DOCTOR")),
                        }
                    }))
                    .then(recipients => this.api.hcparty().getCurrentHealthcareParty().then(currentHcp => [currentHcp, recipients]))
                    .then(([currentHcp, recipients]) => [currentHcp, recipients, {
                        id: this.api.crypto().randomUuid(),
                        publicationId: publicationId,
                        publicationDateTime: parseInt(moment().format('YYYYMMDD')),
                        expirationDateTime: parseInt(moment().add(1, "years").format('YYYYMMDD')),
                        customMetas: {
                            "CM-AuthorID": _.trim(_.get(currentHcp, "nihii", _.get(currentHcp, "ssin", ""))),
                            "CM-AuthorIDType": _.trim(_.get(currentHcp, "nihii", "")) ? "NIHII" : "SSIN",
                            "CM-AuthorType": _.trim(_.get(currentHcp, "civility", "doctor")).toUpperCase(),
                            "CM-AuthorLastName": _.trim(_.get(currentHcp, "lastName", "")).toUpperCase(),
                            "CM-AuthorFirstName": _.trim(_.get(currentHcp, "firstName", "")),
                            "CM-AuthorName": (!_.trim(_.get(currentHcp, "lastName", "")) && !_.trim(_.get(currentHcp, "firstName", ""))) ? _.trim(_.get(currentHcp, "name", _.get(currentHcp, "companyName", ""))) : "",
                            "CM-RecipientID": _.trim(_.get(recipients, "[0].id", "")),
                            "CM-RecipientIDType": _.trim(_.get(recipients, "[0].type", "NIHII")),
                            "CM-RecipientName": recipientsName,
                            "CM-EhrMessage": false,
                            "CM-EhrMessageType": "Functionnal",
                            "CM-EtkApplicationID": _.trim(_.get(this, "api.tokenId", "")),
                            "CM-Requestnumber": publicationId,
                            "CM-SendDateTime": moment().format('YYYY-MM-DD HH:mm:ss'),
                        },
                        document: {title: subject, textContent: "", mimeType: 'text/plain', filename: subject},
                        freeText: "",
                        freeInformationTableTitle: null,
                        freeInformationTableRows: {},
                        patientInss: null,
                        annex: annexes,
                        copyMailTo: [],
                        documentTitle: subject,
                        annexList: annexes,
                        useReceivedReceipt: useReceivedReceipt,
                        useReadReceipt: useReadReceipt,
                        usePublicationReceipt: usePublicationReceipt,
                        hasAnnex: !!_.size(annexes),
                        hasFreeInformations: false,
                        important: false,
                        encrypted: isEncrypted,
                        destinations: recipients,
                        sender: {
                            identifierType: "NIHII",
                            id: _.trim(_.get(currentHcp, "nihii", "")),
                            quality: _.trim(_.get(currentHcp, "quality", "doctor")).toUpperCase(),
                            applicationId: "",
                            lastName: _.trim(_.get(currentHcp, "lastName", "")),
                            firstName: _.trim(_.get(currentHcp, "firstName", "")),
                            organizationName: (!_.trim(_.get(currentHcp, "lastName", "")) && !_.trim(_.get(currentHcp, "firstName", ""))) ? _.trim(_.get(currentHcp, "name", _.get(currentHcp, "companyName", ""))) : "",
                            personInOrganisation: ""
                        },
                        fromHealthcarePartyId: _.get(currentHcp, "id", ""),
                        status: messageStatus
                    }])
                    .then(([currentHcp, recipients, message]) => {

                        // EhBox won't allow for empty values
                        Object.keys(message.customMetas).forEach(k => { if (!_.trim(message.customMetas[k])) try { delete message.customMetas[k] } catch (e) {}})

                        return this.api.fhc().Ehboxcontroller().sendMessageUsingPOST(_.get(this, "api.keystoreId", null), _.get(this, "api.tokenId", null), _.get(this, "api.credentials.ehpassword", null), message, usePublicationReceipt, useReceivedReceipt, useReadReceipt)
                            .then(x => sendMessageResponse = x)
                            .catch(x => sendMessageResponse = x)
                            .finally(() => {
                                console.log("sendMessageResponse", sendMessageResponse);
                                // return sendMessageResponse===true ? this._confirmMessageSuccessfullySent() : _.trim(_.get(sendMessageResponse,"message","")) === "api-error403" ? this._etkNotRetrieved() : this._confirmMessageSuccessfullySent()
                                return this.dispatchEvent(new CustomEvent("feedback-message", {composed: true, bubbles: true, detail: {message:sendMessageResponse===true ? this.localize("sen_succ", "Message successfully sent", this.language) : this.localize("sen_error", "Message could not be sent", this.language)}}))
                            })

                    })
                    .catch(e => this.dispatchEvent(new CustomEvent("feedback-message", {composed: true, bubbles: true, detail: {message:this.localize("sen_error", "Message could not be sent", this.language)}})))

            }

        }

        customElements.define(HtPatEformFormView.is, HtPatEformFormView);

    </script>

</dom-module>
