<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../../collapse-button/collapse-button.html">

<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/paper-tabs-style.html">


<dom-module id="ht-pat-eform-form-view">
    <template>
        <style include="dialog-style scrollbar-style buttons-style shared-style paper-tabs-style">

            .formContainer{
                height: calc(98% - 20px);
                width: 98%;
                padding: 1%;
            }


        </style>

        <embed id="embededForm" src="[[selectedFormInfo.clientUrl]]" class="formContainer"/>

    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';

        class HtPatEformFormView extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-eform-form-view';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient: {
                        type: Object,
                        value: () => {
                        }
                    },
                    currentContact: {
                        type: Object,
                        value: () => {
                        }
                    },
                    isLoading: {
                        type: Boolean,
                        value: false
                    },
                    hcp: {
                        type: Object,
                        value: () => {
                        }
                    },
                    eformsHost: {
                        type: Object,
                        value: {}
                    },
                    selectedForm: {
                        type: Object,
                        value: () => {
                        }
                    },
                    oAuthToken: {
                        type: Object,
                        value: () => {
                        }
                    },
                    selectedFormInfo: {
                        type: Object,
                        value: () => {
                        }
                    },
                    patientSumehr: {
                        type: String,
                        value: null
                    },
                    dataSetId:{
                        type:String,
                        value: null
                    }
                };
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
            }


            _reset() {
                this.set('selectedForm', {})
                this.set('dataSetId', null)
                this.set('selectedFormInfo', {})
            }

            _showForm() {
                this._removeForm().then(removeFormResonse => {
                    return this._createFormInstance()
                }).then(formInstanceResponse => {
                    _.parseInt(_.get(formInstanceResponse, 'response.status', 0)) === 201 ? this.set("selectedFormInfo", _.get(formInstanceResponse, 'content', {})) : null
                    return _.parseInt(_.get(formInstanceResponse, 'response.status', 0)) === 201 ? this._uploadDataSet() : Promise.resolve({})
                }).then(dataSetResponse => {
                    _.parseInt(_.get(dataSetResponse, 'response.status', 0)) === 200 ? this.set("dataSetId", _.get(dataSetResponse, 'content', null)) : null
                    return _.parseInt(_.get(dataSetResponse, 'response.status', 0)) === 200 ? this._mergeDataSet() : Promise.resolve({})
               }).then(mergeDataSetResponse => {
                    return _.parseInt(_.get(mergeDataSetResponse, 'response.status', 0)) === 204 ? this._unlockForm() : Promise.resolve({})
               }).finally(() => {

               })
            }

            _createFormInstance() {
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': "application/json;charset=UTF-8"
                    },
                    body: JSON.stringify({
                        id: _.get(this, 'selectedForm.id', {}),
                        format: _.get(this, 'selectedForm.exportConfiguration.defaultDocumentFormat', 'A4'),
                        integrator: {
                            name: 'Topaz',
                            version: '1.0'
                        },
                        headless: false,
                        formManagesAttachments: true
                    })
                })
            }

            _uploadDataSet(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/data-set", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "text/plain",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': "application/vnd.healthconnect.eforms.kmehr.integrator.v1+xml;charset=UTF-8"
                    },
                    body: _.get(this, 'patientSumehr', null)
                })
            }

            _mergeDataSet(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/merge", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        "Content-Type": "application/json;charset=UTF-8"
                    },
                    body: JSON.stringify({
                        "dataSetId" : _.get(this, 'dataSetId', null),
                        "mergeStrategy" : "extend"
                    })
                })
            }

            _unlockForm(){
               return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/lock", {
                   method: "DELETE",
                   mode: "cors",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": "fr-BE",
                       Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),

                   }
               })
            }

            _removeForm(){
               return _.get(this.selectedFormInfo, 'formId', null) ? this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null), {
                   method: "DELETE",
                   mode: "cors",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": "fr-BE",
                       Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),

                   }
               }) : Promise.resolve({})
            }

            _getFormAdr(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/adr", {
                    method: "GET",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer '+ _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': 'application/xml'
                    }
                })
            }

            _getExportFormat(){
               return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/pdf", {
                   method: "GET",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": "fr-BE",
                       Authorization: 'Bearer '+ _.get(this, 'oAuthToken.access_token', null),
                   }
               })
            }

            _sendForm(){
                this._getFormAdr().then(adr => {
                    const parseAdr = JSON.parse(adr)
                    console.log(parseAdr)
                })
            }

        }
        customElements.define(HtPatEformFormView.is, HtPatEformFormView);
    </script>
</dom-module>
