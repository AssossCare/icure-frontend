<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../../collapse-button/collapse-button.html">

<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">
<link rel="import" href="../../../../styles/shared-styles.html">
<link rel="import" href="../../../../styles/paper-tabs-style.html">
<link rel="import" href="../../../../styles/notification-style.html">


<dom-module id="ht-pat-eform-form-view">
    <template>
        <style include="dialog-style scrollbar-style buttons-style shared-style paper-tabs-style notification-style">

            .formContainer{
                height: calc(98% - 20px);
                width: 98%;
                padding: 1%;
            }

            .pageContent{
                padding: 12px;
                width: auto;
                box-sizing: border-box;
                height: 100%;
            }

            .tabIcon{
                padding-right: 10px;
            }

            iron-pages{
                height: 100%;
                height: calc(100% - 50px);
            }


        </style>

        <paper-tabs selected="{{tabs}}" >
            <paper-tab>
                <iron-icon class="tabIcon" icon="icons:assignment"></iron-icon> [[localize('eforms','E-forms',language)]]
            </paper-tab>
            <template is="dom-if" if="[[attachmentAvailable]]">

            </template>
            <paper-tab class="doNotDisplay" id="tabAttachments">
                <iron-icon class="tabIcon" icon="editor:attach-file"></iron-icon> [[_getAttachmentCount(attachmentCount)]] [[localize('attachments','Attachments',language)]]
            </paper-tab>
        </paper-tabs>
        <iron-pages selected="[[tabs]]">
            <page>
                <div class="pageContent">
                    <ht-spinner active="[[isLoading]]"></ht-spinner>
                    <template is="dom-if" if="[[!isLoading]]">
                        <embed id="embededForm" src="[[selectedFormInfo.clientUrl]]" class="formContainer"/>
                    </template>
                </div>
            </page>
            <page>
                <div class="pageContent">

                </div>
            </page>
        </iron-pages>

    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';
        import xml2js from 'xml2js/lib/xml2js';

        class HtPatEformFormView extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-eform-form-view';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient: {
                        type: Object,
                        value: () => {
                        }
                    },
                    currentContact: {
                        type: Object,
                        value: () => {
                        }
                    },
                    isLoading: {
                        type: Boolean,
                        value: false
                    },
                    hcp: {
                        type: Object,
                        value: () => {
                        }
                    },
                    eformsHost: {
                        type: Object,
                        value: {}
                    },
                    selectedForm: {
                        type: Object,
                        value: () => {
                        }
                    },
                    oAuthToken: {
                        type: Object,
                        value: () => {
                        }
                    },
                    selectedFormInfo: {
                        type: Object,
                        value: () => {
                        }
                    },
                    patientSumehr: {
                        type: String,
                        value: null
                    },
                    dataSetId:{
                        type:String,
                        value: null
                    },
                    tabs:{
                        type: Number,
                        value: 0
                    },
                    attachmentAvailable:{
                        type: Boolean,
                        value: false
                    }
                };
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
            }


            _reset() {
                this.set('selectedForm', {})
                this.set('dataSetId', null)
                this.set('selectedFormInfo', {})
            }

            _showForm() {
                this.set('isLoading', true)
                this._removeForm().then(removeFormResonse => {
                    _.parseInt(_.get(removeFormResonse, 'response.status', 0)) !== 204 ? this._showErrorNotification(_.get(removeFormResonse, 'response', 0), _.get(removeFormResonse, 'content', {})) : null
                    return this._createFormInstance()
                }).then(formInstanceResponse => {
                    _.parseInt(_.get(formInstanceResponse, 'response.status', 0)) === 201 ? this.set("selectedFormInfo", _.get(formInstanceResponse, 'content', {})) : this._showErrorNotification(_.get(formInstanceResponse, 'response', 0), _.get(formInstanceResponse, 'content', {}))
                    return _.parseInt(_.get(formInstanceResponse, 'response.status', 0)) === 201 ? this._uploadDataSet() : Promise.resolve({})
                }).then(dataSetResponse => {
                    _.parseInt(_.get(dataSetResponse, 'response.status', 0)) === 200 ? this.set("dataSetId", _.get(dataSetResponse, 'content', null)) : this._showErrorNotification(_.get(dataSetResponse, 'response', 0), _.get(dataSetResponse, 'content', {}))
                    return _.parseInt(_.get(dataSetResponse, 'response.status', 0)) === 200 ? this._mergeDataSet() : Promise.resolve({})
               }).then(mergeDataSetResponse => {
                    _.parseInt(_.get(mergeDataSetResponse, 'response.status', 0)) !== 204 ? this._showErrorNotification(_.get(mergeDataSetResponse, 'response', 0), _.get(mergeDataSetResponse, 'content', {})) : null
                    return _.parseInt(_.get(mergeDataSetResponse, 'response.status', 0)) === 204 ? this._unlockForm() : Promise.resolve({})
               }).finally(() => {
                    this.set('isLoading', false)
               })
            }

            _createFormInstance() {
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': "application/json;charset=UTF-8"
                    },
                    body: JSON.stringify({
                        id: _.get(this, 'selectedForm.id', {}),
                        format: _.get(this, 'selectedForm.exportConfiguration.defaultDocumentFormat', 'A4'),
                        integrator: {
                            name: 'Topaz',
                            version: '1.0'
                        },
                        headless: false,
                        formManagesAttachments: true
                    })
                })
            }

            _uploadDataSet(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/data-set", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "text/plain",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': "application/vnd.healthconnect.eforms.kmehr.integrator.v1+xml;charset=UTF-8"
                    },
                    body: _.get(this, 'patientSumehr', null)
                })
            }

            _mergeDataSet(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/merge", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        "Content-Type": "application/json;charset=UTF-8"
                    },
                    body: JSON.stringify({
                        "dataSetId" : _.get(this, 'dataSetId', null),
                        "mergeStrategy" : "extend"
                    })
                })
            }

            _unlockForm(){
               return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/lock", {
                   method: "DELETE",
                   mode: "cors",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": "fr-BE",
                       Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),

                   }
               })
            }

            _removeForm(){
               return _.get(this.selectedFormInfo, 'formId', null) ? this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null), {
                   method: "DELETE",
                   mode: "cors",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": "fr-BE",
                       Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),

                   }
               }) : Promise.resolve({response: {status: 204}})
            }

            _getFormAdr(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/adr", {
                    method: "GET",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer '+ _.get(this, 'oAuthToken.access_token', null),
                        'Content-Type': 'application/xml'
                    }
                })
            }

            _getExportFormat(){
               return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/pdf", {
                   method: "GET",
                   headers: {
                       Accept: "application/json;charset=UTF-8",
                       "Accept-Language": "fr-BE",
                       Authorization: 'Bearer '+ _.get(this, 'oAuthToken.access_token', null),
                   }
               })
            }

            _addAttachment(){
                return this.api.executeFetchRequest(_.get(this, 'eformsHost.eForms', null) + "/cloud/api/v1/forms/"+_.get(this.selectedFormInfo, 'formId', null)+"/attachments", {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        Accept: "application/json;charset=UTF-8",
                        "Accept-Language": "fr-BE",
                        Authorization: 'Bearer ' + _.get(this, 'oAuthToken.access_token', null),
                        "Content-Type": 'multipart/mixed; boundary="jbiB48jJ8GsJHjes0vxvvA7ExjJBfOH8o20eSJU"; boundary=6o2knFse3p53ty9dmcQvWAIx1zInP11uCfbm'
                    },
                    body: JSON.stringify({
                        //todo
                    })
                })
            }

            _sendForm(){
                this._getFormAdr().then(adrResponse => {
                    if( _.parseInt(_.get(adrResponse, 'response.status', 0)) === 200){
                        this.xmlStringToObject(_.get(adrResponse, 'content', null)).then(parsedXml => {
                            const pdf =_.get(parsedXml, 'ADR.Attachment', []).find(att => _.get(att, 'MimeType', []).find(mt => mt === "application/pdf"))
                            const eform = _.get(parsedXml, 'ADR.Attachment', []).find(att => _.get(att, 'MimeType', []).find(mt => mt === "application/xml"))

                            this._importDocumentIntoPatient(_.head(_.get(pdf, 'Content', [])), _.head(_.get(pdf, 'Name', [])), _.head(_.get(pdf, 'MimeType', [])))

                        })
                    }else{
                        this._showErrorNotification(_.get(adrResponse, 'response', 0), _.get(adrResponse, 'content', {}))
                    }
                })
            }

            xmlStringToObject(xml){
                return new Promise((resolve, reject) => {
                    xml2js.parseString(xml, { explicitArray: true, attrkey: 'attributes', charkey: 'value' }, (err, doc) => {
                        if (err) reject(err);
                        resolve(doc);
                    });
                });
            }

            _importDocumentIntoPatient(content, docName, mimeType){
                this.api.message().newInstance(this.user)
                    .then(nmi => this.api.message().createMessage(_.merge(nmi, {
                        transportGuid: "EFORM:IN:IMPORTED-DOCUMENT",
                        recipients: [this.user && this.user.healthcarePartyId],
                        metas: {
                            filename: docName,
                            mediaType: mimeType
                        },
                        toAddresses: [_.get(this.user, 'email', this.user && this.user.healthcarePartyId)],
                        subject: "Import form: "+ _.get(this. selectedForm, 'label', null) || null,
                        status : 0 | 1<<25 | (this.patient.id ? 1<<26 : 0)
                    }))
                        .then(createdMessage => Promise.all([createdMessage, this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("encrypt", this.user, createdMessage, this.api.crypto().utils.ua2ArrayBuffer(this.api.crypto().utils.text2ua(JSON.stringify({patientId : _.get(this.patient, 'id', null), isAssigned: true}))))]))
                        .then(([createdMessage, cryptedMeta]) => {
                            createdMessage.metas.cryptedInfo = Base64.encode(String.fromCharCode.apply(null, new Uint8Array(cryptedMeta)))
                            return this.api.message().modifyMessage(createdMessage)
                        })
                        .then(createdMessage => this.api.document().newInstance(this.user, createdMessage, {
                            documentType: 'request',
                            mainUti: this.api.document().uti(mimeType),
                            name: docName
                        }))
                        .then(newDocInstance => this.api.document().createDocument(newDocInstance))
                        .then(createdDocument => this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject('encrypt', this.user, createdDocument, this.api.crypto().utils.base64toArrayBuffer(content))
                            .then(encryptedFileContent => ({createdDocument, encryptedFileContent })))
                        .then(({createdDocument, encryptedFileContent}) => this.api.document().setAttachment(createdDocument.id, null, encryptedFileContent))
                        .then(resourcesObject => {
                            //Import into currentContact
                            let sc = this.currentContact.subContacts.find(sbc => (sbc.status || 0) & 64);
                            if (!sc) {
                                sc = { status: 64, services: [] };
                                this.currentContact.subContacts.push(sc);
                            }
                            const svc = this.api.contact().service().newInstance(this.user, {
                                content: _.fromPairs([[this.language, { documentId: resourcesObject.id, stringValue: resourcesObject.name }]]),
                                label: 'document',
                                tags: [
                                    {type: 'CD-TRANSACTION', code: 'request'},
                                    {type: 'EFORMS', code: 'download'},
                                ]
                            });
                            this.currentContact.services.push(svc);
                            sc.services.push({ serviceId: svc.id });

                            this.saveCurrentContact().then(c => {
                                this.dispatchEvent(new CustomEvent('eforms-download', {bubbles: true, composed: true, detail: {}}))
                            })
                        }).finally(() => {
                            this.dispatchEvent(new CustomEvent('close-dialog', {bubbles: true, composed: true, detail: {}}))
                        })).catch(e => {
                            console.log("---error upload attachment---", e)
                        })
            }

            saveCurrentContact() {
                if(!this.currentContact.id ) {
                    this.currentContact.id = this.api.crypto().randomUuid()
                }
                return (this.currentContact.rev ? this.api.contact().modifyContactWithUser(this.user, this.currentContact) : this.api.contact().createContactWithUser(this.user, this.currentContact)).then(c=>this.api.register(c,'contact')).then(c => (this.currentContact.rev = c.rev) && c);
            }

            _showErrorNotification(response, content){
                this.dispatchEvent(new CustomEvent('show-error-notification', {bubbles: true, composed: true, detail: {response: response, content: content}}))
            }

        }
        customElements.define(HtPatEformFormView.is, HtPatEformFormView);
    </script>
</dom-module>
