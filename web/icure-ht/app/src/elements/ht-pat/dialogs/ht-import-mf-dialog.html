<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">


<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">

<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-themes/material/vaadin-button.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-progress-bar/vaadin-progress-bar.html">
<link rel="import" href="../../../../bower_components/paper-tabs/paper-tabs.html">

<link rel="import" href="../../ht-spinner/ht-spinner.html">

<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../dynamic-form/ckmeans-grouping.html">
<link rel="import" href="../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel="import" href="../../../../bower_components/vaadin-upload/vaadin-upload.html">

<link rel="import" href="../../../dialog-style.html">
<link rel="import" href="../../../notification-style.html">

<dom-module id="ht-import-mf-dialog">
    <template>
        <style>
            .buttons{
                display: flex;
                flex-grow: 1;
                box-sizing: border-box;
                justify-content: flex-end;
                padding-top: 16px;
            }


            .endline {
                display: flex;
                flex-direction: row;
                margin: 0;
                border-top: 1px solid var(--app-background-color-dark);
            }


            .modal-button{
                --paper-button-ink-color: var(--app-secondary-color-dark);
                color: var(--app-text-color);
                font-weight: 400;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            .modal-button--cancel {
                background: var(--app-background-color-dark);
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }

            .modal-button--save{
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                font-weight: 700;
                text-transform: capitalize;
            }

            .modal-title{
                background:  var(--app-background-color-dark);
                margin-top: 0;
                padding: 16px 24px;
            }


            paper-dialog {
                width: 80%;
                height:80%;
                min-width:30%;
                margin: 0;
            }

            paper-radio-group paper-radio-button {
                line-height: 48px;
            }


            vaadin-grid {
                height: 10%;
                max-height:100%;
                border: none;
                --vaadin-grid-body-row-hover-cell: {
                    /* background-color: var(--app-primary-color); */
                    color: white;
                };
                --vaadin-grid-body-row-selected-cell: {
                    background-color: var(--app-primary-color);
                    color: white;
                };
            }

            .supercontent{
                max-height:80%;
                padding-top: 24px;
                padding-bottom: calc(24px + 12px);
                overflow-y: scroll;
            }

            .content {
            }


            @media screen and (max-width: 672px) {
                .modal-button {
                    margin: 4px 0;
                }
            }


            .modal-button[disabled] {
                background: var(--app-secondary-color-dark);
                cursor: initial;
                box-shadow: none;
            }

            #loading {
                padding: 10px
            }


        </style>


        <paper-dialog id="dialog">

            <div class="supercontent">
                <h2 class="modal-title">[[localize('upl_mffil','Upload SMF/PMF files',language)]]<span class="extra-info">[[localize('xml_files', '(XML files)', language)]]</span></h2>
                <div class="content">
                    <vaadin-upload id="vaadin-upload" no-auto files="{{files}}" accept="text/xml,application/xml"
                                   target="[[api.host]]/document/{documentId}/attachment/multipart;jsessionid=[[api.sessionId]]" method="PUT" form-data-name="attachment"
                                   on-upload-success="_mfFileUploaded">

<!--                        <slot name="file-list">

                        <vaadin-grid items="[[files]]" as="file">
                            <vaadin-grid-column width="150px">
                                <template class="header">
                                    [[localize('file','File',language)]]
                                </template>
                                <template>
                                    <vaadin-upload-file file="[[file]]"></vaadin-upload-file>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                        </slot>-->

                    </vaadin-upload>
                </div>


                <h2 class="modal-title">[[localize("pat_import_exist","Patient exists status",language)]] <span>([[remainingPatientImports.length]] [[localize("file_import_remaining", "remaining files")]])</span></h2>
                <div  class="content">
                    <vaadin-grid items="[[patientCheckStatuses]]">
                        <vaadin-grid-column width="150px">
                            <template class="header">
                                [[localize('file','File',language)]]
                            </template>
                            <template>
                                [[item.filename]]
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="150px">
                            <template class="header">
                                [[localize('smf_patient','Patient SMF',language)]]
                            </template>
                            <template>
                                [[item.smf_patients]]
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="150px">
                            <template class="header">
                                [[localize('existing_patient','Patient existant',language)]]
                            </template>
                            <template>
                                [[item.existing_patients]]
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="70px">
                            <template class="header">
                                [[localize('fusion','Fusionner',language)]]
                            </template>
                            <template>
                                <vaadin-checkbox class="" checked="{{item.check}}"> </vaadin-checkbox>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="70px">
                            <template class="header">
                                [[localize('contacts','Renommer',language)]]
                            </template>
                            <template>
                                <paper-button data-item="" on-click="_renameSmfPatient" >[[localize('rename','Renommer',language)]]</paper-button>
                            </template>
                        </vaadin-grid-column>
                    </vaadin-grid>
                </div>

                <h2 class="modal-title">[[localize("pat_import_sta","Patient import status",language)]] <span>([[remainingPatientImports.length]] [[localize("file_import_remaining", "remaining files")]])</span></h2>
                <div  class="content">
                    <vaadin-grid items="[[patientImportStatuses]]">
                        <vaadin-grid-column width="150px">
                            <template class="header">
                                [[localize('file','File',language)]]
                            </template>
                            <template>
                                [[item.filename]]
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="150px">
                            <template class="header">
                                [[localize('pati','Patient',language)]]
                            </template>
                            <template>
                                [[item.patient.firstName]] [[item.patient.lastName]]
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="70px">
                            <template class="header">
                                [[localize('folder','Folder',language)]]
                            </template>
                            <template>
                                <span class$="[[_statusDetailClass(item.statuses.patient)]]">[[_statusDetail(item.statuses.patient)]]</span>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="70px">
                            <template class="header">
                                [[localize('contacts','Contacts',language)]]
                            </template>
                            <template>
                                <span class$="[[_statusDetailClass(item.statuses.contacts)]]">[[_statusDetail(item.statuses.contacts)]]</span>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="70px">
                            <template class="header">
                                Health elements
                            </template>
                            <template>
                                <span class$="[[_statusDetailClass(item.statuses.healthElements)]]">[[_statusDetail(item.statuses.healthElements)]]</span>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="70px">
                            <template class="header">
                                Invoices
                            </template>
                            <template>
                                <span class$="[[_statusDetailClass(item.statuses.invoices)]]">[[_statusDetail(item.statuses.invoices)]]</span>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="70px">
                            <template class="header">
                                [[localize('files','Files',language)]]
                            </template>
                            <template>
                                <span class$="[[_statusDetailClass(item.statuses.documents)]]">[[_statusDetail(item.statuses.documents)]]</span>
                            </template>
                        </vaadin-grid-column>
                        <vaadin-grid-column width="70px">
                            <template class="header">
                                Confirm
                            </template>
                            <template>
                                <paper-button data-item="" on-click="_confirmImportExistingSMFPatientX" >[[localize('continue','Confirm',language)]]</paper-button>
                            </template>
                        </vaadin-grid-column>
                    </vaadin-grid>
                </div>
            </div>
            <!--<ht-spinner class="import-spinner" active="[[isImportingPatients]]"></ht-spinner>-->
            <div class="buttons">
                <paper-button class="modal-button" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
                <paper-button dialog-dismiss>[[localize('close','Close',language)]]</paper-button>
                <paper-button on-click="abortImport" >[[localize('abort','Abort',language)]]</paper-button>
                <paper-button on-click="saveImportLog" >[[localize('save_import_log','Save import log',language)]]</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>

        import _ from 'lodash/lodash';
        import JsBarcode from 'JsBarcode';
        import mustache from "mustache/mustache.js";
        import moment from 'moment/src/moment';
        import promiseLimit from 'promise-limit';

        class HtImportMfDialog extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {

            static get is() {
                return 'ht-import-mf-dialog';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                }
            }

            static get observers() {
                return [
                ];
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
                this.checkLimit = promiseLimit(1)
                this.importLimit = promiseLimit(1)
            }

            open() {
                this.$.dialog.open()
            }

            //////////////



            _mfFileUploaded(e) {
                const vaadinUpload = this.$['vaadin-upload']
                const f = e.detail.file
                const d = f.doc
                this.push('remainingPatientImports', d)
                this.push('importPromisePool',
                    this.checkLimit(() =>
                        this.checkIfPatientExists(d)
                    )
                )
                console.log("file uploaded: " + d.name)
            }

            checkIfPatientExists(document) {
                return this.api.bekmehr().checkIfSMFPatientsExists(document.id, "123245", null, this.user.language, {}).then(results => {
                    if(!forceImport && _.some(results, (pat => pat.exists))) {
                        this.push('patientCheckStatuses', {
                            filename: document.name,
                            smf_patients: results.map(pat => pat.firstName + " " + pat.lastName).join(" - "),
                            existing_patients: results.filter(pat=>pat.exists).map(pat => pat.firstName + " " + pat.lastName).join(" - "),
                            document: document,
                            check:false,
                        })
                    } else {
                        this.push('importPromisePool',
                            this.importLimit(() =>
                                this.importPatientFromDocument(document)
                            )
                        )
                    }
                })
            }

            acceptImport() {
                this.patientCheckStatuses.forEach(p => {
                    if(p.check) {
                        this.push('importPromisePool',
                            this.importLimit(() =>
                                this.importPatientFromDocument(p.document)
                            )
                        )
                    }
                })
            }

            importPatientFromDocument(document) {
                if (this.importAborted) {
                    console.log("import aborted: " + document.name)
                    this.set('hideSpinner', true)
                    this.set('isLoadingPatient', false)
                    this.set('isImportingPatients', false)
                    let fakepat = {
                        firstName: "Document",
                        lastName: document.name
                    }
                    this.push('patientImportStatuses', {
                        patient: fakepat, filename: document.name, statuses: {
                            contacts: {success: null, error: null},
                            healthElements: {success: null, error: null},
                            invoices: {success: null, error: null},
                            documents: {success: null, error: null},
                            patient: {success: false, error: {message: "Aborted"}}
                        }
                    })
                    this.removeFromRemainingPatientImports(document)
                    return Promise.resolve()
                }
                this.set('hideSpinner', false)
                this.set('isLoadingPatient', true)
                this.set('isImportingPatients', true)
                console.log("importing: " + document.name)
                this.dispatchEvent(new CustomEvent('idle', {bubbles: true, composed: true}))

                this.startTime = Date.now()
                return this.api.bekmehr().importSmf(document.id, "123245", null, this.user.language, {}).then(results => {
                    console.log("done importSmf", (Date.now() - this.startTime) / 1000)
                    let patpromises = results.map(result => {
                        return this.api.patient().modifyPatientWithUser(this.user, result.patient).then(pat => {
                            let prolist = [
                                Promise.all(result.forms.map(form => {
                                    return this.api.form().newInstance(this.user, pat, form)
                                })).then(forms => this.api.form().modifyForms(forms)),
                                Promise.all(result.ctcs.map(ctc => {
                                    return this.api.contact().newInstance(this.user, pat, ctc)
                                })).then(c => {
                                    return this.api.contact().modifyContactsWithUser(this.user, c)
                                }),
                                Promise.all(result.hes.map(he => {
                                    return this.api.helement().newInstance(this.user, pat, he)
                                })).then(h => {
                                    return this.api.helement().modifyHealthElements(h)
                                }),
                                Promise.all(result.documents.map(doc => {
                                    return this.api.document().newInstance(this.user, pat, doc)
                                })).then(d => {
                                    return this.api.document().modifyDocuments(d)
                                })
                            ]
                            return prolist.reduce((acc, prom) => acc.then(res => prom.then(innerRes => res.concat(innerRes))), Promise.resolve([]))
                                .then(
                                    datastatus => {
                                        console.log("done import: " + document.name + ":" + pat.firstName + " " + pat.lastName + "; " + pat.id)
                                        console.log(datastatus)

                                        this.push('patientImportStatuses', {
                                            patient: pat, filename: document.name, statuses: {
                                                contacts: {success: null, error: null},
                                                healthElements: {success: null, error: null},
                                                invoices: {success: null, error: null},
                                                documents: {success: null, error: null},
                                                patient: {success: true, error: null}
                                            }
                                        })
                                        return Promise.resolve()
                                    },
                                    // patient imported but error importing patient data
                                    err => {
                                        // TODO: check specific error for contacts, he, etc
                                        console.log(err)
                                        this.push('patientImportStatuses', {
                                            patient: pat, filename: document.name, statuses: {
                                                contacts: {success: null, error: null},
                                                healthElements: {success: null, error: null},
                                                invoices: {success: null, error: null},
                                                documents: {success: null, error: null},
                                                patient: {success: false, error: err}
                                            }
                                        })
                                        return Promise.resolve()
                                    }
                                )
                        })
                    })
                    return Promise.all(patpromises)
                }).then(
                    () => {
                        // import status already pushed at patient level
                        this.removeFromRemainingPatientImports(document)
                        console.log("done encrypt", (Date.now() - this.startTime) / 1000)
                        return Promise.resolve()
                    },
                    err => {
                        console.log(err)
                        let fakepat = {
                            firstName: "Document",
                            lastName: document.name
                        }
                        this.push('patientImportStatuses', {
                            patient: fakepat, filename: document.name, statuses: {
                                contacts: {success: null, error: null},
                                healthElements: {success: null, error: null},
                                invoices: {success: null, error: null},
                                documents: {success: null, error: null},
                                patient: {success: false, error: err}
                            }
                        })
                        this.removeFromRemainingPatientImports(document)
                        return Promise.resolve()
                    }
                )
            }

            _openImportPatientFromMfDialog() {
                const vaadinUpload = this.$['vaadin-upload']
                vaadinUpload.set('i18n.addFiles.many', this.localize('upl_fil','Upload file',this.language))
                vaadinUpload.set('i18n.dropFiles.many', this.localize('uplabel','Drop files here...',this.language))
                if (this.remainingPatientImports === undefined || this.remainingPatientImports.length === 0) {
                    this.remainingPatientImports = []
                    this.patientImportStatuses = []
                    this.importPromisePool = Promise.resolve([])
                    this.importAborted = false
                    this.$['patient-import-dialog'].open()
                } else {
                    this.$['importPatientStatus'].open()
                }
            }

            removeFromRemainingPatientImports(doc) {
                this.remainingPatientImports = this.remainingPatientImports.filter(item => {
                    return item.id !== doc.id
                })
                console.log("remaining: " + this.remainingPatientImports.length)
                if (this.remainingPatientImports.length === 0) {
                    this.importAborted = false
                    console.log("ALL IMPORT DONE")
                    this.set('hideSpinner', true)
                    this.set('isLoadingPatient', false)
                    this.set('isImportingPatients', false)
                }
            }

            abortImport() {
                if (this.remainingPatientImports.length) {
                    this.importAborted = true
                }
            }

            saveImportLog() {
                this.generateXlsFile(this.patientImportStatuses.map(stat => {
                    return {
                        filename: stat.filename,
                        firstName: stat.patient.firstName,
                        lastName: stat.patient.lastName,
                        folder: this._statusDetail(stat.statuses.patient),
                        contacts: this._statusDetail(stat.statuses.contacts),
                        healthElements: this._statusDetail(stat.statuses.healthElements),
                        invoices: this._statusDetail(stat.statuses.invoices),
                        documents: this._statusDetail(stat.statuses.documents),
                    }
                }))
            }

            generateXlsFile(data) {

                // Create xls work book and assign properties
                const xlsWorkBook = {SheetNames: [], Sheets: {}}
                xlsWorkBook.Props = {Title: "Patients list", Author: "iCure"}

                // Create sheet based on json data collection
                var xlsWorkSheet = XLSX.utils.json_to_sheet(data)

                // Link sheet to workbook
                XLSX.utils.book_append_sheet(xlsWorkBook, xlsWorkSheet, 'Patients list')

                // Virtual data output
                var xlsWorkBookOutput = new Buffer(XLSX.write(xlsWorkBook, {bookType: 'xls', type: 'buffer'}))

                // Put output to virtual "file"
                var fileBlob = new Blob([xlsWorkBookOutput], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"})

                // Create download link and append to page's body
                var downloadLink = document.createElement("a")
                document.body.appendChild(downloadLink)
                downloadLink.style = "display: none"

                // Create url
                var urlObject = window.URL.createObjectURL(fileBlob)

                // Link to url
                downloadLink.href = urlObject
                downloadLink.download = "patients-list.xls"

                // Trigger download and drop object
                downloadLink.click()
                window.URL.revokeObjectURL(urlObject)

                // Free mem
                fileBlob = false
                xlsWorkBookOutput = false

                return
            }

        }

        customElements.define(HtImportMfDialog.is, HtImportMfDialog);

    </script>

</dom-module>
