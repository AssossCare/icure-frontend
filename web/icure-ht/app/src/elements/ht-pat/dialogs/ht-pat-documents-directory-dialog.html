<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">

<link rel="import" href="../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel="import" href="../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../collapse-button/collapse-button.html">

<link rel="import" href="../../../styles/dialog-style.html">
<link rel="import" href="../../../styles/scrollbar-style.html">
<link rel="import" href="../../../styles/buttons-style.html">
<link rel="import" href="../../../styles/notification-style.html">
<link rel="import" href="../../../styles/spinner-style.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/paper-tabs-style.html">



<dom-module id="ht-pat-documents-directory-dialog">



    <template>



        <style include="dialog-style scrollbar-style buttons-style notification-style spinner-style shared-styles paper-tabs-style">

            #document-directory-dialog{
                height: calc(98% - 12vh);
                width: 98%;
                max-height: calc(100% - 64px - 48px - 20px); /* 100% - header - margin - footer*/
                min-height: 400px;
                min-width: 800px;
                top: 64px;
            }

            .content{
                height: 100%;
            }

            .buttons{
                position: absolute;
                right: 0;
                bottom: 0;
                margin: 0;
            }

            .btn-dropdown-container {
                text-align: right;
                position: absolute;
                margin-top: 8px;
                top: -40px;
                right: 4px;
                background-color: var(--app-background-color);
                opacity: 1;
                border-radius: 2px;
                z-index: 200;
                height: auto !important;
                box-shadow: var(--app-shadow-elevation-2);
                display: flex;
                flex-flow: column nowrap;
                align-items: stretch;
                border-radius: 3px;
                overflow: hidden;
                padding: 0;
                color: var(--app-text-color);
            }

            .btn-dropdown-container paper-button{
                display: flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: center;
                text-transform: capitalize;
                height: 28px;
                padding: 0 12px 0 8px;
                font-weight: 400;
                font-size: var(--font-size-normal);
                text-align: left;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
                flex-grow: 1;
                border-radius: 0;
                margin: 0;
            }

            .btn-dropdown-container paper-icon-button:hover{
                background: var(--app-background-color-dark);
            }

            .btn-dropdown-container paper-button iron-icon{
                color: var(--app-secondary-color);
                height: 20px;
                width: 20px;
                margin-right: 4px;
                box-sizing: border-box;
            }

            .information-block{
                height: auto;
                width: 98%;
                border: 1px solid var(--app-background-color-dark);
                margin: 1%;
            }

            .information-block-title{
                background-color: var(--app-background-color-dark);
                height: 16px;
                font-size: var(--font-size-small);
                padding: 4px;
            }

            .ko{
                color: var(--app-status-color-nok)
            }

            .ok{
                color: var(--app-status-color-ok)
            }

            .tab-page-title{
                height: 20px;
                padding: 4px;
                width: 98%;
            }

            .close-view-btn{
                right: 0;
                position: absolute;
                margin: 2px;
            }

            .horizontal {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                flex-basis: 100%;
                align-items: center;
            }

            .contact-year-container{
                width: 98%;
                margin: 1%;
                height: auto;
                border: 1px solid var(--app-background-color-dark);
            }

            .contact-year-title{
                height: 20px;
                padding: 5px;
                width: auto;
                background: var(--app-background-color-dark);
            }

            .ctc-nbr{
                height: 20px;
                width: 20px;
                border-radius: 50%;
                background: var(--app-secondary-color);
                color: white;
                text-align: center;
                float: left;
                margin-left: 15px;
            }

            .year{
                float: left;
            }

            .contact-year-ctc-container{
                height: auto;
            }

            .contact-year-ctc-container-ctc{
                height: 20px;
                width: 98%;
                padding: 4px;
            }

            .menu-item {
                @apply --padding-menu-item;
                height: 24px;
                min-height: 24px;
                font-size: var(--font-size-normal);
                text-transform: inherit;
                justify-content: space-between;
                cursor: pointer;
                @apply --transition;
            }

            .sublist .menu-item {
                font-size: var(--font-size-normal);
                min-height:20px;
                height:20px;
            }

            .menu-item:hover{
                background: var(--app-dark-color-faded);
                @apply --transition;
            }

            .menu-item .iron-selected{
                background:var(--app-primary-color);

            }

            .one-line-menu {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-weight: 400;
                padding-left:0;
            }

            .list-title {
                flex-basis: calc(100% - 72px);
                font-weight: bold;
            }

            .menu-item-icon{
                height: 20px;
                width: 20px;
                padding: 0px;
            }

            collapse-button[opened] .menu-item-icon{
                transform: scaleY(-1);
            }

            .sublist{
                background:var(--app-light-color);
                margin:0 0 0 -30px;
                padding:0;
            }

            .sublist-document{
                background:var(--app-light-color);
                margin:0 0 0 0px;
                padding:0;
            }

            .table-line-menu {
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                height: 100%;
                width: 100%;
            }

            .table-line-menu-top{
                padding-left: var(--padding-menu-item_-_padding-left);
                padding-right: var(--padding-menu-item_-_padding-right);
                box-sizing: border-box;
            }

            .table-line-menu div:not(:last-child){
                border-right: 1px solid var(--app-background-color-dark);
                height: 20px;
                line-height: 20px;
            }

            .items-number {
                font-size: var(--font-size-small);
                padding: 2px;
                border-radius: 50%;
                height: 14px;
                width: 14px;
                background: var(--app-background-color-light);
                color: var(--app-text-color);
                display: flex;
                flex-flow: row nowrap;
                justify-content: center;
                align-items: center;
                text-align: center;
                margin-right: 4px;
            }

            .items-number span{
                display: block;
            }

            .list-title {
                flex-basis: calc(100% - 72px);
                font-weight: bold;
            }

            .one-line-menu {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-weight: 400;
                padding-left:0;
            }

            .menu-item paper-icon-button.menu-item-icon--add, .list-info paper-icon-button.menu-item-icon {
                padding: 0px;
                height: 18px;
                width: 18px;
                border-radius: 3px;
                background: var(--app-secondary-color);
                color: var(--app-text-color-light);
                margin-right: 8px;
            }

            .overlaySpinnerContainer {
                position:absolute;
                width:100%;
                height:100%;
                z-index:10;
                background:rgba(255, 255, 255, .8);
                top:0;
                left:0;
                margin:0;
                padding:0;
            }

            .overlaySpinner {
                max-width:80px;
                margin:100px auto
            }

            .docDetailDialog{
                display: flex;
                height: 100%;
                width: auto;
                margin: 0;
                padding: 0;
            }

            .doc-menu-list{
                height: 100%;
                width: 50%;
                background-color: var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
                overflow: auto;
                position: relative;
            }

            .doc-menu-view{
                height: 100%;
                width: 50%;
                position: relative;
                background: white;
            }

            .doc-preview{
                height: calc(100% - 50px);
                width: auto;
                margin: 1%;
                overflow: auto;
            }

            .doc-container{
                height: 100%;
            }

            .doc-container-list{
                height: 100%;
                overflow: auto;
                background-color: white;
            }

            .doc-submenu-container{
                height: 100%;
            }

            #vaadinGrid {
                padding:0;
                margin:0;
                height:calc(100% - 2px);
            }

        </style>



        <paper-dialog id="document-directory-dialog" always-on-top="true" no-cancel-on-outside-click="true" no-cancel-on-esc-key="true">



            <h2 class="modal-title pl10">[[localize('documentsDirectory','Documents directory',language)]] ([[_data.currentPatient.firstName]] [[_data.currentPatient.lastName]] - [[_data.currentPatient.dateOfBirthHr]] - [[_data.currentPatient.age]]) <paper-icon-button class="button button--other" dialog-dismiss icon="icons:close"></paper-icon-button></h2>



            <div class="content">

                <div class="docDetailDialog">
                    <div class="doc-menu-list">
                        <div class="doc-submenu-container">
                            <div class="doc-container">
                                <div class="doc-container-list">



                                    <vaadin-grid id="vaadinGrid" class="material" width="100%" items="[[_vaadinGridDataToShow]]" active-item="{{_vaadinGridActiveItem}}">

                                        <vaadin-grid-column width="100px">
                                            <template class="header"><vaadin-grid-sorter path="date">[[localize('date','Date',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.dateHr]]</template>
                                        </vaadin-grid-column>

                                        <vaadin-grid-column width="100px">
                                            <template class="header"><vaadin-grid-sorter path="inComingOutGoingHr">[[localize('inComingOutGoing','Incoming / Outgoing',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.inComingOutGoingHr]]</template>
                                        </vaadin-grid-column>

                                        <vaadin-grid-column>
                                            <template class="header"><vaadin-grid-sorter path="typeHr">[[localize('type','Type',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.typeHr]]</template>
                                        </vaadin-grid-column>

                                        <vaadin-grid-column>
                                            <template class="header"><vaadin-grid-sorter path="originHr">[[localize('origin','Origin',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.originHr]]</template>
                                        </vaadin-grid-column>

                                        <vaadin-grid-column>
                                            <template class="header"><vaadin-grid-sorter path="authorHr">[[localize('aut','Author',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.authorHr]]</template>
                                        </vaadin-grid-column>

                                        <!--
                                        <vaadin-grid-column>
                                            <template class="header"><vaadin-grid-sorter path="recipientHr">[[localize('rec','Recipient',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.recipientHr]]</template>
                                        </vaadin-grid-column>
                                        -->

                                        <vaadin-grid-column>
                                            <template class="header"><vaadin-grid-sorter path="filename">[[localize('filename','Filename',language)]]</vaadin-grid-sorter></template>
                                            <template>[[item.documentName]]</template>
                                        </vaadin-grid-column>

                                    </vaadin-grid>



                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="doc-menu-view">
                        <template is="dom-if" if="[[_hasSelectedDocument]]">

                            <div class="doc-preview">
                                <dynamic-doc
                                        id="document-preview-[[_selectedDocument.documentId]]"
                                        api="[[api]]"
                                        i18n="[[i18n]]"
                                        user="[[user]]"
                                        document-id="[[_selectedDocument.documentId]]"
                                        title="[[_selectedDocument.documentName]]"
                                        resources="[[resources]]"
                                        language="[[language]]"
                                        preview="true"
                                        downloadable="true"
                                        fullwidth="true"
                                        force-no-assignation="true"
                                        force-no-document-header="true"
                                        forwardable="true"
                                        printable="true"
                                        is-pat-detail="true"
                                        show-extended-title="true"
                                        contacts="[[_asArray(_selectedDocument.contact)]]"
                                        on-print-document="_printDocument"
                                ></dynamic-doc>
                            </div>
                        </template>
                    </div>

                </div>

            </div>



            <div class="buttons">
                <paper-button class="button button--other" dialog-dismiss><iron-icon icon="icons:close"></iron-icon> [[localize('clo','Close',language)]]</paper-button>
            </div>



            <template is="dom-if" if="[[_isBusy]]"><div class="overlaySpinnerContainer"><div class="overlaySpinner"><ht-spinner active></ht-spinner></div></div></template>



        </paper-dialog>



    </template>



    <script>



        import _ from 'lodash/lodash';
        import moment from 'moment/src/moment';
        import { Base64 } from 'js-base64';



        class HtPatDocumentsDirectoryDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {

            static get is() {
                return 'ht-pat-documents-directory-dialog';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    user: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    i18n: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    resources: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    language: {
                        type: String,
                        noReset: true,
                        value: "fr"
                    },
                    patient: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    _isBusy: {
                        type: Boolean,
                        value: false,
                        noReset: true
                    },
                    _vaadinGridActiveItem: {
                        type: Object,
                        value: null
                    },
                    _vaadinGridDataToShow: {
                        type: Array,
                        value: () => []
                    },
                    _hasSelectedDocument: {
                        type: Boolean,
                        value: false
                    },
                    _selectedDocument: {
                        type: Object,
                        value: null
                    },
                    _data: {
                        type: Object,
                        value: () => {return{
                            currentHcp: {
                                type: Object,
                                value: () => {}
                            },
                            currentPatient: {
                                type: Object,
                                value: () => {}
                            },
                            codes: {
                                type: Object,
                                value: ()=>{}
                            },
                            messages: {
                                type: Array,
                                value: ()=>[]
                            },
                            contacts: {
                                type: Array,
                                value: ()=>[]
                            },
                            hcps: {
                                type: Array,
                                value: ()=>[]
                            },
                        }}
                    }
                };
            }

            static get observers() {
                return [
                    '_vaadinGridActiveItemChanged(_vaadinGridActiveItem)',
                ];
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            _asArray(input) {
                return [input];
            }

            _resetComponentProperties() {
                const promResolve = Promise.resolve();
                return promResolve
                    .then(() => {
                        const componentProperties = HtPatDocumentsDirectoryDialog.properties
                        Object.keys(componentProperties).forEach(k => { if (!_.get(componentProperties[k],"noReset", false)) { this.set(k, (typeof componentProperties[k].value === 'function' ? componentProperties[k].value() : (componentProperties[k].value || null))) }})
                        return promResolve
                    })
            }

            _msTstampToDDMMYYYY(msTstamp) {
                return parseInt(msTstamp) ? this.api.moment(parseInt(msTstamp)).format('DD/MM/YYYY') : ""
            }

            _msTstampToYYYYMMDD(msTstamp) {
                return parseInt(msTstamp) ? this.api.moment(parseInt(msTstamp)).format('YYYYMMDD') : ""
            }

            _YYYYMMDDToDDMMYYYY(inputValue) {
                return parseInt(inputValue) ? this.api.moment(_.trim(parseInt(inputValue)),"YYYYMMDD").format('DD/MM/YYYY') : ""
            }

            _YYYYMMDDHHmmssToDDMMYYYYHHmmss(inputValue) {
                return parseInt(inputValue) ? this.api.moment(_.trim(parseInt(inputValue)),"YYYYMMDDHHmmss").format('DD/MM/YYYY HH:mm:ss') : ""
            }

            _upperFirstAll(inputValue){
                return _.trim(_.map(_.trim(inputValue).toLowerCase().split(" "),i=>_.upperFirst(_.trim(i))).join(" "))
            }

            _dobToAge(inputValue) {
                return inputValue ? this.api.getCurrentAgeFromBirthDate(inputValue,( e , s ) => this.localize(e, s, this.language)) : ''
            }

            _getServiceAuthor(svc) {
                return this.api.getAuthor(svc.author);
            }

            _getServiceShortDescription(svc) {
                return this.api.contact().shortServiceDescription(svc, this.language);
            }

            _getInsuranceData(insuranceId) {

                const promResolve = Promise.resolve()

                return !_.trim(insuranceId) ? promResolve : this.api.insurance().getInsurance(insuranceId)
                    .then(insuranceData => _.merge({}, {
                        code: _.trim(_.get(insuranceData, "code", "")),
                        name: this._upperFirstAll(!!_.trim(_.get(insuranceData, "name." + this.language, "")) ? _.trim(_.get(insuranceData, "name." + this.language, "")) : _.trim(_.find(_.get(insuranceData, "name", {}), _.trim)))
                    }))
                    .catch(()=>promResolve)

            }

            _getPrettifiedPatient(user, patientId, patientObject=null) {

                const promResolve = Promise.resolve()

                return !_.size(patientObject) && (!_.trim(_.get(user, "id")) || !_.trim(patientId)) ? promResolve : (!!_.size(patientObject) ? Promise.resolve(patientObject) : this.api.patient().getPatientWithUser(user, patientId))
                    .then(patient => {
                        const addressData = _.find(_.get(patient,"addresses",[]), {addressType:"home"}) || _.find(_.get(patient,"addresses",[]), {addressType:"work"}) || _.get(patient,"addresses[0]",[])
                        return _.merge({}, patient, _.mapValues({
                            address: [ _.trim(_.get(addressData,"street","")), _.trim(_.get(addressData,"houseNumber","")) + (!!_.trim(_.get(addressData,"postboxNumber","")) ? "/" + _.trim(_.get(addressData,"postboxNumber","")) : "") ].join(", "),
                            postalCode: _.trim(_.get(addressData,"postalCode","")),
                            city: this._upperFirstAll(_.trim(_.get(addressData,"city",""))),
                            country: this._upperFirstAll(_.trim(_.get(addressData,"country",""))),
                            phone: _.trim(_.get(_.find(_.get(addressData,"telecoms",[]), {"telecomType":"phone"}), "telecomNumber", "")),
                            mobile: _.trim(_.get(_.find(_.get(addressData,"telecoms",[]), {"telecomType":"mobile"}), "telecomNumber", "")),
                            email: _.trim(_.get(_.find(_.get(addressData,"telecoms",[]), {"telecomType":"email"}), "telecomNumber", "")),
                            firstName: this._upperFirstAll(_.get(patient,"firstName","")),
                            lastName: this._upperFirstAll(_.get(patient,"lastName","")),
                            ssinHr: this.api.formatSsinNumber(_.trim(_.get(patient, "ssin", ""))),
                            gender: _.trim(_.get(patient, "gender", "male")),
                            genderHr: this._upperFirstAll(this.localize(_.trim(_.get(patient, "gender", "male")) + "GenderLong", "masculin")),
                            civilityHr: ( _.trim(_.get(patient, "gender", "")) === "female" ? this._upperFirstAll(this.localize("abrv_female", "Mrs.", this.language)) : this._upperFirstAll(this.localize("abrv_male", "Mr.", this.language))),
                            dateOfBirthHr: this._YYYYMMDDToDDMMYYYY(_.trim(_.get(patient, "dateOfBirth"))),
                            age: this._dobToAge(_.trim(_.get(patient, "dateOfBirth"))),
                            insuranceData: _
                                .chain(_.get(patient, "insurabilities",{}))
                                .filter((i)=>{
                                    return i &&
                                        !!moment( _.trim(_.get(i, "startDate", "0") ), "YYYYMMDD" ).isBefore(moment()) &&
                                        (!!moment( _.trim(_.get(i, "endDate", "0") ), "YYYYMMDD" ).isAfter(moment()) || !_.trim(_.get(i, "endDate", "") ) ) &&
                                        !!_.trim( _.get( i, "insuranceId", "" ) )
                                })
                                .map(i => {return _.mapValues({
                                    insuranceId: _.trim(_.get(i,"insuranceId","")),
                                    identificationNumber: _.trim(_.get(i,"identificationNumber","")),
                                    tc1: _.trim(_.get(i,"parameters.tc1","")),
                                    tc2: _.trim(_.get(i,"parameters.tc2","")),
                                    tc1tc2: [_.trim(_.get(i,"parameters.tc1","")), _.trim(_.get(i,"parameters.tc2",""))].join(" - "),
                                    preferentialstatus: typeof _.get(i,"parameters.preferentialstatus") === "boolean" ? !!_.get(i,"parameters.preferentialstatus",false) : _.trim(_.get(i,"parameters.preferentialstatus")) === "true"
                                }, i => typeof i === "string" ? !!_.trim(i) ? _.trim(i) : '-' : i)})
                                .head()
                                .value(),
                        }, i => typeof i === "string" ? !!_.trim(i) ? _.trim(i) : '-' : i))
                    })
                    .then(patient => this._getInsuranceData(_.trim(_.get(patient,"insuranceData.insuranceId"))).then(insuranceData => _.merge({},patient,{insuranceData:insuranceData})))
                    .catch(()=>promResolve)

            }

            _getPrettifiedHcps(hcpIds=null) {

                const promResolve = Promise.resolve()

                return this.api.hcparty().getHealthcareParties((Array.isArray(hcpIds) && !!_.size(hcpIds)) ? hcpIds.join(",") : (typeof hcpIds === "string" && !!_.size(hcpIds)) ? hcpIds : _.get(this,"user.healthcarePartyId",""))
                    .then(hcps => _.map(hcps, hcp => {
                        const addressData = _.find(_.get(hcp,"addresses",[]), {addressType:"work"}) || _.find(_.get(hcp,"addresses",[]), {addressType:"home"}) || _.get(hcp,"addresses[0]",[])
                        return _.merge({}, hcp, _.mapValues({
                            address: [ _.trim(_.get(addressData,"street","")), _.trim(_.get(addressData,"houseNumber","")) + (!!_.trim(_.get(addressData,"postboxNumber","")) ? "/" + _.trim(_.get(addressData,"postboxNumber","")) : "") ].join(", "),
                            postalCode: _.trim(_.get(addressData,"postalCode","")),
                            city: this._upperFirstAll(_.trim(_.get(addressData,"city",""))),
                            country: this._upperFirstAll(_.trim(_.get(addressData,"country",""))),
                            phone: _.trim(_.get(_.find(_.get(addressData,"telecoms",[]), {"telecomType":"phone"}), "telecomNumber", "")),
                            mobile: _.trim(_.get(_.find(_.get(addressData,"telecoms",[]), {"telecomType":"mobile"}), "telecomNumber", "")),
                            email: _.trim(_.get(_.find(_.get(addressData,"telecoms",[]), {"telecomType":"email"}), "telecomNumber", "")),
                            firstName: this._upperFirstAll(_.get(hcp,"firstName","")),
                            lastName: this._upperFirstAll(_.get(hcp,"lastName","")),
                            nihiiHr: this.api.formatInamiNumber(_.trim(_.get(hcp,"nihii",""))),
                            ssinHr: this.api.formatSsinNumber(_.trim(_.get(hcp,"ssin",""))),
                        }, i => typeof i === "string" ? !!_.trim(i) ? _.trim(i) : '-' : i))
                    }))
                    .catch(()=>promResolve)

            }

            _getCodesByType(codeType) {

                const promResolve = Promise.resolve()

                return !_.trim(codeType) ?
                    promResolve :
                    // 35 valid CD-TRANSACTION codes exist in Thesaurus on 20191023 - While 48 do in language.json - get hard coded data from language / more rich
                    codeType === "CD-TRANSACTION" ? Promise.resolve(_.fromPairs([[codeType, _.compact(_.map(this.resources[this.language], (v,k) => {
                        return !_.startsWith(_.trim(k).toLowerCase(),'cd-transaction-') ? false : {
                            code:_.trim(k).toLowerCase().replace('cd-transaction-',''),
                            disabled:false,
                            id:"CD-TRANSACTION|" + _.trim(k).toLowerCase().replace('cd-transaction-','') + "|1",
                            labelHr:v,
                            type:"CD-TRANSACTION"
                        }
                    }))]])) :
                    this.api.code().findPaginatedCodes("be", codeType)
                        .then(({rows}) => _
                            .chain(rows)
                            .filter(i=> !_.get(i,"disabled",false))
                            .map(i => _.merge({},i,{
                                labelHr: codeType === "CD-TRANSACTION" ?
                                    _.upperFirst(_.trim(this.localize("cd-transaction-" + _.trim(_.get(i,"code")), _.trim(_.get(i,"code")), this.language)).toLowerCase()) :
                                    _.trim(_.get(i,"label." + this.language,"")) ?
                                        _.upperFirst(_.trim(_.get(i,"label." + this.language,"")).toLowerCase()) :
                                        _.upperFirst(_.trim(_.head(_.flatMap(_.get(i,"label","")))).toLowerCase())
                            }))
                            .orderBy(["labelHr"],["asc"])
                            .value()
                        )
                        .then(codes => _.fromPairs([[codeType,codes]]))
                        .catch(()=>promResolve)

            }

            _getMessagesWithMetaPatientId(patientId) {

                // transportGuid of messages
                //
                // WITH encrypted PAT IDS:
                //     "DOC:SCAN:IN",
                //     "DOC:IMPORT:IN"
                //     "HUB:IN:IMPORTED-DOCUMENT",
                //     "PRESCRIPTION:ITT:ARCHIVE",
                //     "PRESCRIPTION:KINE:ARCHIVE",
                //     "PRESCRIPTION:NURSE:ARCHIVE",
                //     "LINKING-LETTER:PATIENT:ARCHIVE",
                //     "PRESCRIPTION:IMAGING:ARCHIVE",
                //
                // WITHOUT encrypted PAT IDS -> get from contact / services
                //     "INBOX:*"
                //     "OUTGOING-DOCUMENT:PATIENT:ARCHIVE"
                //     "PRESCRIPTION:PHARMACEUTICALS:ARCHIVE",
                //     "DOC:REPORT:ARCHIVE"

                const promResolve = Promise.resolve()

                return Promise.all(_.map([
                        "DOC:SCAN:IN",
                        "DOC:IMPORT:IN",
                        "HUB:IN:IMPORTED-DOCUMENT",
                        "PRESCRIPTION:ITT:ARCHIVE",
                        "PRESCRIPTION:KINE:ARCHIVE",
                        "PRESCRIPTION:NURSE:ARCHIVE",
                        "LINKING-LETTER:PATIENT:ARCHIVE",
                        "PRESCRIPTION:IMAGING:ARCHIVE"
                    ], singleTransportGuid => this.api.message().findMessagesByTransportGuid(_.trim(singleTransportGuid), null, null, null, 10000).then(messages=>messages.rows).catch(()=>Promise.resolve())))
                    .then(promisesResults => _
                        .chain(promisesResults)
                        .flatMap()
                        .uniqBy('id')
                        .orderBy(['created','received'],['desc','desc'])
                        .value()
                    )
                    .then(foundMessages => Promise.all(_.map(foundMessages, msg => {

                        const cryptedInfo = _.trim(_.get(msg,"metas.cryptedInfo",""));
                        const dataToDecrypt = ( ["DOC:IMPORT:IN", "DOC:SCAN:IN"].indexOf( _.trim(_.get(msg,"transportGuid",""))) > -1 ) && !!cryptedInfo ? new Uint8Array(this.api.crypto().utils.base64toArrayBuffer(cryptedInfo)) :
                            ( ["HUB:IN:IMPORTED-DOCUMENT"].indexOf( _.trim(_.get(msg,"transportGuid",""))) > -1 ) && !!cryptedInfo ? this.api.crypto().utils.text2ua(Base64.decode(cryptedInfo)) :
                            ( _.trim(_.get(msg,"transportGuid","")).indexOf("INBOX") > -1 ) && !!_.trim(_.get(msg,"metas.annexesInfos","")) ? this.api.crypto().utils.text2ua(Base64.decode(_.trim(_.get(msg,"metas.annexesInfos","")))) :
                            false;

                        return !dataToDecrypt ? msg : this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("decrypt", this.user, msg, dataToDecrypt)
                            .then(uaDecryptedContent => JSON.parse(this.api.crypto().utils.ua2text(uaDecryptedContent)))
                            .then(decryptedContent => _.merge(msg,{metas:{decryptedInfo: !!Array.isArray(decryptedContent) ? _.head(decryptedContent) : decryptedContent}}))
                            .catch(e=>{ console.log("ERROR with decrypt", e, msg); return msg;})
                    })))
                    .then(messagesWithDecryptedInfos => _.filter(messagesWithDecryptedInfos, msg => _.trim(_.get(msg,"metas.decryptedInfo.patientId","")) === patientId || _.trim(_.get(msg,"metas.patientId","")) === patientId ))
                    .catch(e=>{ console.log("ERROR _getMessages", e); return promResolve; })

            }

            _getContactsWithFile(patientObject) {

                const promResolve = Promise.resolve();

                return this.api.contact().findBy( _.trim(_.get(this,"user.healthcarePartyId","")), patientObject )
                    .then(patientContacts => _.compact(_.flatten(_.map(patientContacts, singleContact => _.map(singleContact.services, singleService => !_.trim(_.get(singleService,"content." + this.language + ".documentId")) ? false : {
                        contact: singleContact,
                        service: singleService,
                        serviceTitle: _.trim(_.get(singleService,"content." + this.language + ".stringValue")),
                        formId: _.trim(_.get(singleService,"formId")),
                        date: parseInt(_.get(singleService,"valueDate")),
                        dateAndTimeHr: moment(parseInt(_.trim(_.get(singleService,"valueDate")).substring(0,8)),"YYYYMMDD").format('DD/MM/YYYY') + " - " + _.trim(_.get(singleService,"valueDate")).substring(8,10) + ":" + _.trim(_.get(singleService,"valueDate")).substring(10,12),
                        documentId: _.trim(_.get(singleService,"content." + this.language + ".documentId")),
                        cdTransactionCode: _.get(_.find(_.get(singleService,"tags",[]), {type:"CD-TRANSACTION"}),"code",""),
                    })))))
                    .then(foundServicesWithDocumentId => !_.size(foundServicesWithDocumentId) ? false : this.api.document().getDocuments({ids:_.map(foundServicesWithDocumentId,s=>s.documentId)}).then(foundDocuments=>[foundServicesWithDocumentId,foundDocuments]))
                    .then(([foundServicesWithDocumentId,foundDocuments]) => _.compact(_.map(foundServicesWithDocumentId, fswd => {
                        const serviceDocument = _.find(foundDocuments, {id: _.trim(_.get(fswd, "documentId"))})
                        return (
                            !_.trim(_.get(serviceDocument,"id","")) ||
                            !_.trim(_.get(serviceDocument,"attachmentId","")) ||
                            !_.trim(_.get(serviceDocument,"secretForeignKeys",""))
                        ) ? false : _.merge({}, fswd, {document: serviceDocument})
                    })))
                    .then(servicesAndDocuments => Promise.all(servicesAndDocuments.map(sad => this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(_.get(this, "user.healthcarePartyId", null), _.trim(_.get(sad.document, "id", "")), _.size(_.get(sad.document, "encryptionKeys", [])) ? _.get(sad.document, "encryptionKeys", []) : _.get(sad.document, "delegations", []))
                            .then(({extractedKeys: enckeys}) => !!_.trim(_.get(sad.document,"id","")) && _.trim(_.get(sad.document,"attachmentId","")) ? this.api.document().getAttachment(_.trim(_.get(sad.document,"id","")), _.trim(_.get(sad.document,"attachmentId","")), enckeys.join(',')).then(decryptedContent=>(_.merge(sad, {document:{decryptedContent:decryptedContent}}))).catch(e=>{console.log("ERROR with getAttachment: ",e); }) : sad)
                        )).then(servicesAndDocuments => servicesAndDocuments)
                    )
                    .then(servicesAndDocuments => _
                        .chain(servicesAndDocuments)
                        .filter(i => !!_.trim(_.get(i,"document.id")) && !!parseInt(_.get(i,"document.decryptedContent.byteLength")) )
                        .orderBy(['date'], ['desc'])
                        .value()
                    )
                    .catch(e=>{ console.log("ERROR _getContactsWithFile", e); return promResolve; })

            }

            _vaadinGridActiveItemChanged(_vaadinGridActiveItem) {

                return (!_.size(_vaadinGridActiveItem) || _.trim(_.get(_vaadinGridActiveItem,"documentId","something")) === _.trim(_.get(this,"_selectedDocument.documentId","else")) ) ? null : (this.set('_hasSelectedDocument', true)||true) && (this.set('_selectedDocument', _vaadinGridActiveItem)||true)

            }

            _printDocument(e) {
                if(!!_.get(this,"_isBusy",false)) return;
                this.set("_isBusy", true);
            }

            _donePrintingDocument(e) {
                this.set("_isBusy", false);
            }

            _getPrettifiedDataForGrid() {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => _.map(_.get(this,"_data.contacts",[]), ctc => {

                        const transactionCodeLabelHr = _.trim(_.get(_.find(_.get(this,"_data.codes['CD-TRANSACTION']",[]), {code:_.trim(_.get(ctc,"cdTransactionCode",""))}), "labelHr",""));

                        const inComingOrOutGoing = _.trim(_.get(ctc,"cdTransactionCode","")).toLowerCase() === "diarynote" && _.trim(_.get(ctc, "serviceTitle")).toLowerCase().indexOf("documentdownloadfromhub") > -1 ? 'inComing' :
                            _.trim(_.get(ctc,"cdTransactionCode","")).toLowerCase() === "diarynote" && _.trim(_.get(ctc, "serviceTitle")).toLowerCase().indexOf("documentUploadToHub") > -1 ? 'outGoing' :
                            _.trim(_.get(ctc, "service.label")).toLowerCase().indexOf("imported document") > -1 ? 'inComing' :
                            !!_.size(_.find(_.get(ctc,"service.tags",[]), {type:"originalEhBoxMessageId"})) ? 'inComing' :
                            !!_.size(_.find(_.get(ctc,"service.tags",[]), {type:"outgoingDocument"})) ? 'outGoing' :
                            'outGoing'

                        const documentOrigin = _.trim(_.get(ctc,"cdTransactionCode","")).toLowerCase() === "diarynote" && _.trim(_.get(ctc, "serviceTitle")).toLowerCase().indexOf("documentdownloadfromhub") > -1 ? 'hub' :
                            _.trim(_.get(ctc,"cdTransactionCode","")).toLowerCase() === "diarynote" && _.trim(_.get(ctc, "serviceTitle")).toLowerCase().indexOf("documentUploadToHub") > -1 ? 'hub' :
                            _.trim(_.get(ctc, "service.label")).toLowerCase().indexOf("imported document") > -1 ? 'importedDoc' :

                            // Todo: evaluer le fait que le doc ait été scanné via msg
                            _.trim(_.get(ctc, "service.label")).toLowerCase().indexOf("imported document") > -1 ? 'scannedDoc' :

                            !!_.size(_.find(_.get(ctc,"service.tags",[]), {type:"originalEhBoxMessageId"})) ? 'eHealthbox' :
                            !!_.size(_.find(_.get(ctc,"service.tags",[]), {type:"outgoingDocument"})) ? 'patientFile' :
                            'patientFile'

                        return _.merge({},{
                            contact: _.get(ctc,"contact",""),
                            documentId: _.trim(_.get(ctc,"document.id","")),
                            documentName: !!_.trim(_.get(ctc,"document.name","")) ? _.trim(_.get(ctc,"document.name","")) : _.trim(_.get(ctc,"document.id","")),
                            date: parseInt(_.get(ctc,"document.created",""))||+new Date(),
                            dateHr: this._msTstampToDDMMYYYY(parseInt(_.get(ctc,"document.created",""))||+new Date()),
                            typeHr: !!_.trim(transactionCodeLabelHr) ? _.trim(transactionCodeLabelHr) : _.trim(_.get(ctc, "serviceTitle")),
                            authorHr: _.get(_.find(_.get(this,"_data.hcps",[]), {id:_.trim(_.get(ctc,"contact.responsible",""))}),"lastName","") + " " + _.get(_.find(_.get(this,"_data.hcps",[]), {id:_.trim(_.get(ctc,"contact.responsible",""))}),"firstName",""),
                            // recipientHr: "Dr. Maxime Mennechet", /* Only available in eHealthbox while sent item is not deleted yet */
                            inComingOutGoingHr: this.localize(inComingOrOutGoing, inComingOrOutGoing, this.language),
                            originHr: this.localize("documentsDirectoryOrigin_" + documentOrigin, documentOrigin, this.language),
                        })
                    }))
                    .catch(e=>{ console.log("ERROR _getPrettifiedDataForGrid", e); return promResolve; })

            }

            open(){

                if(!!_.get(this,"_isBusy",false)) return;

                return this._resetComponentProperties()
                    .then(() => _.map(this._data, (propValue,propKey) => typeof _.get(propValue,"value",null) !== "function" ? null : this.set("_data." + propKey, propValue.value())) )
                    .then(() => { this.set("_isBusy", true); this.shadowRoot.querySelector('#document-directory-dialog').open(); })
                    .then(() => this._getPrettifiedHcps().then(hcps => this.set("_data.currentHcp",_.head(hcps))))
                    .then(() => this._getPrettifiedPatient(_.get(this,"user",{}), _.trim(_.get(this,"patient.id",""))).then(pat => this.set("_data.currentPatient", pat)))
                    .then(() => this._getCodesByType("CD-TRANSACTION").then(codes => _.merge(this._data,{codes:codes})))
                    .then(() => this._getMessagesWithMetaPatientId(_.trim(_.get(this,"_data.currentPatient.id",""))).then(messages => this.set("_data.messages", messages)))
                    .then(() => this._getContactsWithFile(_.get(this,"_data.currentPatient",{})).then(contacts => this.set("_data.contacts", contacts)))
                    .then(() => this._getPrettifiedHcps(_.uniq(_.compact(_.map(_.get(this,"_data.contacts",[]), ctc => _.trim(_.get(ctc,"contact.responsible","")))))).then(hcps=>this.set("_data.hcps", hcps)))
                    .then(() => this._getPrettifiedDataForGrid().then(prettifiedDataForGrid => this.set("_vaadinGridDataToShow", prettifiedDataForGrid)))
                    .finally(() => (this.set("_isBusy", false)||true) && (console.log("--- this._data ---",this._data)||true) && (console.log("--- this._vaadinGridDataToShow ---",this._vaadinGridDataToShow)||true))
                    .catch(e=>console.log("ERROR", e));

            }



        }

        customElements.define(HtPatDocumentsDirectoryDialog.is, HtPatDocumentsDirectoryDialog);



    </script>



</dom-module>