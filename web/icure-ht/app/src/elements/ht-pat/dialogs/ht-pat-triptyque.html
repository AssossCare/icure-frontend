<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../ht-spinner/ht-spinner.html">

<link rel="import" href="../../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">

<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../../../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../../dynamic-form/dynamically-loaded-form.html">
<link rel="import" href="../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../dynamic-form/dynamic-number-field.html">
<link rel="import" href="../../dynamic-form/dynamic-text-field.html">
<link rel="import" href="../../dynamic-form/dynamic-date-field.html">
<link rel="import" href="../../dynamic-form/dynamic-checkbox.html">

<link rel="import" href="../../pdf-element/pdf-element.html">

<link rel="import" href="../../../shared-styles.html">
<link rel="import" href="../../../dialog-style.html">
<link rel="import" href="../../../notification-style.html">
<link rel="import" href="../../../spinner-style.html">
<link rel="import" href="../../../scrollbar-style.html">





<dom-module id="ht-pat-triptyque-dialog">





    <template>





        <style include="shared-styles dialog-style notification-style spinner-style scrollbar-style">

        </style>





        <paper-dialog id="triptyqueDialog" always-on-top="true" no-cancel-on-outside-click="true" no-cancel-on-esc-key="true">



            <template is="dom-if" if="[[_isLoading]]">
                <div id="loadingContainer">
                    <div id="loadingContentContainer">
                        <div class="mw100 m0auto"><ht-spinner class="spinner" alt="Loading..." active></ht-spinner></div>
                        <div id="loadingContent"></div>
                    </div>
                </div>
            </template>



            <template is="dom-if" if="[[_dialogParameters.actions.listing]]">



                <div class="panelNavigator m0 p0" id="panelNavigator_1">

                    <h3 class="p0 mt0">[[localize('onGoingPlansOfActions','Ongoing plans of actions',language)]] <span class="fspoint8em fw400">([[_formatTranslateGender(patient.gender)]] [[_ucFirst(patient.lastName)]] [[_ucFirst(patient.firstName)]] - [[_formatDateOfBirth(patient.dateOfBirth)]] - [[_dobToAge(patient.dateOfBirth)]] - [[patient.profession]])</span></h3>

                    <vaadin-grid id="vaadinGridPlanOfAction" class="m0 p0 vaadinGridPlanOfAction" items="[[_vaadinGridPlanOfActionDataToShow]]" active-item="{{_vaadinGridPlanOfActionActiveItem}}" pageSize="[[_vaadinGridPlanOfActionMaxItemsPerPage]]" on-selected-items-changed="_vaadinGridPlanOfActionActiveItemChanged">

                        <vaadin-grid-column width="100px" flex-grow="0">
                            <template class="header"><vaadin-grid-sorter path="openingDate"><b>[[localize('dat','Date',language)]]</b></vaadin-grid-sorter></template>
                            <template>[[item.openingDate]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header"><vaadin-grid-sorter path="heDescr">[[localize('healthcareelement','Healthcare Elements',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.heDescr]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header"><vaadin-grid-sorter path="name">[[localize('lab','Label',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.label]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header"><vaadin-grid-sorter path="prescriber">[[localize('prescriber','Prescriber',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.prescriber]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex-grow="1">
                            <template class="header"><vaadin-grid-sorter path="responsibleHr">[[localize('persphysicianRole','Physician',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.responsibleHr]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="100px" flex-grow="0">
                            <template class="header"><vaadin-grid-sorter path="contactsCount">[[localize('qua','Quantity',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.contactsCount]]/[[item.numberOfCares]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="150px" flex-grow="0">
                            <template class="header"><vaadin-grid-sorter path="statusHr">[[localize('sta','Status',language)]]</vaadin-grid-sorter></template>
                            <template>[[item.statusHr]]</template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="50px" flex-grow="0">
                            <template class="header"></template>
                            <template><paper-button class="tool-btn pl15 pr15" on-tap="_browseAppointments" data-plan-of-action-id="[[item.id]]"><iron-icon data-name="diary" icon="date-range" class="ml5"></iron-icon> [[localize('diary','Diary',language)]]</paper-button></template>
                        </vaadin-grid-column>

                    </vaadin-grid>

                    <div class="vaadinGridBottomActions mt20">
                        <div class="grid-size-indicator hideOnMobile"> [[_vaadinGridPageStart]] â€“ [[_vaadinGridPageEnd]] [[localize('sur','sur',language)]] [[_vaadinGridTotalRecords]]</div>
                        <paper-icon-button id="previous-page-change" icon="chevron-left" class="vaadinGridPageToPageNavigation" on-tap="_gotoPreviousGridPage"></paper-icon-button>
                        <paper-icon-button id="next-page-change" icon="chevron-right" class="vaadinGridPageToPageNavigation" on-tap="_gotoNextGridPage"></paper-icon-button>
                        <div class="hideOnMobile"><paper-icon-button class="vaadinGridScrollToTop" icon="arrow-upward" on-tap="_scrollToTop"></paper-icon-button></div>
                    </div>

                    <div class="buttons">
                        <paper-button on-tap="_closeTriptyqueDialog" class="modal-button modal-button--cancel"><iron-icon icon="icons:close" class=""></iron-icon>[[localize('clo','Close',language)]]</paper-button>
                        <paper-button on-tap="_addPlanOfAction" class="modal-button modal-button--save"><iron-icon icon="icons:add-circle" class="mr0"></iron-icon>[[localize('createPlanOfAction','Create plan of action',language)]]</paper-button>
                    </div>

                </div>



            </template>



            <template is="dom-if" if="[[_dialogParameters.actions.detail]]">

                <h3 class="p0 mt0">[[localize('detailsPlanOfActions','Details plan of actions',language)]] <span class="fspoint8em fw400">([[_formatTranslateGender(patient.gender)]] [[_ucFirst(patient.lastName)]] [[_ucFirst(patient.firstName)]] - [[_formatDateOfBirth(patient.dateOfBirth)]] - [[_dobToAge(patient.dateOfBirth)]] - [[patient.profession]])</span></h3>

                <div class="panelNavigator m0 p0 hasTabViews" id="panelNavigator_2">
                    <div class="panelNavigatorAnchor"><paper-button on-tap="_closePlanOfAction"><iron-icon icon="hardware:keyboard-arrow-left"></iron-icon> [[localize('onGoingPlansOfActions','Ongoing plans of actions',language)]]</paper-button></div>
                    <div class="panelNavigatorContent p0 mt0">



                        <div id="pdfPanel" class="">
                            <div class="documentsList">



                                <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                    <h4 class="textaligncenter uppercase"><iron-icon icon="icons:assignment" class="mr8 darkBlue"></iron-icon> [[localize('linkedPrescriptionToYourTriptyque','This prescription is linked to your triptyque',language)]]:</h4>
                                    <div class="singleDocumentContainer" data-service-id$="[[_selectedPrescriptionObject.service.id]]" data-form-id$="[[_selectedPrescriptionObject.formId]]" data-document-id$="[[_selectedPrescriptionObject.document.id]]">
                                        <div class="header p10">
                                            <span class="date">[[_selectedPrescriptionObject.dateAndTimeHr]]</span>
                                            <paper-button class="p0 m0 fr" on-tap="_unlinkPdfPrescription" data-contact-id$="[[_selectedPrescriptionObject.contact.id]]" data-service-id$="[[_selectedPrescriptionObject.service.id]]" data-form-id$="[[_selectedPrescriptionObject.formId]]" data-document-id$="[[_selectedPrescriptionObject.document.id]]"><iron-icon icon="vaadin:unlink" id$="unlink-[[_selectedPrescriptionObject.service.id]]"></iron-icon></paper-button><paper-tooltip for$="unlink-[[_selectedPrescriptionObject.service.id]]">[[localize('unlinkPdf','Unlink PDF',language)]]</paper-tooltip>
                                        </div>
                                        <div class="body p5 fspoint9em"><iron-icon icon="image:picture-as-pdf" class="mr5 darkRed"></iron-icon> [[_selectedPrescriptionObject.serviceTitle]]</div>
                                        <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                            <dynamic-doc
                                                id="selected-pdf-preview-[[_selectedPrescriptionObject.document.id]]"
                                                api="[[api]]"
                                                i18n="[[i18n]]"
                                                user="[[user]]"
                                                document-id="[[_selectedPrescriptionObject.document.id]]"
                                                language="[[language]]"
                                                preview="true"
                                                downloadable="true"
                                                fullwidth="true"
                                                force-no-assignation="true"
                                                force-no-document-header="true"
                                                additional-css-class="tripTyque"
                                            ></dynamic-doc>
                                        </template>
                                    </div>
                                </template>



                                <template is="dom-if" if="[[!_selectedPrescriptionBoolean]]">
                                    <h4 class="textaligncenter uppercase"><iron-icon icon="icons:assignment" class="mr8 darkBlue"></iron-icon> [[localize('choosePrescriptionForTriptyque','Please choose a prescription to link to your triptyque',language)]]:</h4>
                                    <template is="dom-repeat" items="[[_pdfPrescriptionsList]]" as="singlePdfPrescription">

                                        <div class="singleDocumentContainer" data-service-id$="[[singlePdfPrescription.service.id]]" data-form-id$="[[singlePdfPrescription.formId]]" data-document-id$="[[singlePdfPrescription.document.id]]">
                                            <div class="header p10">
                                                <span class="date">[[singlePdfPrescription.dateAndTimeHr]]</span>
                                                <paper-button class="p0 m0 fr" on-tap="_linkPdfPrescription" data-contact-id$="[[singlePdfPrescription.contact.id]]" data-service-id$="[[singlePdfPrescription.service.id]]" data-form-id$="[[singlePdfPrescription.formId]]" data-document-id$="[[singlePdfPrescription.document.id]]"><iron-icon icon="icons:link" id$="link-[[singlePdfPrescription.service.id]]"></iron-icon></paper-button><paper-tooltip for$="link-[[singlePdfPrescription.service.id]]">[[localize('linkPdf','Link PDF',language)]]</paper-tooltip>
                                                <paper-button class="p0 m0 fr mr10" on-tap="_toggleCollapsePdfPreview" data-contact-id$="[[singlePdfPrescription.contact.id]]" data-service-id$="[[singlePdfPrescription.service.id]]" data-form-id$="[[singlePdfPrescription.formId]]" data-document-id$="[[singlePdfPrescription.document.id]]"><iron-icon icon="icons:visibility" id$="view-[[singlePdfPrescription.service.id]]"></iron-icon></paper-button><paper-tooltip for$="view-[[singlePdfPrescription.service.id]]">[[localize('ehb.view','View',language)]]</paper-tooltip>
                                            </div>
                                            <div class="body p5 fspoint9em"><iron-icon icon="image:picture-as-pdf" class="mr5 darkRed"></iron-icon> [[singlePdfPrescription.serviceTitle]]</div>

                                            <template is="dom-if" if="[[_isEqual(_currentPdfPreviewDocumentId, singlePdfPrescription.document.id)]]">
                                                <dynamic-doc
                                                    id="pdf-preview-[[singlePdfPrescription.document.id]]"
                                                    api="[[api]]"
                                                    i18n="[[i18n]]"
                                                    user="[[user]]"
                                                    document-id="[[singlePdfPrescription.document.id]]"
                                                    title="[[singlePdfPrescription.serviceTitle]]"
                                                    language="[[language]]"
                                                    preview="true"
                                                    downloadable="true"
                                                    fullwidth="true"
                                                    force-no-assignation="true"
                                                    force-no-document-header="true"
                                                    additional-css-class="tripTyque"
                                                ></dynamic-doc>
                                            </template>

                                        </div>

                                    </template>
                                </template>



                            </div>
                        </div>
                        <div class="panelNavigatorAnchor bl0"><paper-button on-tap="_toggleCollapsePdfPanel"><iron-icon icon="hardware:keyboard-arrow-left"></iron-icon> [[localize('prescription','Prescription',language)]] PDF</paper-button></div>



                        <paper-tabs selected="{{_triptyqueDetailActiveTab}}" on-tap="_gotoTabIfsAllowed" attr-for-selected="name" class="p0">
                            <paper-tab class="dialogTab" name="prescriptionForm"><iron-icon icon="icons:assignment" class="mr8 darkBlue"></iron-icon>[[localize('prescription','Prescription',language)]]</paper-tab>
                            <paper-tab class="dialogTab" name="summary"><iron-icon icon="icons:list" class="mr8 darkBlue"></iron-icon> [[localize('summary','Summary',language)]]</paper-tab>
                            <paper-tab class="dialogTab" name="procedures"><iron-icon icon="vaadin:tools" class="mr8 darkBlue"></iron-icon> [[localize('proc(s)','Procedure(s)',language)]] <span class="batchNumber greenBg ml10">[[_totalExistingProceduresForCurrentPlanOfAction]]</span></paper-tab>
                        </paper-tabs>



                        <div class="dialogTabContent p10">



                            <template is="dom-if" if="[[_isEqual(_triptyqueDetailActiveTab,'prescriptionForm')]]">

                                <template is="dom-if" if="[[!_selectedPrescriptionBoolean]]"><iron-icon icon="warning" class="mr8 darkRed"></iron-icon> [[localize('pleaseLinkPrescriptionToTriptyqueFirst','Please link a prescription to your triptyque first',language)]].</template>

                                <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                    <dynamically-loaded-form
                                        id="dynamicallyLoadedFormTripTyque"
                                        api="[[api]]"
                                        user="[[user]]"
                                        i18n="[[i18n]]"
                                        language="[[language]]"
                                        resources="[[resources]]"
                                        patient="[[patient]]"
                                        form-id="[[_selectedPrescriptionObject.formId]]"
                                        contact="[[_selectedPrescriptionObject.contact]]"
                                        contacts="[[_selectedPrescriptionObject.contacts]]"
                                        current-contact="[[_selectedPrescriptionObject.contact]]"
                                        force-no-print="true"
                                        force-no-title="true"
                                        additional-css-class="tripTyque"
                                        services-map="[[_selectedPrescriptionObject.servicesMap]]"
                                        on-data-change="_prescriptionFormDataGotChanged"
                                     ></dynamically-loaded-form>

                                    </template>

                            </template>



                            <template is="dom-if" if="[[_isEqual(_triptyqueDetailActiveTab,'summary')]]">

                                <template is="dom-if" if="[[!_selectedPrescriptionBoolean]]"><iron-icon icon="warning" class="mr8 darkRed"></iron-icon> [[localize('pleaseLinkPrescriptionToTriptyqueFirst','Please link a prescription to your triptyque first',language)]].</template>

                                <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">

                                    <div class="summaryFormContainer w100pc">
                                        <div class="fl50">
                                            <div class="formItem"><vaadin-combo-box class="triptyqueVaadinComboBox" filtered-items="[[activeHealthElements]]" item-label-path="descrHr" item-value-path="id" value="{{_summaryForm.relatedHealthElementId}}" label="[[localize('linkedHealthElement','Related health element',language)]]"></vaadin-combo-box></div>
                                            <div class="formItem"><vaadin-combo-box id="relatedParentPathology" class="triptyqueVaadinComboBox" filtered-items="[[_relatedParentPathologies]]" item-label-path="labelHr" item-value-path="id" value="{{_summaryForm.relatedParentPathology}}" label="Type de pathologie"></vaadin-combo-box></div>
                                            <div class="formItem"><vaadin-combo-box id="relatedChildrenPathology" class="triptyqueVaadinComboBox displaynone" filtered-items="[[_relatedChildrenPathologiesForSelectedParent]]" item-label-path="labelHr" item-value-path="id" value="{{_summaryForm.relatedChildrenPathology}}" label="Affection"></vaadin-combo-box></div>
                                            <div class="formItem mt8">
                                                <vaadin-checkbox checked="{{_summaryForm.lateralityLeft}}"> Gauche</vaadin-checkbox>
                                                <vaadin-checkbox checked="{{_summaryForm.lateralityRight}}"> Droite</vaadin-checkbox>
                                                <vaadin-checkbox checked="{{_summaryForm.lateralityCenter}}"> Tronc central</vaadin-checkbox>
                                            </div>
                                            <div class="fl50">
                                                <div class="formItem mt15"><dynamic-date-field class="dynamicDateField" label="Date de dÃ©but de la prescription" value="{{_summaryForm.startDate}}" i18n="[[i18n]]"></dynamic-date-field></div>
                                                <div class="formItem mt10"><dynamic-date-field class="dynamicDateField" label="Date de la premiÃ¨re scÃ©ance" value="{{_summaryForm.valueDate}}" i18n="[[i18n]]"></dynamic-date-field></div>
                                            </div>
                                            <div class="fr50">
                                                <div class="formItem mt15"><dynamic-date-field class="dynamicDateField" label="Date de fin de la prescription" value="{{_summaryForm.endDate}}" i18n="[[i18n]]"></dynamic-date-field></div>
                                                <div class="formItem mt10"><dynamic-date-field class="dynamicDateField" label="Date de rappel de la demande" value="{{_summaryForm.careRehearseDate}}" i18n="[[i18n]]"></dynamic-date-field></div>
                                            </div>
                                        </div>
                                        <div class="fr50">
                                            <div class="formItem mt2"><dynamic-text-field class="m0" value="{{_summaryForm.planOfActionsName}}" label="Nom du plan d'action"></dynamic-text-field></div>
                                            <div class="formItem mt6"><dynamic-text-field class="m0" value="{{_summaryForm.numberOfCares}}" label="Nombre de sÃ©ances" type="number"></dynamic-text-field></div>
                                            <div class="formItem mt4"><vaadin-combo-box class="triptyqueVaadinComboBox" filtered-items="[[_careTeamValues]]" item-label-path="labelHr" item-value-path="id" value="{{_summaryForm.careTeam}}" label="Prestataire liÃ©"></vaadin-combo-box></div>
                                            <div class="formItem mt4"><vaadin-combo-box class="triptyqueVaadinComboBox" filtered-items="[[_careReasons]]" item-label-path="labelHr" item-value-path="id" value="{{_summaryForm.careReason}}" label="Justificatif de soins"></vaadin-combo-box></div>
                                        </div>
                                        <div class="clear"></div>
                                        <div class="formItem mt20">
                                            <div class="fw700 mb10">Documents de la mutuelle:</div>

                                            <div class="documentsList p10 pb0 borderDashed borderW1px borderColorAppPrimaryLight mb20">
                                                <div class="mb10">Documents liÃ©s au triptyque:</div>
                                                <template is="dom-repeat" items="[[_insuranceLinkedDocuments]]" as="item" id="triptyqueLinkedInsuranceDocumentsDomRepeat">
                                                    <paper-item class="linkedObjectTag" data-document-id="[[item.documentId]]">
                                                        <div class="tagtype" data-document-id="[[item.documentId]]">[[item.created]]</div>
                                                        <div class="one-line-menu list-title" data-document-id="[[item.documentId]]">[[item.documentName]]</div>
                                                        <paper-icon-button class="deleteTag" icon="icons:delete" data-document-id="[[item.documentId]]" on-tap="_removeLinkedInsuranceDocument"></paper-icon-button>
                                                    </paper-item>
                                                </template>
                                                <div class="clear"></div>
                                            </div>

                                            <div class="documentsList p10 pb0 borderDashed borderW1px borderColorAppPrimaryLight">
                                                <div class="mb10">Documents disponibles:</div>
                                                <template is="dom-repeat" items="[[_insuranceDocuments]]" as="item" id="triptyqueAvailableInsuranceDocumentsDomRepeat">
                                                    <div class="singleDocumentContainer" data-message-id$="[[item.messageId]]" data-document-id$="[[item.documentId]]" data-attachment-id$="[[item.attachmentId]]">
                                                        <div class="header p10">
                                                            <span class="date">[[item.created]]</span>
                                                            <paper-button class="p0 m0 fr" on-tap="_linkInsuranceDocument" data-message-id$="[[item.messageId]]" data-document-id$="[[item.documentId]]" data-attachment-id$="[[item.attachmentId]]"><iron-icon icon="icons:link" id$="link-insurance-[[item.documentId]]"></iron-icon></paper-button><paper-tooltip for$="link-insurance-[[item.documentId]]">[[localize('linkPdf','Link PDF',language)]]</paper-tooltip>
                                                            <paper-button class="p0 m0 fr mr10" on-tap="_toggleCollapseInsuranceDocumentPreview" data-message-id$="[[item.messageId]]" data-document-id$="[[item.documentId]]" data-attachment-id$="[[item.attachmentId]]"><iron-icon icon="icons:visibility" id$="view-insurance-[[item.documentId]]"></iron-icon></paper-button><paper-tooltip for$="view-insurance-[[item.documentId]]">[[localize('ehb.view','View',language)]]</paper-tooltip>
                                                        </div>
                                                        <div class="body p5 fspoint9em"><iron-icon icon="image:picture-as-pdf" class="mr5 darkRed"></iron-icon> [[item.documentName]]</div>

                                                        <template is="dom-if" if="[[_isEqual(_currentPreviewInsuranceDocumentId, item.documentId)]]">
                                                            <dynamic-doc
                                                                    id="insurance-document-preview-[[item.documentId]]"
                                                                    api="[[api]]"
                                                                    i18n="[[i18n]]"
                                                                    user="[[user]]"
                                                                    document-id="[[item.documentId]]"
                                                                    title="[[item.documentName]]"
                                                                    language="[[language]]"
                                                                    preview="true"
                                                                    downloadable="true"
                                                                    fullwidth="true"
                                                                    force-no-assignation="true"
                                                                    force-no-document-header="true"
                                                                    additional-css-class="tripTyque"
                                                            ></dynamic-doc>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>

                                        </div>
                                    </div>

                                    <!--
                                    <div class="w100pc">
                                        Documents mutuelle ==> faire dialog Ã  part dans lequel on liste this._insuranceDocuments + se passer ids de ceux dÃ©jÃ  liÃ©s + faire render style prescription liste avec dyn doc pour prÃ©view & action "lier" / supprimer + faire lien vers tab view (dossier pat) pour importer new<br />
                                        Valider tab summary lors du change tab (_gotoTabIfsAllowed)<br />
                                        Repasser sur les localize en dur dans form summary<br />
                                    </div>
                                    -->

                                </template>

                            </template>



                            <template is="dom-if" if="[[_isEqual(_triptyqueDetailActiveTab,'procedures')]]">

                                <template is="dom-if" if="[[!_selectedPrescriptionBoolean]]"><iron-icon icon="warning" class="mr8 darkRed"></iron-icon> [[localize('pleaseLinkPrescriptionToTriptyqueFirst','Please link a prescription to your triptyque first',language)]].</template>

                                <template is="dom-if" if="[[_selectedPrescriptionBoolean]]">
                                    ProcÃ©dures
                                </template>

                            </template>



                        </div>



                        <div class="buttons">
                            <paper-button on-tap="_closeTriptyqueDialog" class="modal-button modal-button--cancel"><iron-icon icon="icons:close" class=""></iron-icon>[[localize('clo','Close',language)]]</paper-button>
                            <paper-button disabled$=[[!_selectedPrescriptionBoolean]] on-tap="_XXXXXX" class$="[[_stringByValue('disabled', 'false', _selectedPrescriptionBoolean)]] modal-button modal-button--save"><iron-icon icon="icons:save" class=""></iron-icon>[[localize('save','Save',language)]]</paper-button>
                            <paper-button disabled$=[[!_selectedPrescriptionBoolean]] on-tap="_XXXXXX" class$="[[_stringByValue('disabled', 'false', _selectedPrescriptionBoolean)]] modal-button modal-button--cancel minw0"><iron-icon icon="icons:more-vert" class="mr0"></iron-icon></paper-button>
                        </div>

                    </div>

                </div>


            </template>



        </paper-dialog>





    </template>





    <script>

        import _ from 'lodash/lodash';
        import moment from 'moment/src/moment';
        import { Base64 } from 'js-base64';

        class HtPatTriptyqueDialog extends Polymer.TkLocalizerMixin(Polymer.Element) {

            static get is() {
                return 'ht-pat-triptyque-dialog';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    user: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    i18n: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    resources: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    language: {
                        type: String,
                        noReset: true,
                        value: "fr"
                    },
                    _isLoading: {
                        type: Boolean,
                        value: true,
                        noReset: true
                    },
                    _loadingMessages: {
                        type: Array,
                        value: () => []
                    },
                    patient: {
                        type: Object,
                        noReset: true,
                        value: () => {}
                    },
                    _isOpened: {
                        type: Boolean,
                        value: false
                    },
                    _dialogData: {
                        type: Object,
                        value: () => {return {
                            currentHcp: {
                                type: Object,
                                value: () => {}
                            },
                            currentPatient: {
                                type: Object,
                                value: () => {}
                            },
                            hesAndPoas: {
                                type: Array,
                                value: () => []
                            },
                            pdfPrescriptionsList: {
                                type: Array,
                                value: () => []
                            },
                            formTemplate: {
                                type: Object,
                                value: () => {}
                            },
                            insuranceDocuments: {
                                type: Array,
                                value: ()=>[],
                            },
                            relatedChildrenPathologies: {
                                type: Array,
                                value: ()=>[],
                            },
                            relatedParentPathologies: {
                                type: Array,
                                value: ()=>[],
                            },
                            codes: {
                                type: Object,
                                value: ()=>{}
                            }
                        }},
                        noReset: true
                    },


                    _vaadinGridPlanOfActionMaxItemsPerPage: {
                        type: Number,
                        value: 2
                    },
                    _vaadinGridPageStart: {
                        type: Number,
                        value: 0
                    },
                    _vaadinGridPageEnd: {
                        type: Number,
                        value: 2
                    },
                    _vaadinGridPlanOfActionDataToShow: {
                        type: Array,
                        value: () => []
                    },
                    _vaadinGridPlanOfActionActiveItem: {
                        type: Object,
                        value: () => {}
                    },
                    _vaadinGridCurrentPageNumber: {
                        type: Number,
                        value: 1
                    },
                    _vaadinGridTotalRecords: {
                        type: Number,
                        value: 0
                    },
                    _vaadinGridTotalPages: {
                        type: Number,
                        value: 1
                    },

                    _triptyqueDetailActiveTab: {
                        type: String,
                        value: "prescriptionForm"
                    },
                    _totalExistingProceduresForCurrentPlanOfAction: {
                        type: Number,
                        value: 0
                    },
                    _currentPdfPreviewDocumentId: {
                        type: String,
                        value: ""
                    },
                    _currentPreviewInsuranceDocumentId: {
                        type: String,
                        value: ""
                    },
                    _selectedPrescriptionObject: {
                        type: Object,
                        value: () => {}
                    },
                    _selectedPrescriptionBoolean: {
                        type: Boolean,
                        value: false
                    },
                    _saveFormReqIdx: {
                        type: Number,
                        value: 0
                    },
                    activeHealthElements: {
                        type: Array,
                        value: ()=>[],
                        noReset: true
                    },
                    _relatedParentPathologies: {
                        type: Array,
                        value: ()=>[],
                        noReset: true
                    },
                    _relatedChildrenPathologies: {
                        type: Array,
                        value: ()=>[],
                        noReset: true
                    },
                    _relatedChildrenPathologiesForSelectedParent: {
                        type: Array,
                        value: ()=>[],
                        noReset: true
                    },



                    _insuranceDocuments: {
                        type: Array,
                        value: ()=>[],
                        noReset: true
                    },
                    _summaryForm: {
                        type: Object,
                        value: {
                            relatedHealthElementId: "",
                            relatedParentPathology: "",
                            relatedChildrenPathology: "",
                            lateralityLeft: false,
                            lateralityRight: false,
                            lateralityCenter: false,
                            startDate: "",
                            endDate: "",
                            valueDate: "",
                            careRehearseDate: "",
                            planOfActionsName: "",
                            numberOfCares: 1,
                            careReason: "",
                            careTeam: "",
                            insuranceDocuments: []
                        }
                    },
                    _careTeamValues: {
                        type: Array,
                        value: ()=>[],
                        noReset: true
                    },
                    _insuranceLinkedDocuments: {
                        type: Array,
                        value: () => []
                    },
                    _dialogParameters: {
                        type: Object,
                        value: () => {
                            return {
                                actions: {
                                    listing: true,
                                    detail: false
                                },
                                triptyqueType: "physiotherapist",
                                configByType: {
                                    physiotherapist: {
                                        pdfDocumentsLabelKey: "requestForKineCare_header1",
                                        formTemplateGuid: "AEFED10A-9A72-4B40-981B-1D79ADB05516",
                                        defaultCodes: [
                                            {id: "BE-THESAURUS-PROCEDURES|A57.062|3.1.0"},
                                            {id: "CD-HCPARTY|persphysiotherapist|1"},
                                            {id: "BE-THESAURUS|40001315|3.1.0"},
                                            {id: "ICPC|*57.03|2"},
                                        ],
                                        insuranceMessagesDocumentsTransportGuid: "INSURANCE:PAT:IMPORT",
                                        prescriptionTypeCode: "care.topaz.kinesitherapyPrescription",
                                        careReasonsCode: "CD-INCAPACITYREASON",
                                        careBeginDateServiceMapKey: "Date intervention",
                                        numberOfCaresServiceMapKey: "Nombre de sÃ©ances"
                                    },
                                    persnurse: {
                                        pdfDocumentsLabelKey: "requestForNurseCare_header1",
                                        formTemplateGuid: "64DAB551-B007-4B5C-BD64-F886301F5326",
                                        defaultCodes: [
                                            {id:"BE-THESAURUS-PROCEDURES|A66.015|3.1.0"},
                                            {id:"BE-THESAURUS|40001452|3.1.0"},
                                            {id:"CD-HCPARTY|persnurse|1"},
                                            {id:"ICPC|*66.01|2"}
                                        ],
                                        insuranceMessagesDocumentsTransportGuid: "INSURANCE:PAT:IMPORT",
                                        prescriptionTypeCode: "care.topaz.nursePrescription",
                                        careReasonsCode: "CD-INCAPACITYREASON",
                                        careBeginDateServiceMapKey: "Date intervention",
                                        numberOfCaresServiceMapKey: "Nombre de sÃ©ances"
                                    }
                                }
                            }
                        }
                    }
                };
            }

            static get observers() {
                return [
                    '_loadingStatusChanged(_isLoading)',
                    '_vaadinGridPlanOfActionActiveItemChanged(_vaadinGridPlanOfActionActiveItem)',
                    '_selectedDocumentChanged(_selectedPrescriptionObject)',
                    '_summaryFormDataGotChanged(_summaryForm.*)',
                    '_vaadinGridPageNumberChanged(_vaadinGridCurrentPageNumber)',
                ]
            }

            constructor() {
                super();
            }

            ready() {
                super.ready();
            }

            _loadingStatusChanged() {
                if(!this._isLoading) this._resetLoadingMessage();
            }

            _resetLoadingMessage() {
                this._loadingMessages = [];
            }

            _setLoadingMessage( messageData ) {
                setTimeout(()=> {
                    if (!!_.get(messageData,"updateLastMessage",false)) this._loadingMessages.pop();
                    this._loadingMessages.push(messageData);
                    const loadingContentTarget = this.shadowRoot.querySelectorAll('#loadingContent')[0];
                    if (loadingContentTarget) { loadingContentTarget.innerHTML = ''; _.each(this._loadingMessages, (v) => { loadingContentTarget.innerHTML += "<p><iron-icon icon='" + v.icon + "' class='" + (v.done ? "loadingIcon done" : "loadingIcon") + "'></iron-icon>" + v.message + "</p>"; }); }
                },100)
            }

            _resetComponentProperties() {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => {
                        const componentProperties = HtPatTriptyqueDialog.properties
                        Object.keys(componentProperties).forEach(k => { if (!_.get(componentProperties[k],"noReset", false)) { this.set(k, (typeof componentProperties[k].value === 'function' ? componentProperties[k].value() : (componentProperties[k].value || null))) }})
                        return promResolve
                    })

            }

            _initOpenDialogActions(dialogParameters={}) {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => {
                        this.set("_isLoading", true)
                        this.set("_isOpened", true)
                        this._setLoadingMessage({ message: this.localize('ongoingProcess', this.language), icon: "arrow-forward" })
                        _.merge(this, dialogParameters) && this.$["triptyqueDialog"].open()
                        return promResolve
                    })

            }

            _closeTriptyqueDialog() {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => this._resetComponentProperties())
                    .then(() => {
                        this.$["triptyqueDialog"].close()
                        this.dispatchEvent(new CustomEvent("triptyque-dialog-closed", {composed: true, bubbles: true, detail: {}}))
                        return promResolve
                    })

            }

            _changeDialogAction(action) {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => _.map(_.keys(_.get(this,"_dialogParameters.actions",[])), k => this.set("_dialogParameters.actions."+k, false)))
                    .then(() => this.set("_dialogParameters.actions."+action, true))
                    .then(() => setTimeout(()=>{
                        _.map(this.shadowRoot.querySelectorAll('.panelNavigator'), i => i && i.classList && i.classList.remove('visible'))
                        return action === "detail" ?
                            this.shadowRoot.querySelector('#panelNavigator_2').classList.add('visible') :
                            this.shadowRoot.querySelector('#panelNavigator_1').classList.add('visible')
                    },1))
                    .then(() => promResolve )

            }

            _getGridSelectedItems() {
                return _.get(this.shadowRoot.querySelector('#vaadinGridPlanOfAction'), "selectedItems", []);
            }

            _resetGridSelectedItems() {

                const promResolve = Promise.resolve();

                const vaadinGrid = this.shadowRoot.querySelector('#vaadinGridPlanOfAction');
                vaadinGrid ? vaadinGrid.selectedItems = [] : false

                return promResolve

            }

            _clearGridCache() {

                const promResolve = Promise.resolve();

                const vaadinGrid = this.shadowRoot.querySelector('#vaadinGridPlanOfAction');
                vaadinGrid && vaadinGrid.clearCache()

                return promResolve

            }

            _isEqual(a, b) {
                return !!(a===b)
            }

            _msTstampToDDMMYYYY(msTstamp) {
                return parseInt(msTstamp) ? this.api.moment(parseInt(msTstamp)).format('DD/MM/YYYY') : ""
            }

            _closePlanOfAction(e) {

                return this.set("_vaadinGridPlanOfActionActiveItem", {})

            }

            _formatTranslateGender(gender){
                return gender === "female" ?
                    this.localize("abrv_female","Miss",this.language) :
                    this.localize("abrv_male","Mr.",this.language)
            }

            _ucFirst(inputValue){
                return _.map(_.trim(inputValue).split(" "),i=>_.upperFirst(_.trim(i).toLowerCase())).join(" ")
            }

            _formatDateOfBirth(inputValue){
                return inputValue ? this.api.moment(inputValue).format('DD/MM/YYYY') : ''
            }

            _dobToAge(inputValue) {
                return inputValue ? this.api.getCurrentAgeFromBirthDate(inputValue,( e , s ) => this.localize(e, s, this.language)) : ''
            }

            _toggleCollapsePdfPanel(e) {

                const pdfPanel = this.shadowRoot.querySelector('#pdfPanel')
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-BUTTON")

                pdfPanel && pdfPanel.classList && pdfPanel.classList.toggle("collapsed")
                targetButton && targetButton.firstElementChild && targetButton.firstElementChild.classList && targetButton.firstElementChild.classList.toggle("collapsedIcon")

            }

            _toggleCollapsePdfPreview(e) {

                const promResolve = Promise.resolve();
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-BUTTON")
                const documentId = _.trim(_.get(targetButton,"dataset.documentId"))

                return !_.trim(documentId) ? promResolve : promResolve
                    .then(()=> _.trim(_.get(this,"_currentPdfPreviewDocumentId","")) === documentId ? this.set("_currentPdfPreviewDocumentId", "") : this.set("_currentPdfPreviewDocumentId", documentId) )
                    .then(()=>{
                        const targetPdfPreviewPdfElement = this.shadowRoot.querySelector("#pdf-preview-" + documentId) && this.shadowRoot.querySelector("#pdf-preview-" + documentId).shadowRoot.querySelector("pdf-element")
                        return typeof _.get(targetPdfPreviewPdfElement,"onWidthChange","") === "function" ? targetPdfPreviewPdfElement.onWidthChange() : false
                    })

            }

            _selectedDocumentChanged(_selectedPrescriptionObject) {
                this.set("_selectedPrescriptionBoolean", !!_.size(_selectedPrescriptionObject) )
            }

            _unlinkPdfPrescription(e) {
                this.set("_selectedPrescriptionObject", {})
            }

            _getServicesMap(singleContact) {
                return singleContact.reduce((map, ctc) => {
                    const svcMap = ctc.subContacts.reduce((svcMap, subContact) => { subContact.services.reduce((svcMap, svcLink) => { (svcMap[svcLink.serviceId] || (svcMap[svcLink.serviceId] = [])).push(subContact); return svcMap; }, svcMap); return svcMap; }, {});
                    ctc.services.reduce((map, svc) => { (map[svc.label] || (map[svc.label] = [])).push({ svc: svc, scs: svcMap[svc.id] || [], ctc: ctc }); return map; }, map);
                    Object.values(map).forEach(arr => arr.sort((a, b) => b.svc.modified - a.svc.modified));
                    return map;
                }, {})
            }

            _stringByValue(stringToReturn, valueToMatch, inputVar) {

                valueToMatch = valueToMatch === "false" ? false : valueToMatch === "true" ? true : valueToMatch
                inputVar = !inputVar && valueToMatch === false ? false : inputVar
                return inputVar === valueToMatch ? stringToReturn : ""

            }

            _getConfig(cfgKeyName, defaultValue = false) {
                const triptyqueType = _.get(this,"_dialogParameters.triptyqueType","physiotherapist")
                return _.get(this,"_dialogParameters.configByType." + triptyqueType + "." + cfgKeyName, defaultValue)
            }

            _getPdfPrescriptionsListOrAlreadyLinkedPdfPrescription(inputConfig={}) {

                const pdfDocumentsLabelKey = this._getConfig("pdfDocumentsLabelKey","")
                const pdfDocumentsServiceStringValue = this.localize(pdfDocumentsLabelKey,"Prescription de kinÃ©sithÃ©rapie", this.language)

                return this.api.contact().findBy( this.user.healthcarePartyId, this.patient )
                    .then(patientContacts => _.compact(_.flatten(_.map(patientContacts, singleContact => _.map(singleContact.services, singleService => !_.trim(_.get(singleService,"content." + this.language + ".documentId")) ? false : {
                        contact: singleContact,
                        service: singleService,
                        serviceTitle: _.trim(_.get(singleService,"content." + this.language + ".stringValue")),
                        formId: _.trim(_.get(singleService,"formId")),
                        date: parseInt(_.get(singleService,"valueDate")),
                        dateAndTimeHr: moment(parseInt(_.trim(_.get(singleService,"valueDate")).substring(0,8)),"YYYYMMDD").format('DD/MM/YYYY') + " - " + _.trim(_.get(singleService,"valueDate")).substring(8,10) + ":" + _.trim(_.get(singleService,"valueDate")).substring(10,12),
                        documentId: _.trim(_.get(singleService,"content." + this.language + ".documentId"))
                    })))))
                    .then(foundServicesWithPrescription => !_.size(foundServicesWithPrescription) ? false : this.api.document().getDocuments({ids:_.map(foundServicesWithPrescription,s=>s.documentId)}).then(foundDocuments=>[foundServicesWithPrescription,foundDocuments]))
                    .then(([foundServicesWithPrescription,foundDocuments]) => _.compact(_.map(foundServicesWithPrescription, fswp => {
                        const serviceDocument = _.find(foundDocuments, {id: _.trim(_.get(fswp, "documentId"))})
                        const documentExtension = _.trim(_.last(_.trim(_.get(serviceDocument,"name","")).split("."))).toLowerCase()
                        return (
                            (
                                fswp.serviceTitle !== pdfDocumentsServiceStringValue &&
                                _.trim(_.get(serviceDocument, "documentType", "")).toLowerCase() !== "prescription"
                            ) ||
                            ['jpg','jpeg','pdf','png','tif','tiff'].indexOf(documentExtension) === -1 ||
                            !_.trim(_.get(serviceDocument,"id","")) ||
                            !_.trim(_.get(serviceDocument,"attachmentId","")) ||
                            !_.trim(_.get(serviceDocument,"secretForeignKeys",""))
                        ) ? false : _.merge({}, _.omit(fswp, ['documentId']), {document: serviceDocument})
                    })))
                    .then(servicesAndDocuments => Promise.all(servicesAndDocuments.map(sad => this.api.crypto().extractKeysFromDelegationsForHcpHierarchy(_.get(this, "user.healthcarePartyId", null), _.trim(_.get(sad.document, "id", "")), _.size(_.get(sad.document, "encryptionKeys", [])) ? _.get(sad.document, "encryptionKeys", []) : _.get(sad.document, "delegations", []))
                            .then(({extractedKeys: enckeys}) => !!_.trim(_.get(sad.document,"id","")) && _.trim(_.get(sad.document,"attachmentId","")) ? this.api.document().getAttachment(_.trim(_.get(sad.document,"id","")), _.trim(_.get(sad.document,"attachmentId","")), enckeys.join(',')).then(decryptedContent=>(_.merge(sad, {document:{decryptedContent:decryptedContent}}))).catch(e=>{console.log("ERROR with getAttachment: ",e); }) : sad)
                        )).then(servicesAndDocuments => servicesAndDocuments)
                    )
                    .then(servicesAndDocuments => _
                        .chain(servicesAndDocuments)
                        .filter(i => !!_.trim(_.get(i,"document.id")) && !!parseInt(_.get(i,"document.decryptedContent.byteLength")) )
                        .orderBy(['date'], ['desc'])
                        .value()
                    )

            }

            _linkPdfPrescription(e) {

                this.set("_isLoading", true);

                const promResolve = Promise.resolve();
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-BUTTON")
                const documentId = _.trim(_.get(targetButton,"dataset.documentId"))
                const documentServiceId = _.trim(_.get(targetButton,"dataset.serviceId"))
                const documentFormId = _.trim(_.get(targetButton,"dataset.formId"))
                const formTemplateGuid = _.trim(this._getConfig("formTemplateGuid"))
                const selectedPrescriptionObject = _.find(this._pdfPrescriptionsList, i=> i.service.id === documentServiceId && i.document.id === documentId)
                const documentContactObject = _.get(selectedPrescriptionObject,"contact",{})

                return promResolve
                    .then(() => this.api.code().findPaginatedCodes('be', 'care.topaz.customTransaction', ''))
                    .then(transactionCodes => _.find(transactionCodes.rows, tc => _.trim(_.get(tc,"code","")).toLowerCase() === "triptyque"))
                    .then(existingTriptyqueTransactionCode => !!_.size(existingTriptyqueTransactionCode) ? existingTriptyqueTransactionCode : this.api.code().createCode({
                        version: "1",
                        code: "triptyque",
                        regions: ["be","fr"],
                        type: "care.topaz.customTransaction",
                        id: "care.topaz.customTransaction|triptyque|1",
                        label: {fr:"Triptyque",nl:"Triptyque",en:"Triptyque"}
                    }))
                    .then(triptyqueTransactionCode => this.api.code().getCodes( this._getConfig("defaultCodes",[]).map(i=>_.trim(_.get(i,"id",""))) ).then(defaultCodes => ([triptyqueTransactionCode,defaultCodes])))
                    .then(([triptyqueTransactionCode,defaultCodes]) => this.api.patient().getPatientWithUser(this.user, _.trim(_.get(this,"patient.id",""))).then(patientObject => ([triptyqueTransactionCode,defaultCodes,patientObject])))
                    .then(([triptyqueTransactionCode,defaultCodes,patientObject]) => this.api.contact().newInstance(this.user, patientObject, {
                            groupId: documentId,
                            created: +new Date,
                            modified: +new Date,
                            author: _.trim(_.get(this,"user.id","")),
                            responsible: _.trim(_.get(this,"user.healthcarePartyId","")),
                            openingDate: moment().format('YYYYMMDDHHmmss'),
                            closingDate: moment().format('YYYYMMDDHHmmss'),
                            encounterType: { type: _.trim(_.get(triptyqueTransactionCode,"type","care.topaz.customTransaction")), version: _.trim(_.get(triptyqueTransactionCode,"version","1")), code: _.trim(_.get(triptyqueTransactionCode,"code","triptyque")) },
                            descr: _.trim(_.get(triptyqueTransactionCode,"label." + this.language,"Triptyque")) + ": " + _.trim(this.localize(this._getConfig("pdfDocumentsLabelKey",""),"Prescription de kinÃ©sithÃ©rapie", this.language)),
                            tags: [
                                { type: "BE-CONTACT-TYPE", version: "1", code: "1" },
                                { type: "BE-CONTACT-TYPE", version: "1", code: "20" },
                                { type: _.trim(_.get(triptyqueTransactionCode,"type","care.topaz.customTransaction")), version: _.trim(_.get(triptyqueTransactionCode,"version","1")), code: _.trim(_.get(triptyqueTransactionCode,"code","triptyque")) },
                                { type: "originalDocumentId", id: documentId },
                                { type: "originalDocumentContactId", id: _.trim(_.get(documentContactObject,"id",""))},
                                { type: "originalDocumentServiceId", id: documentServiceId },
                                { type: "originalDocumentFormId", id: documentFormId},
                            ],
                            codes: _.map(defaultCodes, dc =>{return{type: _.trim(_.get(dc,"type")), version: _.trim(_.get(dc,"version")), code: _.trim(_.get(dc,"code")), label: _.get(dc,"label",{}) }}),
                            subContacts: [],
                            services: []
                        }).then(contactInstance => ([patientObject,contactInstance]))
                    )
                    .then(([patientObject,contactInstance]) => this.api.contact().createContactWithUser(this.user, contactInstance).then(createdContact => ([patientObject,createdContact])))
                    .then(([patientObject,createdContact]) => this.api.hcparty().getCurrentHealthcareParty()
                        .then(currentHcp => Promise.all([
                            this.api.form().getFormTemplatesByGuid( formTemplateGuid, "deptgeneralpractice" ),
                            this.api.form().getFormTemplatesByGuid( formTemplateGuid, _.trim(_.get(currentHcp,"specialityCodes[0].code", "deptgeneralpractice")).replace(/persphysician/, 'deptgeneralpractice'))
                        ]).then(promResults => ([patientObject,createdContact,_.chain(promResults).flatten().filter(x=>!_.get(x,"disabled",false)).uniqBy("guid").compact().head().value()])))
                    )
                    .then(([patientObject,createdContact,formTemplate]) => this.api.form().newInstance(this.user, patientObject, {
                            contactId: _.trim(_.get(createdContact,"id","")),
                            formTemplateId: _.trim(_.get(formTemplate,"id","")),
                            descr: _.trim(_.get(formTemplate,"name","")),
                            tags: _.get(createdContact,"tags",[]),
                        }).then(formInstance => ([patientObject,createdContact,formInstance]))
                    )
                    .then(([patientObject,createdContact,formInstance]) => this.api.form().createForm(formInstance).then(createdForm => ([patientObject,createdContact,createdForm])))
                    .then(([patientObject,createdContact,createdForm]) => {

                        const subContactServiceIds = _.compact(_.uniq(_.get(_.find(_.get(documentContactObject,"subContacts",[]), {formId: documentFormId}),"services",[]).map(i=>_.trim(_.get(i,"serviceId","")))))
                        const subContactServiceDatas = _.filter(_.get(documentContactObject,"services",[]), i=> subContactServiceIds.indexOf(_.trim(_.get(i,"id",""))) > -1 )
                        const newServicesData = _.map(subContactServiceDatas, scsd => this.api.contact().service().newInstance(this.user, _.merge({}, _.omit(scsd, ["author","created","cryptedForeignKeys","delegations","encryptedSelf","encryptionKeys","id","modified","responsible","secretForeignKeys"]))))

                        createdContact.services = newServicesData
                        createdContact.subContacts = [{
                            codes:[],
                            descr:this.api.crypto().randomUuid(),
                            formId:_.trim(_.get(createdForm,"id","")),
                            hasBeenInitialized: false,
                            services: _.map(newServicesData, sv => {return{serviceId: _.trim(_.get(sv,"id",""))/*, service:sv*/}})
                        }]

                        return this.api.contact().modifyContactWithUser(this.user, createdContact).then(modifiedContact => ([patientObject,modifiedContact,createdForm]))

                    })
                    .then(([patientObject,modifiedContact,createdForm]) => {

                        selectedPrescriptionObject.formId = _.trim(_.get(createdForm,"id",""))
                        selectedPrescriptionObject.contact = modifiedContact
                        selectedPrescriptionObject.contacts = [modifiedContact]
                        selectedPrescriptionObject.servicesMap = this._getServicesMap([modifiedContact])

                        this.set("patient", patientObject)
                        this.set("_currentPdfPreviewDocumentId", "")
                        this.set("_selectedPrescriptionObject", selectedPrescriptionObject)
                        this.set("_summaryForm.careTeam", _.get(this,"_selectedPrescriptionObject.document.author"))

                    })
                    .finally(() => {
                        console.log("selectedPrescriptionObject", selectedPrescriptionObject)
                        this.set("_isLoading", false);
                    })

            }

            _addPlanOfAction() {

                return this._vaadinGridPlanOfActionActiveItemChanged({},true)

            }

            _prescriptionFormDataGotChanged(e) {

                const reqIdx = (this._saveFormReqIdx = (this._saveFormReqIdx || 0) + 1)
                const contactObject = _.get(e,"detail",{})

                setTimeout(() => {
                    return (reqIdx !== this._saveFormReqIdx || !_.size(contactObject)) ? false : this.api.contact().modifyContactWithUser(this.user, contactObject)
                        .then(modifiedContact => this.api.register(modifiedContact, 'contact'))
                        .then(modifiedContact => { return (reqIdx !== this._saveFormReqIdx) ? false : this.set("_selectedPrescriptionObject", _.merge({},_.get(this,"_selectedPrescriptionObject",{}), { contact: modifiedContact, contacts: [modifiedContact], servicesMap: this._getServicesMap([modifiedContact]) })) })

                }, 2000)

            }

            _gotoTabIfsAllowed(e) {

                // 1. prescriptionForm
                // 2. summary
                // 3. procedures

                const currentTab = _.trim(_.get(this,"_triptyqueDetailActiveTab", "prescriptionForm"))
                const targetTab = _.trim(_.find( e.path, p => _.get(p,"nodeName","") === "PAPER-TAB").getAttribute('name'))
                const gotoTab = !_.size(_.get(this,"_selectedPrescriptionObject",{})) ? "prescriptionForm" :
                    currentTab === "procedures" ? targetTab :
                    currentTab === "prescriptionForm" && targetTab === "summary" ? !!_.size(_.compact(_.map( this._selectedPrescriptionObject.contact.services, sv => !!_.size(_.get(sv,"content." + this.language )) && _.get(sv,"content." + this.language + ".booleanValue" ) !== false ))) ? targetTab : currentTab :
                    currentTab === "prescriptionForm" && targetTab === "procedures" ? (true === true /* Validate BOTH prescriptionForm & summary tabs here */ ) ? targetTab : currentTab :
                    currentTab === "summary" ? (true === true /* Validate summary tab here */ ) ? targetTab : currentTab :
                    targetTab

                return setTimeout(()=>{this.set("_triptyqueDetailActiveTab", gotoTab)})

            }

            _toggleCollapseInsuranceDocumentPreview(e) {

                const promResolve = Promise.resolve();
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-BUTTON")
                const documentId = _.trim(_.get(targetButton,"dataset.documentId"))

                return !_.trim(documentId) ? promResolve : promResolve
                    .then(()=> _.trim(_.get(this,"_currentPreviewInsuranceDocumentId","")) === documentId ? this.set("_currentPreviewInsuranceDocumentId", "") : this.set("_currentPreviewInsuranceDocumentId", documentId) )
                    .then(()=>{
                        const targetPdfPreviewPdfElement = this.shadowRoot.querySelector("#insurance-document-preview-" + documentId) && this.shadowRoot.querySelector("#insurance-document-preview-" + documentId).shadowRoot.querySelector("pdf-element")
                        return typeof _.get(targetPdfPreviewPdfElement,"onWidthChange","") === "function" ? targetPdfPreviewPdfElement.onWidthChange() : false
                    })

            }

            _linkInsuranceDocument(e) {

                const promResolve = Promise.resolve();
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-BUTTON")
                const documentId = _.trim(_.get(targetButton,"dataset.documentId"))
                const targetDocument = _.head(_.remove(this._insuranceDocuments, {documentId:documentId}))

                return !documentId || !_.size(targetDocument) ?
                    false :
                    promResolve.then(() => {
                        this.push("_insuranceLinkedDocuments", targetDocument)
                        setTimeout(() => {
                            this.set("_summaryForm.insuranceDocuments", _.get(this,"_insuranceLinkedDocuments",[]))
                            this.shadowRoot.querySelector('#triptyqueLinkedInsuranceDocumentsDomRepeat') && this.shadowRoot.querySelector('#triptyqueLinkedInsuranceDocumentsDomRepeat').render()
                            this.shadowRoot.querySelector('#triptyqueAvailableInsuranceDocumentsDomRepeat') && this.shadowRoot.querySelector('#triptyqueAvailableInsuranceDocumentsDomRepeat').render()
                        }, 100)
                    })

            }

            _removeLinkedInsuranceDocument(e) {

                const promResolve = Promise.resolve();
                const targetButton = !!_.size(_.get(e,"target","")) && _.get(e,"target.nodeName","") === "PAPER-ICON-BUTTON" ? e.target : _.find( e.path, p => _.get(p,"nodeName","") === "PAPER-ICON-BUTTON")
                const documentId = _.trim(_.get(targetButton,"dataDocumentId",_.trim(_.get(e,"target.dataDocumentId",""))))
                const targetDocument = _.head(_.remove(this._insuranceLinkedDocuments, {documentId:documentId}))

                return !documentId || !_.size(targetDocument) ?
                    false :
                    promResolve.then(() => {
                        this.push("_insuranceDocuments",targetDocument)
                        setTimeout(() => {
                            this.set("_summaryForm.insuranceDocuments", _.get(this,"_insuranceLinkedDocuments",[]))
                            this.shadowRoot.querySelector('#triptyqueLinkedInsuranceDocumentsDomRepeat') && this.shadowRoot.querySelector('#triptyqueLinkedInsuranceDocumentsDomRepeat').render()
                            this.shadowRoot.querySelector('#triptyqueAvailableInsuranceDocumentsDomRepeat') && this.shadowRoot.querySelector('#triptyqueAvailableInsuranceDocumentsDomRepeat').render()
                        }, 100)
                    })

            }

            _scrollToTop() {

                const promResolve = Promise.resolve();

                const grid = this.shadowRoot.getElementById('vaadinGridPlanOfAction')
                grid && setTimeout(()=>grid._scrollToIndex(0),10)

                return promResolve

            }

            _triggerGridResize() {

                const promResolve = Promise.resolve();

                const grid = this.shadowRoot.getElementById('vaadinGridPlanOfAction')
                grid && setTimeout(()=>grid.notifyResize(),10)

                return promResolve

            }

            _getDialogData() {

                const promResolve = Promise.resolve();

                // const arrayOfDocumentIds = [ "fbd5f03a-7a1e-413d-ae79-8861e056757c",  "beaea1bb-cfe2-410f-9e4c-a76555d4202b" ]
                // promResolve
                //     .then(() =>this.api.patient().getPatientWithUser(_.get(this,"user",{}), _.trim(_.get(this,"patient.id",""))).then(pat => this.set("_dialogData.currentPatient", pat)))
                //     .then(() =>this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject( "encrypt", _.get(this,"user",{}), _.get(this,"_dialogData.currentPatient",{}), this.api.crypto().utils.ua2ArrayBuffer(this.api.crypto().utils.text2ua(arrayOfDocumentIds[0])) ).then(encryptedContent => { console.log("arrayOfDocumentIds[0]", arrayOfDocumentIds[0]); console.log("encryptedContent AS string", Base64.encode(String.fromCharCode.apply(null, new Uint8Array(encryptedContent)))); }))
                //     .then(() =>this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject( "encrypt", _.get(this,"user",{}), _.get(this,"_dialogData.currentPatient",{}), this.api.crypto().utils.ua2ArrayBuffer(this.api.crypto().utils.text2ua(arrayOfDocumentIds[1])) ).then(encryptedContent => { console.log("arrayOfDocumentIds[1]", arrayOfDocumentIds[1]); console.log("encryptedContent AS string", Base64.encode(String.fromCharCode.apply(null, new Uint8Array(encryptedContent)))); }))
                //
                // "encryptedAdministrativesDocuments": [
                //     "Oxocw4EIwrDDgRvCp8KIc2Aww4c3w4rDmHcmAx8mwq7DhcKCRcKLwrsQI2cbYcOpw58Mw60jwrp3ZsKZwp/CqHbDtsKPAxhgdMKsRVQXw77DosOkPVZJwosbCw==",
                //     "ZMO+e8OWW3fCjQoCFG7Dj1cDw4vCgFdyw5TCncKRLcKfXlsbw5opRcKkYzHDqmXDisKqw68Tw7cbYMKUC8OwPxPCgnfDkzrCuDPCmzvCgT4ab8ONa0PCssK3dA=="
                // ]

                return promResolve
                    .then(() => this.api.hcparty().getCurrentHealthcareParty().then(hcp => this.set("_dialogData.currentHcp", _.merge({},hcp,{nameHr: _.map( (_.trim(_.get(hcp, "name", "")) ? _.trim(_.get(hcp, "name", "")) : _.trim(_.get(hcp, "lastName", "")) + " " + _.trim(_.get(hcp, "firstName", ""))).split(" "), i=>_.upperFirst(_.trim(i).toLowerCase())).join(" ") }))))
                    .then(() => Promise.all([
                        this.api.form().getFormTemplatesByGuid( _.trim(this._getConfig("formTemplateGuid")), "deptgeneralpractice" ),
                        this.api.form().getFormTemplatesByGuid( _.trim(this._getConfig("formTemplateGuid")), _.trim(_.get(this,"_dialogData.currentHcp.specialityCodes[0].code", "deptgeneralpractice")).replace(/persphysician/, 'deptgeneralpractice'))
                    ]).then(promResults => this.set("_dialogData.formTemplate", _.chain(promResults).flatten().filter(x=>!_.get(x,"disabled",false)).uniqBy("guid").compact().head().value())))
                    .then(() =>this.api.patient().getPatientWithUser(_.get(this,"user",{}), _.trim(_.get(this,"patient.id",""))).then(pat => this.set("_dialogData.currentPatient", pat)))
                    .then(() => !_.size( _.get(this,"_dialogData.currentPatient.encryptedAdministrativesDocuments",[]) ) ?  [] :  Promise.all( _.get(this,"_dialogData.currentPatient.encryptedAdministrativesDocuments",[]).map(encryptedAdminDocId => this.api.encryptDecryptFileContentByUserHcpIdAndDocumentObject("decrypt", _.get(this,"user",{}), _.get(this,"_dialogData.currentPatient",{}), this.api.crypto().utils.text2ua(Base64.decode(_.trim(encryptedAdminDocId)))).then(uaDecryptedContent => this.api.crypto().utils.ua2text(uaDecryptedContent)))) )
                    .then(insuranceDocumentIds => !_.size( insuranceDocumentIds ) ? promResolve : this.api.document().getDocuments({ids:insuranceDocumentIds}).then(foundDocuments => this.set("_dialogData.insuranceDocuments", _.map(foundDocuments, i => {return {
                        created: moment(parseInt(_.get(i, "modified", 0))).format('DD/MM/YYYY - HH:mm'),
                        documentId: _.trim(_.get(i, "id", "")),
                        attachmentId: _.trim(_.get(i, "attachmentId", "")),
                        documentMainUti: _.trim(_.get(i, "mainUti", "")),
                        documentName: _.trim(_.get(i, "name", ""))
                    }}))))
                    .then(()=> this._getPdfPrescriptionsListOrAlreadyLinkedPdfPrescription().then(pdfPrescriptions => this.set("_dialogData.pdfPrescriptionsList", !!_.size(pdfPrescriptions) ? pdfPrescriptions : [])))
                    .then(() =>this.api.helement().findBy(this.user.healthcarePartyId, this.patient))
                    .then(hes => _
                        .chain(hes)
                        .filter(i => !!_.size(_.filter(_.get(i,"plansOfAction",[]), j =>  !!_.size(_.find(_.get(j,"tags",[]), {type:"originalDocumentId"})))))
                        .orderBy(["desc","created"], ["asc","desc"])
                        .map(i => _.merge({},{
                            heId: _.trim(_.get(i, "id", "")),
                            heClosingDate: parseInt(_.get(i, "closingDate"))||null,
                            heCodes: _.get(i, "codes", []),
                            heCreated: parseInt(_.get(i, "created"))||null,
                            heDescr: _.trim(_.get(i, "descr", "")),
                            heOpeningDate: parseInt(_.get(i, "openingDate"))||null,
                            hePlansOfAction: _.get(i, "plansOfAction",[]),
                            heStatus: parseInt(_.get(i, "status",0)),
                            heTags: _.get(i, "tags",[]),
                        }))
                        .value()
                    )
                    .then(hes => _.flatten(_.map(hes, he => _.map(_.get(he,"hePlansOfAction",[]), poa => {
                        return !_.size(_.filter(_.get(poa,"tags"), {type:"originalDocumentId"})) ? false : _.merge({}, he, {
                            poaId: _.trim(_.get(poa, "id", "")),
                            poaResponsible: _.trim(_.get(poa, "responsible", "")) ? _.trim(_.get(poa, "responsible", "")) : _.trim(_.get(this, "_dialogData.currentHcp.id", "")),
                            poaClosingDate: parseInt(_.get(poa, "closingDate"))||null,
                            poaCodes: _.get(poa, "codes", []),
                            poaCreated: parseInt(_.get(poa, "created"))||null,
                            poaDocumentIds: _.compact(_.uniq(_.get(poa, "documentIds",[]))),
                            poaEndOfLife: parseInt(_.get(poa, "endOfLife"))||null,
                            poaIdOpeningContact: _.trim(_.get(poa, "idOpeningContact", "")),
                            poaName: _.trim(_.get(poa, "name", "")),
                            poaNumberOfCares: _.trim(_.get(poa, "numberOfCares", "")),
                            poaNumberOfCaresMade: "todo",
                            poaOpeningDate: parseInt(_.get(poa, "openingDate"))||null,
                            poaPrescriberId: _.trim(_.get(poa, "prescriberId", "")),
                            poaStatus: parseInt(_.get(poa, "status",0)),
                            poaTags: _.get(poa, "tags", []),
                            poaValueDate: parseInt(_.get(poa, "valueDate"))||null,
                            poaStatusHr: this.localize(
                                !!(_.get(poa,"status",0)&(1<<4)) ? "STATUS_CANCELED" :
                                    !!(_.get(poa,"status",0)&(1<<3)) ? "STATUS_PROLONGED" :
                                        !!(_.get(poa,"status",0)&(1<<2)) ? "STATUS_FINISHED" :
                                            !!(_.get(poa,"status",0)&(1<<1)) ? "STATUS_ONGOING" :
                                                "STATUS_PLANNED", // 1<<0
                                "",
                                this.language
                            )
                        })
                    }))))
                    .then(hesAndPoas => this.set("_dialogData.hesAndPoas", _.compact(_.orderBy(hesAndPoas, ["heDescr", "poaName", "poaCreated"], ["asc","asc","desc"]))))
                    .then(()=>{

                        const internalHcp = _.compact(_.keys(_.get(this,"_dialogData.currentPatient.delegations",[])))
                        const externalHcp = _.compact(_.map(_.get(this,"_dialogData.currentPatient.patientHealthCareParties",[]),i=>_.get(i,"healthcarePartyId","")))
                        const hesAndPoasHcps = _.compact(_.map(_.get(this,"_dialogData.hesAndPoas",[]), i=>_.trim(_.get(i, "poaPrescriberId", ""))))

                        return this.api.hcparty().getHealthcareParties( _.compact(_.uniq(_.concat(internalHcp, externalHcp, hesAndPoasHcps))).join(",") )
                            .then(resolvedHcps => _.map(resolvedHcps, hcp => { return {
                                id: _.trim(_.get(hcp, "id", "")),
                                parentId: _.trim(_.get(hcp, "parentId", "")),
                                name: _.map( (_.trim(_.get(hcp, "name", "")) ? _.trim(_.get(hcp, "name", "")) : _.trim(_.get(hcp, "lastName", "")) + " " + _.trim(_.get(hcp, "firstName", ""))).split(" "), i=>_.upperFirst(_.trim(i).toLowerCase())).join(" "),
                                nihii: _.trim(_.get(hcp, "nihii", "")),
                                type: _.trim(_.get(hcp, "type", "")),
                                nihiiHr: this.api.formatInamiNumber(_.trim(_.get(hcp, "nihii", ""))),
                                specialityCodes: _.compact(_.map(_.get(hcp, "specialityCodes", []), i => _.trim(_.get(i,"id","")))),
                                isInternal: internalHcp.indexOf(_.trim(_.get(hcp, "id", ""))) > -1
                            }}))

                    })
                    .then(hcps => {
                        const hcpSpecialityCodes = _.compact(_.uniq(_.flatten(_.map(hcps, i=>i.specialityCodes))))
                        return !!_.size(hcpSpecialityCodes) ? this.api.code().getCodes( hcpSpecialityCodes.join(",") ).then(specialityCodes=>([hcps,specialityCodes])) : ([hcps,[]])
                    })
                    .then(([hcps,specialityCodes]) => _.map(hcps, hcp=>_.merge({},hcp,{specialityCodesHr:_.compact(_.map(hcp.specialityCodes, sc=>_.get(_.find(specialityCodes,{id:sc}),"label."+this.language, _.head(_.flatMap(_.get(_.find(specialityCodes,{id:sc}),"label",{}))) ))).join(", ")})))
                    .then(hcps => this.set("_dialogData.availableHcps", _.map(_.sortBy(hcps, ["name"],["asc"]), hcp=> _.merge({}, hcp, { vaadinComboxBoxLabelHr: _.compact([ "[" + this.localize((!!_.get(hcp,"isInternal","")?"internal":"external"),"Internal", this.language) + "]", _.trim(_.get(hcp,"name","")), _.trim(_.get(hcp,"nihiiHr","")), (_.trim(_.get(hcp,"specialityCodesHr","")) ? "(" + _.trim(_.get(hcp,"specialityCodesHr","")) + ")" : "") ]).join(" ") }))))
                    .then(() => this.set("_dialogData.hesAndPoas", _.map(_.get(this,"_dialogData.hesAndPoas",[]), heAndPoa => _.merge({},heAndPoa,{poaPrestataireHr: _.trim(_.get(_.find(_.get(this,"_dialogData.availableHcps",[]), {id:_.trim(_.get(heAndPoa,"poaResponsible",""))}), "name","")), poaPrescriberHr: _.trim(_.get(_.find(_.get(this,"_dialogData.availableHcps",[]), {id:_.trim(_.get(heAndPoa,"poaPrescriberId",""))}), "name",""))}))))
                    .then(() => Promise.all([
                        this.api.code().findPaginatedCodes('be', "CD-BVT-LATERALITY"),
                        this.api.code().findPaginatedCodes('be', "care.topaz.customTransaction"),
                        this.api.code().findPaginatedCodes('be', this._getConfig("careReasonsCode","CD-INCAPACITYREASON")),
                        this.api.code().findPaginatedCodes('be', this._getConfig("prescriptionTypeCode","care.topaz.kinesitherapyPrescription")),
                        this.api.code().getCodes( this._getConfig("defaultCodes",[]).map(i=>_.trim(_.get(i,"id",""))) )
                    ]))
                    .then(codes => this.set("_dialogData.codes", {
                        lateralityCodes: _.get(codes,"[0].rows",[]),
                        triptyqueCodes: _.find(_.get(codes,"[1].rows",[]),{code: "triptyque"}),
                        incapacityCodes: _.get(codes,"[2].rows",[]),
                        prescriptionCodes: _.get(codes,"[3].rows",[]),
                        defaultCodes: _.get(codes,"[4]",[])
                    }))
                    .then(() => {

                        this.set("_dialogData.relatedChildrenPathologies", _.chain(_.get(this, "_dialogData.codes.prescriptionCodes",[])).filter(i => !!_.trim(_.get(i,"parent","")) && !_.get(i,"disabled",false)).map(i => _.merge({}, i, { labelHr: _.trim(_.get(i,"label." + this.language,"")) })).orderBy(["parent", "label." + this.language],["asc","asc"]).value())
                        this.set("_dialogData.relatedParentPathologies", _.chain(_.get(this, "_dialogData.codes.prescriptionCodes",[])).filter(i => !_.trim(_.get(i,"parent","")) && !_.get(i,"disabled",false)).map(i => _.merge({}, i, { labelHr: _.trim(_.get(i,"label." + this.language,"")),hasChildren: !!_.size(_.filter(this._relatedChildrenPathologies, j => _.trim(_.get(j,"parent","")) === _.trim(_.get(i,"id","")))) })).orderBy(["label." + this.language],["asc"]).value())

                        this.set("_dialogData.codes.incapacityCodes", _.orderBy(_.compact(_.map(_.filter(_.get(this, "_dialogData.codes.incapacityCodes", []),i=>!_.get(i,"disabled",false)), i => _.merge({}, i, {
                            id: _.trim(_.get(i,"id","")),
                            labelHr: _.trim(_.get(i,"label." + this.language,"")) ? _.trim(_.get(i,"label." + this.language,"")) : _.trim(_.head(_.flatMap(_.get(i,"label","")))),
                        }))), ["labelHr"], ["asc"]))

                        return !!_.size(_.get(this,"_dialogData.codes.triptyqueCodes")) ? true : this.api.code().createCode({
                            version: "1",
                            code: "triptyque",
                            regions: ["be","fr"],
                            type: "care.topaz.customTransaction",
                            id: "care.topaz.customTransaction|triptyque|1",
                            label: {fr:"Triptyque",nl:"Triptyque",en:"Triptyque"}
                        })
                            .then(triptyqueTransactionCode => this.set("_dialogData.codes.triptyqueCodes", triptyqueTransactionCode))

                    })
                    .finally(() => promResolve)

            }

            _gotoPreviousGridPage() {
                if ( parseInt(_.get(this,"_vaadinGridCurrentPageNumber",1)) > 1 ) this.set( '_vaadinGridCurrentPageNumber',( parseInt(_.get(this,"_vaadinGridCurrentPageNumber",2)) - 1 ) )
            }

            _gotoNextGridPage() {
                if ( parseInt(_.get(this,"_vaadinGridCurrentPageNumber",1)) < parseInt(_.get(this,"_vaadinGridTotalPages",1)) ) this.set('_vaadinGridCurrentPageNumber', ( parseInt(_.get(this,"_vaadinGridCurrentPageNumber",1)) + 1 ) )
            }

















            _vaadinGridPlanOfActionActiveItemChanged(activeItem, isNew=false) {

                // Should not yet ?
                if(activeItem instanceof Event || !_.get(this,"_isOpened",false)) return

                this.set("_isLoading", true)

                return !_.trim(_.get(activeItem,"id","")) && !isNew ?
                    this._changeDialogAction("listing").finally(()=>this.set("_isLoading", false)) :
                    this._changeDialogAction("detail")

                        // Fabien : Soit pdf dÃ©jÃ  liÃ© -> get juste celui-lÃ  (%activeItem) || Soit get la liste des PDF qui existent dÃ©jÃ 
                        .then(()=> this._getPdfPrescriptionsListOrAlreadyLinkedPdfPrescription())
                        .then(pdfPrescriptions => pdfPrescriptions) /* IF activeItem ==> invoke / get / load cuisine de this._linkPdfPrescription */
                        .then(pdfPrescriptions => this.set("_pdfPrescriptionsList", !!_.size(pdfPrescriptions) ? pdfPrescriptions : []))

                        // Fabien: load doc mutuelle % transportGuid SSI !activeItem sinon get depuis this.patient ==> encryptedAdministrativesDocuments
                        .then(() => this.api.message().findMessagesByTransportGuid(_.trim(this._getConfig("insuranceMessagesDocumentsTransportGuid","")), null, null, null, 1000).then(foundMessages => _.filter(foundMessages.rows, m => m && !parseInt(_.get(m,"deletionDate",0)))))
                        .then(foundMessages => Promise.all(_.map(foundMessages, singleMessage => this.api.document().findByMessage(_.get(this,"user.healthcarePartyId",""), singleMessage).then(foundDocument => _.merge({},singleMessage,{document:_.head(foundDocument)})))))
                        .then(messagesAndDocuments => this.set("_insuranceDocuments", _.map(messagesAndDocuments, i => {return {
                            messageId: _.trim(_.get(i, "id", "")),
                            created: moment(parseInt(_.get(i, "created", 0))).format('DD/MM/YYYY - HH:mm'),
                            documentId: _.trim(_.get(i, "document.id", "")),
                            attachmentId: _.trim(_.get(i, "document.attachmentId", "")),
                            documentMainUti: _.trim(_.get(i, "document.mainUti", "")),
                            documentName: _.trim(_.get(i, "document.name", "")),
                            documentType: _.trim(_.get(i, "metas.type", "")),
                        }})))
                        .then(() => this.set("activeHealthElements", _.map(_.filter(this.activeHealthElements, ah => !!_.trim(_.get(ah,"id",""))), i => {
                            i.id = _.trim(_.get(i, "id", _.trim(_.get(i, "idService", ""))))
                            i.descrHr = _.compact([_.get(_.filter(_.get(i, "codes", ""), j => _.get(j, "type", "") === "ICPC"), "[0].code", ""), _.get(i, "descr", "")]).join(" - ")
                            return i
                        })))
                        .then(() => this.api.code().findPaginatedCodes('be', this._getConfig("prescriptionTypeCode",""), ''))
                        .then(prescriptionCodes => {
                            this.set("_relatedChildrenPathologies", _.chain(_.get(prescriptionCodes,"rows",[])).filter(i => !!_.trim(_.get(i,"parent","")) && !_.get(i,"disabled",false)).map(i => _.merge({}, i, { labelHr: _.trim(_.get(i,"label." + this.language,"")) })).orderBy(["parent", "label." + this.language],["asc","asc"]).value())
                            this.set("_relatedParentPathologies", _.chain(_.get(prescriptionCodes,"rows",[])).filter(i => !_.trim(_.get(i,"parent","")) && !_.get(i,"disabled",false)).map(i => _.merge({}, i, { labelHr: _.trim(_.get(i,"label." + this.language,"")),hasChildren: !!_.size(_.filter(this._relatedChildrenPathologies, j => _.trim(_.get(j,"parent","")) === _.trim(_.get(i,"id","")))) })).orderBy(["label." + this.language],["asc"]).value())
                        })
                        .then(() => this.api.code().findCodes('be', this._getConfig("careReasonsCode",""), ''))
                        .then(careReasonsData => this.set("_careReasons", _.orderBy(_.compact(_.map(_.filter(careReasonsData,i=>!_.get(i,"disabled",false)), i => { return {
                            id: _.trim(_.get(i,"id","")),
                            labelHr: _.trim(_.get(i,"label." + this.language,"")) ? _.trim(_.get(i,"label." + this.language,"")) : _.trim(_.head(_.flatMap(_.get(i,"label","")))),
                        }})), ["labelHr"], ["asc"])))
                        .then(()=>{
                            const internalHcp = _.compact(_.keys(_.get(this,"patient.delegations",[])))
                            const externalHcp = _.compact(_.map(_.get(this,"patient.patientHealthCareParties",[]),i=>_.get(i,"healthcarePartyId","")))
                            return this.api.hcparty().getHealthcareParties( _.compact(_.uniq(_.concat(internalHcp, externalHcp))).join(",") )
                                .then(resolvedHcps => _.map(resolvedHcps, hcp => { return {
                                    id: _.trim(_.get(hcp, "id", "")),
                                    name: _.map( (_.trim(_.get(hcp, "name", "")) ? _.trim(_.get(hcp, "name", "")) : _.trim(_.get(hcp, "lastName", "")) + " " + _.trim(_.get(hcp, "firstName", ""))).split(" "), i=>_.upperFirst(_.trim(i))).join(" "),
                                    nihiiHr: this.api.formatInamiNumber(_.trim(_.get(hcp, "nihii", ""))),
                                    specialityCodes: _.compact(_.map(_.get(hcp, "specialityCodes", []), i => _.trim(_.get(i,"id","")))),
                                    isInternal: internalHcp.indexOf(_.trim(_.get(hcp, "id", ""))) > -1
                                }}))
                        })
                        .then(hcps => {
                            const hcpSpecialityCodes = _.compact(_.uniq(_.flatten(_.map(hcps, i=>i.specialityCodes))))
                            return !!_.size(hcpSpecialityCodes) ? this.api.code().getCodes( hcpSpecialityCodes.join(",") ).then(specialityCodes=>([hcps,specialityCodes])) : ([hcps,[]])
                        })
                        .then(([hcps,specialityCodes]) => _.map(hcps, hcp=>_.merge({},hcp,{specialityCodesHr:_.compact(_.map(hcp.specialityCodes, sc=>_.get(_.find(specialityCodes,{id:sc}),"label."+this.language, _.head(_.flatMap(_.get(_.find(specialityCodes,{id:sc}),"label",{}))) ))).join(", ")})))
                        .then(hcps => this.set("_careTeamValues", _.map(_.sortBy(hcps, ["name"],["asc"]), hcp=>{ return {
                            id: _.trim(_.get(hcp,"id","")),
                            labelHr: _.compact([ "[" + this.localize((!!_.get(hcp,"isInternal","")?"internal":"external"),"Internal", this.language) + "]", _.trim(_.get(hcp,"name","")), _.trim(_.get(hcp,"nihiiHr","")), (_.trim(_.get(hcp,"specialityCodesHr","")) ? "(" + _.trim(_.get(hcp,"specialityCodesHr","")) + ")" : "") ]).join(" ")
                        }})))
                        .finally(() => this.set("_isLoading", false))

            }

            _summaryFormDataGotChanged(summaryForm) {

                const promResolve = Promise.resolve();
                const careBeginningDate = _.trim(_.get(this,"_selectedPrescriptionObject.servicesMap[" + this._getConfig("careBeginDateServiceMapKey","Date intervention") + "][0].svc.content." + this.language + ".fuzzyDateValue", ""))
                const numberOfCares = _.trim(_.get(this,"_selectedPrescriptionObject.servicesMap[" + this._getConfig("numberOfCaresServiceMapKey","Nombre de sÃ©ances") + "][0].svc.content." + this.language + ".numberValue", ""))

                // Show / hide children pathologies % parent pathologies
                if(_.trim(_.get(summaryForm,"path","")).toLowerCase().indexOf('relatedparentpathology') > -1 ) {

                    const parentValue = _.trim(_.get(this,"_summaryForm.relatedParentPathology",""))
                    const parentChildren = _.filter(this._relatedChildrenPathologies, i => _.trim(_.get(i,"parent","")) === parentValue )
                    const childrenPathologiesForSelectedParent = !!_.trim(parentValue) && !!_.size(parentChildren) ? parentChildren : []
                    const relatedChildrenPathologyVaadinComboBoxClassList = this.shadowRoot.querySelector('#relatedChildrenPathology').classList

                    this.set("_summaryForm.relatedChildrenPathology", "")
                    this.set("_relatedChildrenPathologiesForSelectedParent", !!_.size(childrenPathologiesForSelectedParent) ? childrenPathologiesForSelectedParent : [])
                    relatedChildrenPathologyVaadinComboBoxClassList && !!_.size(childrenPathologiesForSelectedParent) && relatedChildrenPathologyVaadinComboBoxClassList.remove("displaynone")
                    relatedChildrenPathologyVaadinComboBoxClassList && !_.size(childrenPathologiesForSelectedParent) && relatedChildrenPathologyVaadinComboBoxClassList.add("displaynone")

                }

                // Copy value of relatedhealthelementid (string) as plan of action's name
                if(_.trim(_.get(summaryForm,"path","")).toLowerCase().indexOf('relatedhealthelementid') > -1 && !!_.trim(_.get(this,"_summaryForm.relatedHealthElementId","")) && !_.trim(_.get(this,"_summaryForm.planOfActionsName",""))) this.set("_summaryForm.planOfActionsName", _.get(_.find(this.activeHealthElements, {id:_.trim(_.get(this,"_summaryForm.relatedHealthElementId",""))}),"descrHr","") )
                if(!_.trim(_.get(this,"_summaryForm.startDate",""))) this.set("_summaryForm.startDate", _.trim(_.get(this,"_selectedPrescriptionObject.date")).substr(0,8))
                if(!_.trim(_.get(this,"_summaryForm.valueDate","")) && !!_.trim(careBeginningDate)) this.set("_summaryForm.valueDate", _.trim(careBeginningDate).substr(0,8))
                if(parseInt(_.get(this,"_summaryForm.numberOfCares","")) === 1 && !!_.trim(numberOfCares)) this.set("_summaryForm.numberOfCares", _.trim(numberOfCares))

                const reqIdx = (this._saveFormReqIdx = (this._saveFormReqIdx || 0) + 1)
                setTimeout(() => {
                    return (reqIdx !== this._saveFormReqIdx || _.trim(_.get(summaryForm,"path","")) === "_summaryForm" || this._triptyqueDetailActiveTab !== "summary" || !_.trim(_.get(this,"_summaryForm.relatedHealthElementId",""))) ? false : promResolve
                        .then(() => Promise.all([
                            this.api.code().findPaginatedCodes('be', "CD-BVT-LATERALITY"),
                            this.api.code().findPaginatedCodes('be', "care.topaz.customTransaction"),
                            this.api.code().findPaginatedCodes('be', this._getConfig("careReasonsCode","CD-INCAPACITYREASON")),
                            this.api.code().findPaginatedCodes('be', this._getConfig("prescriptionTypeCode","care.topaz.kinesitherapyPrescription"))
                        ]))
                        .then(codes => { return {lateralityCodes: _.get(codes,"[0].rows",[]), triptyqueCodes: _.filter(_.get(codes,"[1].rows",[]),{code: "triptyque"}), incapacityCodes: _.get(codes,"[2].rows",[]), prescriptionCodes: _.get(codes,"[3].rows",[]) }} )
                        .then(codes => !_.trim(_.get(this,"_summaryForm.relatedHealthElementId","")) ? ([codes,{}]) : this.api.helement().getHealthElement(_.trim(_.get(this,"_summaryForm.relatedHealthElementId",""))).then(he=>([codes,he])))
                        .then(([codes,he]) => {
                            const lateralityCheckedCodes = _.compact(_.map(_.compact([ (!!_.get(this,"_summaryForm.lateralityLeft",false) ? "left" : false), (!!_.get(this,"_summaryForm.lateralityRight",false) ? "right" : false), (!!_.get(this,"_summaryForm.lateralityCenter",false) ? "odd" : false) ])))
                            const codeKeysToImport = ["id", "code", "version", "type"]
                            return _.merge({},he,{
                                plansOfAction: [{
                                    id: this.api.crypto().randomUuid(),
                                    author: _.trim(_.get(this,"user.id")),
                                    responsible: _.trim(_.get(this,"user.healthcarePartyId")),
                                    openingDate: _.trim(_.get(this,"_summaryForm.startDate","")) ? parseInt(_.trim(_.get(this,"_summaryForm.startDate",""))) : parseInt(moment().format('YYYYMMDDHHmmss')),
                                    closingDate: parseInt(_.trim(_.get(this,"_summaryForm.endDate",""))),
                                    valueDate: parseInt(_.trim(_.get(this,"_summaryForm.valueDate",""))),
                                    endOfLife: parseInt(_.trim(_.get(this,"_summaryForm.careRehearseDate",""))),
                                    name: _.trim(_.get(this,"_summaryForm.planOfActionsName","")),
                                    idOpeningContact: _.trim(_.get(this,"_selectedPrescriptionObject.contact.id","")),
                                    created: +new Date,
                                    modified: +new Date,
                                    codes: _.compact(_.uniqBy(_.filter(_.concat(
                                        _.compact( _.map( codes.lateralityCodes, lateralityCode => lateralityCheckedCodes.indexOf(_.trim(_.get(lateralityCode,"code",""))) > -1 ? _.pick(lateralityCode, codeKeysToImport) : false )),
                                        [_.pick(_.find( _.get(codes,"incapacityCodes",[]), {id:_.trim(_.get(this,"_summaryForm.careReason",""))}), codeKeysToImport)],
                                        [_.pick(_.find( _.get(codes,"prescriptionCodes",[]), {id:_.trim(_.get(this,"_summaryForm.relatedParentPathology",""))}), codeKeysToImport)],
                                        [_.pick(_.find( _.get(codes,"prescriptionCodes",[]), {id:_.trim(_.get(this,"_summaryForm.relatedChildrenPathology",""))}), codeKeysToImport)]
                                    ), i => !!_.size(i)), "id")),
                                    tags: _.filter(_.compact([
                                        _.pick(_.get(codes,"triptyqueCodes",{}), codeKeysToImport),
                                        _.pick(_.find(_.get(this,"_selectedPrescriptionObject.contact.tags",[]),{type:"originalDocumentContactId"}), codeKeysToImport),
                                        _.pick(_.find(_.get(this,"_selectedPrescriptionObject.contact.tags",[]),{type:"originalDocumentId"}), codeKeysToImport),
                                        _.pick(_.find(_.get(this,"_selectedPrescriptionObject.contact.tags",[]),{type:"originalDocumentServiceId"}), codeKeysToImport),
                                        _.pick(_.find(_.get(this,"_selectedPrescriptionObject.contact.tags",[]),{type:"originalDocumentFormId"}), codeKeysToImport),
                                        {type: "idOpeningContactOfContact", id: _.trim(_.get(this,"_selectedPrescriptionObject.contact.id",""))},
                                        {type: "idOpeningContactOfHelement", id: _.trim(_.get(he,"idOpeningContact",""))}
                                    ]), i => !!_.trim(i.id)),
                                    documentIds: _.map(_.get(this,"_summaryForm.insuranceDocuments",[]), d => _.trim(d.documentId)),
                                    prescriberId: _.trim(_.get(this,"_summaryForm.careTeam","")),
                                    numberOfCares: parseInt(_.trim(_.get(this,"_summaryForm.numberOfCares",""))),
                                    status: 0
                                }]
                            })
                        })
                        .then(he => !_.trim(_.get(he,"id","")) ? promResolve : this.api.helement().modifyHealthElement(he).then(he=>this.api.register(he, 'helement')))
                        .then(modifiedHelement=>{

                            // Fabien: garder modifiedHelement dans le composant (attention au reset)
                            console.log("modifiedHelement",modifiedHelement);

                        })

                }, 2000)

            }

            _vaadinGridPageNumberChanged(vaadinGridCurrentPageNumber) {

                console.log("");
                console.log("vaadinGridCurrentPageNumber", vaadinGridCurrentPageNumber);
                console.log("THIS._vaadinGridCurrentPageNumber", this._vaadinGridCurrentPageNumber);

            }

            open(dialogParameters) {

                const promResolve = Promise.resolve();

                return promResolve
                    .then(() => this._resetComponentProperties())
                    .then(() => this._initOpenDialogActions(dialogParameters))
                    .then(() => this._getDialogData())
                    .then(() => this._clearGridCache())
                    .then(() => this._resetGridSelectedItems())
                    .then(() => {

                        this.set('_vaadinGridPageStart', parseInt(((_.get(this,"_vaadinGridCurrentPageNumber",1)-1)||0) * parseInt(this._vaadinGridPlanOfActionMaxItemsPerPage)))
                        this.set('_vaadinGridPageEnd', parseInt((_.get(this,"_vaadinGridCurrentPageNumber",1)||1) * parseInt(this._vaadinGridPlanOfActionMaxItemsPerPage)))
                        this.set('_vaadinGridTotalRecords', _.size(_.get(this,"_dialogData.hesAndPoas",[])))
                        this.set('_vaadinGridTotalPages', Math.ceil(_.get(this,"_vaadinGridTotalRecords",0) / parseInt(this._vaadinGridPlanOfActionMaxItemsPerPage)))
                        this.set("_vaadinGridPlanOfActionDataToShow", _.get(this,"_dialogData.hesAndPoas",[]).slice(parseInt(_.get(this,"_vaadinGridPageStart",0)), parseInt(_.get(this,"_vaadinGridPageEnd",0))))

                        console.log("_vaadinGridPageStart", this._vaadinGridPageStart);
                        console.log("_vaadinGridPageEnd", this._vaadinGridPageEnd);
                        console.log("_vaadinGridTotalRecords", this._vaadinGridTotalRecords);
                        console.log("_vaadinGridTotalPages", this._vaadinGridTotalPages);
                        console.log("_vaadinGridPlanOfActionDataToShow", this._vaadinGridPlanOfActionDataToShow);

                            // {
                            //     id: "1",
                            //     openingDate: "29/06/2019",
                            //     heDescr: "Health element description",
                            //     prescriptionExists: "Juste dire oui / non",
                            //     label: "LibellÃ© du plan (besoin dates ?)",
                            //     prescriber: "Docteur Frankenstein",
                            //     responsibleHr: "Docteur Maboule",
                            //     contactsCount: "2",
                            //     numberOfCares: "7",
                            //     statusHr: "En cours"
                            // }

                        return promResolve

                    })
                    .finally(() => {

                        console.log(this._dialogParameters);
                        console.log(this._dialogData);

                        return this._changeDialogAction("listing")
                            .then(() => this._triggerGridResize())
                            .then(() => this._scrollToTop())
                            .finally(() => this.set("_isLoading", false))

                    })

            }



















            //         FABIEN
            //
            //         -   Bug placement / position dialog triptyque lors ouverture / si dÃ©jÃ  ouvert && si navigate autres onglets
            //         -   Double check tout ok infirmiÃ¨res
            //         -   Target / search / link procedures proprement
            //         -   Ne pas reset toutes les datas lors open / close triptyque -> lÃ  oÃ¹ Ã§a Ã  du sens
            //         -   SSI already existing HE => tout load / comme si just _linkPdfPrescription
            //         -   Menu "..." verticaux + quels actions ?
            //         -   Nice / smart callbacks pour save lors change tab / modify form ?
            //         -   Code gÃ©nÃ©rique pour imprimer tous les forms pdfs Ã  la fois kine & infi
            //         -   Search procedures & packages procÃ©dures smart => coordonner avec travail de Maxime
            //         -   Action reload toutes datas SSI prescription / HE / plan of action existe dÃ©jÃ 
            //                  -   Repasser derriÃ¨re toutes les datas Ã  set (all tabviews & trigger)
            //                  -   Exemple: this.set("_summaryForm.careTeam", _.get(this,"_selectedPrescriptionObject.document.author"))
            //         -   Revoir vaadin grid listing "mode list" + PTP + DP + columns + layout + bouger "Agenda" dans nouvelles tab view interne (une fois prescription liÃ©e) -> du coup revoir mÃ©canique d'approbation de changement de tab
            //         -   Revoir lien avec Mikrono / intÃ©gration
            //         -   Quid gestion sub-forms (dans le cadre des infis) => actuellement pas gÃ©rÃ©
            //         -   Eval number of cares (vaading grid) = nombre de sÃ©ances minus celles dÃ©jÃ  faites


        }

        customElements.define(HtPatTriptyqueDialog.is, HtPatTriptyqueDialog);

    </script>



</dom-module>
