<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="ht-pat-hub-utils.html">

<dom-module id="ht-pat-hub-medication-scheme-extended-view">
    <template>
        <style include="dialog-style atc-styles scrollbar-style">
            paper-dialog {
                width: 90%;
                height: 80%;
            }

            paper-tabs {
                width: 50%;
                max-width: 400px;
                --paper-tabs-selection-bar-color: var(--app-secondary-color);
                /* margin: 0 auto; */
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color);
            }

            .present, .patient {
                height: 100%;
                overflow-y: auto;
                margin-top: 0;
                box-sizing: border-box;
            }

            .table-container {
                margin-bottom: 24px;
            }

            .header {
                background: linear-gradient(to right, var(--app-secondary-color), var(--app-secondary-color-dark));
                color: var(--app-text-color);
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                height: 40px;
                width: 100%;
                padding: 0 12px;
                box-sizing: border-box;
            }

            .header h3 {
                font-size: 14;
                font-weight: 400;
                margin: 0;
            }

            .header iron-icon {
                height: 20px;
                width: 20px;
                margin-right: 4px;
            }

            .table-header {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--app-background-color-dark);
                font-size: 11px;
                color: var(--app-text-color-disabled);
                height: 28px;
            }

            .col {
                height: 100%;
                padding: 0 4px;
                box-sizing: border-box;
                display: flex;
                flex-flow: row wrap;
                justify-content: center;
                align-items: center;
            }

            .col--med {
                width: 30%;
                justify-content: flex-start;
            }

            .med--name {
                font-weight: 500;
                margin-right: 4px;
            }

            .col--photo {
                max-width: 56px;
                min-width: 56px;
                text-align: center;
                flex-grow: 1;
            }

            .col--bef, .col--dur, .col--aft {
                max-width: 56px;
                min-width: 56px;
                text-align: center;
                flex-grow: 1;
            }

            .col--noMoment{
                max-width: 168px;
                min-width: 168px;
                text-align: center;
                flex-grow: 1;
            }

            .dur-pill {
                background: var(--app-secondary-color);
                color: var(--app-text-color);
                font-weight: 500;
                border-radius: 50%;
                padding: 4px;
                display: block;
                height: 12px;
                width: 12px;
                line-height: 1.1;
                text-align: center;
            }

            .col--ed, .col--freq {
                text-align: center;
                width: 12%;
            }

            .col--com {
                width: 40%;
                justify-content: flex-start;
            }

            .table-row {
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                align-items: center;
                font-size: 12px;
                color: var(--app-text-color);
                height: 40px;
            }

            .table-row:nth-child(even) {
                background: var(--app-background-color-light);
            }

            .table-row .col:not(:last-child) {
                border-right: 1px solid var(--app-background-color-dark);
            }

            .general-infos {
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                margin-bottom: 24px;
                background: var(--app-background-color-dark);
                padding: 12px;
                border-radius: 4px;
            }

            .infos-block {
                font-size: 14px;
                font-weight: 400;
                color: var(--app-text-color);
                margin-right: 24px;
            }

            .infos-block > div:first-child{
                margin-bottom: 8px;
            }

            .infos-block span {
                background: var(--app-background-color-light);
                border-radius: 12px;
                font-weight: 500;
                padding: 1px 8px;
                margin-right: 8px;
            }

            /* PRESENT */

            .table {
                display: flex;
                flex-flow: column nowrap;
                font-size: .8rem;
                line-height: 1.5;
                flex: 1 1 auto;
                min-width: 900px;
            }

            .table div{
                box-sizing: border-box;
            }

            .th {
                display: none;
                font-weight: 700;
                background-color: var(--app-background-color- );
            }

            .th:first-child {
                border-top: 1px solid var(--app-background-color-dark);
            }


            .th > .td {
                white-space: nowrap;
                text-overflow: ellipsis;
                justify-content: center;
            }

            .th .td {
                color: var(--app-text-color);
            }

            .th .td:first-child, .tr.category .td:first-child{
                width: 24px;
                max-width: 24px;
                box-sizing: border-box;
                border-right: none;
            }

            .tr {
                position: relative;
                width: 100%;
                display: flex;
                flex-flow: row nowrap;
                color: var(--app-text-color);
                z-index: 1;
                height: 24px;
            }

            .tr:not(.th):not(.category)::after {
                display: block;
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                z-index: 0;
            }

            .tr:not(.td):nth-child(odd)::after {
                opacity: 0.6;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .tr:not(.td):nth-child(even)::after {
                opacity: 0.8;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .tr:not(.td):hover::after {
                opacity: 1;
            }

            .tr.old {
                color: var(--app-text-color-disabled)!important;
            }
            .tr.old::after {
                background: var(--app-background-color-light)!important;
            }

            .tr:not(.category) {
                color: black;
            }

            .odd {
                background-color: var(--app-background-color);
            }

            .td {
                position: relative;
                display: flex;
                flex-flow: row nowrap;
                align-items: center;
                justify-content: center;
                flex-grow: 1;
                flex-basis: 0;
                padding: 6px;
                overflow: hidden;
                min-width: 0px;
                z-index: 2;
                word-break: break-word;
                white-space: nowrap;
                border-right: 1px solid var(--app-background-color-dark);
                font-size: 13px;
            }

            .td span{
                text-overflow: ellipsis;
                width: 100%;
                overflow: hidden;
                text-align: center;
            }

            .td span.left{
                text-align: left;
            }

            .td-input{
                position: relative
            }

            .td iron-input > input{
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                text-align: center;
                width: 100%;
                color: #fff;
                background-color: transparent;
                border: none;
                height: 100%;
                outline: 0;
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .td iron-input > input:focus{
                animation: .24s ease-in forwards inputShadows;
            }

            .td iron-input > input:hover{
                background-color: rgba(0, 0, 0, .2);
                box-shadow: var(--app-shadow-elevation-1);
            }

            @keyframes inputShadows{
                from{ box-shadow: inset 0 0 0 rgba(0, 0, 0, .2); }
                to{ box-shadow: inset 0 0 50px rgba(0, 0, 0, .2); }
            }

            .td:first-child {
                border-left: 1px solid var(--app-background-color-dark);
            }

            .td--comments, .td--medicine, .td--category {
                justify-content: flex-start;
            }

            .td--category iron-icon {
                height: 14px;
                width: 14px;
                margin-right: 4px;
            }

            .th .td, .tr:last-of-type .td {
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .span-2 {
                padding: 6px 13px; /* 13px because we had the padding of the missings .td padding + their borders */
            }

            .span-3 {
                padding: 6px 19px; /* 19px because we had the padding of the missings .td padding + their borders */
            }

            .span-4 {
                padding: 6px 26px; /* 26px because we had the padding of the missings .td padding + their borders */
            }

            .span-5 {
                padding: 6px 31px; /* 31px because we had the padding of the missings .td padding + their borders */
            }

            .table .category {
                border-bottom: 1px solid #d0d0d0;
            }

            .mergeButtons {
                max-width: 50px;
                justify-content: left;
            }

            .mergeLabel {
                font-weight: bold;
                justify-content: left;
            }

            .mergeValue {
                justify-content: left;
            }

            .mergeScore {
                max-width: 50px;
                justify-content: left;
            }

            .reimbursed{
                width: 24px;
                max-width: 24px;
                box-sizing: border-box;
                padding: 0;
                border-right: none!important;
            }

            .reimbursed .reimbursed-status {
                height: 14px;
                width: 14px;
                padding: 2px;
                border-radius: 50%;
                box-shadow: 0 0 0 rgba(0, 0, 0, .2);
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
                z-index: 3;
            }

            .add-period-btn {
                height: 16px;
                width: 16px;
                padding: 0;
                color: var(--app-text-color);
                transition: all .24s cubic-bezier(0.075, 0.82, 0.165, 1);
            }

            .add-period-btn:hover {
                height: 18px;
                width: 18px;
                color: var(--app-secondary-color);
            }


            /* HISTORY */

            .history{
                margin-top: 24px;
            }

            .timeline-header{
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                background: var(--app-background-color-light);
                border: 1px solid var(--app-background-color-dark);
            }

            .timeline div {
                box-sizing: border-box;
            }

            .years-container{
                max-width: calc(24px * 36 + 2px);
                width: calc(24px * 36 + 2px); /* 3 years + borders */
                overflow-x: auto;
                overflow-y: hidden;
                flex-grow: 1;
                display: flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: center;
                border-left: 1px solid var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
                position: relative;
            }

            .year-block{
                height: 48px;
                min-width: calc(24px * 12 + 3px); /* 3 borders */
                text-align: center;
                display:flex;
                flex-flow: row wrap;
                justify-content: space-between;
                align-items: center;
            }

            .year-block:not(:last-child){
                border-right: 1px solid var(--app-background-color-dark);
            }

            .year-block.current{
                font-weight: 500;
            }

            .year{
                width: 100%;
                height: 50%;
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .quarter{
                height: 50%;
                width: calc(24px * 3);
            }

            .quarter:not(:last-child){
                border-right: 1px solid var(--app-background-color-dark);
            }

            .futur-block{
                min-width: calc(24px * 4);
                width: calc(24px * 4);
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                justify-content: center;
            }

            .btn-left, .btn-right{
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                height: 48px;
                width: 10%;
                flex-grow: 1;
            }

            .btn-left{
                justify-content: flex-end;
            }

            .btn-right{
                justify-content: flex-start;
            }

            .medication-category{
                display:flex;
                flex-flow: row nowrap;
                align-items: center;
                justify-content: space-between;
                color: var(--app-text-color);
                font-size: 10px;
                border-bottom: 1px solid var(--app-background-color-dark);
            }

            .medication-category span:first-child{
                width: 10%;
                flex-grow: 1;
                padding-left: 8px;
                display:block;
                height: 100%;
                box-sizing: border-box;
            }

            .medication-category span:nth-child(2){
                max-width: calc(24px * 36 + 2px);
                width: calc(24px * 36 + 2px);
                display:block;
                height: 20px;
                box-sizing: border-box;
                border-left: 1px solid var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
            }

            .medication-category span:last-child{
                width: 10%;
                flex-grow: 1;
                display:block;
                height: 100%;
                box-sizing: border-box;
            }

            .medication-line{
                display: flex;
                flex-flow: row nowrap;
                justify-content: space-between;
                width: 100%;
                align-items: center;
                height: 24px;
            }

            .medication-line:nth-child(even){
                background: #FAFAFA;
            }

            .medication-line .type{
                width: 10%;
                height: 100%;
                text-align: left;
                flex-grow: 1;
                padding-left: 8px;
            }

            .medication-line .extra-info{
                width: 10%;
                flex-grow: 1;
                padding: 0 8px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                height: 100%;
            }

            .medication-line .line-container{
                max-width: calc(24px * 36 + 2px);
                width: calc(24px * 36 + 2px);
                overflow: hidden;
                height: 24px;
                border-left: 1px solid var(--app-background-color-dark);
                border-right: 1px solid var(--app-background-color-dark);
            }

            .medication-line .line{
                display: flex;
                box-sizing: unset;
                position: absolute;
                color: #fff;
                border-radius: 2px;
                top: 0;
                left: 0;
                height: 100%;
                flex-flow: row wrap;
                align-items: center;
                justify-content: space-between;
                margin: 1px 0;
            }

            .medication-line .line::after{
                position: absolute;
                height: 100%;
                width: 100%;
                display: block;
                content:'';
                z-index: 0;
            }

            .medication-line .line.over{
                opacity: 0.6;
            }

            .line-total-width{
                position: relative;
                height: 100%;
            }

            .medication-line .line .name{
                text-align: left;
                margin-left: 4px;
                margin-bottom: 4px;
                z-index: 1;
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                padding-right: 4px;
            }

            .medication-line .line .until{
                text-align: right;
                margin-right: 4px;
                margin-bottom: 4px;
                z-index: 1;
            }

            .medication-line .reimbursement-line{
                display: block;
                position: absolute;
                width: 100%;
                background: var(--app-status-color-ok);
                height: 4px;
                bottom: 0;
                transition: all .12s cubic-bezier(0.075, 0.82, 0.165, 1);
                cursor: pointer;
                overflow: visible;
            }

            .medication-line .reimbursement-line:hover{
                height: 6px;
            }

            paper-tooltip{
                --paper-tooltip: {
                    position: fixed;
                    z-index: 900;
                    width: auto;
                    left: 50%;
                    top: calc(10% + 24px);
                    transform: translate(-50%, -50%);
                    box-sizing: border-box;
                }
            }

            .medIcon{
                height: 28px;
                width: 28px;
            }

            .content{
                padding: 0;
            }

            .chronicIcon{
                height: 12px;
                width: 12px;
            }

            .suspensionIcon{
                height: 12px;
                width: 12px;
                color: var(--app-status-color-pending)
            }

            .compoundIcon{
                height: 12px;
                width: 12px;
                color: #2882ff;
            }

            .substanceIcon{
                height: 12px;
                width: 12px;
                color: #c62ac4;
            }

            .legend-chronicIcon{
                height: 18px;
                width: 18px;
            }

            .legend-suspensionIcon{
                height: 18px;
                width: 18px;
                color: var(--app-status-color-pending)
            }

            .oneShotIcon{
                height: 12px;
                width: 12px;
                color: #c60b44;
            }

            .legend-oneShotIcon{
                height: 18px;
                width: 18px;
                color: #c60b44;
            }

            .legend-compoundIcon{
                height: 14px;
                width: 14px;
                color: #2882ff;
            }

            .legend-substanceIcon{
                height: 14px;
                width: 14px;
                color: #c62ac4;
            }

            .legend-line{
                margin-right: 8px;
                font-size: var(--font-size-normal);
            }

            #legend {
                background: var(--app-background-color);
                border-radius: 4px;
                padding: 4px;
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 12px;
            }

            .bold{
                font-weight: bold;
            }

            paper-tooltip{
                --paper-tooltip-delay-in:100;
                display: inline-block;
                position: absolute;
            }

            #medicationDetailDialog{
                height: 500px;
                width: 900px;
            }

            .modal-title{
                background:  var(--app-background-color-dark);
                margin-top: 0;
                padding-left: 24px;
            }

            .buttons{
                position: absolute;
                right: 0;
                bottom: 0;
            }

            .medicationDetailDialogContent{
                height: 400px;
                width: auto;
                overflow: auto;
            }

            .medicationMergeDialogContent{
                height: 400px;
                width: auto;
                overflow: auto;
            }

            .medication-detail-line{
                display: flex;
            }


            .flex{
                display: flex;
            }

            .pointer{
                cursor: pointer;
            }

            .suspension-info{
                margin-top: 5px;
            }

            .morningIcon{
                height: 18px;
                width: 18px;
            }

            .moonIcon{
                height: 12px;
                width: 12px;
            }

            .posologyBlock{
                padding: 4px;
            }


            .regimen-container{
                margin-bottom: 12px;
            }

            .headerMasterTitle{
                font-size: var(--font-size-large);
                background: var(--app-background-color-dark);
                padding: 0 12px;
                box-sizing: border-box;
            }

            .headerLabel{
                font-weight: bold;
            }

            .headerInfo{
                height: auto;
                width: 100%;
                box-sizing: border-box;
                padding: 4px;
                border: 1px solid var(--app-background-color-dark);
            }

            .contentMedDia{
                height: 100%;
                position: relative;
                background: white;
                margin: 0;
            }

            .pres-icon{
                height: 14px;
                width: 14px;
            }


        </style>

        <div class="content">
            <div id="legend">
                <span class="legend-line bold">[[localize('legend', 'Legend', language)]]: </span>
                <span class="legend-line"><iron-icon class="legend-chronicIcon" icon="icons:alarm-on"></iron-icon> [[localize('hub-chron-med', 'Chronic medication', language)]]</span>
                <span class="legend-line"><iron-icon class="legend-oneShotIcon" icon="vaadin:thumbs-up-o"></iron-icon> [[localize('hub-one-shot', 'One shot', language)]]</span>
                <span class="legend-line"><iron-icon class="legend-suspensionIcon" icon="icons:warning"></iron-icon> [[localize('hub-sus-med', 'Suspended medication', language)]]</span>
                <span class="legend-line"><iron-icon class="legend-compoundIcon" icon="vaadin:flask"></iron-icon> [[localize('hub-med-mag', 'Compound prescription', language)]]</span>
                <span class="legend-line"><iron-icon class="legend-substanceIcon" icon="vaadin:pill"></iron-icon> [[localize('hub-med-dci', 'DCI prescription', language)]]</span>
            </div>
            <div class="present">
                <div class="table">
                    <div class="tr th">
                        <div class="td reimbursed">

                        </div>
                        <div class="td span-5"
                             style="flex-grow: 5;">

                        </div>
                        <div class="td span-3" style="flex-grow: 3;">

                        </div>
                        <div class="td" style="flex-grow: 1;">

                        </div>
                        <div class="td span-3" style="flex-grow: 3;">
                            <span>[[localize('mom_break','Breakfast',language)]]</span>
                        </div>
                        <div class="td" style="flex-grow: 1;">

                        </div>
                        <div class="td span-3" style="flex-grow: 3;">
                            <span>[[localize('mom_lunch','Lunch',language)]]</span>
                        </div>
                        <div class="td" style="flex-grow: 1;">

                        </div>
                        <div class="td span-3" style="flex-grow: 3;">
                            <span>[[localize('mom_dinner','Dinner',language)]]</span>
                        </div>
                        <div class="td" style="flex-grow: 1;">

                        </div>
                        <template is="dom-repeat" items="[[currentMedicationScheme.times]]" as="timeSlot">
                            <div class="td"></div>
                        </template>
                        <div class="td span-4" style="flex-grow: 4;">

                        </div>
                        <div class="td span-4" style="flex-grow: 4;">

                        </div>
                        <div class="td span-4" style="flex-grow: 3;">

                        </div>
                    </div>
                    <div class="tr th">
                        <div class="td reimbursed">

                        </div>
                        <div class="td td--medicine span-5"
                             style="flex-grow: 5; justify-content: flex-start">
                            <span class="left">[[localize('medic','Medicine',language)]]</span>
                        </div>
                        <div class="td span-3" style="flex-grow: 3;">
                            <span>[[localize('freq','Frequency',language)]]</span>
                        </div>
                        <div class="td bf-bef">
                            <span><iron-icon icon="vaadin:morning" class="morningIcon"></iron-icon></span>
                        </div>
                        <div class="td bf-bef">
                            <span>[[localize('mom_before_short','Be',language)]]</span>
                        </div>
                        <div class="td bf-dur">
                            <span>[[localize('mom_during_short','Du',language)]]</span>
                        </div>
                        <div class="td bf-aft">
                            <span>[[localize('mom_after_short','Af',language)]]</span>
                        </div>
                        <div class="td bf-bef">
                            <span>10h</span>
                        </div>
                        <div class="td lu-bef">
                            <span>[[localize('mom_before_short','Be',language)]]</span>
                        </div>
                        <div class="td lu-dur">
                            <span>[[localize('mom_during_short','Du',language)]]</span>
                        </div>
                        <div class="td lu-aft">
                            <span>[[localize('mom_after_short','Af',language)]]</span>
                        </div>
                        <div class="td bf-bef">
                            <span>16h</span>
                        </div>
                        <div class="td di-bef">
                            <span>[[localize('mom_before_short','Be',language)]]</span>
                        </div>
                        <div class="td di-dur">
                            <span>[[localize('mom_during_short','Du',language)]]</span>
                        </div>
                        <div class="td di-aft">
                            <span>[[localize('mom_after_short','Af',language)]]</span>
                        </div>
                        <div class="td bf-bef">
                            <span><iron-icon icon="vaadin:moon-o" class="moonIcon"></iron-icon></span>
                        </div>
                        <template is="dom-repeat" items="[[currentMedicationScheme.times]]" as="timeSlot">
                            <div class="td">
                                <span>[[_getTimeDesc(timeSlot)]]</span>
                            </div>
                        </template>
                        <div class="td span-2" style="flex-grow: 2;">
                            <span>[[localize('start-date-short','Start',language)]]</span>
                        </div>
                        <div class="td span-2" style="flex-grow: 2;">
                            <span>[[localize('endDate-short','End',language)]]</span>
                        </div>
                        <div class="td td-comments span-4" style="flex-grow: 4; justify-content: space-between;">
                            <span class="left">[[localize('com','Comments',language)]]</span>
                        </div>
                        <div class="td di-aft">Topaz</div>
                        <div class="td di-aft">Hub</div>
                        <div class="td di-aft">Action</div>
                    </div>
                    <!-- END HEADER -->
                    <!-- START BODY -->

                    <template is="dom-repeat" id="medicationScheme" items="[[_getMedElems(currentMedicationScheme, currentMedicationScheme.*, currentMedicationScheme.msElems.synchronizationInfo.*, refresher)]]" as="medicationsWithPosology">
                        <div class$="tr [[_medicationClass(medicationsWithPosology)]] pointer" data-uid$="[[medicationsWithPosology.uniqId]]" data-medication$=[[medicationsWithPosology]] on-tap="_showMedication">
                            <div class="td reimbursed">
                                <template is="dom-if" if="[[_isChronic(medicationsWithPosology)]]">
                                    <iron-icon class="chronicIcon" icon="icons:alarm-on"></iron-icon>
                                </template>
                                <template is="dom-if" if="[[_isOneShot(medicationsWithPosology)]]">
                                    <iron-icon class="oneShotIcon" icon="vaadin:thumbs-up-o"></iron-icon>
                                </template>
                                <template is="dom-if" if="[[_isSuspensions(medicationsWithPosology)]]">
                                    <iron-icon class="suspensionIcon" title="[[_getReasonOfSuspension(medicationsWithPosology)]]" icon="icons:warning"></iron-icon>
                                </template>
                                <template is="dom-if" if="[[_isCompoundPrescription(medicationsWithPosology.compoundprescription)]]">
                                    <iron-icon class="compoundIcon" icon="vaadin:flask"></iron-icon>
                                </template>
                                <template is="dom-if" if="[[_isSubstancePrescription(medicationsWithPosology.substanceproduct)]]">
                                    <iron-icon class="substanceIcon" icon="vaadin:pill"></iron-icon>
                                </template>
                            </div>
                            <div class="td td--medicine span-5" style="flex-grow: 5;">
                                <span class="left">
                                    <iron-icon icon="vaadin:user" class="chronicIcon" title="[[_getResponsibleHcp(medicationsWithPosology.authors)]]"></iron-icon>
                                    <span title="[[_getMedicationName(medicationsWithPosology)]]">[[_getMedicationName(medicationsWithPosology)]]</span>
                                </span>
                            </div>
                            <div class="td span-3" style="flex-grow: 3;" title="[[_getPosology(medicationsWithPosology)]] [[_getDayInfo(medicationsWithPosology.regimen.0)]]"><span>[[_getPosology(medicationsWithPosology)]] [[_getDayInfo(medicationsWithPosology.regimen.0)]]</span></div>
                            <template is="dom-repeat" items="" as="regimen">
                                <div class="td td-input bf-bef">
                                    <span></span>
                                </div>
                            </template>
                            <div class="td td-input di-aft">[[_getRegimen(medicationsWithPosology.regimen.0, 0)]]</div>
                            <div class="td td-input bf-bef">[[_getRegimen(medicationsWithPosology.regimen.0, 1)]]</div>
                            <div class="td td-input bf-dur">[[_getRegimen(medicationsWithPosology.regimen.0, 2)]]</div>
                            <div class="td td-input bf-aft">[[_getRegimen(medicationsWithPosology.regimen.0, 3)]]</div>
                            <template is="dom-repeat" items="" as="regimen">
                                <div class="td td-input bf-bef">
                                    <span></span>
                                </div>
                            </template>
                            <div class="td td-input di-aft">[[_getRegimen(medicationsWithPosology.regimen.0, 4)]]</div>
                            <div class="td td-input lu-bef">[[_getRegimen(medicationsWithPosology.regimen.0, 5)]]</div>
                            <div class="td td-input lu-dur">[[_getRegimen(medicationsWithPosology.regimen.0, 6)]]</div>
                            <div class="td td-input lu-aft">[[_getRegimen(medicationsWithPosology.regimen.0, 7)]]</div>
                            <div class="td td-input di-aft">[[_getRegimen(medicationsWithPosology.regimen.0, 8)]]</div>
                            <template is="dom-repeat" items="" as="regimen">
                                <div class="td td-input bf-bef">
                                    <span></span>
                                </div>
                            </template>
                            <div class="td td-input di-bef">[[_getRegimen(medicationsWithPosology.regimen.0, 9)]]</div>
                            <div class="td td-input di-dur">[[_getRegimen(medicationsWithPosology.regimen.0, 10)]]</div>
                            <div class="td td-input di-aft">[[_getRegimen(medicationsWithPosology.regimen.0, 11)]]</div>
                            <div class="td td-input di-aft">[[_getRegimen(medicationsWithPosology.regimen.0, 12)]]</div>
                            <template is="dom-repeat" items="" as="regimen">
                                <div class="td td-input bf-bef">
                                    <span></span>
                                </div>
                            </template>
                            <template is="dom-repeat" items="[[currentMedicationScheme.times]]" as="timeSlot">
                                <div class="td td-input">
                                    <span>[[_getRegimen(medicationsWithPosology.regimen.0, timeSlot)]]</span>
                                </div>
                            </template>
                            <div class="td span-2" style="flex-grow: 2;" title="[[medicationsWithPosology.beginmoment]]"><span>[[medicationsWithPosology.beginmoment]]</span></div>
                            <div class="td span-2" style="flex-grow: 2;" title="[[medicationsWithPosology.endmoment]]"><span>[[medicationsWithPosology.endmoment]]</span></div>
                            <div class="td td--comments span-4" style="flex-grow: 4;" title="[[_getComment(medicationsWithPosology)]]"><span class="left">[[_getComment(medicationsWithPosology)]]</span></div>

                            <template is="dom-if" if="[[medicationsWithPosology.synchronizationInfo.availableOnLocal]]">
                                <div class="td td-input di-aft" on-tap="_stopPropagation">
                                    <vaadin-checkbox checked="true" disabled="true"></vaadin-checkbox>
                                </div>
                            </template>
                            <template is="dom-if" if="[[!medicationsWithPosology.synchronizationInfo.availableOnLocal]]">
                                <div class="td td-input di-aft">
                                    <vaadin-checkbox data-item="[[medicationsWithPosology]]" on-tap="_synchronizeItemToLocal"></vaadin-checkbox>
                                </div>
                            </template>

                            <template is="dom-if" if="[[medicationsWithPosology.synchronizationInfo.availableOnHub]]">
                                <div class="td td-input di-aft" on-tap="_stopPropagation">
                                    <vaadin-checkbox checked="true" disabled="true"></vaadin-checkbox>
                                </div>
                            </template>
                            <template is="dom-if" if="[[!medicationsWithPosology.synchronizationInfo.availableOnHub]]">
                                <div class="td td-input di-aft">
                                    <vaadin-checkbox data-item="[[medicationsWithPosology]]" on-tap="_synchronizeItemToHub"></vaadin-checkbox>
                                </div>
                            </template>
                            <div class="td td-input di-aft"></div>
                        </div>
                        <template is="dom-repeat" items="[[_getOtherRegimen(medicationsWithPosology.regimen)]]" as="reg">
                            <div class$="tr [[_medicationClass(reg)]] pointer" data-medication$=[[medicationsWithPosology]] on-tap="_showMedication">
                                <div class="td reimbursed">

                                </div>
                                <div class="td td--medicine span-5" style="flex-grow: 5;">
                                    <span class="left"></span>
                                </div>
                                <div class="td span-3" style="flex-grow: 3;" title="[[_getDayInfo(reg)]]"><span>[[_getDayInfo(reg)]]</span></div>
                                <template is="dom-repeat" items="" as="regimen">
                                    <div class="td td-input bf-bef">
                                        <span></span>
                                    </div>
                                </template>
                                <div class="td td-input di-aft">[[_getRegimen(reg, 0)]]</div>
                                <div class="td td-input bf-bef">[[_getRegimen(reg, 1)]]</div>
                                <div class="td td-input bf-dur">[[_getRegimen(reg, 2)]]</div>
                                <div class="td td-input bf-aft">[[_getRegimen(reg, 3)]]</div>
                                <template is="dom-repeat" items="" as="regimen">
                                    <div class="td td-input bf-bef">
                                        <span></span>
                                    </div>
                                </template>
                                <div class="td td-input di-aft">[[_getRegimen(reg, 4)]]</div>
                                <div class="td td-input lu-bef">[[_getRegimen(reg, 5)]]</div>
                                <div class="td td-input lu-dur">[[_getRegimen(reg, 6)]]</div>
                                <div class="td td-input lu-aft">[[_getRegimen(reg, 7)]]</div>
                                <div class="td td-input di-aft">[[_getRegimen(reg, 8)]]</div>
                                <template is="dom-repeat" items="" as="regimen">
                                    <div class="td td-input bf-bef">
                                        <span></span>
                                    </div>
                                </template>
                                <div class="td td-input di-bef">[[_getRegimen(reg, 9)]]</div>
                                <div class="td td-input di-dur">[[_getRegimen(reg, 10)]]</div>
                                <div class="td td-input di-aft">[[_getRegimen(reg, 11)]]</div>
                                <div class="td td-input di-aft">[[_getRegimen(reg, 12)]]</div>
                                <template is="dom-repeat" items="" as="regimen">
                                    <div class="td td-input bf-bef">
                                        <span></span>
                                    </div>
                                </template>
                                <template is="dom-repeat" items="[[currentMedicationScheme.times]]" as="timeSlot">
                                    <div class="td td-input">
                                        <span>[[_getRegimen(reg, timeSlot)]]</span>
                                    </div>
                                </template>
                                <div class="td span-2" style="flex-grow: 2;"><span></span></div>
                                <div class="td span-2" style="flex-grow: 2;"><span></span></div>
                                <div class="td td--comments span-4" style="flex-grow: 4;"><span class="left"></span></div>
                                <div class="td td-input di-aft"></div>
                                <div class="td td-input di-aft"></div>
                                <div class="td td-input di-aft"></div>
                            </div>
                        </template>
                    </template>
                </div>
                <!-- END BODY -->
                <!-- END TABLE -->
            </div>


        </div>

        <paper-dialog id="medicationDetailDialog" on-iron-overlay-closed="_closeMedicationDetailDialog">
            <div class="contentMedDia">
                <div class="modal-title">
                    [[_getMedicationName(selectedMedication)]]
                    <template is="dom-if" if="[[_isChronic(selectedMedication)]]">
                        <div>
                            <iron-icon class="legend-chronicIcon" icon="icons:alarm-on"></iron-icon> [[localize('hub-chron-med', 'Chronic medication', language)]]
                        </div>
                    </template>
                    <template is="dom-if" if="[[_isOneShot(selectedMedication)]]">
                        <div>
                            <iron-icon class="oneShotIcon" icon="vaadin:thumbs-up-o"></iron-icon> [[localize('hub-one-shot', 'One shot', language)]]
                        </div>
                    </template>
                    <template is="dom-if" if="[[_isSuspensions(selectedMedication)]]">
                        <div>
                            <iron-icon class="legend-suspensionIcon" icon="icons:warning"></iron-icon> [[localize('hub-sus-med', 'Suspended medication', language)]]
                        </div>
                    </template>
                    <template is="dom-if" if="[[_isCompoundPrescription(selectedMedication.compoundprescription)]]">
                        <div>
                            <iron-icon class="legend-compoundIcon" icon="vaadin:flask"></iron-icon> [[localize('hub-med-mag', 'Compound prescription', language)]]
                        </div>
                    </template>
                    <template is="dom-if" if="[[_isSubstancePrescription(selectedMedication.substanceproduct)]]">
                        <div>
                            <iron-icon class="legend-substanceIcon" icon="vaadin:pill"></iron-icon> [[localize('hub-med-dci', 'DCI prescription', language)]]
                        </div>
                    </template>
                </div>
                <div class="medicationDetailDialogContent">

                    <div class="regimen-container">
                        <div class="headerMasterTitle headerLabel">[[localize('hub-med-trt-date', 'Treatment date', language)]]</div>
                        <div class="headerInfo">
                            [[selectedMedication.beginmoment]] au [[selectedMedication.endmoment]]
                        </div>
                    </div>

                    <template is="dom-if" if="[[selectedMedication.usePresent]]">
                        <div class="regimen-container">
                            <div class="headerMasterTitle headerLabel">[[localize('hub-med-use', 'Medication use', language)]]</div>
                            <div class="headerInfo">
                                [[_getMedicationUse(selectedMedication.useTexts)]]
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="[[_isCompoundPrescription(selectedMedication.compoundprescription)]]">
                        <div class="regimen-container">
                            <div class="headerMasterTitle headerLabel">[[localize('des', 'Description', language)]]</div>
                            <div class="headerInfo">
                                <template is="dom-repeat" items="[[selectedMedication.compoundprescription.magistraltext]]" as="magistralText">
                                    <div>
                                        [[magistralText.value]]
                                    </div>
                                </template>
                                <template is="dom-repeat" items="[[selectedMedication.compoundprescription.mixedContent]]" as="content">
                                    <div>
                                        [[content]]
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="[[selectedMedication.regimen]]">
                        <div class="regimen-container">
                            <div class="headerMasterTitle headerLabel">[[localize('pos', 'Posology', language)]]</div>
                            <div class="headerInfo">
                                <template is="dom-repeat" items="[[selectedMedication.regimen]]" as="regimens">
                                    <div>
                                        <template is="dom-repeat" items="[[regimens]]" as="reg">
                                            [[_getRegimenAsText(reg)]]
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="[[_isSuspensions(selectedMedication)]]">
                        <template is="dom-repeat" items="[[selectedMedication.suspensions]]" as="sus">
                            <div class="regimen-container">
                                <div class="headerMasterTitle headerLabel">[[localize('Suspension','Suspension',language)]] [[sus.beginmoment]] au [[sus.endmoment]]</div>
                                <div class="headerInfo">
                                    <div>
                                        [[_getReasonOfSuspensionForDialog(sus)]]
                                    </div>
                                </div>
                            </div>
                        </template>
                    </template>

                    <template is="dom-if" if="[[_getComment(selectedMedication)]]">
                        <div class="regimen-container">
                            <div class="headerMasterTitle headerLabel">[[localize('com','Comment',language)]]</div>
                            <div class="headerInfo">
                                [[_getComment(selectedMedication)]]
                            </div>
                        </div>
                    </template>

                    <div class="table">
                        <template is="dom-repeat" items="[[candidates]]" as="candidate">
                            <div class="tr">
                                <div class="td mergeButtons"><paper-icon-button data-uid$="[[candidate.medication.uniqId]]" on-tap="_compare" icon="icons:compare-arrows"></paper-icon-button></div>
                                <div class="td mergeScore">[[candidate.score]]</div>
                                <div class="td mergeValue">[[_getMedicationName(candidate.medication)]]</div>
                            </div>
                        </template>
                    </div>

                </div>
                <div class="buttons">
                    <paper-button class="button button--other" on-tap="_closeMedicationDetailDialog">[[localize('clo','Close',language)]]</paper-button>
                </div>
            </div>
        </paper-dialog>

        <paper-dialog id="medicationMergeDialog" on-iron-overlay-closed="_closeMedicationMergeDialog">
            <h2 class="modal-title">
                [[_getMedicationName(source)]]
                <template is="dom-if" if="[[_isChronic(source)]]">
                    <div>
                        <iron-icon class="legend-chronicIcon" icon="icons:alarm-on"></iron-icon> [[localize('hub-chron-med', 'Chronic medication', language)]]
                    </div>
                </template>
                <template is="dom-if" if="[[_isOneShot(source)]]">
                    <div>
                        <iron-icon class="oneShotIcon" icon="vaadin:thumbs-up-o"></iron-icon> [[localize('hub-one-shot', 'One shot', language)]]
                    </div>
                </template>
                <template is="dom-if" if="[[_isSuspensions(source)]]">
                    <div>
                        <iron-icon class="legend-suspensionIcon" icon="icons:warning"></iron-icon> [[localize('hub-sus-med', 'Suspended medication', language)]]
                    </div>
                </template>
                <template is="dom-if" if="[[_isCompoundPrescription(source.compoundprescription)]]">
                    <div>
                        <iron-icon class="legend-compoundIcon" icon="vaadin:flask"></iron-icon> [[localize('hub-med-mag', 'Compound prescription', language)]]
                    </div>
                </template>
                <template is="dom-if" if="[[_isSubstancePrescription(source.substanceproduct)]]">
                    <div>
                        <iron-icon class="legend-substanceIcon" icon="vaadin:pill"></iron-icon> [[localize('hub-med-dci', 'DCI prescription', language)]]
                    </div>
                </template>
            </h2>
            <div class="content">
                <div class="table">
                    <template id="fields" is="dom-repeat" items="[[fields]]" as="field">
                        <template is="dom-if" if="[[!field.hidden]]">
                            <div class="tr"><div class="td mergeLabel">[[field.label]]</div></div>
                            <div class="tr">
                                <div class="td mergeButtons"><vaadin-checkbox id="{{field.name}}" checked="[[_isChecked(field, refresher)]]" on-tap="_check"></vaadin-checkbox></div>
                                <div class="td mergeValue">[[_getValue(field.source, refresher)]]</div>
                            </div>
                            <div class="tr">
                                <div class="td mergeButtons"><vaadin-checkbox id="{{field.name}}" checked="[[!_isChecked(field, refresher)]]" on-tap="_uncheck"></vaadin-checkbox></div>
                                <div class="td mergeValue">[[_getValue(field.target, refresher)]]</div>
                            </div>
                        </template>
                    </template>
                </div>
            </div>
            <div class="buttons">
                <paper-button class="button button--other" on-tap="_merge">[[localize('Merge','Merge',language)]]</paper-button>
                <paper-button class="button button--other" on-tap="_closeMedicationMergeDialog">[[localize('clo','Close',language)]]</paper-button>
            </div>
        </paper-dialog>

        <ht-pat-hub-utils id="htPatHubUtils" api="[[api]]" user="[[user]]" language="[[language]]" patient="[[patient]]" i18n="[[i18n]]" current-contact="[[currentContact]]" i18n="[[i18n]]" resources="[[resources]]" on-hub-download="_hubDownload" on-close-hub-dialog="_closeOverlay"></ht-pat-hub-utils>
    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';
        import hu from "../../../../../bower_components/moment/src/locale/hu";
        const md5 = require('md5');

        const all_fields = [
            { label: 'medicationName', getter: '_getMedicationName', score: 82, hidden: true },
            { label: 'beginmoment', name: 'beginmoment', score: 1 },
            { label: 'endmoment', name: 'endmoment', score: 1 },
            { label: 'temporality', name: 'temporality', score: 1 },
            { label: 'frequency', name: 'frequency', score: 1, format: '_formatFrequency' },
            { label: 'posology', name: 'posology', score: 1, format: '_formatPosology' },
            { label: 'ms_morning', name: 'regimen.0', score: 1, filter: '_filterRegimen', argument: 0, path: 'quantity', defaultValue: 0 },
            { label: 'ms_beforebreakfast', name: 'regimen.0', score: 1, filter: '_filterRegimen', argument: 1, path: 'quantity', defaultValue: 0 },
            { label: 'ms_duringbreakfast', name: 'regimen.0', score: 1, filter: '_filterRegimen', argument: 2, path: 'quantity', defaultValue: 0 },
            { label: 'ms_afterbreakfast', name: 'regimen.0', score: 1, filter: '_filterRegimen', argument: 3, path: 'quantity', defaultValue: 0 },
            { label: 'ms_betweenbreakfastandlunch', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 4, path: 'quantity', defaultValue: 0 },
            { label: 'ms_beforelunch', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 5, path: 'quantity', defaultValue: 0 },
            { label: 'ms_duringlunch', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 6, path: 'quantity', defaultValue: 0 },
            { label: 'ms_afterlunch', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 7, path: 'quantity', defaultValue: 0 },
            { label: 'ms_betweenlunchanddinner', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 8, path: 'quantity', defaultValue: 0 },
            { label: 'ms_beforedinner', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 9, path: 'quantity', defaultValue: 0 },
            { label: 'ms_duringdinner', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 10, path: 'quantity', defaultValue: 0 },
            { label: 'ms_afterdinner', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 11, path: 'quantity', defaultValue: 0 },
            { label: 'ms_evening', name: 'regimen.0', score: 1,  filter: '_filterRegimen', argument: 12, path: 'quantity', defaultValue: 0 },
        ]

        const all_periods = [
            { id: 0, keywords: ['morning'] },
            { id: 1, keywords: ['beforebreakfast'] },
            { id: 2, keywords: ['duringbreakfast'] },
            { id: 3, keywords: ['afterbreakfast'] },
            { id: 4, keywords: ['betweenbreakfastandlunch'] },
            { id: 5, keywords: ['beforelunch'] },
            { id: 6, keywords: ['duringlunch'] },
            { id: 7, keywords: ['afterlunch'] },
            { id: 8, keywords: ['betweenlunchanddinner'] },
            { id: 9, keywords: ['beforedinner'] },
            { id: 10, keywords: ['duringdinner'] },
            { id: 11, keywords: ['afterdinner'] },
            { id: 12, keywords: ['evening', 'night', 'thehourofsleep'] },
        ]

        class HtPatHubMedicationSchemeExtendedView extends Polymer.TkLocalizerMixin(Polymer.Element) {
            static get is() {
                return 'ht-pat-hub-medication-scheme-extended-view';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient:{
                        type: Object
                    },
                    language: {
                        type: String
                    },
                    medicationScheme:{
                       type: Array,
                       value: () => []
                    },
                    currentMedicationScheme:{
                        type: Object,
                        value: () => {}
                    },
                    candidates:{
                        type: Array,
                        value: () => []
                    },
                    refresher: {
                        type: Number,
                        value: 0
                    },
                    source: {
                        type: Object,
                        value: () => {}
                    },
                    target: {
                        type: Object,
                        value: () => {}
                    },
                    fields:{
                        type: Object,
                        value: () => []
                    },
                    periodicity:{
                        type: Object,
                        value: [
                            {code : 'D', label: {fr:'/jour', en: '', nl: '/dag'}},
                            {code : 'DA', label: {fr:'/8 jours', en: '', nl: '/8 dagen'}},
                            {code : 'DD', label: {fr:'/3 jours', en: '', nl: '/3 dagen'}},
                            {code : 'DE', label: {fr:'/11 jours', en: '', nl: '/11 dagen'}},
                            {code : 'DN', label: {fr:'/9 jours', en: '', nl: '/9 dagen'}},
                            {code : 'DQ', label: {fr:'/5 jours', en: '', nl: '/5 dagen'}},
                            {code : 'DT', label: {fr:'/2 jours', en: '', nl: '/2 dagen'}},
                            {code : 'DV', label: {fr:'/4 jours', en: '', nl: '/4 dagen'}},
                            {code : 'DW', label: {fr:'/12 jours', en: '', nl: '/12 dagen'}},
                            {code : 'DX', label: {fr:'/10 jours', en: '', nl: '/10 dagen'}},
                            {code : 'DZ', label: {fr:'/6 jours', en: '', nl: '/6 dagen'}},
                            {code : 'J', label: {fr:'/an', en: '', nl: '/jaar'}},
                            {code : 'JD', label: {fr:'/3 ans', en: '', nl: '/3 jaar'}},
                            {code : 'JH2', label: {fr:'/6 mois', en: '', nl: '/6 maand'}},
                            {code : 'JQ', label: {fr:'/5 ans', en: '', nl: '/5 jaar'}},
                            {code : 'JT', label: {fr:'/2 ans', en: '', nl: '/2 jaar'}},
                            {code : 'JV', label: {fr:'/4 ans', en: '', nl: '/4 jaar'}},
                            {code : 'JZ', label: {fr:'/6 ans', en: '', nl: '/6 jaar'}},
                            {code : 'M', label: {fr:'/mois', en: '', nl: '/maand'}},
                            {code : 'MA', label: {fr:'/8 mois', en: '', nl: '/8 maand'}},
                            {code : 'MC', label: {fr:'/18 mois', en: '', nl: '/18 maand'}},
                            {code : 'MD', label: {fr:'/3 mois', en: '', nl: '/3 maand'}},
                            {code : 'ME', label: {fr:'/11 mois', en: '', nl: '/11 maand'}},
                            {code : 'MN', label: {fr:'/9 mois', en: '', nl: '/9 maand'}},
                            {code : 'MQ', label: {fr:'/5 mois', en: '', nl: '/5 maand'}},
                            {code : 'MS', label: {fr:'/7 mois', en: '', nl: '/7 maand'}},
                            {code : 'MT', label: {fr:'/2 mois', en: '', nl: '/2 maand'}},
                            {code : 'MV', label: {fr:'/4 mois', en: '', nl: '/4 maand'}},
                            {code : 'MX', label: {fr:'/10 mois', en: '', nl: '/10 maand'}},
                            {code : 'MZ2', label: {fr:'/6 mois', en: '', nl: '/6 maand'}},
                            {code : 'O1', label: {fr:'Tout les 2 jours', en: '', nl: '/elke 2 dagen'}},
                            {code : 'ondemand', label: {fr:'Sur demande', en: '', nl: 'Op vraag'}},
                            {code : 'U', label: {fr:'/heure', en: '', nl: '/u'}},
                            {code : 'UA', label: {fr:'/8 heures', en: '', nl: '/8 u'}},
                            {code : 'UD', label: {fr:'/3 heures', en: '', nl: '/3 u'}},
                            {code : 'UE', label: {fr:'/11 heures', en: '', nl: '/11 u'}},
                            {code : 'UH', label: {fr:'/demi-heure', en: '', nl: '/30 min'}},
                            {code : 'UN', label: {fr:'/9 heures', en: '', nl: '/9 u'}},
                            {code : 'UQ', label: {fr:'/5 heures', en: '', nl: '/5 u'}},
                            {code : 'US', label: {fr:'/7 heures', en: '', nl: '/7 u'}},
                            {code : 'UT', label: {fr:'/2 heures', en: '', nl: '/2 u'}},
                            {code : 'UV', label: {fr:'/4 heures', en: '', nl: '/4 u'}},
                            {code : 'UW', label: {fr:'/12 heures', en: '', nl: '/12 u'}},
                            {code : 'UX', label: {fr:'/10 heures', en: '', nl: '/10 u'}},
                            {code : 'UZ', label: {fr:'/6 heures', en: '', nl: '/6 u'}},
                            {code : 'W', label: {fr:'/semaine', en: '', nl: '/week'}},
                            {code : 'WA', label: {fr:'/8 semaines', en: '', nl: '/8 weken'}},
                            {code : 'WD', label: {fr:'/3 semaines', en: '', nl: '/3 weken'}},
                            {code : 'WE', label: {fr:'/11 semaines', en: '', nl: '/11 weken'}},
                            {code : 'WN', label: {fr:'/9 semaines', en: '', nl: '/9 weken'}},
                            {code : 'WP', label: {fr:'/24 semaines', en: '', nl: '/24 weken'}},
                            {code : 'WQ', label: {fr:'/5 semaines', en: '', nl: '/5 weken'}},
                            {code : 'WS', label: {fr:'/7 semaines', en: '', nl: '/7 weken'}},
                            {code : 'WT', label: {fr:'/2 semaines', en: '', nl: '/2 weken'}},
                            {code : 'WV', label: {fr:'/4 semaines', en: '', nl: '/4 weken'}},
                            {code : 'WW', label: {fr:'/12 semaines', en: '', nl: '/12 weken'}},
                            {code : 'WX', label: {fr:'/10 semaines', en: '', nl: '/10 weken'}},
                            {code : 'WZ', label: {fr:'/6 semaines', en: '', nl: '/6 weken'}}
                        ]
                    },
                    selectedMedication: {
                        type: Object,
                        value: () => {}
                    },
                    administrationUnit:{
                        type: Object,
                        value : [
                            {code: "00001", label: {fr: "x 5 ml", en: '', nl: ''}},
                            {code: "00002", label: {fr: "amp.", en: '', nl: ''}},
                            {code: "00003", label: {fr: "applic.", en: '', nl: ''}},
                            {code: "00004", label: {fr: "caps.", en: '', nl: ''}},
                            {code: "00005", label: {fr: "compr.", en: '', nl: ''}},
                            {code: "00006", label: {fr: "dose", en: '', nl: ''}},
                            {code: "00007", label: {fr: "gouttes", en: '', nl: ''}},
                            {code: "00008", label: {fr: "flac.", en: '', nl: ''}},
                            {code: "00009", label: {fr: "implant", en: '', nl: ''}},
                            {code: "00010", label: {fr: "perfusion", en: '', nl: ''}},
                            {code: "00011", label: {fr: "inhalation", en: '', nl: ''}},
                            {code: "00012", label: {fr: "insert", en: '', nl: ''}},
                            {code: "00013", label: {fr: "gommes à mâcher", en: '', nl: ''}},
                            {code: "00014", label: {fr: "compresse(s)", en: '', nl: ''}},
                            {code: "00015", label: {fr: "lavement", en: '', nl: ''}},
                            {code: "00016", label: {fr: "ml", en: '', nl: ''}},
                            {code: "00017", label: {fr: "ov.", en: '', nl: ''}},
                            {code: "00018", label: {fr: "perle(s)", en: '', nl: ''}},
                            {code: "00019", label: {fr: "pastille", en: '', nl: ''}},
                            {code: "00020", label: {fr: "patch", en: '', nl: ''}},
                            {code: "00021", label: {fr: "patr.", en: '', nl: ''}},
                            {code: "00022", label: {fr: "stylo", en: '', nl: ''}},
                            {code: "00023", label: {fr: "puff(s)", en: '', nl: ''}},
                            {code: "00024", label: {fr: "éponge", en: '', nl: ''}},
                            {code: "00025", label: {fr: "stylo", en: '', nl: ''}},
                            {code: "00026", label: {fr: "suppo", en: '', nl: ''}},
                            {code: "00027", label: {fr: "tube", en: '', nl: ''}},
                            {code: "00028", label: {fr: "mèche", en: '', nl: ''}},
                            {code: "00029", label: {fr: "sac", en: '', nl: ''}},
                            {code: "00030", label: {fr: "sachets(s)", en: '', nl: ''}},
                            {code: "cm", label: {fr: "centimètre", en: '', nl: ''}},
                            {code: "dropsperminute", label: {fr: "goutes par minute", en: '', nl: ''}},
                            {code: "gm", label: {fr: "gramme", en: '', nl: ''}},
                            {code: "internationalunits", label: {fr: "unités internationales", en: '', nl: ''}},
                            {code: "mck/h", label: {fr: "microgramme par heure", en: '', nl: ''}},
                            {code: "mck/kg/minute", label: {fr: "microgramme par kilogramme par minute", en: '', nl: ''}},
                            {code: "measure", label: {fr: "mesure", en: '', nl: ''}},
                            {code: "mg", label: {fr: "milligramme", en: '', nl: ''}},
                            {code: "mg/h", label: {fr: "milligramme par heure", en: '', nl: ''}},
                            {code: "mg/ml", label: {fr: "milligramme par millimètre", en: '', nl: ''}},
                            {code: "ml/h", label: {fr: "millilitre par heure", en: '', nl: ''}},
                            {code: "tbl", label: {fr: "cuillère à soupe", en: '', nl: ''}},
                            {code: "tsp", label: {fr: "cuillère à café", en: '', nl: ''}},
                            {code: "unt/h", label: {fr: "unités par heure", en: '', nl: ''}}
                        ]
                    },
                    medications:{
                        type: Array,
                        value: () => []
                    },
                    prescriptions:{
                        type: Array,
                        value: () => []
                    },
                    contacts: {
                        type: Array,
                        value: () => []
                    },
                    hcp: {
                        type: Object,
                        value: () => {}
                    },
                    hcPartiesCache: {
                        type: Array,
                        value: () => []
                    }
                }
            }

            static get observers() {
                return ['dataProvider(medicationSchemeTransactions.*)'];
            }

            ready() {
                super.ready();
            }

            dataProvider(){
                console.log(this.medicationSchemeTransactions)
                const ms = this._getMedicationSchemeFromTransactionSet();
                this.set('currentMedicationScheme', {
                    idKmehr: _.get(ms, 'idKmehr', null),
                    hubId: _.get(ms, 'hubId', null),
                    date: _.get(ms, 'date', null),
                    authors: _.get(ms, 'authors', []),
                    version: _.get(ms, 'version', null),
                    msElems: _.concat(_.get(ms, 'msElems', []), this._getElementsFromMedications()),
                    msSusps: _.get(ms, 'msSusps', []),
                    times:  _.get(ms, 'times', [])
                })
            }

            _getMedicationName(medication){
                return medication && medication.medicinalproduct && medication.medicinalproduct.intendedname ? medication && medication.medicinalproduct && medication.medicinalproduct.intendedname :
                    medication && medication.substanceproduct && medication.substanceproduct.intendedname ? medication.substanceproduct.intendedname  :
                        medication && medication.compoundprescription !== null ? "Magistrale" : null
            }

            _getPosology(medication){
                const period = medication && medication.frequency && medication.frequency.periodicity && medication.frequency.periodicity.cd && medication.frequency.periodicity.cd.value || null
                const periodicity = this.periodicity.find(p => p.code === period) || null
                return periodicity && periodicity.label && periodicity.label[this.language] ? periodicity.label[this.language] : null
            }

            _convertHubDateAsString(timestamp){
                return timestamp && timestamp.millis ? this.api.moment(timestamp.millis).format("DD/MM/YYYY") : null;
            }

            _getDateFromHub(date){
                return _.get(date, 'date', null) ? this._convertHubDateAsString(date.date) : null
            }

            _getComment(medication){
                return medication && medication.posology && medication.posology.text && medication.posology.text.value || null
            }

            _isChronic(medication){
                return medication && medication.temporality && medication.temporality.cd && medication.temporality.cd.value === "CHRONIC" ? true : false
            }

            _isOneShot(medication){
                return medication && medication.temporality && medication.temporality.cd && medication.temporality.cd.value === "ONESHOT" ? true : false
            }

            _getRegimen(regimen, period){

                const concernPeriod = period === 0 ? "morning" :
                    period === 1 ? "beforebreakfast" :
                    period === 2 ? "duringbreakfast" :
                    period === 3 ? "afterbreakfast" :
                    period === 4 ? "betweenbreakfastandlunch" :
                    period === 5 ? "beforelunch" :
                    period === 6 ? "duringlunch" :
                    period === 7 ? "afterlunch" :
                    period === 8 ? "betweenlunchanddinner" :
                    period === 9 ? "beforedinner" :
                    period === 10 ? "duringdinner" :
                    period === 11 ? "afterdinner" :
                    period === 12 ? "evening" :
                    period >= 19700101000000 ? period.toString() : null

               if(period >= 100) console.log("Concerned period = ", concernPeriod)
               return regimen && regimen.filter(r => period === 12 ? _.toLower(r.dayTime) === 'evening' || _.toLower(r.dayTime) === 'night' || _.toLower(r.dayTime) === 'thehourofsleep'  : _.toLower(r.dayTime) === concernPeriod).reduce((tot, r) => tot + Number(r.quantity), 0) || null
            }

            _getOtherRegimen(regimen){
                return _.drop(regimen)
            }

            _getRegimenAsText(regimen){
                const administrationInfo = this.administrationUnit.find(adm => adm.code === regimen.administrationUnit) || null
                const adminUnit = administrationInfo && administrationInfo.label && administrationInfo.label[this.language] ? administrationInfo.label[this.language] : administrationInfo.label["fr"]

                return this._getDayFreqDesc(regimen) + regimen.quantity+" "+adminUnit+" "+ this._getDayTimeDesc(regimen.dayTime)
            }

            _getDayFreqDesc(regimen){
                return regimen.dayNumber ? (this.localize("daynr", "Day #", this.language) + regimen.dayNumber + ":") :
                    (regimen.weekDay ? ((regimen.weekNumber ? (this.localize("weeknr", "Week #", this.language) + regimen.weekNumber + ":") : "") + this.localize(regimen.weekDay, regimen.weekDay, this.language) + ":") : (""));
            }

            _getDayTimeDesc(dayTime){

                return !isNaN(dayTime) ? this._getTimeDesc(dayTime) : this.localize('ms_'+_.toLower(dayTime), _.toLower(dayTime), this.language);
            }

            _isSuspensions(medication){
                return medication && medication.suspended === true ? true : false
            }

            _getReasonOfSuspension(medication){
                return _.flatten(medication && medication.suspensions && medication.suspensions.map(s => s && s.reasonTexts && s.reasonTexts.map(r => r && r.value))).join(',') || null
            }

            _getReasonOfSuspensionForDialog(suspension){
                return _.flatten(suspension && suspension.reasonTexts && suspension.reasonTexts.map(r => r.value)).join(',') || null
            }

            _getMedicationUse(useTexts){
                return useTexts && useTexts.map(u => u.value).join(',') || null
            }

            _isCompoundPrescription(compoundPrescription){
                return compoundPrescription && compoundPrescription !== null ? true : false
            }

            _isSubstancePrescription(substanceProduct){
                return substanceProduct && substanceProduct !== null ? true : false
            }

            _getDayInfo(regimen){
                //return regimen.dayNumber ? (this.localize("daynr", "Day #", this.language) + regimen.dayNumber + ":") :
                //    (regimen.weekday ? ((regimen.weekNumber ? (this.localize("weeknr", "Week #", this.language) + regimen.weekNumber + ":") : "") + this.localize(regimen.weekday, regimen.weekday, this.language) + ":") : (""));

                return Array.isArray(regimen) && (regimen || []).find(r => _.get(r, 'dayNumber', null)) && _.get(regimen.find(r => _.get(r, 'dayNumber', null)), 'dayNumber', null) ? (this.localize("daynr", "Day # ", this.language) + _.get(regimen.find(r => _.get(r, 'dayNumber', null)), 'dayNumber', null)) :
                    Array.isArray(regimen) && (regimen || []).find(r => _.get(r, 'weekNumber', null)) && _.get(regimen.find(r => _.get(r, 'weekNumber', null)), 'weekNumber', null) ? (this.localize("weeknr", "Week # ", this.language) + _.get(regimen.find(r => _.get(r, 'weekNumber', null)), 'weekNumber', null)) :
                        Array.isArray(regimen) && (regimen || []).find(r => _.get(r, 'weekDay', null)) && _.get(regimen.find(r => _.get(r, 'weekDay', null)), 'weekDay', null) ? (this.localize(_.get(regimen.find(r => _.get(r, 'weekDay', null)), 'weekDay', null), _.get(regimen.find(r => _.get(r, 'weekDay', null)), 'weekDay', null), this.language)): ""
            }

            _getTimeDesc(time){
                return  time && time.toString().length >= 14 ? time.toString().substr(8,2) + ":" + time.toString().substr(10,2) : "";
            }

            _getValue(value) {
                return value ? value : "<empty>"
            }

            _filterRegimen(regimen, id) {
                let period = all_periods.find(p => p.id == id)
                return period && period.keywords.some(k => k == _.toLower(regimen.dayTime))
            }

            _formatPosology(posology) {
                return posology ? posology.text.value : '<empty>'
            }

            _formatFrequency(frequency) {
                let code = _.get(frequency, 'periodicity.cd.value', '')
                let periodicity = this.periodicity.find(p => p.code == code)
                return periodicity ? periodicity.label.fr : '<empty>'
            }

            _format(medication, field) {
                let value = this._getField(medication, field)
                return field.format ? this[field.format](value) : value
            }

            _getField(medication, field) {
                let defaultValue = field.defaultValue ? field.defaultValue : ''
                if (field.getter) {
                    if (field.name)
                        return this[field.getter](medication[field.name])
                    return this[field.getter](medication)
                }
                if (field.filter) {
                    let items = _.get(medication, field.name, [])
                    let item = items.find(item => this[field.filter](item, field.argument))
                    if (field.path)
                        return _.get(item, field.path, defaultValue)
                    return item
                }
                return _.get(medication, field.name, defaultValue)
            }

            _setField(medication, field, value) {
                if (field.filter) {
                    let items = _.get(medication, field.name, [])
                    let item = items.find(item => this[field.filter](item, field.argument))
                    if (field.path)
                        _.set(item, field.path, value)
                    else
                        items[items.indexOf(item)] = value
                    return;
                }
                _.set(medication, field.name, value)
            }

            _getScore(source, target) {
                let score = 0
                let total = 0
                all_fields.forEach(field => {
                    let source_value = this._getField(source, field, '')
                    let target_value = this._getField(target, field, '')
                    if (source_value == target_value)
                        score += field.score
                    total += field.score
                })
                return score
            }

            _getCandidates(medication, flag) {
                let candidates = this.currentMedicationScheme.msElems
                    .filter(med => med.uniqId != medication.uniqId && !med.synchronizationInfo[flag]).map(med => {
                        return {
                            medication: med,
                            score: this._getScore(medication, med)
                        }
                    })
                return candidates
            }

            _showMedication(e) {
                this.set('selectedMedication', {})

                //if(e.currentTarget.dataset.medication){
                //    this.set('selectedMedication', JSON.parse(e.currentTarget.dataset.medication))

                const uid = e.currentTarget.dataset.uid
                let medication = this.currentMedicationScheme.msElems.find(m => m.uniqId == uid);
                if (medication) {
                    this.set('selectedMedication', medication)
                    let si = this.selectedMedication.synchronizationInfo
                    let flag = si.availableOnHub ? 'availableOnHub' : 'availableOnLocal';
                    this.set('candidates', this._getCandidates(this.selectedMedication, flag))
                    this.$['medicationDetailDialog'].open()
                }
            }

            _closeMedicationDetailDialog() {
                this.set('selectedMedication', {})
                this.$['medicationDetailDialog'].close()
            }

            _closeMedicationMergeDialog() {
                this.set('selectedMedication', {})
                this.$['medicationMergeDialog'].close()
            }

            _compare(e) {
                const uid = e.target.dataset.uid
                let source = this.selectedMedication
                let target = this.candidates.find(candidate => candidate.medication.uniqId == uid).medication
                let fields = []
                all_fields.forEach(field => {
                    let source_value = this._getField(source, field)
                    let target_value = this._getField(target, field)
                    if (source_value != target_value) {
                        fields.push({
                            name: field.name,
                            label: field.label,
                            source: this._format(source, field),
                            target: this._format(target, field),
                            hidden: field.hidden,
                            checked: true
                        })
                    }
                })
                this.set('source', source)
                this.set('target', target)
                this.set('fields', fields)
                this.$['medicationDetailDialog'].close()
                this.$['medicationMergeDialog'].open()
                this.shadowRoot.querySelector('#fields').render()
                this.set('refresher', this.refresher + 1)
            }

            _merge(e) {
                this.fields.forEach(field => {
                    if (!field.checked) {
                        if (field.sibling) {
                            let _field = all_fields.find(f => f.name == field.sibling)
                            if (_field) {
                                field = {
                                    name: _field.name,
                                    label: _field.label,
                                    source: this._format(this.source, _field),
                                    target: this._format(this.target, _field),
                                    hidden: field.hidden,
                                    checked: true
                                }
                                let value = this._getField(this.target, field)
                                this._setField(this.source, field, value)
                            }
                        }
                        else {
                            let value = this._getField(this.target, field)
                            this._setField(this.source, field, value)
                        }
                    }
                })
                let medications = this.currentMedicationScheme.msElems
                Object.assign(medications.find(m => m.uniqId == this.source.uniqId), this.source)
                this.currentMedicationScheme.msElems = medications.filter(m => m.uniqId != this.target.uniqId)
                this.$['medicationMergeDialog'].close()
                this.shadowRoot.querySelector('#medicationScheme').render()
                this.set('refresher', this.refresher + 1)
            }

            _isChecked(field) {
                return field.checked
            }

            _setChecked(name, checked) {
                let field = this.fields.find(field => field.name == name)
                field.checked = checked
                this.set('refresher', this.refresher + 1)
            }

            _check(e) {
                e.target.checked = true
                this._setChecked(e.target.id, true)
            }

            _uncheck(e) {
                e.target.checked = true
                this._setChecked(e.target.id, false)
            }

            _medicationClass(m) {
                return (m.idKmehr%2 == 0) ? 'even' : 'odd'
            }


            _getElementsFromMedications(){
                console.log(this.medications);
                console.log(this.prescriptions);


                return _.concat(_.get(this, 'medications', []), _.get(this, 'prescriptions', [])).map(med => {
                    const medicationValue = this.api.contact().medicationValue(med, this.language) || {};
                    const beginMoment = _.get(medicationValue, "beginMoment", null);
                    const endMoment = _.get(medicationValue, "endMoment", null);
                    return {
                        idKmehr: null,
                        medicationHubId: null,
                        adaptationflag: null,
                        adaptationtype: null,
                        compoundprescription: _.get(medicationValue, "compoundprescription", null),
                        medicinalproduct: _.get(medicationValue, "medicinalProduct", null),
                        substanceproduct: _.get(medicationValue, "substanceproduct", null),
                        beginmoment: beginMoment ? moment(beginMoment, "YYYYMMDD").format('DD/MM/YYYY'): null,
                        endmoment: endMoment ? moment(endMoment, "YYYYMMDD").format('DD/MM/YYYY'): null,
                        temporality: null,
                        frequency: null,
                        regimen: [this._composeRegimen(_.get(medicationValue, "regimen", []))],
                        regimenDayNumber: null,
                        regimenWeekDay: null,
                        regimenWeekNumber: null,
                        posology: {
                            text: {
                                value: _.get(medicationValue, "instructionForPatient", null)
                            }
                        },
                        suspensions: null,
                        usePresent: null,
                        useTexts: [],
                        date: null,
                        beginTimeStamp: beginMoment,
                        authors: [],
                        uniqId: this.api.crypto().randomUuid(),
                        synchronizationInfo: {
                            availableOnHub: false,
                            availableOnLocal: true,
                            localToHub: false,
                            hubToLocal: false
                        }
                    }
                })
            }

            _composeRegimen(regimen){
                let formatedRegimen = []
                regimen.map(reg => {
                    const administrationUnit = _.get(reg, 'administratedQuantity.unit', null);
                    formatedRegimen.push({
                        dayTime: _.get(reg, 'dayPeriod.code', null),
                        dayNumber : null,
                        quantity: _.get(reg, 'administratedQuantity.quantity', null),
                        administrationUnit: administrationUnit && administrationUnit.match(/[0-9]+|cm|dropsperminute|gm|internationalunits|mck\/h|mck\/kg\/minute|measure|mg\/h|ml\/h|tbl|tsp|unt\/h|mg|mg\/ml/) ? administrationUnit : '00006',
                        weekDay: null,
                        weekNumber: null
                    })

                })

                return formatedRegimen
            }

            //create easy medicationscheme object
            _getMedicationSchemeFromTransactionSet(){
                if (!(_.has(this.medicationSchemeTransactions, "medicationScheme") && _.has(this.medicationSchemeTransactions, "medicationSchemeElements") && _.has(this.medicationSchemeTransactions, "treatmentSuspensions")))
                    return [];
                //loop trough medicationschemeElements tr[1..n]
                // loop trough items
                //  medicationchemeelement:
                //  item[0]: meta info (adaptation, ...)
                //  item[1]: medication info (medication, dates, posology, regimen, frequency, ...)
                //  item[2]: medication use /optional (?)
                const elems = this.medicationSchemeTransactions.medicationSchemeElements.map(msElement => {
                    const dateFromHub = this._getDateFromHub(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'beginmoment', null));
                    let el = {
                        idKmehr: _.get(_.get(msElement, 'ids', []).find(id => _.get(id, 's', null) === "ID_KMEHR"), 'value', null),
                        medicationHubId: _.get(_.get(msElement, 'ids', []).find(id => _.get(id, 's', null) === "LOCAL"), 'value', null),
                        adaptationflag: !!_.size(_.get(_.get(msElement, 'item', []).filter(itm=> _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "healthcareelement")).find(itm => _.get(itm, 'contents', []).find(it => _.get(it, 'cds', []).find(cd => _.get(cd, 's', null) ==="CD_MS_ADAPTATION"))), 'contents', []).filter(it => _.get(it, 'cds', []).find(cd => _.get(cd, 'value', null) === "adaptationflag"))) > 0,
                        adaptationtype: !!_.get(_.get(_.get(_.get(msElement, 'item', []).filter(itm=> _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "healthcareelement")).find(itm => _.get(itm, 'contents', []).find(it => _.get(it, 'cds', []).find(cd => _.get(cd, 's', null) ==="CD_MS_ADAPTATION"))), 'contents', []).find(it => it.cds.find(cd => cd.s==="CD_MS_ADAPTATION")), 'cds', []).find(cd => cd.s==="CD_MS_ADAPTATION"), 'value', null),
                        compoundprescription: _.get(_.head(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'compoundprescription', null),
                        medicinalproduct: _.get(_.head(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'medicinalproduct', null),
                        substanceproduct: _.get(_.head(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'substanceproduct', null),
                        beginmoment: this._getDateFromHub(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'beginmoment', null)),
                        endmoment: this._getDateFromHub(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'endmoment', null)),
                        temporality: _.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'temporality', null),
                        frequency: _.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'frequency', null),
                        regimen: _.values(_.groupBy(this._decomposedRegimen(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'regimen', null)), item => _.get(item, 'dayNumber', null) || 'other')),
                        regimenDayNumber: _.values(_.groupBy(this._decomposedRegimen(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'regimen', null)), item => _.get(item, 'dayNumber', null) || 'other')),
                        regimenWeekDay: _.values(_.groupBy(this._decomposedRegimen(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'regimen', null)), item => _.get(item, 'weekDay', null) || 'other')),
                        regimenWeekNumber: _.values(_.groupBy(this._decomposedRegimen(_.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'regimen', null)), item => _.get(item, 'weekNumber', null) || 'other')),
                        posology: _.get(_.get(msElement, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'posology', null),
                        suspensions: [],
                        usePresent: !!_.get(_.get(msElement, 'item', []).filter(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "healthcareelement")).find(itm => _.get(itm, 'contents', []).find(it => _.get(it, 'cds', []).find(cd => _.get(cd, 'value', null) === "medicationuse"))), 'contents', []).find(it => _.size(_.get(it, 'cds', [])) === 0),
                        useTexts: _.get(_.get(_.get(msElement, 'item', []).filter(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "healthcareelement")).find(itm => _.get(itm, 'contents', []).find(it => _.get(it, 'cds', []).find(cd => _.get(cd, 'value', null) === "medicationuse"))), 'contents', []).find(it => _.size(_.get(it, 'cds', [])) === 0), 'texts', []),
                        date: null,
                        beginTimeStamp: dateFromHub ? moment(dateFromHub, 'DD/MM/YYYY').format('YYYYMMDD') : null,
                        authors: _.get(msElement, 'author.hcparties', []),
                        uniqId: this.api.crypto().randomUuid(),
                        synchronizationInfo: {
                            availableOnHub: true,
                            availableOnLocal: false,
                            localToHub: false,
                            hubToLocal: false
                        }
                    };

                    if(_.size(_.get(el, 'regimenDayNumber', [])) > _.size(_.get(el, 'regimenWeekDay', []))){
                        if(_.size(_.get(el, 'regimenWeekNumber', [])) > _.size(_.get(el, 'regimenDayNumber', []))){
                            el.regimen = _.get(el, 'regimenWeekNumber', null)
                        } else {
                            el.regimen = _.get(el, 'regimenDayNumber', null)
                        }
                    } else {
                        if(_.size(_.get(el, 'regimenWeekNumber', [])) > _.size(_.get(el, 'regimenWeekDay', []))){
                            el.regimen = _.get(el, 'regimenWeekNumber', null)
                        } else {
                            el.regimen = _.get(el, 'regimenWeekDay', null)
                        }
                    }

                    return el
                });

                //loop trough treatmentsuspensions tr[1..n]
                const susps = this.medicationSchemeTransactions.treatmentSuspensions.map(msSuspension => {
                    let el = {
                        idKmehr: _.get(_.get(msSuspension, 'ids', []).find(id => _.get(id, 's', null) === "ID_KMEHR"), 'value', null),
                        compoundprescription: _.get(_.head(_.get(_.get(msSuspension, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'compoundprescription', null),
                        medicinalproduct: _.get(_.head(_.get(_.get(msSuspension, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'medicinalproduct', null),
                        substanceproduct: _.get(_.head(_.get(_.get(msSuspension, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'substanceproduct', null),
                        beginmoment: this._getDateFromHub(_.get(_.head(_.get(_.get(msSuspension, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'beginmoment', null)),
                        endmoment: this._getDateFromHub(_.get(_.head(_.get(_.get(msSuspension, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'endmoment', null)),
                        lifecycle: _.get(_.head(_.get(_.get(msSuspension, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'lifecycle', null),
                        lnks: _.get(_.head(_.get(_.get(msSuspension, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "medication")), 'contents', [])), 'lnks', null),
                        reasonTexts: _.get(_.get(_.get(msSuspension, 'item', []).find(itm => _.get(itm, 'cds', []).find(cd => _.get(cd, 'value', null) === "transactionreason")), 'contents', []).find(it => _.size(_.get(it, 'cds', [])) === 0), 'texts', [])
                    }

                    //link to msElem by idKmehr
                    const lnk = _.get(_.head(_.get(el, 'lnks', [])), 'url', null)

                    const matches = lnk && lnk.match(/(\d+)/) || [];
                    const lnkIdKmehr = _.size(matches) > 0 ? _.head(matches) : null;
                    if(lnkIdKmehr){
                        let trToSusp = _.get(ms, 'msElems', []).find(elm => _.get(elm, 'idKmehr', null) === lnkIdKmehr);
                        if(trToSusp){
                            trToSusp.suspensions.push(el);
                            trToSusp.suspended = true;
                        }
                    }
                    return el;
                });

                const msInfo = this.medicationSchemeTransactions.medicationScheme;
                let ms = {
                    idKmehr: _.get(_.get(msInfo, 'ids', []).find(id => _.get(id, 's', null) === "ID_KMEHR"), 'value', null),
                    hubId: _.get(_.get(msInfo, 'ids', []).find(id => _.get(id, 's', null) === "LOCAL"), 'sl', null) + "." + _.get(_.get(msInfo, 'ids', []).find(id => id.s === "LOCAL"), 'value', null),
                    date: null,
                    authors: _.get(msInfo, 'author.hcparties', null),
                    version: _.get(msInfo, 'version', null),
                    msElems: _.orderBy(elems, ['beginTimeStamp'], ['desc']),
                    msSusps: susps
                };

                ms.times = this._getTimes(ms);
                return ms;
            }

            _decomposedRegimen(regimen){

                let decomposedRegimen = []
                const subRegimen = _.get(regimen, 'daynumbersAndQuantitiesAndDates', null) ? _.chunk(_.get(regimen, 'daynumbersAndQuantitiesAndDates', []), (_.indexOf(_.get(regimen, 'daynumbersAndQuantitiesAndDates', []), _.get(regimen, 'daynumbersAndQuantitiesAndDates', []).find(r => r.name === "{http://www.ehealth.fgov.be/standards/kmehr/schema/v1}quantity")) + 1)) : []
                subRegimen.map(sr => decomposedRegimen.push(this._getRegimenInfo(sr)))
                return decomposedRegimen
            }

            _getRegimenInfo(regimen){

                const dayNumber = regimen && regimen.find(r => r.name === "{http://www.ehealth.fgov.be/standards/kmehr/schema/v1}daynumber") || null
                const dayTime = regimen && regimen.find(r => r.name === "{http://www.ehealth.fgov.be/standards/kmehr/schema/v1}daytime") || null
                const quantity = regimen && regimen.find(r => r.name === "{http://www.ehealth.fgov.be/standards/kmehr/schema/v1}quantity") || null
                const weekDay = regimen && regimen.find(r => r.name === "{http://www.ehealth.fgov.be/standards/kmehr/schema/v1}weekday") || null

                return {
                    dayNumber: _.get(dayNumber, 'value', null),
                    dayTime: _.get(dayTime, 'value.dayperiod.cd.value', null) || _.get(dayTime, 'value.time', null),
                    quantity:  _.get(quantity, 'value.decimal', null),
                    administrationUnit: _.get(quantity, 'value.unit.cd.value', null),
                    weekDay: _.toLower(_.get(weekDay, 'value.cd.value', null)),
                    weekNumber: _.get(weekDay, 'value.weeknumber', null)
                }
            }


            _getTimes(simplifiedMs){
                return _.uniq(_.flatMap(_.get(simplifiedMs, 'msElems', []), msElem =>_.flatMap( _.get(msElem, 'regimen', []), reg=>_.flatMap(reg, ritm => _.get(ritm, 'dayTime', null)))).filter(it => !isNaN(it))).sort()
            }

            _createAuthor(data) {
                if (data.authors && data.authors.length) {
                    const author = data.authors.find(author => author.cds.some(cd => cd.value === "persphysician"));
                    if (author) {
                        return {
                            id: author.localId,
                            name: `${author.familyname} ${author.firstname}`,
                            lastName: author.familyname,
                            firstName: author.firstname,
                            nihii: _.get(author.ids.find(id => id.s === "ID_HCPARTY"), 'value', ''),
                            ssin: _.get(author.ids.find(id => id.s === "INSS"), 'value', ''),
                            addresses: author.addresses.map(address => {
                                return {
                                    addressType: _.get(address.cds.find(cd => cd.s === "CD_ADDRESS"), 'value', 'work'),
                                    street: _.get(address, 'street', ''),
                                    houseNumber: _.get(address, 'housenumber', ''),
                                    postboxNumber: _.get(address, 'postboxnumber', ''),
                                    postalCode: _.get(address, 'zip', ''),
                                    city: _.get(address, 'city', ''),
                                    country: !!_.trim(_.get(address, 'country.cd.value')) ? _.get(address, 'country.cd.value') : 'be',
                                    telecoms: author.telecoms.map(telecom => {
                                        return {
                                            telecomType: _.get(telecom.cds.find(cd => cd.s === "CD_TELECOM"), "value", "phone"),
                                            telecomNumber: _.get(telecom, "telecomnumber", "")
                                        };
                                    })
                                };
                            })
                        };
                    } else {
                        // @todo: special case
                        return this.hcp;
                    }
                } else {
                    return this.hcp;
                }
            }

            _createMedication(data) {
                const medicationContent = {
                    medicationValue: {regimen: [], substitutionAllowed: true},
                    stringValue: data.medicationHubId
                };
                const medication = {
                    content: _.fromPairs([[this.language, medicationContent]]),
                    codes: [],
                    tags: []
                };

                const medicationValue = medicationContent.medicationValue;

                data.regimen && data.regimen.length && data.regimen.forEach(subReg => subReg && subReg.length && subReg.forEach(dataReg => {
                    medicationValue.regimen.push(Object.assign({
                        administratedQuantity: {
                            quantity: dataReg.quantity,
                            administrationUnit: this.api.code().normalize(`CD-ADMINISTRATIONUNIT|${dataReg.administrationUnit}|1`)
                        }},
                        dataReg && dataReg.dayTime ? ( dataReg.dayTime.millisOfDay || dataReg.dayTime.millisOfDay === 0 ? {timeOfDay: +moment(dataReg.dayTime.millisOfDay).format('HHmmss')} : {dayPeriod: this.api.code().normalize(`CD-DAYPERIOD|${dataReg.dayTime.toLowerCase()}|1`)} ) : {})
                    );
                }));

                const isMedication = !data.endmoment;

                if (data.compoundPrescription) {
                    medicationValue.compoundPrescription = data.compoundPrescription;
                } else {
                    const dataProduct = _.get(data, "medicinalproduct",  _.get(data, "substanceproduct"));
                    if (!dataProduct) return null;

                    const code =  _.get(dataProduct, "intendedcds", []).length > 0 && _.get(dataProduct, "intendedcds", [])[0].code ? {value: _.get(dataProduct, "intendedcds", [])[0].code} : _.get(dataProduct, "intendedcds", []).find(cd => cd.s === "CD_VMPGROUP" || cd.s === "CD_INNCLUSTER" || cd.s === "CD_DRUG_CNK");
                    const drugType = _.get(dataProduct, "intendedcds", []).length > 0 && _.get(dataProduct, "intendedcds", [])[0].type ? _.get(dataProduct, "intendedcds", [])[0].type : (code.s === "CD_VMPGROUP") ? "CD-VMPGROUP" :
                        (code.s === "CD_INNCLUSTER") ? "CD-INNCLUSTER" :
                            (code.s === "CD_DRUG_CNK") ? "CD-DRUG-CNK" :
                                "compoundPrescription";

                    const product = {
                        intendedname: dataProduct.intendedname,
                        intendedcds: [{type: drugType, code: code.value}]
                    };

                    medication.codes.push(this.api.code().normalize(data.endmoment ? "CD-ITEM|medication|1" : "ICURE|PRESC|1"));
                    medication.tags.push(this.api.code().normalize(`${drugType}|${code.value}|1`));

                    Object.assign(medicationValue, data.medicinalproduct ? {medicinalProduct: product} : {substanceProduct: product});
                    Object.assign(medicationValue, {
                        posology: _.get(data, "posology.text.value", ""),
                        beginMoment: data.beginmoment ? moment(data.beginmoment, 'DD/MM/YYYY', true).format('YYYYMMDD') : null
                    });
                    if (data.endmoment) {
                        Object.assign(medicationContent.medicationValue, {endMoment: moment(data.endmoment, 'DD/MM/YYYY', true).format('YYYYMMDD')});
                    }
                }

                medication.label = data.endmoment ? "Prescription" : "Medication";
                medication.id = this.api.crypto().randomUuid();
                medication.author = this.user.id;
                return this.api.contact().service().newInstance(this.user, medication);
            }

            dashToLoDash(t){
                return t.replace("-", "_");
            }

            _getServiceSignature(svc) {
                // build with intendedName, beginMoment, ... to complete
                const medicationValue = this.api.contact().medicationValue(svc, this.language);
                const intendedName = _.get(medicationValue, "medicinalProduct.intendedname" , _.get(medicationValue, "substanceProduct.intendedname", _.get(medicationValue, "compoundPrescription", "")));
                return md5(JSON.stringify([intendedName, medicationValue.beginMoment, (medicationValue.endMoment || "")]));
            }

            _getServiceContact(hubId) {
                return this.contacts.find(ctc => ctc.services.some(svc => {
                    const content = this.api.contact().preferredContent(svc, this.language);
                    return content && content.stringValue === hubId;
                }));
            }

            _compareMedication(hubSvc) {
                const hubId = (this.api.contact().preferredContent(hubSvc, this.language) || {stringValue: ""}).stringValue;
                let contact = this._getServiceContact(hubId);
                // common compare convention: 0 means identical.
                if (!contact) return 1;
                const localSvc = contact.services.find(svc => {
                    const content = this.api.contact().preferredContent(svc, this.language);
                    return content && content.stringValue === hubId;
                });
                if (!localSvc) return 1;
                return this._getServiceSignature(localSvc) === this._getServiceSignature(hubSvc) ? 0 : 1;
            }

            _overrideLocalMedication(hubSvc) {
                //@todo: check if that service already exists
                const medicationValue = this.api.contact().medicationValue(hubSvc, this.language);
                const hubId = (this.api.contact().preferredContent(hubSvc, this.language) || {stringValue: ""}).stringValue;
                let contact = this._getServiceContact(hubId);
                if (contact) {
                    const localSvc = contact.services.find(svc => {
                        const content = this.api.contact().preferredContent(svc, this.language);
                        return content && content.stringValue === hubId;
                    });
                    contact.services.splice(contact.services.indexOf(localSvc), 1, hubSvc);
                    const csc = contact.subContacts.find(csc => csc.services.indexOf(localSvc.id) > -1);
                    if (csc) {
                        csc.services.splice(csc.services.indexOf(localSvc.id), 1, {serviceId: hubSvc.id});
                    } else {
                        contact.subContacts.push({services: [{serviceId: hubSvc.id}]});
                    }
                    return this.api.contact().modifyContact(contact);
                } else {
                    const contactDate = medicationValue.beginMoment ? parseInt(moment(medicationValue.beginMoment, 'YYYYMMDD', true).format("YYYYMMDDHHmmss")) : null;
                    return this.api.contact().newInstance(this.user, this.patient, {
                        openingDate: contactDate,
                        closingDate: contactDate,
                        author: this.user.id,
                        responsible: this.user.healthcarePartyId,
                        subContacts: []
                    })
                        .then(contact => {
                            (contact.services || (contact.services = [])).push(hubSvc);
                            contact.subContacts.push({services: [{serviceId: hubSvc.id}]});
                            return this.api.contact().createContactWithUser(this.user, contact);
                        })
                }
            }


            _synchronizeItemToLocal(e){
                e.stopPropagation()
                if(_.get(e, 'currentTarget.dataItem', null)){
                    let data = _.get(this, 'currentMedicationScheme.msElems', []).find(el => _.get(el, 'uniqId', null) === _.get(e, 'currentTarget.dataItem.uniqId', null));
                    let info  =_.get(data, 'synchronizationInfo', null)
                    _.get(info, 'hubToLocal', false) ? info.hubToLocal = false : info.hubToLocal = true;

                    const hubSvc = this._createMedication(data);
                    if (this._compareMedication(hubSvc) !== 0) {
                        // @todo: ask user which one to keep
                        // for example, user wants to update local medication
                        this._overrideLocalMedication(hubSvc);
                    }

                }

                // const newMedication = _.cloneDeep(m.newMedication);
                // ((newMedication.tags || (newMedication.tags = [])).find(tag => tag.type === "CD-ITEM") || (newMedication.tags[newMedication.tags.length] = {type: "CD-ITEM", version: "1"})).code = "medication";
                // newMedication.label = this.localize('medication', 'medication', this.language);
                // newMedication.id = this.api.crypto().randomUuid();
                // return this.saveNewService(this.api.contact().service().newInstance(this.user, newMedication));

            }

            _synchronizeItemToHub(e){
                e.stopPropagation()
                if(_.get(e, 'currentTarget.dataItem', null)){
                    let info  =_.get(_.get(this, 'currentMedicationScheme.msElems', []).find(el => _.get(el, 'uniqId', null) === _.get(e, 'currentTarget.dataItem.uniqId', null)), 'synchronizationInfo', null)
                    _.get(info, 'localToHub', false) ? info.localToHub = false : info.localToHub = true
                }
            }

            _stopPropagation(e){
                e.stopPropagation()
            }

            _getMedElems(currentMedicationScheme){
                return _.get(currentMedicationScheme, 'msElems', [])
            }

            _synchronizeScheme(){
                console.log("currentMedicationScheme", JSON.stringify(this.currentMedicationScheme));
                const servicesToUpload = [];
                const serviceAuthors = [];
                _.get(this.currentMedicationScheme, "msElems", []).map(item => {
                    if(_.get(item, 'synchronizationInfo.localToHub', false) || _.get(item, 'synchronizationInfo.availableOnHub', false)) {
                        const hcp = this._createAuthor(item);
                        const med = this._createMedication(item);
                        med.author = this.user.id;
                        // med.author = hcp.id;
                        if (med) {
                            servicesToUpload.push(med)
                        } else{
                            console.log("_createMedication Failed for ", item)
                        }
                        serviceAuthors.push(hcp);
                    } else if(_.get(item, 'synchronizationInfo.hubToLocal', false)) {
                        const drugType = !_.isEmpty(_.get(item, 'medicinalproduct', {})) ? "CD-DRUG-CNK" : !_.isEmpty(_.get(item, 'substanceproduct', {})) ? "CD-VMPGROUP" : "compoundPrescription"
                        //these are to be stored local
                    }
                });
                console.log("servicesToUpload", JSON.stringify(servicesToUpload));

                // const propHub = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.preferredhub') ||
                //     (this.user.properties[this.user.properties.length] = {
                //         type: {identifier: 'org.taktik.icure.user.preferredhub'},
                //         typedValue: {type: 'STRING', stringValue: 'rsw'}
                //     })
                //
                // const propEnv = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.eHealthEnv') ||
                //     (this.user.properties[this.user.properties.length] = {
                //         type: {identifier: 'org.taktik.icure.user.eHealthEnv'},
                //         typedValue: {type: 'STRING', stringValue: 'prd'}
                //     })
                // this.set("curHub", propHub.typedValue.stringValue);
                // this.set("curEnv", propEnv.typedValue.stringValue);
                //
                // const hubConfig = this.$["htPatHubUtils"].getHubConfig(this.curHub, this.curEnv);
                // //this.set('isLoading',tru0
                // this.hubConfig = hubConfig ;

                this.$["htPatHubUtils"].initHubConfig();
                this.$["htPatHubUtils"].putMedicationScheme(servicesToUpload, serviceAuthors, this.currentMedicationScheme.version, false).then(svcs => console.log("services after processing", svcs));
            }

            _getResponsibleHcp(authors){
                return !_.isEmpty(authors.find(aut => _.get(aut, "cds", []).find(cd => _.get(cd, "value", null) === "persphysician"))) ? _.get(authors.find(aut => _.get(aut, "cds", []).find(cd => _.get(cd, "value", null) === "persphysician")), 'firstname', null)+" "+_.get(authors.find(aut => _.get(aut, "cds", []).find(cd => _.get(cd, "value", null) === "persphysician")), 'familyname', null) : _.get(_.last(authors), 'firstname', null)+" "+_.get(_.last(authors), 'familyname', null) || _.get(_.last(authors), 'name', null)
            }

        }
        customElements.define(HtPatHubMedicationSchemeExtendedView.is, HtPatHubMedicationSchemeExtendedView);
    </script>
</dom-module>
