<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="./ht-pat-hub-medication-scheme-view.html">
<link rel="import" href="../../../../scrollbar-style.html">

<dom-module id="ht-pat-hub-transaction-preview">
    <template>
        <style include="scrollbar-style">

            #dialog .hub-cons{
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                justify-content: flex-start;
                width: 100%;
                box-sizing: border-box;
            }

            #dialog paper-button.action {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                font-weight: 400;
                font-size: 12px;
                height: 32px;
                padding: 10px 1.2em;
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                background: var(--app-secondary-color);
                color: var(--app-primary-color-dark);
                justify-self: flex-end;
            }
            #dialog .hub-cons paper-button.action[disabled] {
                background-color: var(--app-secondary-color-dark);
                color: var(--app-text-color-disabled);
                box-shadow: none;
            }

            #dialog .hub-cons .buttons {
                right: 24px;
                position: absolute;
            }

            #dialog .hub-cons vaadin-date-picker {
                margin-right: 8px;
            }

            #dialog a {
                text-decoration: none;
                color:	var(--app-secondary-color);
            }

            #dialog{
                min-height: 800px;
                min-width: 1024px;
            }

            #dialog .hub-doc {
                overflow: auto ;
                max-height: 500px;
            }



            .links {
                position: absolute;
                right: 0;
            }

            .pills {
                float: right;
            }

            dynamic-link {
                float: right;
                top:4px;
            }

            vaadin-combo-box {
                width: 100%;
            }

            vaadin-text-area {
                width: 100%;
            }

            .containerHubCons {
                height: 58px;
                display: flex;
            }

            #par-search {
                flex: 1;
            }

            #dialog .hub-info{
                margin-top:0;
                display:flex;
                flex-flow: row nowrap;
                justify-content: flex-start;
                align-items: flex-start;
            }

            #dialog .hub-info div{
                margin-right: 24px;
            }

            #dialog .hub-info div p{
                margin: 8px 0;
            }

            #dialog .hub-info div b{
                margin-right: 8px;
            }

            .modal-title{
                background:  var(--app-background-color-dark);
                margin-top: 0;
                padding: 16px 24px;
            }

            paper-tabs {
                --paper-tabs-selection-bar-color: var(--app-text-color);
            }

            paper-tab {
                --paper-tab-ink: var(--app-secondary-color-dark);
                color: var(--app-text-color);
            }

            paper-tab iron-icon{
                color: var(--app-text-color-disabled);
            }

            paper-tab.iron-selected {
                font-weight: bold;
            }

            paper-tab.iron-selected > iron-icon {
                color: var(--app-text-color);
            }

            .tab-selector {
                height: 48px;
                background: var(--app-secondary-color);
            }

            .end-buttons {
                display: flex;
                position: absolute;
                right: 0;
                bottom: 0;
            }

            .modal-button--save {
                background: var(--app-secondary-color);
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
            }

            ht-spinner {
                position: relative;
                height: 42px;
                width: 42px;
            }

            #kmehr_slot{
                overflow-y: scroll;
                height: 90%;
            }

            #titleInfo{
                height: 20px;
                width: 98%;
                margin-bottom: 12px;
                font-size: 20px;
                font-weight: bold;
            }

            .headerInfo{
                height: auto;
                width: 100%;
                box-sizing: border-box;
            }

            #blockInfo{
                height: auto;
                width: 100%;
                box-sizing: border-box;
            }

            .headerInfoLine{
                width: 100%;
                padding: 4px;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: flex-start;
            }

            .headerInfoField{
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                align-content: stretch;
                width: calc(100% / 4);
                padding: 0 8px;
                box-sizing: border-box;
            }

            .headerLabel{
                font-weight: bold;
            }

            .hub-doc-container{
                box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
                margin-bottom: 12px;
            }

            .headerMasterTitle{
                font-size: var(--font-size-large);
                background: var(--app-background-color-dark);
                padding: 0 12px;
                box-sizing: border-box;
            }

            .blockInfo{
                height: auto;
                width: 100%;
                box-sizing: border-box;
            }

            .vaadinStyle{
                height: auto;
                border: none;
            }

            .doNotDisplay {
                display: none;
            }

            .pageContent{
                padding: 12px;
                width: auto;
                box-sizing: border-box;
            }

            iron-pages{
                height: calc(100% - 48px);
                width: auto;
                overflow: auto;
            }

            .modal-title {
                background: var(--app-background-color-dark);
                margin-top: 0;
                padding: 16px 24px;
            }

            .modal-button{
                --paper-button-ink-color: var(--app-secondary-color);
                background-color: var(--app-secondary-color);
                color: var(--app-text-color);
                font-weight: 700;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
            }

            .selectedDocumentToImportContent{
                height: 260px;
                width: auto;
                margin: 12px;
            }

            .buttons{
                position: absolute;
                right: 0;
                bottom: 0;
                margin: 8px 16px;
            }

            #importHubDocumentDialog{
                height: 400px;
                width: 650px;
            }

            .pat-details-card > .card-content {
                padding: 16px 16px 32px !important;
            }

            .pat-details-card {
                margin: 0 32px 32px;
                padding:0 8px 8px;
                overflow: hidden;
                width: calc(100% - 64px);
            }

            .pat-details-card.fullWidth {
                margin: 0 0 32px 0;
                width: 100%;
            }

            .pat-details-card hr {
                border: 1px solid var(--app-background-color-darker)
            }

            .form-title {
                color: var(--app-primary-color);
                border-top: 2px solid var(--app-background-color-dark);
                border-radius: 2px 2px 0 0;
                background: var(--app-background-color-dark);
                font-size: 12px;
                margin: 0 0 8px -8px;
                padding: 2px 4px 2px 20px;
                display: flex;
                flex-flow: row nowrap;
                width: calc(100% - 8px);
                text-align: left;
                justify-content: space-between;
                align-items: center;
            }
            .form-title > span {
                flex-grow: 1;
                min-width: 100px;
            }

            .form-title >div {
                flex-grow: 0;
                min-width: 20px;
            }

            .full-height {
                height: 100%;
            }

            .tabIcon{
                padding-right: 10px;
            }

            .tel-line{
                display: flex;
                align-items: center;
            }

            .tel-line iron-icon{
                color: var(--app-text-color-disabled);
                height: 16px;
                width: 16px;
                margin-right: 4px;
            }

            .chronicIcon{
                height: 12px;
                width: 12px;
            }

            .oneShotIcon{
                height: 12px;
                width: 12px;
                color: #c60b44;
            }

            .legend-oneShotIcon{
                height: 18px;
                width: 18px;
                color: #c60b44;
            }

            .legend-compoundIcon{
                height: 14px;
                width: 14px;
                color: #2882ff;
            }

            .legend-substanceIcon{
                height: 14px;
                width: 14px;
                color: #c62ac4;
            }

            .legend-line{
                margin-right: 8px;
                font-size: var(--font-size-normal);
            }

            #legend {
                background: var(--app-background-color);
                border-radius: 4px;
                padding: 4px;
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 12px;
            }

            .vaadin-temporality{
                width: 30px!important;
            }

            .modal-button{
                --paper-button-ink-color: var(--app-secondary-color);
                background-color: var(--app-secondary-color);
                color: var(--app-text-color);
                font-weight: 700;
                font-size: 14px;
                height: 40px;
                min-width: 100px;
                padding: 10px 1.2em;
                text-transform: capitalize;
            }

            #loadingContainer, #loadingContainerSmall {
                position:absolute;
                width: 100%;
                height: 100%;
                top: 0;left: 0;
                background-color: rgba(0,0,0,.3);
                z-index: 10;
                text-align: center;
            }

            .grid-btn-small {
                margin: 0;
                padding:2px 10px;
                box-sizing: border-box;
                --paper-button-ink-color: var(--app-secondary-color-dark);
                display: inline-block;
                text-align: center;
                --paper-button: {
                    background: var(--app-secondary-color);
                    color: var(--app-text-color);
                    width: auto;
                    margin: 0 auto;
                    font-size: 12px;
                    font-weight: 400;
                    padding:10px;
                };
            }

            .grid-btn-small.noBg {
                --paper-button-ink-color: var(--app-secondary-color-dark);
                --paper-button: {
                    background: none;
                };
            }

            .grid-btn-small iron-icon {
                max-width:20px;
            }
        </style>

            <!--<h2 class="modal-title">[[localize('hub_doc','Document',language)]]:[[_transactionId(transInfo)]]:[[_transactionType(transInfo)]]</h2>-->
            <paper-tabs class="tab-selector" selected="{{tabs}}" >
                <paper-tab>
                    <iron-icon class="tabIcon" icon="vaadin:male"></iron-icon> [[localize('tra_vwr','Viewer',language)]]
                </paper-tab>
               <paper-tab>[[localize('json_vwr','JSON View',language)]]</paper-tab>
            </paper-tabs>
            <iron-pages selected="[[tabs]]">
                <page>
                    <div class="pageContent">
                        <div id="titleInfo">
                            [[_localizeTransactionType(transInfo)]]
                            <ht-spinner active="[[isLoading]]"></ht-spinner>
                        </div>
                        <template is="dom-if" if="[[_bodyOverlay]]">
                            <div id="loadingContainer"></div>
                        </template>
                        <div class="hub-doc">
                            <div class="blockInfo">
                                <div class="hub-doc-container">
                                    <div class="headerMasterTitle headerLabel">[[_getTraduction('healthelement')]]</div>
                                <vaadin-grid id="he-list" class="vaadinStyle" items="[[currentSumehr.healthElements]]">
                                    <vaadin-grid-selection-column></vaadin-grid-selection-column>
                                    <vaadin-grid-column>
                                        <template class="header">
                                            [[localize('hub_titl','Title',language)]]
                                        </template>
                                        <template>
                                            [[item.descr]]
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column>
                                        <template class="header">
                                            [[localize('hub_sta_dat','Start date',language)]]
                                        </template>
                                        <template>
                                            [[item.openingDate]]
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column>
                                        <template class="header">
                                            [[localize('hub_code','Code',language)]]
                                        </template>
                                        <template>
                                            <template is="dom-repeat" items="[[item.codes]]" as="code">
                                                [[code.type]] [[code.code]]<br/>
                                            </template>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column>
                                        <template class="header">
                                            [[localize('hub_tag','Tag',language)]]
                                        </template>
                                        <template>
                                            <template is="dom-repeat" items="[[item.tags]]" as="tag">
                                                [[tag.type]] [[tag.code]]<br/>
                                            </template>
                                        </template>
                                    </vaadin-grid-column>
                                    <vaadin-grid-column>
                                        <template>
                                            <paper-button class="grid-btn-small modal-button" on-tap="_toggleConfidentiality" data-item-data$="[[item]]" >
                                                <iron-icon icon="lock" class="force-left" data-item-data$="[[item]]"></iron-icon> &nbsp; [[localize('confidentiality',"Confidentiality",language)]]</paper-button>
                                        </template>
                                    </vaadin-grid-column>
                                </vaadin-grid>
                                </div>
                            </div>
                            <div class="headerMasterTitle headerLabel">[[_getTraduction('other')]]</div>
                            <vaadin-grid id="svc-list" class="vaadinStyle" items="[[_getServicesNotByType(currentSumehr.services, 'medication')]]">
                                <vaadin-grid-selection-column></vaadin-grid-selection-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('hub_titl','Title',language)]]
                                    </template>
                                    <template>
                                        [[getServiceTitle(item.content)]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('hub_sta_dat','Start date',language)]]
                                    </template>
                                    <template>
                                        [[item.valueDate]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('hub_code','Code',language)]]
                                    </template>
                                    <template>
                                        <template is="dom-repeat" items="[[item.codes]]" as="code">
                                            [[code.type]] [[code.code]]<br/>
                                        </template>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('hub_tag','Tag',language)]]
                                    </template>
                                    <template>
                                        <template is="dom-repeat" items="[[item.tags]]" as="tag">
                                            [[tag.type]] [[tag.code]]<br/>
                                        </template>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template>
                                        <paper-button class="grid-btn-small modal-button" on-tap="_toggleConfidentiality" data-item-data$="[[item]]" >
                                            <iron-icon icon="lock" class="force-left" data-item-data$="[[item]]"></iron-icon> &nbsp; [[localize('confidentiality',"Confidentiality",language)]]</paper-button>
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid>
                            <div class="headerMasterTitle headerLabel">[[_getTraduction('medication')]]</div>
                            <vaadin-grid id="med-list" class="vaadinStyle" items="[[_getServicesByType(currentSumehr.services, 'medication')]]">
                                <vaadin-grid-selection-column></vaadin-grid-selection-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('medication','Medication',language)]]
                                    </template>
                                    <template>
                                        [[getMedicationTitle(item.content)]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('hub_sta_dat','Start date',language)]]
                                    </template>
                                    <template>
                                        [[getMedicationStartDate(item)]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('hub_end_dat','End date',language)]]
                                    </template>
                                    <template>
                                        [[getMedicationEndDate(item)]]
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('hub_code','Code',language)]]
                                    </template>
                                    <template>
                                        <template is="dom-repeat" items="[[item.codes]]" as="code">
                                            [[code.type]] [[code.code]]<br/>
                                        </template>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template class="header">
                                        [[localize('hub_tag','Tag',language)]]
                                    </template>
                                    <template>
                                        <template is="dom-repeat" items="[[item.tags]]" as="tag">
                                            [[tag.type]] [[tag.code]]<br/>
                                        </template>
                                    </template>
                                </vaadin-grid-column>
                                <vaadin-grid-column>
                                    <template>
                                        <paper-button class="grid-btn-small modal-button" on-tap="_toggleConfidentiality" data-item-data$="[[item]]" >
                                            <iron-icon icon="lock" class="force-left" data-item-data$="[[item]]"></iron-icon> &nbsp; [[localize('confidentiality',"Confidentiality",language)]]</paper-button>
                                    </template>
                                </vaadin-grid-column>
                            </vaadin-grid>
                        </div>
                    </div>
                </page>
                <page>
                    <div class="pageContent">
                        <div class="hub-cons"> <!-- Notification input -->
                            <div>
                                <iron-autogrow-textarea class="paper-input-input" slot="input" id="transactionText" value="[[getJSON(currentSumehr)]]" ></iron-autogrow-textarea>
                            </div>

                        </div>
                    </div>
                </page>
            </iron-pages>
        <paper-dialog class="modalDialog" id="confidentialityDialog" no-cancel-on-outside-click>
            <h2 class="modal-title"><iron-icon icon="icons:warning"></iron-icon> [[localize('warning','Warning',language)]]</h2>
            <div class="modalDialogContent m-t-50">
                <h3 class="textAlignCenter">[[localize('areYouSureFlagInvoiceAsLost','Are you sure you wish to flag invoice as permanently lost?',language)]]</h3>
                <p class="textAlignCenter m-t-50 bold">[[localize('unrecoverableAction','This action is unrecoverable',language)]].</p>
            </div>
            <div class="buttons">
                <paper-button class="modal-button" on-tap="_closeDialogs"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('can','Cancel',language)]]</paper-button>
                <paper-button class="modal-button" on-tap="_flagInvoiceAsLost"><iron-icon icon="check-circle" class="mr5 smallIcon" ></iron-icon> [[localize('confirm','Confirm',language)]]</paper-button>
            </div>
        </paper-dialog>
    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';
        import { Base64 } from 'js-base64';

        class HtPatHubTransactionPreview extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-hub-transaction-preview';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient:{
                      type: Object
                    },
                    language: {
                        type: String
                    },
                    opened: {
                        type: Boolean,
                        value: false
                    },
                    tabs: {
                        type:  Number,
                        value: 0
                    },
                    isLoading:{
                        type: Boolean,
                        value: false
                    },
                    transInfo:{
                        type: Object,
                        value: null
                    },
                    message:{
                        type: Object,
                        value: null
                    },
                    attachmentCount: {
                        type:  Number,
                        value: 0
                    },
                    auditTrail:{
                        type: Object,
                        value: null
                    },
                    parent:{
                        type:Object,
                        value: null
                    },
                    selectedDocumentToBeImported:{
                        type: Object,
                        value: () => {}
                    },
                    currentContact:{
                        type: Object
                    },
                    contacts:{
                        type: Array
                    },
                    currentSumehr:{
                        type: Object,
                        value: null
                    },
                    cdTransaction:{
                        type: Object,
                        value: () => [
                            {
                                type: 'contactreport', label: {en: 'Contact report', fr : 'Rapport de consultation'}
                            },
                            {
                                type: 'labresult', label: {en: 'Laboratory result', fr : 'Résultat de laboratoire'}
                            },
                            {
                                type: 'note', label: {en : "Note", fr : 'Note'}
                            },
                            {
                                type: 'report', label: {en : "Repport", fr : 'Rapport'}
                            },
                            {
                                type: 'diarynote', label: {en : "Diary note", fr : 'Note de journal'}
                            },
                            {
                                type: 'result', label: {en : "Result", fr : 'Résultat'}
                            }
                        ]
                    },
                    currentMedicationScheme:{
                        type: Object,
                        value:null
                    },
                    isPreview:{
                        type: Boolean,
                        value: false
                    },
                    confidentialityItem:{
                        type: Object,
                        value : null
                    },
                    _bodyOverlay: {
                        type: Boolean,
                        value: false
                    },
                    administrationUnit:{
                        type: Object,
                        value : [
                            {code: "00001", label: {fr: "x 5 ml", en: '', nl: ''}},
                            {code: "00002", label: {fr: "amp.", en: '', nl: ''}},
                            {code: "00003", label: {fr: "applic.", en: '', nl: ''}},
                            {code: "00004", label: {fr: "caps.", en: '', nl: ''}},
                            {code: "00005", label: {fr: "compr.", en: '', nl: ''}},
                            {code: "00006", label: {fr: "dose", en: '', nl: ''}},
                            {code: "00007", label: {fr: "gouttes", en: '', nl: ''}},
                            {code: "00008", label: {fr: "flac.", en: '', nl: ''}},
                            {code: "00009", label: {fr: "implant", en: '', nl: ''}},
                            {code: "00010", label: {fr: "perfusion", en: '', nl: ''}},
                            {code: "00011", label: {fr: "inhalation", en: '', nl: ''}},
                            {code: "00012", label: {fr: "insert", en: '', nl: ''}},
                            {code: "00013", label: {fr: "gommes à mâcher", en: '', nl: ''}},
                            {code: "00014", label: {fr: "compresse(s)", en: '', nl: ''}},
                            {code: "00015", label: {fr: "lavement", en: '', nl: ''}},
                            {code: "00016", label: {fr: "ml", en: '', nl: ''}},
                            {code: "00017", label: {fr: "ov.", en: '', nl: ''}},
                            {code: "00018", label: {fr: "perle(s)", en: '', nl: ''}},
                            {code: "00019", label: {fr: "pastille", en: '', nl: ''}},
                            {code: "00020", label: {fr: "patch", en: '', nl: ''}},
                            {code: "00021", label: {fr: "patr.", en: '', nl: ''}},
                            {code: "00022", label: {fr: "stylo", en: '', nl: ''}},
                            {code: "00023", label: {fr: "puff(s)", en: '', nl: ''}},
                            {code: "00024", label: {fr: "éponge", en: '', nl: ''}},
                            {code: "00025", label: {fr: "stylo", en: '', nl: ''}},
                            {code: "00026", label: {fr: "suppo", en: '', nl: ''}},
                            {code: "00027", label: {fr: "tube", en: '', nl: ''}},
                            {code: "00028", label: {fr: "mèche", en: '', nl: ''}},
                            {code: "00029", label: {fr: "sac", en: '', nl: ''}},
                            {code: "00030", label: {fr: "sachets(s)", en: '', nl: ''}},
                            {code: "cm", label: {fr: "centimètre", en: '', nl: ''}},
                            {code: "dropsperminute", label: {fr: "goutes par minute", en: '', nl: ''}},
                            {code: "gm", label: {fr: "gramme", en: '', nl: ''}},
                            {code: "internationalunits", label: {fr: "unités internationales", en: '', nl: ''}},
                            {code: "mck/h", label: {fr: "microgramme par heure", en: '', nl: ''}},
                            {code: "mck/kg/minute", label: {fr: "microgramme par kilogramme par minute", en: '', nl: ''}},
                            {code: "measure", label: {fr: "mesure", en: '', nl: ''}},
                            {code: "mg", label: {fr: "milligramme", en: '', nl: ''}},
                            {code: "mg/h", label: {fr: "milligramme par heure", en: '', nl: ''}},
                            {code: "mg/ml", label: {fr: "milligramme par millimètre", en: '', nl: ''}},
                            {code: "ml/h", label: {fr: "millilitre par heure", en: '', nl: ''}},
                            {code: "tbl", label: {fr: "cuillère à soupe", en: '', nl: ''}},
                            {code: "tsp", label: {fr: "cuillère à café", en: '', nl: ''}},
                            {code: "unt/h", label: {fr: "unités par heure", en: '', nl: ''}}
                        ]
                    }

                };
            }

            static get observers() {
                return ['apiReady(api,user,opened)', 'sumehrChanged(currentSumehr)'];
            }

            ready() {
                super.ready();
            }

            _isEqual(a,b) {
                return (a === b)
            }

            _dateFormat(date) {
                return date ? this.api.moment(date).format('DD/MM/YYYY') : '';
            }

            _yesOrNo(b){
                return b ? this.localize('yes','yes',this.language) : this.localize('no','no',this.language)
            }

            isEven(n) {
                return n % 2 == 0;
            }

            getGender(niss){
                if(niss && niss.length === 11){
                    const c9 = niss.substring(8,9);
                    const even = this.isEven(parseInt(c9));
                    if(even){
                        return 'female';
                    }
                    else{
                        return 'male';
                    }
                }
                else{
                    return '';
                }
            }


            apiReady() {
                if (!this.api || !this.user || !this.user.id || !this.opened) return;

                try {
                } catch (e) {
                    console.log(e);
                }
            }

            attached() {
                super.attached();
                this.async(this.notifyResize, 1);
            }



            open(htPatHubDetail, sumehr) {
                this.set('parent', htPatHubDetail)
                this.set('attachmentCount', 0);
                this.set('message', null);
                this.set('isLoading',false);
                this.set('currentSumehr', sumehr);
            }

            sumehrChanged(sumehr){
                console.log("sumehr changed detected")
                //this.set('currentSumehr', sumehr);
            }

            getGridUnsSelectedItems(gridId) {
                const selected = _.get(this.shadowRoot.querySelector('#' + gridId), "selectedItems", []);
                const all = _.get(this.shadowRoot.querySelector('#' + gridId), "items", []);
                const unselected = all.filter(x => !selected.includes(x));
                return unselected
            }

            getItemsToExclude(){
                let unSelectedHe = this.getGridUnsSelectedItems('he-list');
                let unSelectedSvc = this.getGridUnsSelectedItems('svc-list');
                let unSelectedMed = this.getGridUnsSelectedItems('med-list');
                return unSelectedHe.concat(unSelectedSvc).concat(unSelectedMed);
            }

            getIdsToExclude(){
                return this.getItemsToExclude() ? this.getItemsToExclude().map(item => item.id) : [];
            }

            _resetGridSelectedItems(gridId) {
                const vaadinMessagesGrid = this.shadowRoot.querySelector('#' + gridId);
                vaadinMessagesGrid.selectedItems = []
                this.set('_haveGridSelectedMessages',false)
            }

            _arr_diff (a1, a2) {

                var a = [], diff = [];

                for (let x = 0; x < a1.length; x++) {
                    a[a1[x]] = true;
                }

                for (let i = 0; i < a2.length; i++) {
                    if (a[a2[i]]) {
                        delete a[a2[i]];
                    } else {
                        a[a2[i]] = true;
                    }
                }

                for (var k in a) {
                    diff.push(k);
                }

                return diff;
            }

            getJSON(obj){
                return JSON.stringify(obj);
            }

            _getServicesByType(services, type){
                return services && services.length ? services.filter(svc => svc.tags.find(tag => tag.code === type)) : [];
            }

            _getServicesNotByType(services, type){
                return services && services.length ? services.filter(svc => svc.tags.find(tag => tag.code !== type)) : [];
            }

            cdDesc(cds){
                return cds.map(cd => cd.value);
            }

            _getNodeList(msg, tagName){
                return msg ? msg.querySelectorAll(tagName) : null;
            }

            _getAuthorDesc(trn, type){
                const auth = this._getAuthor(trn, type);
                if(auth){
                    let nm = auth.querySelector('name') ? auth.querySelector('name').innerHTML : '';
                    nm += auth.querySelector('firstname') ? ' ' + auth.querySelector('firstname').innerHTML : ''
                    nm += auth.querySelector('familyname') ? ' ' + auth.querySelector('familyname').innerHTML : ''
                    return nm
                }else {
                    return '';
                }
            }

            _getAuthor(trn, type){
                //msg.querySelectorAll(tagName)[0].querySelectorAll('author')[0].querySelectorAll('hcparty')
                const hcps = Array.from(trn.querySelectorAll('author')[0].querySelectorAll('hcparty'));
                const auth =  hcps ? hcps.find(hcp => hcp.querySelectorAll('cd')[0].innerHTML === type) : null;
                return auth;
            }

            _isSumehr(transInfo){
                return this._transactionType(transInfo) === 'sumehr';
            }

            _isMedicationScheme(transInfo){
                return this._transactionType(transInfo) === 'medicationscheme';
            }

            _isDiaryNote(transInfo){
                return this._transactionType(transInfo) === 'diarynote';
            }

            _isOther(transInfo){
                return !( this._isSumehr(transInfo)|| this._isMedicationScheme(transInfo) || this._isDiaryNote(transInfo));
            }

            _transactionId(tr){
                if(tr && tr.ids){
                    const id = tr.ids.find(id => id.s === "LOCAL");
                    if(id){
                        return (id.sl ? id.sl : "") + "/" + (id.value ? id.value : "");
                    } else{
                        return "--";
                    }
                }else{
                    return "";
                }
            }

            _transactionDate(tr){
                if(tr && tr.date) {
                    var d = new Date(0);
                    d.setUTCMilliseconds(tr.date);
                    return d.toDateString();
                } else {
                    return "";
                }
            }

            dateFormat(date){
                if(date && date.date && date.date.millis){
                    let d = new Date(0);
                    d.setUTCMilliseconds(date.date.millis);
                    return d.toDateString();
                }else {
                    return ""
                }
            }

            fromYYYYMMDDHHmmss(num){
                if(num) {
                    const str = num.toString()
                    const year = str.substring(0, 4);
                    const month = str.substring(4, 6);
                    const day = str.substring(6, 8);
                    const hour = str.substring(8, 10);
                    const minute = str.substring(10, 12);
                    const second = str.substring(12, 14);
                    return day + "/" + month + "/" + year + " (" + hour + ":" + minute + ")"
                }
                else {
                    return null
                }
            }

            _transactionAuthor(tr){
                if(tr){
                    var authorRes = "--";
                    const author = tr.author.hcparties.find(hcp => hcp.familyname);
                    if(author) {
                        authorRes = author.familyname + ' ' + author.firstname;
                    }
                    const dept = tr.author.hcparties.find(hcp => hcp.cds.find(cd => cd.s === "CD-HCPARTY"))
                    if(dept){
                        const cd = dept.cds.find(cd => cd.s === "CD-HCPARTY")
                        authorRes += "/" + cd.value;
                    }
                    return authorRes;
                }else {
                    return "";
                }
            }

            _transactionType(tr){
                if(tr) {
                    const cdTransType = tr.cds.find(cd => cd.s === "CD-TRANSACTION");
                    if (cdTransType) {
                        return cdTransType.value;
                    }
                    else {
                        return "--";
                    }
                } else {
                    return "";
                }
            }

            _localizeTransactionType(tr){
                if(tr){
                    const cdTransType = tr.cds.find(cd => cd.s === "CD-TRANSACTION");
                    if (cdTransType) {
                        return this.localize("cd-transaction-"+cdTransType.value, cdTransType.value, this.language);
                    }

                }
            }

            close() {
                this.$.dialog.close();
            }

            _getHcpInfo(hcps){
                let hcpInfo = []

                if(hcps){
                    hcps.map(hcp => {
                        hcp && hcp.cds && hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY") && hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY").value !== "hub" ?
                            hcpInfo.push({
                                name: hcp.name || null,
                                firstName: hcp.firstname || null,
                                familyName: hcp.familyname || null,
                                inss: hcp && hcp.ids && hcp.ids.find(id => id && id.s === 'INSS') && hcp.ids.find(id => id && id.s === 'INSS') ? hcp.ids.find(id => id && id.s === 'INSS').value : null,
                                nihii: hcp && hcp.ids && hcp.ids.find(id => id && id.s === 'ID_HCPARTY') && hcp.ids.find(id => id && id.s === 'ID_HCPARTY').value ? hcp.ids.find(id => id && id.s === 'ID_HCPARTY').value : null,
                                type: hcp && hcp.cds && hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY") && hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY").value ? hcp.cds.find(cd => cd && cd.s === "CD_HCPARTY").value : null,
                                addresses: this._getAdresses(hcp.addresses) || [],
                                telecoms: this._getTelecoms(hcp.telecoms) || []
                            }) : null
                    })
                }

                return hcpInfo
            }

            _getPersonInfo(person){
                let personInfo = {}

                person ?
                    personInfo = {
                        inss: person.ids && person.ids.find(id => id.s === "INSS") && person.ids.find(id => id.s === "INSS").value ? person.ids.find(id => id.s === "INSS").value : null,
                        firstName: person.firstnames.join(' ') || null,
                        familyName: person.familyname || null,
                        birthdate: person.birthdate || null,
                        deathdate: person.deathdate || null,
                        sex : person.sex && person.sex.value || null,
                        addresses: this._getAdresses(person.addresses) || [],
                        telecoms: this._getTelecoms(person.telecoms) || [],
                        type: person && person.cds && person.cds.find(cd => cd && cd.s === "CD_HCPARTY") && person.cds.find(cd => cd && cd.s === "CD_HCPARTY").value ? person.cds.find(cd => cd && cd.s === "CD_HCPARTY").value : null,
                    }
                    : null

                return personInfo

            }


            _getAdresses(addresses){
                let addressesInfo = []
                addresses.map(adr => addressesInfo.push({
                        addressType: adr && adr.cds && adr.cds.find(cd => cd.s === "CD_ADDRESS") && adr.cds.find(cd => cd.s === "CD_ADDRESS").value ? adr.cds.find(cd => cd.s === "CD_ADDRESS").value : null,
                        country: adr && adr.country && adr.country.cd && adr.country.cd.s  && adr.country.cd.s === "CD_FED_COUNTRY" && adr.country.cd.value ? adr.country.cd.value : null,
                        zip: adr.zip || null,
                        nis: adr.nis || null,
                        city: adr.city || null,
                        district : adr.district || null,
                        street : adr.street || null,
                        houseNumber: adr.housenumber || null,
                        postboxNumber :adr.postboxnumber || null
                    })
                )

                return addressesInfo
            }

            _getTelecoms(telecoms){
                let telecomInfo = []
                telecoms.map(tel => telecomInfo.push({
                    addressType: tel && tel.cds && tel.cds.find(cd => cd.s === "CD_ADDRESS") && tel.cds.find(cd => cd.s === "CD_ADDRESS").value ? tel.cds.find(cd => cd.s === "CD_ADDRESS").value : null,
                    telecomType: tel && tel.cds && tel.cds.find(cd => cd.s === "CD_TELECOM") && tel.cds.find(cd => cd.s === "CD_TELECOM").value ? tel.cds.find(cd => cd.s === "CD_TELECOM").value : null,
                    telecomNumber : tel.telecomnumber
                }))

                return telecomInfo
            }

            _getContentCds(cds){
                let cdsInfo = []
                cds ? cds.map(cd => { cdsInfo.push({ s: cd.s, value: cd.value }) }) : null
                return cdsInfo
            }

            _getContentTexts(texts){
                let textInfo = []
                texts ? texts.map(txt => {textInfo.push({txtValue: txt.value,lang: txt.l}) }) : null
                return textInfo
            }

            _getTraduction(type){
                return this.localize(type, type, this.language)
            }

            getMedicationTitle(contents){
                const med = _.flatMap(contents)[0].medicationValue;
                return med && med.medicinalProduct ? med.medicinalProduct.intendedname : (med && med.substanceProduct ? med.substanceProduct.intendedname : (med && med.compoundPrescription ? med.compoundPrescription : "/"))
            }

            getServiceTitle(contents){
                const tmp = _.flatMap(contents)[0];
                return tmp && tmp.stringValue ? tmp.stringValue : "";
            }

            getMedicationStartDate(svc){
                const med = svc.content ? _.flatMap(svc.content)[0].medicationValue : null;
                return med && med.beginMoment ? med.beginMoment : svc.openingDate;
            }

            getMedicationEndDate(svc){
                const med = svc.content ? _.flatMap(svc.content)[0].medicationValue : null;
                return med && med.endMoment ? med.endMoment : "";
            }

            getRegimen(contents){
                return _.flatMap(contents)[0] && _.flatMap(contents)[0].medicationValue && _.flatMap(contents)[0].medicationValue.regimen ? _.flatMap(contents)[0].medicationValue.regimen : [];
            }

            _getTitle(contents, type){
                return type === "medication" || type === "vaccine" ? _.compact(_.flatten(contents.map(ct => ct.medicinalproduct))).map(med => med.intendedname).join(',') || null : _.flatten(contents.map(ct => ct.texts.map(txt => txt.txtValue))).join(',') || null
            }

            _getCode(contents, type){
                let codeList = []
                contents.map(ct => ct.cds.map(cd => {
                    codeList.push({
                        value: cd.value,
                        code: cd.s === "CD_CLINICAL" ? "Ibui: " :
                            cd.s === "CD_ATC" ? "Atc: " :
                                cd.s === "CD_VACCINEINDICATION" ? "" :
                                    cd.s === "ICD" ? "Icd: " :
                                        cd.s === "ICPC" ? "Icpc: " :
                                            cd.s === "CD_PATIENTWILL" ? "" :
                                                cd.s+": "
                    })
                }))

                return codeList
            }

            _ifTableView(type){
                return type === "gmdmanager" || type === "contactperson" || type === "contacthcparty" || type === "patientwill" ? false : true
            }

            _convertHubDateAsString(timestamp){
                if(timestamp){
                    let date = parseInt(timestamp) / 1000000
                    return this.api.moment(date).format("DD/MM/YYYY")
                }
            }

            _isSumehrType(transInfo){
                return this._transactionType(transInfo) === "sumehr" ? true : false
            }

            _isHcp(type){
                return type === "gmdmanager" || type === "contacthcparty" ? true : false
            }

            _isPerson(type){
                return type === "contactperson" ? true : false
            }

            _isAuthor(hcp){
                return hcp && hcp.length > 0 ? true : false
            }

            _isRedactor(hcp){
                return hcp && hcp.length > 0 ? true : false
            }

            _isMedicationView(docType){
                return docType && docType.desc && docType.desc === "medicationscheme" ? true : false
            }

            _localizeHcpType(type){
                return this.localize("cd-hcp-"+type, type, this.language)
            }

            _isPatientWill(transactionType){
                return transactionType === "patientwill" ? true : false
            }

            _isVaccineData(transactionType){
                return transactionType === "vaccine" ? true : false
            }

            _isMedicationData(transactionType){
                return transactionType === "medication" ? true : false
            }

            _isOtherData(transactionType){
                return transactionType !== "medication" && transactionType !== "vaccine"  ? true : false
            }

            _getPatientWill(cds){
                return cds.s === "CD_PATIENTWILL" ? this.localize('cd-patientwill-'+cds.value, cds.value, this.language) :
                            cds.s === "CD_PATIENTWILL_HOS" ? this.localize('cd-patientwill-hos-'+cds.value, cds.value, this.language):
                                cds.s === "CD_PATIENTWILL_RES" ? this.localize('cd-patientwill-res-'+cds.value, cds.value, this.language) :
                                    cds.value
            }

            _getPosology(item){
                if(item && item.posology){
                    //const posology = item.posology || null

                }
            }

            //{"administratedQuantity":{"quantity":"1"},"dayPeriod":{"type":"CD-DAYPERIOD","code":"beforebreakfast"},"frequency":"daily"}
            //{"frequency":"daily","administratedQuantity":{"time":null,"quantity":"1","unit":"unit"},"timeOfDay":200000}
            _getRegimenAsText(regimen){
                const administrationInfo = this.administrationUnit.find(adm => adm.code === regimen.administrationUnit) || null
                const adminUnit = administrationInfo && administrationInfo.label && administrationInfo.label[this.language] ? administrationInfo.label[this.language] : ""

                return this._getDayFreqDesc(regimen) + regimen.quantity+" "+adminUnit+" "+ this._getDayTimeDesc(regimen.dayTime)
            }

            _getDayFreqDesc(regimen){
                return regimen.dayNumber ? (this.localize("daynr", "Day #", this.language) + regimen.dayNumber + ":") :
                    (regimen.weekDay ? ((regimen.weekNumber ? (this.localize("weeknr", "Week #", this.language) + regimen.weekNumber + ":") : "") + this.localize(regimen.weekDay, regimen.weekDay, this.language) + ":") : (""));
            }

            _getDayTimeDesc(dayTime){

                return !isNaN(dayTime) ? this._getTimeDesc(dayTime) : this.localize('ms_'+_.toLower(dayTime), _.toLower(dayTime), this.language);
            }

            _getTimeDesc(time){
                return  time && time.toString().length >= 14 ? time.toString().substr(8,2) + ":" + time.toString().substr(10,2) : "";
            }

            _isChronic(temporality){
                return temporality && temporality === "CHRONIC" ? true : false
            }

            _isOneShot(temporality){
                return temporality && temporality === "ONESHOT" ? true : false
            }

            _localizeVaccine(value){
                return value && this.localize("cd-vaccine-indication-"+value, value, this.language)
            }

            _toggleConfidentiality(e){
                console.log(e);
                this.confidentialityItem = JSON.parse(_.get(e, "target.dataset.itemData", ""));

                this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp =>
                    this.api.patient().getPatientWithUser(this.user,this.patient.id)
                        .then(patientDto =>
                        {
                            if(this.confidentialityItem.healthElementId){
                                //healthelement
                                this.api.helementicc.getHealthElement(this.confidentialityItem.id).then(he => this.api.helementicc.decrypt(hcp.id, [he])).then(hes => {
                                    console.log(hes);
                                    let he = hes[0];
                                    const tg = he.tags.find(tag => tag.type === "org.taktik.icure.entities.embed.Confidentiality");
                                    if(tg){
                                        _.remove(he.tags, t => t == tg)
                                        console.log("secret removed");
                                    }else
                                    {
                                        he.tags.push({
                                            "code": "secret",
                                            "type": "org.taktik.icure.entities.embed.Confidentiality",
                                            "version": "1",
                                            "_id": "org.taktik.icure.entities.embed.Confidentiality|secret|1"
                                        });
                                        console.log("secret applied");
                                    }
                                    let heTmp = this.currentSumehr.healthElements.find(s => s.id === he.id);
                                    heTmp.tags = he.tags;
                                    this.$['he-list'].clearCache();
                                    this._sendHEChanged(he);
                                });
                            } else{
                                //service
                                this.api.contacticc.getContactWithUser(this.user, this.confidentialityItem.contactId).then(ctc => {
                                        console.log(ctc);
                                        this.api.contacticc.decrypt(hcp.id, [ctc]).then(ctcsTmp => {
                                            console.log(ctcsTmp);
                                            let svc = ctcsTmp[0].services.find(svc => svc.id === this.confidentialityItem.id);
                                            const tg = svc.tags.find(tag => tag.type === "org.taktik.icure.entities.embed.Confidentiality");
                                            if(tg){
                                                _.remove(svc.tags, t => t == tg)
                                                console.log("secret removed");
                                            } else {
                                                svc.tags.push({
                                                    "code": "secret",
                                                    "type": "org.taktik.icure.entities.embed.Confidentiality",
                                                    "version": "1",
                                                    "_id": "org.taktik.icure.entities.embed.Confidentiality|secret|1"
                                                });
                                                console.log("secret applied");
                                            }
                                            let svcTmp = this.currentSumehr.services.find(s => s.id === svc.id);
                                            svcTmp.tags = svc.tags;
                                            this.$['med-list'].clearCache();
                                            this.$['svc-list'].clearCache();
                                            //this.set("currentSumehr.services", );
                                            this._sendServiceChanged(svc);
                                        })
                                    }
                                )
                            }
                        }
                    )
                ).catch(e => {
                    console.log(e)
                })
            }

            _sendHEChanged(he){
                this.dispatchEvent(new CustomEvent('healthelement-changed', {detail: {healthelement: he}, bubbles: true, composed: true}))
            }

            _sendServiceChanged(svc){
                this.dispatchEvent(new CustomEvent('service-changed', {detail: {service: svc}, bubbles: true, composed: true}))
            }

            _closeDialogs() {
                this.set("_bodyOverlay", false);
                _.map( this.shadowRoot.querySelectorAll('.modalDialog'), i=> i && typeof i.close === "function" && i.close() )
            }

        }
        customElements.define(HtPatHubTransactionPreview.is, HtPatHubTransactionPreview);
    </script>
</dom-module>
