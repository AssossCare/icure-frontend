<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">

<dom-module id="ht-pat-hub-utils">
    <template>

    </template>
    <script>
        import * as models from '@taktik/icc-api-legacy/dist/icc-api/model/models';
        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import promiseLimit from 'promise-limit';


        class HtPatHubUtils extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-hub-utils';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient: {
                        type: Object,
                        notify: true
                    },
                    language: {
                        type: String
                    },
                    opened: {
                        type: Boolean,
                        value: false
                    },
                    tabs: {
                        type:  Number,
                        value: 0
                    },
                    isLoading:{
                        type: Boolean,
                        value: false
                    }
                };
            }

            static get observers() {
                return ['apiReady(api,user,opened)'];
            }

            ready() {
                super.ready();
                // this.addEventListener('iron-resize', () => this.onWidthChange());
                document.addEventListener('xmlHubUpdated', () => this.xmlHubListener() );
            }

            _dateFormat(date) {
                return date ? this.api.moment(date).format('DD/MM/YYYY') : '';
            }

            _timeFormat(date) {
                return date ? this.api.moment(date).format(date > 99991231 ? 'DD/MM/YYYY HH:mm' : 'DD/MM/YYYY') : '';
            }

            _dateFormat2(date, fFrom, fTo){
                return date ? this.api.moment(date, fFrom).format(fTo) : '';
            }

            _shortDateFormat(date, altDate) {
                return (date || altDate) && "'"+this.api.moment((date || altDate)).format('YY') || '';
            }

            _trueOrUnknown(b){
                return b ? this.localize('yes','yes',this.language) : '?'
            }

            _yesOrNo(b){
                return b ? this.localize('yes','yes',this.language) : this.localize('no','no',this.language)
            }

            apiReady() {
                if (!this.api || !this.user || !this.user.id || !this.opened) return;

                try {
                } catch (e) {
                    console.log(e);
                }
            }

            attached() {
                super.attached();
                this.async(this.notifyResize, 1);
            }

            getHubConfig(hub, environment){
                const hubConfig = {};
                switch (hub) {
                    case 'rsb':
                        hubConfig.name = "RSB";
                        hubConfig.hubId = 1990000728;
                        hubConfig.hubEndPoint = environment ===  'acc' ? 'https://acchub.abrumet.be/hubservices/intrahub/v3/intrahub.asmx' : 'https://hub.abrumet.be/hubservices/intrahub/v3/intrahub.asmx';
                        hubConfig.hubSupportsConsent = true;
                        hubConfig.hubPackageId = null;
                        hubConfig.hubApplication = "" ;//TODO: verify value
                        hubConfig.supportBreakTheGlass = false;
                        break;
                    case 'rsw':
                        hubConfig.name = "RSW";
                        hubConfig.hubId = 1990000035;
                        hubConfig.hubEndPoint = environment === 'acc' ? 'https://acchub.reseausantewallon.be/HubServices/IntraHub/V3/IntraHub.asmx' : 'https://hub.reseausantewallon.be/HubServices/IntraHub/V3/IntraHub.asmx';
                        hubConfig.hubSupportsConsent = true;
                        hubConfig.hubPackageId = null;
                        hubConfig.hubApplication = environment === 'acc' ? 'RSW' : '';
                        hubConfig.supportBreakTheGlass =  false;
                        break;
                    case 'cozo':
                        hubConfig.name = "COZO";
                        hubConfig.hubId = 1990000134;
                        hubConfig.hubEndPoint = environment === 'acc' ? 'https://servicestest.cozo.be/IntrahubServiceTest/servicev3.asmx' : 'https://services.cozo.be/IntrahubService/servicev3.asmx';
                        hubConfig.hubSupportsConsent = false;
                        hubConfig.hubPackageId = null;
                        hubConfig.hubApplication = environment === 'acc' ? 'TST2017' : 'COZO';
                        hubConfig.supportBreakTheGlass = false;
                        break;
                    case 'vitalink':
                        hubConfig.name = "VITALINK";
                        hubConfig.hubId = 1990001916;
                        hubConfig.hubEndPoint = environment === 'acc' ? 'https://vitalink-acpt.ehealth.fgov.be/vpmg/vitalink-gateway/IntraHubService' : 'https://vitalink.ehealth.fgov.be/vpmg/vitalink-gateway/IntraHubService';
                        hubConfig.hubSupportsConsent = false;
                        hubConfig.hubPackageId = environment === 'acc' ? "ACC_73424e1e-7eab-4b2c-9a8d-90a2bd1c078f" : "PROD_82fa1e06-7efc-4d84-8f4c-f88513009b9e"; //TODO: replace Pricare by TOPAZ Keys
                        hubConfig.hubApplication = "VITALINKGATEWAY";
                        hubConfig.supportBreakTheGlass =  true;
                        break
                }
                return hubConfig;
            }

            getLocalMedicationschemeStatus(pat){
                //last reading time
                //last read version
                //last downloaded json

                //integration time
                //integrated version
                //upload time
                //uploaded json
                //upload result json
                return {}
            }

            putLocalMedicationschemeStatus(pat){
                return {}
            }

            putMedicationScheme(hubConfig, services, serviceAuthors, version, isTest){
                //0. Check Data (optional) (frontend)
                //1. Generate Medicationscheme Kmehr Message (backend)
                //2. Send Medicationscheme Kmehr Message To Hub: putTransactionSet (FHC)
                //3. Get putTransactionSet Response (FHC)
                //3.1. Get the transactionset (for detailled info) (optional)
                //4. handle error messages
                //5. update services using the putTransactionSet Response
                return this.checkMedicationServices(services)
                    .then(svcs => this.generateMedicationScheme(svcs, serviceAuthors, version, hubConfig))
                    .then(msMessage => this.putTransactionSet(msMessage, hubConfig, isTest))
                    .then(putResponse => this.handleResponse(putResponse, services, hubConfig))
                    .finally(() => {
                        this.dispatchEvent(new CustomEvent('update-ms', {detail: {}, bubbles: true, composed: true}))
                    })
            }

            checkMedicationServices(services){
                services.forEach(s => {
                    _.values(s.content).forEach(c => {
                        if (c.medicationValue) {
                            if(c.medicationValue.beginMoment === 'Invalid date') {
                                c.medicationValue.beginMoment = +new Date()
                            }
                            if(c.medicationValue.endMoment === 'Invalid date') {
                                delete c.medicationValue.endMoment
                            }
                        }
                        delete c.stringValue
                    })
                })
                return Promise.resolve(services);
            }

            generateMedicationScheme(services, serviceAuthors, version, hubConfig){
                let enc = new TextDecoder("utf-8");
                return this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp =>
                    this.api.patient().getPatientWithUser(this.user,this.patient.id)
                        .then(patientDto => this.api.bekmehr().generateMedicationSchemeExport(patientDto.id, this.language, hubConfig.name, version, {
                                recipient: hcp,
                                services : services,
                                serviceAuthors : serviceAuthors,
                                comment: "medicationscheme",
                                recipientSafe: hubConfig.name,
                                version: version
                            }).then(output => {
                                return Promise.resolve(enc.decode(output));
                            }).catch(error=> {
                                return Promise.resolve({message: "error on generate", error: error});
                            })
                        ))
            }

            putTransactionSet(tsXML, hubConfig, isTest){
                const myblob = new Blob([tsXML]);
                return isTest ? Promise.resolve({message: "test: not sent", acknowledge: {isComplete:false}, error: ""}) : this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId).then(hcp => this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId)
                    .then(hcp => this.api.fhc().Hub().putTransactionSetUsingPOST(hubConfig.hubEndPoint,
                        this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                        hcp.lastName, hcp.firstName, hcp.nihii, hcp.ssin, "1000",
                        hubConfig.hubId,
                        this.patient.ssin,
                        myblob,
                        hubConfig.hubPackageId, hubConfig.hubApplication
                        )
                    )
                )
            }

            handleResponse(putResponse, services, hubConfig){
                return this.hasError(putResponse) ? Promise.resolve({error:"has an error", response:putResponse}): Promise.resolve(this.mergeResponse(putResponse, services, hubConfig));
            }

            hasError(putResponse){
                //TODO: implement
                const ack = putResponse.acknowledge;
                if(!ack.iscomplete) console.log("response with error", putResponse);
                return !ack.iscomplete;
            }

            // private String medicationSchemeIdOnSafe;
            // private Integer medicationSchemeSafeVersion;
            // private Long medicationSchemeTimeStampOnSafe;
            // private String medicationSchemeDocumentId;
            // private String safeIdName; //can be: vitalinkuri, RSWID, RSBID
            // private String idOnSafes; //medicationschemeelement : value of vitalinkuri, RSBID, RSWID
            // private Long timestampOnSafe; //transaction date+time
            // private Boolean changeValidated; //accept change on safe
            // private Boolean newSafeMedication; //new medication on safe
            // private String medicationUse; //free text
            // private Boolean medicationChanged;
            // private Boolean posologyChanged;

            mergeResponse(putResponse, services, hubConfig){
                //1. get transactionset id
                //2. get transactionset from hub
                //3. updated the services
                const tsInfo = putResponse.transactions && putResponse.transactions.length > 0 ? putResponse.transactions[0].ids.find(id => id.s==="LOCAL") : null;
                const tsSv = tsInfo.sv;
                const tsSl = tsInfo.sl;
                const tsId = tsInfo.value;
                this.getTransactionSet(tsSv, tsSl, tsId, hubConfig).then(tsResp => {
                    putResponse.transactions.forEach(trInfo  => {
                        const idKmehr = trInfo.ids.find(id => id.s === "ID-KMEHR").value;
                        const trOnHub = tsResp.folders[0].transactions.find(tr => tr.ids.find(id => id.s === "ID-KMEHR" && id.value === idKmehr)); //TODO: verify other id's (LOCAL)
                        const idLocalSv = trInfo.ids.find(id => id.s === "LOCAL").sv;
                        const idLocalSl = trInfo.ids.find(id => id.s === "LOCAL").sl;
                        const idLocalValue = trInfo.ids.find(id => id.s === "LOCAL").value;
                        const trTimeStamp = this.transactionDateTime(trOnHub);
                        if(idKmehr === 1){ //set the medicationscheme ids to all services
                            services.forEach(svc => {
                                const med = this.api.contact().preferredContent(svc, this.language);
                                med.medicationSchemeIdOnSafe = idLocalValue;
                                med.safeIdName = idLocalSl;
                                med.medicationSchemeTimeStampOnSafe = this.transactionDateTime(trOnHub);
                            })
                        } else {//set te medicationschemeElement ids to the corresponding service
                            const svcId = this.iCureServiceId(trOnHub);
                            const svc = svcId ? services.find(svc => svc.id === svcId) : services[idKmehr - 1];
                            const med = this.api.contact().preferredContent(svc, this.language);
                            med.idOnSafes = idLocalValue;
                            med.timestampOnSafe = this.transactionDateTime(trOnHub);
                        }
                    });
                    console.log("updated services", services);
                    return services;
                })
            }

            getTransactionSet(tsSv, tsSl, tsId, hubConfig){
                return this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId)
                    .then(hcp => this.api.fhc().Hub().getTransactionSetUsingGET(hubConfig.hubEndPoint, this.api.keystoreId,
                        this.api.tokenId, this.api.credentials.ehpassword,
                        hcp.lastName, hcp.firstName, hcp.nihii, hcp.ssin, this.hcpZip,
                        this.patient.ssin,
                        tsSv, tsSl, tsId,
                        hubConfig.hubPackageId, ""
                        )
                    )
            }

            transactionDateTime(tr){
                const millis = tr.date.millis + tr.time.millis;
                return millis;
            }

            iCureServiceId(tr){
                const itm = tr.item.find(it => it.ids.find(id => id.sl === "iCure-Service"));
                const svcId = itm.ids.find(id => id.sl === "iCure-Service") ? itm.ids.find(id => id.sl === "iCure-Service").value : null
                return svcId;
            }
        }
        customElements.define(HtPatHubUtils.is, HtPatHubUtils);
    </script>
</dom-module>
