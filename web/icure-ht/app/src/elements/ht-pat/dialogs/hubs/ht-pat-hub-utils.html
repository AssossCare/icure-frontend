<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">

<dom-module id="ht-pat-hub-utils">
    <template>

    </template>
    <script>
        import * as models from 'icc-api/dist/icc-api/model/models';
        import moment from 'moment/src/moment';
        import _ from 'lodash/lodash';
        import promiseLimit from 'promise-limit';


        class HtPatHubUtils extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-hub-utils';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient: {
                        type: Object,
                        notify: true
                    },
                    language: {
                        type: String
                    },
                    opened: {
                        type: Boolean,
                        value: false
                    },
                    tabs: {
                        type:  Number,
                        value: 0
                    },
                    hcpCache: {
                        type: Object,
                        notify: false
                    },
                    hcpMap: {
                        type: Object,
                        notify: false,
                        value: () => new Map()
                    },
                    weekdayKeys: {
                        type: Array,
                        value: () => ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"]
                    },
                    weekdayCodes: {
                        type: Array,
                        value: () => []
                    },
                    dayPeriodCodes: {
                        type: Array,
                        value: () => []
                    },
                    reimbursementReason: {
                        type: Object,
                        value: () => {}
                    },
                    timeUnits:{
                        type: Array,
                        value: () => []
                    },
                    reimbursementCodeRecipe: {
                        type: Array,
                        value: () => []
                    },
                    administrationUnits: {
                        type: Array,
                        value: () => []
                    }
                };
            }

            static get observers() {
                return ['apiReady(api,user,opened)'];
            }

            ready() {
                super.ready();
                // this.addEventListener('iron-resize', () => this.onWidthChange());
                document.addEventListener('xmlHubUpdated', () => this.xmlHubListener() );
            }

            _dateFormat(date) {
                return date ? this.api.moment(date).format('DD/MM/YYYY') : '';
            }

            _timeFormat(date) {
                return date ? this.api.moment(date).format(date > 99991231 ? 'DD/MM/YYYY HH:mm' : 'DD/MM/YYYY') : '';
            }

            _dateFormat2(date, fFrom, fTo){
                return date ? this.api.moment(date, fFrom).format(fTo) : '';
            }

            _shortDateFormat(date, altDate) {
                return (date || altDate) && "'"+this.api.moment((date || altDate)).format('YY') || '';
            }

            _trueOrUnknown(b){
                return b ? this.localize('yes','yes',this.language) : '?'
            }

            _yesOrNo(b){
                return b ? this.localize('yes','yes',this.language) : this.localize('no','no',this.language)
            }

            apiReady() {
                if (!this.api || !this.user || !this.user.id || !this.opened) return;

                try {
                } catch (e) {
                    console.log(e);
                }
            }

            attached() {
                super.attached();
                this.async(this.notifyResize, 1);
            }

            _getHcp() {
                let p = this.hcpCache && this.hcpCache.id === this.user.healthcarePartyId ? this.hcpCache.promise : null;
                if (!p) {
                    p = this.api.hcparty().getHealthcareParty(this.user.healthcarePartyId)
                        .then(hcp => {
                            hcp.zip = ((hcp.addresses || []).find(address => !!address.postalCode) || {postalCode: "1000"}).postalCode;
                            return hcp;
                        });
                    this.hcpCache = {id: this.user.healthcarePartyId, promise: p};
                }
                return p;
            }

            init() {
                return new Promise(resolve => {
                    if (this.dayPeriodCodes && this.dayPeriodCodes.length) return resolve();
                    else return this.api.code().findCodes("be", "CD-DAYPERIOD")
                        .then(codes => this.api.code().findCodes("be", "care.topaz.customDayPeriod")
                            .then(customCodes => this.push("dayPeriodCodes", ...codes.concat(customCodes))))
                        .then(() => resolve())
                })
                    .then(() => {
                        if (this.weekdayCodes && this.weekdayCodes.length) return Promise.resolve();
                        else return this.api.code().findCodes("be", "CD-WEEKDAY")
                            .then(codes => this.push("weekdayCodes", ...codes.map(code => {
                                    const day = code.label[this.language] || "";
                                    const number = this.weekdayKeys.indexOf(code.code) || -1;
                                    return Object.assign(
                                        code,
                                        {
                                            "weekday": day,
                                            "weekNumber": (number > -1) && number || 0
                                        });
                                })
                            ))
                    })
                    .then (() => {
                        if (this.reimbursementCodeRecipe && this.reimbursementCodeRecipe.length) return Promise.resolve();
                        return this.api.code().findCodes("be", "CD-REIMBURSEMENT-RECIPE")
                            .then(reimb => this.push("reimbursementCodeRecipe", "", ..._.orderBy(reimb, ['label.fr'], ['asc'])))
                    })
                    .then(() => {
                        if (this.timeUnits && this.timeUnits.length) return Promise.resolve();
                        return this.api.code().findCodes("be", "CD-TIMEUNIT")
                            .then(timeUnits => this.push("timeUnits", ..._.orderBy(_.filter(timeUnits, i => ["ns", "us", "ms", "s", "min"].indexOf(_.trim(_.get(i, "code"))) === -1), ['label.fr'], 'asc')))
                    })
                    .then(() => {
                        if (this.administrationUnits && this.administrationUnits.length) return Promise.resolve();
                        return this.api.code().findCodes("be", "CD-ADMINISTRATIONUNIT")
                            .then(administrationUnits => this.push("administrationUnits", ...administrationUnits.filter(a => a.version === "1.3")))
                    });
            }


            getHubConfig(hub, environment){
                const hubConfig = {};
                switch (hub) {
                    case 'rsb':
                        hubConfig.name = "RSB";
                        hubConfig.hubId = 1990000728;
                        hubConfig.hubEndPoint = environment ===  'acc' ? 'https://acchub.abrumet.be/hubservices/intrahub/v3/intrahub.asmx' : 'https://hub.abrumet.be/hubservices/intrahub/v3/intrahub.asmx';
                        hubConfig.hubSupportsConsent = true;
                        hubConfig.hubPackageId = null;
                        hubConfig.hubApplication = "" ;//TODO: verify value
                        hubConfig.supportBreakTheGlass = false;
                        break;
                    case 'rsw':
                        hubConfig.name = "RSW";
                        hubConfig.hubId = 1990000035;
                        hubConfig.hubEndPoint = environment === 'acc' ? 'https://acchub.reseausantewallon.be/HubServices/IntraHub/V3/IntraHub.asmx' : 'https://hub.reseausantewallon.be/HubServices/IntraHub/V3/IntraHub.asmx';
                        hubConfig.hubSupportsConsent = true;
                        hubConfig.hubPackageId = null;
                        hubConfig.hubApplication = environment === 'acc' ? 'RSW' : '';
                        hubConfig.supportBreakTheGlass =  false;
                        break;
                    case 'cozo':
                        hubConfig.name = "COZO";
                        hubConfig.hubId = 1990000134;
                        hubConfig.hubEndPoint = environment === 'acc' ? 'https://servicestest.cozo.be/IntrahubServiceTest/servicev3.asmx' : 'https://services.cozo.be/IntrahubService/servicev3.asmx';
                        hubConfig.hubSupportsConsent = false;
                        hubConfig.hubPackageId = null;
                        hubConfig.hubApplication = environment === 'acc' ? 'TST2017' : 'COZO';
                        hubConfig.supportBreakTheGlass = false;
                        break;
                    case 'vitalink':
                        hubConfig.name = "VITALINK";
                        hubConfig.hubId = 1990001916;
                        hubConfig.hubEndPoint = environment === 'acc' ? 'https://vitalink-acpt.ehealth.fgov.be/vpmg/vitalink-gateway/IntraHubService' : 'https://vitalink.ehealth.fgov.be/vpmg/vitalink-gateway/IntraHubService';
                        hubConfig.hubSupportsConsent = false;
                        hubConfig.hubPackageId = environment === 'acc' ? "ACC_73424e1e-7eab-4b2c-9a8d-90a2bd1c078f" : "PROD_82fa1e06-7efc-4d84-8f4c-f88513009b9e"; //TODO: replace Pricare by TOPAZ Keys
                        hubConfig.hubApplication = "VITALINKGATEWAY";
                        hubConfig.supportBreakTheGlass =  true;
                        break
                }
                return hubConfig;
            }

            getUserHubConfig() {
                const propHub = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.preferredhub') ||
                    (this.user.properties[this.user.properties.length] = {
                        type: {identifier: 'org.taktik.icure.user.preferredhub'},
                        typedValue: {type: 'STRING', stringValue: 'rsw'}
                    });

                const propEnv = this.user.properties.find(p => p.type && p.type.identifier === 'org.taktik.icure.user.eHealthEnv') ||
                    (this.user.properties[this.user.properties.length] = {
                        type: {identifier: 'org.taktik.icure.user.eHealthEnv'},
                        typedValue: {type: 'STRING', stringValue: 'prd'}
                    });

                return this.getHubConfig(propHub.typedValue.stringValue, propEnv.typedValue.stringValue);
            }

            getLocalMedicationschemeStatus(pat){
                //last reading time
                //last read version
                //last downloaded json

                //integration time
                //integrated version
                //upload time
                //uploaded json
                //upload result json
                return {}
            }

            putLocalMedicationschemeStatus(pat){
                return {}
            }

            initHubConfig(curHub, curEnv) {
                this.hubConfig = (curHub && curEnv ? this.getHubConfig(curHub, curEnv) : this.getUserHubConfig());
                return this.hubConfig;
            }

            _getCachedHcpIdBySsin(ssin) {
                let p = this.hcpMap.get(ssin);
                if (p === undefined) {
                    p = this.api.hcparty().findBySsinOrNihii(ssin, null, null, 1)
                        .then(hcp => {
                            return hcp.rows[0].id;
                        });
                    this.hcpMap.set(ssin, p);
                }
                return p;
            }

            getMedicationScheme() {
                this.initHubConfig();
                if (this.patient.ssin && this.api.tokenId) {
                    return this._getHcp()
                        .then(hcp => {
                            return this.api.fhc().Hubcontroller().getTransactionsListUsingGET(this.hubConfig.hubEndPoint,
                                this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                                hcp.lastName, hcp.firstName, hcp.nihii, hcp.ssin, hcp.zip,
                                this.patient.ssin,
                                this.hubConfig.hubPackageId,
                                null, null, null, null,
                                true, this.hubConfig.supportBreakTheGlass
                            )
                        })
                        .then(transactions => {
                            const transaction = transactions.find(transaction => _.get(transaction, 'cds', []).find(cd => _.get(cd, 's', null) === "CD-TRANSACTION" && _.get(cd, 'value', null) === "medicationscheme"))
                            const tsInfo = transaction.ids.find(id => id.s ==='LOCAL');
                            if (!tsInfo) return Promise.reject("No local transaction found");
                            return !_.isEmpty(transaction) ? this.getTransactionSet(tsInfo.sv, tsInfo.sl, tsInfo.value) : Promise.resolve({})
                        })
                        .then(transactionSet => {
                            console.log(transactionSet);
                            return _.get(_.head(_.get(transactionSet, 'folders', {})), 'transactions', []);
                        })
                        .then(subTransactions => Promise.all(subTransactions.map(subTransaction => {
                            const hcParty = _.get(subTransaction, "author.hcparties", []).find(hcParty => hcParty.ids.some(id => id.s === "INSS"));
                            if (hcParty) {
                                return this._getCachedHcpIdBySsin(hcParty.ids.find(id => id.s === "INSS").value)
                                    .then(id => {
                                        hcParty.localId = id;
                                        return subTransaction;
                                    });
                            } else {
                                return Promise.resolve(subTransaction);
                            }
                        })))
                        .then(subTransactions => {
                            return {
                                medicationScheme: subTransactions.find(it => _.get(it, 'cds', []).find(cd => _.get(cd, 'value', null) === "medicationscheme")),
                                medicationSchemeElements: subTransactions.filter(it => _.get(it, 'cds', []).find(cd => _.get(cd, 'value', null) === "medicationschemeelement")),
                                treatmentSuspensions: subTransactions.filter(it => _.get(it, 'cds', []).find(cd => _.get(cd, 'value', null) === "treatmentsuspension"))
                            };
                        })
                } else {
                    const messageId = this.patient.ssin ? "youAreNotConnectedToehBox" : "niss-absent";
                    return Promise.reject(this.localize(messageId, messageId));
                }
            }

            putMedicationScheme(services, serviceAuthors, version, isTest) {

                //0. Check Data (optional) (frontend)
                //1. Generate Medicationscheme Kmehr Message (backend)
                //2. Send Medicationscheme Kmehr Message To Hub: putTransactionSet (FHC)
                //3. Get putTransactionSet Response (FHC)
                //3.1. Get the transactionset (for detailled info) (optional)
                //4. handle error messages
                //5. update services using the putTransactionSet Response

                this.initHubConfig();
                const normalized = this.normalizeMedications(services);
                return this.generateMedicationScheme(normalized, serviceAuthors, version)
                    .then(msMessage => this.putTransactionSet(msMessage, isTest))
                    .then(putResponse => this.handleResponse(putResponse, services))
                    // .finally(() => {
                    //     this.dispatchEvent(new CustomEvent('update-ms', {detail: {}, bubbles: true, composed: true}))
                    // })
            }

            fixDate(date, defaultDate) {
                if (!date) return defaultDate;
                if (typeof date !== "number") date = parseInt(date, 10);
                if (!date) return defaultDate;
                if (date < 19700101 || date > parseInt(this.api.moment(Date.now()).add(1, 'y').format("YYYYMMDD"), 10)) return defaultDate;
                return date;
            }

            _isCustomReg(r) {
                return r.dayPeriod && ["midday", "afterwakingup"].includes(r.dayPeriod.code);
            }

            normalizeMedications(medications) {
                return medications.map(medication => {
                    const medicationValue = this.api.contact().medicationValue(medication, this.language);
                    const content = this.api.contact().preferredContent(medication, this.language);
                    delete content.stringValue;
                    delete medication.valueDate;
                    medicationValue.beginMoment = this.fixDate(medicationValue.beginMoment, parseInt(this.api.moment(Date.now()).format("YYYYMMDD"), 10));
                    medicationValue.endMoment = this.fixDate(medicationValue.endMoment);
                    if (medicationValue.regimen && medicationValue.regimen.length) {
                        medicationValue.knownUsage = false;
                        const customReg = medicationValue.regimen.filter(r => this._isCustomReg(r));
                        if (customReg && customReg.length) {
                            medicationValue.regimen = medicationValue.regimen.filter(r => !this._isCustomReg(r));
                            customReg.forEach(r => {
                                if (r.dayPeriod.code === "midday") {
                                    medicationValue.regimen.push({timeOfDay: "120000", administratedQuantity: r.administratedQuantity});
                                } else if (r.dayPeriod.code === "afterwakingup") {
                                    medicationValue.regimen.push({timeOfDay: "63000", administratedQuantity: r.administratedQuantity});
                                }
                            });
                        }
                        medicationValue.regimen.filter(r => r.administratedQuantity.quantity === "1/2").forEach(i => i.administratedQuantity.quantity = 0.5);
                        medicationValue.regimen.filter(r => r.administratedQuantity.quantity === "1/3").forEach(i => i.administratedQuantity.quantity = 0.33);
                        medicationValue.regimen.filter(r => r.administratedQuantity.quantity === "1/4").forEach(i => i.administratedQuantity.quantity = 0.25);
                    } else {
                        if (!medicationValue.instructionForPatient) {
                            medicationValue.knownUsage = true;
                        }
                    }
                    if (medicationValue.substanceProduct) {
                        if (medicationValue.substanceProduct.intendedcds && medicationValue.substanceProduct.intendedcds.some(intendedcd => intendedcd.type === "CD-VMPGROUP")) {
                            medicationValue.substanceProduct.intendedcds = [];
                        }
                    }
                    if (medicationValue.reimbursementReason) {
                        const key = Object.keys(this._reimbursementReasonToInstructions).find(key => key === medicationValue.reimbursementReason.code);
                        medicationValue.instructionsForReimbursement = key && this._reimbursementReasonToInstructions[key] || this._reimbursementReasonToInstructions.notreimbursable;
                    }
                    return medication;
                });
            }


            checkMedicationServices(services){
                services.forEach(s => {
                    _.values(s.content).forEach(c => {
                        if (c.medicationValue) {
                            if(c.medicationValue.beginMoment === 'Invalid date') {
                                c.medicationValue.beginMoment = +new Date()
                            }
                            if(c.medicationValue.endMoment === 'Invalid date') {
                                delete c.medicationValue.endMoment
                            }
                        }
                        delete c.stringValue
                    })
                })
                return Promise.resolve(services);
            }

            generateMedicationScheme(services, serviceAuthors, version){
                let enc = new TextDecoder("utf-8");
                return this._getHcp()
                    .then(hcp => this.api.patient().getPatientWithUser(this.user,this.patient.id)
                    .then(patientDto => this.api.bekmehr().generateMedicationSchemeExport(patientDto.id, this.language, this.hubConfig.name, version, {
                            recipient: hcp,
                            services : services,
                            serviceAuthors : serviceAuthors,
                            comment: "medicationscheme",
                            recipientSafe: this.hubConfig.name,
                            version: version
                        }).then(output => {
                            return Promise.resolve(enc.decode(output));
                        }).catch(error=> {
                            return Promise.reject(error);
                        })
                    ))
            }

            putTransactionSet(tsXML, isTest){
                const myblob = new Blob([tsXML]);
                if (isTest) return Promise.resolve({message: "test: not sent", acknowledge: {isComplete: false}, error: ""});
                return this._getHcp()
                    .then(hcp => this.api.fhc().Hubcontroller().putTransactionSetUsingPOST(this.hubConfig.hubEndPoint,
                        this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                        hcp.lastName, hcp.firstName, hcp.nihii, hcp.ssin, hcp.zip,
                        this.hubConfig.hubId,
                        this.patient.ssin,
                        myblob,
                        this.hubConfig.hubPackageId, this.hubConfig.hubApplication))
                    .catch(error => {
                        return Promise.reject(error);
                    })
            }

            getTransactionSet(tsSv, tsSl, tsId) {
                return this._getHcp()
                    .then(hcp => this.api.fhc().Hubcontroller().getTransactionSetMessageUsingGET(this.hubConfig.hubEndPoint,
                        this.api.keystoreId, this.api.tokenId, this.api.credentials.ehpassword,
                        hcp.lastName, hcp.firstName, hcp.nihii, hcp.ssin, hcp.zip,
                        this.patient.ssin,
                        tsSv, tsSl, tsId,
                        this.hubConfig.hubPackageId, ""))
                    .catch(error => {
                        return Promise.reject(error);
                    })
            }

            handleResponse(response, services){
                return this.hasError(response) ? Promise.reject(response): Promise.resolve(this.mergeResponse(response, services));
            }

            hasError(putResponse){
                //TODO: implement
                const ack = putResponse.acknowledge;
                if(!ack.iscomplete) console.log("response with error", putResponse);
                return !ack.iscomplete;
            }

            // private String medicationSchemeIdOnSafe;
            // private Integer medicationSchemeSafeVersion;
            // private Long medicationSchemeTimeStampOnSafe;
            // private String medicationSchemeDocumentId;
            // private String safeIdName; //can be: vitalinkuri, RSWID, RSBID
            // private String idOnSafes; //medicationschemeelement : value of vitalinkuri, RSBID, RSWID
            // private Long timestampOnSafe; //transaction date+time
            // private Boolean changeValidated; //accept change on safe
            // private Boolean newSafeMedication; //new medication on safe
            // private String medicationUse; //free text
            // private Boolean medicationChanged;
            // private Boolean posologyChanged;


            // @todo idKmehr wrong
            mergeResponse(putResponse, services){
                //1. get transactionset id
                //2. get transactionset from hub
                //3. updated the servicesreject
                const serviceContents = services.map(service => this.api.contact().preferredContent(service, this.language));
                const tsInfo = putResponse.transactions && putResponse.transactions.length > 0 ? putResponse.transactions[0].ids.find(id => id.s==="LOCAL") : null;
                if (!tsInfo) return Promise.reject("No local transaction found");
                return this.getTransactionSet(tsInfo.sv, tsInfo.sl, tsInfo.value).then(getTransaction => {
                    putResponse.transactions.forEach(putTransaction  => {
                        const idKmehr = putTransaction.ids.find(id => id.s === "ID_KMEHR").value;
                        const trOnHub = getTransaction.folders[0].transactions.find(tr => tr.ids.find(id => id.s === "ID_KMEHR" && id.value === idKmehr)); //TODO: verify other id's (LOCAL)
                        // const idLocalSv = trInfo.ids.find(id => id.s === "LOCAL").sv;
                        const idLocalSl = putTransaction.ids.find(id => id.s === "LOCAL").sl;
                        const idLocalValue = putTransaction.ids.find(id => id.s === "LOCAL").value;
                        // const trTimeStamp = this.transactionDateTime(trOnHub);
                        if(idKmehr === "1") { //set the medicationscheme ids to all services
                            services.forEach(svc => {
                                const med = this.api.contact().preferredContent(svc, this.language);
                                med.medicationSchemeIdOnSafe = idLocalValue;
                                med.safeIdName = idLocalSl;
                                med.medicationSchemeTimeStampOnSafe = this.transactionDateTime(trOnHub);
                            })
                        } else {//set te medicationschemeElement ids to the corresponding service
                            const idKmehrIndex = (parseInt(idKmehr, 10) || 0) - 2;
                            if (idKmehrIndex > -1 && idKmehrIndex < services.length) {
                                const content = this.api.contact().preferredContent(services[idKmehrIndex]);
                                if (content && content.medicationValue) {
                                    const med = content.medicationValue;
                                    med.idOnSafes = idLocalValue;
                                    med.timestampOnSafe = this.transactionDateTime(trOnHub);
                                }
                            }
                            // const svcId = this.getServiceId(trOnHub);
                            // const svc = svcId ? services.find(svc => svc.id === svcId) : services[idKmehrIndex];
                        }
                    });
                    console.log("updated services", services);
                    return services;
                })
                .catch(error => Promise.reject(error));
            }

            transactionDateTime(tr){
                const millis = tr.date.millis + tr.time.millis;
                return millis;
            }

            getServiceId(tr){
                const item = tr.item.find(it => it.ids.find(id => id.sl === "iCure-Service"));
                const svcId = (item && item.ids.find(id => id.sl === "iCure-Service") || {value: null}).value;
                return svcId;
            }

            regimenToPosology(regimen) {
                const iCureRegimen = regimen.reduce((iCureRegimen, reg) => {
                    const unit = (this.administrationUnits.find(adminUnit => adminUnit.code === reg.administrationUnit) || this.administrationUnits.find(adminUnit => adminUnit === "00006")).label[this.language];
                    const administratedQuantity = {quantity: reg.quantity, unit: unit};
                    if (reg.dayPeriod) {
                        const dayPeriod = this.dayPeriodCodes.find(dayPeriodCode => dayPeriodCode.code === reg.dayPeriod);
                        if (dayPeriod) {
                            iCureRegimen.push({dayPeriod: dayPeriod, administratedQuantity: administratedQuantity});
                        }
                    } else if (reg.dayTime) {
                        iCureRegimen.push({timeOfDay: reg.dayTime, administratedQuantity: administratedQuantity});
                    }
                    return iCureRegimen;
                }, []);
                return this.api.contact().medication().posologyToString({regimen: iCureRegimen}, this.language);
            }
        }
        customElements.define(HtPatHubUtils.is, HtPatHubUtils);
    </script>
</dom-module>
