<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../../collapse-button/collapse-button.html">
<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">
<link rel="import" href="../../../../styles/paper-tabs-style.html">
<link rel="import" href="../../../dynamic-form/dynamic-text-field.html">
<link rel="import" href="../../../../styles/notification-style.html">

<link rel="import" href="./ht-pat-member-data-response.html">
<link rel="import" href="./ht-pat-member-data-technical-info.html">


<dom-module id="ht-pat-member-data-detail">
    <template>
        <style include="dialog-style scrollbar-style buttons-style paper-tabs-style notification-style">
            #mdaDetailDialog{
                height: calc(98% - 12vh);
                width: 98%;
                max-height: calc(100% - 64px - 48px - 20px); /* 100% - header - margin - footer*/
                min-height: 400px;
                min-width: 800px;
                top: 64px;
            }

            .mdaDetailDialog{
                display: flex;
                height: calc(100% - 45px);;
                width: auto;
                margin: 0;
                padding: 0;
            }

            .mda-content{
                display: flex;
                width: 100%;
                position: relative;
                height: 100%;
                background-color: white;
            }

            .mda-menu-list{
                width: 30%;
            }

            .mda-view{
                width: 70%;
            }

            .mda-menu-list-header{
                height: 48px;
                width: 100%;
                border-bottom: 1px solid var(--app-background-color-darker);
                background-color: var(--app-background-color-dark);
                padding: 0 12px;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                box-sizing: border-box;
            }

            .mda-menu-list-header-info{
                margin-left: 12px;
                display: flex;
                align-items: center;
            }

            .mda-name{
                font-size: var(--font-size-large);
                font-weight: 700;
            }

            .mda-menu-search-line{
                display: flex;
            }

            .w100{
                width: 100%;
            }


            .w33{
                width: 33%;
            }

            .p4{
                padding: 4px;
            }

            .mtm2{
                margin-top: -2px;
            }

            .w40{
                width: 40%;
            }

            .headerInfoLine{
                width: 100%;
                padding: 4px;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: flex-start;
            }

            .headerInfoField{
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                align-content: stretch;
                width: calc(100% / 4);
                padding: 0 8px;
                box-sizing: border-box;
            }

            .headerLabel{
                font-weight: bold;
            }

            .mda-result-container{
                margin-bottom: 12px;
                border: 1px solid var(--app-background-color-dark);
            }

            .headerMasterTitle{
                font-size: var(--font-size-large);
                background: var(--app-background-color-dark);
                padding: 0 12px;
                box-sizing: border-box;
            }

            .mda-sub-container{
                height: auto;
                width: auto;
                margin: 10px;
                border: 1px solid var(--app-background-color-dark);
            }

            .mda-person-container{
                height: auto;
                width: auto;
            }

            .mda-address-container{
                height: auto;
                width: auto;
            }

            .mda-partnerInfo-container{
                height: auto;
                width: auto;
            }

            .mda-error-container{
                height: auto;
                width: auto;
                color: var(--app-status-color-nok);
                font-weight: bold;
            }

            .m5{
                margin: 5px;
            }


        </style>

        <paper-dialog id="mdaDetailDialog">
                <div class="mdaDetailDialog">
                    <div class="mda-content">
                        <div class="mda-menu-list">
                            <div class="mda-menu-list-header">
                                <div class="mda-menu-list-header-info">
                                    <div class="mda-name">
                                        [[localize('mda-mda','Member data',language)]]
                                    </div>
                                </div>
                            </div>
                            <div class="mda-menu-list-search">
                                <div class="mda-menu-search-line">
                                    <vaadin-combo-box id="consultType" class="w40" label="[[localize('mda-consult-type', 'Consultation type', language)]]" filter="{{mdaTypeFilter}}" selected-item="{{selectedMdaConsultType}}"  filtered-items="[[mdaConsultType]]" item-label-path="label.fr" >
                                        <template>[[_getLabel(item.label)]]</template>
                                    </vaadin-combo-box>
                                    <template is="dom-if" if="[[_isMdaSearchByNiss(selectedMdaConsultType)]]">
                                        <dynamic-text-field class="w100 p4 mtm2 mw0" label="[[localize('mda-niss', 'Niss', language)]]" value="{{mdaSearch.ssin}}" required error-message="This field is required"></dynamic-text-field>
                                    </template>
                                    <template is="dom-if" if="[[!_isMdaSearchByNiss(selectedMdaConsultType)]]">
                                        <dynamic-text-field class="w100 p4 mtm2 mw0" label="[[localize('mda-mutuality', 'Mutuality', language)]]" value="{{mdaSearch.mutuality}}" required error-message="This field is required"></dynamic-text-field>
                                        <dynamic-text-field class="w100 p4 mtm2 mw0" label="[[localize('mda-identification-number', 'Identification number', language)]]" value="{{mdaSearch.identificationNumber}}" required error-message="This field is required"></dynamic-text-field>
                                    </template>
                                </div>
                                <template is="dom-if" if="[[_isMedicalHouse(hcp)]]">
                                    <div class="mda-menu-search-line">
                                        <dynamic-date-field label="[[localize('mda-start-date', 'Start date', language)]]" value="{{mdaSearch.startDate}}" i18n="[[i18n]]"></dynamic-date-field>
                                        <dynamic-date-field label="[[localize('mda-end-date', 'End date', language)]]" value="{{mdaSearch.endDate}}" i18n="[[i18n]]"></dynamic-date-field>
                                    </div>
                                    <div class="mda-menu-search-line">
                                        <vaadin-combo-box id="contactType" class="w40" label="[[localize('mda-contact-type', 'Contact type', language)]]" filter="{{mdaContactTypeFilter}}" selected-item="{{selectedMdaContactType}}"  filtered-items="[[mdaContactType]]" item-label-path="label.fr" >
                                            <template>[[_getLabel(item.label)]]</template>
                                        </vaadin-combo-box>
                                    </div>
                                    <div class="mda-menu-search-line">
                                        <vaadin-combo-box id="contactType" class="w40" label="[[localize('mda-request-type', 'Request type', language)]]" filter="{{mdaRequestTypeFilter}}" selected-item="{{selectedMdaRequestType}}"  filtered-items="[[mdaRequestType]]" item-label-path="label.fr" >
                                            <template>[[_getLabel(item.label)]]</template>
                                        </vaadin-combo-box>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[!_isMedicalHouse(hcp)]]">
                                    <div class="mda-menu-search-line">
                                        <dynamic-date-field label="[[localize('mda-start-date', 'Start date', language)]]" value="{{mdaSearch.startDate}}" i18n="[[i18n]]"></dynamic-date-field>
                                        <vaadin-combo-box id="contactType" class="w40" label="[[localize('mda-contact-type', 'Contact type', language)]]" filter="{{mdaContactTypeFilter}}" selected-item="{{selectedMdaContactType}}"  filtered-items="[[mdaContactType]]" item-label-path="label.fr" >
                                            <template>[[_getLabel(item.label)]]</template>
                                        </vaadin-combo-box>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="mda-view">
                            <paper-tabs selected="{{tabs}}" >
                                <paper-tab>
                                    <iron-icon class="tabIcon" icon="vaadin:male"></iron-icon> [[localize('mda-response','Response',language)]]
                                </paper-tab>
                                <paper-tab>
                                    <iron-icon class="tabIcon" icon="vaadin:tools"></iron-icon> [[localize('mda-technical-info','Technical info',language)]]
                                </paper-tab>
                            </paper-tabs>
                            <iron-pages selected="[[tabs]]">
                                <page>
                                    <ht-pat-member-data-response api="[[api]]" user="[[user]]" language="[[language]]" patient="[[patient]]" hcp="[[hcp]]" mda-search="[[mdaSearch]]" selected-mda-contact-type="[[selectedMdaContactType]]" selected-mda-request-type="[[selectedMdaRequestType]]" mda-result="[[mdaResult]]" i18n="[[i18n]]" resources="[[resources]]"></ht-pat-member-data-response>
                                </page>
                                <page>
                                    <ht-pat-member-data-technical-info api="[[api]]" user="[[user]]" language="[[language]]" patient="[[patient]]" hcp="[[hcp]]" mda-search="[[mdaSearch]]" selected-mda-contact-type="[[selectedMdaContactType]]" selected-mda-request-type="[[selectedMdaRequestType]]" mda-result="[[mdaResult]]" i18n="[[i18n]]" resources="[[resources]]"></ht-pat-member-data-technical-info>
                                </page>
                            </iron-pages>
                        </div>
                    </div>
                    <div class="buttons">
                        <paper-button class="button" on-tap="_closeDialogs"><iron-icon icon="icons:close" class="mr5 smallIcon" ></iron-icon> [[localize('clo','Close',language)]]</paper-button>
                        <paper-button class="button button--other" on-tap="_refresh"><iron-icon icon="icons:refresh" class="mr5 smallIcon" ></iron-icon> [[localize('refresh','Refresh',language)]]</paper-button>
                    </div>
                </div>
            </div>
        </paper-dialog>
    </template>
    <script>
        import moment from 'moment/src/moment';

        class HtPatMemberDataDetail extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-member-data-detail';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                    patient:{
                        type: Object,
                        value: () => {}
                    },
                    hcp:{
                        type: Object,
                        value: () => {}
                    },
                    tabs:{
                        type: Number,
                        value: 0
                    },
                    mdaConsultType:{
                        type: Array,
                        value: () => [
                            {type: "byNiss", label: {fr: "Niss", en: "SSIN", nl: ""}},
                            {type: "byIo", label: {fr: "Données mutuelles", en: "Mutuality information", nl: ""}}
                        ]
                    },
                    selectedMdaConsultType:{
                        type: Object,
                        value: () => {}
                    },
                    mdaSearch:{
                        type: Object,
                        value: () => ({
                            ssin: null,
                            startDate: null,
                            endDate: null,
                            mutuality: null,
                            inscriptionNumber: null,
                            contactType: null,
                            requestType: null
                        })
                    },
                    mdaContactType: {
                        type: Array,
                        value: () => [
                            {type: "other", label:{fr: "Ambulant", nl: "", en: "Other"}},
                            {type: "hospitalized", label:{fr: "Hospitalisé", nl: "", en: "Hospitalized"}}
                        ]
                    },
                    selectedMdaContactType:{
                        type: Object,
                        value: () => {}
                    },
                    mdaRequestType:{
                        type: Array,
                        value: () => [
                            {type: "information", label:{fr: "Information", nl: "", en: "Information"}},
                            {type: "invoicing", label:{fr: "Facturation", nl: "", en: "Invoicing"}}
                        ]
                    },
                    selectedMdaRequestType:{
                        type: Object,
                        value: () => {}
                    },
                    mdaResult:{
                        type: Object,
                        value: () => {}
                    }
                };
            }

            static get observers() {
                return ['_selectedMdaConsultTypeChanged(selectedMdaConsultType)'];
            }

            ready() {
                super.ready();
            }

            openDialog(){
                this.api.hcparty().getHealthcareParty(_.get(this.user, 'healthcarePartyId', null)).then(hcp => {
                    this.set('hcp', hcp)
                }).finally(() => {
                    this.set('selectedMdaConsultType', _.get(this.patient, 'ssin', null) ? _.get(this, 'mdaConsultType', []).find(t => t.type === "byNiss") : _.get(this, 'mdaConsultType', []).find(t => t.type === "byIo"))
                    this.set('selectedMdaContactType', _.get(this, 'mdaContactType', []).find(t => t.type === "other"))
                    this.set('selectedMdaRequestType', _.get(this, 'mdaRequestType', []).find(t => t.type === "information"))
                    this.set('mdaSearch', {
                        ssin: _.get(this.patient, 'ssin', null),
                        startDate: this._isMedicalHouse() ? moment().startOf('month').format('YYYY-MM-DD') : moment().format('YYYY-MM-DD'),
                        endDate: this._isMedicalHouse() ? moment().endOf('month').format('YYYY-MM-DD') : null,
                        mutuality: _.get(_.head(_.get(this.patient, 'insurabilities', [])), "insuranceId", null),
                        identificationNumber: _.get(_.head(_.get(this.patient, 'insurabilities', [])), "identificationNumber", null),
                        contactType: _.get(_.get(this, 'mdaContactType', []).find(t => t.type === "other"), "type", "other"),
                        requestType: _.get(_.get(this, 'mdaRequestType', []).find(t => t.type === "information"), "type", "information")
                    })
                    this.$['mdaDetailDialog'].open()
                    _.get(this.patient, 'ssin', null) || (_.get(_.head(_.get(this.patient, 'insurabilities', [])), "insuranceId", null) && _.get(_.head(_.get(this.patient, 'insurabilities', [])), "identificationNumber", null)) ? this.consultMda() : null
                })
            }

            consultMda(){
                this.set('isLoading',true)
                ;(_.get(this.patient, 'ssin', null) ? this.consultMdaBySsin() : this.consultMdaByMemberShip()).then(resp => {
                    console.log(resp)
                    this.set("mdaResult", resp)
                }).finally(() => {
                    this.set('isLoading',false)
                })
            }

            consultMdaBySsin(){
                return _.get(this.patient, "ssin", null) ? this.api.fhc().MemberDataController().getMemberDataUsingGET(_.get(this.patient, "ssin", null), _.get(this.api, "tokenId", null), _.get(this.api, "keystoreId", null), _.get(this.api, "credentials.ehpassword", null), _.get(this.hcp, "nihii", null), _.get(this.hcp, "ssin", null), _.get(this.hcp, "firstName", null), "doctor") : Promise.resolve({})
            }

            consultMdaByMemberShip(){
                return this.api.fhc().MemberDataController().getMemberDataByMembershipUsingGET("", "", _.get(this.api, "tokenId", null), _.get(this.api, "keystoreId", null), _.get(this.api, "credentials.ehpassword", null), _.get(this.hcp, "nihii", null), _.get(this.hcp, "ssin", null), _.get(this.hcp, "firstName", null), "doctor")
            }

            _selectedMdaConsultTypeChanged(){
                if(this.selectedMdaConsultType){

                }
            }

            _isMdaSearchByNiss(){
                return _.get(this.selectedMdaConsultType, 'type', {}) === "byNiss"
            }

            _getLabel(label){
                return _.get(label, this.language, label.en)
            }

            _isMedicalHouse(){
                return _.get(this.hcp, "type", null) === "medicalhouse"
            }

            _getAssertionType(assertionType){
                return assertionType === "urn:be:cin:nippin:insurability:patientData" ? this.localize('mda-ass-patient-data', 'Patient data', this.language) :
                       assertionType === "urn:be:cin:nippin:insurability:period" ? this.localize('mda-ass-period', 'Period', this.language) :
                       assertionType === "urn:be:cin:nippin:insurability:payment" ? this.localize('mda-ass-payment', 'Payment', this.language) :
                       assertionType === "urn:be:cin:nippin:medicalHouse" ? this.localize('mda-mmh', 'Medical house', this.language) :
                       assertionType === "urn:be:cin:nippin:hospitalisation" ? this.localize('mda-hospi', 'Hospitalisation', this.language) :
                       assertionType === "urn:be:cin:nippin:insurability:generalSituation" ? this.localize('mda-general-situation', 'General situation', this.language) :
                       assertionType === "urn:be:cin:nippin:carePath" ? this.localize('mda-care-path', 'Care path', this.language) :
                       assertionType === "urn:be:cin:nippin:chronicCondition" ? this.localize('mda-chronic-condition', 'Chronic condition', this.language) :
                       assertionType === "urn:be:cin:nippin:referencePharmacy" ? this.localize('mda-ref-pharmacy', 'Reference pharmacy', this.language) :
                       assertionType
            }

            _getStatusOfRequest(statusCode){
                return statusCode === "urn:oasis:name:tc:SAML:2.0:status:Success" ? this.localize('mda-stat-succ', 'Succcess', this.language) :
                       statusCode === "urn:oasis:name:tc:SAML:2.0:status:Requester" ? this.localize('mda-stat-requ', 'Requester', this.language) :
                       statusCode === "urn:oasis:name:tc:SAML:2.0:status:Responder" ? this.localize('mda-stat-resp', 'Responder', this.language) :
                       statusCode === "urn:be:cin:nippin:SAML:status:PartialAnswer" ? this.localize('mda-stat-part-ans', 'Partial answer', this.language) :
                       statusCode
            }

            _getAttributeName(att){
                return _.get(att, 'name', null)
            }

            _getAttributeValue(att){
                return _.get(att, 'attributeValues', []).join(" ")
            }

        }
        customElements.define(HtPatMemberDataDetail.is, HtPatMemberDataDetail);
    </script>
</dom-module>
