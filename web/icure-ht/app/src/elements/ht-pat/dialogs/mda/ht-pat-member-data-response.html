<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../../bower_components/vaadin-icons/vaadin-icons.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="../../../../../bower_components/vaadin-material-theme/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../../../bower_components/vaadin-text-field/vaadin-text-area.html">
<link rel="import" href="../../../../../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../dynamic-form/dynamic-link.html">
<link rel="import" href="../../../dynamic-form/dynamic-pills.html">
<link rel="import" href="../../../ht-spinner/ht-spinner.html">
<link rel="import" href="../../../dynamic-form/dynamic-doc.html">
<link rel="import" href="../../../collapse-button/collapse-button.html">
<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">
<link rel="import" href="../../../../styles/buttons-style.html">
<link rel="import" href="../../../../styles/paper-tabs-style.html">
<link rel="import" href="../../../dynamic-form/dynamic-text-field.html">
<link rel="import" href="../../../../styles/notification-style.html">



<dom-module id="ht-pat-member-data-response">
    <template>
        <style include="dialog-style scrollbar-style buttons-style paper-tabs-style notification-style">
            #mdaDetailDialog{
                height: calc(98% - 12vh);
                width: 98%;
                max-height: calc(100% - 64px - 48px - 20px); /* 100% - header - margin - footer*/
                min-height: 400px;
                min-width: 800px;
                top: 64px;
            }

            .mdaDetailDialog{
                display: flex;
                height: calc(100% - 45px);;
                width: auto;
                margin: 0;
                padding: 0;
            }

            .mda-content{
                display: flex;
                width: 100%;
                position: relative;
                height: 100%;
                background-color: white;
            }

            .mda-menu-list{
                width: 30%;
            }

            .mda-view{
                width: 70%;
            }

            .mda-menu-list-header{
                height: 48px;
                width: 100%;
                border-bottom: 1px solid var(--app-background-color-darker);
                background-color: var(--app-background-color-dark);
                padding: 0 12px;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: center;
                box-sizing: border-box;
            }

            .mda-menu-list-header-info{
                margin-left: 12px;
                display: flex;
                align-items: center;
            }

            .mda-name{
                font-size: var(--font-size-large);
                font-weight: 700;
            }

            .mda-menu-search-line{
                display: flex;
            }

            .w100{
                width: 100%;
            }


            .w33{
                width: 33%;
            }

            .p4{
                padding: 4px;
            }

            .mtm2{
                margin-top: -2px;
            }

            .w40{
                width: 40%;
            }

            .headerInfoLine{
                width: 100%;
                padding: 4px;
                display: flex;
                flex-flow: row wrap;
                justify-content: flex-start;
                align-items: flex-start;
            }

            .headerInfoField{
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                align-content: stretch;
                width: calc(100% / 4);
                padding: 0 8px;
                box-sizing: border-box;
            }

            .headerLabel{
                font-weight: bold;
            }

            .mda-result-container{
                margin-bottom: 12px;
                border: 1px solid var(--app-background-color-dark);
            }

            .headerMasterTitle{
                font-size: var(--font-size-large);
                background: var(--app-background-color-dark);
                padding: 0 12px;
                box-sizing: border-box;
            }

            .mda-sub-container{
                height: auto;
                width: auto;
                margin: 10px;
                border: 1px solid var(--app-background-color-dark);
            }

            .mda-person-container{
                height: auto;
                width: auto;
            }

            .mda-address-container{
                height: auto;
                width: auto;
            }

            .mda-partnerInfo-container{
                height: auto;
                width: auto;
            }

            .mda-error-container{
                height: auto;
                width: auto;
                color: var(--app-status-color-nok);
                font-weight: bold;
            }

            .m5{
                margin: 5px;
            }
            .fw2{
                width: calc(100% / 2);
            }


        </style>

        <div>
            <template is="dom-if" if="[[_isDataAvailable('urn:be:cin:nippin:insurability:patientData', mdaResult, mdaResult.*)]]">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.patientData]]" as="pd">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-patientData', 'Patient data', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-name', 'Name', language)]]: &nbsp;</span> [[pd.careReceiver.name]]
                                </div>
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-firstName', 'First name', language)]]: &nbsp;</span> [[pd.careReceiver.firstName]]
                                </div>
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-gender', 'Gender', language)]]: &nbsp;</span> [[_localizeGender(pd.careReceiver.gender)]]
                                </div>
                            </div>
                            <div class="headerInfoLine">
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-niss', 'Niss', language)]]: &nbsp;</span> [[_formatNissNumber(pd.person.ssin)]]
                                </div>
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-birdthDate', 'Birth date', language)]]: &nbsp;</span> [[_formatDate(pd.careReceiver.birthDate)]]
                                </div>
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-deceasedDate', 'Deceased date', language)]]: &nbsp;</span> [[_formatDate(pd.careReceiver.deceasedDate)]]
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </template>

            <template is="dom-if" if="[[_isDataAvailable('urn:be:cin:nippin:insurability:period', mdaResult, mdaResult.*)]]">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.period]]" as="p">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-period', 'Period', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-reg-numb', 'Registration number', language)]]: &nbsp;</span> [[p.careReceiver.registrationNumber]]
                                </div>
                                <div class="headerInfoField fw2">
                                    <span class="headerLabel">[[localize('mda-mut', 'Mutuality', language)]]: &nbsp;</span> [[p.careReceiver.mutuality.code]] [[p.careReceiver.mutuality.name]]
                                </div>
                            </div>
                            <div class="headerInfoLine">
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-ct-code', 'Ct code', language)]]: &nbsp;</span> [[p.cb1]]/[[p.cb2]]
                                </div>
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-com-date', 'Communication date', language)]]: &nbsp;</span> [[_formatDate(p.communicationDate)]]
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </template>

            <template is="dom-if" if="[[_isDataAvailable('urn:be:cin:nippin:insurability:payment', mdaResult, mdaResult.*)]]">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.payment]]" as="p">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-payment', 'Payment', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-payment-io', 'Payment by IO', language)]]: &nbsp;</span> [[_localizePayment(p.paymentByIO)]]
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </template>

            <template is="dom-if" if="[[_isDataAvailable('urn:be:cin:nippin:medicalHouse', mdaResult, mdaResult.*)]]">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.medicalHouse]]" as="mmh">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-medicalHouse', 'Medical house', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoLine">
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-nihii', 'Nihii', language)]]: &nbsp;</span> [[_formatNihiiNumber(mmh.medicalHouse.nihii)]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-name', 'Name', language)]]: &nbsp;</span> [[mmh.medicalHouse.name]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-type', 'Type', language)]]: &nbsp;</span> [[mmh.medicalHouse.type]]
                                    </div>
                                </div>
                                <div class="headerInfoLine">
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-startDate', 'Start date', language)]]: &nbsp;</span> [[_formatDate(mmh.medicalHouse.startDate)]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-endDate', 'End date', language)]]: &nbsp;</span> [[_formatDate(mmh.medicalHouse.endDate)]]
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </template>

            <template is="dom-if" if="[[_isDataAvailable('urn:be:cin:nippin:hospitalisation', mdaResult, mdaResult.*)]]">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.hospitalisation]]" as="hosp">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-hospitalisation', 'Hospitalisation', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoLine">
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-nihii', 'Nihii', language)]]: &nbsp;</span> [[_formatNihiiNumber(hosp.hospitalisation.hospital.nihii)]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-name', 'Name', language)]]: &nbsp;</span> [[hosp.hospitalisation.hospital.name]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-service', 'Service', language)]]: &nbsp;</span> [[hosp.hospitalisation.service]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-adm-date', 'Admission date', language)]]: &nbsp;</span> [[_formatDate(hosp.hospitalisation.admissionDate)]]
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </template>

            <template is="dom-if" if="_isDataAvailable('urn:be:cin:nippin:insurability:generalSituation', mdaResult, mdaResult.*)">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.generalSituation]]" as="gs">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-generalSituation', 'General situation', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoLine">
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-event', 'Event', language)]]: &nbsp;</span> [[_localizeEvent(gs.generalSituation.event)]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-direction', 'Direction', language)]]: &nbsp;</span> [[_localizeDirection(gs.generalSituation.transfer.direction)]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-io', 'IO', language)]]: &nbsp;</span> [[gs.generalSituation.transfer.IO]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-transferDate', 'Transfer date', language)]]: &nbsp;</span> [[_formatDate(gs.generalSituation.transfer.transferDate)]]
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </template>

            <template is="dom-if" if="[[_isDataAvailable('urn:be:cin:nippin:carePath', mdaResult, mdaResult.*)]]">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.carePath]]" as="cp">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-carePath', 'Care path', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-type', 'Type', language)]]:  &nbsp;</span> [[_localizeCarePathType(cp.carePath.type)]]
                                </div>
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-startRightDate', 'Start right date', language)]]: &nbsp;</span> [[_formatDate(cp.carePath.startRightDate)]]
                                </div>
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-endRightDate', 'End right date', language)]]: &nbsp;</span> [[_formatDate(cp.carePath.endRightDate)]]
                                </div>
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-endContractDate', 'End contract date', language)]]: &nbsp;</span> [[_formatDate(cp.carePath.endContractDate)]]
                                </div>
                            </div>
                            <template is="dom-if" if="[[_isCarePathNihiiAvailable(cp.carePath.physician.nihii, cp.*)]]">
                                <div class="mda-sub-container m5">
                                    <div class="mda-person-container">
                                        <div class="headerMasterTitle headerLabel">[[localize('mda-physician', 'Physician', language)]]</div>
                                        <div class="headerInfoLine">
                                            <div class="headerInfoLine">
                                                <div class="headerInfoField">
                                                    <span class="headerLabel">[[localize('mda-nihii', 'Nihii', language)]]: &nbsp;</span> [[_formatNihiiNumber(cp.carePath.physician.nihii)]]
                                                </div>
                                                <div class="headerInfoField">
                                                    <span class="headerLabel">[[localize('mda-firstName', 'First name', language)]]: &nbsp;</span> [[cp.carePath.physician.firstName]]
                                                </div>
                                                <div class="headerInfoField">
                                                    <span class="headerLabel">[[localize('mda-lastName', 'Last name', language)]]: &nbsp;</span> [[cp.carePath.physician.lastName]]
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <template is="dom-if" if="[[_isCarePathNihiiAvailable(cp.carePath.medicalHouse.nihii, cp.*)]]">
                               <div class="mda-sub-container m5">
                                   <div class="mda-person-container">
                                       <div class="headerMasterTitle headerLabel">[[localize('mda-cp-medicalHouse', 'Medical house', language)]]</div>
                                       <div class="headerInfoLine">
                                           <div class="headerInfoLine">
                                               <div class="headerInfoLine">
                                                   <div class="headerInfoField">
                                                       <span class="headerLabel">[[localize('mda-nihii', 'Nihii', language)]]: &nbsp;</span> [[_formatNihiiNumber(cp.carePath.medicalHouse.nihii)]]
                                                   </div>
                                                   <div class="headerInfoField">
                                                       <span class="headerLabel">[[localize('mda-name', 'Name', language)]]: &nbsp;</span> [[cp.carePath.medicalHouse.name]]
                                                   </div>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </template>
                            <template is="dom-if" if="[[_isCarePathNihiiAvailable(cp.carePath.specialist.nihii, cp.*)]]">
                               <div class="mda-sub-container m5">
                                   <div class="mda-person-container">
                                       <div class="headerMasterTitle headerLabel">[[localize('mda-specialist', 'Specialist', language)]]</div>
                                       <div class="headerInfoLine">
                                           <div class="headerInfoLine">
                                               <div class="headerInfoLine">
                                                   <div class="headerInfoField">
                                                       <span class="headerLabel">[[localize('mda-nihii', 'Nihii', language)]]: &nbsp;</span> [[_formatNihiiNumber(cp.carePath.specialist.nihii)]]
                                                   </div>
                                                   <div class="headerInfoField">
                                                       <span class="headerLabel">[[localize('mda-firstName', 'First name', language)]]: &nbsp;</span> [[cp.carePath.specialist.firstName]]
                                                   </div>
                                                   <div class="headerInfoField">
                                                       <span class="headerLabel">[[localize('mda-lastName', 'Last name', language)]]: &nbsp;</span> [[cp.carePath.specialist.lastName]]
                                                   </div>
                                                   <div class="headerInfoField">
                                                       <span class="headerLabel">[[localize('mda-speciality', 'Speciality', language)]]: &nbsp;</span> [[cp.carePath.specialist.speciality]]
                                                   </div>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                               </div>
                           </template>
                        </div>
                    </div>
                </template>
            </template>

            <template is="dom-if" if="[[_isDataAvailable('urn:be:cin:nippin:chronicCondition', mdaResult, mdaResult.*)]]">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.chronicCondition]]" as="cc">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-chronicCondition', 'Chronic condition', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoField">
                                    <span class="headerLabel">[[localize('mda-year', 'Year', language)]]: &nbsp;</span> [[cc.chronicCondition.year]]
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </template>

            <template is="dom-if" if="[[_isDataAvailable('urn:be:cin:nippin:referencePharmacy', mdaResult, mdaResult.*)]]">
                <template is="dom-repeat" items="[[mdaResult.formatedResponse.referencePharmacy]]" as="rp">
                    <div class="mda-sub-container">
                        <div class="mda-person-container">
                            <div class="headerMasterTitle headerLabel">[[localize('mda-referencePharmacy', 'Reference pharmacy', language)]]</div>
                            <div class="headerInfoLine">
                                <div class="headerInfoLine">
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-nihii', 'Nihii', language)]]: &nbsp;</span> [[_formatNihiiNumber(rp.referencePharmacy.pharmacy.nihii)]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-name', 'Name', language)]]: &nbsp;</span> [[rp.referencePharmacy.pharmacy.name]]
                                    </div>
                                    <div class="headerInfoField">
                                        <span class="headerLabel">[[localize('mda-startDate', 'Start date', language)]]: &nbsp;</span> [[_formatDate(rp.referencePharmacy.startDate)]]
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </template>
        </div>
    </template>
    <script>
        import moment from 'moment/src/moment';

        class HtPatMemberDataResponse extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {
            static get is() {
                return 'ht-pat-member-data-response';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    language: {
                        type: String
                    },
                    patient:{
                        type: Object,
                        value: () => {}
                    },
                    hcp:{
                        type: Object,
                        value: () => {}
                    },
                    mdaSearch:{
                        type: Object,
                        value: () => {}
                    },
                    selectedMdaContactType:{
                        type: Object,
                        value: () => {}
                    },
                    selectedMdaRequestType:{
                        type: Object,
                        value: () => {}
                    },
                    mdaResult:{
                        type: Object,
                        value: () => {}
                    }
                };
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
            }

            _getAssertionType(assertionType){
                return this.localize('mda-ass-'+_.last(_.split(assertionType, ':')), _.last(_.split(assertionType, ':')), this.language)
            }

            _getStatusOfRequest(statusCode){
                return this.localize('mda-stat-'+_.last(_.split(statusCode, ':')), _.last(_.split(statusCode, ':')), this.language)
            }

            _getAttributeName(att){
                return this.localize('mda-att-name-'+_.last(_.split(_.get(att, 'name', null), ':')), _.last(_.split(_.get(att, 'name', null), ':')), this.language)
            }

            _getAttributeValue(att){
                return _.get(att, 'attributeValues', []).join(" ")
            }

            _isDataAvailable(type, mdaResult){
                return !!_.get(mdaResult, 'assertions', []).find(assertion => _.get(assertion, 'advice.assertionType', null) === type)
            }

            _formatDate(date){
                return date ? moment(parseInt(date)).format("DD/MM/YYYY"): null
            }

            _formatNissNumber(niss) {
                return niss ? ("" + niss).replace(/([0-9]{2})([0-9]{2})([0-9]{2})([0-9]{3})([0-9]{2})/, '$1.$2.$3-$4.$5') : ''
            }

            _formatNihiiNumber(nihii) {
                return nihii ? ("" + nihii).replace(/([0-9]{1})([0-9]{5})([0-9]{2})([0-9]{3})/, '$1-$2-$3-$4') : nihii
            }

            _localizePayment(payment){
                return payment ? this.localize('mda-payement-'+_.toLower(payment), payment, this.language) : null
            }

            _localizeGender(gender){
                return gender ? this.localize('mda-gender-'+_.toLower(gender), gender, this.language) : null
            }

            _localizeCarePathType(carePathType){
                return carePathType ? this.localize('mda-carePath-type-'+_.toLower(carePathType), carePathType, this.language) : null
            }

            _localizeDirection(direction){
                return direction ? this.localize('mda-direction-'+direction, direction, this.language) : null
            }

            _localizeEvent(event){
                return event ? this.localize('mda-event-'+event, event, this.language) : null
            }

            _isCarePathNihiiAvailable(nihii){
                return nihii !== null && nihii !== ""
            }

        }

        customElements.define(HtPatMemberDataResponse.is, HtPatMemberDataResponse);
    </script>
</dom-module>
