<link rel="import" href="../../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">

<link rel="import" href="ht-pat-vaccine-period.html">

<dom-module id="ht-pat-vaccine-schema-wallonia">
    <template>
        <style include="scrollbar-style dialog-style">

            .schema{
                padding: 12px;
                width: auto;
                box-sizing: border-box;
            }

            .schemaLine{
                display: flex;
            }

            .schemaColumn{
                border: 1px solid #bababa;
                height: 90px;
            }

            .schemaLine-title{
                display: flex;
            }

            .schemaColumn-title{
                border: 1px solid #bababa;
                height: 30px;
                text-align: center;
                font-weight: bold;
            }

            .schemaColumn-cat{
                border: 1px solid #bababa;
                height: 30px;
                text-align: center;
                font-weight: bold;
            }

            .w11{
                width: 11%;
            }

            .w44{
                width: 44%;
            }

            .w55{
                width: 55%;
            }

            .no-border{
                border: 1px solid transparent;
            }

            .baby{
                background-color: #f3b738;
                color: white;
                height: 21px;
                padding: 5px;
            }

            .childAndAdo{
                background-color: #aebf41;
                color: white;
                height: 21px;
                padding: 5px;
            }

            .titleTxt{
                height: 21px;
                padding: 5px;
            }

            .productContainer{
                padding: 5px;
                height: 60px;
                font-size: x-small;
                text-align: center;
            }

            .productTitle{
                font-weight: bold;
            }

            .productDescription{
                font-size: 10px;
            }

        </style>

        <div>
            <div class="schema">
                <div class="schemaLine-title">
                    <div class="schemaColumn-cat w11 no-border">
                        <div></div>
                    </div>
                    <div class="schemaColumn-cat w55">
                        <div class="baby">Nourrissons</div>
                    </div>
                    <div class="schemaColumn-cat w44">
                        <div class="childAndAdo">Enfants et adolescents</div>
                    </div>
                </div>
                <div class="schemaLine-title">
                    <div class="schemaColumn-title w11 no-border">
                        <div></div>
                    </div>
                    <template is="dom-repeat" items="[[periods]]" as="period">
                        <div class="schemaColumn-title w11">
                            <div class="titleTxt">[[period.name.fr]]</div>
                        </div>
                    </template>
                </div>
                <template is="dom-repeat" items="[[procedures]]" as="item">
                    <div class="schemaLine">
                        <div class="schemaColumn w11">
                            <div class="productContainer">
                                <div class="productTitle">[[item.procedure.label.fr]]</div>
                                <div class="productDescription"></div>
                            </div>
                        </div>
                        <template is="dom-repeat" items="[[item.periods]]" as="period">
                            <div class="schemaColumn w11">
                                <ht-pat-vaccine-period id="[[item.procedure.code]]-[[period.code]]"
                                    api="[[api]]"
                                    period="[[period]]"
                                    on-date-changed="_dateChanged"></ht-pat-vaccine-period>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>

    </template>
    <script>

        const vaccine_schema = {
            "fr": {
                id: "care.topaz.procedurepackage|schÃ©ma-de-vaccination-wallonie|1",
                periods: [
                    {name: {fr: "2 mois", nl: "", en: ""}, code: "MT", months: 2},
                    {name: {fr: "3 mois", nl: "", en: ""}, code: "MD", months: 3},
                    {name: {fr: "4 mois", nl: "", en: ""}, code: "MV", months: 4},
                    {name: {fr: "12 mois", nl: "", en: ""}, code: "MW", months: 12},
                    {name: {fr: "15 mois", nl: "", en: ""}, code: "MF", months: 15},
                    {name: {fr: "5-6 ans", nl: "", en: ""}, code: "JQ", months: 60},
                    {name: {fr: "11-12 ans", nl: "", en: ""}, code: "JE", months: 132},
                    {name: {fr: "13-14 ans", nl: "", en: ""}, code: "JY", months: 156},
                    {name: {fr: "15-16 ans", nl: "", en: ""}, code: "JF", months: 180}
                ]
            },
            "nl": {
                id: "care.topaz.procedurepackage|vlaams-vaccinatieschema|1",
                periods: [
                    {name: {fr: "2 mois", nl: "", en: ""}, code: "MT", months: 2},
                    {name: {fr: "3 mois", nl: "", en: ""}, code: "MD", months: 3},
                    {name: {fr: "4 mois", nl: "", en: ""}, code: "MV", months: 4},
                    {name: {fr: "12 mois", nl: "", en: ""}, code: "MW", months: 12},
                    {name: {fr: "15 mois", nl: "", en: ""}, code: "MF", months: 15},
                    {name: {fr: "6 ans", nl: "", en: ""}, code: "JZ", months: 72},
                    {name: {fr: "10 ans", nl: "", en: ""}, code: "JX", months: 120},
                    {name: {fr: "12 ans", nl: "", en: ""}, code: "JW", months: 144},
                    {name: {fr: "14 ans", nl: "", en: ""}, code: "JB", months: 168}
                ]
            }
        }

        class HtPatVaccineSchemaWallonia extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {

            static get is() {
                return 'ht-pat-vaccine-schema-wallonia';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient: {
                        type: Object,
                        value: null
                    },
                    region: {
                        type: String,
                        value: "nl"
                    },
                    language: {
                        type: String
                    },
                    contacts:{
                        type: Array,
                        value: () => []
                    },
                    procedures:{
                        type: Array,
                        value: () => []
                    },
                    periods:{
                        type: Array,
                        value: () => []
                    }
                };
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
            }

            initialize() {
                this._periodicities = [];
                this._newServices = [];
                this._oldServices = [];

                this.set("periods", vaccine_schema[this.region].periods);

                this.api.code().getCodes(this.periods.map(period => "CD-PERIODICITY|" + period.code + "|1"))
                    .then(codes => this._periodicities = codes)
                    .then(() => this.api.code().getCode(vaccine_schema[this.region].id))
                    .then(pack => {
                        const links = pack.links.filter(l => l.startsWith("BE-THESAURUS-PROCEDURES"));
                        const promises = links.map(l => this.api.code().getCode(l));
                        Promise.all(promises).then(procedures => {
                            console.log(procedures);
                            let newProc = procedures.map(procedure => ({
                                procedure: procedure,
                                periods: this.periods.map(period => ({
                                    code: period.code,
                                    service: this._registerService(procedure, period)
                                }))
                            }));
                            console.log(newProc);
                            this.set("procedures", newProc);
                        })
                    })
            }

            _dateChanged(e) {
                const service = e.detail.period.service;
                const procedure = this.procedures.find(pr => pr.periods.some(p => p.service == service));
                let found = false;
                for (const period of procedure.periods) {
                    if (found && period.service) {
                        const date = this.api.moment(period.service.valueDate);
                        period.service.valueDate = date.add(e.detail.days, 'days').format("YYYYMMDD");
                        const selector = '#' + procedure.procedure.code.split(".").join("\\.") + "-" + period.code;
                        this.shadowRoot.querySelector(selector).refresh();
                    }
                    found |= period.service == service;
                }
            }

            _matchPeriod(service, code) {
                return service.tags && service.tags.some(tag => tag.type == "CD-PERIODICITY" && tag.code == code);
            }

            _matchService(service, id, code) {
                return service.codes.some(c => c.id == id) && this._matchPeriod(service, code);
            }

            _findService(id, code) {
                const contact = this.contacts.find(c => c.services.some(s => this._matchService(s, id, code)));
                return contact ? contact.services.find(s => this._matchService(s, id, code)) : null;
            }

            _createService(procedure, period) {
                let periodicity = this._periodicities.find(code => code.code = period.code);
                return {
                    content: {
                        "fr" : _.get(procedure, 'label.fr', null),
                        "nl" : _.get(procedure, 'label.nl', null),
                    },
                    label: "Actes",
                    comment: "Test LDE",
                    valueDate: this.api.moment(this.patient.dateOfBirth).add(period.months, 'M').format("YYYYMMDD"),
                    codes: [
                        {
                            id: _.get(procedure, 'id', null),
                            type: _.get(procedure, 'type', null),
                            code:  _.get(procedure, 'code', null),
                            version:  _.get(procedure, 'version', null)
                        }
                    ],
                    tags: [
                        { type: 'CD-TRANSACTION', code: 'request'},
                        {
                            id: "CD-CLINICALPLAN|primaryprevention|1",
                            type: "CD-CLINICALPLAN",
                            code: "primaryprevention",
                            version: "1"
                        },
                        { type: 'CD-LIFECYCLE', code:'planned'},
                        {
                            id: periodicity.id || null,
                            type: periodicity.type || null,
                            code: periodicity.code || null,
                            version: periodicity.version || null,
                        }
                    ]
                }
            }

            _registerService(procedure, period) {
                if (!procedure.periodicity || !procedure.periodicity.some(p => (
                    p.relatedCode.id === vaccine_schema[this.region].id &&
                    p.relatedPeriodicity.type === "CD-PERIODICITY" &&
                    p.relatedPeriodicity.code === period.code)))
                    return null;
                let service = this._findService(procedure.id, period.code);
                if (service == null) {
                    service = this._createService(procedure, period);
                    this._newServices.push(service);
                }
                else this._oldServices.push(service);
                return service;
            }

            createMedicationSchema() {
                let ids = this._oldServices.map(s => s.contactId).filter((x, i, a) => a.indexOf(x) == i);

                const getContacts = ids.map(id => this.api.contact().getContactWithUser(this.user, id));

                const promises = this._newServices.map(s => this.api.contact().service().newInstance(this.user, s));

                this.api.contact().newInstance(this.user, this.patient, {
                    created: +new Date,
                    modified: +new Date,
                    author: _.trim(_.get(this, "user.id", "")),
                    responsible: _.trim(_.get(this, "user.healthcarePartyId", "")),
                    openingDate: +new Date,
                    closingDate: +new Date,
                    encounterType: {type: "CD-TRANSACTION", version: "1", code: 'request'},
                    tags: [],
                    services: []
                }).then(contact => Promise.all([contact, promises])).then(([contact, services]) => {
                    contact.services = services;
                    if (contact.services.length > 0)
                        return this.api.contact().createContactWithUser(this.user, contact);
                }).then(() => Promise.all(getContacts)).then(contacts => {
                    contacts.forEach(contact => {
                        contact.services = this._oldServices.filter(s => s.contactId == contact.id);
                    });
                    const promises = contacts.map(contact => {
                        return this.api.contact().modifyContactWithUser(this.user, contact)
                    });
                    return Promise.all(promises);
                }).then(() => console.log("Contacts updated"));
            }
        }

        customElements.define(HtPatVaccineSchemaWallonia.is, HtPatVaccineSchemaWallonia);
    </script>
</dom-module>

