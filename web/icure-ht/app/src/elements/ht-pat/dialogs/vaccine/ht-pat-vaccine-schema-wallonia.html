
<link rel="import" href="../../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="../../../../styles/dialog-style.html">
<link rel="import" href="../../../../styles/scrollbar-style.html">

<link rel="import" href="ht-pat-vaccine-period.html">

<dom-module id="ht-pat-vaccine-schema-wallonia">
    <template>
        <style include="scrollbar-style dialog-style">

            .schema{
                padding: 12px;
                width: auto;
                box-sizing: border-box;
            }

            .schemaLine{
                display: flex;
            }

            .schemaColumn{
                border: 1px solid #bababa;
                height: 90px;
            }

            .schemaLine-title{
                display: flex;
            }

            .schemaColumn-title{
                border: 1px solid #bababa;
                height: 30px;
                text-align: center;
                font-weight: bold;
            }

            .schemaColumn-cat{
                border: 1px solid #bababa;
                height: 30px;
                text-align: center;
                font-weight: bold;
            }

            .w11{
                width: 11%;
            }

            .w44{
                width: 44%;
            }

            .w55{
                width: 55%;
            }

            .no-border{
                border: 1px solid transparent;
            }

            .baby{
                background-color: #f3b738;
                color: white;
                height: 21px;
                padding: 5px;
            }

            .childAndAdo{
                background-color: #aebf41;
                color: white;
                height: 21px;
                padding: 5px;
            }

            .titleTxt{
                height: 21px;
                padding: 5px;
            }

            .product{
                padding: 5px;
                height: 60px;
                font-size: 10px;
                text-align: center;
                line-height: 12px;
                display: flex;
                flex-flow: column;
            }

            .productCode{
                font-weight: bold;
            }

        </style>

        <div>
            <template is="dom-if" if="[[hasSchema]]">
                <div class="schema">
                    <div class="schemaLine-title">
                        <div class="schemaColumn-cat w11 no-border">
                            <div></div>
                        </div>
                        <div class="schemaColumn-cat w55">
                            <div class="baby">Nourrissons</div>
                        </div>
                        <div class="schemaColumn-cat w44">
                            <div class="childAndAdo">Enfants et adolescents</div>
                        </div>
                    </div>
                    <div class="schemaLine-title">
                        <div class="schemaColumn-title w11 no-border">
                            <div></div>
                        </div>
                        <template is="dom-repeat" items="[[periods]]" as="period">
                            <div class="schemaColumn-title w11">
                                <div class="titleTxt">[[period.name.fr]]</div>
                            </div>
                        </template>
                    </div>
                    <template is="dom-repeat" items="[[procedures]]" as="item">
                        <div class="schemaLine">
                            <div class="schemaColumn w11">
                                <div class="product">
                                    <div class="productCode">[[item.procedure.code]]</div>
                                    <div>[[item.procedure.label.fr]]</div>
                                </div>
                            </div>
                            <template is="dom-repeat" items="[[item.periods]]" as="period">
                                <div class="schemaColumn w11">
                                    <ht-pat-vaccine-period id="[[item.procedure.code]]-[[period.code]]"
                                        api="[[api]]"
                                        i18n="[[i18n]]"
                                        period="[[period]]"
                                        procedure="[[item.procedure]]"
                                        on-date-changed="_dateChanged"
                                        on-select-product="_onSelectProduct"
                                        on-update-service="_onUpdateService"></ht-pat-vaccine-period>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>
        </div>

    </template>
    <script>

        class HtPatVaccineSchemaWallonia extends Polymer.TkLocalizerMixin(Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element)) {

            static get is() {
                return 'ht-pat-vaccine-schema-wallonia';
            }

            static get properties() {
                return {
                    api: {
                        type: Object,
                        value: null
                    },
                    user: {
                        type: Object,
                        value: null
                    },
                    patient: {
                        type: Object,
                        value: null
                    },
                    region: {
                        type: String,
                        value: "nl"
                    },
                    language: {
                        type: String
                    },
                    contacts: {
                        type: Array,
                        value: () => []
                    },
                    procedures: {
                        type: Array,
                        value: () => []
                    },
                    periods: {
                        type: Array,
                        value: () => []
                    },
                    hasSchema: {
                        type: Boolean,
                        value: true
                    }
                };
            }

            static get observers() {
                return [];
            }

            ready() {
                super.ready();
            }

            initialize(schema) {
                this.set("hasSchema", schema != null);
                if (!schema) return;
                this._periodicities = [];
                this._newServices = [];
                this._oldServices = [];
                this._schema = schema;
                this.set("periods", schema.periods);
                this.api.code().getCodes(this.periods.map(period => "CD-PERIODICITY|" + period.code + "|1"))
                    .then(codes => {
                        this._periodicities = codes;
                        let procedures = schema.procedures.map(procedure => ({
                            procedure: procedure,
                            periods: this.periods.map(period => ({
                                code: period.code,
                                service: this._registerService(procedure, period)
                            }))
                        }));
                        this._update();
                        this.set("procedures", procedures);
                    });
            }

            _getSelector(procedure, period) {
                return '#' + procedure.code.split(".").join("\\.") + "-" + period.code;
            }

            _toggle(target) {
                this.procedures.forEach(procedure => {
                    const targetProc = target.procedures.find(p => p.code == procedure.procedure.code);
                    if (targetProc) {
                        let index = 0;
                        procedure.periods.filter(p => p.service).forEach(period => {
                            if (index < targetProc.periodicity.length) {
                                period.code = targetProc.periodicity[index].relatedPeriodicity.code;
                                period.service.tags = period.service.tags.map(t => {
                                    return t.type !== "CD-PERIODICITY" ? t : {
                                        id: target.periodicity.id || null,
                                        type: target.periodicity.type || null,
                                        code: target.periodicity.code || null,
                                        version: target.periodicity.version || null,
                                    }
                                });
                                index++;
                            }
                            else {
                                _.set(period.service.tags.find(t => t.type == "CD-LIFECYCLE"), "code", "aborted");
                            }
                        })
                        while (index < targetProc.periodicity.length) {
                            // Create new services
                        }
                    }
                    else {
                        procedure.periods.filter(p => p.service).forEach(period => {
                            _.set(period.service.tags.find(t => t.type == "CD-LIFECYCLE"), "code", "aborted");
                        });
                    }
                })
            }

            _update() {
                this._oldServices.forEach(service => {
                    if (!service.tags.find(t => t.type == "CD-ITEM" && t.code == "vaccine"))
                        service.tags.push({ type: "CD-ITEM", code: "vaccine" })
                })
                this.procedures.forEach(procedure => {
                    let doseNumber = 1;
                    procedure.periods.filter(p => p.service).map(p => {
                        if (_.get(p.service.tags.find(t => t.type == "CD-LIFECYCLE"), "code", "") != "cancelled") {
                            p.service.content.fr = this._setDoseNumber(p.service.content.fr, doseNumber);
                            p.service.content.nl = this._setDoseNumber(p.service.content.nl, doseNumber);
                            doseNumber++;
                        }
                    });
                })
            }

            _setDoseNumber(content, doseNumber) {
                if ((typeof content) == "string")
                    content = { stringValue: content };
                if (!content.medicationValue)
                    content.medicationValue = {};
                if (!content.medicationValue.options)
                    content.medicationValue.options = {};
                if (!content.medicationValue.options.doseNumber)
                    content.medicationValue.options.doseNumber = {}
                content.medicationValue.options.doseNumber.stringValue = doseNumber.toString();
                return content;
            }

            _setMedication(content, product) {
                if ((typeof content) == "string")
                    content = { stringValue: content };
                if (!content.medicationValue)
                    content.medicationValue = {};
                if (!content.medicationValue.medicinalProduct)
                    content.medicationValue.medicinalProduct = {}
                const cds = product.code ? [{ type: "CD-DRUG-CNK", code: product.code }] : []
                content.medicationValue.medicinalProduct.intendedcds = cds;
                content.medicationValue.medicinalProduct.intendedname = product.name;
                return content;
            }

            _setProduct(service, product) {
                service.comment = product.name;
                service.content.fr = this._setMedication(service.content.fr, product);
                service.content.nl = this._setMedication(service.content.nl, product);
                if (product.code) {
                    const tag = service.tags.find(t => t.type == "CD-DRUG-CNK");
                    if (tag)
                        tag.code = product.code;
                    else
                        service.tags.push({
                            type: "CD-DRUG-CNK",
                            code: product.code
                        });
                    return;
                }
                service.tags = service.tags.filter(t => t.type != "CD-DRUG-CNK");
            }

            selectProduct(detail) {
                this._setProduct(detail.period.service, detail.period.product);
                this.shadowRoot.querySelector(this._getSelector(detail.procedure, detail.period)).refresh();
                this._dispatchEvent("update-service", detail);
            }

            _onSelectProduct(e) {
                console.log("onSelectProduct1");
                this._dispatchEvent("select-product", e.detail);

            }

            _onUpdateService(e) {
                console.log("onUpdateService1");
                this._dispatchEvent("update-service", e.detail);
            }

            _dateChanged(e) {
                // const service = e.detail.period.service;
                // const procedure = this.procedures.find(pr => pr.periods.some(p => p.service == service));
                // let found = false;
                // procedure.periods.forEach(period => {
                //     if (found && period.service) {
                //         const date = this.api.moment(period.service.valueDate);
                //         period.service.valueDate = date.add(e.detail.days, 'days').format("YYYYMMDD");
                //         const selector = this._getSelector(procedure.procedure.code, period.code);
                //         this.shadowRoot.querySelector(selector).refresh();
                //     }
                //     found |= period.service == service;
                // });
                console.log("onDateChanged1");
                this._dispatchEvent("update-service", e.detail);
            }

            _dispatchEvent(code, detail) {
                this.dispatchEvent(new CustomEvent(code, {
                    detail: detail,
                    bubbles: true
                }));
            }

            _matchPeriod(service, code) {
                return service.tags && service.tags.some(tag => tag.type == "CD-PERIODICITY" && tag.code == code);
            }

            _matchService(service, id, code) {
                return service.codes.some(c => c.id == id) && this._matchPeriod(service, code);
            }

            _findService(id, code) {
                // TODO: use services from parent
                const contact = this.contacts.find(c => c.services.some(s => this._matchService(s, id, code)));
                return contact ? contact.services.find(s => this._matchService(s, id, code)) : null;
            }

            _createService(procedure, period) {
                let periodicity = this._periodicities.find(code => code.code == period.code);
                return {
                    content: {
                        "fr" : {
                            stringValue: _.get(procedure, 'label.fr', null),

                        },
                        "nl" : {
                            stringValue: _.get(procedure, 'label.nl', null),
                        }
                    },
                    label: "Actes",
                    valueDate: this.api.moment(this.patient.dateOfBirth).add(period.months, 'M').format("YYYYMMDD"),
                    codes: [
                        {
                            id: _.get(procedure, 'id', null),
                            type: _.get(procedure, 'type', null),
                            code: _.get(procedure, 'code', null),
                            version: _.get(procedure, 'version', null)
                        }
                    ],
                    tags: [
                        { type: 'CD-TRANSACTION', code: 'request'},
                        {
                            id: "CD-CLINICALPLAN|primaryprevention|1",
                            type: "CD-CLINICALPLAN",
                            code: "primaryprevention",
                            version: "1"
                        },
                        { type: 'CD-ITEM', code:'vaccine'},
                        { type: 'CD-LIFECYCLE', code:'planned'},
                        {
                            id: periodicity.id || null,
                            type: periodicity.type || null,
                            code: periodicity.code || null,
                            version: periodicity.version || null,
                        }
                    ]
                }
            }

            _registerService(procedure, period) {
                if (!procedure.periodicity || !procedure.periodicity.some(p => (
                    p.relatedCode.id === this._schema.id &&
                    p.relatedPeriodicity.type === "CD-PERIODICITY" &&
                    p.relatedPeriodicity.code === period.code)))
                    return null;
                let service = this._findService(procedure.id, period.code);
                if (service == null) {
                    service = this._createService(procedure, period);
                    this._newServices.push(service);
                }
                else this._oldServices.push(service);
                return service;
            }

            createMedicationSchema() {
                let ids = this._oldServices.map(s => s.contactId).filter((x, i, a) => a.indexOf(x) == i);

                const getContacts = ids.map(id => this.api.contact().getContactWithUser(this.user, id));

                const promises = this._newServices.map(s => this.api.contact().service().newInstance(this.user, s));

                this.api.contact().newInstance(this.user, this.patient, {
                    created: +new Date,
                    modified: +new Date,
                    author: _.trim(_.get(this, "user.id", "")),
                    responsible: _.trim(_.get(this, "user.healthcarePartyId", "")),
                    openingDate: +new Date,
                    closingDate: +new Date,
                    encounterType: {type: "CD-TRANSACTION", version: "1", code: 'request'},
                    tags: [],
                    services: []
                }).then(contact => Promise.all([contact, promises])).then(([contact, services]) => {
                    contact.services = services;
                    if (contact.services.length > 0)
                        return this.api.contact().createContactWithUser(this.user, contact);
                }).then(() => Promise.all(getContacts)).then(contacts => {
                    contacts.forEach(contact => {
                        contact.services = this._oldServices.filter(s => s.contactId == contact.id);
                    });
                    const promises = contacts.map(contact => {
                        return this.api.contact().modifyContactWithUser(this.user, contact)
                    });
                    return Promise.all(promises);
                }).then(() => console.log("Contacts updated"));
            }

            print() {
                let html = '';
                html += '<div class="schema">';

                html += '<div class="schemaLine header">';
                html += '<div class="schemaColumn w00 no-border"></div>';
                html += '<div class="schemaColumn w55 group1"><div class="pad">Nourrissons</div></div>';
                html += '<div class="schemaColumn w44 group2"><div class="pad">Enfants et adolescents</div></div>';
                html += '</div>';

                html += '<div class="schemaLine header">';
                html += '<div class="schemaColumn w00 no-border"></div>';
                this.periods.forEach(period => {
                    html += '<div class="schemaColumn w11"><div class="pad">' + period.name.fr + '</div></div>';
                });
                html += '</div>';

                this.procedures.forEach(procedure => {
                    html += '<div class="schemaLine row">';
                    html += '<div class="schemaColumn w00">';
                    html += '<div class="product">' + procedure.procedure.label.fr + '</div>';
                    html += '</div>';
                    procedure.periods.forEach(period => {
                        html += '<div class="schemaColumn w11">';
                        html += '<div class="period">';
                        if (period.service) {
                            html += "<div>" + this.api.moment(period.service.valueDate).format('DD/MM/YYYY') + "</div>";
                            html += "<div>" + period.service.tags.find(t => t.type == "CD-LIFECYCLE").code + "</div>";
                            html += "<div>" + period.service.comment + "</div>";
                        }
                        html += '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                })

                html += '</div>';
                return html;
            }
        }

        customElements.define(HtPatVaccineSchemaWallonia.is, HtPatVaccineSchemaWallonia);
    </script>
</dom-module>

